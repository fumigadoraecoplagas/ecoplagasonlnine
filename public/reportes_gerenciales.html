<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulso de Horas Seguro - Eco Plagas</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="eco-plagas-styles.css" rel="stylesheet">
    <link href="unified-styles.css?v=1.0" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <script type="module" src="load-headersecure.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous" />
    <script src="check-permissions.js"></script>
    <script type="module" src="csrf-token.js"></script>
    <!-- Sistema de Autenticación Seguro -->
    <script type="module">
        import { auth } from './auth-secure.js';
        
        // Guardar auth en window para uso global
        window.firebaseAuth = auth;
        
        // VERIFICACIÓN INMEDIATA DE AUTENTICACIÓN - Redirigir antes de cargar contenido
        (async function() {
            // Prevenir múltiples ejecuciones
            if (window.authCheckInProgress) {
                return;
            }
            window.authCheckInProgress = true;
            
            // Verificar si ya estamos en iniciar_sesion.html (evitar loop)
            if (window.location.pathname.includes('iniciar_sesion.html')) {
                window.authCheckInProgress = false;
                if (document.body) document.body.style.display = 'block';
                return;
            }

            // 1. Validación optimista: Si hay señal de sesión previa, mostrar UI inmediatamente
            // Esto evita el "falso logout" visual mientras carga Firebase
            const hasSessionToken = sessionStorage.getItem('firebaseAuthToken') === 'authenticated';
            if (hasSessionToken) {
                // Sesión local detectada, mostrando UI optimista (sin log)
                if (document.body) {
                    document.body.style.display = 'block';
                }
            } else {
                // Si no hay sesión local, mantener oculto hasta confirmar
                if (document.body) document.body.style.display = 'none';
            }
            
            // 2. Verificación Real con Firebase
            // Usamos onAuthStateChanged para esperar la inicialización real, sin timeouts fijos
            try {
                const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario autenticado (Firebase) (sin exponer email)
                        
                        // Asegurar que secureAuthManager esté listo
                        let retries = 0;
                        while (!window.secureAuthManager && retries < 50) {
                            await new Promise(r => setTimeout(r, 100));
                            retries++;
                        }
                        
                        if (window.secureAuthManager) {
                            window.authManager = window.secureAuthManager;
                        }

                        if (document.body) {
                            document.body.style.display = 'block';
                            document.body.classList.add('authenticated');
                        }
                    } else {
                        // No hay sesión activa en Firebase (sin log)
                        // Guardar URL actual para retorno
                        try {
                            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                                sessionStorage.setItem('postLoginRedirect', window.location.href);
                            }
                        } catch (e) { /* Error saving redirect (sin log) */ }
                        
                        // Solo redirigir si Firebase confirma que no hay usuario
                        window.location.replace('iniciar_sesion.html');
                    }
                    window.authCheckInProgress = false;
                });
            } catch (error) {
                console.error('Error inicializando auth:', error);
                // En caso de error crítico de carga, redirigir por seguridad tras un tiempo
                setTimeout(() => {
                    if (!auth.currentUser && !window.location.pathname.includes('iniciar_sesion.html')) {
                        try { sessionStorage.setItem('postLoginRedirect', window.location.href); } catch (e) {}
                        window.location.replace('iniciar_sesion.html');
                    }
                }, 15000); // 15 segundos de seguridad
            }
        })();
    </script>
    <style>
        /* Ocultar contenido hasta verificar autenticación */
        body {
            display: none !important;
        }
        body.authenticated {
            display: block !important;
        }
        .reporte-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Estilos animados para Pulso de Horas */
        .page-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1.2rem;
            background-color: #fff9c4 !important;
            background: #fff9c4 !important;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(44, 62, 80, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            display: none !important;
        }
        
        .page-header h1 {
            color: #000000 !important;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: none !important;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }
        
        .page-header h1 i {
            color: #ff6b6b !important;
            animation: heartbeat 1.5s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
        }
        
        /* Animación de latido del corazón */
        @keyframes heartbeat {
            0% {
                transform: scale(1);
            }
            14% {
                transform: scale(1.1);
            }
            28% {
                transform: scale(1);
            }
            42% {
                transform: scale(1.1);
            }
            70% {
                transform: scale(1);
            }
        }
        
        
        
        /* Responsive para móviles */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.8rem;
                flex-direction: column;
                gap: 0.4rem;
            }
            
            .page-header {
                padding: 1rem;
                margin-bottom: 1.2rem;
            }
        }
        
        .filtros-section {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 2rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 1px solid #495057;
            color: white;
        }
        
        /* Estilos mejorados para filtros */
        .filtros-section .form-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: #000000 !important;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filtros-section .form-select,
        .filtros-section .form-control {
            height: 50px;
            font-size: 1.1rem;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: #ffffff;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .filtros-section .form-select:focus,
        .filtros-section .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.3rem rgba(0,123,255,0.25);
            background: #ffffff;
            transform: translateY(-2px);
        }
        
        .filtros-section .form-select:hover,
        .filtros-section .form-control:hover {
            border-color: #adb5bd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .filtros-section .btn {
            height: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .filtros-section .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        /* Estilo para el botón Aplicar Filtros */
        #aplicarFiltros {
            background-color: #0b7835 !important;
            color: #ffffff !important;
            border: none !important;
        }
        
        #aplicarFiltros:hover {
            background-color: #0a6b2f !important;
            color: #ffffff !important;
        }
        
        /* Estilos para la sección Colaboradores Conectados */
        #colaboradoresConectadosSection {
            background-color: #c8e6c9 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
        }
        
        /* Encabezado de Colaboradores Conectados en Verde Primario */
        #colaboradoresConectadosSection .section-header {
            background-color: #0b7835 !important;
            color: #ffffff !important;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        #colaboradoresConectadosSection .section-header .section-title,
        #colaboradoresConectadosSection .section-header .title-text,
        #colaboradoresConectadosSection .section-header .title-subtitle {
            color: #ffffff !important;
        }
        
        /* Títulos de departamento (como "Fumigación") en Verde Primario */
        #colaboradoresConectadosSection .departamento-title {
            background-color: #0b7835 !important;
            color: #ffffff !important;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Badge numérico en los títulos de departamento en Verde Pastel */
        #colaboradoresConectadosSection .departamento-title .badge.bg-secondary {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            color: #000000 !important;
        }
        
        /* Botón Crear Turno en Verde Pastel */
        #colaboradoresConectadosSection #crearTurnoManualBtn {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            color: #000000 !important;
            border: 1px solid #a5d6a7 !important;
            box-shadow: none !important;
            height: 38px !important;
            padding: 8px 16px !important;
            font-size: 0.875rem !important;
            line-height: 1.5 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 0.375rem !important;
        }
        
        #colaboradoresConectadosSection #crearTurnoManualBtn:hover {
            background-color: #a5d6a7 !important;
            background: #a5d6a7 !important;
            color: #000000 !important;
            transform: translateY(-2px) !important;
        }
        
        #colaboradoresConectadosSection #crearTurnoManualBtn::before {
            display: none !important;
        }
        
        /* Badge App Prendida en Verde Pastel - Mismo tamaño y bordes redondeados que el botón */
        #colaboradoresConectadosSection .section-badge .badge.bg-success,
        #colaboradoresConectadosSection .badge.bg-success {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            color: #000000 !important;
            height: 38px !important;
            padding: 8px 16px !important;
            font-size: 0.875rem !important;
            line-height: 1.5 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 1px solid #a5d6a7 !important;
            border-radius: 0.375rem !important;
        }
        
        /* Asegurar que el contenedor del badge tenga el mismo tamaño */
        #colaboradoresConectadosSection .section-badge {
            display: inline-flex !important;
            align-items: center !important;
        }
        
        /* Estilos para la sección Resumen General */
        .consolidado-section {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
        }
        
        .consolidado-section h3 {
            color: #ffffff !important;
        }
        
        .consolidado-section h3 i {
            color: #ffffff !important;
        }
        
        /* Micro-secciones de Resumen General */
        /* Total Horas y Monto Ineficiente - Azul Pastel */
        .consolidado-section .consolidado-item.total-horas,
        .consolidado-section .consolidado-item.monto-ineficiente {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
        }
        
        /* Total Extra y Valor Extra - Verde Pastel */
        .consolidado-section .consolidado-item.total-extra,
        .consolidado-section .consolidado-item.valor-extra {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
        }
        
        /* Total Pendientes y Valor Pendientes - Rojo Pastel */
        .consolidado-section .consolidado-item.total-pendientes,
        .consolidado-section .consolidado-item.valor-pendientes {
            background-color: #ffcdd2 !important;
            background: #ffcdd2 !important;
        }
        
        /* Color de texto negro para todas las micro-secciones */
        .consolidado-section .consolidado-item .consolidado-label,
        .consolidado-section .consolidado-item .consolidado-value {
            color: #000000 !important;
        }
        
        /* Eliminar bordes de todas las micro-secciones */
        .consolidado-section .consolidado-item,
        .consolidado-section .consolidado-item.total-horas,
        .consolidado-section .consolidado-item.total-extra,
        .consolidado-section .consolidado-item.valor-extra,
        .consolidado-section .consolidado-item.total-pendientes,
        .consolidado-section .consolidado-item.valor-pendientes,
        .consolidado-section .consolidado-item.monto-ineficiente {
            border: none !important;
            border-left: none !important;
            border-right: none !important;
            border-top: none !important;
            border-bottom: none !important;
        }
        
        /* Ícono de apagado individual de cada empleado en color rojo */
        .force-close-btn i.fa-power-off {
            color: #ff0000 !important;
        }
        
        .force-close-btn:hover i.fa-power-off {
            color: #cc0000 !important;
        }
        
        /* Círculo del botón de apagado en Rojo Pastel */
        .force-close-btn {
            background-color: #ffcdd2 !important;
            background: #ffcdd2 !important;
            border-color: #ffcdd2 !important;
        }
        
        .force-close-btn:hover {
            background-color: #ef9a9a !important;
            background: #ef9a9a !important;
            border-color: #ef9a9a !important;
        }
        
        /* Estilos para la sección Colaboradores Desconectados */
        #colaboradoresDesconectadosSection {
            background-color: #fbdc02 !important;
            background: #fbdc02 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
        }
        
        #colaboradoresDesconectadosSection .section-header {
            background-color: #ffd54f !important;
            background: #ffd54f !important;
            color: #ffffff !important;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        #colaboradoresDesconectadosSection .section-header .section-title,
        #colaboradoresDesconectadosSection .section-header .title-text,
        #colaboradoresDesconectadosSection .section-header .title-subtitle {
            color: #ffffff !important;
        }
        
        #colaboradoresDesconectadosSection .section-header i {
            color: #ffffff !important;
        }
        
        /* Badge "App Apagada" en Amarillo Pastel - Mismo tamaño y bordes redondeados que el botón "App Prendida" */
        #colaboradoresDesconectadosSection .section-badge .badge.bg-secondary,
        #colaboradoresDesconectadosSection .badge.bg-secondary {
            background-color: #fff9c4 !important;
            background: #fff9c4 !important;
            color: #000000 !important;
            height: 38px !important;
            padding: 8px 16px !important;
            font-size: 0.875rem !important;
            line-height: 1.5 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 1px solid #f9e79f !important;
            border-radius: 0.375rem !important;
        }
        
        /* Asegurar que el contenedor del badge tenga el mismo tamaño */
        #colaboradoresDesconectadosSection .section-badge {
            display: inline-flex !important;
            align-items: center !important;
        }
        
        /* Títulos de departamento (como "Fumigación", "Logística", "Ventas") en Amarillo Intermedio */
        #colaboradoresDesconectadosSection .departamento-title {
            background-color: #ffd54f !important;
            background: #ffd54f !important;
            color: #000000 !important;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Badge numérico en los títulos de departamento en Colaboradores Desconectados - Igual que Colaboradores Conectados */
        #colaboradoresDesconectadosSection .departamento-title .badge.bg-secondary,
        #colaboradoresDesconectadosSection .departamento-title .badge {
            background-color: #fff9c4 !important;
            background: #fff9c4 !important;
            color: #000000 !important;
            border-radius: 20px !important;
            padding: 4px 10px !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Estilos para la sección "Detalle por Empleado" */
        .empleados-section {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
        }
        
        .empleados-section h3 {
            color: #ffffff !important;
        }
        
        .empleados-section h3 i {
            color: #ffffff !important;
        }
        
        .empleados-section small {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        /* Títulos de departamento en "Detalle por Empleado" en Azul Pastel */
        .empleados-section .departamento-title {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            color: #000000 !important;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Badge numérico en los títulos de departamento en "Detalle por Empleado" */
        .empleados-section .departamento-title .badge.bg-secondary {
            background-color: #90CAF9 !important;
            background: #90CAF9 !important;
            color: #000000 !important;
            border-radius: 20px !important;
            padding: 4px 10px !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Estilos para la sección "Reporte de Horas por Día" */
        .horas-por-dia-section:has(#horasPorDiaTable),
        .horas-por-dia-section:first-of-type {
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
            border: none !important;
            border-top: none !important;
            border-bottom: none !important;
            border-left: none !important;
            border-right: none !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        /* Eliminar cualquier borde superior que pueda venir de estilos heredados o pseudo-elementos */
        .horas-por-dia-section:has(#horasPorDiaTable)::before,
        .horas-por-dia-section:has(#horasPorDiaTable)::after,
        .horas-por-dia-section:first-of-type::before,
        .horas-por-dia-section:first-of-type::after {
            display: none !important;
            border: none !important;
            border-top: none !important;
        }
        
        /* Eliminar bordes de elementos hijos que puedan estar causando el borde superior */
        .horas-por-dia-section:has(#horasPorDiaTable) > *:first-child,
        .horas-por-dia-section:first-of-type > *:first-child {
            border-top: none !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        .horas-por-dia-section:has(#horasPorDiaTable) h3,
        .horas-por-dia-section:first-of-type h3 {
            color: #ffffff !important;
        }
        
        .horas-por-dia-section:has(#horasPorDiaTable) h3 i,
        .horas-por-dia-section:first-of-type h3 i {
            color: #ffffff !important;
        }
        
        /* Recuadro "Leyenda de Colores" en Verde Pastel */
        .horas-por-dia-section:has(#horasPorDiaTable) .alert.alert-modern,
        .horas-por-dia-section:first-of-type .alert.alert-modern {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            border: none !important;
            border-radius: 8px;
            padding: 15px 20px;
        }
        
        .horas-por-dia-section:has(#horasPorDiaTable) .alert.alert-modern .alert-content,
        .horas-por-dia-section:first-of-type .alert.alert-modern .alert-content {
            color: #000000 !important;
        }
        
        .horas-por-dia-section:has(#horasPorDiaTable) .alert.alert-modern .alert-content strong,
        .horas-por-dia-section:first-of-type .alert.alert-modern .alert-content strong {
            color: #000000 !important;
        }
        
        .horas-por-dia-section:has(#horasPorDiaTable) .alert.alert-modern .alert-content i,
        .horas-por-dia-section:first-of-type .alert.alert-modern .alert-content i {
            color: #000000 !important;
        }
        
        /* Estilos para la sección "Reporte de Facturación por Empleado" */
        .horas-por-dia-section:has(#facturacionPorDiaTable) {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
            border: none !important;
            border-top: none !important;
            border-bottom: none !important;
            border-left: none !important;
            border-right: none !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        /* Eliminar cualquier borde superior que pueda venir de estilos heredados o pseudo-elementos */
        .horas-por-dia-section:has(#facturacionPorDiaTable)::before,
        .horas-por-dia-section:has(#facturacionPorDiaTable)::after {
            display: none !important;
            border: none !important;
            border-top: none !important;
        }
        
        /* Eliminar bordes de elementos hijos que puedan estar causando el borde superior */
        .horas-por-dia-section:has(#facturacionPorDiaTable) > *:first-child {
            border-top: none !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* Encabezado "Reporte de Facturación por Empleado" en Azul Pastel */
        .horas-por-dia-section:has(#facturacionPorDiaTable) h3 {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            color: #000000 !important;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .horas-por-dia-section:has(#facturacionPorDiaTable) h3 i {
            color: #000000 !important;
        }
        
        /* Recuadro de información en Azul Pastel */
        .horas-por-dia-section:has(#facturacionPorDiaTable) .alert.alert-modern {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            border: none !important;
            border-radius: 8px;
            padding: 15px 20px;
        }
        
        .horas-por-dia-section:has(#facturacionPorDiaTable) .alert.alert-modern .alert-content {
            color: #000000 !important;
        }
        
        .horas-por-dia-section:has(#facturacionPorDiaTable) .alert.alert-modern .alert-content strong {
            color: #000000 !important;
        }
        
        .horas-por-dia-section:has(#facturacionPorDiaTable) .alert.alert-modern .alert-content i {
            color: #000000 !important;
        }
        
        /* Subtítulo "Facturación Total por Día" en Azul Pastel */
        .horas-por-dia-section:has(#facturacionPorDiaTable) h4 {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            color: #000000 !important;
            padding: 10px 16px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .horas-por-dia-section:has(#facturacionPorDiaTable) h4 i {
            color: #000000 !important;
        }
        
        /* Estilos para la sección "Mapa de Ubicaciones GPS" */
        .mapa-gps-section {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
            border: none !important;
            box-shadow: none !important;
        }
        
        /* Recuadro del encabezado "Mapa de Ubicaciones GPS" en Verde Primario */
        .mapa-gps-section .mapa-gps-header {
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            color: #ffffff !important;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .mapa-gps-section .mapa-gps-header h3 {
            color: #ffffff !important;
            margin: 0;
        }
        
        .mapa-gps-section .mapa-gps-header h3 i {
            color: #ffffff !important;
        }
        
        /* Estadísticas del mapa GPS en color negro */
        .mapa-gps-section .mapa-gps-stats {
            color: #000000 !important;
        }
        
        .mapa-gps-section .mapa-gps-stats .mapa-gps-stat-item {
            color: #000000 !important;
        }
        
        .mapa-gps-section .mapa-gps-stats .mapa-gps-stat-value {
            color: #000000 !important;
        }
        
        .mapa-gps-section .mapa-gps-stats .mapa-gps-stat-label {
            color: #000000 !important;
        }
        
        /* Estilos para el encabezado "Pulso de Horas" */
        .page-header {
            background: #BBDEFB !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .page-header h1 {
            color: #000000 !important;
        }
        
        .page-header h1 i.reports-icon,
        .page-header h1 .fa-heartbeat {
            color: #ff0000 !important;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.6) !important;
        }
        
        /* Estilos mejorados para el botón Crear Turno */
        #crearTurnoManualBtn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        #crearTurnoManualBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        #crearTurnoManualBtn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        }
        
        #crearTurnoManualBtn:hover::before {
            left: 100%;
        }
        
        #crearTurnoManualBtn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.5);
        }
        
        #crearTurnoManualBtn i {
            font-size: 1.1em;
            animation: pulse-icon 2s ease-in-out infinite;
        }
        
        @keyframes pulse-icon {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .consolidado-section {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 2rem;
            color: white;
        }
        
        .consolidado-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .consolidado-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            backdrop-filter: blur(10px);
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .consolidado-value {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .consolidado-label {
            font-size: 0.7rem;
            opacity: 0.9;
            line-height: 1.2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .usuarios-activos-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Estilo específico para Colaboradores Conectados (App Prendida) */
        #colaboradoresConectadosSection {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.3);
            border: 1px solid rgba(21, 128, 61, 0.2);
        }
        
        /* Estilo específico para Colaboradores Desconectados (App Apagada) */
        #colaboradoresDesconectadosSection {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            box-shadow: 0 8px 25px rgba(73, 80, 87, 0.3);
            border: 1px solid #495057;
        }
        
        /* Headers específicos para cada sección */
        #colaboradoresConectadosSection .section-header {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px 20px;
            margin: -10px -10px 20px -10px;
            border-bottom: 2px solid rgba(34, 197, 94, 0.3);
        }
        
        #colaboradoresDesconectadosSection .section-header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px 20px;
            margin: -10px -10px 20px -10px;
            border-bottom: 2px solid rgba(75, 85, 99, 0.3);
        }
        
        /* Ajustar colores de texto para mejor legibilidad */
        #colaboradoresConectadosSection .section-title i,
        #colaboradoresConectadosSection .title-text,
        #colaboradoresConectadosSection .title-subtitle {
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        #colaboradoresDesconectadosSection .section-title i,
        #colaboradoresDesconectadosSection .title-text,
        #colaboradoresDesconectadosSection .title-subtitle {
            color: #f3f4f6;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 1.4rem;
            color: #ecf0f1;
        }
        
        .title-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ecf0f1;
            margin-right: 8px;
        }
        
        .title-subtitle {
            font-size: 0.9rem;
            font-weight: 500;
            color: #bdc3c7;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .section-badge .badge {
            font-size: 0.8rem;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            animation: pulse-badge 2s infinite;
        }
        
        @keyframes pulse-badge {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .usuarios-activos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .usuarios-activos-header h3 {
            margin: 0;
        }
        
        .filtro-empleado-activo {
            min-width: 250px;
        }
        
        .filtro-empleado-activo .form-select {
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.3);
            color: #333;
        }
        
        .filtro-empleado-activo .form-select:focus {
            background: white;
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
        }
        
        /* Estilos para reporte de horas por día */
        .horas-por-dia-section {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 1px solid #495057;
            position: relative;
            overflow: hidden;
            color: white;
        }
        
        .horas-por-dia-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
        }
        
        .horas-por-dia-section h3 {
            color: #ffffff;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .horas-por-dia-section h3 i {
            color: #ffffff;
            font-size: 1.3rem;
        }
        
        /* Alert moderno para leyenda */
        .alert-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .alert-content {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .alert-content i {
            font-size: 1.2rem;
            color: #ecf0f1;
        }
        
        .alert-content strong {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ecf0f1;
        }
        
        /* Badges modernos */
        .badge-modern {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .badge-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        
        .badge-modern i {
            font-size: 0.8rem;
        }
        
        .badge-sin-horas {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }
        
        .badge-pocas-horas {
            background: linear-gradient(135deg, #87ceeb, #5dade2);
            color: white;
        }
        
        .badge-horas-normales {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .badge-muchas-horas {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .horas-por-dia-table {
            font-size: 0.7rem; /* Texto más pequeño */
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
            table-layout: fixed; /* Ancho fijo para columnas */
        }
        
        .horas-por-dia-table th,
        .horas-por-dia-table td {
            border: 1px solid #dee2e6;
            padding: 4px 2px; /* Padding más pequeño */
            text-align: center;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .horas-por-dia-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            font-size: 0.65rem; /* Header aún más pequeño */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .horas-por-dia-table th:first-child {
            text-align: left;
            width: 120px; /* Ancho fijo para columna empleado */
            position: sticky;
            left: 0;
            z-index: 11;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        .horas-por-dia-table th:not(:first-child) {
            width: 35px; /* Ancho fijo para columnas de días */
            min-width: 35px;
            max-width: 35px;
        }
        
        .horas-por-dia-table td:first-child {
            background: #f8f9fa;
            color: #2c3e50 !important;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #dee2e6;
            width: 120px;
        }
        
        .horas-por-dia-table td:not(:first-child) {
            width: 35px; /* Ancho fijo para celdas de días */
            min-width: 35px;
            max-width: 35px;
        }
        
        /* Color coding para anomalías - Paleta personalizada */
        .celda-sin-horas {
            background: linear-gradient(135deg, #6c757d, #5a6268) !important;
            color: white !important;
            font-weight: 700;
            font-size: 0.65rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #495057 !important;
            position: relative;
            overflow: hidden;
        }
        
        .celda-sin-horas::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .celda-pocas-horas {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
            font-weight: 700;
            font-size: 0.65rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #3498db !important;
            position: relative;
            overflow: hidden;
        }
        
        .celda-pocas-horas::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .celda-horas-normales {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            font-weight: 600;
            font-size: 0.65rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border: 1px solid #1e7e34 !important;
            position: relative;
            overflow: hidden;
        }
        
        .celda-horas-normales::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .celda-muchas-horas {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            font-weight: 700;
            font-size: 0.65rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #bd2130 !important;
            position: relative;
            overflow: hidden;
        }
        
        .celda-muchas-horas::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        /* Color morado para días con vacaciones aprobadas */
        .celda-vacaciones {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
            color: white !important;
            font-weight: 700;
            font-size: 0.65rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #7d3c98 !important;
            position: relative;
            overflow: hidden;
        }
        
        /* Color morado débil para domingos y feriados en encabezados de columnas */
        .horas-por-dia-table th.dia-domingo-feriado {
            background: linear-gradient(135deg, #e8d5f2, #d4b3e6) !important;
            color: #6c3483 !important;
            font-weight: 600;
        }
        
        /* Color morado débil para celdas de domingos y feriados */
        .horas-por-dia-table td.dia-domingo-feriado {
            background: linear-gradient(135deg, #f4e8fa, #e8d5f2) !important;
        }
        
        .celda-vacaciones::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        /* Efecto hover para todas las celdas */
        .horas-por-dia-table td:hover::before {
            left: 100%;
        }
        
        .celda-sin-datos {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }
        
        .horas-por-dia-table tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
        }
        
        .horas-por-dia-table tbody tr:hover td:first-child {
            background-color: #e9ecef !important;
            color: #2c3e50 !important;
        }
        
        /* Responsive para tabla de horas por día */
        @media (max-width: 768px) {
            .horas-por-dia-table {
                font-size: 0.6rem;
            }
            
            .horas-por-dia-table th:not(:first-child),
            .horas-por-dia-table td:not(:first-child) {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
            }
            
            .horas-por-dia-table th:first-child,
            .horas-por-dia-table td:first-child {
                width: 100px;
            }
            
            .celda-sin-horas,
            .celda-pocas-horas,
            .celda-horas-normales,
            .celda-muchas-horas {
                font-size: 0.6rem;
            }
        }
        
        .usuarios-activos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .usuario-activo-card {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 12px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1), 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .usuario-activo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .usuario-activo-card[style*="background-color"] {
            background: unset !important;
            backdrop-filter: unset !important;
        }
        
        .usuario-activo-card:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .usuario-activo-card:hover::before {
            opacity: 1;
        }
        
        .usuario-activo-card[style*="background-color"]:hover {
            background: unset !important;
        }
        
        /* Mejorar legibilidad del texto en tarjetas de usuarios activos con colores dinámicos */
        .usuario-activo-card[style*="background-color"] h5 {
            color: #1a1a1a !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
        }
        
        .usuario-activo-card[style*="background-color"] p,
        .usuario-activo-card[style*="background-color"] .tiempo-transcurrido,
        .usuario-activo-card[style*="background-color"] .tiempo-label,
        .usuario-activo-card[style*="background-color"] .estado-activo,
        .usuario-activo-card[style*="background-color"] .estado-jornada,
        .usuario-activo-card[style*="background-color"] .saldo-label {
            color: #2c2c2c !important;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(255,255,255,0.2);
        }
        
        .usuario-activo-card[style*="background-color"] .saldo-value:not(.saldo-positivo):not(.saldo-negativo) {
            color: #1a1a1a !important;
            font-weight: 700;
        }
        
        /* Valores de saldo con colores específicos mantienen sus colores */
        .usuario-activo-card[style*="background-color"] .saldo-value.saldo-positivo,
        .usuario-activo-card[style*="background-color"] .saldo-value.saldo-negativo {
            font-weight: 600;
        }
        
        .usuario-activo-card[style*="background-color"] .saldo-value {
            background: rgba(255,255,255,0.9) !important;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        /* Estados de jornada con colores correctos */
        .usuario-activo-card.jornada-pendientes {
            background: linear-gradient(135deg, #4169E1 0%, #357ABD 100%);
            border-left: 4px solid #4169E1;
        }
        
        .usuario-activo-card.jornada-pendientes:hover {
            background: linear-gradient(135deg, #357ABD 0%, #2E6BA8 100%);
        }
        
        .usuario-activo-card.jornada-equilibrado {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border-left: 4px solid #6c757d;
        }
        
        .usuario-activo-card.jornada-equilibrado:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        }
        
        .usuario-activo-card.jornada-extras {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border-left: 4px solid #dc3545;
        }
        
        .usuario-activo-card.jornada-extras:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }
        
        /* Bordes izquierdos para tarjetas de empleados */
        .empleado-card.jornada-pendientes {
            border-left: 4px solid #4169E1;
        }
        
        .empleado-card.jornada-equilibrado {
            border-left: 4px solid #6c757d;
        }
        
        .empleado-card.jornada-extras {
            border-left: 4px solid #dc3545;
        }
        
        /* Colores para cajitas del consolidado */
        .consolidado-item.total-horas {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border-left: 4px solid #6c757d;
        }
        
        .consolidado-item.total-extra {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-left: 4px solid #dc3545;
        }
        
        .consolidado-item.valor-extra {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-left: 4px solid #dc3545;
        }
        
        .consolidado-item.total-pendientes {
            background: linear-gradient(135deg, #4169E1 0%, #357ABD 100%);
            color: white;
            border-left: 4px solid #4169E1;
        }
        
        .consolidado-item.valor-pendientes {
            background: linear-gradient(135deg, #4169E1 0%, #357ABD 100%);
            color: white;
            border-left: 4px solid #4169E1;
        }
        
        .consolidado-item.monto-ineficiente {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border-left: 4px solid #6c757d;
        }
        
        .consolidado-item.total-horas .consolidado-value,
        .consolidado-item.total-horas .consolidado-label,
        .consolidado-item.total-extra .consolidado-value,
        .consolidado-item.total-extra .consolidado-label,
        .consolidado-item.valor-extra .consolidado-value,
        .consolidado-item.valor-extra .consolidado-label,
        .consolidado-item.total-pendientes .consolidado-value,
        .consolidado-item.total-pendientes .consolidado-label,
        .consolidado-item.valor-pendientes .consolidado-value,
        .consolidado-item.valor-pendientes .consolidado-label,
        .consolidado-item.monto-ineficiente .consolidado-value,
        .consolidado-item.monto-ineficiente .consolidado-label {
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .estado-jornada {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .estado-jornada i {
            font-size: 0.9rem;
        }
        
        .ranking-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .ranking-number {
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        .usuario-activo-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .usuario-activo-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .usuario-activo-info h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .usuario-activo-info p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .usuario-activo-info .hora-inicio {
            font-size: 0.8rem !important;
            opacity: 0.7 !important;
            font-style: italic;
        }
        
        /* Indicador de jornada en usuarios activos */
        .jornada-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .jornada-indicator i {
            font-size: 0.7rem;
        }
        
        .jornada-indicator.jornada-diurna {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }
        
        .jornada-indicator.jornada-mixta {
            background: rgba(108, 117, 125, 0.2);
            border-color: rgba(108, 117, 125, 0.4);
            color: #6c757d;
        }
        
        .jornada-indicator.jornada-nocturna {
            background: rgba(13, 110, 253, 0.2);
            border-color: rgba(13, 110, 253, 0.4);
            color: #0d6efd;
        }
        
        .saldo-hoy {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .saldo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .saldo-item:last-child {
            margin-bottom: 0;
        }
        
        .saldo-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .saldo-value {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .saldo-positivo {
            color: #dc3545; /* Rojo para extras */
        }
        
        .saldo-negativo {
            color: #4169E1; /* Azul para deuda */
        }
        
        .saldo-desglose {
            margin-top: 4px;
            padding: 4px 0;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .saldo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
            font-size: 0.8rem;
        }
        
        .saldo-item:last-child {
            margin-bottom: 0;
        }
        
        .saldo-label {
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }
        
        .saldo-valor {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .text-success-dark {
            color: #198754 !important; /* Verde más oscuro y menos chillón */
        }
        
        .usuario-activo-tiempo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 4px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }
        
        .usuario-activo-actions {
            margin-top: 12px;
            display: flex;
            justify-content: center;
        }
        
        .force-close-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border: none;
            color: #212529;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .force-close-btn:hover {
            background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            color: #212529;
        }
        
        .force-close-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .force-close-btn:focus {
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.25);
        }
        
        .tiempo-transcurrido {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }
        
        .tiempo-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .tiempo-compacto {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .tiempo-compacto .tiempo-transcurrido {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            color: #2c2c2c;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .tiempo-compacto .tiempo-label {
            font-size: 0.8rem;
            color: #4a4a4a;
            margin: 0;
            opacity: 1;
            font-weight: 600;
        }
        
        .hora-inicio-compacta {
            text-align: center;
            font-size: 0.8rem;
            color: #2c3e50;
            margin-top: 4px;
            opacity: 1;
            font-weight: 700;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid rgba(44, 62, 80, 0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .saldo-principal {
            text-align: center;
            margin: 6px 0;
            padding: 6px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 2px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .saldo-numero {
            font-size: 1.6rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            line-height: 1;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }
        
        .saldo-numero.saldo-positivo {
            color: #dc3545;
            text-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        
        .saldo-numero.saldo-negativo {
            color: #4169E1;
            text-shadow: 0 2px 4px rgba(65, 105, 225, 0.3);
        }
        
        .saldo-etiqueta {
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 4px;
            opacity: 1;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .estado-activo {
            display: flex;
            align-items: center;
            color: #90EE90;
            font-size: 0.9rem;
        }
        
        .estado-activo i {
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        .estado-activo-superior {
            position: absolute;
            top: 8px;
            right: 12px;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            color: #00ff00;
            font-size: 0.8rem;
            font-weight: 600;
            animation: parpadeo 1.5s infinite;
            z-index: 10;
        }
        
        .estado-activo-superior i {
            margin-right: 4px;
            animation: pulse 1s infinite;
        }
        
        @keyframes parpadeo {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
            }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-placeholder {
            text-align: center;
            padding: 40px;
            opacity: 0.8;
        }
        
        .loading-placeholder i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .no-usuarios-activos {
            text-align: center;
            padding: 40px;
            opacity: 0.8;
        }
        
        .no-usuarios-activos i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empleados-section {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #495057;
            color: white;
        }
        
        .empleados-section h3 {
            color: #ffffff;
        }
        
        .empleados-section h3 i {
            color: #ffffff;
        }
        
        .departamentos-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .departamentos-fila {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            align-items: start;
        }
        
        .departamento-section {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 0;
        }
        
        .departamento-title {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .departamento-title i {
            color: #ffc107;
            font-size: 1.1rem;
        }
        
        .departamento-header-row {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.2) 100%);
            border-top: 2px solid rgba(255, 193, 7, 0.5);
            border-bottom: 2px solid rgba(255, 193, 7, 0.5);
        }
        
        .departamento-header-cell {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.15) 100%);
            color: #ffffff;
            font-weight: 700;
            font-size: 1rem;
            padding: 12px 16px;
            text-align: left;
            border: none;
        }
        
        .departamento-header-cell i {
            color: #ffc107;
            margin-right: 8px;
        }
        
        /* Layout en filas con ancho variable (máximo 2 elementos por fila para tarjetas de empleado) */
        .empleados-row {
            display: grid;
            gap: 12px;
            width: 100%;
        }
        
        /* Ajustar columnas según cantidad de elementos (máximo 2 para evitar que el texto se salga) */
        .empleados-row[data-items="1"] {
            grid-template-columns: 1fr;
        }
        
        .empleados-row[data-items="2"] {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .empleados-row[data-items="3"],
        .empleados-row[data-items="4"] {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .empleados-row .empleado-card {
            min-width: 0;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .usuarios-activos-row {
            display: grid;
            gap: 12px;
            width: 100%;
        }
        
        /* Ajustar columnas según cantidad de elementos (1-4) */
        .usuarios-activos-row[data-items="1"] {
            grid-template-columns: 1fr;
        }
        
        .usuarios-activos-row[data-items="2"] {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .usuarios-activos-row[data-items="3"] {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .usuarios-activos-row[data-items="4"] {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .usuarios-activos-row .usuario-activo-card {
            min-width: 0;
            width: 100%;
        }
        
        @media (max-width: 1200px) {
            .departamentos-fila {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .departamento-section[style*="grid-column: span 4"] {
                grid-column: span 3 !important;
            }
        }
        
        @media (max-width: 768px) {
            .departamentos-fila {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .departamento-section[style*="grid-column: span 4"],
            .departamento-section[style*="grid-column: span 3"] {
                grid-column: span 2 !important;
            }
        }
        
        .empleados-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .empleados-row .empleado-card,
            .usuarios-activos-row .usuario-activo-card {
                min-width: 250px;
                max-width: 280px;
            }
        }
        
        .empleado-card {
            border: none;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .empleado-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .empleado-card[style*="background-color"] {
            background: unset !important;
        }
        
        .empleado-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-4px) scale(1.02);
        }
        
        .empleado-card:hover::before {
            opacity: 1;
        }
        
        .empleado-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        
        .empleado-card[style*="background-color"] .empleado-header {
            background: transparent !important;
        }
        
        /* Mejorar legibilidad del texto en tarjetas con colores dinámicos */
        .empleado-card[style*="background-color"] .empleado-name {
            color: #1a1a1a !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
        }
        
        .empleado-card[style*="background-color"] .empleado-type {
            color: #4a4a4a !important;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(255,255,255,0.2);
        }
        
        .empleado-card[style*="background-color"] .metric-label {
            color: #2c2c2c !important;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(255,255,255,0.2);
        }
        
        .empleado-card[style*="background-color"] .neto-indicator {
            background: rgba(255,255,255,0.9) !important;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        .empleado-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .empleado-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .empleado-details {
            flex: 1;
            min-width: 0;
        }
        
        .empleado-name {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
            text-overflow: ellipsis;
        }
        
        .empleado-type {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .empleado-metrics {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metric-item {
            text-align: center;
            min-width: 50px;
        }
        
        .metric-value {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1px;
        }
        
        .metric-label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .neto-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,249,250,0.9) 100%);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        
        .neto-indicator:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .neto-positivo {
            color: #dc3545; /* Rojo para extras */
        }
        
        .neto-negativo {
            color: #4169E1; /* Azul para deuda */
        }
        
        .neto-cero {
            color: #6c757d; /* Gris para cero */
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .empleado-content {
            display: none;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .semanas-section {
            margin-bottom: 20px;
        }
        
        .semana-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .semana-header {
            background: #e9ecef;
            padding: 6px 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            margin-bottom: 4px;
        }
        
        .semana-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .semana-dates {
            font-weight: 600;
            font-size: 0.75rem;
            color: #495057;
            min-width: 120px;
        }
        
        .semana-horas {
            font-size: 0.7rem;
            font-weight: 600;
            color: #333;
            background: rgba(255,255,255,0.8);
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            min-width: 50px;
            text-align: center;
        }
        
        .semana-neto {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 6px;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 60px;
            justify-content: center;
        }
        
        .semana-content {
            display: none;
            padding: 4px 6px;
            background: white;
        }
        
        .dias-section {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .dia-item {
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 3px;
            overflow: hidden;
        }
        
        .dia-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #e9ecef;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .dia-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .dia-fecha {
            font-size: 0.7rem;
            font-weight: 600;
            color: #333;
            min-width: 80px;
        }
        
        .dia-jornada {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 3px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .jornada-diurna {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .jornada-mixta {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .jornada-nocturna {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        .jornada-default {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .dia-neto {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 4px;
            background: rgba(255,255,255,0.8);
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
            min-width: 35px;
            text-align: center;
        }
        
        
        .turnos-section {
            margin-top: 10px;
        }
        
        .turno-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .turno-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .turno-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            border-color: #667eea;
        }
        
        .turno-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .turno-info i {
            color: #667eea;
            font-size: 1rem;
            width: 16px;
            text-align: center;
        }
        
        .turno-info span {
            color: #495057;
            font-weight: 500;
        }
        
        .turno-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .turno-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .turno-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Estilos para botones de turno - iconos pequeños con advertencia */
        .turno-actions .btn-sm {
            font-size: 0.6rem;
            padding: 3px 6px;
            border-radius: 3px;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .turno-actions .btn-sm i {
            font-size: 0.5rem;
            margin: 0;
        }
        
        .turno-actions .edit-turno-btn {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            border: 1px solid #ff8c00;
            color: #000;
            font-weight: 600;
        }
        
        .turno-actions .edit-turno-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);
            transform: translateY(-1px);
        }
        
        .turno-actions .delete-turno-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: 1px solid #c82333;
            color: #fff;
            font-weight: 600;
        }
        
        .turno-actions .delete-turno-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-1px);
        }
        
        .turno-actions .btn-sm:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .empleado-metrics {
                flex-direction: column;
                gap: 10px;
            }
            
            .consolidado-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .empleado-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        /* Estilos para el mapa GPS */
        .mapa-gps-section {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #495057;
            color: white;
        }
        
        .mapa-gps-section h3 {
            color: #ffffff;
        }
        
        .mapa-gps-section h3 i {
            color: #ffffff;
        }
        
        .mapa-gps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .mapa-gps-header h3 {
            margin: 0;
            color: var(--eco-dark);
        }
        
        .mapa-gps-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .mapa-gps-toggle {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mapa-gps-toggle:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .mapa-gps-toggle.active {
            background: #28a745;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .mapa-gps-container {
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e9ecef;
            position: relative;
        }
        
        .mapa-gps-container.hidden {
            display: none;
        }
        
        .mapa-gps-leyenda {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .mapa-gps-leyenda-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--eco-dark);
        }
        
        .mapa-gps-leyenda-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .mapa-gps-leyenda-marker.inicio {
            background: #28a745;
        }
        
        .mapa-gps-leyenda-marker.fin {
            background: #dc3545;
        }
        
        .mapa-gps-leyenda-marker.oficina {
            background: #007bff;
            width: 20px;
            height: 20px;
        }
        
        .mapa-gps-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .mapa-gps-stat-item {
            text-align: center;
        }
        
        .mapa-gps-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--eco-primary);
        }
        
        .mapa-gps-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }
        /* Estilos Calendario Vacaciones */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .calendar-header-day {
            text-align: center;
            font-weight: bold;
            color: #6c757d;
            padding: 5px;
            font-size: 0.9rem;
        }
        
        .calendar-day {
            min-height: 100px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 5px;
            position: relative;
            background-color: #fff;
        }
        
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #adb5bd;
        }
        
        .calendar-date-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.85rem;
            font-weight: bold;
            color: #495057;
        }
        
        .calendar-events {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .calendar-event {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 3px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        
        .calendar-event.approved {
            background-color: #28a745;
        }
        
        .calendar-event.pending {
            background-color: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header dinámico -->
        <div id="header-container"></div>
        
        <div class="reporte-container">
            <div class="page-header">
                <h1><i class="fas fa-heartbeat reports-icon"></i> Pulso de Horas</h1>
            </div>
            
            <!-- Filtros -->
            <div class="filtros-section" style="background: #c8e6c9; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; box-shadow: none; border: none;">
                <div class="row">
                    <div class="col-md-3">
                        <label for="mesFilter" class="form-label" style="color: #000000; font-weight: 600;">Mes</label>
                        <select class="form-select" id="mesFilter">
                            <option value="">Cargando meses...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="semanaFilter" class="form-label" style="color: #000000; font-weight: 600;">Semana</label>
                        <select class="form-select" id="semanaFilter">
                            <option value="">Todas las semanas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="empleadoFilter" class="form-label" style="color: #000000; font-weight: 600;">Empleado</label>
                        <select class="form-select" id="empleadoFilter">
                            <option value="">Todos los empleados</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-modern btn-primary-modern" id="aplicarFiltros">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Consolidado General -->
            <div class="consolidado-section">
                <h3 class="mb-4"><i class="fas fa-chart-bar"></i> Resumen General</h3>
                <div class="consolidado-grid" id="consolidadoGrid">
                    <div class="consolidado-item total-horas">
                        <div class="consolidado-value" id="totalHoras">-</div>
                        <div class="consolidado-label">Total Horas</div>
                    </div>
                    <div class="consolidado-item total-extra">
                        <div class="consolidado-value" id="totalExtra">-</div>
                        <div class="consolidado-label">Total Extra</div>
                    </div>
                    <div class="consolidado-item valor-extra">
                        <div class="consolidado-value" id="valorExtra">-</div>
                        <div class="consolidado-label">Valor Extra</div>
                    </div>
                    <div class="consolidado-item total-pendientes">
                        <div class="consolidado-value" id="totalPendientes">-</div>
                        <div class="consolidado-label">Total Pendientes</div>
                    </div>
                    <div class="consolidado-item valor-pendientes">
                        <div class="consolidado-value" id="valorPendientes">-</div>
                        <div class="consolidado-label">Valor Pendientes</div>
                    </div>
                    <div class="consolidado-item monto-ineficiente">
                        <div class="consolidado-value" id="montoIneficiente">-</div>
                        <div class="consolidado-label">Monto Ineficiente</div>
                    </div>
                </div>
            </div>
            
            <!-- Usuarios Activos en Tiempo Real -->
            <div id="colaboradoresConectadosSection" class="usuarios-activos-section">
                <div class="section-header mb-4">
                    <div class="section-title">
                        <i class="fas fa-users-cog me-2"></i>
                        <span class="title-text">Colaboradores Conectados</span>
                        <span class="title-subtitle">Tiempo Real</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" id="crearTurnoManualBtn" title="Crear turno manualmente">
                            <i class="fas fa-plus-circle me-1"></i>
                            Crear Turno
                        </button>
                        <div class="section-badge">
                            <span class="badge bg-success">
                                <i class="fas fa-power-off me-1"></i>App Prendida
                            </span>
                        </div>
                    </div>
                </div>
                <div class="usuarios-activos-grid" id="usuariosActivosGrid">
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Cargando colaboradores conectados...</span>
                    </div>
                </div>
            </div>
            
            <!-- Empleados con Horas Positivas (Sin Turnos Activos) -->
            <div id="colaboradoresDesconectadosSection" class="usuarios-activos-section">
                <div class="section-header mb-4">
                    <div class="section-title">
                        <i class="fas fa-user-check me-2"></i>
                        <span class="title-text">Colaboradores Desconectados</span>
                        <span class="title-subtitle">Sin Turnos Activos</span>
                    </div>
                    <div class="section-badge">
                        <span class="badge bg-secondary">
                            <i class="fas fa-power-off me-1"></i>App Apagada
                        </span>
                    </div>
                </div>
                <div class="usuarios-activos-grid" id="usuariosConHorasPositivasGrid">
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Cargando colaboradores desconectados...</span>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Empleados -->
            <div class="empleados-section">
                <h3 class="mb-4"><i class="fas fa-users"></i> Detalle por Empleado <small class="text-white-50">(Solo turnos cerrados)</small></h3>
                <div id="empleadosList">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando datos...</p>
                    </div>
                </div>
            </div>

            <!-- Reporte de Horas por Día -->
            <div class="horas-por-dia-section">
                <h3 class="mb-4"><i class="fas fa-calendar-check"></i> Reporte de Horas por Día</h3>
                <div class="alert alert-modern">
                    <div class="alert-content">
                        <i class="fas fa-palette me-2"></i>
                        <strong>Leyenda de Colores:</strong>
                        <span class="ms-3">
                            <span class="badge-modern badge-sin-horas me-2">
                                <i class="fas fa-times-circle me-1"></i>Sin horas
                            </span>
                            <span class="badge-modern badge-pocas-horas me-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>Pocas horas
                            </span>
                            <span class="badge-modern badge-horas-normales me-2">
                                <i class="fas fa-check-circle me-1"></i>Horas normales
                            </span>
                            <span class="badge-modern badge-muchas-horas me-2">
                                <i class="fas fa-star me-1"></i>Muchas horas
                            </span>
                        </span>
                    </div>
                </div>
                <div id="horasPorDiaTable" class="table-responsive">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Generando reporte de horas por día...</p>
                    </div>
                </div>
            </div>

            <!-- Reporte de Facturación por Empleado -->
            <div class="horas-por-dia-section">
                <h3 class="mb-4"><i class="fas fa-dollar-sign"></i> Reporte de Facturación por Empleado</h3>
                <div class="alert alert-modern">
                    <div class="alert-content">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Información:</strong> La facturación se divide entre los técnicos asignados a la ruta. El día operacional va de 5:00 AM a 4:59:59 AM del día siguiente.
                    </div>
                </div>
                
                <!-- Tabla 1: Facturación por Empleado por Día -->
                <h4 class="mt-4 mb-3"><i class="fas fa-table"></i> Facturación Total por Día</h4>
                <div id="facturacionPorDiaTable" class="table-responsive">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Generando reporte de facturación por día...</p>
                    </div>
                </div>

                <!-- Tabla 2: Facturación por Empleado por Día por Hora Laborada -->
                <h4 class="mt-5 mb-3"><i class="fas fa-clock"></i> Facturación por Hora Laborada</h4>
                <div id="facturacionPorHoraTable" class="table-responsive">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Generando reporte de facturación por hora laborada...</p>
                    </div>
                </div>
            </div>
            
            <!-- Mapa GPS -->
            <div class="mapa-gps-section">
                <div class="mapa-gps-header">
                    <h3><i class="fas fa-map-marked-alt"></i> Mapa de Ubicaciones GPS</h3>
                    <div class="mapa-gps-controls">
                        <button class="mapa-gps-toggle" id="toggleMapaGPS">
                            <i class="fas fa-map"></i> Mostrar Mapa
                        </button>
                    </div>
                </div>
                
                <div class="mapa-gps-container hidden" id="mapaGPSContainer">
                    <div id="mapaGPS" style="width: 100%; height: 100%;"></div>
                </div>
                
                <div class="mapa-gps-leyenda">
                    <div class="mapa-gps-leyenda-item">
                        <div class="mapa-gps-leyenda-marker inicio"></div>
                        <span>Inicio de Turno</span>
                    </div>
                    <div class="mapa-gps-leyenda-item">
                        <div class="mapa-gps-leyenda-marker fin"></div>
                        <span>Fin de Turno</span>
                    </div>
                    <div class="mapa-gps-leyenda-item">
                        <div class="mapa-gps-leyenda-marker oficina"></div>
                        <span>Oficina Principal</span>
                    </div>
                </div>
                
                <div class="mapa-gps-stats" id="mapaGPSStats">
                    <div class="mapa-gps-stat-item">
                        <div class="mapa-gps-stat-value" id="totalPuntosGPS">0</div>
                        <div class="mapa-gps-stat-label">Puntos GPS</div>
                    </div>
                    <div class="mapa-gps-stat-item">
                        <div class="mapa-gps-stat-value" id="iniciosGPS">0</div>
                        <div class="mapa-gps-stat-label">Inicios</div>
                    </div>
                    <div class="mapa-gps-stat-item">
                        <div class="mapa-gps-stat-value" id="finesGPS">0</div>
                        <div class="mapa-gps-stat-label">Fines</div>
                    </div>
                    <div class="mapa-gps-stat-item">
                        <div class="mapa-gps-stat-value" id="empleadosConGPS">0</div>
                        <div class="mapa-gps-stat-label">Empleados</div>
                    </div>
                    <div class="mapa-gps-stat-item">
                        <div class="mapa-gps-stat-value" id="turnosActivosGPS" style="color: #28a745;">0</div>
                        <div class="mapa-gps-stat-label">Turnos Activos</div>
                    </div>
                </div>
            </div>
    </div>
</div>

            <!-- Gestión de Vacaciones -->
            <div class="vacaciones-section mt-5 mb-5">
                <div class="section-header mb-4 d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-umbrella-beach"></i> Gestión de Vacaciones</h3>
                    <button type="button" class="btn btn-success" onclick="abrirModalCrearVacacion()">
                        <i class="fas fa-plus-circle me-2"></i>Crear Solicitud de Vacaciones
                    </button>
                </div>

                <ul class="nav nav-tabs mb-4" id="vacacionesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab" aria-controls="pendientes" aria-selected="true">
                            <i class="fas fa-list-ul me-2"></i>Solicitudes Pendientes <span class="badge bg-danger ms-1" id="badgePendientesCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="aprobadas-tab" data-bs-toggle="tab" data-bs-target="#aprobadas" type="button" role="tab" aria-controls="aprobadas" aria-selected="false">
                            <i class="fas fa-check-circle me-2"></i>Aprobadas <span class="badge bg-success ms-1" id="badgeAprobadasCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rechazadas-tab" data-bs-toggle="tab" data-bs-target="#rechazadas" type="button" role="tab" aria-controls="rechazadas" aria-selected="false">
                            <i class="fas fa-times-circle me-2"></i>Rechazadas <span class="badge bg-danger ms-1" id="badgeRechazadasCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="calendario-vacaciones-tab" data-bs-toggle="tab" data-bs-target="#calendario-vacaciones" type="button" role="tab" aria-controls="calendario-vacaciones" aria-selected="false">
                            <i class="fas fa-calendar-alt me-2"></i>Calendario de Vacaciones
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="vacacionesTabsContent">
                    <!-- Tab Pendientes -->
                    <div class="tab-pane fade show active" id="pendientes" role="tabpanel" aria-labelledby="pendientes-tab">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Empleado</th>
                                                <th>Fecha Solicitud</th>
                                                <th>Rango</th>
                                                <th>Días</th>
                                                <th>Motivo</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaSolicitudesPendientes">
                                            <tr><td colspan="6" class="text-center py-4 text-muted">Cargando solicitudes...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Aprobadas -->
                    <div class="tab-pane fade" id="aprobadas" role="tabpanel" aria-labelledby="aprobadas-tab">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Empleado</th>
                                                <th>Fecha Solicitud</th>
                                                <th>Rango</th>
                                                <th>Días</th>
                                                <th>Motivo</th>
                                                <th>Aprobado Por</th>
                                                <th>Comentario</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaSolicitudesAprobadas">
                                            <tr><td colspan="8" class="text-center py-4 text-muted">Cargando solicitudes...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Rechazadas -->
                    <div class="tab-pane fade" id="rechazadas" role="tabpanel" aria-labelledby="rechazadas-tab">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Empleado</th>
                                                <th>Fecha Solicitud</th>
                                                <th>Rango</th>
                                                <th>Días</th>
                                                <th>Motivo</th>
                                                <th>Rechazado Por</th>
                                                <th>Motivo Rechazo</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaSolicitudesRechazadas">
                                            <tr><td colspan="8" class="text-center py-4 text-muted">Cargando solicitudes...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Calendario -->
                    <div class="tab-pane fade" id="calendario-vacaciones" role="tabpanel" aria-labelledby="calendario-vacaciones-tab">
                         <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <!-- Controles Calendario -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="cambiarMesVacaciones(-1)"><i class="fas fa-chevron-left"></i></button>
                                    <h5 class="mb-0 fw-bold" id="tituloMesVacaciones">Mes Año</h5>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="cambiarMesVacaciones(1)"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <!-- Grid Calendario -->
                                <div id="gridCalendarioVacaciones" class="calendar-grid">
                                    <!-- Se genera dinámicamente -->
                                </div>
                                <div class="mt-3 d-flex gap-3 text-small text-muted">
                                    <div class="d-flex align-items-center"><span class="badge bg-success me-1">&nbsp;</span> Aprobada</div>
                                    <div class="d-flex align-items-center"><span class="badge bg-warning text-dark me-1">&nbsp;</span> Pendiente</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Aprobar Solicitud con Comentario -->
            <div class="modal fade" id="modalAprobarVacacion" tabindex="-1" aria-labelledby="modalAprobarVacacionLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalAprobarVacacionLabel">
                                <i class="fas fa-check-circle me-2"></i>Aprobar Solicitud de Vacaciones
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Información de la Solicitud -->
                            <div class="card border-0 shadow-sm mb-4" id="infoSolicitudAprobar" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                <div class="card-body">
                                    <h6 class="mb-3 text-success">
                                        <i class="fas fa-info-circle me-2"></i>Información de la Solicitud
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-1">Empleado</small>
                                                <strong id="infoEmpleadoAprobar">-</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-1">ID</small>
                                                <strong id="infoEmpleadoIdAprobar">-</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-1">Fecha de Solicitud</small>
                                                <strong id="infoFechaSolicitudAprobar">-</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-1">Total de Días Hábiles</small>
                                                <strong class="text-primary" id="infoTotalDiasAprobar">-</strong>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-1">Período de Vacaciones</small>
                                                <strong id="infoRangoFechasAprobar">-</strong>
                                            </div>
                                        </div>
                                        <div class="col-12" id="infoDiasListaAprobar" style="display: none;">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-2">Días Solicitados</small>
                                                <div class="d-flex flex-wrap gap-2" id="listaDiasAprobar">
                                                    <!-- Se llenará dinámicamente -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12" id="infoMotivoAprobarContainer" style="display: none;">
                                            <div class="info-item">
                                                <small class="text-muted d-block mb-1">Motivo</small>
                                                <em id="infoMotivoAprobar">-</em>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <form id="formAprobarVacacion">
                                <div class="mb-3">
                                    <label for="comentarioAprobacion" class="form-label">
                                        <i class="fas fa-comment me-2"></i>Comentario de Aprobación <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="comentarioAprobacion" rows="3" required placeholder="Ingresa un comentario explicando la aprobación (obligatorio para evitar aprobaciones accidentales)..."></textarea>
                                    <small class="form-text text-muted">Este comentario es obligatorio para confirmar la aprobación.</small>
                                </div>
                                <input type="hidden" id="solicitudIdAprobar" value="">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" id="confirmarAprobacionBtn">
                                <i class="fas fa-check me-2"></i>Confirmar Aprobación
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Crear Solicitud de Vacaciones -->
            <div class="modal fade" id="modalCrearVacacion" tabindex="-1" aria-labelledby="modalCrearVacacionLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalCrearVacacionLabel">
                                <i class="fas fa-umbrella-beach me-2"></i>Crear Solicitud de Vacaciones
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formCrearVacacion">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="empleadoVacacionSelect" class="form-label">
                                            <i class="fas fa-user me-2"></i>Empleado *
                                        </label>
                                        <select class="form-select" id="empleadoVacacionSelect" required>
                                            <option value="">Selecciona un empleado</option>
                                        </select>
                                        <small class="form-text text-muted">Selecciona el empleado para quien se creará la solicitud de vacaciones</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="fechaInicioVacacionAdmin" class="form-label">Fecha Inicio *</label>
                                        <input type="date" class="form-control" id="fechaInicioVacacionAdmin" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="fechaFinVacacionAdmin" class="form-label">Fecha Fin *</label>
                                        <input type="date" class="form-control" id="fechaFinVacacionAdmin" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="motivoVacacionAdmin" class="form-label">Motivo (Opcional)</label>
                                        <textarea class="form-control" id="motivoVacacionAdmin" rows="2" placeholder="Comentarios adicionales..."></textarea>
                                    </div>
                                    
                                    <div class="col-12" id="infoDiasVacacionAdmin" style="display:none;">
                                        <div class="alert alert-info py-2 mb-0" style="font-size: 0.9rem;">
                                            <i class="fas fa-info-circle me-1"></i> Se solicitarán <strong id="cantidadDiasCalcAdmin">0</strong> días hábiles (se excluyen domingos y feriados).
                                        </div>
                                    </div>

                                    <div class="col-12 text-end">
                                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-paper-plane me-2"></i>Crear Solicitud
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Crear Turno Manual -->
<div class="modal fade" id="crearTurnoModal" tabindex="-1" aria-labelledby="crearTurnoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="crearTurnoModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Crear Turno Manual
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="crearTurnoForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="empleadoSelect" class="form-label">Empleado *</label>
                            <select class="form-select" id="empleadoSelect" required>
                                <option value="">Selecciona un empleado</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipoJornadaSelect" class="form-label">Tipo de Jornada *</label>
                            <select class="form-select" id="tipoJornadaSelect" required>
                                <option value="">Selecciona tipo de jornada</option>
                                <option value="diurna">Diurna (8 horas)</option>
                                <option value="mixta">Mixta (7 horas)</option>
                                <option value="nocturna">Nocturna (6 horas)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaInicio" class="form-label">Fecha de Inicio *</label>
                            <input type="date" class="form-control" id="fechaInicio" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="horaInicio" class="form-label">Hora de Inicio *</label>
                            <input type="time" class="form-control" id="horaInicio" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaFin" class="form-label">Fecha de Fin *</label>
                            <input type="date" class="form-control" id="fechaFin" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="horaFin" class="form-label">Hora de Fin *</label>
                            <input type="time" class="form-control" id="horaFin" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notasTurno" class="form-label">Notas (opcional)</label>
                        <textarea class="form-control" id="notasTurno" rows="3" placeholder="Agrega notas adicionales sobre este turno..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Información:</strong> Este turno se creará como completado automáticamente. 
                        Las horas se calcularán basándose en la duración real del turno.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="guardarTurnoManualBtn">
                    <i class="fas fa-save me-1"></i>Crear Turno
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
    <script src="cache-buster.js"></script>
    <script src="utils.js"></script>
    <!-- Sistema de Autenticación Seguro ya cargado en el head -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, addDoc, Timestamp, updateDoc, doc, onSnapshot, serverTimestamp, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Configuración de Firebase
        const firebaseConfig = {
            projectId: "cursorwebapp-f376d",
            appId: "1:719990096116:web:07c1ff697e7655b2cd9ea1",
            databaseURL: "https://cursorwebapp-f376d-default-rtdb.firebaseio.com",
            storageBucket: "cursorwebapp-f376d.firebasestorage.app",
            apiKey: "AIzaSyC-IQj0yHR8cELr-mw-v2xlnw6LlJYFUyk",
            authDomain: "cursorwebapp-f376d.firebaseapp.com",
            messagingSenderId: "719990096116",
            measurementId: "G-DJXLKFR7CD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let empleadosData = [];
        let reporteData = {};
        let filtroMes = '';
        let filtroSemana = '';
        let filtroEmpleado = '';
        let usuariosActivosData = [];
        let usuariosActivosFiltrados = [];
        let empleadosMap = {}; // Mapa global de empleados
        
        // Variables para el mapa GPS
        let mapaGPS = null;
        let marcadoresGPS = [];
        let datosGPS = [];
        let mostrarMapa = false;
        
        // Variable global para work sessions
        let allWorkSessions = [];

        // Variable para cleanup de event listeners
        let expansionListenersController = null;

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            setupEventListeners();
            checkAuthentication();
            
            // Inicializar módulo de vacaciones
            cargarSolicitudesPendientes();
            renderCalendarioVacaciones();
        });

        // Verificar autenticación
        async function checkAuthentication() {
            try {
                // Verificar que el body esté autenticado (ya verificado en el head)
                if (document.body && !document.body.classList.contains('authenticated')) {
                    // Esperando verificación de autenticación (sin log)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    if (!document.body.classList.contains('authenticated')) {
                        if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                            // No autenticado, redirigiendo (sin log)
                            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                                window.location.replace('iniciar_sesion.html');
                            }
                            return;
                        } else {
                            document.body.style.display = 'block';
                            document.body.classList.add('authenticated');
                        }
                    }
                }
                
                // Esperar a secureAuthManager
                if (!window.secureAuthManager) {
                    let retries = 0;
                    while (!window.secureAuthManager && retries < 30) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retries++;
                    }
                }
                
                if (window.secureAuthManager) {
                    window.authManager = window.secureAuthManager;
                }
                
                if (!window.authManager || !window.authManager.isAuthenticated()) {
                    // No autenticado después de esperar (sin log)
                    if (!window.location.pathname.includes('iniciar_sesion.html')) {
                        window.location.replace('iniciar_sesion.html');
                    }
                    return;
                }

                const user = window.authManager.getCurrentUser();
                if (!user) {
                    // No se pudo obtener usuario (sin log)
                    if (!window.location.pathname.includes('iniciar_sesion.html')) {
                        window.location.replace('iniciar_sesion.html');
                    }
                    return;
                }
                
                if (!user.permisos || !user.permisos.reportes_gerenciales) {
                    alert('No tienes permisos para acceder a este módulo');
                    window.location.href = 'sin_permisos.html';
                    return;
                }

                loadData();
            } catch (error) {
                console.error('Error en autenticación:', error);
                if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
            }
        }

        // Esperar a que authManager esté disponible
        function waitForAuthManager() {
            return new Promise((resolve) => {
                const checkAuth = () => {
                    if (window.authManager) {
                        resolve();
                    } else {
                        setTimeout(checkAuth, 100);
                    }
                };
                checkAuth();
            });
        }

        // Inicializar filtros
        function initializeFilters() {
            initializeMonthFilter();
            initializeWeekFilter();
            initializeEmpleadoFilter();
        }

        // Inicializar filtro de mes
        function initializeMonthFilter() {
            const monthFilter = document.getElementById('mesFilter');
            const currentDate = new Date();
            const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
            
            // Generar opciones de los últimos 12 meses
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthValue = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                const monthText = date.toLocaleDateString('es-ES', { 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthText;
                
                if (monthValue === currentMonth) {
                    option.selected = true;
                    filtroMes = monthValue;
                }
                
                monthFilter.appendChild(option);
            }
        }

        // Inicializar filtro de semana
        function initializeWeekFilter() {
            const weekFilter = document.getElementById('semanaFilter');
            weekFilter.innerHTML = '<option value="">Todas las semanas</option>';
            
            if (filtroMes) {
                updateWeekFilter();
                // Seleccionar la semana actual por defecto
                selectCurrentWeek();
            }
        }

        // Seleccionar la semana actual por defecto
        function selectCurrentWeek() {
            const weekFilter = document.getElementById('semanaFilter');
            const today = new Date();
            const currentWeekStart = getWeekStart(today);
            const currentWeekKey = getWeekKey(currentWeekStart);
            
            // Buscar la opción que coincida con la semana actual
            for (let i = 0; i < weekFilter.options.length; i++) {
                if (weekFilter.options[i].value === currentWeekKey) {
                    weekFilter.selectedIndex = i;
                    filtroSemana = currentWeekKey;
                    break;
                }
            }
        }

        // Inicializar filtro de empleado
        function initializeEmpleadoFilter() {
            const empleadoFilter = document.getElementById('empleadoFilter');
            if (empleadoFilter) {
                empleadoFilter.addEventListener('change', function() {
                    filtroEmpleado = this.value;
                    loadData();
                    filtrarUsuariosActivos();
                });
            } else {
                console.error('❌ Elemento empleadoFilter no encontrado');
            }
        }

        // Cargar opciones del filtro de empleados
        function cargarOpcionesFiltroEmpleados() {
            const empleadoFilter = document.getElementById('empleadoFilter');
            
            // Limpiar opciones existentes
            empleadoFilter.innerHTML = '<option value="">Todos los empleados</option>';
            
            // Ordenar empleados alfabéticamente por nombre completo
            const empleadosOrdenados = [...empleadosData].sort((a, b) => {
                const nombreA = `${a.primerNombre} ${a.primerApellido}`.toLowerCase();
                const nombreB = `${b.primerNombre} ${b.primerApellido}`.toLowerCase();
                return nombreA.localeCompare(nombreB);
            });
            
            // Agregar opciones para cada empleado ordenado
            empleadosOrdenados.forEach(empleado => {
                const option = document.createElement('option');
                option.value = empleado.username;
                option.textContent = `${empleado.primerNombre} ${empleado.primerApellido} (@${empleado.username})`;
                empleadoFilter.appendChild(option);
            });
        }

        // Actualizar filtro de semana
        function updateWeekFilter() {
            const weekFilter = document.getElementById('semanaFilter');
            weekFilter.innerHTML = '<option value="">Todas las semanas</option>';
            
            // Resetear filtro de semana cuando cambia el mes
            filtroSemana = '';
            
            if (!filtroMes) return;
            
            const [year, month] = filtroMes.split('-');
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            // Generar semanas del mes
            let currentDate = new Date(firstDay);
            let weekNumber = 1;
            
            while (currentDate <= lastDay) {
                const weekStart = getWeekStart(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                // Ajustar si la semana se extiende fuera del mes
                if (weekEnd > lastDay) {
                    weekEnd.setTime(lastDay.getTime());
                }
                
                const weekKey = getWeekKey(weekStart);
                const weekText = weekKey; // Ya incluye el formato amigable
                
                const option = document.createElement('option');
                option.value = weekKey;
                option.textContent = weekText;
                weekFilter.appendChild(option);
                
                currentDate.setDate(currentDate.getDate() + 7);
                weekNumber++;
            }
        }

        // Obtener inicio de semana (lunes)
        function getWeekStart(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }

        // Obtener lunes de la semana
        function getMondayOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date);
            monday.setDate(diff);
            return monday;
        }

        // Obtener clave de semana
        function getWeekKey(date) {
            // Obtener lunes de la semana
            const monday = getMondayOfWeek(date);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            
            // Formato amigable: "3-9 Oct 2025"
            const formatDate = (date) => {
                return date.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'short' 
                });
            };
            
            const mondayStr = formatDate(monday);
            const sundayStr = formatDate(sunday);
            const year = monday.getFullYear();
            
            return `${mondayStr} - ${sundayStr} ${year}`;
        }

        // Verificar si una fecha pertenece al mes seleccionado
        function belongsToMonth(date, monthFilter) {
            if (!monthFilter) return true; // Si no hay filtro de mes, incluir todas las fechas
            
            const [year, month] = monthFilter.split('-');
            const dateYear = date.getFullYear();
            const dateMonth = date.getMonth() + 1; // getMonth() devuelve 0-11
            
            return dateYear === parseInt(year) && dateMonth === parseInt(month);
        }

        // Obtener número de semana
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Formatear fecha
        function formatDate(date) {
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit' 
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            const mesFilter = document.getElementById('mesFilter');
            if (mesFilter) {
                mesFilter.addEventListener('change', function() {
                    filtroMes = this.value;
                    updateWeekFilter();
                    // Seleccionar la semana actual del nuevo mes
                    selectCurrentWeek();
                    loadData();
                });
            }
            
            const semanaFilter = document.getElementById('semanaFilter');
            if (semanaFilter) {
                semanaFilter.addEventListener('change', function() {
                    filtroSemana = this.value;
                    loadData();
                    filtrarUsuariosActivos();
                    // Mostrar/ocultar secciones basándose en la semana seleccionada
                    toggleColaboradoresSections();
                });
            }
            
            const aplicarFiltrosBtn = document.getElementById('aplicarFiltros');
            if (aplicarFiltrosBtn) {
                aplicarFiltrosBtn.addEventListener('click', function() {
                    loadData();
                    filtrarUsuariosActivos();
                });
            }
            
            // Event listener para el botón del mapa GPS
            const toggleMapaGPS = document.getElementById('toggleMapaGPS');
            if (toggleMapaGPS) {
                toggleMapaGPS.addEventListener('click', function() {
                    toggleMapa();
                });
            }
        }

        // Cargar datos
        async function loadData() {
            try {
                
                // Mostrar loading
                document.getElementById('empleadosList').innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando datos...</p>
                    </div>
                `;
                
                // Cargar empleados
                await loadEmpleados();
                
                // Cargar work_sessions
                await loadWorkSessions();
                
                // Cargar usuarios activos
                await loadUsuariosActivos();
                
                // Cargar usuarios con horas positivas
                await loadUsuariosConHorasPositivas();
                
                // Procesar datos
                processData();
                
                // Mostrar/ocultar secciones basándose en la semana seleccionada
                toggleColaboradoresSections();
                
                // Actualizar mapa GPS si está visible
                if (mostrarMapa && mapaGPS) {
                    cargarDatosGPS();
                }
                
                // Renderizar
                renderConsolidado();
                renderEmpleados();
                
                // Configurar actualización automática de usuarios activos cada 30 segundos
                setInterval(async () => {
                    await loadUsuariosActivos();
                    await loadUsuariosConHorasPositivas();
                    // Recalcular saldo acumulado después de actualizar usuarios activos
                    if (usuariosActivosData && usuariosActivosData.length > 0) {
                        renderUsuariosActivos(usuariosActivosData, empleadosMap);
                    }
                    // Mostrar/ocultar secciones basándose en la semana seleccionada
                    toggleColaboradoresSections();
                }, 30000);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('empleadosList').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Error cargando datos. Intenta nuevamente.</p>
                    </div>
                `;
            }
        }

        // Cargar empleados
        async function loadEmpleados() {
            const empleadosRef = collection(db, 'empleados');
            const querySnapshot = await getDocs(empleadosRef);
            
            empleadosData = [];
            empleadosMap = {}; // Inicializar el mapa global
            querySnapshot.forEach((doc) => {
                const empleado = doc.data();
                
                // Incluir todos los empleados
                empleadosData.push({
                    id: doc.id,
                    ...empleado
                });
                
                // Llenar el mapa global de empleados
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                let iniciales = empleado.iniciales;
                if (!iniciales && nombreCompleto) {
                    const partes = nombreCompleto.split(' ').filter(p => p.length > 0);
                    if (partes.length >= 2) {
                        iniciales = (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
                    } else if (partes.length === 1) {
                        iniciales = partes[0].charAt(0).toUpperCase();
                    }
                }
                
                empleadosMap[empleado.username] = {
                    nombre: nombreCompleto || empleado.username,
                    iniciales: iniciales || 'XX'
                };
            });
            
            // Cargar opciones del filtro de empleados
            cargarOpcionesFiltroEmpleados();
            
        }

        // Cargar work_sessions
        async function loadWorkSessions() {
            if (!filtroMes) return;
            
            const [year, month] = filtroMes.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            const sessionsRef = collection(db, 'work_sessions');
            let q = query(
                sessionsRef,
                where('startTime', '>=', startDate),
                where('startTime', '<=', endDate)
            );
            
            const querySnapshot = await getDocs(q);
            
            const sessions = [];
            querySnapshot.forEach((doc) => {
                const session = doc.data();
                // Incluir sesiones completadas y activas (turnos en curso)
                if (session.status === 'completed' || session.status === 'working') {
                    sessions.push({
                        id: doc.id,
                        ...session
                    });
                }
            });
            
            // Asignar a la variable global
            allWorkSessions = sessions;
            
            // Agrupar por empleado usando username como referencia
            const sessionsByEmpleado = {};
            sessions.forEach(session => {
                const empleadoUsername = session.username; // Usar username directamente
                if (!sessionsByEmpleado[empleadoUsername]) {
                    sessionsByEmpleado[empleadoUsername] = [];
                }
                sessionsByEmpleado[empleadoUsername].push(session);
            });
            
            
            // Agregar sesiones a cada empleado (mantener todos los empleados con acceso a registro_horas)
            empleadosData.forEach(empleado => {
                empleado.sessions = sessionsByEmpleado[empleado.username] || [];
            });
        }

        // Verificar si la semana seleccionada es la actual
        function isCurrentWeekSelected() {
            if (!filtroSemana || filtroSemana === '') {
                return true; // Si no hay filtro de semana, mostrar secciones (comportamiento por defecto)
            }
            
            const currentWeekKey = getCurrentWeek();
            const isCurrent = filtroSemana === currentWeekKey;
            
            // Aplicando filtros (sin log)
            
            return isCurrent;
        }

        // Mostrar/ocultar secciones de colaboradores basándose en la semana seleccionada
        function toggleColaboradoresSections() {
            const isCurrentWeek = isCurrentWeekSelected();
            const conectadosSection = document.getElementById('colaboradoresConectadosSection');
            const desconectadosSection = document.getElementById('colaboradoresDesconectadosSection');
            
            // Verificando secciones (sin log)
            
            if (conectadosSection) {
                conectadosSection.style.display = isCurrentWeek ? 'block' : 'none';
                // Aplicando estilos (sin log)
            }
            
            if (desconectadosSection) {
                desconectadosSection.style.display = isCurrentWeek ? 'block' : 'none';
                // Aplicando estilos (sin log)
            }
            
        }

        // Cargar usuarios activos en tiempo real
        async function loadUsuariosActivos() {
            try {
                
                // Obtener sesiones activas (status: 'working')
                const q = query(
                    collection(db, 'work_sessions'),
                    where('status', '==', 'working')
                );
                const querySnapshot = await getDocs(q);
                
                const usuariosActivos = [];
                const ahora = new Date();
                
                querySnapshot.forEach((doc) => {
                    const session = doc.data();
                    const startTime = session.startTime.toDate();
                    const tiempoTranscurrido = ahora - startTime;
                    
                    usuariosActivos.push({
                        id: doc.id,
                        sessionId: doc.id, // ID de la sesión en Firebase
                        username: session.username,
                        startTime: startTime,
                        tiempoTranscurrido: tiempoTranscurrido
                    });
                });
                
                // Obtener nombres de empleados (solo los que tienen acceso a registro_horas)
                const empleadosRef = collection(db, 'empleados');
                const empleadosSnapshot = await getDocs(empleadosRef);
                empleadosMap = {}; // Usar la variable global
                empleadosSnapshot.forEach((doc) => {
                    const empleado = doc.data();
                    
                // Incluir todos los empleados en el mapa
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                let iniciales = empleado.iniciales;
                if (!iniciales && nombreCompleto) {
                    const partes = nombreCompleto.split(' ').filter(p => p.length > 0);
                    if (partes.length >= 2) {
                        iniciales = (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
                    } else if (partes.length === 1) {
                        iniciales = partes[0].charAt(0).toUpperCase();
                    }
                }
                
                empleadosMap[empleado.username] = {
                    nombre: nombreCompleto || empleado.username,
                    iniciales: iniciales || 'XX'
                };
                });
                
                // Incluir todos los usuarios activos que estén en el mapa de empleados
                const usuariosActivosConAcceso = usuariosActivos.filter(usuario => 
                    empleadosMap[usuario.username] !== undefined
                );
                
                
                // Guardar datos globalmente
                usuariosActivosData = usuariosActivosConAcceso;
                usuariosActivosFiltrados = usuariosActivosConAcceso;
                
                // Los usuarios activos se filtran con el filtro global de empleado
                
                // Renderizar usuarios activos
                renderUsuariosActivos(usuariosActivos, empleadosMap);
                
                // Mostrar/ocultar secciones basándose en la semana seleccionada
                toggleColaboradoresSections();
                
            } catch (error) {
                console.error('❌ Error cargando usuarios activos:', error);
                document.getElementById('usuariosActivosGrid').innerHTML = `
                    <div class="no-usuarios-activos">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error cargando colaboradores conectados</p>
                    </div>
                `;
            }
        }

        // Cargar usuarios inactivos (todos los que no están en Estado del Personal)
        async function loadUsuariosConHorasPositivas() {
            try {
                // Obtener todos los empleados
                const empleadosRef = collection(db, 'empleados');
                const empleadosSnapshot = await getDocs(empleadosRef);
                const todosLosEmpleados = [];
                
                empleadosSnapshot.forEach((doc) => {
                    const empleado = doc.data();
                    todosLosEmpleados.push({
                        username: empleado.username,
                        nombre: `${empleado.primerNombre} ${empleado.primerApellido}`,
                        iniciales: empleado.iniciales || empleado.nombre?.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'XX'
                    });
                });
                
                // Obtener sesiones activas para excluirlas
                const qActivos = query(
                    collection(db, 'work_sessions'),
                    where('status', '==', 'working')
                );
                const activosSnapshot = await getDocs(qActivos);
                const usuariosActivos = new Set();
                
                activosSnapshot.forEach((doc) => {
                    const session = doc.data();
                    usuariosActivos.add(session.username);
                });
                
                // Filtrar empleados que NO están activos (todos los inactivos)
                const empleadosInactivos = todosLosEmpleados.filter(empleado => 
                    !usuariosActivos.has(empleado.username)
                );
                
                // Calcular datos para cada empleado inactivo y verificar si tiene horas en el período
                const empleadosInactivosConDatos = [];
                
                for (const empleado of empleadosInactivos) {
                    // Calcular horas laboradas en el período seleccionado
                    const horasEnPeriodo = calcularHorasEnPeriodo(empleado.username);
                    
                    // Solo incluir si tiene horas laboradas en el período (mayor a 0)
                    if (horasEnPeriodo > 0) {
                        const saldoAcumulado = calcularSaldoAcumulado(empleado.username);
                        const saldoTotal = saldoAcumulado; // Sin turno activo, el total es el acumulado
                        
                        empleadosInactivosConDatos.push({
                            username: empleado.username,
                            nombre: empleado.nombre,
                            iniciales: empleado.iniciales,
                            saldoAcumulado: saldoAcumulado,
                            saldoTotal: saldoTotal,
                            diferenciaHoras: 0, // Sin turno activo
                            saldoHoy: { diferencia: 0, horasLaboradas: 0 }, // Sin turno activo
                            horasEnPeriodo: horasEnPeriodo
                        });
                    }
                }
                
                // Ordenar por saldo total (mayor a menor)
                empleadosInactivosConDatos.sort((a, b) => b.saldoTotal - a.saldoTotal);
                
                // Renderizar usando la misma función que usuarios activos
                renderUsuariosActivos(empleadosInactivosConDatos, empleadosMap, 'usuariosConHorasPositivasGrid');
                
                // Mostrar/ocultar secciones basándose en la semana seleccionada
                toggleColaboradoresSections();
                
            } catch (error) {
                console.error('❌ Error cargando usuarios inactivos:', error);
                document.getElementById('usuariosConHorasPositivasGrid').innerHTML = `
                    <div class="no-usuarios-activos">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error cargando colaboradores desconectados</p>
                    </div>
                `;
            }
        }

        // Calcular horas laboradas en el período seleccionado (semana o mes)
        function calcularHorasEnPeriodo(username) {
            // Buscar el empleado en empleadosData
            const empleado = empleadosData.find(emp => emp.username === username);
            if (!empleado || !empleado.sessions) {
                return 0;
            }
            
            let sesionesFiltradas = empleado.sessions;
            
            // Aplicar filtro de semana si está activo
            if (filtroSemana) {
                sesionesFiltradas = empleado.sessions.filter(session => {
                    const sessionDate = session.startTime.toDate();
                    const weekKey = getWeekKey(sessionDate);
                    return weekKey === filtroSemana;
                });
            }
            
            // Aplicar filtro de mes si está activo
            if (filtroMes) {
                const [año, mes] = filtroMes.split('-');
                const mesNum = parseInt(mes);
                const añoNum = parseInt(año);
                
                sesionesFiltradas = sesionesFiltradas.filter(session => {
                    const sessionDate = session.startTime.toDate();
                    return sessionDate.getMonth() + 1 === mesNum && sessionDate.getFullYear() === añoNum;
                });
            }
            
            // Calcular total de horas laboradas en el período
            let totalHoras = 0;
            sesionesFiltradas.forEach(session => {
                if (session.status === 'completed' && session.endTime) {
                    const startTime = session.startTime.toDate();
                    const endTime = session.endTime.toDate();
                    const duracion = endTime - startTime;
                    const horas = duracion / (1000 * 60 * 60);
                    totalHoras += horas;
                }
            });
            
            return totalHoras;
        }

        // Filtrar usuarios activos
        function filtrarUsuariosActivos() {
            if (filtroEmpleado === '') {
                usuariosActivosFiltrados = usuariosActivosData;
            } else {
                usuariosActivosFiltrados = usuariosActivosData.filter(usuario => 
                    usuario.username === filtroEmpleado
                );
            }
            
            // Obtener nombres de empleados para renderizar
            empleadosMap = {}; // Usar la variable global
            empleadosData.forEach(empleado => {
                empleadosMap[empleado.username] = `${empleado.primerNombre} ${empleado.primerApellido}`;
            });
            
            // Renderizar usuarios filtrados
            renderUsuariosActivos(usuariosActivosFiltrados, empleadosMap);
        }

        // Determinar estado de jornada para color de tarjeta
        function getEstadoJornada(diferenciaHoras) {
            const color = getNetoColor(diferenciaHoras);
            
            if (diferenciaHoras < 0) {
                return {
                    class: 'jornada-pendientes',
                    label: 'Horas Pendientes',
                    icon: 'fas fa-arrow-down',
                    color: color
                };
            } else if (diferenciaHoras === 0) {
                return {
                    class: 'jornada-equilibrado',
                    label: 'Jornada Completa',
                    icon: 'fas fa-check-circle',
                    color: color
                };
            } else {
                return {
                    class: 'jornada-extras',
                    label: 'Horas Extra',
                    icon: 'fas fa-arrow-up',
                    color: color
                };
            }
        }

        // Calcular saldo neto acumulado de turnos cerrados para un empleado (RESPETANDO filtro de semana)
        function calcularSaldoAcumulado(username) {
            
            // Si reporteData.empleados no está disponible, usar empleadosData con procesamiento manual
            if (!reporteData || !reporteData.empleados || !Array.isArray(reporteData.empleados)) {
                // reporteData.empleados no disponible, usando empleadosData (sin log)
                
                if (!empleadosData || !Array.isArray(empleadosData)) {
                    // empleadosData tampoco disponible (sin log)
                    return 0;
                }
                
                // Buscar el empleado en empleadosData
                const empleado = empleadosData.find(emp => emp.username === username);
                if (!empleado) {
                    // Empleado no encontrado (sin log)
                    return 0;
                }
                
                
                // Procesar manualmente las sesiones del empleado
                const sessions = (empleado.sessions || []).filter(session => session.endTime);
                
                if (sessions.length === 0) {
                    // No hay sesiones completadas (sin log)
                    return 0;
                }
                
                // Calcular saldo acumulado manualmente RESPETANDO filtro de semana
                let saldoAcumulado = 0;
                const tipoContrato = empleado.tipoContrato || 'Mensual';
                const departamento = empleado.departamento || '';
                const requiereDescuento = requiereDescuentoAlmuerzo(departamento);
                
                // Agrupar por semana
                const semanas = {};
                sessions.forEach(session => {
                    const sessionDate = session.startTime.toDate();
                    const weekKey = getWeekKey(sessionDate);
                    
                    // APLICAR FILTRO DE SEMANA
                    if (filtroSemana && filtroSemana !== '' && weekKey !== filtroSemana) {
                        // Excluyendo sesión de semana no seleccionada (sin log)
                        return;
                    }
                    
                    // APLICAR FILTRO DE MES (combinado con semana)
                    if (filtroMes && !belongsToMonth(sessionDate, filtroMes)) {
                        // Excluyendo sesión que no pertenece al mes seleccionado (sin log)
                        return;
                    }
                    
                    // Si no hay filtro de semana, excluir semana actual
                    if (!filtroSemana || filtroSemana === '') {
                        const semanaActual = getWeekKey(new Date());
                        if (weekKey === semanaActual) {
                            // Excluyendo sesión de semana actual (sin log)
                            return;
                        }
                    }
                    
                    if (!semanas[weekKey]) {
                        semanas[weekKey] = {
                            sessions: [],
                            resumen: { horasExtra: 0, horasPendientes: 0 }
                        };
                    }
                    semanas[weekKey].sessions.push(session);
                });
                
                
                // Procesar cada semana usando la misma lógica que calcularResumenEmpleado
                let totalHorasExtra = 0;
                let totalHorasPendientes = 0;
                
                Object.values(semanas).forEach(semana => {
                    const semanaData = processSemanaData(semana, tipoContrato, requiereDescuento);
                    
                    if (tipoContrato === 'Mensual') {
                        // Solo semanas con neto positivo para extras
                        const netoSemanal = semanaData.resumen.horasExtra - semanaData.resumen.horasPendientes;
                        if (netoSemanal > 0) {
                            totalHorasExtra += semanaData.resumen.horasExtra;
                        }
                        totalHorasPendientes += semanaData.resumen.horasPendientes;
                    } else {
                        // Suma simple para empleados por horas
                        totalHorasExtra += semanaData.resumen.horasExtra;
                        totalHorasPendientes += semanaData.resumen.horasPendientes;
                    }
                });
                
                saldoAcumulado = totalHorasExtra - totalHorasPendientes;
                
                // Saldo acumulado calculado (sin log)
                return saldoAcumulado;
            }
            
            // Buscar el empleado en reporteData.empleados (datos procesados)
            const empleado = reporteData.empleados.find(emp => {
                return emp.username === username || emp.id === username;
            });
            
            if (!empleado) {
                return 0;
            }
            
            
            // Calcular saldo acumulado RESPETANDO filtro de semana
            let saldoAcumulado = 0;
            const tipoContrato = empleado.tipoContrato || 'Mensual';
            // Obtener departamento del empleado desde empleadosData
            const empleadoCompleto = empleadosData.find(e => e.id === empleado.id || e.username === empleado.username);
            const departamento = empleadoCompleto?.departamento || '';
            const requiereDescuento = requiereDescuentoAlmuerzo(departamento);
            
            if (empleado.semanas && empleado.semanas.length > 0) {
                let totalHorasExtra = 0;
                let totalHorasPendientes = 0;
                
                empleado.semanas.forEach((semana, index) => {
                    // APLICAR FILTRO DE SEMANA
                    if (filtroSemana && filtroSemana !== '' && semana.weekKey !== filtroSemana) {
                        // Excluyendo semana no seleccionada (sin log)
                        return;
                    }
                    
                    // APLICAR FILTRO DE MES: Filtrar sesiones dentro de la semana que pertenecen al mes
                    let sesionesFiltradas = semana.sessions || [];
                    if (filtroMes) {
                        sesionesFiltradas = sesionesFiltradas.filter(session => {
                            const sessionDate = session.startTime.toDate();
                            return belongsToMonth(sessionDate, filtroMes);
                        });
                        
                        // Si no hay sesiones que pertenezcan al mes, excluir la semana completa
                        if (sesionesFiltradas.length === 0) {
                            // Excluyendo semana sin sesiones del mes seleccionado (sin log)
                            return;
                        }
                        
                        // Recalcular resumen solo con sesiones del mes
                        const semanaFiltrada = {
                            sessions: sesionesFiltradas,
                            resumen: { horasExtra: 0, horasPendientes: 0 }
                        };
                        const semanaData = processSemanaData(semanaFiltrada, tipoContrato, requiereDescuento);
                        semana.resumen = semanaData.resumen;
                    }
                    
                    // Si no hay filtro de semana, excluir semana actual
                    if (!filtroSemana || filtroSemana === '') {
                        const semanaActual = getWeekKey(new Date());
                        if (semana.weekKey === semanaActual) {
                            // Excluyendo semana actual (sin log)
                            return;
                        }
                    }
                    
                    
                    if (tipoContrato === 'Mensual') {
                        // Solo semanas con neto positivo para extras
                        const netoSemanal = semana.resumen.horasExtra - semana.resumen.horasPendientes;
                        if (netoSemanal > 0) {
                            totalHorasExtra += semana.resumen.horasExtra;
                        }
                        totalHorasPendientes += semana.resumen.horasPendientes;
                    } else {
                        // Suma simple para empleados por horas
                        totalHorasExtra += semana.resumen.horasExtra;
                        totalHorasPendientes += semana.resumen.horasPendientes;
                    }
                });
                
                saldoAcumulado = totalHorasExtra - totalHorasPendientes;
                
                // Saldo acumulado calculado (sin log)
            } else {
                // No hay semanas disponibles (sin log)
            }
            
            return saldoAcumulado;
        }

        // Renderizar usuarios activos
        function renderUsuariosActivos(usuariosActivos, empleadosMap, containerId = 'usuariosActivosGrid') {
            const container = document.getElementById(containerId);
            
            if (usuariosActivos.length === 0) {
                container.innerHTML = `
                    <div class="no-usuarios-activos">
                        <i class="fas fa-user-slash"></i>
                        <p>No hay ${containerId === 'usuariosActivosGrid' ? 'colaboradores conectados' : 'colaboradores desconectados'} en este momento</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar usuarios por diferencia de horas (mayor a menor)
            const usuariosOrdenados = usuariosActivos.map(usuario => {
                // Detectar si es usuario activo (tiene startTime) o inactivo
                const esActivo = usuario.startTime !== undefined;
                
                let saldoHoy, diferenciaHoras;
                if (esActivo) {
                    saldoHoy = calcularSaldoHoy(usuario.startTime, usuario.tiempoTranscurrido);
                    diferenciaHoras = saldoHoy.diferencia;
                } else {
                    // Usuario inactivo: saldo de hoy es 0
                    saldoHoy = { diferencia: 0, horasLaboradas: 0, jornadaEsperada: 0 };
                    diferenciaHoras = 0;
                }
                
                const saldoAcumulado = usuario.saldoAcumulado || calcularSaldoAcumulado(usuario.username);
                const saldoTotal = saldoAcumulado + diferenciaHoras;
                
                return {
                    ...usuario,
                    esActivo: esActivo,
                    diferenciaHoras: diferenciaHoras,
                    saldoHoy: saldoHoy,
                    saldoAcumulado: saldoAcumulado,
                    saldoTotal: saldoTotal
                };
            }).sort((a, b) => b.saldoTotal - a.saldoTotal);
            
            // Agrupar usuarios por departamento
            const usuariosPorDepartamento = {};
            usuariosOrdenados.forEach(usuario => {
                const empleado = empleadosData.find(emp => emp.username === usuario.username);
                const departamento = empleado?.departamento || 'Sin Departamento';
                
                if (!usuariosPorDepartamento[departamento]) {
                    usuariosPorDepartamento[departamento] = [];
                }
                usuariosPorDepartamento[departamento].push(usuario);
            });
            
            // Ordenar departamentos por cantidad de usuarios (mayor a menor), "Sin Departamento" al final
            const departamentosOrdenados = Object.keys(usuariosPorDepartamento).sort((a, b) => {
                if (a === 'Sin Departamento') return 1;
                if (b === 'Sin Departamento') return -1;
                const cantidadA = usuariosPorDepartamento[a].length;
                const cantidadB = usuariosPorDepartamento[b].length;
                return cantidadB - cantidadA; // Mayor a menor
            });
            
            // Distribuir departamentos en un grid de 4 columnas totales
            const MAX_COLUMNAS = 4;
            const MAX_ELEMENTOS_POR_FILA = 4;
            
            // Preparar lista de departamentos con su información
            const departamentosList = departamentosOrdenados.map(departamento => {
                const usuarios = usuariosPorDepartamento[departamento];
                const cantidadUsuarios = usuarios.length;
                const necesitaNuevaFila = cantidadUsuarios > MAX_ELEMENTOS_POR_FILA;
                const columnasOcupadas = necesitaNuevaFila ? MAX_COLUMNAS : Math.min(cantidadUsuarios, MAX_COLUMNAS);
                
                return {
                    departamento,
                    usuarios,
                    cantidadUsuarios,
                    necesitaNuevaFila,
                    columnasOcupadas
                };
            });
            
            // Renderizar en grid de 4 columnas
            let html = '<div class="departamentos-grid">';
            let columnaActual = 0;
            
            departamentosList.forEach((dept, index) => {
                // Si este departamento necesita nueva fila o no cabe en la fila actual
                if (dept.necesitaNuevaFila || (columnaActual + dept.columnasOcupadas > MAX_COLUMNAS)) {
                    // Cerrar fila anterior si hay elementos
                    if (columnaActual > 0) {
                        html += '</div>'; // Cerrar departamentos-fila
                    }
                    // Iniciar nueva fila
                    html += '<div class="departamentos-fila">';
                    columnaActual = 0;
                }
                
                // Renderizar departamento
                if (dept.necesitaNuevaFila) {
                    // Departamento con más de 4 usuarios: ocupa las 4 columnas y se divide internamente
                    html += `
                        <div class="departamento-section" style="grid-column: span ${MAX_COLUMNAS};">
                            <h4 class="departamento-title mb-2">
                                <i class="fas fa-building"></i> ${dept.departamento}
                                <span class="badge bg-secondary ms-2">${dept.cantidadUsuarios}</span>
                            </h4>
                    `;
                    
                    // Dividir usuarios en filas de máximo 4
                    const filasUsuarios = [];
                    for (let i = 0; i < dept.usuarios.length; i += MAX_ELEMENTOS_POR_FILA) {
                        filasUsuarios.push(dept.usuarios.slice(i, i + MAX_ELEMENTOS_POR_FILA));
                    }
                    
                    filasUsuarios.forEach((filaUsuarios) => {
                        // Siempre usar 4 columnas para mantener el mismo ancho en todas las filas
                        html += `<div class="usuarios-activos-row" data-items="4">`;
                        filaUsuarios.forEach(usuario => {
                            html += renderUsuarioCard(usuario, empleadosMap);
                        });
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                    columnaActual = MAX_COLUMNAS; // Ocupa toda la fila
                } else {
                    // Departamento normal: ocupa columnas proporcionales
                    html += `
                        <div class="departamento-section" style="grid-column: span ${dept.columnasOcupadas};">
                            <h4 class="departamento-title mb-2">
                                <i class="fas fa-building"></i> ${dept.departamento}
                                <span class="badge bg-secondary ms-2">${dept.cantidadUsuarios}</span>
                            </h4>
                            <div class="usuarios-activos-row" data-items="${dept.cantidadUsuarios}">
                    `;
                    dept.usuarios.forEach(usuario => {
                        html += renderUsuarioCard(usuario, empleadosMap);
                    });
                    html += `
                            </div>
                        </div>
                    `;
                    columnaActual += dept.columnasOcupadas;
                }
            });
            
            // Cerrar última fila si hay elementos
            if (columnaActual > 0) {
                html += '</div>'; // Cerrar departamentos-fila
            }
            
            html += '</div>'; // Cerrar departamentos-grid
            
            container.innerHTML = html;
            
            // Configurar event listeners para los botones de forzar cierre
            setupExpansionListeners();
        }
        
        // Función auxiliar para renderizar tarjeta de usuario
        function renderUsuarioCard(usuario, empleadosMap) {
            const empleadoInfo = empleadosMap[usuario.username] || { nombre: usuario.username, iniciales: 'XX' };
            const nombreCompleto = empleadoInfo.nombre;
            const iniciales = empleadoInfo.iniciales;
            
            const saldoHoy = usuario.saldoHoy;
            const saldoAcumulado = usuario.saldoAcumulado;
            const saldoTotal = usuario.saldoTotal;
            
            // Determinar el estado de la jornada para el color de la tarjeta basado en saldo total
            const estadoJornada = getEstadoJornada(saldoTotal);
            
            if (usuario.esActivo) {
                // Usuario ACTIVO - con turno abierto
                const tiempoFormateado = formatTiempoTranscurrido(usuario.tiempoTranscurrido);
                const horaInicio = formatHoraInicio(usuario.startTime);
                
                // Determinar tipo de jornada basado en hora de inicio
                const jornadaType = getJornadaType(usuario.startTime);
                const jornadaIcon = getJornadaIcon(jornadaType);
                const jornadaClass = getJornadaClass(jornadaType);
                
                return `
                    <div class="usuario-activo-card ${estadoJornada.class}" style="background-color: ${estadoJornada.color} !important; position: relative;">
                        <button class="btn btn-sm btn-warning force-close-btn position-absolute" 
                                data-username="${usuario.username}" 
                                data-session-id="${usuario.sessionId}"
                                title="Forzar cierre de turno"
                                style="top: 8px; right: 8px; z-index: 10; padding: 4px 6px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <div class="usuario-activo-header">
                            <div class="usuario-activo-info">
                                <h5>${nombreCompleto}</h5>
                                <div class="jornada-indicator ${jornadaClass}">
                                    <i class="fas ${jornadaIcon}"></i>
                                    ${jornadaType}
                                </div>
                            </div>
                        </div>
                        <div class="saldo-principal">
                            <div class="saldo-numero ${saldoTotal >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">
                                ${saldoTotal >= 0 ? '+' : ''}${saldoTotal.toFixed(1)}h
                            </div>
                            <div class="saldo-etiqueta">
                                ${saldoTotal >= 0 ? 'Saldo Total Positivo' : 'Saldo Total Negativo'}
                            </div>
                        </div>
                        <div class="saldo-desglose">
                            <div class="saldo-item">
                                <span class="saldo-label">Saldo hoy:</span>
                                <span class="saldo-valor ${saldoHoy.diferencia >= 0 ? 'text-danger' : 'text-primary'}">
                                    ${saldoHoy.diferencia >= 0 ? '+' : ''}${saldoHoy.diferencia.toFixed(1)}h
                                </span>
                            </div>
                            <div class="saldo-item">
                                <span class="saldo-label">Saldos cerrados:</span>
                                <span class="saldo-valor ${saldoAcumulado === 0 ? 'text-dark' : (saldoAcumulado > 0 ? 'text-success-dark' : 'text-warning')}">
                                    ${saldoAcumulado >= 0 ? '+' : ''}${saldoAcumulado.toFixed(1)}h
                                </span>
                            </div>
                        </div>
                        <div class="usuario-activo-tiempo">
                            <div class="tiempo-compacto">
                                <span class="tiempo-transcurrido">${tiempoFormateado}</span>
                                <span class="tiempo-label">Laboradas</span>
                            </div>
                            <div class="hora-inicio-compacta">
                                <span>Inició: ${horaInicio}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" 
                                        onclick="abrirModalEditarHoraInicio('${usuario.username}', '${usuario.sessionId}', '${horaInicio}')"
                                        title="Editar hora de inicio">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Usuario INACTIVO - sin turno abierto (versión simplificada)
                return `
                    <div class="usuario-activo-card ${estadoJornada.class}" style="background-color: ${estadoJornada.color} !important;">
                        <div class="usuario-activo-header">
                            <div class="usuario-activo-info">
                                <h5>${nombreCompleto}</h5>
                            </div>
                        </div>
                        <div class="saldo-principal">
                            <div class="saldo-numero ${saldoTotal >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">
                                ${saldoTotal >= 0 ? '+' : ''}${saldoTotal.toFixed(1)}h
                            </div>
                            <div class="saldo-etiqueta">
                                ${saldoTotal >= 0 ? 'Saldo Total Positivo' : 'Saldo Total Negativo'}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Formatear tiempo transcurrido
        function formatTiempoTranscurrido(milliseconds) {
            const horas = milliseconds / (1000 * 60 * 60);
            return `${horas.toFixed(1)}h`;
        }

        // Formatear hora de inicio
        function formatHoraInicio(startTime) {
            const fecha = startTime.toDate ? startTime.toDate() : new Date(startTime);
            return fecha.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            });
        }

        // Obtener iniciales del nombre
        function getIniciales(nombre) {
            return nombre.split(' ')
                .map(palabra => palabra.charAt(0))
                .join('')
                .toUpperCase()
                .substring(0, 2);
        }

        // Función para obtener el color basado en el valor del neto
        function getNetoColor(neto) {
            if (neto <= -9) {
                return '#000080'; // Azul oscuro (dark blue) - deuda alta
            } else if (neto <= -6) {
                return '#4169E1'; // Azul normal (royal blue) - deuda media
            } else if (neto <= -3) {
                return '#87CEEB'; // Azul claro (sky blue) - deuda baja
            } else if (neto < 0) {
                return '#E0F6FF'; // Azul tenue (very light blue) - deuda mínima
            } else if (neto === 0) {
                return '#E0E0E0'; // Gris neutro (neutral gray) - equilibrado
            } else if (neto < 3) {
                return '#FFE0E0'; // Rojo tenue (very light red) - extras mínimas
            } else if (neto < 6) {
                return '#FFB3B3'; // Rojo claro (light red) - extras bajas
            } else if (neto < 9) {
                return '#FF6B6B'; // Rojo normal (light red) - extras altas
            } else {
                return '#DC143C'; // Rojo oscuro (crimson) - extras muy altas
            }
        }

        // Calcular saldo de hoy basado en jornada del día (hora de inicio)
        function calcularSaldoHoy(startTime, tiempoTranscurrido) {
            const fechaInicio = startTime.toDate ? startTime.toDate() : new Date(startTime);
            const horaInicio = fechaInicio.getHours();
            
            // Determinar tipo de jornada del día basado en hora de inicio (lógica corregida)
            let jornadaEsperada;
            if (horaInicio >= 5 && horaInicio < 12) {
                jornadaEsperada = 8.0; // Jornada Diurna (05:00-11:59)
            } else if (horaInicio >= 12 && horaInicio < 19) {
                jornadaEsperada = 7.0; // Jornada Mixta (12:00-18:59)
            } else {
                jornadaEsperada = 6.0; // Jornada Nocturna (19:00-04:59)
            }
            
            // Convertir tiempo transcurrido a horas
            const horasTrabajadas = tiempoTranscurrido / (1000 * 60 * 60);
            
            // Calcular saldo (diferencia entre trabajado y jornada del día)
            const diferencia = horasTrabajadas - jornadaEsperada;
            
            return {
                horasTrabajadas: horasTrabajadas,
                jornadaEsperada: jornadaEsperada,
                diferencia: diferencia
            };
        }

        // Procesar datos
        function processData() {
            
            reporteData = {
                consolidadoGeneral: {
                    totalEmpleados: 0,
                    totalHorasLaboradas: 0,
                    totalHorasExtra: 0,
                    totalHorasPendientes: 0,
                    netoTotal: 0,
                    empleadosPositivos: 0,
                    empleadosNegativos: 0
                },
                empleados: []
            };
            
            // Filtrar empleados si hay filtro aplicado
            let empleadosFiltrados = empleadosData;
            if (filtroEmpleado) {
                empleadosFiltrados = empleadosData.filter(empleado => empleado.username === filtroEmpleado);
            }
            
            // Aplicar filtro de semana y mes a las sesiones de cada empleado
            if (filtroSemana || filtroMes) {
                empleadosFiltrados = empleadosFiltrados.map(empleado => {
                    const empleadoFiltrado = { ...empleado };
                    if (empleadoFiltrado.sessions) {
                        empleadoFiltrado.sessions = empleadoFiltrado.sessions.filter(session => {
                            const sessionDate = session.startTime.toDate();
                            
                            // Aplicar filtro de semana
                            if (filtroSemana) {
                            const weekKey = getWeekKey(sessionDate);
                                if (weekKey !== filtroSemana) {
                                    return false;
                                }
                            }
                            
                            // Aplicar filtro de mes (combinado con semana)
                            if (filtroMes && !belongsToMonth(sessionDate, filtroMes)) {
                                return false;
                            }
                            
                            return true;
                        });
                    }
                    return empleadoFiltrado;
                });
            }
            
            empleadosFiltrados.forEach(empleado => {
                const empleadoData = processEmpleadoData(empleado);
                
                // Solo incluir empleados con horas laboradas > 0
                if (empleadoData.resumen.horasLaboradas > 0) {
                    reporteData.empleados.push(empleadoData);
                    
                    // Actualizar consolidado
                    reporteData.consolidadoGeneral.totalEmpleados++;
                    reporteData.consolidadoGeneral.totalHorasLaboradas += empleadoData.resumen.horasLaboradas;
                    reporteData.consolidadoGeneral.totalHorasExtra += empleadoData.resumen.horasExtra;
                    reporteData.consolidadoGeneral.totalHorasPendientes += empleadoData.resumen.horasPendientes;
                    reporteData.consolidadoGeneral.netoTotal += empleadoData.resumen.netoHoras;
                    
                    if (empleadoData.resumen.netoHoras > 0) {
                        reporteData.consolidadoGeneral.empleadosPositivos++;
                    } else if (empleadoData.resumen.netoHoras < 0) {
                        reporteData.consolidadoGeneral.empleadosNegativos++;
                    }
                }
            });
            
            // Ordenar empleados por neto (descendente)
            reporteData.empleados.sort((a, b) => b.resumen.netoHoras - a.resumen.netoHoras);
            
            // Generar reporte de horas por día
            generarReporteHorasPorDia();
            generarReporteFacturacionPorEmpleado();
            
        }

        // Función helper para verificar si un departamento requiere descuento de 1 hora por día
        function requiereDescuentoAlmuerzo(departamento) {
            if (!departamento) return false;
            const departamentosConAlmuerzo = [
                'Ventas',
                'Administración',
                'Logística',
                'Recursos Humanos',
                'Contabilidad',
                'Gerencia'
            ];
            return departamentosConAlmuerzo.includes(departamento);
        }

        // Procesar datos de un empleado
        function processEmpleadoData(empleado) {
            const tipoContrato = empleado.tipoContrato || 'Mensual';
            const departamento = empleado.departamento || '';
            const requiereDescuento = requiereDescuentoAlmuerzo(departamento);
            
            // Filtrar solo sesiones completadas (con endTime) para el cálculo del neto
            const sessions = (empleado.sessions || []).filter(session => session.endTime);
            
            // Agrupar por semana
            const semanas = {};
            sessions.forEach(session => {
                const sessionDate = session.startTime.toDate();
                const weekKey = getWeekKey(sessionDate);
                
                // APLICAR FILTRO DE SEMANA
                if (filtroSemana && filtroSemana !== '' && weekKey !== filtroSemana) {
                    return;
                }
                
                // APLICAR FILTRO DE MES (combinado con semana)
                if (filtroMes && !belongsToMonth(sessionDate, filtroMes)) {
                    return;
                }
                
                if (!semanas[weekKey]) {
                    semanas[weekKey] = {
                        weekKey: weekKey,
                        sessions: [],
                        resumen: {
                            horasLaboradas: 0,
                            horasExtra: 0,
                            horasPendientes: 0,
                            netoHoras: 0
                        }
                    };
                }
                
                semanas[weekKey].sessions.push(session);
            });
            
            // Procesar cada semana
            Object.values(semanas).forEach(semana => {
                const semanaData = processSemanaData(semana, tipoContrato, requiereDescuento);
                semana.resumen = semanaData.resumen;
                semana.dias = semanaData.dias;
            });
            
            // Calcular resumen del empleado
            const resumen = calcularResumenEmpleado(semanas, tipoContrato);
            
            return {
                id: empleado.id,
                username: empleado.username, // Agregar username
                nombre: `${empleado.primerNombre} ${empleado.primerApellido}`,
                tipoContrato: tipoContrato,
                resumen: resumen,
                semanas: Object.values(semanas)
            };
        }

        // Procesar datos de una semana
        function processSemanaData(semana, tipoContrato, requiereDescuento = false) {
            // Filtrar solo sesiones completadas (con endTime) para el cálculo del neto
            const sessions = semana.sessions.filter(session => session.endTime);
            
            // Agrupar por día
            const dias = {};
            sessions.forEach(session => {
                const sessionDate = session.startTime.toDate();
                // Usar fecha local en lugar de UTC para evitar problemas de zona horaria
                const year = sessionDate.getFullYear();
                const month = String(sessionDate.getMonth() + 1).padStart(2, '0');
                const day = String(sessionDate.getDate()).padStart(2, '0');
                const dayKey = `${year}-${month}-${day}`;
                
                
                if (!dias[dayKey]) {
                    // Determinar tipo de jornada basándose en el horario completo
                    const startTime = session.startTime.toDate();
                    const endTime = session.endTime ? session.endTime.toDate() : null;
                    const jornadaType = getJornadaType(startTime, endTime);
                    
                    dias[dayKey] = {
                        fecha: dayKey,
                        sessions: [],
                        jornadaType: jornadaType,
                        resumen: {
                            horasLaboradas: 0,
                            horasExtra: 0,
                            horasPendientes: 0
                        }
                    };
                }
                
                dias[dayKey].sessions.push(session);
            });
            
            // Procesar cada día
            Object.values(dias).forEach(dia => {
                try {
                    const diaData = processDiaData(dia, tipoContrato, requiereDescuento);
                    dia.resumen = diaData.resumen;
                    dia.turnos = diaData.turnos;
                } catch (error) {
                    console.error('Error procesando día:', error, dia);
                    // Asignar valores por defecto en caso de error
                    dia.resumen = { horasLaboradas: 0, horasExtra: 0, horasPendientes: 0 };
                    dia.turnos = [];
                }
            });
            
            // Calcular resumen de la semana
            const resumen = calcularResumenSemana(dias, tipoContrato);
            
            return {
                resumen: resumen,
                dias: Object.values(dias)
            };
        }

        // Procesar datos de un día
        function processDiaData(dia, tipoContrato, requiereDescuento = false) {
            const sessions = dia.sessions;
            const jornadaType = dia.jornadaType;
            
            // Calcular horas laboradas
            let horasLaboradas = 0;
            sessions.forEach(session => {
                if (session.endTime) {
                    const duracion = (session.endTime.toDate() - session.startTime.toDate()) / (1000 * 60 * 60);
                    horasLaboradas += duracion;
                }
            });
            
            // Aplicar descuento de 1 hora por día si el empleado pertenece a departamentos con almuerzo
            // Solo se descuenta una vez por día, aunque haya múltiples turnos
            if (requiereDescuento && horasLaboradas > 0) {
                horasLaboradas = Math.max(0, horasLaboradas - 1);
            }
            
            // Calcular horas esperadas según jornada
            const horasEsperadas = getJornadaHours(jornadaType);
            
            // Calcular extra/pendientes según tipo de contrato
            let horasExtra = 0;
            let horasPendientes = 0;
            
            if (tipoContrato === 'Por horas') {
                // Solo horas extra diarias
                if (horasLaboradas > horasEsperadas) {
                    horasExtra = horasLaboradas - horasEsperadas;
                }
                // No hay horas pendientes para empleados por horas
            } else {
                // Lógica mensual
                const diferencia = horasLaboradas - horasEsperadas;
                if (diferencia > 0) {
                    horasExtra = diferencia;
                } else if (diferencia < 0) {
                    horasPendientes = Math.abs(diferencia);
                }
            }
            
            // Procesar turnos
            const turnos = sessions.map(session => ({
                id: session.id, // ID real de la sesión de Firebase
                inicio: session.startTime.toDate().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true
                }),
                fin: session.endTime ? session.endTime.toDate().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true
                }) : 'En curso',
                duracion: session.endTime ? (session.endTime.toDate() - session.startTime.toDate()) / (1000 * 60 * 60) : 0,
                notas: session.notes || '',
                // Guardar referencias originales para edición
                sessionData: {
                    id: session.id,
                    startTime: session.startTime,
                    endTime: session.endTime,
                    notes: session.notes
                }
            }));
            
            return {
                resumen: {
                    horasLaboradas: horasLaboradas,
                    horasExtra: horasExtra,
                    horasPendientes: horasPendientes
                },
                turnos: turnos
            };
        }

        // Obtener tipo de jornada
        function getJornadaType(startTime, endTime = null) {
            const startHour = startTime.getHours();
            
            // Si hay hora de fin, analizar el rango completo del turno
            if (endTime) {
                const endHour = endTime.getHours();
                
                // Lógica mejorada: clasificar basado en el horario de inicio y el rango
                // Diurna: 05:00 - 11:59
                if (startHour >= 5 && startHour < 12) {
                    return 'Diurna';
                }
                // Mixta: 12:00 - 18:59 (incluye turnos que empiezan en la tarde)
                else if (startHour >= 12 && startHour < 19) {
                    return 'Mixta';
                }
                // Nocturna: 19:00 - 04:59 (incluye turnos nocturnos y madrugada)
                else {
                    return 'Nocturna';
                }
            }
            
            // Solo hora de inicio (lógica corregida)
            if (startHour >= 5 && startHour < 12) return 'Diurna';
            if (startHour >= 12 && startHour < 19) return 'Mixta';
            return 'Nocturna';
        }

        // Obtener horas esperadas según jornada
        function getJornadaHours(jornadaType) {
            switch(jornadaType) {
                case 'Diurna': return 8;
                case 'Mixta': return 7;
                case 'Nocturna': return 6;
                default: return 8;
            }
        }

        // Calcular resumen de empleado
        function calcularResumenEmpleado(semanas, tipoContrato) {
            let totalHorasLaboradas = 0;
            let totalHorasExtra = 0;
            let totalHorasPendientes = 0;
            
            Object.values(semanas).forEach(semana => {
                totalHorasLaboradas += semana.resumen.horasLaboradas;
                
                if (tipoContrato === 'Mensual') {
                    // Para horas extra: solo sumar semanas con horas extra (ignorar semanas con saldo negativo)
                    // Las horas pendientes no se restan de las horas extra, son a favor del empleado
                    if (semana.resumen.horasExtra > 0) {
                        totalHorasExtra += semana.resumen.horasExtra;
                    }
                    // Sumar todas las horas pendientes (para información, pero no se restan de las horas extra)
                    totalHorasPendientes += semana.resumen.horasPendientes;
                } else {
                    // Suma simple para empleados por horas
                    totalHorasExtra += semana.resumen.horasExtra;
                }
            });
            
            // El neto ya no es la diferencia, sino solo las horas extra (las pendientes son a favor del empleado)
            const netoHoras = totalHorasExtra;
            
            return {
                horasLaboradas: totalHorasLaboradas,
                horasExtra: totalHorasExtra,
                horasPendientes: totalHorasPendientes,
                netoHoras: netoHoras
            };
        }

        // Calcular resumen de semana
        function calcularResumenSemana(dias, tipoContrato) {
            let totalHorasLaboradas = 0;
            let totalHorasExtra = 0;
            let totalHorasPendientes = 0;
            
            // Calcular horas laboradas totales
            Object.values(dias).forEach(dia => {
                totalHorasLaboradas += dia.resumen.horasLaboradas;
            });
            
            if (tipoContrato === 'Por horas') {
                // Para empleados por horas: suma horas extra diarias
                Object.values(dias).forEach(dia => {
                    totalHorasExtra += dia.resumen.horasExtra;
                    // No hay horas pendientes para empleados por horas
                });
            } else {
                // Para empleados mensuales: neteo semanal
                // Calcular horas de jornada esperadas para la semana
                let totalHorasJornada = 0;
                Object.values(dias).forEach(dia => {
                    const jornadaType = dia.jornadaType;
                    const horasEsperadas = getJornadaHours(jornadaType);
                    totalHorasJornada += horasEsperadas;
                });
                
                const diferencia = totalHorasLaboradas - totalHorasJornada;
                if (diferencia > 0) {
                    // Solo horas extra
                    totalHorasExtra = diferencia;
                    totalHorasPendientes = 0;
                } else if (diferencia < 0) {
                    // Solo horas pendientes
                    totalHorasExtra = 0;
                    totalHorasPendientes = Math.abs(diferencia);
                } else {
                    // Normal
                    totalHorasExtra = 0;
                    totalHorasPendientes = 0;
                }
            }
            
            const netoHoras = totalHorasExtra - totalHorasPendientes;
            
            return {
                horasLaboradas: totalHorasLaboradas,
                horasExtra: totalHorasExtra,
                horasPendientes: totalHorasPendientes,
                netoHoras: netoHoras
            };
        }

        // Renderizar consolidado
        function renderConsolidado() {
            const consolidado = reporteData.consolidadoGeneral;
            const costoPorHora = 3600; // Costo por hora extra en colones
            
            // Calcular valoraciones monetarias
            const valorExtra = consolidado.totalHorasExtra * costoPorHora;
            const valorPendientes = consolidado.totalHorasPendientes * costoPorHora;
            
            // Calcular monto ineficiente (el menor entre valor extra y valor pendientes)
            const montoIneficiente = Math.min(valorExtra, valorPendientes);
            
            // Mostrar valores básicos
            document.getElementById('totalHoras').textContent = consolidado.totalHorasLaboradas.toFixed(1) + 'h';
            document.getElementById('totalExtra').textContent = '+' + consolidado.totalHorasExtra.toFixed(1) + 'h';
            document.getElementById('totalPendientes').textContent = '-' + consolidado.totalHorasPendientes.toFixed(1) + 'h';
            
            // Mostrar valoraciones monetarias
            document.getElementById('valorExtra').textContent = formatearColones(valorExtra);
            document.getElementById('valorPendientes').textContent = formatearColones(valorPendientes);
            document.getElementById('montoIneficiente').textContent = formatearColones(montoIneficiente);
        }

        // Renderizar empleados
        function renderEmpleados() {
            const empleadosList = document.getElementById('empleadosList');
            
            if (reporteData.empleados.length === 0) {
                empleadosList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>No hay empleados con datos para el período seleccionado.</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar empleados por departamento
            const empleadosPorDepartamento = {};
            reporteData.empleados.forEach(empleado => {
                const empleadoCompleto = empleadosData.find(e => e.id === empleado.id || e.username === empleado.username);
                const departamento = empleadoCompleto?.departamento || 'Sin Departamento';
                
                if (!empleadosPorDepartamento[departamento]) {
                    empleadosPorDepartamento[departamento] = [];
                }
                empleadosPorDepartamento[departamento].push(empleado);
            });
            
            // Ordenar departamentos por cantidad de empleados (mayor a menor), "Sin Departamento" al final
            const departamentosOrdenados = Object.keys(empleadosPorDepartamento).sort((a, b) => {
                if (a === 'Sin Departamento') return 1;
                if (b === 'Sin Departamento') return -1;
                const cantidadA = empleadosPorDepartamento[a].length;
                const cantidadB = empleadosPorDepartamento[b].length;
                return cantidadB - cantidadA; // Mayor a menor
            });
            
            // Distribuir departamentos en un grid de 4 columnas totales
            // PERO las tarjetas de empleado usan máximo 2 columnas para evitar que el texto se salga
            const MAX_COLUMNAS = 4;
            const MAX_ELEMENTOS_POR_FILA = 2; // Cambiado a 2 para tarjetas de empleado
            
            // Preparar lista de departamentos con su información
            const departamentosList = departamentosOrdenados.map(departamento => {
                const empleados = empleadosPorDepartamento[departamento];
                const cantidadEmpleados = empleados.length;
                const necesitaNuevaFila = cantidadEmpleados > MAX_ELEMENTOS_POR_FILA;
                // Calcular columnas ocupadas: 
                // - 1 empleado: ocupa 2 columnas del grid principal
                // - 2 empleados: ocupa 4 columnas del grid principal
                // - Más de 2: ocupa 4 columnas y se divide internamente
                let columnasOcupadas;
                if (cantidadEmpleados === 1) {
                    columnasOcupadas = 2;
                } else if (cantidadEmpleados === 2) {
                    columnasOcupadas = 4;
                } else {
                    columnasOcupadas = MAX_COLUMNAS;
                }
                
                return {
                    departamento,
                    empleados,
                    cantidadEmpleados,
                    necesitaNuevaFila,
                    columnasOcupadas
                };
            });
            
            // Renderizar en grid de 4 columnas
            let html = '<div class="departamentos-grid">';
            let columnaActual = 0;
            
            departamentosList.forEach((dept, index) => {
                // Si este departamento necesita nueva fila o no cabe en la fila actual
                if (dept.necesitaNuevaFila || (columnaActual + dept.columnasOcupadas > MAX_COLUMNAS)) {
                    // Cerrar fila anterior si hay elementos
                    if (columnaActual > 0) {
                        html += '</div>'; // Cerrar departamentos-fila
                    }
                    // Iniciar nueva fila
                    html += '<div class="departamentos-fila">';
                    columnaActual = 0;
                }
                
                // Renderizar departamento
                if (dept.necesitaNuevaFila) {
                    // Departamento con más de 2 empleados: ocupa las 4 columnas y se divide internamente
                    html += `
                        <div class="departamento-section" style="grid-column: span ${MAX_COLUMNAS};">
                            <h4 class="departamento-title mb-2">
                                <i class="fas fa-building"></i> ${dept.departamento}
                                <span class="badge bg-secondary ms-2">${dept.cantidadEmpleados}</span>
                            </h4>
                    `;
                    
                    // Dividir empleados en filas de máximo 2
                    const filasEmpleados = [];
                    for (let i = 0; i < dept.empleados.length; i += MAX_ELEMENTOS_POR_FILA) {
                        filasEmpleados.push(dept.empleados.slice(i, i + MAX_ELEMENTOS_POR_FILA));
                    }
                    
                    filasEmpleados.forEach((filaEmpleados) => {
                        // Siempre usar 2 columnas para mantener el mismo ancho en todas las filas
                        html += `<div class="empleados-row" data-items="2">`;
                        filaEmpleados.forEach(empleado => {
                            html += renderEmpleadoCard(empleado);
                        });
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                    columnaActual = MAX_COLUMNAS; // Ocupa toda la fila
                } else {
                    // Departamento normal: ocupa columnas proporcionales (1 empleado = 2 columnas, 2 empleados = 4 columnas)
                    html += `
                        <div class="departamento-section" style="grid-column: span ${dept.columnasOcupadas};">
                            <h4 class="departamento-title mb-2">
                                <i class="fas fa-building"></i> ${dept.departamento}
                                <span class="badge bg-secondary ms-2">${dept.cantidadEmpleados}</span>
                            </h4>
                            <div class="empleados-row" data-items="${dept.cantidadEmpleados}">
                    `;
                    dept.empleados.forEach(empleado => {
                        html += renderEmpleadoCard(empleado);
                    });
                    html += `
                            </div>
                        </div>
                    `;
                    columnaActual += dept.columnasOcupadas;
                }
            });
            
            // Cerrar última fila si hay elementos
            if (columnaActual > 0) {
                html += '</div>'; // Cerrar departamentos-fila
            }
            
            html += '</div>'; // Cerrar departamentos-grid
            
            empleadosList.innerHTML = html;
            
            // Configurar event listeners para expansión
            setupExpansionListeners();
        }

        // Formatear colones con separador de miles (punto cada 000)
        function formatColones(monto) {
            const montoRedondeado = Math.round(monto);
            // Usar toLocaleString y luego reemplazar comas por puntos
            return '₡' + montoRedondeado.toLocaleString('es-CR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).replace(/,/g, '.');
        }

        // Renderizar tarjeta de empleado
        function renderEmpleadoCard(empleado) {
            const neto = empleado.resumen.netoHoras;
            const netoClass = neto > 0 ? 'neto-positivo' : neto < 0 ? 'neto-negativo' : 'neto-cero';
            const netoIcon = neto > 0 ? 'fa-arrow-up' : neto < 0 ? 'fa-arrow-down' : 'fa-minus';
            const netoColor = getNetoColor(neto);
            
            // Calcular montos en dinero
            const horasExtra = empleado.resumen.horasExtra; // Solo positivas (ya filtradas)
            const horasPendientes = empleado.resumen.horasPendientes; // Solo negativas
            const montoExtra = horasExtra * 2375; // Horas extra: ₡2,375 por hora
            const montoPendientes = horasPendientes * 1584; // Horas pendientes: ₡1,584 por hora
            
            // Construir HTML para mostrar extras y pendientes separados
            let montosHTML = '';
            if (horasExtra > 0 && horasPendientes > 0) {
                // Mostrar ambos: extras en rojo y pendientes en azul (negativo), separados
                montosHTML = `
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px; margin-left: 4px;">
                        <span style="font-size: 0.7rem; color: #dc3545; background: rgba(220, 53, 69, 0.1); border-radius: 12px; padding: 2px 6px; display: inline-block;">${formatColones(montoExtra)}</span>
                        <span style="font-size: 0.7rem; color: #0d6efd; background: rgba(13, 110, 253, 0.1); border-radius: 12px; padding: 2px 6px; display: inline-block;">-${formatColones(montoPendientes)}</span>
                    </div>
                `;
            } else if (horasExtra > 0) {
                // Solo extras
                montosHTML = `<span style="font-size: 0.7rem; color: #dc3545; background: rgba(220, 53, 69, 0.1); border-radius: 12px; padding: 2px 6px; display: inline-block; margin-left: 4px;">${formatColones(montoExtra)}</span>`;
            } else if (horasPendientes > 0) {
                // Solo pendientes (negativo)
                montosHTML = `<span style="font-size: 0.7rem; color: #0d6efd; background: rgba(13, 110, 253, 0.1); border-radius: 12px; padding: 2px 6px; display: inline-block; margin-left: 4px;">-${formatColones(montoPendientes)}</span>`;
            }
            
            // Determinar clase de estado para el borde izquierdo
            let estadoClass = '';
            if (neto < 0) {
                estadoClass = 'jornada-pendientes';
            } else if (neto === 0) {
                estadoClass = 'jornada-equilibrado';
            } else {
                estadoClass = 'jornada-extras';
            }
            
            return `
                <div class="empleado-card ${estadoClass}" data-empleado-id="${empleado.id}" style="background-color: ${netoColor} !important;">
                    <div class="empleado-header" onclick="toggleEmpleado('${empleado.id}')">
                        <div class="empleado-info">
                            <div class="empleado-details">
                                <div class="empleado-name">${empleado.nombre}</div>
                            </div>
                        </div>
                        <div class="empleado-metrics">
                            <div class="neto-indicator ${netoClass}">
                                <i class="fas ${netoIcon}"></i>
                                ${(neto >= 0 ? '+' : '') + neto.toFixed(1)}h
                                ${montosHTML}
                            </div>
                        </div>
                        <i class="fas fa-chevron-down expand-icon" id="icon-${empleado.id}"></i>
                    </div>
                    <div class="empleado-content" id="content-${empleado.id}">
                        ${renderSemanas(empleado.semanas, empleado.id)}
                    </div>
                </div>
            `;
        }

        // Renderizar semanas
        function renderSemanas(semanas, empleadoId) {
            if (semanas.length === 0) {
                return '<p class="text-muted">No hay datos de semanas.</p>';
            }
            
            let html = '<div class="semanas-section">';
            semanas.forEach(semana => {
                // APLICAR FILTRO DE SEMANA
                if (filtroSemana && filtroSemana !== '' && semana.weekKey !== filtroSemana) {
                    return;
                }
                
                // APLICAR FILTRO DE MES: Filtrar sesiones dentro de la semana que pertenecen al mes
                if (filtroMes && semana.sessions) {
                    const sesionesFiltradas = semana.sessions.filter(session => {
                        const sessionDate = session.startTime.toDate();
                        return belongsToMonth(sessionDate, filtroMes);
                    });
                    
                    // Si no hay sesiones que pertenezcan al mes, excluir la semana completa
                    if (sesionesFiltradas.length === 0) {
                        return;
                    }
                    
                    // Recalcular resumen solo con sesiones del mes
                    const empleadoInfo = empleadosData.find(e => e.id === empleadoId);
                    const tipoContrato = empleadoInfo?.tipoContrato || 'Mensual';
                    const departamento = empleadoInfo?.departamento || '';
                    const requiereDescuento = requiereDescuentoAlmuerzo(departamento);
                    
                    const semanaFiltrada = {
                        sessions: sesionesFiltradas,
                        resumen: { horasExtra: 0, horasPendientes: 0 }
                    };
                    const semanaData = processSemanaData(semanaFiltrada, tipoContrato, requiereDescuento);
                    semana.resumen = semanaData.resumen;
                    semana.dias = semanaData.dias;
                }
                
                const neto = semana.resumen.netoHoras;
                const netoClass = neto > 0 ? 'neto-positivo' : neto < 0 ? 'neto-negativo' : 'neto-cero';
                const netoIcon = neto > 0 ? 'fa-arrow-up' : neto < 0 ? 'fa-arrow-down' : 'fa-minus';
                
                // Calcular montos en dinero para la semana
                const horasExtra = semana.resumen.horasExtra;
                const horasPendientes = semana.resumen.horasPendientes;
                const montoExtra = horasExtra * 2375; // Horas extra: ₡2,375 por hora
                const montoPendientes = horasPendientes * 1584; // Horas pendientes: ₡1,584 por hora
                
                // Crear ID único combinando empleado y semana
                const uniqueId = `${empleadoId}-${semana.weekKey}`;
                
                // Formatear el neto con montos
                let netoHTML = '';
                if (horasExtra > 0) {
                    netoHTML = `
                        <span class="semana-neto ${netoClass}" style="color: #dc3545;">
                            <i class="fas ${netoIcon}"></i>
                            ${(neto >= 0 ? '+' : '') + neto.toFixed(1)}h
                            <span style="font-size: 0.7rem; color: #dc3545; background: rgba(220, 53, 69, 0.1); border-radius: 12px; padding: 2px 6px; display: inline-block; margin-left: 4px;">${formatColones(montoExtra)}</span>
                        </span>
                    `;
                } else if (horasPendientes > 0) {
                    netoHTML = `
                        <span class="semana-neto ${netoClass}" style="color: #0d6efd;">
                            <i class="fas ${netoIcon}"></i>
                            ${(neto >= 0 ? '+' : '') + neto.toFixed(1)}h
                            <span style="font-size: 0.7rem; color: #0d6efd; background: rgba(13, 110, 253, 0.1); border-radius: 12px; padding: 2px 6px; display: inline-block; margin-left: 4px;">-${formatColones(montoPendientes)}</span>
                        </span>
                    `;
                } else {
                    netoHTML = `
                        <span class="semana-neto ${netoClass}">
                            <i class="fas ${netoIcon}"></i>
                            ${(neto >= 0 ? '+' : '') + neto.toFixed(1)}h
                        </span>
                    `;
                }
                
                html += `
                    <div class="semana-card" data-semana-id="${uniqueId}">
                        <div class="semana-header" onclick="toggleSemana('${uniqueId}')">
                            <div class="semana-info">
                                <span class="semana-dates">${semana.weekKey}</span>
                                <span class="semana-horas">${semana.resumen.horasLaboradas.toFixed(1)}h</span>
                                ${netoHTML}
                            </div>
                            <i class="fas fa-chevron-down expand-icon" id="semana-icon-${uniqueId}"></i>
                        </div>
                        <div class="semana-content" id="semana-content-${uniqueId}">
                            ${renderDias(semana.dias)}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Obtener ícono de jornada
        function getJornadaIcon(jornadaType) {
            switch(jornadaType) {
                case 'Diurna': return 'fa-sun';
                case 'Mixta': return 'fa-cloud-sun';
                case 'Nocturna': return 'fa-moon';
                default: return 'fa-clock';
            }
        }
        
        // Obtener clase de jornada
        function getJornadaClass(jornadaType) {
            switch(jornadaType) {
                case 'Diurna': return 'jornada-diurna';
                case 'Mixta': return 'jornada-mixta';
                case 'Nocturna': return 'jornada-nocturna';
                default: return 'jornada-default';
            }
        }

        // Renderizar días
        function renderDias(dias) {
            if (!dias || Object.keys(dias).length === 0) {
                return '<p class="text-muted">No hay datos de días.</p>';
            }
            let html = '<div class="dias-section">';
            Object.values(dias).forEach(dia => {
                try {
                    // Verificar que dia.fecha existe y es válida
                    let fecha;
                    if (dia.fecha) {
                        // Parsear la fecha como local para evitar problemas de zona horaria
                        const [year, month, day] = dia.fecha.split('-');
                        const localDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        fecha = localDate.toLocaleDateString('es-ES', {
                            weekday: 'long',
                            day: '2-digit',
                            month: '2-digit'
                        });
                    } else {
                        // Si no hay fecha, usar la primera sesión como referencia
                        const primeraSession = dia.sessions && dia.sessions[0];
                        if (primeraSession && primeraSession.startTime) {
                            const startTimeDate = primeraSession.startTime.toDate();
                            fecha = startTimeDate.toLocaleDateString('es-ES', {
                                weekday: 'long',
                                day: '2-digit',
                                month: '2-digit'
                            });
                        } else {
                            fecha = 'Fecha no disponible';
                        }
                    }
                    
                    // Verificar que dia.resumen existe
                    const resumen = dia.resumen || { horasLaboradas: 0, horasExtra: 0, horasPendientes: 0 };
                    
                    const netoDia = resumen.horasExtra - resumen.horasPendientes;
                    const netoClass = netoDia > 0 ? 'text-danger' : netoDia < 0 ? 'text-primary' : '';
                    
                    const jornadaIcon = getJornadaIcon(dia.jornadaType);
                    const jornadaClass = getJornadaClass(dia.jornadaType);
                    
                    html += `
                        <div class="dia-item">
                            <div class="dia-header">
                                <div class="dia-info">
                                    <div class="dia-fecha">${fecha}</div>
                                    <div class="dia-jornada ${jornadaClass}">
                                        <i class="fas ${jornadaIcon}"></i>
                                        ${dia.jornadaType || 'No definida'}
                                    </div>
                                </div>
                                <div class="dia-neto ${netoClass}">
                                    ${(netoDia >= 0 ? '+' : '') + netoDia.toFixed(1)}h
                                </div>
                            </div>
                            ${renderTurnos(dia.turnos || [])}
                        </div>
                    `;
                } catch (error) {
                    console.error('Error renderizando día:', error, dia);
                    html += `
                        <div class="dia-item">
                            <div class="dia-header">
                                <div class="dia-info">
                                    <div class="dia-fecha">Error en datos</div>
                                    <div class="dia-jornada jornada-default">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Error
                                    </div>
                                </div>
                                <div class="dia-neto">0h</div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            return html;
        }

        // Renderizar turnos
        function renderTurnos(turnos) {
            if (!turnos || turnos.length === 0) {
                return '';
            }
            
            // Verificar permisos del usuario actual
            const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
            const canEdit = currentUser && currentUser.permisos && currentUser.permisos.edicion_horas;
            
            let html = '<div class="turnos-section">';
            turnos.forEach((turno, index) => {
                try {
                    const inicio = turno.inicio || 'N/A';
                    const fin = turno.fin || 'N/A';
                    const duracion = turno.duracion ? turno.duracion.toFixed(1) : '0.0';
                    const notas = turno.notas ? ` - ${turno.notas}` : '';
                    const turnoId = turno.id || `turno-${index}`;
                    
                    html += `
                        <div class="turno-item">
                            <div class="turno-info">
                                <i class="fas fa-clock"></i>
                                <span>${inicio} - ${fin} (${duracion}h)${notas}</span>
                            </div>
                            <div class="turno-actions">
                                <button class="btn btn-sm btn-outline-warning edit-turno-btn" 
                                        data-turno-id="${turnoId}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para editar"' : ''}>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-turno-btn" 
                                        data-turno-id="${turnoId}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para eliminar"' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error renderizando turno:', error, turno);
                    html += `
                        <div class="turno-item">
                            <div class="turno-info">
                                <i class="fas fa-clock"></i>
                                <span>Error en datos del turno</span>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            return html;
        }

        // Configurar event listeners para expansión
        function setupExpansionListeners() {
            // Limpiar listener anterior si existe (evitar duplicados)
            if (expansionListenersController) {
                expansionListenersController.abort();
            }
            
            // Crear nuevo AbortController para este listener
            expansionListenersController = new AbortController();
            
            // Event listeners para botones de turno
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-turno-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.closest('.edit-turno-btn');
                    const turnoId = btn.dataset.turnoId;
                    editTurno(turnoId);
                }
                
                if (e.target.closest('.delete-turno-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.closest('.delete-turno-btn');
                    const turnoId = btn.dataset.turnoId;
                    deleteTurno(turnoId);
                }
                
                if (e.target.closest('.force-close-btn')) {
                    const btn = e.target.closest('.force-close-btn');
                    const username = btn.dataset.username;
                    const sessionId = btn.dataset.sessionId;
                    forceCloseSession(username, sessionId);
                }
            }, { signal: expansionListenersController.signal });
        }

        // Limpiar listeners al salir de la página
        window.addEventListener('beforeunload', () => {
            if (expansionListenersController) {
                expansionListenersController.abort();
                expansionListenersController = null;
            }
        });
        
        // Función para editar turno
        function editTurno(turnoId) {
            if (isEditing) return; // Prevenir doble ejecución
            isEditing = true;
            
            // Editar turno (sin log)
            
            // Verificar que los datos estén disponibles
            if (!allWorkSessions || allWorkSessions.length === 0) {
                alert('Los datos aún se están cargando. Por favor, espera un momento e intenta nuevamente.');
                isEditing = false;
                return;
            }
            
            // Buscar el turno específico
            const turno = findTurnoById(turnoId);
            if (!turno) {
                alert('No se encontró el turno seleccionado. Los datos pueden no estar completamente cargados.');
                // Datos disponibles (sin log)
                isEditing = false;
                return;
            }
            
            // Llenar el modal con los datos del turno
            document.getElementById('editTurnoId').value = turnoId;
            
            // Convertir las fechas a formato de input date y time usando zona horaria local
            const startTime = turno.startTime.toDate();
            
            // Usar métodos locales para evitar problemas de zona horaria
            const startYear = startTime.getFullYear();
            const startMonth = String(startTime.getMonth() + 1).padStart(2, '0');
            const startDay = String(startTime.getDate()).padStart(2, '0');
            const startDateString = `${startYear}-${startMonth}-${startDay}`;
            
            const startTimeString = startTime.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Llenar fecha y hora de inicio
            document.getElementById('editStartDate').value = startDateString;
            document.getElementById('editStartTime').value = startTimeString;
            
            if (turno.endTime) {
                const endTime = turno.endTime.toDate();
                
                // Usar métodos locales para evitar problemas de zona horaria
                const endYear = endTime.getFullYear();
                const endMonth = String(endTime.getMonth() + 1).padStart(2, '0');
                const endDay = String(endTime.getDate()).padStart(2, '0');
                const endDateString = `${endYear}-${endMonth}-${endDay}`;
                
                const endTimeString = endTime.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Llenar fecha y hora de fin
                document.getElementById('editEndDate').value = endDateString;
                document.getElementById('editEndTime').value = endTimeString;
            } else {
                document.getElementById('editEndTime').value = '';
            }
            
            // Mostrar el modal
            const modalElement = document.getElementById('editTurnoModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Limpiar el modal cuando se cierre
            modalElement.addEventListener('hidden.bs.modal', function() {
                // Limpiar formulario
                document.getElementById('editTurnoForm').reset();
                
                // Limpiar completamente el DOM del modal
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Remover todos los backdrops
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // Remover clases de modal del elemento
                modalElement.classList.remove('show');
                modalElement.style.display = 'none';
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                
                // Modal limpiado completamente (sin log)
            }, { once: true });
            
            modal.show();
            
            // Resetear flag
            isEditing = false;
        }
        
        // Función para convertir hora AM/PM a formato de 24 horas
        function convertTo24Hour(timeString) {
            if (!timeString || timeString === 'En curso') {
                return '';
            }
            
            // Parsear la hora AM/PM (ej: "6:28 AM" o "4:35 PM")
            const match = timeString.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) {
                return '';
            }
            
            let hours = parseInt(match[1]);
            const minutes = match[2];
            const period = match[3].toUpperCase();
            
            if (period === 'AM' && hours === 12) {
                hours = 0;
            } else if (period === 'PM' && hours !== 12) {
                hours += 12;
            }
            
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        
        // Función para buscar un turno por ID
        function findTurnoById(turnoId) {
            // allWorkSessions disponible (sin log)
            
            // Buscar directamente en allWorkSessions
            if (allWorkSessions && allWorkSessions.length > 0) {
                const turno = allWorkSessions.find(session => session.id === turnoId);
                if (turno) {
                    // Turno encontrado en allWorkSessions (sin log)
                    return turno;
                }
            }
            
            // Si no se encuentra en allWorkSessions, buscar en empleadosData como fallback
            if (empleadosData && empleadosData.length > 0) {
                for (const empleado of empleadosData) {
                    if (empleado.semanas) {
                        for (const semana of empleado.semanas) {
                            if (semana.dias) {
                                for (const dia of semana.dias) {
                                    if (dia.turnos) {
                                        const turno = dia.turnos.find(t => t.id === turnoId);
                                        if (turno) {
                                            // Turno encontrado en empleadosData (sin log)
                                            return turno;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Turno no encontrado (sin log)
            return null;
        }
        
        // Variables para prevenir doble ejecución
        let isDeleting = false;
        let isEditing = false;

        // Función para eliminar turno
        async function deleteTurno(turnoId) {
            if (isDeleting) return; // Prevenir doble ejecución
            
            // Encontrar el turno antes de eliminar para saber de quién es
            const turno = allWorkSessions.find(t => t.id === turnoId);
            
            if (confirm('¿Estás seguro de que quieres eliminar este turno?')) {
                isDeleting = true; // Marcar como en proceso
                try {
                    // Verificar autenticación
                    const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
                    if (!currentUser) {
                        alert('Error: No se pudo verificar la autenticación del usuario actual');
                        return;
                    }

                    // Verificar permisos
                    if (!currentUser.permisos || !currentUser.permisos.reportes_gerenciales) {
                        alert('No tienes permisos para eliminar registros');
                        return;
                    }

                    // Importar Firebase
                    const { deleteDoc, doc, getFirestore } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const db = getFirestore();

                    // Eliminar el documento
                    await deleteDoc(doc(db, 'work_sessions', turnoId));

                    // --- ACTUALIZACIÓN OPTIMISTA ---
                    if (turno) {
                        const empleadoUsername = turno.username;
                        
                        // 1. Eliminar de allWorkSessions
                        allWorkSessions = allWorkSessions.filter(t => t.id !== turnoId);
                        
                        // 2. Actualizar empleadosData (sessions)
                        const empleadoData = empleadosData.find(e => e.username === empleadoUsername);
                        if (empleadoData && empleadoData.sessions) {
                            empleadoData.sessions = empleadoData.sessions.filter(t => t.id !== turnoId);
                        }

                        // 3. Recalcular datos procesados
                        processData();

                        // 4. Actualizar la UI específica del empleado
                        const empleadoReporte = reporteData.empleados.find(e => e.username === empleadoUsername);
                        
                        if (empleadoReporte) {
                            // Buscar la tarjeta existente en el DOM
                            const cardExistente = document.querySelector(`.empleado-card[data-empleado-id="${empleadoReporte.id}"]`);
                            
                            if (cardExistente) {
                                // Guardar estado de expansión
                                const contentDiv = cardExistente.querySelector('.empleado-content');
                                const isExpanded = contentDiv && (contentDiv.style.display === 'block' || contentDiv.classList.contains('show'));
                                
                                // Generar nuevo HTML
                                const nuevoHTML = renderEmpleadoCard(empleadoReporte);
                                
                                // Crear un elemento temporal
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = nuevoHTML;
                                const nuevaCard = tempDiv.firstElementChild;
                                
                                // Restaurar estado de expansión
                                if (isExpanded) {
                                    const nuevoContent = nuevaCard.querySelector('.empleado-content');
                                    const nuevoIcon = nuevaCard.querySelector('.expand-icon');
                                    if (nuevoContent) {
                                        nuevoContent.style.display = 'block';
                                    }
                                    if (nuevoIcon) {
                                        nuevoIcon.classList.remove('fa-chevron-down');
                                        nuevoIcon.classList.add('fa-chevron-up');
                                    }
                                }
                                
                                // Reemplazar en el DOM
                                cardExistente.parentNode.replaceChild(nuevaCard, cardExistente);
                            } else {
                                renderEmpleados();
                            }
                        } else {
                            renderEmpleados();
                        }
                        
                        // Actualizar consolidado global
                        renderConsolidado();
                        
                    } else {
                        // Si no encontramos el turno localmente, recarga completa
                        loadData();
                    }
                    
                } catch (error) {
                    console.error('Error eliminando turno:', error);
                    alert('Error al eliminar el turno: ' + error.message);
                    // En caso de error, intentar recargar
                    loadData();
                } finally {
                    isDeleting = false; // Resetear flag
                }
            }
        }
        
        // Función para forzar cierre de sesión
        async function forceCloseSession(username, sessionId) {
            try {
                // Verificar permisos del usuario actual
                const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
                if (!currentUser) {
                    alert('Error: No se pudo verificar la autenticación del usuario actual');
                    return;
                }
                
                // Verificar si el usuario tiene permisos de reportes_gerenciales
                if (!currentUser.permisos || !currentUser.permisos.reportes_gerenciales) {
                    alert('Error: No tienes permisos para forzar el cierre de turnos');
                    return;
                }
                
                // Obtener nombre del empleado
                const empleadoInfo = empleadosMap[username] || { nombre: username };
                
                // Llenar el modal con la información del empleado
                document.getElementById('forceCloseEmployeeName').textContent = empleadoInfo.nombre;
                document.getElementById('forceCloseUsername').value = username;
                document.getElementById('forceCloseSessionId').value = sessionId;
                
                // Establecer la hora actual como valor por defecto
                const now = new Date();
                // El input datetime-local espera la fecha en formato YYYY-MM-DDTHH:MM
                // sin información de zona horaria (se asume zona horaria local)
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const nowString = `${year}-${month}-${day}T${hours}:${minutes}`;
                document.getElementById('forceCloseEndTime').value = nowString;
                
                // Limpiar campos del formulario
                document.getElementById('forceCloseReason').value = '';
                document.getElementById('forceCloseNotes').value = '';
                
                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById('forceCloseModal'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error preparando cierre de sesión:', error);
                alert('Error al preparar el cierre del turno: ' + error.message);
            }
        }
        
        // Función para confirmar el cierre forzado
        async function confirmForceClose() {
            try {
                const username = document.getElementById('forceCloseUsername').value;
                const sessionId = document.getElementById('forceCloseSessionId').value;
                const endTimeString = document.getElementById('forceCloseEndTime').value;
                const reason = document.getElementById('forceCloseReason').value;
                const notes = document.getElementById('forceCloseNotes').value;
                
                if (!endTimeString || !reason) {
                    alert('Por favor completa todos los campos requeridos');
                    return;
                }
                
                // Convertir la fecha/hora seleccionada a Date
                // El input datetime-local devuelve la hora en zona horaria local del navegador
                const endTime = new Date(endTimeString);
                
                // Hora procesada (sin log)
                
                const { Timestamp, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const endTimestamp = Timestamp.fromDate(endTime);
                
                // Confirmando cierre de sesión (sin exponer datos)
                
                // Buscar la sesión activa en Firebase
                const q = query(
                    collection(db, 'work_sessions'),
                    where('username', '==', username),
                    where('status', '==', 'working')
                );
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    alert('Error: No se encontró una sesión activa para este usuario');
                    return;
                }
                
                // Si hay múltiples sesiones, usar la más reciente
                const sessions = querySnapshot.docs.sort((a, b) => {
                    const dateA = a.data().startTime?.toDate ? a.data().startTime.toDate() : new Date(a.data().startTime);
                    const dateB = b.data().startTime?.toDate ? b.data().startTime.toDate() : new Date(b.data().startTime);
                    return dateB - dateA;
                });
                
                const sessionDoc = sessions[0];
                const sessionData = sessionDoc.data();
                
                // Calcular duración total
                const startTime = sessionData.startTime?.toDate ? sessionData.startTime.toDate() : new Date(sessionData.startTime);
                const duration = calculateDurationHours(startTime, endTime);
                
                // Obtener el usuario actual para la auditoría
                const currentUser = window.authManager.getCurrentUser();
                
                // Preparar datos de actualización
                const updateData = {
                    endTime: endTimestamp,
                    status: 'completed',
                    notes: (sessionData.notes || '') + ` [Turno cerrado forzosamente por ${currentUser.nombre || currentUser.id} el ${endTime.toLocaleString('es-ES')}. Motivo: ${reason}${notes ? '. Notas: ' + notes : ''}]`
                };
                
                // Actualizar la sesión en Firebase
                await updateDoc(sessionDoc.ref, updateData);
                
                // Sesión cerrada forzosamente (sin exponer datos)
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('forceCloseModal'));
                modal.hide();
                
                // Mostrar mensaje de éxito
                alert(`Turno de ${username} cerrado exitosamente.\n\nDuración total: ${duration.toFixed(1)} horas\nHora de cierre: ${endTime.toLocaleString('es-ES')}\nMotivo: ${reason}`);
                
                // Recargar los datos para reflejar el cambio
                await loadData();
                
            } catch (error) {
                console.error('❌ Error confirmando cierre de sesión:', error);
                alert('Error al confirmar el cierre del turno: ' + error.message);
            }
        }
        
        // Función auxiliar para calcular duración en horas
        function calculateDurationHours(startTime, endTime) {
            const diffMs = endTime - startTime;
            return diffMs / (1000 * 60 * 60); // Convertir a horas
        }
        
        // Event listener para el botón de guardar turno
        document.addEventListener('DOMContentLoaded', function() {
            const saveTurnoBtn = document.getElementById('saveTurnoBtn');
            if (saveTurnoBtn) {
                saveTurnoBtn.addEventListener('click', function() {
                    saveTurnoChanges();
                });
            }
            
            // Event listener para el botón de confirmar cierre forzado
            const confirmForceCloseBtn = document.getElementById('confirmForceCloseBtn');
            if (confirmForceCloseBtn) {
                confirmForceCloseBtn.addEventListener('click', function() {
                    confirmForceClose();
                });
            }
            
            // Event listener para el botón de crear turno manual
            const crearTurnoManualBtn = document.getElementById('crearTurnoManualBtn');
            if (crearTurnoManualBtn) {
                crearTurnoManualBtn.addEventListener('click', function() {
                    abrirModalCrearTurno();
                });
            }
            
            // Event listener para el botón de guardar turno manual
            const guardarTurnoManualBtn = document.getElementById('guardarTurnoManualBtn');
            if (guardarTurnoManualBtn) {
                guardarTurnoManualBtn.addEventListener('click', function() {
                    guardarTurnoManual();
                });
            }
            
            // Event listener para el botón de guardar cambio de hora de inicio
            const saveStartTimeChangeBtn = document.getElementById('saveStartTimeChangeBtn');
            if (saveStartTimeChangeBtn) {
                saveStartTimeChangeBtn.addEventListener('click', function() {
                    saveStartTimeChange();
                });
            }
        });
        
        // Función para abrir el modal de crear turno manual
        function abrirModalCrearTurno() {
            // Cargar empleados en el select
            cargarEmpleadosEnSelect();
            
            // Establecer fecha actual por defecto
            const hoy = new Date();
            const fechaHoy = hoy.toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = fechaHoy;
            document.getElementById('fechaFin').value = fechaHoy;
            
            // Establecer hora actual por defecto
            const horaActual = hoy.toTimeString().slice(0, 5);
            document.getElementById('horaInicio').value = horaActual;
            
            // Calcular hora de fin basada en tipo de jornada (8 horas después por defecto)
            const horaFin = new Date(hoy.getTime() + 8 * 60 * 60 * 1000);
            document.getElementById('horaFin').value = horaFin.toTimeString().slice(0, 5);
            
            // Limpiar formulario
            document.getElementById('crearTurnoForm').reset();
            document.getElementById('fechaInicio').value = fechaHoy;
            document.getElementById('fechaFin').value = fechaHoy;
            document.getElementById('horaInicio').value = horaActual;
            document.getElementById('horaFin').value = horaFin.toTimeString().slice(0, 5);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('crearTurnoModal'));
            modal.show();
        }
        
        // Función para cargar empleados en el select
        function cargarEmpleadosEnSelect() {
            const select = document.getElementById('empleadoSelect');
            select.innerHTML = '<option value="">Selecciona un empleado</option>';
            
            if (empleadosData && empleadosData.length > 0) {
                empleadosData.forEach(empleado => {
                    const option = document.createElement('option');
                    option.value = empleado.username;
                    option.textContent = `${empleado.primerNombre} ${empleado.primerApellido}`;
                    select.appendChild(option);
                });
            }
        }
        
        // Función para guardar turno manual
        async function guardarTurnoManual() {
            const empleadoUsername = document.getElementById('empleadoSelect').value;
            const tipoJornada = document.getElementById('tipoJornadaSelect').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const horaInicio = document.getElementById('horaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const horaFin = document.getElementById('horaFin').value;
            const notas = document.getElementById('notasTurno').value;
            
            // Validar campos requeridos
            if (!empleadoUsername || !tipoJornada || !fechaInicio || !horaInicio || !fechaFin || !horaFin) {
                alert('Por favor completa todos los campos requeridos.');
                return;
            }
            
            // Crear objetos Date
            const startTime = new Date(`${fechaInicio}T${horaInicio}`);
            const endTime = new Date(`${fechaFin}T${horaFin}`);
            
            // Validar que la fecha de fin no sea anterior a la de inicio
            if (endTime <= startTime) {
                alert('La fecha y hora de fin debe ser posterior a la de inicio.');
                return;
            }
            
            // Validar que no sea más de 24 horas de diferencia
            const diffHours = (endTime - startTime) / (1000 * 60 * 60);
            if (diffHours > 24) {
                alert('La duración del turno no puede ser mayor a 24 horas.');
                return;
            }
            
            try {
                // Deshabilitar botón mientras se guarda
                const btn = document.getElementById('guardarTurnoManualBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creando...';
                
                
                // Crear el documento en Firebase
                const turnoData = {
                    username: empleadoUsername,
                    startTime: startTime,
                    endTime: endTime,
                    status: 'completed',
                    tipoJornada: tipoJornada,
                    notas: notas || '',
                    createdBy: 'admin', // Indicar que fue creado manualmente
                    createdAt: new Date(),
                    duracion: diffHours
                };
                
                
                const docRef = await addDoc(collection(db, 'work_sessions'), turnoData);
                
                // Turno manual creado exitosamente (sin log)
                
                // Mostrar mensaje de éxito
                alert('Turno creado exitosamente.');
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('crearTurnoModal'));
                modal.hide();
                
                // Recargar datos
                await loadData();
                
            } catch (error) {
                console.error('❌ Error creando turno manual:', error);
                console.error('❌ Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                alert(`Error al crear el turno: ${error.message}. Revisa la consola para más detalles.`);
            } finally {
                // Rehabilitar botón
                const btn = document.getElementById('guardarTurnoManualBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save me-1"></i>Crear Turno';
            }
        }

        // Función para guardar cambios del turno
        async function saveTurnoChanges() {
            const turnoId = document.getElementById('editTurnoId').value;
            const startDate = document.getElementById('editStartDate').value;
            const startTime = document.getElementById('editStartTime').value;
            const endDate = document.getElementById('editEndDate').value;
            const endTime = document.getElementById('editEndTime').value;
            const notes = document.getElementById('editNotes').value;
            
            if (!startDate || !startTime) {
                alert('Por favor completa la fecha y hora de inicio');
                return;
            }
            
            // Crear objetos Date para validación
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = endDate && endTime ? new Date(`${endDate}T${endTime}`) : null;
            
            // Validar que la fecha/hora de fin sea posterior a la de inicio (solo si se proporciona)
            if (endDateTime && startDateTime >= endDateTime) {
                alert('La fecha y hora de fin debe ser posterior a la fecha y hora de inicio');
                return;
            }
            
            try {
                // Verificar autenticación
                const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
                if (!currentUser) {
                    alert('Error: No se pudo verificar la autenticación del usuario actual');
                    return;
                }

                // Verificar permisos
                if (!currentUser.permisos || !currentUser.permisos.reportes_gerenciales) {
                    alert('No tienes permisos para editar registros');
                    return;
                }

                // Importar Firebase
                const { updateDoc, doc, getFirestore, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();

                // Obtener el turno original para mantener la fecha
                const turnoOriginal = findTurnoById(turnoId);
                if (!turnoOriginal) {
                    alert('No se encontró el turno a editar');
                    return;
                }

                // Crear las nuevas fechas usando las fechas seleccionadas
                const newStartTime = new Date(`${startDate}T${startTime}`);

                let updateData = {
                    startTime: Timestamp.fromDate(newStartTime),
                    lastModified: Timestamp.now()
                };

                // Si se proporciona fecha y hora de fin, actualizarla
                if (endDate && endTime) {
                    const newEndTime = new Date(`${endDate}T${endTime}`);
                    updateData.endTime = Timestamp.fromDate(newEndTime);
                    updateData.status = 'completed';
                }

                // Actualizar el documento
                await updateDoc(doc(db, 'work_sessions', turnoId), updateData);

                // Mostrar mensaje de éxito
                alert('Turno actualizado exitosamente');
                
                // Cerrar el modal de forma segura
                try {
                    const modalElement = document.getElementById('editTurnoModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    } else {
                        // Si no hay instancia, crear una nueva y cerrarla
                        const newModal = new bootstrap.Modal(modalElement);
                        newModal.hide();
                    }
                } catch (modalError) {
                    console.error('Error cerrando modal:', modalError);
                    // Forzar limpieza completa del modal
                    const modalElement = document.getElementById('editTurnoModal');
                    
                    // Limpiar completamente el DOM del modal
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // Remover todos los backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    // Remover clases de modal del elemento
                    modalElement.classList.remove('show');
                    modalElement.style.display = 'none';
                    modalElement.setAttribute('aria-hidden', 'true');
                    modalElement.removeAttribute('aria-modal');
                    
                    // Modal limpiado manualmente (sin log)
                }
                
                // Recargar los datos
                loadData();
                
            } catch (error) {
                console.error('Error actualizando turno:', error);
                alert('Error al actualizar el turno: ' + error.message);
            }
        }

        // Función para abrir el modal de editar hora de inicio
        function abrirModalEditarHoraInicio(username, sessionId, horaActual) {
            // Abriendo modal para editar hora de inicio (sin exponer datos)
            
            // Verificar que el modal existe
            const modalElement = document.getElementById('modalEditarHoraInicio');
            if (!modalElement) {
                console.error('❌ Modal no encontrado');
                alert('Error: Modal no encontrado');
                return;
            }
            
            // Buscar la sesión real en los datos para obtener la hora exacta
            let horaReal = null;
            if (allWorkSessions && allWorkSessions.length > 0) {
                const sesion = allWorkSessions.find(s => s.id === sessionId);
                if (sesion && sesion.startTime) {
                    // Convertir Timestamp de Firebase a Date
                    const fechaInicio = sesion.startTime.toDate ? sesion.startTime.toDate() : new Date(sesion.startTime);
                    horaReal = fechaInicio;
                    // Hora real de la base de datos (sin log)
                }
            }
            
            // Si no encontramos la hora real, usar la hora actual del sistema
            if (!horaReal) {
                horaReal = new Date();
                // Usando hora actual del sistema como fallback (sin log)
            }
            
            // Convertir a formato datetime-local en zona horaria local
            const año = horaReal.getFullYear();
            const mes = String(horaReal.getMonth() + 1).padStart(2, '0');
            const dia = String(horaReal.getDate()).padStart(2, '0');
            const hora = String(horaReal.getHours()).padStart(2, '0');
            const minuto = String(horaReal.getMinutes()).padStart(2, '0');
            
            const valorFinal = `${año}-${mes}-${dia}T${hora}:${minuto}`;
            // Valor final para el campo (sin log)
            
            // Verificar que el campo existe antes de asignar
            const campoHora = document.getElementById('editStartTimeNew');
            if (campoHora) {
                campoHora.value = valorFinal;
                // Campo llenado (sin log)
                
                // Verificar inmediatamente después de asignar
                setTimeout(() => {
                    const valorVerificado = document.getElementById('editStartTimeNew').value;
                }, 100);
            } else {
                console.error('❌ Campo editStartTimeNew no encontrado');
            }
            
            // Verificar que el campo tiene valor
            const valorCampo = document.getElementById('editStartTimeNew')?.value;
            // Valor final del campo (sin log)
            
            // Limpiar notas
            document.getElementById('editStartTimeNotes').value = '';
            
            // Guardar datos del usuario para usar al guardar
            modalElement.dataset.username = username;
            modalElement.dataset.sessionId = sessionId;
            
            // Datos guardados en modal (sin log)
            
            // Mostrar modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Llenar el campo cuando el modal esté completamente visible
            modalElement.addEventListener('shown.bs.modal', function() {
                // Modal completamente visible, llenando campo (sin log)
                const campoHora = document.getElementById('editStartTimeNew');
                if (campoHora) {
                    campoHora.value = valorFinal;
                    // Campo llenado después de mostrar modal (sin log)
                }
            }, { once: true });
        }

        // Función para guardar el cambio de hora de inicio
        async function saveStartTimeChange() {
            try {
                const modal = document.getElementById('modalEditarHoraInicio');
                const username = modal.dataset.username;
                const sessionId = modal.dataset.sessionId;
                const nuevaHora = document.getElementById('editStartTimeNew').value;
                const notas = document.getElementById('editStartTimeNotes').value;
                
                
                if (!username || !sessionId || !nuevaHora) {
                    console.error('❌ Datos faltantes:', { username, sessionId, nuevaHora });
                    alert('Error: Faltan datos necesarios. Username: ' + username + ', SessionId: ' + sessionId + ', NuevaHora: ' + nuevaHora);
                    return;
                }
                
                // Guardando cambio de hora de inicio (sin exponer datos)
                
                // Convertir la nueva hora a Timestamp de Firebase
                const nuevaFechaHora = new Date(nuevaHora);
                const nuevaTimestamp = Timestamp.fromDate(nuevaFechaHora);
                
                // Actualizar la sesión en Firebase
                const sessionRef = doc(db, 'work_sessions', sessionId);
                const updateData = {
                    startTime: nuevaTimestamp,
                    lastUpdated: Timestamp.now()
                };
                
                // Agregar notas si existen
                if (notas.trim()) {
                    updateData.startTimeChangeNotes = notas.trim();
                }
                
                await updateDoc(sessionRef, updateData);
                
                // Hora de inicio actualizada exitosamente (sin log)
                
                // Mostrar mensaje de éxito
                alert('Hora de inicio actualizada exitosamente');
                
                // Cerrar modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Recargar datos para reflejar el cambio
                loadData();
                
            } catch (error) {
                console.error('❌ Error actualizando hora de inicio:', error);
                alert('Error al actualizar la hora de inicio: ' + error.message);
            }
        }

        // Función para determinar si un día es domingo o feriado (global)
        function esDomingoOFeriado(fecha) {
            // Verificar si es domingo (0 = domingo)
            if (fecha.getDay() === 0) {
                return true;
            }
            
            // Lista de feriados de Costa Rica 2026
            const feriados = [
                '2026-01-01', // 1 de enero
                '2026-04-02', // 2 de abril
                '2026-04-03', // 3 de abril
                '2026-04-11', // 11 de abril
                '2026-05-01', // 1 de mayo
                '2026-07-25', // 25 de julio
                '2026-08-02', // 2 de agosto
                '2026-08-15', // 15 de agosto
                '2026-08-31', // 31 de agosto
                '2026-09-15', // 15 de septiembre
                '2026-12-01', // 1 de diciembre
                '2026-12-25'  // 25 de diciembre
            ];
            
            const fechaStr = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
            return feriados.includes(fechaStr);
        }
        
        // Función para generar reporte de horas por día
        async function generarReporteHorasPorDia() {
            try {
                // Generando reporte de horas por día (sin log)
                
                if (!allWorkSessions || allWorkSessions.length === 0) {
                    document.getElementById('horasPorDiaTable').innerHTML = '<p class="text-muted">No hay datos disponibles</p>';
                    return;
                }
                
                // Usar el mes actual si no hay filtro
                const mesActual = filtroMes || new Date().toISOString().substring(0, 7);
                
                // Obtener rango de fechas del mes - CORREGIDO
                const [año, mes] = mesActual.split('-');
                const fechaInicio = new Date(parseInt(año), parseInt(mes) - 1, 1);
                const fechaFin = new Date(parseInt(año), parseInt(mes), 0); // Último día del mes
                
                
                // Generar array de días del mes
                const diasDelMes = [];
                const fechaActual = new Date(fechaInicio);
                
                while (fechaActual <= fechaFin) {
                    diasDelMes.push(new Date(fechaActual));
                    fechaActual.setDate(fechaActual.getDate() + 1);
                }
                
                
                // Obtener empleados únicos
                const empleadosUnicos = [...new Set(allWorkSessions.map(session => session.username))];
                
                // Cargar vacaciones aprobadas para el mes
                const vacacionesAprobadas = await cargarVacacionesAprobadasParaMes(fechaInicio, fechaFin);
                
                // Crear mapa de vacaciones: empleado -> Set de días con vacaciones (formato YYYY-MM-DD)
                const mapaVacaciones = {};
                vacacionesAprobadas.forEach(vac => {
                    const empleadoId = vac.empleadoId;
                    if (!mapaVacaciones[empleadoId]) {
                        mapaVacaciones[empleadoId] = new Set();
                    }
                    
                    // Procesar array de días de vacaciones
                    if (vac.dias && Array.isArray(vac.dias)) {
                        vac.dias.forEach(diaTimestamp => {
                            try {
                                const fechaDia = diaTimestamp.toDate ? diaTimestamp.toDate() : new Date(diaTimestamp);
                                const year = fechaDia.getFullYear();
                                const month = String(fechaDia.getMonth() + 1).padStart(2, '0');
                                const day = String(fechaDia.getDate()).padStart(2, '0');
                                const diaKey = `${year}-${month}-${day}`;
                                mapaVacaciones[empleadoId].add(diaKey);
                            } catch (e) {
                                // Error procesando día de vacación (sin log)
                            }
                        });
                    }
                });
                
                // Crear matriz de datos: empleado -> día -> horas
                const matrizHoras = {};
                
                empleadosUnicos.forEach(username => {
                    matrizHoras[username] = {};
                    diasDelMes.forEach(dia => {
                        // CORREGIDO: Usar fecha local para consistencia
                        const year = dia.getFullYear();
                        const month = String(dia.getMonth() + 1).padStart(2, '0');
                        const day = String(dia.getDate()).padStart(2, '0');
                        const diaKey = `${year}-${month}-${day}`;
                        matrizHoras[username][diaKey] = 0;
                    });
                });
                
                // Procesar sesiones y sumar horas por día
                allWorkSessions.forEach(session => {
                    if (session.endTime) { // Solo sesiones completadas
                        const sessionDate = session.startTime.toDate();
                        // CORREGIDO: Usar fecha local en lugar de UTC para consistencia
                        const year = sessionDate.getFullYear();
                        const month = String(sessionDate.getMonth() + 1).padStart(2, '0');
                        const day = String(sessionDate.getDate()).padStart(2, '0');
                        const diaKey = `${year}-${month}-${day}`;
                        const duracion = (session.endTime.toDate() - session.startTime.toDate()) / (1000 * 60 * 60);
                        
                        if (matrizHoras[session.username] && matrizHoras[session.username][diaKey] !== undefined) {
                            matrizHoras[session.username][diaKey] += duracion;
                        }
                    }
                });
                
                // Aplicar descuento de 1 hora por día para empleados de departamentos con almuerzo
                empleadosUnicos.forEach(username => {
                    const empleado = empleadosData.find(emp => emp.username === username);
                    if (empleado && requiereDescuentoAlmuerzo(empleado.departamento)) {
                        diasDelMes.forEach(dia => {
                            const year = dia.getFullYear();
                            const month = String(dia.getMonth() + 1).padStart(2, '0');
                            const day = String(dia.getDate()).padStart(2, '0');
                            const diaKey = `${year}-${month}-${day}`;
                            
                            // Solo descontar si hay horas trabajadas ese día (una vez por día)
                            if (matrizHoras[username][diaKey] > 0) {
                                matrizHoras[username][diaKey] = Math.max(0, matrizHoras[username][diaKey] - 1);
                            }
                        });
                    }
                });
                
                // Generar HTML de la tabla
                let html = '<table class="horas-por-dia-table">';
                
                // Header con días
                html += '<thead><tr>';
                html += '<th>Empleado</th>';
                diasDelMes.forEach(dia => {
                    const diaStr = dia.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit' });
                    const esDomingoFeriado = esDomingoOFeriado(dia);
                    const claseDia = esDomingoFeriado ? 'dia-domingo-feriado' : '';
                    html += `<th class="${claseDia}" title="${dia.toLocaleDateString('es-ES')}">${diaStr}</th>`;
                });
                html += '</tr></thead>';
                
                // Agrupar empleados por departamento
                const empleadosPorDepartamento = {};
                empleadosUnicos.forEach(username => {
                    const empleado = empleadosData.find(emp => emp.username === username);
                    const departamento = empleado?.departamento || 'Sin Departamento';
                    
                    if (!empleadosPorDepartamento[departamento]) {
                        empleadosPorDepartamento[departamento] = [];
                    }
                    empleadosPorDepartamento[departamento].push(username);
                });
                
                // Ordenar departamentos (alfabéticamente, pero "Sin Departamento" al final)
                const departamentosOrdenados = Object.keys(empleadosPorDepartamento).sort((a, b) => {
                    if (a === 'Sin Departamento') return 1;
                    if (b === 'Sin Departamento') return -1;
                    return a.localeCompare(b);
                });
                
                // Filas de empleados agrupadas por departamento
                html += '<tbody>';
                departamentosOrdenados.forEach(departamento => {
                    const empleados = empleadosPorDepartamento[departamento];
                    
                    // Fila de encabezado del departamento
                    html += `<tr class="departamento-header-row">`;
                    html += `<td colspan="${diasDelMes.length + 1}" class="departamento-header-cell">`;
                    html += `<i class="fas fa-building"></i> <strong>${departamento}</strong> <span class="badge bg-secondary ms-2">${empleados.length}</span>`;
                    html += `</td>`;
                    html += `</tr>`;
                    
                    // Filas de empleados del departamento
                    empleados.forEach(username => {
                        const empleadoInfo = empleadosMap[username];
                        const nombreEmpleado = empleadoInfo ? empleadoInfo.nombre : username;
                        
                        html += `<tr>`;
                        html += `<td title="${username}">${nombreEmpleado}</td>`;
                        
                        diasDelMes.forEach(dia => {
                            // CORREGIDO: Usar fecha local para consistencia
                            const year = dia.getFullYear();
                            const month = String(dia.getMonth() + 1).padStart(2, '0');
                            const day = String(dia.getDate()).padStart(2, '0');
                            const diaKey = `${year}-${month}-${day}`;
                            const horas = matrizHoras[username][diaKey] || 0;
                            
                            // Verificar si hay vacaciones aprobadas para este empleado en este día
                            const tieneVacaciones = mapaVacaciones[username] && mapaVacaciones[username].has(diaKey);
                            
                            // Verificar si es domingo o feriado
                            const esDomingoFeriado = esDomingoOFeriado(dia);
                            
                            // Determinar clase CSS basada en horas, vacaciones y domingos/feriados
                            let claseCss = '';
                            let texto = '';
                            let titulo = '';
                            
                            if (tieneVacaciones) {
                                // Prioridad: Si hay vacaciones aprobadas, mostrar en morado
                                claseCss = 'celda-vacaciones';
                                if (horas > 0) {
                                    texto = `${horas.toFixed(1)}h`;
                                    titulo = `${dia.toLocaleDateString('es-ES')}: ${horas.toFixed(2)} horas - Vacaciones aprobadas`;
                                } else {
                                    texto = 'V';
                                    titulo = `${dia.toLocaleDateString('es-ES')}: Vacaciones aprobadas`;
                                }
                            } else if (horas === 0) {
                                claseCss = esDomingoFeriado ? 'celda-sin-horas dia-domingo-feriado' : 'celda-sin-horas';
                                texto = '0h';
                                titulo = `${dia.toLocaleDateString('es-ES')}: ${horas.toFixed(2)} horas`;
                            } else if (horas < 4) {
                                claseCss = esDomingoFeriado ? 'celda-pocas-horas dia-domingo-feriado' : 'celda-pocas-horas';
                                texto = `${horas.toFixed(1)}h`;
                                titulo = `${dia.toLocaleDateString('es-ES')}: ${horas.toFixed(2)} horas`;
                            } else if (horas <= 10) {
                                claseCss = esDomingoFeriado ? 'celda-horas-normales dia-domingo-feriado' : 'celda-horas-normales';
                                texto = `${horas.toFixed(1)}h`;
                                titulo = `${dia.toLocaleDateString('es-ES')}: ${horas.toFixed(2)} horas`;
                            } else {
                                claseCss = esDomingoFeriado ? 'celda-muchas-horas dia-domingo-feriado' : 'celda-muchas-horas';
                                texto = `${horas.toFixed(1)}h`;
                                titulo = `${dia.toLocaleDateString('es-ES')}: ${horas.toFixed(2)} horas`;
                            }
                            
                            html += `<td class="${claseCss}" title="${titulo}">${texto}</td>`;
                        });
                        
                        html += '</tr>';
                    });
                });
                
                html += '</tbody></table>';
                
                
                // Mostrar la tabla
                document.getElementById('horasPorDiaTable').innerHTML = html;
                
                // Reporte de horas por día generado exitosamente (sin log)
                
            } catch (error) {
                console.error('❌ Error generando reporte de horas por día:', error);
                document.getElementById('horasPorDiaTable').innerHTML = '<p class="text-danger">Error al generar el reporte: ' + error.message + '</p>';
            }
        }
        
        // Función para generar reporte de facturación por empleado
        async function generarReporteFacturacionPorEmpleado() {
            try {
                console.log('🔄 Generando reporte de facturación por empleado...');
                
                // Validar que empleadosData esté disponible
                if (!empleadosData || empleadosData.length === 0) {
                    console.warn('⚠️ empleadosData no disponible, esperando...');
                    document.getElementById('facturacionPorDiaTable').innerHTML = '<p class="text-warning">Cargando datos de empleados...</p>';
                    document.getElementById('facturacionPorHoraTable').innerHTML = '<p class="text-warning">Cargando datos de empleados...</p>';
                    // Reintentar después de un momento
                    setTimeout(() => generarReporteFacturacionPorEmpleado(), 2000);
                    return;
                }
                
                // Validar que allWorkSessions esté disponible
                if (!allWorkSessions || allWorkSessions.length === 0) {
                    console.warn('⚠️ allWorkSessions no disponible');
                }
                
                // Usar el mes actual si no hay filtro
                const mesActual = filtroMes || new Date().toISOString().substring(0, 7);
                console.log('📅 Mes seleccionado:', mesActual);
                
                // Obtener rango de fechas del mes
                const [año, mes] = mesActual.split('-');
                const fechaInicio = new Date(parseInt(año), parseInt(mes) - 1, 1);
                const fechaFin = new Date(parseInt(año), parseInt(mes), 0); // Último día del mes
                
                // Generar array de días del mes
                const diasDelMes = [];
                const fechaActual = new Date(fechaInicio);
                while (fechaActual <= fechaFin) {
                    diasDelMes.push(new Date(fechaActual));
                    fechaActual.setDate(fechaActual.getDate() + 1);
                }
                
                // Calcular rango de fechas considerando día operacional (5am a 5am)
                // Inicio: 5am del primer día del mes
                const fechaInicioOperacional = new Date(parseInt(año), parseInt(mes) - 1, 1, 5, 0, 0, 0);
                // Fin: 4:59:59.999 del primer día del mes siguiente (último día operacional del mes)
                const fechaFinOperacional = new Date(parseInt(año), parseInt(mes), 1, 4, 59, 59, 999);
                
                // Convertir a Timestamps para la query
                const inicioTimestamp = Timestamp.fromDate(fechaInicioOperacional);
                const finTimestamp = Timestamp.fromDate(fechaFinOperacional);
                
                console.log(`📅 Rango operacional: ${fechaInicioOperacional.toISOString()} a ${fechaFinOperacional.toISOString()}`);
                
                // Cargar solo las citas del mes (filtradas por rango de fechas)
                let todasLasCitas = [];
                try {
                    // Intentar con orderBy (requiere índice compuesto)
                    const citasQuery = query(
                        collection(db, 'citas'),
                        where('inicio_gmt6', '>=', inicioTimestamp),
                        where('inicio_gmt6', '<=', finTimestamp),
                        orderBy('inicio_gmt6', 'desc')
                    );
                    const citasSnapshot = await getDocs(citasQuery);
                    
                    citasSnapshot.forEach(doc => {
                        todasLasCitas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                } catch (error) {
                    if (error.code === 'failed-precondition') {
                        // Índice faltante - cargar sin orderBy y ordenar en cliente
                        console.warn('⚠️ Índice compuesto faltante, cargando sin orderBy...');
                        const citasQueryAlt = query(
                            collection(db, 'citas'),
                            where('inicio_gmt6', '>=', inicioTimestamp),
                            where('inicio_gmt6', '<=', finTimestamp)
                        );
                        const citasSnapshotAlt = await getDocs(citasQueryAlt);
                        
                        citasSnapshotAlt.forEach(doc => {
                            todasLasCitas.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Ordenar en cliente por fecha descendente
                        todasLasCitas.sort((a, b) => {
                            const fechaA = a.inicio_gmt6?.toMillis?.() || 0;
                            const fechaB = b.inicio_gmt6?.toMillis?.() || 0;
                            return fechaB - fechaA;
                        });
                    } else {
                        throw error;
                    }
                }
                
                console.log(`📋 Total de citas cargadas del mes: ${todasLasCitas.length}`);
                
                // Función para determinar el día operacional de una cita (5am a 5am)
                function obtenerDiaOperacional(inicioGMT6) {
                    if (!inicioGMT6 || !inicioGMT6.toDate) return null;
                    
                    const fechaLocal = inicioGMT6.toDate();
                    const hora = fechaLocal.getHours();
                    const minutos = fechaLocal.getMinutes();
                    
                    // Si la hora es antes de las 5am, pertenece al día anterior
                    if (hora < 5) {
                        const diaAnterior = new Date(fechaLocal);
                        diaAnterior.setDate(diaAnterior.getDate() - 1);
                        return diaAnterior;
                    }
                    // Si es 5am o después, pertenece al día actual
                    return new Date(fechaLocal.getFullYear(), fechaLocal.getMonth(), fechaLocal.getDate());
                }
                
                // Función para generar ID de ruteador (igual que en calendario.html)
                function generarIdRuteador(fecha, ruta) {
                    const fechaStr = fecha instanceof Date 
                        ? `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`
                        : fecha;
                    // IMPORTANTE: Usar replace(' ', '-') para reemplazar solo el primer espacio (igual que calendario.html)
                    const rutaFormateada = ruta.replace(' ', '-');
                    return `${fechaStr}_${rutaFormateada}`;
                }
                
                // Función para generar key del cache (debe ser consistente con generarIdRuteador)
                function generarRuteadorKey(fecha, ruta) {
                    const fechaStr = fecha instanceof Date 
                        ? `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`
                        : fecha;
                    const rutaFormateada = ruta.replace(' ', '-');
                    return `${fechaStr}_${rutaFormateada}`;
                }
                
                // Función para formatear monto de forma compacta
                function formatearMontoCompacto(monto) {
                    if (monto >= 1000000) {
                        return `${(monto / 1000000).toFixed(1)}M`;
                    } else if (monto >= 1000) {
                        return `${Math.round(monto / 1000)}k`;
                    } else {
                        return `${Math.round(monto)}`;
                    }
                }
                
                // Función para cargar ruteador
                async function cargarRuteador(fecha, ruta) {
                    try {
                        const ruteadorId = generarIdRuteador(fecha, ruta);
                        const ruteadorRef = doc(db, 'ruteador', ruteadorId);
                        const ruteadorDoc = await getDoc(ruteadorRef);
                        
                        if (ruteadorDoc.exists()) {
                            const data = ruteadorDoc.data();
                            return {
                                tecnicos: (data.tecnicos || []).filter(t => t && String(t).trim() !== ''),
                                vehiculos: (data.vehiculos || []).filter(v => v && String(v).trim() !== '')
                            };
                        }
                        return { tecnicos: [], vehiculos: [] };
                    } catch (error) {
                        console.error('Error cargando ruteador:', error);
                        return { tecnicos: [], vehiculos: [] };
                    }
                }
                
                // Procesar citas y agrupar por empleado y día
                const matrizFacturacion = {}; // empleado -> día -> monto
                const matrizFacturacionPorHora = {}; // empleado -> día -> monto/hora
                
                // Obtener empleados únicos de empleadosData
                const empleadosUnicos = [...new Set(empleadosData.map(emp => emp.username))];
                
                // Inicializar matrices
                empleadosUnicos.forEach(username => {
                    matrizFacturacion[username] = {};
                    matrizFacturacionPorHora[username] = {};
                    diasDelMes.forEach(dia => {
                        const year = dia.getFullYear();
                        const month = String(dia.getMonth() + 1).padStart(2, '0');
                        const day = String(dia.getDate()).padStart(2, '0');
                        const diaKey = `${year}-${month}-${day}`;
                        matrizFacturacion[username][diaKey] = 0;
                        matrizFacturacionPorHora[username][diaKey] = 0;
                    });
                });
                
                // Pre-calcular horas trabajadas por empleado por día (más eficiente)
                const horasPorEmpleadoPorDia = {};
                empleadosUnicos.forEach(username => {
                    horasPorEmpleadoPorDia[username] = {};
                    diasDelMes.forEach(dia => {
                        const year = dia.getFullYear();
                        const month = String(dia.getMonth() + 1).padStart(2, '0');
                        const day = String(dia.getDate()).padStart(2, '0');
                        const diaKey = `${year}-${month}-${day}`;
                        horasPorEmpleadoPorDia[username][diaKey] = 0;
                    });
                });
                
                // Calcular horas trabajadas por empleado por día
                allWorkSessions.forEach(session => {
                    if (session.endTime && session.status === 'completed') {
                        const sessionDate = session.startTime.toDate();
                        const year = sessionDate.getFullYear();
                        const month = String(sessionDate.getMonth() + 1).padStart(2, '0');
                        const day = String(sessionDate.getDate()).padStart(2, '0');
                        const diaKey = `${year}-${month}-${day}`;
                        
                        if (horasPorEmpleadoPorDia[session.username] && horasPorEmpleadoPorDia[session.username][diaKey] !== undefined) {
                            const startTime = session.startTime.toDate();
                            const endTime = session.endTime.toDate();
                            const duracion = (endTime - startTime) / (1000 * 60 * 60);
                            horasPorEmpleadoPorDia[session.username][diaKey] += duracion;
                        }
                    }
                });
                
                // Aplicar descuento de almuerzo
                empleadosUnicos.forEach(username => {
                    const empleado = empleadosData.find(emp => emp.username === username);
                    if (empleado && requiereDescuentoAlmuerzo(empleado.departamento)) {
                        diasDelMes.forEach(dia => {
                            const year = dia.getFullYear();
                            const month = String(dia.getMonth() + 1).padStart(2, '0');
                            const day = String(dia.getDate()).padStart(2, '0');
                            const diaKey = `${year}-${month}-${day}`;
                            
                            if (horasPorEmpleadoPorDia[username][diaKey] > 0) {
                                horasPorEmpleadoPorDia[username][diaKey] = Math.max(0, horasPorEmpleadoPorDia[username][diaKey] - 1);
                            }
                        });
                    }
                });
                
                // Cargar vacaciones aprobadas para el mes
                const vacacionesAprobadas = await cargarVacacionesAprobadasParaMes(fechaInicio, fechaFin);
                
                // Crear mapa de vacaciones: empleado -> Set de días con vacaciones (formato YYYY-MM-DD)
                const mapaVacaciones = {};
                vacacionesAprobadas.forEach(vac => {
                    const empleadoId = vac.empleadoId;
                    if (!mapaVacaciones[empleadoId]) {
                        mapaVacaciones[empleadoId] = new Set();
                    }
                    
                    // Procesar array de días de vacaciones
                    if (vac.dias && Array.isArray(vac.dias)) {
                        vac.dias.forEach(diaTimestamp => {
                            try {
                                const fechaDia = diaTimestamp.toDate ? diaTimestamp.toDate() : new Date(diaTimestamp);
                                const year = fechaDia.getFullYear();
                                const month = String(fechaDia.getMonth() + 1).padStart(2, '0');
                                const day = String(fechaDia.getDate()).padStart(2, '0');
                                const diaKey = `${year}-${month}-${day}`;
                                mapaVacaciones[empleadoId].add(diaKey);
                            } catch (e) {
                                // Error procesando día de vacación
                            }
                        });
                    }
                });
                
                // OPTIMIZACIÓN: Identificar todas las combinaciones únicas de (fecha, ruta) necesarias
                const ruteadoresNecesarios = new Set();
                const citasValidas = [];
                
                for (const cita of todasLasCitas) {
                    // Determinar día operacional
                    const diaOperacional = obtenerDiaOperacional(cita.inicio_gmt6);
                    if (!diaOperacional) continue;
                    
                    // Verificar si el día operacional está en el rango del mes
                    const year = diaOperacional.getFullYear();
                    const month = diaOperacional.getMonth() + 1;
                    const day = diaOperacional.getDate();
                    
                    if (year !== parseInt(año) || month !== parseInt(mes)) continue;
                    
                    const diaKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    // Obtener ruta de la cita
                    const ruta = cita.metadata?.ruta || cita.ruta || 'Sin asignar';
                    if (!ruta || ruta === 'Sin asignar') continue;
                    
                    // Obtener monto
                    const monto = cita.metadata?.monto || 0;
                    if (!monto || monto <= 0) continue;
                    
                    // Agregar a la lista de ruteadores necesarios usando la función correcta
                    const ruteadorKey = generarRuteadorKey(diaOperacional, ruta);
                    ruteadoresNecesarios.add(ruteadorKey);
                    
                    // Guardar cita válida para procesar después
                    citasValidas.push({
                        cita,
                        diaOperacional,
                        diaKey,
                        ruta,
                        monto,
                        ruteadorKey // Guardar el key para uso posterior
                    });
                }
                
                console.log(`📊 Citas válidas: ${citasValidas.length}, Ruteadores únicos a cargar: ${ruteadoresNecesarios.size}`);
                
                // OPTIMIZACIÓN: Cargar todos los ruteadores necesarios en paralelo
                const ruteadoresCache = new Map();
                const ruteadoresPromesas = Array.from(ruteadoresNecesarios).map(async (ruteadorKey) => {
                    try {
                        // Parsear el key: formato "YYYY-MM-DD_Ruta-X"
                        // El split('_') puede tener problemas si la ruta tiene guiones, así que usamos el último '_'
                        const lastUnderscore = ruteadorKey.lastIndexOf('_');
                        if (lastUnderscore === -1) {
                            console.error('❌ Formato de ruteadorKey inválido:', ruteadorKey);
                            return;
                        }
                        
                        const fechaStr = ruteadorKey.substring(0, lastUnderscore);
                        const rutaFormateada = ruteadorKey.substring(lastUnderscore + 1);
                        
                        // Convertir ruta formateada de vuelta a formato original (Ruta-X -> Ruta X)
                        // Solo reemplazar el primer guión (inverso de replace(' ', '-'))
                        const ruta = rutaFormateada.replace('-', ' ');
                        
                        const [yearStr, monthStr, dayStr] = fechaStr.split('-');
                        const fecha = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));
                        
                        const ruteador = await cargarRuteador(fecha, ruta);
                        ruteadoresCache.set(ruteadorKey, ruteador);
                    } catch (error) {
                        console.error(`❌ Error cargando ruteador ${ruteadorKey}:`, error);
                    }
                });
                
                // Esperar a que todos los ruteadores se carguen
                await Promise.all(ruteadoresPromesas);
                console.log(`✅ Ruteadores cargados: ${ruteadoresCache.size}`);
                
                // Procesar citas usando el cache de ruteadores
                let citasProcesadas = 0;
                let citasConMonto = 0;
                let citasConRuta = 0;
                let citasConTecnicos = 0;
                
                // Contador para debug
                const citasPorTecnico = {}; // Para verificar si hay double counting
                
                for (const { cita, diaOperacional, diaKey, ruta, monto, ruteadorKey } of citasValidas) {
                    citasProcesadas++;
                    citasConRuta++;
                    citasConMonto++;
                    
                    // Obtener ruteador del cache usando el key guardado
                    const ruteador = ruteadoresCache.get(ruteadorKey) || { tecnicos: [], vehiculos: [] };
                    const tecnicos = ruteador.tecnicos || [];
                    
                    if (tecnicos.length === 0) {
                        console.warn(`⚠️ Cita ${cita.id} sin técnicos en ruteador ${ruteadorKey}`);
                        continue;
                    }
                    
                    citasConTecnicos++;
                    
                    // Filtrar técnicos duplicados (por si acaso)
                    const tecnicosUnicos = [...new Set(tecnicos.filter(t => t && String(t).trim() !== ''))];
                    
                    if (tecnicosUnicos.length === 0) {
                        console.warn(`⚠️ Cita ${cita.id} sin técnicos válidos después de filtrar duplicados`);
                        continue;
                    }
                    
                    // Dividir monto entre técnicos únicos
                    const montoPorTecnico = monto / tecnicosUnicos.length;
                    
                    // Debug: verificar que el monto se divide correctamente (solo primeras 5 citas)
                    if (citasProcesadas <= 5) {
                        console.log(`🔍 Cita ${cita.id}: monto=${monto}, técnicos=${tecnicosUnicos.length} (únicos), montoPorTecnico=${montoPorTecnico.toFixed(2)}, ruta=${ruta}, diaKey=${diaKey}`);
                    }
                    
                    // Asignar monto a cada técnico único
                    tecnicosUnicos.forEach(tecnicoUsername => {
                        if (!matrizFacturacion[tecnicoUsername]) {
                            console.warn(`⚠️ Técnico ${tecnicoUsername} no existe en matrizFacturacion (no está en empleadosData)`);
                            return;
                        }
                        
                        if (matrizFacturacion[tecnicoUsername][diaKey] === undefined) {
                            console.warn(`⚠️ Día ${diaKey} no existe en matrizFacturacion para ${tecnicoUsername}`);
                            return;
                        }
                        
                        // Debug: rastrear asignaciones (solo para primeros 3 técnicos)
                        if (Object.keys(citasPorTecnico).length < 3 || citasPorTecnico[tecnicoUsername]) {
                            if (!citasPorTecnico[tecnicoUsername]) {
                                citasPorTecnico[tecnicoUsername] = {};
                            }
                            if (!citasPorTecnico[tecnicoUsername][diaKey]) {
                                citasPorTecnico[tecnicoUsername][diaKey] = [];
                            }
                            citasPorTecnico[tecnicoUsername][diaKey].push({
                                citaId: cita.id,
                                monto: montoPorTecnico,
                                ruta: ruta,
                                montoTotal: monto
                            });
                        }
                        
                        matrizFacturacion[tecnicoUsername][diaKey] += montoPorTecnico;
                        
                        // Calcular monto por hora usando las horas pre-calculadas
                        const horas = horasPorEmpleadoPorDia[tecnicoUsername]?.[diaKey] || 0;
                        if (horas > 0) {
                            const montoPorHora = montoPorTecnico / horas;
                            matrizFacturacionPorHora[tecnicoUsername][diaKey] += montoPorHora;
                        }
                    });
                }
                
                // Debug: mostrar resumen de asignaciones
                if (Object.keys(citasPorTecnico).length > 0) {
                    console.log('📊 Resumen de asignaciones (primeros 3 técnicos):');
                    let count = 0;
                    for (const username in citasPorTecnico) {
                        if (count >= 3) break;
                        const totalCitas = Object.values(citasPorTecnico[username]).reduce((sum, arr) => sum + arr.length, 0);
                        const totalMonto = Object.values(citasPorTecnico[username]).reduce((sum, arr) => 
                            sum + arr.reduce((s, c) => s + c.monto, 0), 0
                        );
                        console.log(`  ${username}: ${totalCitas} citas, total monto asignado: ₡${totalMonto.toLocaleString('es-CR')}`);
                        count++;
                    }
                }
                
                console.log(`✅ Citas procesadas: ${citasProcesadas} del mes, ${citasConRuta} con ruta, ${citasConMonto} con monto, ${citasConTecnicos} con técnicos asignados`);
                
                // Generar HTML de la tabla 1: Facturación Total por Día
                let html1 = '<table class="horas-por-dia-table">';
                html1 += '<thead><tr>';
                html1 += '<th>Empleado</th>';
                diasDelMes.forEach(dia => {
                    const diaStr = dia.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit' });
                    const esDomingoFeriado = esDomingoOFeriado(dia);
                    const claseDia = esDomingoFeriado ? 'dia-domingo-feriado' : '';
                    html1 += `<th class="${claseDia}" title="${dia.toLocaleDateString('es-ES')}">${diaStr}</th>`;
                });
                html1 += '</tr></thead>';
                
                // Agrupar empleados por departamento
                const empleadosPorDepartamento = {};
                empleadosUnicos.forEach(username => {
                    const empleado = empleadosData.find(emp => emp.username === username);
                    const departamento = empleado?.departamento || 'Sin Departamento';
                    
                    if (!empleadosPorDepartamento[departamento]) {
                        empleadosPorDepartamento[departamento] = [];
                    }
                    empleadosPorDepartamento[departamento].push(username);
                });
                
                // Ordenar departamentos
                const departamentosOrdenados = Object.keys(empleadosPorDepartamento).sort((a, b) => {
                    if (a === 'Sin Departamento') return 1;
                    if (b === 'Sin Departamento') return -1;
                    return a.localeCompare(b);
                });
                
                html1 += '<tbody>';
                departamentosOrdenados.forEach(departamento => {
                    const empleados = empleadosPorDepartamento[departamento];
                    
                    // Fila de encabezado del departamento
                    html1 += `<tr class="departamento-header-row">`;
                    html1 += `<td colspan="${diasDelMes.length + 1}" class="departamento-header-cell">`;
                    html1 += `<i class="fas fa-building"></i> <strong>${departamento}</strong> <span class="badge bg-secondary ms-2">${empleados.length}</span>`;
                    html1 += `</td>`;
                    html1 += `</tr>`;
                    
                    // Filas de empleados del departamento
                    empleados.forEach(username => {
                        // Obtener nombre del empleado (puede ser string o objeto)
                        let nombreEmpleado = username;
                        if (empleadosMap[username]) {
                            if (typeof empleadosMap[username] === 'string') {
                                nombreEmpleado = empleadosMap[username];
                            } else if (empleadosMap[username].nombre) {
                                nombreEmpleado = empleadosMap[username].nombre;
                            }
                        } else {
                            // Si no está en el mapa, buscar en empleadosData
                            const empleado = empleadosData.find(emp => emp.username === username);
                            if (empleado) {
                                nombreEmpleado = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() || username;
                            }
                        }
                        
                        html1 += `<tr>`;
                        html1 += `<td title="${username}">${nombreEmpleado}</td>`;
                        
                        diasDelMes.forEach(dia => {
                            const year = dia.getFullYear();
                            const month = String(dia.getMonth() + 1).padStart(2, '0');
                            const day = String(dia.getDate()).padStart(2, '0');
                            const diaKey = `${year}-${month}-${day}`;
                            const monto = matrizFacturacion[username][diaKey] || 0;
                            const horas = horasPorEmpleadoPorDia[username]?.[diaKey] || 0;
                            
                            // Verificar si hay vacaciones aprobadas para este empleado en este día
                            const tieneVacaciones = mapaVacaciones[username] && mapaVacaciones[username].has(diaKey);
                            
                            // Verificar si es domingo o feriado
                            const esDomingoFeriado = esDomingoOFeriado(dia);
                            
                            // Determinar clase CSS basada en monto, horas trabajadas y vacaciones
                            let claseCss = '';
                            let texto = '';
                            let titulo = '';
                            
                            // Prioridad: Si hay vacaciones aprobadas, mostrar en morado
                            if (tieneVacaciones) {
                                claseCss = 'celda-vacaciones';
                                if (monto > 0) {
                                    texto = formatearMontoCompacto(monto);
                                    titulo = `${dia.toLocaleDateString('es-ES')}: ₡${monto.toLocaleString('es-CR')} - Vacaciones aprobadas`;
                                } else {
                                    texto = 'V';
                                    titulo = `${dia.toLocaleDateString('es-ES')}: Vacaciones aprobadas`;
                                }
                            }
                            // Si no trabajó horas, mostrar "-" sin color especial
                            else if (horas === 0) {
                                claseCss = esDomingoFeriado ? 'celda-sin-horas dia-domingo-feriado' : 'celda-sin-horas';
                                texto = '-';
                                titulo = `${dia.toLocaleDateString('es-ES')}: Sin horas trabajadas`;
                            } 
                            // Si trabajó pero monto = 0, mostrar en rojo (valor bajo)
                            else if (monto === 0) {
                                claseCss = esDomingoFeriado ? 'celda-pocas-horas dia-domingo-feriado' : 'celda-pocas-horas'; // Rojo (valor bajo)
                                texto = '₡0';
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡0 (${horas.toFixed(1)}h trabajadas)`;
                            } 
                            // Monto bajo: rojo
                            else if (monto < 50000) {
                                claseCss = esDomingoFeriado ? 'celda-pocas-horas dia-domingo-feriado' : 'celda-pocas-horas'; // Rojo
                                texto = formatearMontoCompacto(monto);
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡${monto.toLocaleString('es-CR')}`;
                            } 
                            // Monto medio: amarillo/normal
                            else if (monto <= 200000) {
                                claseCss = esDomingoFeriado ? 'celda-horas-normales dia-domingo-feriado' : 'celda-horas-normales'; // Amarillo/Normal
                                texto = formatearMontoCompacto(monto);
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡${monto.toLocaleString('es-CR')}`;
                            } 
                            // Monto alto: verde
                            else {
                                claseCss = esDomingoFeriado ? 'celda-muchas-horas dia-domingo-feriado' : 'celda-muchas-horas'; // Verde (valor alto)
                                texto = formatearMontoCompacto(monto);
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡${monto.toLocaleString('es-CR')}`;
                            }
                            
                            html1 += `<td class="${claseCss}" title="${titulo}">${texto}</td>`;
                        });
                        
                        html1 += '</tr>';
                    });
                });
                
                html1 += '</tbody></table>';
                
                // Generar HTML de la tabla 2: Facturación por Hora Laborada
                let html2 = '<table class="horas-por-dia-table">';
                html2 += '<thead><tr>';
                html2 += '<th>Empleado</th>';
                diasDelMes.forEach(dia => {
                    const diaStr = dia.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit' });
                    const esDomingoFeriado = esDomingoOFeriado(dia);
                    const claseDia = esDomingoFeriado ? 'dia-domingo-feriado' : '';
                    html2 += `<th class="${claseDia}" title="${dia.toLocaleDateString('es-ES')}">${diaStr}</th>`;
                });
                html2 += '</tr></thead>';
                
                html2 += '<tbody>';
                departamentosOrdenados.forEach(departamento => {
                    const empleados = empleadosPorDepartamento[departamento];
                    
                    // Fila de encabezado del departamento
                    html2 += `<tr class="departamento-header-row">`;
                    html2 += `<td colspan="${diasDelMes.length + 1}" class="departamento-header-cell">`;
                    html2 += `<i class="fas fa-building"></i> <strong>${departamento}</strong> <span class="badge bg-secondary ms-2">${empleados.length}</span>`;
                    html2 += `</td>`;
                    html2 += `</tr>`;
                    
                    // Filas de empleados del departamento
                    empleados.forEach(username => {
                        // Obtener nombre del empleado (puede ser string o objeto)
                        let nombreEmpleado = username;
                        if (empleadosMap[username]) {
                            if (typeof empleadosMap[username] === 'string') {
                                nombreEmpleado = empleadosMap[username];
                            } else if (empleadosMap[username].nombre) {
                                nombreEmpleado = empleadosMap[username].nombre;
                            }
                        } else {
                            // Si no está en el mapa, buscar en empleadosData
                            const empleado = empleadosData.find(emp => emp.username === username);
                            if (empleado) {
                                nombreEmpleado = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() || username;
                            }
                        }
                        
                        html2 += `<tr>`;
                        html2 += `<td title="${username}">${nombreEmpleado}</td>`;
                        
                        diasDelMes.forEach(dia => {
                            const year = dia.getFullYear();
                            const month = String(dia.getMonth() + 1).padStart(2, '0');
                            const day = String(dia.getDate()).padStart(2, '0');
                            const diaKey = `${year}-${month}-${day}`;
                            const montoPorHora = matrizFacturacionPorHora[username][diaKey] || 0;
                            const horas = horasPorEmpleadoPorDia[username]?.[diaKey] || 0;
                            
                            // Verificar si hay vacaciones aprobadas para este empleado en este día
                            const tieneVacaciones = mapaVacaciones[username] && mapaVacaciones[username].has(diaKey);
                            
                            // Verificar si es domingo o feriado
                            const esDomingoFeriado = esDomingoOFeriado(dia);
                            
                            // Determinar clase CSS basada en monto por hora, horas trabajadas y vacaciones
                            let claseCss = '';
                            let texto = '';
                            let titulo = '';
                            
                            // Prioridad: Si hay vacaciones aprobadas, mostrar en morado
                            if (tieneVacaciones) {
                                claseCss = 'celda-vacaciones';
                                if (montoPorHora > 0) {
                                    texto = `${formatearMontoCompacto(montoPorHora)}/h`;
                                    titulo = `${dia.toLocaleDateString('es-ES')}: ₡${montoPorHora.toLocaleString('es-CR')} por hora - Vacaciones aprobadas`;
                                } else {
                                    texto = 'V';
                                    titulo = `${dia.toLocaleDateString('es-ES')}: Vacaciones aprobadas`;
                                }
                            }
                            // Si no trabajó horas, mostrar "-" sin color especial
                            else if (horas === 0) {
                                claseCss = esDomingoFeriado ? 'celda-sin-horas dia-domingo-feriado' : 'celda-sin-horas';
                                texto = '-';
                                titulo = `${dia.toLocaleDateString('es-ES')}: Sin horas trabajadas`;
                            } 
                            // Si trabajó pero monto/hora = 0, mostrar en rojo (valor bajo)
                            else if (montoPorHora === 0) {
                                claseCss = esDomingoFeriado ? 'celda-pocas-horas dia-domingo-feriado' : 'celda-pocas-horas'; // Rojo (valor bajo)
                                texto = '₡0/h';
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡0 por hora (${horas.toFixed(1)}h trabajadas)`;
                            } 
                            // Monto/hora bajo: rojo
                            else if (montoPorHora < 5000) {
                                claseCss = esDomingoFeriado ? 'celda-pocas-horas dia-domingo-feriado' : 'celda-pocas-horas'; // Rojo
                                texto = `${formatearMontoCompacto(montoPorHora)}/h`;
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡${montoPorHora.toLocaleString('es-CR')} por hora`;
                            } 
                            // Monto/hora medio: amarillo/normal
                            else if (montoPorHora <= 20000) {
                                claseCss = esDomingoFeriado ? 'celda-horas-normales dia-domingo-feriado' : 'celda-horas-normales'; // Amarillo/Normal
                                texto = `${formatearMontoCompacto(montoPorHora)}/h`;
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡${montoPorHora.toLocaleString('es-CR')} por hora`;
                            } 
                            // Monto/hora alto: verde
                            else {
                                claseCss = esDomingoFeriado ? 'celda-muchas-horas dia-domingo-feriado' : 'celda-muchas-horas'; // Verde (valor alto)
                                texto = `${formatearMontoCompacto(montoPorHora)}/h`;
                                titulo = `${dia.toLocaleDateString('es-ES')}: ₡${montoPorHora.toLocaleString('es-CR')} por hora`;
                            }
                            
                            html2 += `<td class="${claseCss}" title="${titulo}">${texto}</td>`;
                        });
                        
                        html2 += '</tr>';
                    });
                });
                
                html2 += '</tbody></table>';
                
                // Mostrar las tablas
                document.getElementById('facturacionPorDiaTable').innerHTML = html1;
                document.getElementById('facturacionPorHoraTable').innerHTML = html2;
                
                console.log('✅ Reporte de facturación generado exitosamente');
                
            } catch (error) {
                console.error('❌ Error generando reporte de facturación:', error);
                document.getElementById('facturacionPorDiaTable').innerHTML = '<p class="text-danger">Error al generar el reporte: ' + error.message + '</p>';
                document.getElementById('facturacionPorHoraTable').innerHTML = '<p class="text-danger">Error al generar el reporte: ' + error.message + '</p>';
            }
        }
        
        // Función auxiliar para cargar vacaciones aprobadas para un rango de fechas
        async function cargarVacacionesAprobadasParaMes(fechaInicio, fechaFin) {
            try {
                const q = query(
                    collection(db, 'vacaciones'),
                    where('estado', '==', 'aprobada')
                );
                
                const snapshot = await getDocs(q);
                const vacaciones = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Verificar si alguna de las fechas de vacaciones está en el rango del mes
                    if (data.dias && Array.isArray(data.dias)) {
                        let tieneFechaEnRango = false;
                        
                        data.dias.forEach(diaTimestamp => {
                            try {
                                const fechaDia = diaTimestamp.toDate ? diaTimestamp.toDate() : new Date(diaTimestamp);
                                // Comparar solo fecha (sin hora)
                                const fechaDiaInicio = new Date(fechaDia.getFullYear(), fechaDia.getMonth(), fechaDia.getDate());
                                const fechaInicioComparar = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth(), fechaInicio.getDate());
                                const fechaFinComparar = new Date(fechaFin.getFullYear(), fechaFin.getMonth(), fechaFin.getDate());
                                
                                if (fechaDiaInicio >= fechaInicioComparar && fechaDiaInicio <= fechaFinComparar) {
                                    tieneFechaEnRango = true;
                                }
                            } catch (e) {
                                // Ignorar errores de fecha
                            }
                        });
                        
                        if (tieneFechaEnRango) {
                            vacaciones.push(data);
                        }
                    }
                });
                
                return vacaciones;
            } catch (error) {
                console.error('Error cargando vacaciones aprobadas:', error);
                return [];
            }
        }
        
        // Toggle empleado
        window.toggleEmpleado = function(empleadoId) {
            const content = document.getElementById(`content-${empleadoId}`);
            const icon = document.getElementById(`icon-${empleadoId}`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('expanded');
            }
        };

        // Toggle semana
        window.toggleSemana = function(semanaKey) {
            const content = document.getElementById(`semana-content-${semanaKey}`);
            const icon = document.getElementById(`semana-icon-${semanaKey}`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('expanded');
            }
        };

        // Exportar funciones para editar hora de inicio
        window.abrirModalEditarHoraInicio = abrirModalEditarHoraInicio;
        window.saveStartTimeChange = saveStartTimeChange;
        
        // ===== FUNCIONES DEL MAPA GPS =====
        
        // Toggle del mapa GPS
        function toggleMapa() {
            const container = document.getElementById('mapaGPSContainer');
            const toggle = document.getElementById('toggleMapaGPS');
            
            if (mostrarMapa) {
                // Ocultar mapa
                container.classList.add('hidden');
                toggle.innerHTML = '<i class="fas fa-map"></i> Mostrar Mapa';
                toggle.classList.remove('active');
                mostrarMapa = false;
            } else {
                // Mostrar mapa
                container.classList.remove('hidden');
                toggle.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Mapa';
                toggle.classList.add('active');
                mostrarMapa = true;
                
                // Inicializar mapa si no existe
                if (!mapaGPS) {
                    inicializarMapa();
                }
                
                // Cargar datos GPS
                cargarDatosGPS();
            }
        }
        
        // Inicializar el mapa Leaflet
        function inicializarMapa() {
            // Coordenadas de la oficina principal (Costa Rica)
            const oficinaLat = 9.953848;
            const oficinaLng = -84.165469;
            
            // Crear mapa centrado en la oficina con zoom máximo aumentado
            mapaGPS = L.map('mapaGPS', {
                maxZoom: 20,  // Permitir zoom hasta nivel 20 para separar puntos cercanos
                minZoom: 8    // Zoom mínimo para mantener contexto
            }).setView([oficinaLat, oficinaLng], 12);
            
            // Agregar capa de tiles con zoom máximo aumentado
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 20,  // Zoom máximo para los tiles
                maxNativeZoom: 19  // Zoom máximo nativo de OpenStreetMap
            }).addTo(mapaGPS);
            
            // Agregar marcador de la oficina
            const oficinaIcon = L.divIcon({
                className: 'oficina-marker',
                html: '<div style="background: #007bff; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([oficinaLat, oficinaLng], { icon: oficinaIcon })
                .addTo(mapaGPS)
                .bindPopup('<b>Oficina Principal</b><br>Eco Plagas');
        }
        
        // Cargar datos GPS de la semana actual
        async function cargarDatosGPS() {
            try {
                console.clear();
                // Iniciando generación de mapa GPS (sin log)
                
                // Verificar que allWorkSessions esté definida
                if (typeof allWorkSessions === 'undefined' || !allWorkSessions) {
                    // allWorkSessions no está definida, cargando datos primero (sin log)
                    await loadData();
                }
                
                // Verificar que empleadosMap esté definida
                if (typeof empleadosMap === 'undefined' || !empleadosMap || Object.keys(empleadosMap).length === 0) {
                    // empleadosMap no está definida, cargando empleados primero (sin log)
                    await loadEmpleados();
                }
                
                // Total work_sessions cargadas (sin log)
                
                // Limpiar marcadores existentes
                marcadoresGPS.forEach(marker => mapaGPS.removeLayer(marker));
                marcadoresGPS = [];
                datosGPS = [];
                
                // Usar filtro de semana si está seleccionado, sino usar semana actual
                const semanaFiltro = filtroSemana || getCurrentWeek();
                
                // Procesando todas las sesiones disponibles (sin log)
                
                // Filtrar por semana
                let todasLasSesiones = allWorkSessions.filter(session => {
                    const sessionDate = session.startTime.toDate();
                    const sessionWeek = getWeekKey(sessionDate);
                    const match = sessionWeek === semanaFiltro;
                    return match;
                });
                
                // Total sesiones de la semana (sin log)
                
                // Filtrar por GPS - verificar estructura de datos GPS (latitude/longitude)
                let sesionesConGPS = todasLasSesiones.filter(session => {
                    const gpsStartValido = session.gpsStart && 
                        typeof session.gpsStart === 'object' && 
                        session.gpsStart.latitude && 
                        session.gpsStart.longitude;
                    
                    const gpsEndValido = session.gpsEnd && 
                        typeof session.gpsEnd === 'object' && 
                        session.gpsEnd.latitude && 
                        session.gpsEnd.longitude;
                    
                    const tieneGPS = gpsStartValido || gpsEndValido;
                    
                    // Verificando GPS de sesión (sin log)
                    
                    return tieneGPS;
                });
                
                // Aplicar filtro de empleado si está seleccionado
                if (filtroEmpleado && filtroEmpleado !== '') {
                    // Aplicando filtro de empleado (sin log)
                    sesionesConGPS = sesionesConGPS.filter(session => {
                        const match = session.username === filtroEmpleado;
                        // Verificando match de empleado (sin log)
                        return match;
                    });
                }
                
                // Sesiones con GPS encontradas (sin log)
                
                let totalPuntos = 0;
                let inicios = 0;
                let fines = 0;
                let turnosActivos = 0;
                const empleadosUnicos = new Set();
                
                // Procesar cada sesión
                // Procesando sesiones con GPS (sin log)
                sesionesConGPS.forEach((session, index) => {
                    
                    const empleado = empleadosMap[session.username];
                    if (!empleado) {
                        // Empleado no encontrado en empleadosMap (sin log)
                        return;
                    }
                    
                    empleadosUnicos.add(session.username);
                    
                    // Contar turnos activos
                    if (session.status === 'working') {
                        turnosActivos++;
                        // Turno activo detectado (sin log)
                    }
                    
                    // Agregar punto de inicio si existe
                    const gpsStartValido = session.gpsStart && 
                        typeof session.gpsStart === 'object' && 
                        session.gpsStart.latitude && 
                        session.gpsStart.longitude;
                    
                    if (gpsStartValido) {
                        // Obtener iniciales (2 letras: primera del nombre y primera del apellido)
                        let inicial = '?';
                        if (empleado.iniciales && empleado.iniciales.length >= 2) {
                            inicial = empleado.iniciales.substring(0, 2).toUpperCase();
                        } else if (empleado.nombre) {
                            const partes = empleado.nombre.trim().split(' ').filter(p => p.length > 0);
                            if (partes.length >= 2) {
                                inicial = (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
                            } else if (partes.length === 1) {
                                inicial = partes[0].charAt(0).toUpperCase();
                            }
                        }
                        
                        // Agregando marcador de INICIO (sin log)
                        agregarMarcadorGPS(
                            session.gpsStart.latitude, 
                            session.gpsStart.longitude, 
                            'inicio', 
                            empleado.nombre,
                            inicial,
                            session.startTime.toDate(),
                            session
                        );
                        inicios++;
                        totalPuntos++;
                    } else {
                        // No hay GPS de inicio válido (sin log)
                    }
                    
                    // Agregar punto de fin si existe
                    const gpsEndValido = session.gpsEnd && 
                        typeof session.gpsEnd === 'object' && 
                        session.gpsEnd.latitude && 
                        session.gpsEnd.longitude;
                    
                    if (gpsEndValido) {
                        // Obtener iniciales (2 letras: primera del nombre y primera del apellido)
                        let inicial = '?';
                        if (empleado.iniciales && empleado.iniciales.length >= 2) {
                            inicial = empleado.iniciales.substring(0, 2).toUpperCase();
                        } else if (empleado.nombre) {
                            const partes = empleado.nombre.trim().split(' ').filter(p => p.length > 0);
                            if (partes.length >= 2) {
                                inicial = (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
                            } else if (partes.length === 1) {
                                inicial = partes[0].charAt(0).toUpperCase();
                            }
                        }
                        
                        // Agregando marcador de FIN (sin log)
                        agregarMarcadorGPS(
                            session.gpsEnd.latitude, 
                            session.gpsEnd.longitude, 
                            'fin', 
                            empleado.nombre,
                            inicial,
                            session.endTime ? session.endTime.toDate() : null,
                            session
                        );
                        fines++;
                        totalPuntos++;
                    } else {
                        // No hay GPS de fin válido (sin log)
                    }
                });
                
                // Actualizar estadísticas
                actualizarEstadisticasGPS(totalPuntos, inicios, fines, empleadosUnicos.size, turnosActivos);
                
                // Ajustar vista del mapa para mostrar todos los marcadores
                if (marcadoresGPS.length > 0) {
                    const group = new L.featureGroup(marcadoresGPS);
                    mapaGPS.fitBounds(group.getBounds().pad(0.1));
                }
                
                // Mapa GPS generado exitosamente (sin log)
                
            } catch (error) {
                console.error('❌ Error cargando datos GPS:', error);
                if (window.safeLogger) {
                    window.safeLogger.error('Error en reporte', error);
                } else {
                    console.error('Error en reporte');
                }
            }
        }
        
        // Agregar marcador GPS al mapa
        function agregarMarcadorGPS(lat, lng, tipo, empleadoNombre, inicial, fecha, session) {
            // Agregando marcador (sin log)
            const color = tipo === 'inicio' ? '#28a745' : '#dc3545';
            const icono = tipo === 'inicio' ? 'play-circle' : 'stop-circle';
            
            // Mostrar las iniciales (2 letras)
            const inicialMostrar = inicial && inicial.length >= 2 
                ? inicial.substring(0, 2).toUpperCase() 
                : (inicial && inicial.length === 1 
                    ? inicial.toUpperCase() 
                    : (empleadoNombre 
                        ? empleadoNombre.trim().split(' ').filter(p => p.length > 0).map(p => p.charAt(0)).join('').substring(0, 2).toUpperCase() 
                        : '?'));
            
            const customIcon = L.divIcon({
                className: 'gps-marker',
                html: `<div style="
                    background: ${color}; 
                    width: 28px; 
                    height: 28px; 
                    border-radius: 50%; 
                    border: 2px solid white; 
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 12px;
                    color: white;
                    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                ">${inicialMostrar}</div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
            
            const marker = L.marker([lat, lng], { icon: customIcon }).addTo(mapaGPS);
            
            // Crear popup con información
            const fechaStr = fecha ? fecha.toLocaleString('es-ES') : 'En progreso';
            const tipoStr = tipo === 'inicio' ? 'Inicio' : 'Fin';
            const estadoStr = session.status === 'working' ? ' (Activo)' : '';
            
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h6 style="margin: 0 0 8px 0; color: ${color};">
                        <i class="fas fa-${icono}"></i> ${tipoStr} de Turno${estadoStr}
                    </h6>
                    <p style="margin: 0 0 4px 0;"><strong>Empleado:</strong> ${empleadoNombre}</p>
                    <p style="margin: 0 0 4px 0;"><strong>Fecha:</strong> ${fechaStr}</p>
                    <p style="margin: 0 0 4px 0;"><strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                    ${session.status === 'working' ? '<p style="margin: 0 0 4px 0; color: #28a745;"><strong>Estado:</strong> <i class="fas fa-circle" style="color: #28a745; font-size: 8px;"></i> Turno Activo</p>' : ''}
                    ${session.notes ? `<p style="margin: 0;"><strong>Notas:</strong> ${session.notes}</p>` : ''}
                </div>
            `);
            
            marcadoresGPS.push(marker);
        }
        
        // Actualizar estadísticas del mapa GPS
        function actualizarEstadisticasGPS(totalPuntos, inicios, fines, empleados, turnosActivos = 0) {
            document.getElementById('totalPuntosGPS').textContent = totalPuntos;
            document.getElementById('iniciosGPS').textContent = inicios;
            document.getElementById('finesGPS').textContent = fines;
            document.getElementById('empleadosConGPS').textContent = empleados;
            
            // Actualizar estadística de turnos activos si existe el elemento
            const turnosActivosEl = document.getElementById('turnosActivosGPS');
            if (turnosActivosEl) {
                turnosActivosEl.textContent = turnosActivos;
            }
        }
        
        // Obtener la semana actual para el filtro
        function getCurrentWeek() {
            const now = new Date();
            return getWeekKey(now);
        }

        // --- LÓGICA DE VACACIONES ---
        let mesVacacionesActual = new Date();
        let unsubscribeVacaciones = null;

        // Función para cambiar el mes del calendario
        window.cambiarMesVacaciones = function(delta) {
            mesVacacionesActual.setMonth(mesVacacionesActual.getMonth() + delta);
            renderCalendarioVacaciones();
        };

        // Abrir modal para crear solicitud de vacaciones
        window.abrirModalCrearVacacion = function() {
            const modal = new bootstrap.Modal(document.getElementById('modalCrearVacacion'));
            
            // Llenar select de empleados
            const selectEmpleado = document.getElementById('empleadoVacacionSelect');
            selectEmpleado.innerHTML = '<option value="">Selecciona un empleado</option>';
            
            if (empleadosData && empleadosData.length > 0) {
                // Ordenar empleados alfabéticamente
                const empleadosOrdenados = [...empleadosData].sort((a, b) => {
                    const nombreA = `${a.primerNombre} ${a.primerApellido}`.toLowerCase();
                    const nombreB = `${b.primerNombre} ${b.primerApellido}`.toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                empleadosOrdenados.forEach(empleado => {
                    const option = document.createElement('option');
                    option.value = empleado.username;
                    option.textContent = `${empleado.primerNombre} ${empleado.primerApellido} (@${empleado.username})`;
                    selectEmpleado.appendChild(option);
                });
            } else {
                // Si no hay empleados cargados, intentar cargarlos
                loadEmpleados().then(() => {
                    if (empleadosData && empleadosData.length > 0) {
                        const empleadosOrdenados = [...empleadosData].sort((a, b) => {
                            const nombreA = `${a.primerNombre} ${a.primerApellido}`.toLowerCase();
                            const nombreB = `${b.primerNombre} ${b.primerApellido}`.toLowerCase();
                            return nombreA.localeCompare(nombreB);
                        });
                        
                        empleadosOrdenados.forEach(empleado => {
                            const option = document.createElement('option');
                            option.value = empleado.username;
                            option.textContent = `${empleado.primerNombre} ${empleado.primerApellido} (@${empleado.username})`;
                            selectEmpleado.appendChild(option);
                        });
                    }
                });
            }
            
            // Limpiar formulario
            document.getElementById('formCrearVacacion').reset();
            document.getElementById('infoDiasVacacionAdmin').style.display = 'none';
            
            modal.show();
        };

        // Listeners para calcular días dinámicamente en el formulario admin
        const inputInicioAdmin = document.getElementById('fechaInicioVacacionAdmin');
        const inputFinAdmin = document.getElementById('fechaFinVacacionAdmin');
        const infoDivAdmin = document.getElementById('infoDiasVacacionAdmin');
        const countSpanAdmin = document.getElementById('cantidadDiasCalcAdmin');
        
        function actualizarCalculoDiasAdmin() {
            const inicio = inputInicioAdmin.value;
            const fin = inputFinAdmin.value;
            
            if (inicio && fin) {
                const dias = calcularDiasHabiles(inicio, fin);
                if (dias.length > 0) {
                    countSpanAdmin.textContent = dias.length;
                    infoDivAdmin.style.display = 'block';
                } else {
                    infoDivAdmin.style.display = 'none';
                }
            } else {
                infoDivAdmin.style.display = 'none';
            }
        }
        
        if (inputInicioAdmin && inputFinAdmin) {
            inputInicioAdmin.addEventListener('change', actualizarCalculoDiasAdmin);
            inputFinAdmin.addEventListener('change', actualizarCalculoDiasAdmin);
        }
        
        // Event listener para el formulario de crear vacación
        const formCrearVacacion = document.getElementById('formCrearVacacion');
        if (formCrearVacacion) {
            formCrearVacacion.addEventListener('submit', async function(e) {
                e.preventDefault();
                await guardarSolicitudVacacionAdmin();
            });
        }
        
        async function guardarSolicitudVacacionAdmin() {
            const empleadoUsername = document.getElementById('empleadoVacacionSelect').value;
            const fechaInicio = document.getElementById('fechaInicioVacacionAdmin').value;
            const fechaFin = document.getElementById('fechaFinVacacionAdmin').value;
            const motivo = document.getElementById('motivoVacacionAdmin').value;
            
            if (!empleadoUsername || !fechaInicio || !fechaFin) {
                alert('Por favor complete todos los campos requeridos.');
                return;
            }

            const diasEfectivos = calcularDiasHabiles(fechaInicio, fechaFin);
            
            if (diasEfectivos.length === 0) {
                 alert('El rango de fechas no es válido o no contiene días hábiles.');
                 return;
            }
            
            // Buscar datos del empleado seleccionado
            const empleadoSeleccionado = empleadosData.find(emp => emp.username === empleadoUsername);
            if (!empleadoSeleccionado) {
                alert('Empleado no encontrado.');
                return;
            }
            
            const btnSubmit = document.querySelector('#formCrearVacacion button[type="submit"]');
            const originalText = btnSubmit.innerHTML;
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
            
            try {
                // Convertir fechas a Timestamps
                const fechaInicioTimestamp = Timestamp.fromDate(new Date(fechaInicio + 'T00:00:00'));
                const fechaFinTimestamp = Timestamp.fromDate(new Date(fechaFin + 'T00:00:00'));
                
                // Convertir array de strings de fechas a array de Timestamps
                const diasTimestamps = diasEfectivos.map(fechaStr => {
                    return Timestamp.fromDate(new Date(fechaStr + 'T00:00:00'));
                });
                
                const empleadoId = empleadoSeleccionado.username;
                const empleadoNombre = `${empleadoSeleccionado.primerNombre} ${empleadoSeleccionado.primerApellido}`;
                
                // Obtener usuario que está creando la solicitud (versión secure)
                const user = window.secureAuthManager?.getCurrentUser();
                const creadoPor = user?.id || user?.username || 'admin';
                
                const nuevaSolicitud = {
                    empleadoId: empleadoId,
                    empleadoNombre: empleadoNombre,
                    estado: 'pendiente',
                    fechaInicio: fechaInicioTimestamp,
                    fechaFin: fechaFinTimestamp,
                    fechaSolicitud: serverTimestamp(),
                    fechaHoraSolicitud: new Date().toISOString(),
                    dias: diasTimestamps,
                    totalDias: diasEfectivos.length,
                    creadoPor: creadoPor, // Quien creó la solicitud
                    creadoPorAdmin: true // Flag para indicar que fue creada por admin
                };
                
                // Agregar motivo si existe
                if (motivo && motivo.trim()) {
                    nuevaSolicitud.motivo = motivo.trim();
                }
                
                await addDoc(collection(db, 'vacaciones'), nuevaSolicitud);
                
                // Limpiar formulario
                document.getElementById('formCrearVacacion').reset();
                if (infoDivAdmin) infoDivAdmin.style.display = 'none';
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearVacacion'));
                if (modal) modal.hide();
                
                // Recargar solicitudes pendientes
                if (window.cargarSolicitudesPendientes) {
                    window.cargarSolicitudesPendientes();
                }
                
                // Mostrar mensaje éxito
                alert(`Solicitud de vacaciones creada exitosamente para ${empleadoNombre}`);
                
            } catch (error) {
                console.error("Error al crear solicitud:", error);
                alert('Error al crear la solicitud: ' + error.message);
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
            }
        }

        // Cargar solicitudes pendientes
        async function cargarSolicitudesPendientes() {
            const tabla = document.getElementById('tablaSolicitudesPendientes');
            const badge = document.getElementById('badgePendientesCount');
            if (!tabla) return;
            
            tabla.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>';
            
            // Intentar primero con getDocs para detectar índice faltante
            try {
                const q = query(
                    collection(db, 'vacaciones'),
                    where('estado', '==', 'pendiente'),
                    orderBy('fechaSolicitud', 'desc')
                );
                
                // Probar si la query funciona
                await getDocs(q);
                
                // Si funciona, usar onSnapshot para actualizaciones en tiempo real
                onSnapshot(q, (snapshot) => {
                if (badge) badge.textContent = snapshot.size;
                
                if (snapshot.empty) {
                    tabla.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No hay solicitudes pendientes</td></tr>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const dias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                    const fechaSol = data.fechaSolicitud ? data.fechaSolicitud.toDate().toLocaleDateString() : '';
                    
                    // Formato fechas desde Timestamps
                    const inicio = data.fechaInicio ? data.fechaInicio.toDate().toLocaleDateString() : '';
                    const fin = data.fechaFin ? data.fechaFin.toDate().toLocaleDateString() : '';

                    html += `
                        <tr>
                            <td>
                                <div class="fw-bold">${data.empleadoNombre || data.empleadoId}</div>
                                <div class="small text-muted">${data.empleadoId}</div>
                            </td>
                            <td>${fechaSol}</td>
                            <td>
                                <div>Del ${inicio}</div>
                                <div>Al ${fin}</div>
                            </td>
                            <td><span class="badge bg-info text-dark">${dias} días hábiles</span></td>
                            <td>${data.motivo || '<span class="text-muted">-</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="abrirModalAprobar('${doc.id}')" title="Aprobar"><i class="fas fa-check"></i></button>
                                <button class="btn btn-sm btn-danger me-1" onclick="rechazarSolicitud('${doc.id}')" title="Rechazar"><i class="fas fa-times"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarSolicitud('${doc.id}', '${data.empleadoNombre || data.empleadoId}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tabla.innerHTML = html;
                }, (error) => {
                    console.error('Error en onSnapshot:', error);
                    // Si falla onSnapshot, recargar con getDocs
                    cargarSolicitudesPendientesSinSnapshot();
                });
            } catch (error) {
                console.error('Error cargando solicitudes pendientes:', error);
                // Índice faltante - usar consulta alternativa sin orderBy
                cargarSolicitudesPendientesSinSnapshot();
            }
        }
        
        // Función alternativa para cargar sin orderBy (cuando falta índice)
        async function cargarSolicitudesPendientesSinSnapshot() {
            const tabla = document.getElementById('tablaSolicitudesPendientes');
            const badge = document.getElementById('badgePendientesCount');
            if (!tabla) return;
            
            try {
                // Consulta alternativa sin orderBy
                const qAlt = query(
                    collection(db, 'vacaciones'),
                    where('estado', '==', 'pendiente')
                );
                
                const snapshotAlt = await getDocs(qAlt);
                
                if (badge) badge.textContent = snapshotAlt.size;
                
                if (snapshotAlt.empty) {
                    tabla.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No hay solicitudes pendientes</td></tr>';
                    return;
                }
                
                // Ordenar en cliente por fechaSolicitud
                const docsArray = [];
                snapshotAlt.forEach(doc => {
                    docsArray.push({ id: doc.id, ...doc.data() });
                });
                
                docsArray.sort((a, b) => {
                    const fechaA = a.fechaSolicitud?.toDate?.() || new Date(0);
                    const fechaB = b.fechaSolicitud?.toDate?.() || new Date(0);
                    return fechaB - fechaA; // Descendente
                });
                
                let html = '';
                docsArray.forEach(item => {
                    const data = item;
                    const dias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                    const fechaSol = data.fechaSolicitud ? data.fechaSolicitud.toDate().toLocaleDateString() : '';
                    
                    const inicio = data.fechaInicio ? data.fechaInicio.toDate().toLocaleDateString() : '';
                    const fin = data.fechaFin ? data.fechaFin.toDate().toLocaleDateString() : '';

                    html += `
                        <tr>
                            <td>
                                <div class="fw-bold">${data.empleadoNombre || data.empleadoId}</div>
                                <div class="small text-muted">${data.empleadoId}</div>
                            </td>
                            <td>${fechaSol}</td>
                            <td>
                                <div>Del ${inicio}</div>
                                <div>Al ${fin}</div>
                            </td>
                            <td><span class="badge bg-info text-dark">${dias} días hábiles</span></td>
                            <td>${data.motivo || '<span class="text-muted">-</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="abrirModalAprobar('${item.id}')" title="Aprobar"><i class="fas fa-check"></i></button>
                                <button class="btn btn-sm btn-danger me-1" onclick="rechazarSolicitud('${item.id}')" title="Rechazar"><i class="fas fa-times"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarSolicitud('${item.id}', '${data.empleadoNombre || data.empleadoId}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tabla.innerHTML = html;
                        
            } catch (e2) {
                console.error('Error en consulta alternativa:', e2);
                tabla.innerHTML = `
                    <tr><td colspan="6" class="text-center py-4">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error cargando solicitudes. Por favor, crea el índice requerido en Firestore.
                            <br><br>
                            <a href="https://console.firebase.google.com/project/cursorwebapp-f376d/firestore/indexes" target="_blank" class="btn btn-sm btn-primary">
                                Crear Índice
                            </a>
                        </div>
                    </td></tr>
                `;
            }
        }

        // Abrir modal para aprobar solicitud
        window.abrirModalAprobar = async function(id) {
            document.getElementById('solicitudIdAprobar').value = id;
            document.getElementById('comentarioAprobacion').value = '';
            
            // Cargar información de la solicitud
            try {
                const docRef = doc(db, 'vacaciones', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Función para formatear fechas amigablemente
                    function formatearFechaAmigable(fecha) {
                        if (!fecha) return 'N/A';
                        const fechaObj = fecha.toDate ? fecha.toDate() : new Date(fecha);
                        const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                        const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                        const diaSemana = diasSemana[fechaObj.getDay()];
                        const dia = fechaObj.getDate();
                        const mes = meses[fechaObj.getMonth()];
                        const año = fechaObj.getFullYear();
                        return `${diaSemana}, ${dia} de ${mes} de ${año}`;
                    }
                    
                    // Llenar información
                    const empleadoNombre = data.empleadoNombre || data.empleadoId || 'N/A';
                    const empleadoId = data.empleadoId || 'N/A';
                    const fechaSolicitud = data.fechaSolicitud ? formatearFechaAmigable(data.fechaSolicitud) : 'N/A';
                    const fechaInicio = data.fechaInicio ? formatearFechaAmigable(data.fechaInicio) : 'N/A';
                    const fechaFin = data.fechaFin ? formatearFechaAmigable(data.fechaFin) : 'N/A';
                    const totalDias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                    const motivo = data.motivo || null;
                    
                    document.getElementById('infoEmpleadoAprobar').textContent = empleadoNombre;
                    document.getElementById('infoEmpleadoIdAprobar').textContent = empleadoId;
                    document.getElementById('infoFechaSolicitudAprobar').textContent = fechaSolicitud;
                    document.getElementById('infoTotalDiasAprobar').textContent = `${totalDias} días hábiles`;
                    document.getElementById('infoRangoFechasAprobar').textContent = `Del ${fechaInicio} al ${fechaFin}`;
                    
                    // Mostrar motivo si existe
                    if (motivo) {
                        document.getElementById('infoMotivoAprobar').textContent = motivo;
                        document.getElementById('infoMotivoAprobarContainer').style.display = 'block';
                    } else {
                        document.getElementById('infoMotivoAprobarContainer').style.display = 'none';
                    }
                    
                    // Mostrar lista de días si están disponibles
                    if (data.dias && Array.isArray(data.dias) && data.dias.length > 0) {
                        const listaDias = document.getElementById('listaDiasAprobar');
                        listaDias.innerHTML = '';
                        
                        const diasFormateados = data.dias
                            .map(timestamp => {
                                const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                                return {
                                    fecha: fecha,
                                    formateada: formatearFechaAmigable(timestamp)
                                };
                            })
                            .sort((a, b) => a.fecha - b.fecha);
                        
                        diasFormateados.forEach(dia => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-info text-dark';
                            badge.style.fontSize = '0.85rem';
                            badge.style.padding = '4px 8px';
                            badge.textContent = dia.formateada;
                            listaDias.appendChild(badge);
                        });
                        
                        document.getElementById('infoDiasListaAprobar').style.display = 'block';
                    } else {
                        document.getElementById('infoDiasListaAprobar').style.display = 'none';
                    }
                } else {
                    // Si no se encuentra la solicitud, ocultar información
                    document.getElementById('infoSolicitudAprobar').style.display = 'none';
                }
            } catch (error) {
                console.error('Error cargando información de solicitud:', error);
                // Continuar mostrando el modal aunque falle la carga de info
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalAprobarVacacion'));
            modal.show();
        };

        // Confirmar aprobación desde el modal
        document.getElementById('confirmarAprobacionBtn')?.addEventListener('click', async function() {
            const comentario = document.getElementById('comentarioAprobacion').value.trim();
            const id = document.getElementById('solicitudIdAprobar').value;
            
            if (!comentario) {
                alert('Por favor ingresa un comentario de aprobación.');
                document.getElementById('comentarioAprobacion').focus();
                return;
            }
            
            if (!id) {
                alert('Error: ID de solicitud no encontrado.');
                return;
            }
            
            await aprobarSolicitud(id, comentario);
        });

        // Aprobar Solicitud
        async function aprobarSolicitud(id, comentario) {
            const btn = document.getElementById('confirmarAprobacionBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
            
            try {
                const user = window.secureAuthManager?.currentUser;
                const aprobadoPor = user?.username || user?.email?.split('@')[0] || 'admin';
                
                await updateDoc(doc(db, 'vacaciones', id), {
                    estado: 'aprobada',
                    aprobadoPor: aprobadoPor,
                    comentarioAprobacion: comentario,
                    fechaAprobacion: serverTimestamp()
                });
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAprobarVacacion'));
                if (modal) modal.hide();
                
                // Recargar calendario y solicitudes
                if (window.renderCalendarioVacaciones) window.renderCalendarioVacaciones();
                if (window.cargarSolicitudesPendientes) window.cargarSolicitudesPendientes();
                
                alert('Solicitud aprobada exitosamente.');
            } catch (e) {
                console.error('Error aprobando:', e);
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Eliminar Solicitud
        window.eliminarSolicitud = async function(id, empleadoNombre) {
            if (!confirm(`¿Estás seguro de eliminar la solicitud de vacaciones de ${empleadoNombre}?\n\nEsta acción no se puede deshacer.`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'vacaciones', id));
                alert('Solicitud eliminada exitosamente.');
                // Recargar solicitudes
                if (window.cargarSolicitudesPendientes) window.cargarSolicitudesPendientes();
                if (window.cargarSolicitudesAprobadas) window.cargarSolicitudesAprobadas();
                if (window.cargarSolicitudesRechazadas) window.cargarSolicitudesRechazadas();
                if (window.renderCalendarioVacaciones) window.renderCalendarioVacaciones();
            } catch (e) {
                console.error('Error eliminando:', e);
                alert('Error al eliminar: ' + e.message);
            }
        };

        // Cargar Solicitudes Aprobadas
        window.cargarSolicitudesAprobadas = async function() {
            const tabla = document.getElementById('tablaSolicitudesAprobadas');
            const badge = document.getElementById('badgeAprobadasCount');
            if (!tabla) return;
            
            try {
                const q = query(
                    collection(db, 'vacaciones'),
                    where('estado', '==', 'aprobada'),
                    orderBy('fechaAprobacion', 'desc')
                );
                
                const snapshot = await getDocs(q);
                if (badge) badge.textContent = snapshot.size;
                
                if (snapshot.empty) {
                    tabla.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No hay solicitudes aprobadas</td></tr>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const dias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                    const fechaSol = data.fechaSolicitud ? data.fechaSolicitud.toDate().toLocaleDateString() : '';
                    const inicio = data.fechaInicio ? data.fechaInicio.toDate().toLocaleDateString() : '';
                    const fin = data.fechaFin ? data.fechaFin.toDate().toLocaleDateString() : '';
                    const aprobadoPor = data.aprobadoPor || 'N/A';
                    const comentario = data.comentarioAprobacion || '<span class="text-muted">-</span>';
                    const fechaAprobacion = data.fechaAprobacion ? data.fechaAprobacion.toDate().toLocaleDateString() : '';
                    
                    html += `
                        <tr>
                            <td>
                                <div class="fw-bold">${data.empleadoNombre || data.empleadoId}</div>
                                <div class="small text-muted">${data.empleadoId}</div>
                            </td>
                            <td>${fechaSol}</td>
                            <td>
                                <div>Del ${inicio}</div>
                                <div>Al ${fin}</div>
                            </td>
                            <td><span class="badge bg-info text-dark">${dias} días hábiles</span></td>
                            <td>${data.motivo || '<span class="text-muted">-</span>'}</td>
                            <td>
                                <div class="small">${aprobadoPor}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">${fechaAprobacion}</div>
                            </td>
                            <td><small>${comentario}</small></td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="generarPDFConfirmacion('${doc.id}')" title="Generar PDF"><i class="fas fa-file-pdf"></i></button>
                                <button class="btn btn-sm btn-warning me-1" onclick="cambiarEstadoSolicitud('${doc.id}', 'pendiente', '${data.empleadoNombre || data.empleadoId}')" title="Cambiar a Pendiente"><i class="fas fa-undo"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="cambiarEstadoSolicitud('${doc.id}', 'rechazada', '${data.empleadoNombre || data.empleadoId}')" title="Rechazar"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tabla.innerHTML = html;
            } catch (e) {
                console.error('Error cargando aprobadas:', e);
                // Intentar sin orderBy si falla
                try {
                    const qAlt = query(
                        collection(db, 'vacaciones'),
                        where('estado', '==', 'aprobada')
                    );
                    const snapshotAlt = await getDocs(qAlt);
                    if (badge) badge.textContent = snapshotAlt.size;
                    
                    if (snapshotAlt.empty) {
                        tabla.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No hay solicitudes aprobadas</td></tr>';
                        return;
                    }
                    
                    const docsArray = [];
                    snapshotAlt.forEach(doc => {
                        docsArray.push({ id: doc.id, ...doc.data() });
                    });
                    
                    docsArray.sort((a, b) => {
                        const fechaA = a.fechaAprobacion?.toDate?.() || new Date(0);
                        const fechaB = b.fechaAprobacion?.toDate?.() || new Date(0);
                        return fechaB - fechaA;
                    });
                    
                    let html = '';
                    docsArray.forEach(item => {
                        const data = item;
                        const dias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                        const fechaSol = data.fechaSolicitud ? data.fechaSolicitud.toDate().toLocaleDateString() : '';
                        const inicio = data.fechaInicio ? data.fechaInicio.toDate().toLocaleDateString() : '';
                        const fin = data.fechaFin ? data.fechaFin.toDate().toLocaleDateString() : '';
                        const aprobadoPor = data.aprobadoPor || 'N/A';
                        const comentario = data.comentarioAprobacion || '<span class="text-muted">-</span>';
                        const fechaAprobacion = data.fechaAprobacion ? data.fechaAprobacion.toDate().toLocaleDateString() : '';
                        
                        html += `
                            <tr>
                                <td>
                                    <div class="fw-bold">${data.empleadoNombre || data.empleadoId}</div>
                                    <div class="small text-muted">${data.empleadoId}</div>
                                </td>
                                <td>${fechaSol}</td>
                                <td>
                                    <div>Del ${inicio}</div>
                                    <div>Al ${fin}</div>
                                </td>
                                <td><span class="badge bg-info text-dark">${dias} días hábiles</span></td>
                                <td>${data.motivo || '<span class="text-muted">-</span>'}</td>
                                <td>
                                    <div class="small">${aprobadoPor}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">${fechaAprobacion}</div>
                                </td>
                                <td><small>${comentario}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1" onclick="generarPDFConfirmacion('${item.id}')" title="Generar PDF"><i class="fas fa-file-pdf"></i></button>
                                    <button class="btn btn-sm btn-warning me-1" onclick="cambiarEstadoSolicitud('${item.id}', 'pendiente', '${data.empleadoNombre || data.empleadoId}')" title="Cambiar a Pendiente"><i class="fas fa-undo"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="cambiarEstadoSolicitud('${item.id}', 'rechazada', '${data.empleadoNombre || data.empleadoId}')" title="Rechazar"><i class="fas fa-times"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    tabla.innerHTML = html;
                } catch (e2) {
                    tabla.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-danger">Error: ${e2.message}</td></tr>`;
                }
            }
        };

        // Cargar Solicitudes Rechazadas
        window.cargarSolicitudesRechazadas = async function() {
            const tabla = document.getElementById('tablaSolicitudesRechazadas');
            const badge = document.getElementById('badgeRechazadasCount');
            if (!tabla) return;
            
            try {
                const q = query(
                    collection(db, 'vacaciones'),
                    where('estado', '==', 'rechazada'),
                    orderBy('fechaRechazo', 'desc')
                );
                
                const snapshot = await getDocs(q);
                if (badge) badge.textContent = snapshot.size;
                
                if (snapshot.empty) {
                    tabla.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No hay solicitudes rechazadas</td></tr>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const dias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                    const fechaSol = data.fechaSolicitud ? data.fechaSolicitud.toDate().toLocaleDateString() : '';
                    const inicio = data.fechaInicio ? data.fechaInicio.toDate().toLocaleDateString() : '';
                    const fin = data.fechaFin ? data.fechaFin.toDate().toLocaleDateString() : '';
                    const rechazadoPor = data.rechazadoPor || 'N/A';
                    const motivoRechazo = data.motivoRechazo || '<span class="text-muted">-</span>';
                    const fechaRechazo = data.fechaRechazo ? data.fechaRechazo.toDate().toLocaleDateString() : '';
                    
                    html += `
                        <tr>
                            <td>
                                <div class="fw-bold">${data.empleadoNombre || data.empleadoId}</div>
                                <div class="small text-muted">${data.empleadoId}</div>
                            </td>
                            <td>${fechaSol}</td>
                            <td>
                                <div>Del ${inicio}</div>
                                <div>Al ${fin}</div>
                            </td>
                            <td><span class="badge bg-info text-dark">${dias} días hábiles</span></td>
                            <td>${data.motivo || '<span class="text-muted">-</span>'}</td>
                            <td>
                                <div class="small">${rechazadoPor}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">${fechaRechazo}</div>
                            </td>
                            <td><small>${motivoRechazo}</small></td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="cambiarEstadoSolicitud('${doc.id}', 'aprobada', '${data.empleadoNombre || data.empleadoId}')" title="Aprobar"><i class="fas fa-check"></i></button>
                                <button class="btn btn-sm btn-warning me-1" onclick="cambiarEstadoSolicitud('${doc.id}', 'pendiente', '${data.empleadoNombre || data.empleadoId}')" title="Cambiar a Pendiente"><i class="fas fa-undo"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tabla.innerHTML = html;
            } catch (e) {
                console.error('Error cargando rechazadas:', e);
                // Intentar sin orderBy si falla
                try {
                    const qAlt = query(
                        collection(db, 'vacaciones'),
                        where('estado', '==', 'rechazada')
                    );
                    const snapshotAlt = await getDocs(qAlt);
                    if (badge) badge.textContent = snapshotAlt.size;
                    
                    if (snapshotAlt.empty) {
                        tabla.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No hay solicitudes rechazadas</td></tr>';
                        return;
                    }
                    
                    const docsArray = [];
                    snapshotAlt.forEach(doc => {
                        docsArray.push({ id: doc.id, ...doc.data() });
                    });
                    
                    docsArray.sort((a, b) => {
                        const fechaA = a.fechaRechazo?.toDate?.() || new Date(0);
                        const fechaB = b.fechaRechazo?.toDate?.() || new Date(0);
                        return fechaB - fechaA;
                    });
                    
                    let html = '';
                    docsArray.forEach(item => {
                        const data = item;
                        const dias = data.totalDias || (data.dias ? data.dias.length : 'N/A');
                        const fechaSol = data.fechaSolicitud ? data.fechaSolicitud.toDate().toLocaleDateString() : '';
                        const inicio = data.fechaInicio ? data.fechaInicio.toDate().toLocaleDateString() : '';
                        const fin = data.fechaFin ? data.fechaFin.toDate().toLocaleDateString() : '';
                        const rechazadoPor = data.rechazadoPor || 'N/A';
                        const motivoRechazo = data.motivoRechazo || '<span class="text-muted">-</span>';
                        const fechaRechazo = data.fechaRechazo ? data.fechaRechazo.toDate().toLocaleDateString() : '';
                        
                        html += `
                            <tr>
                                <td>
                                    <div class="fw-bold">${data.empleadoNombre || data.empleadoId}</div>
                                    <div class="small text-muted">${data.empleadoId}</div>
                                </td>
                                <td>${fechaSol}</td>
                                <td>
                                    <div>Del ${inicio}</div>
                                    <div>Al ${fin}</div>
                                </td>
                                <td><span class="badge bg-info text-dark">${dias} días hábiles</span></td>
                                <td>${data.motivo || '<span class="text-muted">-</span>'}</td>
                                <td>
                                    <div class="small">${rechazadoPor}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">${fechaRechazo}</div>
                                </td>
                                <td><small>${motivoRechazo}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-success me-1" onclick="cambiarEstadoSolicitud('${item.id}', 'aprobada', '${data.empleadoNombre || data.empleadoId}')" title="Aprobar"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-sm btn-warning me-1" onclick="cambiarEstadoSolicitud('${item.id}', 'pendiente', '${data.empleadoNombre || data.empleadoId}')" title="Cambiar a Pendiente"><i class="fas fa-undo"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    tabla.innerHTML = html;
                } catch (e2) {
                    tabla.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-danger">Error: ${e2.message}</td></tr>`;
                }
            }
        };

        // Cambiar Estado de Solicitud
        window.cambiarEstadoSolicitud = async function(id, nuevoEstado, empleadoNombre) {
            let confirmacion = '';
            if (nuevoEstado === 'pendiente') {
                confirmacion = `¿Cambiar el estado de la solicitud de ${empleadoNombre} a Pendiente?`;
            } else if (nuevoEstado === 'aprobada') {
                // Si va a aprobar, usar el modal de aprobación
                abrirModalAprobar(id);
                return;
            } else if (nuevoEstado === 'rechazada') {
                const motivo = prompt('Motivo del rechazo:');
                if (!motivo || !motivo.trim()) return;
                
                try {
                    const user = window.secureAuthManager?.currentUser;
                    const rechazadoPor = user?.username || user?.email?.split('@')[0] || 'admin';
                    
                    await updateDoc(doc(db, 'vacaciones', id), {
                        estado: 'rechazada',
                        rechazadoPor: rechazadoPor,
                        motivoRechazo: motivo.trim(),
                        fechaRechazo: serverTimestamp()
                    });
                    
                    alert('Solicitud rechazada exitosamente.');
                    if (window.cargarSolicitudesAprobadas) window.cargarSolicitudesAprobadas();
                    if (window.cargarSolicitudesRechazadas) window.cargarSolicitudesRechazadas();
                    if (window.cargarSolicitudesPendientes) window.cargarSolicitudesPendientes();
                    if (window.renderCalendarioVacaciones) window.renderCalendarioVacaciones();
                    return;
                } catch (e) {
                    console.error('Error rechazando:', e);
                    alert('Error: ' + e.message);
                    return;
                }
            }
            
            if (!confirm(confirmacion)) return;
            
            try {
                const user = window.secureAuthManager?.currentUser;
                const actualizadoPor = user?.username || user?.email?.split('@')[0] || 'admin';
                
                const updateData = {
                    estado: nuevoEstado,
                    actualizadoPor: actualizadoPor,
                    fechaActualizacion: serverTimestamp()
                };
                
                if (nuevoEstado === 'pendiente') {
                    // Limpiar campos de aprobación/rechazo
                    updateData.aprobadoPor = null;
                    updateData.comentarioAprobacion = null;
                    updateData.fechaAprobacion = null;
                    updateData.rechazadoPor = null;
                    updateData.motivoRechazo = null;
                    updateData.fechaRechazo = null;
                }
                
                await updateDoc(doc(db, 'vacaciones', id), updateData);
                
                alert(`Estado actualizado exitosamente a ${nuevoEstado}.`);
                if (window.cargarSolicitudesAprobadas) window.cargarSolicitudesAprobadas();
                if (window.cargarSolicitudesRechazadas) window.cargarSolicitudesRechazadas();
                if (window.cargarSolicitudesPendientes) window.cargarSolicitudesPendientes();
                if (window.renderCalendarioVacaciones) window.renderCalendarioVacaciones();
            } catch (e) {
                console.error('Error cambiando estado:', e);
                alert('Error: ' + e.message);
            }
        };

        // Generar PDF de Confirmación
        window.generarPDFConfirmacion = async function(id) {
            try {
                const docRef = doc(db, 'vacaciones', id);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('Solicitud no encontrada.');
                    return;
                }
                
                const solicitudData = { id: docSnap.id, ...docSnap.data() };
                
                if (solicitudData.estado !== 'aprobada') {
                    alert('Solo se pueden generar PDFs para solicitudes aprobadas.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Configuración
                const margin = 20;
                let y = margin;
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (margin * 2);
                
                // Colores
                const primaryColor = [40, 167, 69]; // Verde
                const textColor = [33, 37, 41];
                
                // Encabezado
                pdf.setFillColor(...primaryColor);
                pdf.rect(0, 0, pageWidth, 50, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(24);
                pdf.setFont(undefined, 'bold');
                pdf.text('CONFIRMACIÓN DE VACACIONES', pageWidth / 2, 25, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text('Ecofumigadora Hermanos Paniagua SRL', pageWidth / 2, 35, { align: 'center' });
                
                y = 70;
                pdf.setTextColor(...textColor);
                
                // Función para formatear fechas de manera amigable
                function formatearFechaAmigable(fecha) {
                    if (!fecha) return 'N/A';
                    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    const fechaObj = fecha.toDate ? fecha.toDate() : new Date(fecha);
                    const diaSemana = diasSemana[fechaObj.getDay()];
                    const dia = fechaObj.getDate();
                    const mes = meses[fechaObj.getMonth()];
                    const año = fechaObj.getFullYear();
                    return `${diaSemana}, ${dia} de ${mes} de ${año}`;
                }
                
                // Información de la solicitud
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Información de la Solicitud', margin, y);
                y += 10;
                
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'normal');
                
                const empleadoNombre = solicitudData.empleadoNombre || solicitudData.empleadoId || 'N/A';
                const empleadoId = solicitudData.empleadoId || 'N/A';
                const fechaInicioObj = solicitudData.fechaInicio ? solicitudData.fechaInicio.toDate() : null;
                const fechaFinObj = solicitudData.fechaFin ? solicitudData.fechaFin.toDate() : null;
                const fechaInicio = fechaInicioObj ? formatearFechaAmigable(solicitudData.fechaInicio) : 'N/A';
                const fechaFin = fechaFinObj ? formatearFechaAmigable(solicitudData.fechaFin) : 'N/A';
                const totalDias = solicitudData.totalDias || (solicitudData.dias ? solicitudData.dias.length : 'N/A');
                const motivo = solicitudData.motivo || 'No especificado';
                const fechaSolicitudObj = solicitudData.fechaSolicitud ? solicitudData.fechaSolicitud.toDate() : null;
                const fechaSolicitud = fechaSolicitudObj ? formatearFechaAmigable(solicitudData.fechaSolicitud) : 'N/A';
                
                pdf.text(`Empleado: ${empleadoNombre}`, margin, y);
                y += 7;
                pdf.text(`ID: ${empleadoId}`, margin, y);
                y += 7;
                pdf.text(`Fecha de Solicitud: ${fechaSolicitud}`, margin, y);
                y += 7;
                pdf.text(`Período de Vacaciones: Del ${fechaInicio} al ${fechaFin}`, margin, y);
                y += 7;
                pdf.text(`Total de Días Hábiles: ${totalDias} días`, margin, y);
                y += 7;
                pdf.text(`Motivo: ${motivo}`, margin, y);
                y += 10;
                
                // Lista de días específicos solicitados
                if (solicitudData.dias && Array.isArray(solicitudData.dias) && solicitudData.dias.length > 0) {
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Días Solicitados:', margin, y);
                    y += 8;
                    
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    
                    // Ordenar días y formatearlos
                    const diasFormateados = solicitudData.dias
                        .map(timestamp => {
                            const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                            return {
                                fecha: fecha,
                                formateada: formatearFechaAmigable(timestamp)
                            };
                        })
                        .sort((a, b) => a.fecha - b.fecha);
                    
                    // Mostrar días en columnas si hay muchos
                    const maxDiasPorColumna = 12;
                    const columnas = Math.ceil(diasFormateados.length / maxDiasPorColumna);
                    const anchoColumna = columnas > 1 ? (contentWidth - 10) / columnas : contentWidth;
                    const espaciadoEntreColumnas = columnas > 1 ? 5 : 0;
                    
                    let columnaActual = 0;
                    let yInicialColumna = y;
                    let diasEnColumnaActual = 0;
                    
                    diasFormateados.forEach((dia, index) => {
                        if (diasEnColumnaActual >= maxDiasPorColumna && columnas > 1) {
                            columnaActual++;
                            diasEnColumnaActual = 0;
                            y = yInicialColumna;
                        }
                        
                        const xPos = margin + (columnaActual * (anchoColumna + espaciadoEntreColumnas));
                        pdf.text(`• ${dia.formateada}`, xPos, y);
                        y += 5;
                        diasEnColumnaActual++;
                        
                        // Verificar si necesita nueva página
                        if (y > pageHeight - 40) {
                            pdf.addPage();
                            y = margin + 10;
                            yInicialColumna = y;
                        }
                    });
                    
                    y += 5;
                }
                
                y += 10;
                
                // Información de aprobación
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Información de Aprobación', margin, y);
                y += 10;
                
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'normal');
                
                const aprobadoPor = solicitudData.aprobadoPor || 'N/A';
                const fechaAprobacionObj = solicitudData.fechaAprobacion ? solicitudData.fechaAprobacion.toDate() : null;
                const fechaAprobacion = fechaAprobacionObj ? formatearFechaAmigable(solicitudData.fechaAprobacion) : 'N/A';
                const comentario = solicitudData.comentarioAprobacion || 'No especificado';
                
                pdf.text(`Aprobado por: ${aprobadoPor}`, margin, y);
                y += 7;
                pdf.text(`Fecha de Aprobación: ${fechaAprobacion}`, margin, y);
                y += 7;
                
                // Comentario (puede ser largo, dividir en líneas)
                pdf.text('Comentario:', margin, y);
                y += 5;
                const comentarioLines = pdf.splitTextToSize(comentario, contentWidth);
                pdf.text(comentarioLines, margin, y);
                y += comentarioLines.length * 5 + 10;
                
                // Estado
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.setFillColor(...primaryColor);
                pdf.setTextColor(255, 255, 255);
                pdf.rect(margin, y, contentWidth, 15, 'F');
                pdf.text('ESTADO: APROBADA', pageWidth / 2, y + 10, { align: 'center' });
                y += 25;
                
                // Pie de página
                pdf.setTextColor(...textColor);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const fechaGeneracion = new Date().toLocaleDateString('es-ES') + ' ' + new Date().toLocaleTimeString('es-ES');
                pdf.text(`Documento generado el ${fechaGeneracion}`, pageWidth / 2, pageHeight - 15, { align: 'center' });
                
                // Guardar PDF
                const fechaInicioParaArchivo = fechaInicioObj ? fechaInicioObj.toISOString().split('T')[0] : 'fecha';
                const nombreArchivo = `Confirmacion_Vacaciones_${empleadoId}_${fechaInicioParaArchivo}.pdf`;
                pdf.save(nombreArchivo);
                
                alert('PDF de confirmación generado exitosamente.');
            } catch (e) {
                console.error('Error generando PDF:', e);
                alert('Error al generar PDF: ' + e.message);
            }
        };
        
        // Cargar aprobadas y rechazadas cuando se cambia de tab
        document.getElementById('aprobadas-tab')?.addEventListener('shown.bs.tab', function() {
            if (window.cargarSolicitudesAprobadas) window.cargarSolicitudesAprobadas();
        });
        
        document.getElementById('rechazadas-tab')?.addEventListener('shown.bs.tab', function() {
            if (window.cargarSolicitudesRechazadas) window.cargarSolicitudesRechazadas();
        });

        // Rechazar Solicitud
        window.rechazarSolicitud = async function(id) {
            const motivo = prompt('Motivo del rechazo:');
            if (motivo === null) return;
            
            try {
                const user = window.secureAuthManager?.currentUser;
                const rechazadoPor = user?.username || user?.email?.split('@')[0] || 'admin';
                
                await updateDoc(doc(db, 'vacaciones', id), {
                    estado: 'rechazada',
                    rechazadoPor: rechazadoPor,
                    motivoRechazo: motivo,
                    fechaRechazo: serverTimestamp()
                });
            } catch (e) {
                console.error('Error rechazando:', e);
                alert('Error: ' + e.message);
            }
        };

        // Lista de feriados (año-mes-día)
        const FERIADOS = [
            '2025-01-01', '2025-04-11', '2025-04-17', '2025-04-18', '2025-05-01',
            '2025-07-25', '2025-08-02', '2025-08-15', '2025-08-31', '2025-09-15',
            '2025-12-01', '2025-12-25',
            '2026-01-01', '2026-04-02', '2026-04-03', '2026-04-11', '2026-05-01',
            '2026-07-25', '2026-08-02', '2026-08-15', '2026-08-31', '2026-09-15',
            '2026-12-01', '2026-12-25'
        ];
        
        // Función para verificar si una fecha es feriado
        function esFeriado(fechaStr) {
            return FERIADOS.includes(fechaStr);
        }

        // Renderizar Calendario de Vacaciones
        async function renderCalendarioVacaciones() {
            const grid = document.getElementById('gridCalendarioVacaciones');
            const titulo = document.getElementById('tituloMesVacaciones');
            if (!grid || !titulo) return;
            
            // Actualizar título
            titulo.textContent = mesVacacionesActual.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            titulo.style.textTransform = 'capitalize';
            
            // Limpiar grid
            grid.innerHTML = '';
            
            // Días semana headers
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            diasSemana.forEach(d => {
                const el = document.createElement('div');
                el.className = 'calendar-header-day';
                el.textContent = d;
                grid.appendChild(el);
            });
            
            // Obtener días del mes
            const year = mesVacacionesActual.getFullYear();
            const month = mesVacacionesActual.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Relleno inicial
            for (let i = 0; i < firstDay.getDay(); i++) {
                const el = document.createElement('div');
                el.className = 'calendar-day other-month';
                grid.appendChild(el);
            }
            
            // Consultar vacaciones aprobadas
            const q = query(
                collection(db, 'vacaciones'),
                where('estado', '==', 'aprobada')
            );
            
            let snapshot;
            try {
                snapshot = await getDocs(q);
            } catch (e) {
                console.error("Error cargando calendario:", e);
                return;
            }
            
            const vacacionesMes = [];
            // Obtener rango del mes en timestamps para comparación
            const startMonth = new Date(year, month, 1);
            const endMonth = new Date(year, month + 1, 0, 23, 59, 59);
            
            snapshot.forEach(doc => {
                const data = doc.data();
                // Verificar si hay overlap entre el rango de vacaciones y el mes actual
                const fechaInicio = data.fechaInicio?.toDate ? data.fechaInicio.toDate() : null;
                const fechaFin = data.fechaFin?.toDate ? data.fechaFin.toDate() : null;
                
                if (fechaInicio && fechaFin) {
                    // Hay overlap si la fecha de inicio es antes del fin del mes y la fecha fin es después del inicio del mes
                    if (fechaInicio <= endMonth && fechaFin >= startMonth) {
                        vacacionesMes.push(data);
                    }
                }
            });
            
            // Días del mes
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                const currentDateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                cell.innerHTML = `<span class="calendar-date-number">${day}</span>`;
                
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'calendar-events';
                
                // No mostrar vacaciones en domingos ni feriados
                const esDomingo = currentDate.getDay() === 0;
                const esFeriadoFecha = esFeriado(currentDateStr);
                
                if (!esDomingo && !esFeriadoFecha) {
                    // Buscar vacaciones en este día
                    vacacionesMes.forEach(vac => {
                        let isVacationDay = false;
                        if (vac.dias && Array.isArray(vac.dias)) {
                            // Comparar con array de Timestamps
                            isVacationDay = vac.dias.some(timestamp => {
                                const fechaVac = timestamp.toDate ? timestamp.toDate() : null;
                                if (!fechaVac) return false;
                                return fechaVac.toISOString().split('T')[0] === currentDateStr;
                            });
                        } else {
                            // Fallback: comparar con rango de fechas (pero excluir domingos y feriados)
                            const fechaInicio = vac.fechaInicio?.toDate ? vac.fechaInicio.toDate() : null;
                            const fechaFin = vac.fechaFin?.toDate ? vac.fechaFin.toDate() : null;
                            if (fechaInicio && fechaFin) {
                                isVacationDay = currentDate >= fechaInicio && currentDate <= fechaFin;
                            }
                        }
                        
                        if (isVacationDay) {
                            const eventDiv = document.createElement('div');
                            eventDiv.className = 'calendar-event approved';
                            eventDiv.textContent = vac.empleadoNombre || vac.empleadoId;
                            eventDiv.title = `${vac.empleadoNombre || vac.empleadoId}: ${vac.motivo || 'Vacaciones'}`;
                            eventsContainer.appendChild(eventDiv);
                        }
                    });
                }
                
                cell.appendChild(eventsContainer);
                grid.appendChild(cell);
            }
        }
    </script>

    <!-- Modal de Edición de Turno -->
    <div class="modal fade" id="editTurnoModal" tabindex="-1" aria-labelledby="editTurnoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTurnoModalLabel">
                        <i class="fas fa-edit"></i> Editar Turno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTurnoForm">
                        <input type="hidden" id="editTurnoId" name="turnoId">
                        
                        <!-- Fecha y Hora de Inicio -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editStartDate" class="form-label">Fecha de Inicio</label>
                                <input type="date" class="form-control" id="editStartDate" name="startDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editStartTime" class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" id="editStartTime" name="startTime" required>
                            </div>
                        </div>
                        
                        <!-- Fecha y Hora de Fin -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEndDate" class="form-label">Fecha de Fin</label>
                                <input type="date" class="form-control" id="editEndDate" name="endDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEndTime" class="form-label">Hora de Fin</label>
                                <input type="time" class="form-control" id="editEndTime" name="endTime" required>
                            </div>
                        </div>
                        
                        <!-- Notas -->
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notas (opcional)</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                        </div>
                        
                        <!-- Información sobre turnos que cruzan medianoche -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Turnos que cruzan medianoche:</strong> Si el turno termina al día siguiente, 
                            selecciona la fecha correcta de fin. El sistema validará automáticamente que la hora de fin 
                            sea posterior a la de inicio considerando las fechas.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="saveTurnoBtn">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Forzar Cierre de Turno -->
    <div class="modal fade" id="forceCloseModal" tabindex="-1" aria-labelledby="forceCloseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="forceCloseModalLabel">
                        <i class="fas fa-stop-circle"></i> Forzar Cierre de Turno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Empleado:</strong> <span id="forceCloseEmployeeName"></span>
                    </div>
                    
                    <form id="forceCloseForm">
                        <input type="hidden" id="forceCloseUsername" name="username">
                        <input type="hidden" id="forceCloseSessionId" name="sessionId">
                        
                        <div class="mb-3">
                            <label for="forceCloseEndTime" class="form-label">
                                <i class="fas fa-clock me-1"></i> Hora de Cierre
                            </label>
                            <input type="datetime-local" class="form-control" id="forceCloseEndTime" name="endTime" required>
                            <div class="form-text">Selecciona la fecha y hora exacta de cierre del turno</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="forceCloseReason" class="form-label">
                                <i class="fas fa-comment me-1"></i> Motivo del Cierre Forzado
                            </label>
                            <select class="form-select" id="forceCloseReason" name="reason" required>
                                <option value="">Selecciona un motivo</option>
                                <option value="forgot_to_close">Empleado olvidó cerrar el turno</option>
                                <option value="technical_issue">Problema técnico con la aplicación</option>
                                <option value="emergency">Emergencia o situación imprevista</option>
                                <option value="administrative">Decisión administrativa</option>
                                <option value="other">Otro motivo</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="forceCloseNotes" class="form-label">
                                <i class="fas fa-sticky-note me-1"></i> Notas Adicionales
                            </label>
                            <textarea class="form-control" id="forceCloseNotes" name="notes" rows="3" 
                                      placeholder="Describe brevemente el motivo del cierre forzado..."></textarea>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Importante:</strong> Esta acción registrará la hora seleccionada como hora de finalización del turno. 
                            Asegúrate de que la hora sea correcta antes de confirmar.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmForceCloseBtn">
                        <i class="fas fa-stop-circle me-1"></i> Confirmar Cierre
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Hora de Inicio -->
    <div class="modal fade" id="modalEditarHoraInicio" tabindex="-1" aria-labelledby="modalEditarHoraInicioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalEditarHoraInicioLabel">
                        <i class="fas fa-edit me-2"></i>Editar Hora de Inicio
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarHoraInicio">
                        <div class="mb-3">
                            <label for="editStartTimeNew" class="form-label">
                                <i class="fas fa-clock me-1"></i> Nueva Hora de Inicio
                            </label>
                            <input type="datetime-local" class="form-control" id="editStartTimeNew" name="startTime" required>
                            <div class="form-text">Selecciona la nueva hora de inicio del turno</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editStartTimeNotes" class="form-label">
                                <i class="fas fa-sticky-note me-1"></i> Notas (opcional)
                            </label>
                            <textarea class="form-control" id="editStartTimeNotes" name="notes" rows="3" 
                                      placeholder="Describe el motivo del cambio de hora de inicio..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Información:</strong> Esta acción actualizará la hora de inicio del turno activo. 
                            El tiempo transcurrido se recalculará automáticamente.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="saveStartTimeChangeBtn">
                        <i class="fas fa-save me-1"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>
</body>
</html>
