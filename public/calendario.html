en https://ecoplagas.online/calendario.html<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Servicios Seguro - Eco Plagas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="eco-plagas-styles.css" rel="stylesheet">
    <link href="unified-styles.css?v=1.0" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha384-JcnsjUPPylna1s1fvi1u12X5qjY5OL56iySh75FdtrwhO/SWXgMjoVqcKyIIWOLk" crossorigin="anonymous"></script>
    <script src="check-permissions.js"></script>
    <script type="module" src="csrf-token.js"></script>
    <!-- Sistema de Autenticaci√≥n Seguro -->
    <script type="module">
        import { auth } from './auth-secure.js';
        
        // Guardar auth en window para uso global
        window.firebaseAuth = auth;
        
        // VERIFICACI√ìN INMEDIATA DE AUTENTICACI√ìN - Redirigir antes de cargar contenido
        (async function() {
            // Prevenir m√∫ltiples ejecuciones
            if (window.authCheckInProgress) {
                return;
            }
            window.authCheckInProgress = true;
            
            // Ocultar body inmediatamente
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Esperar a que auth-secure.js se cargue completamente
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verificar si ya estamos en iniciar_sesion.html (evitar loop)
            if (window.location.pathname.includes('iniciar_sesion.html')) {
                window.authCheckInProgress = false;
                return;
            }
            
            // Verificar autenticaci√≥n de manera simple
            let retries = 0;
            const maxRetries = 100; // 10 segundos
            
            while (retries < maxRetries) {
                // Verificar Firebase Auth directamente
                if (auth.currentUser) {
                    if (window.safeLogger) {
                        window.safeLogger.success('‚úÖ [CALENDARIO_SECURE] Usuario autenticado');
                    } else {
                        console.log('‚úÖ [CALENDARIO_SECURE] Usuario autenticado');
                    }
                    
                    // Esperar a secureAuthManager
                    if (window.secureAuthManager) {
                        window.authManager = window.secureAuthManager;
                    } else {
                        // Esperar un poco m√°s
                        await new Promise(resolve => setTimeout(resolve, 300));
                        if (window.secureAuthManager) {
                            window.authManager = window.secureAuthManager;
                        }
                    }
                    
                    // Mostrar body
                    if (document.body) {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                    
                    window.authCheckInProgress = false;
                    return; // Usuario autenticado, continuar
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            // Si llegamos aqu√≠, no hay autenticaci√≥n
            console.log('‚ùå [CALENDARIO_SECURE] No autenticado despu√©s de esperar');
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Solo redirigir si no estamos ya en loginsecure
            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                try {
                    sessionStorage.setItem('postLoginRedirect', window.location.href);
                } catch (e) { console.error('Error saving redirect:', e); }
                window.location.replace('iniciar_sesion.html');
            }
            
            window.authCheckInProgress = false;
        })();
    </script>
    <style>
        /* Ocultar contenido hasta verificar autenticaci√≥n */
        body {
            display: none !important;
        }
        body.authenticated {
            display: block !important;
        }
        /* Estilos espec√≠ficos del calendario - sin header */
        .controls-section {
            background: var(--light-color);
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .calendar-container {
            padding: 30px;
            background: white;
        }

        .menu-hamburguesa {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            min-width: 220px;
            z-index: 1000;
            margin-top: 8px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: var(--light-gradient);
            border-radius: 15px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-calendar {
            background: var(--primary-gradient);
            color: var(--eco-black);
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: var(--primary-gradient);
            color: var(--eco-black);
            padding: 15px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #f8f9fa;
            position: relative;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--eco-black);
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #ccc;
        }

        .drag-preview {
            background: rgba(102, 126, 234, 0.3) !important;
            border: 2px dashed #667eea !important;
            border-radius: 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cita-item {
            background: var(--primary-gradient);
            color: var(--eco-black);
            padding: 4px 8px;
            border-radius: 8px;
            border: 2px solid;
            font-size: 0.75rem;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cita-item:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .cita-item.Ruta-1 { background: #A5D6A7; border-color: #66BB6A; color: #000; font-weight: 600; }
        .cita-item.Ruta-2 { background: #CE93D8; border-color: #BA68C8; color: #000; font-weight: 600; }
        .cita-item.Ruta-3 { background: #FFF59D; border-color: #FFD54F; color: #000; font-weight: 600; }
        .cita-item.Ruta-4 { background: #FFCC80; border-color: #FFB74D; color: #000; font-weight: 600; }
        .cita-item.Ruta-5 { background: #90CAF9; border-color: #64B5F6; color: #000; font-weight: 600; }
        .cita-item.Ruta-6 { background: #F48FB1; border-color: #F06292; color: #000; font-weight: 600; }
        .cita-item.Ruta-7 { background: #B0BEC5; border-color: #78909C; color: #000; font-weight: 600; }
        .cita-item.Ruta-8 { background: #90CAF9; border-color: #64B5F6; color: #000; font-weight: 600; }
        .cita-item.Ruta-9 { background: #A5D6A7; border-color: #66BB6A; color: #000; font-weight: 600; }
        .cita-item.Ruta-10 { background: #CE93D8; border-color: #BA68C8; color: #000; font-weight: 600; }
        .cita-item.Ruta-11 { background: #FFF59D; border-color: #FFD54F; color: #000; font-weight: 600; }
        .cita-item.Ruta-12 { background: #FFCC80; border-color: #FFB74D; color: #000; font-weight: 600; }
        .cita-item.Ruta-13 { background: #90CAF9; border-color: #64B5F6; color: #000; font-weight: 600; }
        .cita-item.Ruta-14 { background: #F48FB1; border-color: #F06292; color: #000; font-weight: 600; }
        .cita-item.Ruta-15 { background: #B0BEC5; border-color: #78909C; color: #000; font-weight: 600; }
        .cita-item.Ruta-16 { background: #CE93D8; border-color: #9C27B0; color: #000; font-weight: 600; }
        .cita-item.Ruta-17 { background: #F8BBD0; border-color: #E91E63; color: #000; font-weight: 600; }
        .cita-item.Ruta-18 { background: #B2EBF2; border-color: #00BCD4; color: #000; font-weight: 600; }
        .cita-item.Ruta-19 { background: #C5E1A5; border-color: #8BC34A; color: #000; font-weight: 600; }
        .cita-item.Ruta-20 { background: #FFAB91; border-color: #FF5722; color: #000; font-weight: 600; }
        .cita-item.Sin-asignar { background: #B0BEC5; border-color: #9E9E9E; color: #000; font-weight: 600; }

        .filters-section {
            background: var(--light-gradient);
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal {
            z-index: 9999 !important;
        }
        
        .modal-backdrop {
            z-index: 9998 !important;
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            z-index: 10000 !important;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: var(--eco-black);
            border-radius: 20px 20px 0 0;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner-modern {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: var(--light-gradient);
            border-radius: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
        }

        .no-citas {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-citas i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Estilos para Vista de D√≠a */
        .vista-dia {
            margin-top: 0;
        }

        .vista-dia-header {
            background: var(--light-gradient);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .vehiculos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        /* Estilos para cronograma con eje Y */
        .cronograma-container {
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 0;
            max-height: 1100px; /* Altura m√°xima aumentada para mostrar hasta las 11pm */
            overflow-y: auto; /* Permitir scroll vertical (se sobrescribir√° cuando se aplique recorte) */
            overflow-x: hidden; /* No permitir scroll horizontal aqu√≠ */
            position: relative; /* Necesario para que el overflow funcione correctamente */
        }
        
        /* Cuando se aplica recorte, el contenedor debe tener overflow: hidden */
        .cronograma-container[style*="overflow: hidden"],
        .cronograma-container[style*="overflow:hidden"] {
            overflow: hidden !important;
            overflow-y: hidden !important;
        }

        .eje-horas {
            width: 80px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            padding: 0 10px;
            min-height: 792px; /* Altura del timeline (24 horas * 33px) */
            position: relative; /* Posici√≥n relativa para que el transform funcione dentro del contenedor */
            flex-shrink: 0; /* No reducir tama√±o */
            z-index: 5;
            overflow: visible; /* Permitir que los marcadores se vean aunque est√©n fuera del contenedor inicialmente */
        }

        .hora-marcador {
            height: 33px;
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #e9ecef;
            position: relative;
        }

        .hora-marcador:last-child {
            border-bottom: none;
        }

        .vehiculos-cronograma {
            flex: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; /* El scroll vertical lo maneja el contenedor padre */
            position: relative; /* Necesario para que los elementos absolutos dentro funcionen */
        }

        .vehiculo-columna-cronograma {
            min-width: 90px;
            max-width: 180px;
            width: clamp(90px, 8vw, 180px);
            flex: 1 1 auto;
            border-right: 2px solid #000000;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 1200px) {
            .vehiculo-columna-cronograma {
                width: clamp(120px, 10vw, 200px);
                max-width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .vehiculo-columna-cronograma {
                min-width: 80px;
                width: clamp(80px, 12vw, 120px);
                max-width: 120px;
            }
        }

        .vehiculo-columna-cronograma:last-child {
            border-right: none;
        }
        
        /* Cajas de recursos sin asignar */
        .recursos-sin-asignar-container {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .recurso-caja {
            flex: 1;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
            min-height: 80px;
        }
        
        .recurso-caja-header {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            padding: 6px 10px;
            font-weight: 600;
            font-size: 0.8rem;
            border-bottom: 1px solid #5a6268;
        }
        
        .recurso-caja-body {
            padding: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 50px;
            max-height: 120px;
            overflow-y: auto;
            justify-content: center;
            align-items: flex-start;
        }
        
        .recurso-item {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: move;
            user-select: none;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .recurso-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .recurso-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .recurso-tecnico {
            background: #FF9800;
            color: white;
        }
        
        .recurso-vehiculo {
            background: #2196F3;
            color: white;
        }
        
        .ruta-info-row.drop-zone {
            border: 2px dashed #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .ruta-info-row.drop-zone-active {
            border-color: #2e7d32;
            background: rgba(76, 175, 80, 0.2);
        }

        .vehiculo-header-cronograma {
            padding: 4px 4px;
            color: var(--eco-black);
            font-weight: 700;
            font-size: 0.8rem;
            text-align: center;
            position: relative; /* Cambiar de sticky a relative para que el timeline empiece despu√©s */
            top: 0;
            z-index: 10;
            min-height: 230px; /* Altura fija: 120px (header info) + 110px (t√©cnicos/veh√≠culos) = ~230px */
            height: auto; /* Altura autom√°tica basada en contenido */
            max-height: 230px; /* Altura m√°xima fija */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            overflow: hidden; /* Evitar desbordamiento sobre el timeline */
            flex-shrink: 0; /* No reducir tama√±o */
            box-sizing: border-box; /* Incluir padding y border en el c√°lculo de altura */
        }
        
        .ruta-nombre-header {
            font-size: clamp(0.65rem, 1.2vw, 0.75rem);
            font-weight: 700;
            padding: 0;
            color: #ffffff;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .ruta-monto-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: clamp(0.55rem, 1vw, 0.65rem);
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .ruta-contenido-blanco {
            background: linear-gradient(to bottom, rgba(33, 150, 243, 0.05) 0%, rgba(33, 150, 243, 0.05) 28px, rgba(255, 152, 0, 0.05) 31px, rgba(255, 152, 0, 0.05) 100%);
            border-left: 3px solid #2196F3;
            padding: 4px;
            flex: 0 0 auto; /* Altura autom√°tica para ajustarse al contenido */
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow: hidden; /* Evitar desbordamiento */
            min-height: 81px; /* Altura m√≠nima: 28px (veh√≠culos) + 50px (t√©cnicos) + 3px (gap) = 81px */
            position: relative;
        }
        
        /* Asegurar que el borde izquierdo naranja tambi√©n se vea desde el inicio de t√©cnicos */
        .ruta-contenido-blanco::after {
            content: '';
            position: absolute;
            left: 0;
            top: 31px; /* Inicio despu√©s de veh√≠culos (28px) + gap (3px) */
            bottom: 0;
            width: 3px;
            background: #FF9800;
            z-index: 1;
        }
        
        .ruta-info-row {
            font-size: clamp(0.5rem, 1vw, 0.55rem);
            text-align: center;
            padding: 1px 4px;
            border-top: 1px solid rgba(0,0,0,0.1);
            margin-top: 0;
            min-height: 28px; /* Altura m√≠nima fija siempre visible */
            height: 28px; /* Altura fija para mantener consistencia */
            max-height: 28px; /* Altura m√°xima para evitar desbordamiento */
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-weight: 500;
            color: #000;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            align-items: center; /* Centrar verticalmente cuando est√° vac√≠o */
            justify-content: center;
            overflow: hidden; /* Evitar desbordamiento */
            position: relative;
            flex: 0 0 28px; /* Altura fija de 28px para veh√≠culos, t√©cnicos tienen flex auto */
        }
        
        .ruta-info-row[data-tipo-fila="vehiculo"] {
            background: rgba(33, 150, 243, 0.05);
            border-left: 3px solid #2196F3;
        }
        
        /* Cuando est√° vac√≠o, hacer m√°s visible el √°rea de drop para veh√≠culos */
        .ruta-info-row[data-tipo-fila="vehiculo"].drop-zone-empty {
            background: rgba(33, 150, 243, 0.15) !important;
            border: 2px dashed rgba(33, 150, 243, 0.5);
            border-left: 3px solid #2196F3;
        }
        
        .ruta-info-row[data-tipo-fila="tecnico"] {
            background: rgba(255, 152, 0, 0.05);
            border-left: 3px solid #FF9800;
            min-height: 50px !important; /* Altura suficiente para m√∫ltiples t√©cnicos */
            height: auto !important; /* Altura autom√°tica para que crezca con el contenido */
            max-height: none !important; /* Sin l√≠mite m√°ximo para permitir m√∫ltiples filas */
            flex: 0 0 auto !important; /* Flex autom√°tico para ajustarse al contenido */
        }
        
        /* Cuando est√° vac√≠o, hacer m√°s visible el √°rea de drop para t√©cnicos */
        .ruta-info-row[data-tipo-fila="tecnico"].drop-zone-empty {
            background: rgba(255, 152, 0, 0.15) !important;
            border: 2px dashed rgba(255, 152, 0, 0.5);
            border-left: 3px solid #FF9800;
        }
        
        .ruta-info-row[data-tipo-fila="vehiculo"]::before {
            content: "üöó";
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.75rem;
            z-index: 1;
            pointer-events: none;
        }
        
        .ruta-info-row[data-tipo-fila="tecnico"]::before {
            content: "üë§";
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.75rem;
            z-index: 1;
            pointer-events: none;
        }
        
        /* Asegurar que todas las filas de info tengan la misma altura */
        .vehiculos-cronograma {
            display: flex;
            align-items: flex-start;
        }
        
        .vehiculo-columna-cronograma {
            display: flex;
            flex-direction: column;
            position: relative; /* Para contener elementos posicionados */
            overflow: visible; /* Permitir que las citas se vean */
        }
        
        
        .ruta-info-row:first-of-type {
            border-top: none;
        }
        
        .ruta-badge-item {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.55rem;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: move;
            user-select: none;
            transition: all 0.2s;
            text-align: center;
        }
        
        .ruta-badge-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .ruta-badge-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .ruta-badge-vehiculo {
            background: #2196F3;
        }
        
        .ruta-badge-tecnico {
            background: #FF9800;
        }
        
        .ruta-badge-sin-asignar {
            background: #9E9E9E;
            opacity: 0.6;
        }

        .vehiculo-header-cronograma.Ruta-1 { background: #388E3C; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-2 { background: #7B1FA2; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-3 { background: #F9A825; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-4 { background: #F57C00; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-5 { background: #1976D2; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-6 { background: #C2185B; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-7 { background: #455A64; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-8 { background: #1976D2; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-9 { background: #388E3C; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-10 { background: #7B1FA2; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-11 { background: #F9A825; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-12 { background: #F57C00; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-13 { background: #1976D2; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-14 { background: #C2185B; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-15 { background: #455A64; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-16 { background: #6A1B9A; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-17 { background: #AD1457; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-18 { background: #00838F; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-19 { background: #558B2F; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-20 { background: #D84315; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Sin-asignar { 
            background: #ffffff !important; 
            color: #000000 !important; 
            font-weight: 600; 
        }

        .citas-timeline {
            position: relative;
            height: 792px; /* Altura del timeline (24 horas * 33px) */
            min-height: 792px; /* Mantener altura m√≠nima */
            max-height: 792px; /* Altura m√°xima fija */
            padding-left: 0; /* Sin padding para que los marcadores est√©n alineados */
            margin-top: 0; /* Sin margen superior */
            top: 0; /* Empezar justo despu√©s del header */
            flex-shrink: 0; /* No reducir tama√±o */
            box-sizing: border-box;
            z-index: 2; /* Asegurar que est√© sobre el header */
            background: white; /* Fondo para que las citas se vean claramente */
        }
        
        /* Marcadores de hora dentro del timeline */
        .marcador-hora-timeline {
            position: absolute;
            left: 0;
            width: 100%;
            height: 33px;
            /* Sin border-bottom, las l√≠neas divisorias ya est√°n manejadas por .linea-divisoria-hora */
            pointer-events: none;
            z-index: 1;
        }
        
        .marcador-hora-timeline-label {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: #000000;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        /* L√≠neas divisorias de hora (grises delgadas, uniformes) */
        .linea-divisoria-hora {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background-color: rgba(200, 200, 200, 0.6);
            pointer-events: none;
            z-index: 1; /* Detr√°s de las citas pero m√°s visible */
            /* Asegurar que no haya bordes adicionales que cambien el grosor */
            border: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .cita-bloque {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 4px;
            padding: 4px;
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid;
            z-index: 2; /* Por encima de los marcadores de hora */
            user-select: none;
        }

        .cita-bloque:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .cita-bloque.dragging {
            opacity: 0.5;
            z-index: 1000;
            cursor: grabbing;
        }

        .citas-timeline.drag-over {
            background-color: rgba(76, 175, 80, 0.1);
            border: 2px dashed rgba(76, 175, 80, 0.5);
        }

        .cita-bloque.Ruta-1 { border-color: #2E7D32; background: #388E3C; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-2 { border-color: #6A1B9A; background: #7B1FA2; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-3 { border-color: #F57F17; background: #F9A825; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-4 { border-color: #E65100; background: #F57C00; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-5 { border-color: #0D47A1; background: #1976D2; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-6 { border-color: #880E4F; background: #C2185B; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-7 { border-color: #263238; background: #455A64; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-8 { border-color: #0D47A1; background: #1976D2; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-9 { border-color: #2E7D32; background: #388E3C; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-10 { border-color: #6A1B9A; background: #7B1FA2; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-11 { border-color: #F57F17; background: #F9A825; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-12 { border-color: #E65100; background: #F57C00; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-13 { border-color: #0D47A1; background: #1976D2; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-14 { border-color: #880E4F; background: #C2185B; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-15 { border-color: #263238; background: #455A64; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-16 { border-color: #4A148C; background: #6A1B9A; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-17 { border-color: #880E4F; background: #AD1457; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-18 { border-color: #006064; background: #00838F; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-19 { border-color: #33691E; background: #558B2F; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-20 { border-color: #BF360C; background: #D84315; color: #fff; font-weight: 600; }
        .cita-bloque.Sin-asignar { border-color: #424242; background: #616161; color: #fff; font-weight: 600; }

        .cita-hora-cronograma {
            font-weight: 600;
            font-size: 0.5rem;
            color: #ffffff;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .cita-cliente-cronograma {
            font-weight: 600;
            font-size: 0.55rem;
            color: #ffffff;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .cita-descripcion-cronograma {
            font-size: 0.55rem;
            color: #ffffff;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-weight: 500;
        }

        .cita-estado-cronograma {
            display: none; /* Ocultar el punto azul */
        }

        .cita-estado-cronograma.agendada { background: #1976d2; }
        .cita-estado-cronograma.confirmada { background: #2e7d32; }
        .cita-estado-cronograma.completada { background: #7b1fa2; }
        .cita-estado-cronograma.cancelada { background: #c62828; }
        
        /* Indicador GPS en esquina superior derecha */
        .indicador-gps {
            position: absolute;
            top: 2px;
            right: 2px;
            z-index: 10;
            font-size: 0.75rem !important;
        }
        
        .cita-item-dia {
            position: relative;
        }
        
        .cita-item {
            position: relative;
        }

        .tiempo-libre {
            position: absolute;
            left: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.02);
            border: 1px dashed #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.7rem;
            font-style: italic;
        }

        .tiempo-libre:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
            color: #667eea;
        }

        .vehiculo-columna {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .vehiculo-columna:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .vehiculo-header {
            padding: 20px;
            color: var(--eco-black);
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            position: relative;
        }

        .vehiculo-header.Ruta-1 { background: #A5D6A7; color: #1B5E20; font-weight: 600; }
        .vehiculo-header.Ruta-2 { background: #CE93D8; color: #4A148C; font-weight: 600; }
        .vehiculo-header.Ruta-3 { background: #FFF59D; color: #F57F17; font-weight: 600; }
        .vehiculo-header.Ruta-4 { background: #FFCC80; color: #E65100; font-weight: 600; }
        .vehiculo-header.Ruta-5 { background: #90CAF9; color: #0D47A1; font-weight: 600; }
        .vehiculo-header.Ruta-6 { background: #F48FB1; color: #880E4F; font-weight: 600; }
        .vehiculo-header.Ruta-7 { background: #B0BEC5; color: #263238; font-weight: 600; }
        .vehiculo-header.Ruta-8 { background: #90CAF9; color: #0D47A1; font-weight: 600; }
        .vehiculo-header.Ruta-9 { background: #A5D6A7; color: #1B5E20; font-weight: 600; }
        .vehiculo-header.Ruta-10 { background: #CE93D8; color: #4A148C; font-weight: 600; }
        .vehiculo-header.Ruta-11 { background: #FFF59D; color: #F57F17; font-weight: 600; }
        .vehiculo-header.Ruta-12 { background: #FFCC80; color: #E65100; font-weight: 600; }
        .vehiculo-header.Ruta-13 { background: #90CAF9; color: #0D47A1; font-weight: 600; }
        .vehiculo-header.Ruta-14 { background: #F48FB1; color: #880E4F; font-weight: 600; }
        .vehiculo-header.Ruta-15 { background: #B0BEC5; color: #263238; font-weight: 600; }
        .vehiculo-header.Ruta-16 { background: #CE93D8; color: #4A148C; font-weight: 600; }
        .vehiculo-header.Ruta-17 { background: #F8BBD0; color: #880E4F; font-weight: 600; }
        .vehiculo-header.Ruta-18 { background: #B2EBF2; color: #006064; font-weight: 600; }
        .vehiculo-header.Ruta-19 { background: #C5E1A5; color: #33691E; font-weight: 600; }
        .vehiculo-header.Ruta-20 { background: #FFAB91; color: #BF360C; font-weight: 600; }
        .vehiculo-header.Sin-asignar { background: #616161; color: white; font-weight: 600; }
        .vehiculo-header.Sin-asignar { background: #616161; color: white; font-weight: 700; }
        .vehiculo-header-cronograma.Sin-asignar { background: #616161; color: white; font-weight: 700; }

        .vehiculo-stats {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
            color: #666;
        }

        .citas-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Contenedor para citas en la misma hora - lado a lado */
        .citas-misma-hora {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .citas-misma-hora .cita-item-dia {
            flex: 1 1 calc(50% - 4px);
            min-width: 200px;
        }
        
        /* Si hay 3 o m√°s citas, hacer m√°s peque√±as */
        .citas-misma-hora:has(.cita-item-dia:nth-child(3)) .cita-item-dia {
            flex: 1 1 calc(33.333% - 6px);
            min-width: 150px;
        }

        .cita-item-dia {
            padding: 15px 20px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .cita-item-dia:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .cita-item-dia:last-child {
            border-bottom: none;
        }

        .cita-hora {
            font-weight: 700;
            color: #667eea;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .cita-cliente {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .cita-descripcion {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .cita-estado {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .cita-estado.agendada { background: #1976d2; color: white; font-weight: 700; }
        .cita-estado.confirmada { background: #2e7d32; color: white; font-weight: 700; }
        .cita-estado.completada { background: #7b1fa2; color: white; font-weight: 700; }
        .cita-estado.cancelada { background: #c62828; color: white; font-weight: 700; }

        .cita-duracion {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sin-citas {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .sin-citas i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Botones personalizados para calendario */
        .btn-primary-modern {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }
        .btn-primary-modern:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%) !important;
            border-color: #45a049 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-success-modern {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }
        .btn-success-modern:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%) !important;
            border-color: #45a049 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-warning-modern {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%) !important;
            border-color: #FF9800 !important;
            color: white !important;
        }
        .btn-warning-modern:hover {
            background: linear-gradient(135deg, #F57C00 0%, #E65100 100%) !important;
            border-color: #F57C00 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }

        .btn-danger-modern {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%) !important;
            border-color: #F44336 !important;
            color: white !important;
        }
        .btn-danger-modern:hover {
            background: linear-gradient(135deg, #D32F2F 0%, #C62828 100%) !important;
            border-color: #D32F2F !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
        }

        .btn-info-modern {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important;
            border-color: #2196F3 !important;
            color: white !important;
        }
        .btn-info-modern:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important;
            border-color: #1976D2 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }

        .btn-outline-primary {
            border-color: #4CAF50 !important;
            color: #4CAF50 !important;
        }
        .btn-outline-primary:hover {
            background: #4CAF50 !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #757575 0%, #616161 100%) !important;
            border-color: #757575 !important;
            color: white !important;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #616161 0%, #424242 100%) !important;
            border-color: #616161 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(117, 117, 117, 0.3);
        }

        /* Bot√≥n de cronograma - Verde */
        #btnVistaCronograma {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }

        #btnVistaCronograma:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%) !important;
            border-color: #45a049 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        #btnVistaCronograma.active {
            background: linear-gradient(135deg, #3d8b40 0%, #2e7d32 100%) !important;
            border-color: #3d8b40 !important;
            color: white !important;
        }
        /* Icono animado de despliegue */
        @keyframes pulse-down {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(8px) scale(1.15);
            }
        }
        
        .icon-expand-pulse {
            animation: pulse-down 1.5s ease-in-out infinite;
        }
        
        /* Secci√≥n Adicional colapsable */
        .adicional-toggle {
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .adicional-toggle:hover {
            opacity: 0.9;
        }
        
        .adicional-content {
            display: none;
        }
        
        .adicional-content.show {
            display: block;
        }
        
        /* Estilos para dropdown con buscador */
        .dropdown-container {
            position: relative;
        }
        
        .dropdown-menu {
            width: 100%;
            margin-top: 0.25rem;
        }
        
        .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: #f5f5f5;
        }
        
        .dropdown-item:active {
            background-color: #e0e0e0;
        }
        
        /* Estilos para botones de d√≠as del mes */
        .btn-dia-mes {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            text-align: center;
            color: #333;
            white-space: nowrap;
        }
        
        .btn-dia-mes:hover {
            background: #f0f0f0;
            border-color: #4CAF50;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-dia-mes.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: 600;
        }
        
        .btn-dia-mes.today {
            border-color: #4CAF50;
            border-width: 2px;
        }
        
        .btn-dia-mes.domingo {
            background: #9E9E9E !important;
            color: white !important;
            border-color: #757575 !important;
        }
        
        .btn-dia-mes.domingo:hover {
            background: #757575 !important;
            border-color: #616161 !important;
        }
        
        .btn-dia-mes.domingo.active {
            background: #616161 !important;
            border-color: #424242 !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header se carga din√°micamente -->

        <!-- Calendario -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <!-- Filtro de fecha y bot√≥n Vista Total -->
                    <div class="date-filter-container" style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <button id="btnPrevMonthCronograma" class="btn-date-nav" style="background: #f5f5f5; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #4CAF50;" onmouseover="this.style.background='#4CAF50'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#4CAF50';">
                            <i class="fas fa-chevron-left" style="font-size: 0.9rem;"></i>
                        </button>
                        <div id="datePickerContainer" style="display: flex; flex-wrap: wrap; gap: 4px; max-width: 600px; overflow-x: auto; padding: 4px;">
                            <!-- Los botones de d√≠as se generar√°n din√°micamente -->
                        </div>
                        <button id="btnNextMonthCronograma" class="btn-date-nav" style="background: #f5f5f5; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #4CAF50;" onmouseover="this.style.background='#4CAF50'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#4CAF50';">
                            <i class="fas fa-chevron-right" style="font-size: 0.9rem;"></i>
                        </button>
                        <!-- Input oculto para mantener compatibilidad -->
                        <input type="date" id="datePicker" style="display: none;">
                        <div style="width: 1px; height: 28px; background: #e0e0e0; margin: 0 4px;"></div>
                        <button id="btnToggleVistaCompacta" class="btn btn-sm active" style="background: #4CAF50; color: white; border: none; padding: 8px 14px; border-radius: 8px; font-weight: 500; font-size: 0.9rem; height: 36px; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#45a049';" onmouseout="this.style.background='#4CAF50';">
                            <i class="fas fa-expand-alt" style="font-size: 0.85rem;"></i>
                            <span>Vista Total</span>
                        </button>
                        <!-- Botones de navegaci√≥n de semana (solo visibles en vista compacta) -->
                        <div id="navegacionSemana" style="display: none; align-items: center; gap: 8px;">
                            <button id="btnSemanaAnterior" class="btn-date-nav" style="background: #f5f5f5; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #4CAF50;" onmouseover="this.style.background='#4CAF50'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#4CAF50';">
                                <i class="fas fa-chevron-left" style="font-size: 0.9rem;"></i>
                            </button>
                            <span id="rangoSemana" style="font-size: 0.9rem; font-weight: 500; color: #333; min-width: 200px; text-align: center;"></span>
                            <button id="btnSemanaSiguiente" class="btn-date-nav" style="background: #f5f5f5; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #4CAF50;" onmouseover="this.style.background='#4CAF50'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#4CAF50';">
                                <i class="fas fa-chevron-right" style="font-size: 0.9rem;"></i>
                            </button>
                        </div>
                </div>
                    <div class="ms-auto position-relative">
                        <button id="btnMenuHamburguesa" class="btn btn-outline-secondary" style="font-size: 1.2rem; padding: 8px 12px;" title="Men√∫">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div id="menuHamburguesa" class="menu-hamburguesa" style="display: none;">
                            <!-- SECCI√ìN: ACTUALIZAR DATA -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar Data
                                </h6>
                                <button id="btnCargarCSV" class="btn btn-primary-modern btn-modern w-100 mb-2" title="Cargar citas desde archivo CSV">
                                    <i class="fas fa-file-csv me-2"></i>Cargar CSV
                                </button>
                                <input type="file" id="inputCSV" accept=".csv" style="display: none;">
                                <button id="btnActualizarCSV" class="btn btn-warning-modern btn-modern w-100 mb-2" title="Actualizar citas desde CSV (reemplaza solo las del rango de fechas del CSV)">
                                    <i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV
                                </button>
                                <input type="file" id="inputCSVActualizar" accept=".csv" style="display: none;">
                                <button id="btnActualizarGoogleSheetsAuto" class="btn btn-success-modern btn-modern w-100 mb-2" title="Actualizar citas desde Google Sheets oficial (URL predefinida)">
                                    <i class="fab fa-google me-2"></i>Actualizar desde Sheets Oficial
                                </button>
                            </div>
                            
                            <!-- SECCI√ìN: REPORTES -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-chart-bar me-1"></i>Reportes
                                </h6>
                                <a href="reporte_tactico.html" class="btn btn-danger-modern btn-modern w-100 mb-2" title="Reporte T√°ctico 2025 - Ventas por d√≠a y empleado">
                                    üî•ü™ñ T√°ctico 2025
                                </a>
                                <a href="reporte_encuestas.html" class="btn btn-info-modern btn-modern w-100 mb-2" title="Reporte de Encuestas de Satisfacci√≥n">
                                    <i class="fas fa-clipboard-check me-2"></i>Encuestas
                                </a>
                            </div>
                            
                            <!-- SECCI√ìN: AGREGAR -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-plus-circle me-1"></i>Agregar
                                </h6>
                                <button id="btnGestionarServicios" class="btn btn-warning-modern btn-modern w-100 mb-2" title="Gestionar servicios disponibles">
                                    <i class="fas fa-cog me-2"></i>Servicios
                                </button>
                                <button id="btnGestionarEquipo" class="btn btn-info-modern btn-modern w-100 mb-2" title="Gestionar equipo y herramientas disponibles">
                                    <i class="fas fa-tools me-2"></i>Equipo
                                </button>
                            </div>
                            
                            <!-- OTRAS OPCIONES -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-cog me-1"></i>Opciones
                                </h6>
                                <button id="btnEliminarTodasCitas" class="btn btn-danger-modern btn-modern w-100 mb-2" title="‚ö†Ô∏è ELIMINAR TODAS LAS CITAS (Solo para pruebas)">
                                    <i class="fas fa-trash-alt me-2"></i>Eliminar Todas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Los d√≠as del calendario se generar√°n din√°micamente -->
            </div>

            <!-- Vista de D√≠a -->
            <div id="vistaDia" class="vista-dia" style="display: none;">
                <div class="vista-dia-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 id="vistaDiaTitulo" class="mb-0">
                            <i class="fas fa-calendar-day me-2"></i>Citas del D√≠a
                        </h3>
                        <div id="facturacionTotalDia" class="text-end" style="display: none;">
                            <strong style="font-size: 1.2rem; color: #28a745;">
                                <i class="fas fa-money-bill-wave me-2"></i>
                                Facturaci√≥n Total: <span id="montoTotalDia">‚Ç°0</span>
                            </strong>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <button id="btnPrevDay" class="btn btn-calendar">
                            <i class="fas fa-chevron-left"></i> D√≠a Anterior
                        </button>
                        <button id="btnNextDay" class="btn btn-calendar">
                            D√≠a Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="vehiculos-grid" id="vehiculosGrid">
                    <!-- Las columnas de veh√≠culos se generar√°n din√°micamente -->
                </div>
            </div>

            <!-- Vista de Cronograma -->
            <div id="vistaCronograma" class="vista-dia" style="display: none;">
                <!-- Cajas de recursos sin asignar -->
                <div class="recursos-sin-asignar-container mb-1" style="padding: 8px; margin-top: 0;">
                    <div class="recurso-caja">
                        <div class="recurso-caja-header">
                            <i class="fas fa-users me-2"></i>T√©cnicos Sin Asignar
                        </div>
                        <div class="recurso-caja-body" id="tecnicosSinAsignarContainer">
                            <!-- Los t√©cnicos se generar√°n din√°micamente -->
                        </div>
                    </div>
                    <div class="recurso-caja">
                        <div class="recurso-caja-header">
                            <i class="fas fa-truck me-2"></i>Veh√≠culos Sin Asignar
                        </div>
                        <div class="recurso-caja-body" id="vehiculosSinAsignarContainer">
                            <!-- Los veh√≠culos se generar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
                <!-- Secci√≥n Rutas Diurnas - BLOQUE COMPLETAMENTE INDEPENDIENTE -->
                <div id="seccionRutasDiurnas" style="width: 100%; margin-bottom: 2px; padding: 4px; background: #f8f9fa; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div class="seccion-titulo" style="background: #0D47A1; color: white; padding: 6px 15px; margin-bottom: 0; border-radius: 6px 6px 0 0; font-weight: bold; text-align: center; font-size: 0.9rem;">
                        <i class="fas fa-sun me-2"></i>Rutas Diurnas (Ruta 1-10)
                    </div>
                    <div class="cronograma-container" style="width: 100%;">
                        <!-- Eje de horas oculto, usando marcadores internos en "Sin asignar" -->
                        <div class="eje-horas" id="ejeHorasDiurnas" style="display: none;">
                            <!-- Oculto -->
                        </div>
                        <div class="vehiculos-cronograma" id="vehiculosCronogramaDiurnas" style="flex: 1; display: flex; overflow-x: auto; overflow-y: hidden; margin-bottom: 0; padding-bottom: 0;">
                            <!-- Las columnas de rutas diurnas se generar√°n din√°micamente -->
                    </div>
                </div>
            </div>

                <!-- Secci√≥n Rutas Nocturnas / Especiales - BLOQUE COMPLETAMENTE INDEPENDIENTE -->
                <div id="seccionRutasNocturnas" style="width: 100%; margin-top: 2px; padding: 4px; background: #f5f3ff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div class="seccion-titulo" style="background: #000000; color: white; padding: 6px 15px; margin-bottom: 0; border-radius: 6px 6px 0 0; font-weight: bold; text-align: center; font-size: 0.9rem;">
                        <i class="fas fa-moon me-2"></i>Rutas Nocturnas / Especiales (Ruta 11-Cancelaciones)
                    </div>
                    <div class="cronograma-container" style="width: 100%;">
                        <!-- Eje de horas oculto, usando marcadores internos en "Sin asignar" -->
                        <div class="eje-horas" id="ejeHorasNocturnas" style="display: none;">
                            <!-- Oculto -->
                        </div>
                        <div class="vehiculos-cronograma" id="vehiculosCronogramaNocturnas" style="flex: 1; display: flex; overflow-x: auto; overflow-y: hidden; margin-bottom: 0; padding-bottom: 0;">
                            <!-- Las columnas de rutas nocturnas se generar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>


                </div>
                </div>

    <!-- Modal para Editar Cita -->
    <div class="modal fade" id="editCitaModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center" style="flex-wrap: wrap; gap: 0.5rem;">
                    <h5 class="modal-title mb-0" style="color: #8B0000 !important;"><i class="fas fa-edit me-2"></i>Editar Cita</h5>
                    <div class="d-flex gap-2" style="flex-wrap: wrap;">
                        <button type="button" id="btnDescargarProforma" style="background: #fbdc02; color: #000000; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-download me-2"></i>Descargar Proforma PNG
                        </button>
                        <button type="button" id="btnJustificarSinEncuesta" title="Justificar por qu√© esta cita no lleva encuesta" style="background: #fbdc02; color: #000000; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-heart me-2"></i>Cita no lleva encuesta
                        </button>
                        <button type="button" id="btnEnviarEncuesta" title="Generar link de encuesta post-servicio" style="background: #fbdc02; color: #000000; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-clipboard-check me-2"></i>Enviar Encuesta
                        </button>
                        <button type="button" id="btnDeleteCita" style="background: #ea0e2a; color: white; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-trash me-2"></i>Eliminar Cita
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; color: white; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="button" id="btnSaveCitaTop" style="background: #0b7835; color: white; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 0.75rem; background: #f5f5f5;">
                    <!-- Campos Indispensables -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Requerido</h5>
                </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Tel√©fono -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 140px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Tel√©fono <span style="color: #ea0e2a;">*</span></label>
                                    <input type="text" id="editClientPhone" class="form-control" placeholder="12345678" maxlength="8" pattern="[0-9]{8}" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small id="editPhoneDisplay" class="d-block mt-1" style="font-size: 0.75rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;"></small>
                </div>
                                
                                <!-- Sucursal -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Sucursal <span style="color: #ea0e2a;">*</span></label>
                                    <div class="input-group">
                                        <select id="editSucursal" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px 0 0 8px; color: #000000;">
                                            <option value="">Cargando...</option>
                                        </select>
                                        <button type="button" id="btnNuevaSucursalEdit" class="btn" style="border: 1px solid #e0e0e0; border-left: none; border-radius: 0 8px 8px 0; background: #ffffff; color: #000000; padding: 0.75rem;" title="Crear nueva sucursal">
                                            <i class="fas fa-plus" style="opacity: 0.7;"></i>
                                        </button>
                </div>
                                    <input type="text" id="editNombreSucursal" class="form-control mt-2" placeholder="Nombre de la sucursal" style="display: none; border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.8rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Seleccione o cree una sucursal</small>
                </div>
                                
                                <!-- Fecha y Hora de Inicio -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 230px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Fecha y Hora <span style="color: #ea0e2a;">*</span></label>
                                    <input type="datetime-local" id="editStartTime" class="form-control" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                </div>
                                
                                <!-- Duraci√≥n -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 150px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Duraci√≥n <span style="color: #ea0e2a;">*</span></label>
                                    <select id="editDuration" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="15">15 minutos</option>
                                        <option value="30">30 minutos</option>
                                        <option value="45">45 minutos</option>
                                        <option value="60" selected>1 hora</option>
                                        <option value="75">1 hora 15 minutos</option>
                                        <option value="90">1 hora 30 minutos</option>
                                        <option value="105">1 hora 45 minutos</option>
                                        <option value="120">2 horas</option>
                                        <option value="135">2 horas 15 minutos</option>
                                        <option value="150">2 horas 30 minutos</option>
                                        <option value="165">2 horas 45 minutos</option>
                                        <option value="180">3 horas</option>
                                        <option value="195">3 horas 15 minutos</option>
                                        <option value="210">3 horas 30 minutos</option>
                                        <option value="225">3 horas 45 minutos</option>
                                        <option value="240">4 horas</option>
                                        <option value="255">4 horas 15 minutos</option>
                                        <option value="270">4 horas 30 minutos</option>
                                        <option value="285">4 horas 45 minutos</option>
                                        <option value="300">5 horas</option>
                                        <option value="315">5 horas 15 minutos</option>
                                        <option value="330">5 horas 30 minutos</option>
                                        <option value="345">5 horas 45 minutos</option>
                                        <option value="360">6 horas</option>
                                        <option value="375">6 horas 15 minutos</option>
                                        <option value="390">6 horas 30 minutos</option>
                                        <option value="405">6 horas 45 minutos</option>
                                        <option value="420">7 horas</option>
                                        <option value="435">7 horas 15 minutos</option>
                                        <option value="450">7 horas 30 minutos</option>
                                        <option value="465">7 horas 45 minutos</option>
                                        <option value="480">8 horas</option>
                                        <option value="540">9 horas</option>
                                        <option value="600">10 horas</option>
                                        <option value="660">11 horas</option>
                                        <option value="720">12 horas</option>
                                    </select>
                                        </div>
                                
                                <!-- Ruta -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 120px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Ruta <span style="color: #ea0e2a;">*</span></label>
                                    <select id="editRuta" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="Sin asignar">Sin asignar</option>
                                        <option value="Ruta 1">Ruta 1</option>
                                        <option value="Ruta 2">Ruta 2</option>
                                        <option value="Ruta 3">Ruta 3</option>
                                        <option value="Ruta 4">Ruta 4</option>
                                        <option value="Ruta 5">Ruta 5</option>
                                        <option value="Ruta 6">Ruta 6</option>
                                        <option value="Ruta 7">Ruta 7</option>
                                        <option value="Ruta 8">Ruta 8</option>
                                        <option value="Ruta 9">Ruta 9</option>
                                        <option value="Ruta 10">Ruta 10</option>
                                        <option value="Ruta 11">Ruta 11</option>
                                        <option value="Ruta 12">Ruta 12</option>
                                        <option value="Ruta 13">Ruta 13</option>
                                        <option value="Ruta 14">Ruta 14</option>
                                        <option value="Ruta 15">Ruta 15</option>
                                        <option value="Ruta 16">Ruta 16</option>
                                        <option value="Ruta 17">Ruta 17</option>
                                        <option value="Ruta 18">Ruta 18</option>
                                        <option value="Ruta 19">Ruta 19</option>
                                        <option value="Ruta 20">Ruta 20</option>
                                    </select>
                </div>
                                
                                <!-- Nombre del Cliente -->
                                <div class="col-12 col-md" style="flex: 1 1 0; min-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Nombre del Cliente</label>
                                    <input type="text" id="editClientName" class="form-control" placeholder="Ingrese el nombre completo" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                        </div>
                                    </div>
                                </div>
                                
                    <!-- Informaci√≥n Adicional (Opcional) -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h6 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Opcional</h6>
                </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Ubicaci√≥n (Opcional) -->
                                <div class="col-12" style="margin-top: 0.25rem;">
                                    <h6 class="mb-2" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Ubicaci√≥n</h6>
                                </div>
                                
                                <!-- Fila 1: Coordenadas, Otras Se√±as, Provincia, Cant√≥n y Distrito en la misma l√≠nea -->
                                <div class="col-12">
                                    <div class="row" style="gap: 0.5rem 0.75rem; margin: 0;">
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Coordenadas (Lat, Lng)</label>
                                            <input type="text" id="editCoordenadas" class="form-control" placeholder="9.838501, -83.866745" pattern="^-?\d+\.?\d*,\s*-?\d+\.?\d*$" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Otras Se√±as</label>
                                            <input type="text" id="editOtrasSenas" class="form-control" placeholder="Ej: 200mts norte del supermercado, casa azul" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Provincia</label>
                                            <select id="editProvincia" class="form-select" disabled readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;">
                                                <option value="">Se detectar√° autom√°ticamente...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Cant√≥n</label>
                                            <select id="editCanton" class="form-select" disabled readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;">
                                                <option value="">Se detectar√° autom√°ticamente...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Distrito</label>
                                            <select id="editDistrito" class="form-select" disabled readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;">
                                                <option value="">Se detectar√° autom√°ticamente...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fila 2: Link de Ubicaci√≥n y WhatsApp -->
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Link de Ubicaci√≥n (Waze/Google Maps)</label>
                                    <textarea id="editDireccion" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generar√°n autom√°ticamente al ingresar coordenadas"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">WhatsApp</label>
                                    <textarea id="editWhatsApp" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generar√° autom√°ticamente con el tel√©fono"></textarea>
                                </div>
                                
                                <!-- Mapa -->
                                <div class="col-12" style="margin-top: 0.5rem;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Vista del Mapa</label>
                                    <div id="mapaUbicacionEdit" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #e0e0e0;"></div>
                                </div>
                                
                                <!-- Servicios -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                </div>
                                <div class="col-12" style="position: relative; z-index: 1000;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Servicios
                                    </label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1001;">
                                        <input type="text" id="editServicioSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar servicio" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editServiciosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1002 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditServicio" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editServiciosSelected" class="mb-2 mt-2">
                                        <table class="table table-sm table-bordered" id="editServiciosTabla" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="font-size: 0.9rem; font-weight: 600;">Servicio</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Precio (‚Ç°)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="editServiciosTablaBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Plaga -->
                                <div class="col-12" style="position: relative; z-index: 999;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Plaga
                                    </label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1000;">
                                        <input type="text" id="editPlagaSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar plaga" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editPlagasDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1001 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditPlaga" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editPlagasSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                
                                <!-- Estado -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <h6 class="mb-2" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif; margin-top: 0.5rem;">Detalles</h6>
            </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Estado</label>
                                    <select id="editStatus" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="agendada">Agendada</option>
                                        <option value="confirmada">Confirmada</option>
                                        <option value="completada">Completada</option>
                                        <option value="cancelada">Cancelada</option>
                                    </select>
        </div>
                                
                                <!-- Monto y Costo -->
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Monto de Venta (‚Ç°)</label>
                                    <input type="text" id="editMontoVenta" class="form-control" placeholder="0" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
    </div>

                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Costo del Servicio (‚Ç°)</label>
                                    <input type="text" id="editCostoServicio" class="form-control" placeholder="20000" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.85rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Costo estimado</small>
                                </div>
                                
                                <!-- M√©todo de Pago -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">M√©todo de Pago</label>
                                    <select id="editMetodoPago" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="">Seleccionar m√©todo de pago</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Dat√°fono (tarjeta)">Dat√°fono (tarjeta)</option>
                                        <option value="SINPE">SINPE</option>
                                        <option value="Transferencia bancaria">Transferencia bancaria</option>
                                        <option value="Cuenta por cobrar">Cuenta por cobrar</option>
                                    </select>
                                </div>
                                
                                <!-- N¬∞ Factura -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">N¬∞ Factura</label>
                                    <input type="text" id="editNumeroFactura" class="form-control" placeholder="Ingrese el n√∫mero de factura" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
            </div>
        </div>
    </div>

                    <!-- Informaci√≥n Adicional -->
                    <div class="card mb-2" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; z-index: 1;">
                        <div class="card-header adicional-toggle" id="toggleAdicionalEdit" style="background: #fbdc02; border-bottom: 1px solid #e0e0e0; padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <h6 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Adicional</h6>
                                <i class="fas fa-chevron-down icon-expand-pulse" style="font-size: 1.8rem; color: #000000;"></i>
                            </div>
                </div>
                        <div class="card-body adicional-content" id="contentAdicionalEdit" style="padding: 1rem; display: none;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Vendedores
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="editVendedorSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar vendedor" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editVendedoresDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditVendedor" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editVendedoresSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                        </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Productos de Inventario
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="editProductoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar producto" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editProductosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditProducto" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editProductosSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                        </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Equipo y Herramientas
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="editEquipoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar equipo" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editEquipoDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditEquipo" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editEquipoSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-certificate me-1" style="opacity: 0.7;"></i>Certificados de Fumigaci√≥n
                                    </label>
                                    <textarea id="editCertificados" class="form-control" rows="3" placeholder="Ingrese el texto para generar uno o m√°s certificados de fumigaci√≥n. Cada l√≠nea o p√°rrafo generar√° un certificado separado." style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #ffffff; border-radius: 8px; color: #000000;"></textarea>
                                    <small class="d-block mt-1" style="font-size: 0.85rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Cada l√≠nea o p√°rrafo generar√° un certificado separado para la fecha y hora de esta cita</small>
                                    <button type="button" id="btnGenerarCertificadoEdit" class="btn mt-2" style="background: #0b7835; color: white; border: none; border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-file-pdf me-2"></i>Generar PDF
                                    </button>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="card" style="border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div class="card-header" style="background-color: #2c3e50; color: white; border-bottom: 2px solid #34495e;">
                                            <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-calculator me-2"></i>Resumen Financiero</h6>
                                    </div>
                                        <div class="card-body" style="background-color: #ffffff;">
                                            <div class="mb-3" style="background-color: #f8f9fa; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #3498db;">
                                                <small style="color: #7f8c8d; font-size: 0.85rem;"><i class="fas fa-info-circle me-1"></i>Ingresos y Costos de la Cita</small>
                                </div>
                                            
                                            <!-- SECCI√ìN DE COSTOS -->
                                            <div class="mb-3">
                                                <h6 style="color: #e74c3c; font-weight: 600; margin-bottom: 0.75rem; font-size: 0.95rem;">
                                                    <i class="fas fa-arrow-down me-1"></i>COSTOS (Egresos)
                                                </h6>
                                                <div class="row" style="background-color: #fff5f5; padding: 0.75rem; border-radius: 6px; margin: 0;">
                                                    <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Servicios (precio de servicios seleccionados):</span>
                                                            <span id="totalServicios" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">‚Ç°0</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Productos (costo de productos √ó cantidad):</span>
                                                            <span id="totalProductos" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">‚Ç°0</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Costo del Servicio (manual):</span>
                                                            <span id="costoServicioDisplay" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">‚Ç°0</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 pt-2" style="border-top: 2px solid #e74c3c;">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <strong style="color: #e74c3c; font-size: 1rem;">TOTAL COSTOS:</strong>
                                                            <span id="totalCostos" style="color: #e74c3c; font-weight: 700; font-size: 1.1rem;">‚Ç°0</span>
                                                        </div>
                                                        <small style="color: #7f8c8d; font-size: 0.75rem;">Servicios + Productos + Costo Servicio</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- SECCI√ìN DE INGRESOS -->
                                            <div class="mb-3">
                                                <h6 style="color: #27ae60; font-weight: 600; margin-bottom: 0.75rem; font-size: 0.95rem;">
                                                    <i class="fas fa-arrow-up me-1"></i>INGRESOS
                                                </h6>
                                                <div class="row" style="background-color: #f0fff4; padding: 0.75rem; border-radius: 6px; margin: 0;">
                                <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Monto de Venta:</span>
                                                            <span id="montoVentaDisplay" style="color: #27ae60; font-weight: 700; font-size: 1rem;">‚Ç°0</span>
                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- RESULTADO NETO -->
                                            <div class="col-12 pt-3" style="border-top: 3px solid #34495e; background-color: #f8f9fa; padding: 1rem !important; border-radius: 6px; margin-top: 1rem;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong style="color: #2c3e50; font-size: 1.1rem;">GANANCIA NETA:</strong>
                                                    <span id="netoVenta" style="font-weight: 700; font-size: 1.3rem;">‚Ç°0</span>
                                                </div>
                                                <small style="color: #7f8c8d; font-size: 0.8rem;">Monto Venta - Total Costos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label mb-2 fw-bold" style="font-size: 1rem; color: #212529;">
                                        Descripci√≥n del Servicio
                                    </label>
                                    <textarea id="editDescription" class="form-control" rows="4" placeholder="Detalles adicionales sobre el servicio a realizar..." style="border: 2px solid #dee2e6; font-size: 1rem; padding: 0.75rem; background-color: #ffffff; border-radius: 6px;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light" style="display: none;">
                    <!-- Botones movidos al header -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Justificar Cita sin Encuesta -->
    <div class="modal fade" id="modalJustificarSinEncuesta" tabindex="-1" aria-labelledby="modalJustificarSinEncuestaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalJustificarSinEncuestaLabel">
                        <i class="fas fa-heart me-2"></i>Justificar Cita sin Encuesta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="justificacionSinEncuesta" class="form-label">
                            <strong>Justificaci√≥n:</strong>
                            <small class="text-muted">Explique por qu√© esta cita no lleva encuesta</small>
                        </label>
                        <textarea class="form-control" id="justificacionSinEncuesta" rows="4" placeholder="Ejemplo: Cita cancelada, cliente no atendi√≥, servicio no realizado, etc."></textarea>
                    </div>
                    <div id="justificacionExistente" class="alert alert-info" style="display: none;">
                        <strong>Justificaci√≥n actual:</strong>
                        <p id="textoJustificacionExistente" class="mb-0 mt-2"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnGuardarJustificacion">
                        <i class="fas fa-save me-2"></i>Guardar Justificaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Cita (id√©ntico al de editar) -->
    <div class="modal fade" id="nuevaCitaModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center" style="flex-wrap: wrap; gap: 0.5rem;">
                    <h5 class="modal-title mb-0" style="color: #8B0000 !important;"><i class="fas fa-plus me-2"></i>Nueva Cita</h5>
                    <div class="d-flex gap-2" style="flex-wrap: wrap;">
                        <button type="button" id="btnDescargarProformaNew" style="background: #fbdc02; color: #000000; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-download me-2"></i>Descargar Proforma PNG
                        </button>
                        <button type="button" id="btnJustificarSinEncuestaNew" title="Justificar por qu√© esta cita no lleva encuesta" style="background: #fbdc02; color: #000000; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-heart me-2"></i>Cita no lleva encuesta
                        </button>
                        <button type="button" id="btnEnviarEncuestaNew" title="Generar link de encuesta post-servicio" style="background: #fbdc02; color: #000000; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-clipboard-check me-2"></i>Enviar Encuesta
                        </button>
                        <button type="button" id="btnDeleteCitaNew" style="background: #ea0e2a; color: white; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-trash me-2"></i>Eliminar Cita
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #6c757d; color: white; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="button" id="btnSaveNewCitaTop" style="background: #0b7835; color: white; border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2);">
                            <i class="fas fa-save me-2"></i>Guardar Cita
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 0.75rem; background: #f5f5f5;">
                    <!-- Campos Indispensables -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Requerido</h5>
                </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Tel√©fono -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 140px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Tel√©fono <span style="color: #ea0e2a;">*</span></label>
                                    <input type="text" id="newClientPhone" class="form-control" placeholder="12345678" maxlength="8" pattern="[0-9]{8}" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small id="newPhoneDisplay" class="d-block mt-1" style="font-size: 0.75rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;"></small>
                </div>
                                
                                <!-- Sucursal -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Sucursal <span style="color: #ea0e2a;">*</span></label>
                                    <div class="input-group">
                                        <select id="newSucursal" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px 0 0 8px; color: #000000;">
                                            <option value="">Ingrese tel√©fono primero</option>
                                        </select>
                                        <button type="button" id="btnNuevaSucursalNew" class="btn" style="border: 1px solid #e0e0e0; border-left: none; border-radius: 0 8px 8px 0; background: #ffffff; color: #000000; padding: 0.75rem;" title="Crear nueva sucursal">
                                            <i class="fas fa-plus" style="opacity: 0.7;"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="newNombreSucursal" class="form-control mt-2" placeholder="Nombre de la sucursal" style="display: none; border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.8rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Seleccione o cree una sucursal</small>
                </div>
                                
                                <!-- Fecha y Hora de Inicio -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 230px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Fecha y Hora <span style="color: #ea0e2a;">*</span></label>
                                    <input type="datetime-local" id="newStartTime" class="form-control" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                
                                <!-- Duraci√≥n -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 150px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Duraci√≥n <span style="color: #ea0e2a;">*</span></label>
                                    <select id="newDuration" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="15">15 minutos</option>
                                        <option value="30">30 minutos</option>
                                        <option value="45">45 minutos</option>
                                        <option value="60" selected>1 hora</option>
                                        <option value="75">1 hora 15 minutos</option>
                                        <option value="90">1 hora 30 minutos</option>
                                        <option value="105">1 hora 45 minutos</option>
                                        <option value="120">2 horas</option>
                                        <option value="135">2 horas 15 minutos</option>
                                        <option value="150">2 horas 30 minutos</option>
                                        <option value="165">2 horas 45 minutos</option>
                                        <option value="180">3 horas</option>
                                        <option value="195">3 horas 15 minutos</option>
                                        <option value="210">3 horas 30 minutos</option>
                                        <option value="225">3 horas 45 minutos</option>
                                        <option value="240">4 horas</option>
                                        <option value="255">4 horas 15 minutos</option>
                                        <option value="270">4 horas 30 minutos</option>
                                        <option value="285">4 horas 45 minutos</option>
                                        <option value="300">5 horas</option>
                                        <option value="315">5 horas 15 minutos</option>
                                        <option value="330">5 horas 30 minutos</option>
                                        <option value="345">5 horas 45 minutos</option>
                                        <option value="360">6 horas</option>
                                        <option value="375">6 horas 15 minutos</option>
                                        <option value="390">6 horas 30 minutos</option>
                                        <option value="405">6 horas 45 minutos</option>
                                        <option value="420">7 horas</option>
                                        <option value="435">7 horas 15 minutos</option>
                                        <option value="450">7 horas 30 minutos</option>
                                        <option value="465">7 horas 45 minutos</option>
                                        <option value="480">8 horas</option>
                                        <option value="540">9 horas</option>
                                        <option value="600">10 horas</option>
                                        <option value="660">11 horas</option>
                                        <option value="720">12 horas</option>
                                    </select>
                                </div>
                                
                                <!-- Ruta -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 120px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Ruta <span style="color: #ea0e2a;">*</span></label>
                                    <select id="newRuta" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="Sin asignar">Sin asignar</option>
                                <option value="Ruta 1">Ruta 1</option>
                                <option value="Ruta 2">Ruta 2</option>
                                <option value="Ruta 3">Ruta 3</option>
                                <option value="Ruta 4">Ruta 4</option>
                                <option value="Ruta 5">Ruta 5</option>
                                <option value="Ruta 6">Ruta 6</option>
                                <option value="Ruta 7">Ruta 7</option>
                                <option value="Ruta 8">Ruta 8</option>
                                <option value="Ruta 9">Ruta 9</option>
                                <option value="Ruta 10">Ruta 10</option>
                                <option value="Ruta 11">Ruta 11</option>
                                <option value="Ruta 12">Ruta 12</option>
                                <option value="Ruta 13">Ruta 13</option>
                                <option value="Ruta 14">Ruta 14</option>
                                <option value="Ruta 15">Ruta 15</option>
                                <option value="Ruta 16">Ruta 16</option>
                                <option value="Ruta 17">Ruta 17</option>
                                <option value="Ruta 18">Ruta 18</option>
                                <option value="Ruta 19">Ruta 19</option>
                                <option value="Ruta 20">Ruta 20</option>
                            </select>
                        </div>
                                
                                <!-- Nombre del Cliente -->
                                <div class="col-12 col-md" style="flex: 1 1 0; min-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Nombre del Cliente</label>
                                    <input type="text" id="newClientName" class="form-control" placeholder="Ingrese el nombre completo" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                    </div>
                                </div>
                                        </div>
                    
                    <!-- Informaci√≥n Adicional (Opcional) -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h6 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Opcional</h6>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Ubicaci√≥n (Opcional) -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <h6 class="mb-2" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif; margin-top: 0.5rem;">Ubicaci√≥n</h6>
                        </div>
                                
                                <!-- Fila 1: Coordenadas, Otras Se√±as, Provincia, Cant√≥n y Distrito en la misma l√≠nea -->
                                <div class="col-12">
                                    <div class="row" style="gap: 0.5rem 0.75rem; margin: 0;">
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Coordenadas (Lat, Lng)</label>
                                            <input type="text" id="newCoordenadas" class="form-control" placeholder="9.838501, -83.866745" pattern="^-?\d+\.?\d*,\s*-?\d+\.?\d*$" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Otras Se√±as</label>
                                            <input type="text" id="newOtrasSenas" class="form-control" placeholder="Ej: 200mts norte del supermercado, casa azul" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Provincia</label>
                                            <select id="newProvincia" class="form-select" disabled readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;">
                                                <option value="">Se detectar√° autom√°ticamente...</option>
                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Cant√≥n</label>
                                            <select id="newCanton" class="form-select" disabled readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;">
                                                <option value="">Se detectar√° autom√°ticamente...</option>
                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Distrito</label>
                                            <select id="newDistrito" class="form-select" disabled readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;">
                                                <option value="">Se detectar√° autom√°ticamente...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fila 2: Link de Ubicaci√≥n y WhatsApp -->
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Link de Ubicaci√≥n (Waze/Google Maps)</label>
                                    <textarea id="newDireccion" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generar√°n autom√°ticamente al ingresar coordenadas"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">WhatsApp</label>
                                    <textarea id="newWhatsApp" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generar√° autom√°ticamente con el tel√©fono"></textarea>
                                </div>
                                
                                <!-- Mapa -->
                                <div class="col-12" style="margin-top: 0.5rem;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Vista del Mapa</label>
                                    <div id="mapaUbicacionNew" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #e0e0e0;"></div>
                                        </div>
                                
                                <!-- Servicios -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                </div>
                                <div class="col-12" style="position: relative; z-index: 1000;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Servicios
                                    </label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1001;">
                                        <input type="text" id="newServicioSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar servicio" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newServiciosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1002 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewServicio" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newServiciosSelected" class="mb-2 mt-2">
                                        <table class="table table-sm table-bordered" id="newServiciosTabla" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="font-size: 0.9rem; font-weight: 600;">Servicio</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Precio (‚Ç°)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="newServiciosTablaBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Plaga -->
                                <div class="col-12" style="position: relative; z-index: 999;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Plaga
                                    </label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1000;">
                                        <input type="text" id="newPlagaSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar plaga" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newPlagasDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1001 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewPlaga" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newPlagasSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                
                                <!-- Estado -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <h6 class="mb-2" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif; margin-top: 0.5rem;">Detalles</h6>
                                    </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Estado</label>
                                    <select id="newStatus" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                <option value="agendada">Agendada</option>
                                <option value="confirmada">Confirmada</option>
                                <option value="completada">Completada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                                
                                <!-- Monto y Costo -->
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Monto de Venta (‚Ç°)</label>
                                    <input type="text" id="newMontoVenta" class="form-control" placeholder="0" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                        </div>

                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Costo del Servicio (‚Ç°)</label>
                                    <input type="text" id="newCostoServicio" class="form-control" placeholder="20000" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.85rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Costo estimado</small>
                                </div>
                                
                                <!-- M√©todo de Pago -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">M√©todo de Pago</label>
                                    <select id="newMetodoPago" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="">Seleccionar m√©todo de pago</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Dat√°fono (tarjeta)">Dat√°fono (tarjeta)</option>
                                        <option value="SINPE">SINPE</option>
                                        <option value="Transferencia bancaria">Transferencia bancaria</option>
                                        <option value="Cuenta por cobrar">Cuenta por cobrar</option>
                                    </select>
                                </div>
                                
                                <!-- N¬∞ Factura -->
                                <div class="col-12" style="margin-top: 0.75rem;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">N¬∞ Factura</label>
                                    <input type="text" id="newNumeroFactura" class="form-control" placeholder="Ingrese el n√∫mero de factura" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                        </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Adicional -->
                    <div class="card mb-2" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; z-index: 1;">
                        <div class="card-header adicional-toggle" id="toggleAdicionalNew" style="background: #fbdc02; border-bottom: 1px solid #e0e0e0; padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <h6 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Adicional</h6>
                                <i class="fas fa-chevron-down icon-expand-pulse" style="font-size: 1.8rem; color: #000000;"></i>
                            </div>
                        </div>
                        <div class="card-body adicional-content" id="contentAdicionalNew" style="padding: 1rem; display: none;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Vendedores
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="newVendedorSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar vendedor" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newVendedoresDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewVendedor" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newVendedoresSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                        </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Productos de Inventario
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="newProductoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar producto" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newProductosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewProducto" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newProductosSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                        </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Equipo y Herramientas
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="newEquipoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar equipo" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newEquipoDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewEquipo" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newEquipoSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-certificate me-1" style="opacity: 0.7;"></i>Certificados de Fumigaci√≥n
                                    </label>
                                    <textarea id="newCertificados" class="form-control" rows="3" placeholder="Ingrese el texto para generar uno o m√°s certificados de fumigaci√≥n. Cada l√≠nea o p√°rrafo generar√° un certificado separado." style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #ffffff; border-radius: 8px; color: #000000;"></textarea>
                                    <small class="d-block mt-1" style="font-size: 0.85rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Cada l√≠nea o p√°rrafo generar√° un certificado separado para la fecha y hora de esta cita</small>
                                    <button type="button" id="btnGenerarCertificadoNew" class="btn mt-2" style="background: #0b7835; color: white; border: none; border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-file-pdf me-2"></i>Generar PDF
                                    </button>
                        </div>
                                <div class="col-12 mb-3">
                                    <div class="card" style="border: 2px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px;">
                                        <div class="card-header" style="background-color: #2c3e50; color: white; border-bottom: 2px solid #34495e; padding: 1rem;">
                                            <h6 class="mb-0" style="color: white; font-weight: 600; font-size: 1.1rem;"><i class="fas fa-calculator me-2"></i>Resumen Financiero</h6>
                    </div>
                                        <div class="card-body" style="background-color: #ffffff; padding: 1.5rem;">
                                            <div class="mb-3" style="background-color: #f8f9fa; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #3498db;">
                                                <small style="color: #7f8c8d; font-size: 0.85rem;"><i class="fas fa-info-circle me-1"></i>Ingresos y Costos de la Cita</small>
                    </div>

                                            <!-- SECCI√ìN DE COSTOS -->
                                            <div class="mb-3">
                                                <h6 style="color: #e74c3c; font-weight: 600; margin-bottom: 0.75rem; font-size: 0.95rem;">
                                                    <i class="fas fa-arrow-down me-1"></i>COSTOS (Egresos)
                                                </h6>
                                                <div class="row" style="background-color: #fff5f5; padding: 0.75rem; border-radius: 6px; margin: 0;">
                                <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Servicios (precio de servicios seleccionados):</span>
                                                            <span id="newTotalServicios" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">‚Ç°0</span>
                    </div>
                                </div>
                                <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Productos (costo de productos √ó cantidad):</span>
                                                            <span id="newTotalProductos" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">‚Ç°0</span>
                                        </div>
                                </div>
                                <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Costo del Servicio (manual):</span>
                                                            <span id="newCostoServicioDisplay" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">‚Ç°0</span>
                                        </div>
                                    </div>
                                                    <div class="col-12 pt-2" style="border-top: 2px solid #e74c3c;">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <strong style="color: #e74c3c; font-size: 1rem;">TOTAL COSTOS:</strong>
                                                            <span id="newTotalCostos" style="color: #e74c3c; font-weight: 700; font-size: 1.1rem;">‚Ç°0</span>
                                </div>
                                                        <small style="color: #7f8c8d; font-size: 0.75rem;">Servicios + Productos + Costo Servicio</small>
                                        </div>
                                                </div>
                                                </div>
                                            
                                            <!-- SECCI√ìN DE INGRESOS -->
                                            <div class="mb-3">
                                                <h6 style="color: #27ae60; font-weight: 600; margin-bottom: 0.75rem; font-size: 0.95rem;">
                                                    <i class="fas fa-arrow-up me-1"></i>INGRESOS
                                                </h6>
                                                <div class="row" style="background-color: #f0fff4; padding: 0.75rem; border-radius: 6px; margin: 0;">
                        <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span style="color: #34495e; font-size: 0.9rem;">Monto de Venta:</span>
                                                            <span id="newMontoVentaDisplay" style="color: #27ae60; font-weight: 700; font-size: 1rem;">‚Ç°0</span>
                                                </div>
                                                </div>
                                                </div>
                        </div>
                                            
                                            <!-- RESULTADO NETO -->
                                            <div class="col-12 pt-3" style="border-top: 3px solid #34495e; background-color: #f8f9fa; padding: 1rem !important; border-radius: 6px; margin-top: 1rem;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong style="color: #2c3e50; font-size: 1.1rem;">GANANCIA NETA:</strong>
                                                    <span id="newNetoVenta" style="font-weight: 700; font-size: 1.3rem;">‚Ç°0</span>
                                                </div>
                                                <small style="color: #7f8c8d; font-size: 0.8rem;">Monto Venta - Total Costos</small>
                    </div>
                </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Descripci√≥n del Servicio
                                    </label>
                                    <textarea id="newDescription" class="form-control" rows="4" placeholder="Detalles adicionales sobre el servicio a realizar..." style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000; resize: vertical;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light" style="display: none;">
                    <!-- Botones movidos al header -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gestionar Servicios -->
    <!-- Modal para Mapa de Ruta del Veh√≠culo -->
    <div class="modal fade" id="modalRutaVehiculo" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important; border-bottom: 2px solid #0d47a1;">
                    <h5 class="modal-title" style="color: #FFFFFF !important; font-weight: 700 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="fas fa-route me-2"></i>Ruta del Veh√≠culo: <span id="rutaVehiculoNombre" style="color: #FFD700 !important; font-weight: 800 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">-</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 0.5rem; background: #f5f7fa;">
                    <div id="mapaRutaVehiculo" style="height: 400px; width: 100%; border-radius: 6px; border: 2px solid #1976D2; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);"></div>
                    <div id="rutaInfo" class="mt-2" style="font-size: 0.85rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Ruteador (T√©cnicos y Veh√≠culos) -->
    <div class="modal fade" id="modalRuteador" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important; border-bottom: 2px solid #2e7d32;">
                    <h5 class="modal-title" style="color: #FFFFFF !important; font-weight: 700 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        <i class="fas fa-users-cog me-2"></i>Asignar T√©cnicos y Veh√≠culos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 1.5rem;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ruta:</label>
                        <div id="ruteadorRutaNombre" class="fw-bold text-primary" style="font-size: 1.1rem;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fecha:</label>
                        <div id="ruteadorFechaNombre" class="text-muted"></div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-2">
                            <i class="fas fa-users me-2"></i>T√©cnicos Asignados
                        </label>
                        <div id="ruteadorTecnicosContainer" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando empleados...
                            </div>
                        </div>
                        <small class="text-muted">Seleccione uno o m√°s t√©cnicos</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold mb-2">
                            <i class="fas fa-truck me-2"></i>Veh√≠culos Asignados
                        </label>
                        <div id="ruteadorVehiculosContainer" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <!-- Los veh√≠culos se generar√°n din√°micamente -->
                        </div>
                        <small class="text-muted">Seleccione uno o m√°s veh√≠culos</small>
                    </div>
                    
                    <div id="ruteadorErrores" class="alert alert-warning" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="window.guardarRuteador()">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Migrar Citas entre Rutas -->
    <div class="modal fade" id="modalMigrarRutas" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Migrar Citas entre Rutas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instrucciones:</strong> Esta herramienta migrar√° todas las citas de la ruta origen a la ruta destino 
                        <strong>solo del d√≠a laborable seleccionado</strong> (5am a 5am del siguiente d√≠a). 
                        Las citas se migrar√°n manteniendo todas sus dem√°s propiedades.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-arrow-left me-2"></i>Ruta Origen <span class="text-danger">*</span>
                            </label>
                            <input type="text" id="rutaOrigenMigrar" class="form-control" readonly>
                            <input type="hidden" id="fechaDiaMigrar" value="">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-arrow-right me-2"></i>Ruta Destino <span class="text-danger">*</span>
                            </label>
                            <select id="rutaDestinoMigrar" class="form-select">
                                <option value="">Seleccionar ruta destino...</option>
                                <option value="Sin asignar">Sin asignar</option>
                                <option value="Ruta 1">Ruta 1</option>
                                <option value="Ruta 2">Ruta 2</option>
                                <option value="Ruta 3">Ruta 3</option>
                                <option value="Ruta 4">Ruta 4</option>
                                <option value="Ruta 5">Ruta 5</option>
                                <option value="Ruta 6">Ruta 6</option>
                                <option value="Ruta 7">Ruta 7</option>
                                <option value="Ruta 8">Ruta 8</option>
                                <option value="Ruta 9">Ruta 9</option>
                                <option value="Ruta 10">Ruta 10</option>
                                <option value="Ruta 11">Ruta 11</option>
                                <option value="Ruta 12">Ruta 12</option>
                                <option value="Ruta 13">Ruta 13</option>
                                <option value="Ruta 14">Ruta 14</option>
                                <option value="Ruta 15">Ruta 15</option>
                                <option value="Ruta 16">Ruta 16</option>
                                <option value="Ruta 17">Ruta 17</option>
                                <option value="Ruta 18">Ruta 18</option>
                                <option value="Ruta 19">Ruta 19</option>
                                <option value="Ruta 20">Ruta 20</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="previewMigracion" class="mt-4" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Vista Previa</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Citas a migrar:</strong> <span id="totalCitasMigrar">0</span></p>
                                <p class="mb-0 text-muted small">Se migrar√°n todas las citas de "<span id="previewRutaOrigen"></span>" a "<span id="previewRutaDestino"></span>"</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnPreviewMigracion" onclick="previewMigracionRutas()">
                        <i class="fas fa-eye me-2"></i>Vista Previa
                    </button>
                    <button type="button" class="btn btn-success" id="btnConfirmarMigracion" onclick="confirmarMigracionRutas()" disabled>
                        <i class="fas fa-check me-2"></i>Confirmar Migraci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGestionarServicios" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Gestionar Servicios</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Formulario para agregar nuevo servicio -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Nuevo Servicio</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-7 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-1"></i>Nombre del Servicio <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="nuevoServicioNombre" class="form-control form-control-modern" placeholder="Ej: Termonebulizaci√≥n">
                                </div>
                                <div class="col-md-5 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-dollar-sign me-1"></i>Precio (‚Ç°) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" id="nuevoServicioPrecio" class="form-control form-control-modern" placeholder="20000" min="0" step="1">
                                </div>
                            </div>
                            <button type="button" id="btnAgregarServicio" class="btn btn-success-modern btn-modern">
                                <i class="fas fa-plus me-2"></i>Agregar Servicio
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de servicios existentes -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Servicios Disponibles</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 5%;">ID</th>
                                            <th style="width: 50%;">Nombre</th>
                                            <th style="width: 30%;">Precio (‚Ç°)</th>
                                            <th style="width: 15%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaServicios">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando servicios...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gestionar Equipo y Herramientas -->
    <div class="modal fade" id="modalGestionarEquipo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-tools me-2"></i>Gestionar Equipo y Herramientas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Formulario para agregar nuevo equipo -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Nuevo Equipo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-1"></i>Nombre del Equipo/Herramienta <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="nuevoEquipoNombre" class="form-control form-control-modern" placeholder="Ej: Termonebulizador port√°til, Bomba de presi√≥n, etc.">
                                </div>
                            </div>
                            <button type="button" id="btnAgregarEquipo" class="btn btn-success-modern btn-modern">
                                <i class="fas fa-plus me-2"></i>Agregar Equipo
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de equipo existente -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Equipo y Herramientas Disponibles</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 5%;">ID</th>
                                            <th style="width: 80%;">Nombre</th>
                                            <th style="width: 15%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaEquipo">
                                        <tr>
                                            <td colspan="3" class="text-center text-muted py-4">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando equipo...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let todasLasCitas = [];
        let citasFiltradas = [];
        let selectedCita = null;
        let currentDate = new Date();
        let diaSeleccionado = new Date();
        let semanaActual = new Date(); // Fecha del lunes de la semana actual en vista compacta
        // Mapas de encuestas:
        // - mapaLinksEncuestas: links generados (encuestas_id) - clave = "telefono_fechaServicio"
        // - mapaRespuestasEncuestas: respuestas recibidas (encuestas) - clave = "id_encuesta"
        // - mapaJustificacionesSinEncuesta: justificaciones de citas sin encuesta - clave = "cita_id"
        let mapaLinksEncuestas = new Map();
        let mapaRespuestasEncuestas = new Map();
        let mapaJustificacionesSinEncuesta = new Map();
        let vistaActual = 'cronograma';

        // Funci√≥n global para formatear fecha
        window.formatearFecha = function(timestamp) {
            if (!timestamp) return null;
            const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return fecha;
        };
        
        // Alias para uso dentro del m√≥dulo
        const formatearFecha = window.formatearFecha;

        // ========== GESTI√ìN DE UBICACIONES (PROVINCIA, CANT√ìN, DISTRITO) - Funciones de llenado ==========
        // Llenar selector de provincias en modal de edici√≥n
        function llenarProvinciasEdit() {
            const selectProvincia = document.getElementById('editProvincia');
            if (!selectProvincia || !window.ubicacionesCR) return;
            
            selectProvincia.innerHTML = '<option value="">Seleccionar provincia...</option>';
            
            Object.values(window.ubicacionesCR).forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia.id;
                option.textContent = provincia.nombre;
                selectProvincia.appendChild(option);
            });
        }
        
        // Llenar selector de cantones seg√∫n provincia seleccionada (edici√≥n)
        function llenarCantonesEdit(provinciaId) {
            const selectCanton = document.getElementById('editCanton');
            const selectDistrito = document.getElementById('editDistrito');
            
            if (!selectCanton || !window.ubicacionesCR || !provinciaId) {
                if (selectCanton) {
                    selectCanton.innerHTML = '<option value="">Primero seleccione una provincia</option>';
                    selectCanton.disabled = true;
                }
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">Primero seleccione un cant√≥n</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones) {
                if (selectCanton) {
                    selectCanton.innerHTML = '<option value="">No hay cantones disponibles</option>';
                    selectCanton.disabled = true;
                }
                return;
            }
            
            selectCanton.innerHTML = '<option value="">Seleccionar cant√≥n...</option>';
            
            Object.values(provincia.cantones).forEach(canton => {
                const option = document.createElement('option');
                option.value = canton.id;
                option.textContent = canton.nombre;
                selectCanton.appendChild(option);
            });
            
            selectCanton.disabled = false;
            
            // Limpiar distritos
            if (selectDistrito) {
                selectDistrito.innerHTML = '<option value="">Primero seleccione un cant√≥n</option>';
                selectDistrito.disabled = true;
            }
        }
        
        // Llenar selector de distritos seg√∫n cant√≥n seleccionado (edici√≥n)
        function llenarDistritosEdit(provinciaId, cantonId) {
            const selectDistrito = document.getElementById('editDistrito');
            
            if (!selectDistrito || !window.ubicacionesCR || !provinciaId || !cantonId) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">Primero seleccione un cant√≥n</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones || !provincia.cantones[cantonId]) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">No hay distritos disponibles</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const canton = provincia.cantones[cantonId];
            if (!canton || !canton.distritos) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">No hay distritos disponibles</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            selectDistrito.innerHTML = '<option value="">Seleccionar distrito...</option>';
            
            Object.values(canton.distritos).forEach(distrito => {
                const option = document.createElement('option');
                option.value = distrito.id;
                option.textContent = distrito.nombre;
                selectDistrito.appendChild(option);
            });
            
            selectDistrito.disabled = false;
        }
        
        // Actualizar mapa de ubicaci√≥n en modal de edici√≥n
        // Actualizar mapa seg√∫n ubicaci√≥n seleccionada (COPIADO EXACTAMENTE de citas_registradas.html)
        async function actualizarMapaUbicacionEdit(provinciaId, cantonId, distritoId) {
            console.log('üîç actualizarMapaUbicacionEdit llamado con:', { provinciaId, cantonId, distritoId });
            
            // Verificar que el mapa est√© inicializado y sea v√°lido
            const contenedor = document.getElementById('mapaUbicacionEdit');
            
            // Usar la variable global
            mapaUbicacionEdit = window.mapaUbicacionEdit;
            
            if (!mapaUbicacionEdit || typeof mapaUbicacionEdit.setView !== 'function' || typeof mapaUbicacionEdit.invalidateSize !== 'function') {
                console.warn('‚ö†Ô∏è Mapa no est√° inicializado o no es v√°lido', {
                    tieneMapa: !!mapaUbicacionEdit,
                    tipo: typeof mapaUbicacionEdit,
                    tieneSetView: mapaUbicacionEdit ? typeof mapaUbicacionEdit.setView : 'N/A',
                    tieneLeafletId: contenedor ? !!contenedor._leaflet_id : false
                });
                // Si el mapa no est√° inicializado, intentar inicializarlo
                if (!mapaUbicacionEdit) {
                    inicializarMapaEdit();
                }
                // Esperar un momento y reintentar
                setTimeout(() => actualizarMapaUbicacionEdit(provinciaId, cantonId, distritoId), 500);
                return;
            }
            
            if (!ubicacionesCR) {
                console.warn('‚ö†Ô∏è ubicacionesCR no est√° cargado');
                return;
            }
            
            // Asegurar que el mapa tenga el tama√±o correcto
            setTimeout(() => {
                if (mapaUbicacionEdit && typeof mapaUbicacionEdit.invalidateSize === 'function') {
                    mapaUbicacionEdit.invalidateSize();
                }
            }, 50);
            
            let ubicacionTexto = '';
            
            // Priorizar: Distrito > Cant√≥n > Provincia (m√°s espec√≠fico primero)
            if (provinciaId && ubicacionesCR[provinciaId]) {
                const provinciaNombre = ubicacionesCR[provinciaId].nombre;
                let cantonNombre = '';
                let distritoNombre = '';
                
                if (cantonId && ubicacionesCR[provinciaId].cantones && ubicacionesCR[provinciaId].cantones[cantonId]) {
                    cantonNombre = ubicacionesCR[provinciaId].cantones[cantonId].nombre;
                    
                    if (distritoId && ubicacionesCR[provinciaId].cantones[cantonId].distritos && ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                        distritoNombre = ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre;
                    }
                }
                
                // Construir b√∫squeda priorizando distrito
                if (distritoNombre) {
                    ubicacionTexto = `${distritoNombre}, ${cantonNombre}, ${provinciaNombre}`;
                } else if (cantonNombre) {
                    ubicacionTexto = `${cantonNombre}, ${provinciaNombre}`;
                } else {
                    ubicacionTexto = provinciaNombre;
                }
            }
            
            console.log('üìç Ubicaci√≥n texto construido:', ubicacionTexto);
            
            if (!ubicacionTexto) {
                console.warn('‚ö†Ô∏è No hay texto de ubicaci√≥n, centrando en Costa Rica');
                // Si no hay ubicaci√≥n, mostrar centro de Costa Rica
                mapaUbicacionEdit.setView([9.7489, -83.7534], 8);
                if (window.marcadorUbicacionEdit) {
                    mapaUbicacionEdit.removeLayer(window.marcadorUbicacionEdit);
                    window.marcadorUbicacionEdit = null;
                    marcadorUbicacionEdit = null;
                }
                return;
            }
            
            // Geocodificar la ubicaci√≥n usando Nominatim (OpenStreetMap)
            // Priorizar distrito con m√∫ltiples intentos de b√∫squeda
            try {
                let data = null;
                let queryUsado = '';
                
                // Extraer nombres individuales para b√∫squedas progresivas
                const partes = ubicacionTexto.split(', ');
                const distritoNombre = partes[0];
                const cantonNombre = partes.length > 1 ? partes[1] : '';
                const provinciaNombre = partes.length > 2 ? partes[2] : '';
                
                // Intentar b√∫squedas progresivas, priorizando distrito
                const queries = [];
                
                // 1. Solo distrito + cant√≥n (m√°xima jerarqu√≠a al distrito)
                if (distritoNombre && cantonNombre) {
                    queries.push(`${distritoNombre}, ${cantonNombre}, Costa Rica`);
                }
                
                // 2. Solo distrito (m√°xima especificidad)
                if (distritoNombre) {
                    queries.push(`${distritoNombre}, Costa Rica`);
                }
                
                // 3. Distrito + cant√≥n + provincia (fallback)
                if (distritoNombre && cantonNombre && provinciaNombre) {
                    queries.push(`${distritoNombre}, ${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                }
                
                // 4. Cant√≥n + provincia (si no hay distrito)
                if (!distritoNombre && cantonNombre && provinciaNombre) {
                    queries.push(`${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                }
                
                // 5. Solo provincia (√∫ltimo recurso)
                if (!distritoNombre && !cantonNombre && provinciaNombre) {
                    queries.push(`${provinciaNombre}, Costa Rica`);
                }
                
                // Intentar cada query hasta encontrar resultados
                for (const query of queries) {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                    const result = await response.json();
                    
                    if (result && result.length > 0) {
                        data = result;
                        queryUsado = query;
                        break;
                    }
                }
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    // Centrar mapa en la ubicaci√≥n
                    mapaUbicacionEdit.setView([lat, lon], 13);
                    
                    // Invalidar tama√±o antes de agregar marcador
                    mapaUbicacionEdit.invalidateSize();
                    
                // Remover marcador anterior si existe
                if (window.marcadorUbicacionEdit) {
                    mapaUbicacionEdit.removeLayer(window.marcadorUbicacionEdit);
                }
                
                // Agregar nuevo marcador
                window.marcadorUbicacionEdit = L.marker([lat, lon]).addTo(mapaUbicacionEdit);
                marcadorUbicacionEdit = window.marcadorUbicacionEdit; // Sincronizar alias local
                window.marcadorUbicacionEdit.bindPopup(`<b>${ubicacionTexto}</b>`).openPopup();
                    
                    // Invalidar tama√±o nuevamente despu√©s de agregar marcador
                    setTimeout(() => {
                        mapaUbicacionEdit.invalidateSize();
                    }, 100);
                    
                    console.log('‚úÖ Mapa actualizado para:', ubicacionTexto, '(b√∫squeda:', queryUsado, ')');
                } else {
                    console.warn('‚ö†Ô∏è No se encontr√≥ ubicaci√≥n para:', ubicacionTexto);
                }
            } catch (error) {
                console.error('‚ùå Error geocodificando ubicaci√≥n:', error);
            }
        }

        // Funci√≥n global para abrir modal de edici√≥n
        async function abrirModalEdicion(citaId) {
            console.log('üîç ===== INICIANDO abrirModalEdicion =====');
            console.log('üîç Cita ID recibido:', citaId);
            console.log('üîç Tipo de citaId:', typeof citaId);
            console.log('üìä window.todasLasCitas existe:', !!window.todasLasCitas);
            console.log('üìä window.todasLasCitas es array:', Array.isArray(window.todasLasCitas));
            console.log('üìä Total de citas disponibles:', window.todasLasCitas ? window.todasLasCitas.length : 0);
            
            if (window.todasLasCitas && window.todasLasCitas.length > 0) {
                console.log('üìã Primeras 3 citas:', window.todasLasCitas.slice(0, 3).map(c => ({ id: c.id, cliente: window.obtenerClienteNombre ? window.obtenerClienteNombre(c) : 'N/A' })));
            }
            
            // Buscar la cita en las variables globales
            const cita = window.todasLasCitas ? window.todasLasCitas.find(c => c.id === citaId) : null;
            
            console.log('üîç B√∫squeda de cita - resultado:', cita ? 'ENCONTRADA' : 'NO ENCONTRADA');
            
            if (!cita) {
                console.error('‚ùå Cita no encontrada:', citaId);
                console.log('üîç IDs disponibles:', window.todasLasCitas ? window.todasLasCitas.map(c => c.id) : 'No hay citas');
                console.log('üîç Comparaci√≥n exacta de IDs:');
                if (window.todasLasCitas) {
                    window.todasLasCitas.forEach((c, index) => {
                        console.log(`  [${index}] ID: "${c.id}" (tipo: ${typeof c.id}) === "${citaId}" (tipo: ${typeof citaId}) = ${c.id === citaId}`);
                    });
                }
                alert('Error: No se pudo encontrar la cita seleccionada');
                return;
            }
            
            console.log('‚úÖ Cita encontrada:', cita);
            // Usar versi√≥n s√≠ncrona para logging
            const nombreClienteLog = window.obtenerClienteNombreSync ? window.obtenerClienteNombreSync(cita) : 'N/A';
            console.log('‚úÖ Cliente:', nombreClienteLog);
            console.log('‚úÖ Veh√≠culo:', window.obtenerVehiculo ? window.obtenerVehiculo(cita) : 'N/A');
            
            // Asignar a variable global
            window.selectedCita = cita;
            selectedCita = cita;
            
            // Verificar que las funciones helper est√©n disponibles
            if (!window.obtenerClienteNombre) {
                console.error('‚ùå Funciones helper no est√°n disponibles a√∫n');
                alert('Error: Las funciones helper no est√°n cargadas. Por favor, recarga la p√°gina.');
                return;
            }
            
            // Llenar el formulario con todos los datos
            // Obtener nombre del cliente desde el documento del cliente (source of truth)
            const telefonoCita = window.obtenerTelefono(cita);
            let nombreCliente = 'Sin nombre';
            if (telefonoCita) {
                const cliente = await window.buscarCliente(telefonoCita);
                if (cliente && cliente.nombre) {
                    nombreCliente = cliente.nombre;
                } else {
                    // Fallback: usar nombre guardado en la cita (compatibilidad con datos antiguos)
                    nombreCliente = window.obtenerClienteNombreSync(cita);
                }
            } else {
                nombreCliente = window.obtenerClienteNombreSync(cita);
            }
            document.getElementById('editClientName').value = nombreCliente;
            
            // Tel√©fono: mostrar solo 8 d√≠gitos (sin 506)
            const telefonoActual = window.obtenerTelefono(cita);
            const telefonoSin506 = telefonoActual && telefonoActual.startsWith('506') ? telefonoActual.substring(3) : (telefonoActual || '');
            document.getElementById('editClientPhone').value = telefonoSin506;
            
            // Actualizar display del tel√©fono
            const phoneDisplay = document.getElementById('editPhoneDisplay');
            if (phoneDisplay && telefonoActual) {
                phoneDisplay.textContent = window.formatearTelefono(telefonoActual);
            }
            
            // Generar link de WhatsApp
            const editWhatsApp = document.getElementById('editWhatsApp');
            if (editWhatsApp && telefonoActual) {
                editWhatsApp.value = window.generarLinkWhatsApp(telefonoActual, 'Hola desde Ecoplagas');
            }
            
            // Cargar sucursales del cliente
            if (telefonoActual) {
                const sucursalIndice = cita.metadata?.sucursalIndice;
                await window.cargarSucursalesEnSelect('editSucursal', telefonoActual, sucursalIndice);
                
                // Si hay sucursal seleccionada, pre-llenar datos
                if (sucursalIndice) {
                    const sucursal = await window.obtenerSucursalPorIndice(telefonoActual, sucursalIndice);
                    if (sucursal) {
                        // Pre-llenar nombre de sucursal si existe
                        const editNombreSucursal = document.getElementById('editNombreSucursal');
                        if (editNombreSucursal) {
                            editNombreSucursal.value = sucursal.nombre;
                        }
                        // Pre-llenar coordenadas y ubicaci√≥n
                        if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                            const coordsTexto = `${sucursal.coordenadas.lat}, ${sucursal.coordenadas.lng}`;
                            document.getElementById('editCoordenadas').value = coordsTexto;
                            if (window.procesarCoordenadasEdit) {
                                await window.procesarCoordenadasEdit(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
                            }
                        }
                        if (sucursal.provinciaId) document.getElementById('editProvincia').value = sucursal.provinciaId;
                        if (sucursal.cantonId) document.getElementById('editCanton').value = sucursal.cantonId;
                        if (sucursal.distritoId) document.getElementById('editDistrito').value = sucursal.distritoId;
                        if (sucursal.direccion) document.getElementById('editDireccion').value = sucursal.direccion;
                        if (sucursal.otrasSenas) document.getElementById('editOtrasSenas').value = sucursal.otrasSenas;
                    }
                }
            }
            
            const montoVenta = window.obtenerMonto(cita) || 0;
            const montoVentaFormateado = window.formatearMontoVenta(montoVenta);
            document.getElementById('editMontoVenta').value = montoVentaFormateado;
            
            // Costo del Servicio
            const costoServicio = window.obtenerCostoServicio(cita) || 20000;
            const costoServicioFormateado = window.formatearMontoVenta(costoServicio);
            document.getElementById('editCostoServicio').value = costoServicioFormateado;
            
            // M√©todo de Pago
            const metodoPago = cita.metadata?.metodoPago || '';
            const editMetodoPago = document.getElementById('editMetodoPago');
            if (editMetodoPago) {
                editMetodoPago.value = metodoPago;
            }
            
            // N¬∞ Factura
            const numeroFactura = cita.metadata?.numeroFactura || '';
            const editNumeroFactura = document.getElementById('editNumeroFactura');
            if (editNumeroFactura) {
                editNumeroFactura.value = numeroFactura;
            }
            
            // Ruta: incluir "Sin asignar" si aplica
            const rutaActual = window.obtenerRuta(cita);
            document.getElementById('editRuta').value = rutaActual || 'Sin asignar';
            
            document.getElementById('editStatus').value = window.obtenerEstado(cita);
            
            // Fecha y hora: convertir correctamente desde GMT-06
            const fechaInicio = window.formatearFecha(window.obtenerInicio(cita));
            if (fechaInicio) {
                // El timestamp ya est√° en GMT-06, solo necesitamos formatearlo para datetime-local
                const year = fechaInicio.getFullYear();
                const month = String(fechaInicio.getMonth() + 1).padStart(2, '0');
                const day = String(fechaInicio.getDate()).padStart(2, '0');
                const hours = String(fechaInicio.getHours()).padStart(2, '0');
                const minutes = String(fechaInicio.getMinutes()).padStart(2, '0');
                
                const fechaFormateada = `${year}-${month}-${day}T${hours}:${minutes}`;
                console.log('üîç Fecha original (GMT-06):', window.obtenerInicio(cita));
                console.log('üîç Fecha convertida (local):', fechaFormateada);
                document.getElementById('editStartTime').value = fechaFormateada;
            } else {
                // Si no hay fecha, usar la fecha actual
                const ahora = new Date();
                const year = ahora.getFullYear();
                const month = String(ahora.getMonth() + 1).padStart(2, '0');
                const day = String(ahora.getDate()).padStart(2, '0');
                const hours = String(ahora.getHours()).padStart(2, '0');
                const minutes = String(ahora.getMinutes()).padStart(2, '0');
                document.getElementById('editStartTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            // Duraci√≥n: seleccionar la opci√≥n m√°s cercana
            const duracionCita = window.obtenerDuracion(cita) || 60;
            const opcionesDuracion = [15, 30, 45, 60, 75, 90, 105, 120, 180, 240, 300, 360, 420, 480];
            let duracionSeleccionada = 60; // Valor por defecto
            // Encontrar la opci√≥n m√°s cercana
            for (let i = 0; i < opcionesDuracion.length; i++) {
                if (duracionCita <= opcionesDuracion[i]) {
                    duracionSeleccionada = opcionesDuracion[i];
                    break;
                }
            }
            // Si es mayor a 480, usar 480
            if (duracionCita > 480) {
                duracionSeleccionada = 480;
            }
            document.getElementById('editDuration').value = duracionSeleccionada;
            
            // Vendedores: cargar empleados y inicializar b√∫squeda
            if (!window.empleados || window.empleados.length === 0) {
                await window.cargarEmpleados();
            }
            const vendedores = window.obtenerVendedores(cita);
            window.vendedoresSeleccionadosEdit = Array.isArray(vendedores) ? [...vendedores] : [];
            // Renderizar badges de vendedores seleccionados
            const editVendedoresSelected = document.getElementById('editVendedoresSelected');
            if (editVendedoresSelected) {
                editVendedoresSelected.innerHTML = '';
                window.vendedoresSeleccionadosEdit.forEach(username => {
                    const empleado = window.empleados.find(e => (e.username || e.id) === username);
                    const nombre = empleado ? `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() : username;
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary me-1 mb-1';
                    badge.setAttribute('data-username', username);
                    badge.innerHTML = `${nombre} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
                    badge.querySelector('i').addEventListener('click', () => {
                        const index = window.vendedoresSeleccionadosEdit.indexOf(username);
                        if (index > -1) window.vendedoresSeleccionadosEdit.splice(index, 1);
                        badge.remove();
                    });
                    editVendedoresSelected.appendChild(badge);
                });
            }
            if (window.inicializarBusquedaVendedores) {
                window.inicializarBusquedaVendedores('edit');
            }
            
            // Servicios: cargar servicios y inicializar b√∫squeda
            if (!window.todosLosServicios || window.todosLosServicios.length === 0) {
                await window.cargarServicios();
            }
            const servicios = window.obtenerServicios(cita);
            // Convertir servicios a formato de objetos {id, precio}
            // Si vienen como strings (IDs), usar precio del servicio base
            // Si vienen como objetos {id, precio}, mantener el precio personalizado
            window.serviciosSeleccionadosEdit = Array.isArray(servicios) ? servicios.map(serv => {
                if (typeof serv === 'string') {
                    // Es un ID simple, usar precio del servicio base
                    const servicio = window.todosLosServicios.find(s => s.id === serv);
                    return {
                        id: serv,
                        precio: servicio?.precio || 0
                    };
                } else if (typeof serv === 'object' && serv.id) {
                    // Ya es un objeto con id y posiblemente precio
                    const servicio = window.todosLosServicios.find(s => s.id === serv.id);
                    return {
                        id: serv.id,
                        precio: serv.precio !== undefined ? serv.precio : (servicio?.precio || 0)
                    };
                }
                return null;
            }).filter(s => s !== null) : [];
            
            // Renderizar tabla de servicios
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('edit');
            }
            if (window.inicializarBusquedaServicios) {
                window.inicializarBusquedaServicios('edit');
            }
            
            // Plagas: cargar plagas seleccionadas
            const plagas = cita.metadata?.plagas || [];
            window.plagasSeleccionadasEdit = Array.isArray(plagas) ? [...plagas] : [];
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('edit');
            }
            
            // Productos: cargar productos y inicializar b√∫squeda
            if (!window.todosLosProductos || window.todosLosProductos.length === 0) {
                await window.cargarProductos();
            }
            const productos = window.obtenerProductos(cita);
            window.productosSeleccionadosEdit = Array.isArray(productos) ? [...productos] : [];
            const editProductosSelected = document.getElementById('editProductosSelected');
            if (editProductosSelected) {
                editProductosSelected.innerHTML = '';
                window.productosSeleccionadosEdit.forEach(productoId => {
                    const producto = window.todosLosProductos.find(p => p.id === productoId);
                    if (!producto) return;
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-info me-1 mb-1';
                    badge.setAttribute('data-producto-id', productoId);
                    badge.innerHTML = `${producto.nombre} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
                    badge.querySelector('i').addEventListener('click', () => {
                        const index = window.productosSeleccionadosEdit.indexOf(productoId);
                        if (index > -1) window.productosSeleccionadosEdit.splice(index, 1);
                        badge.remove();
                    });
                    editProductosSelected.appendChild(badge);
                });
            }
            if (window.inicializarBusquedaProductos) {
                window.inicializarBusquedaProductos('edit');
            }
            
            // Equipo: cargar equipo y inicializar b√∫squeda
            if (!window.todosLosEquipos || window.todosLosEquipos.length === 0) {
                await window.cargarEquipo();
            }
            const equipo = window.obtenerEquipo(cita);
            window.equipoSeleccionadoEdit = Array.isArray(equipo) ? [...equipo] : [];
            const editEquipoSelected = document.getElementById('editEquipoSelected');
            if (editEquipoSelected) {
                editEquipoSelected.innerHTML = '';
                window.equipoSeleccionadoEdit.forEach(equipoId => {
                    const equipoItem = window.todosLosEquipos.find(e => e.id === equipoId);
                    if (!equipoItem) return;
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-info me-1 mb-1';
                    badge.setAttribute('data-equipo-id', equipoId);
                    badge.innerHTML = `${equipoItem.nombre} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
                    badge.querySelector('i').addEventListener('click', () => {
                        const index = window.equipoSeleccionadoEdit.indexOf(equipoId);
                        if (index > -1) window.equipoSeleccionadoEdit.splice(index, 1);
                        badge.remove();
                    });
                    editEquipoSelected.appendChild(badge);
                });
            }
            if (window.inicializarBusquedaEquipo) {
                window.inicializarBusquedaEquipo('edit');
            }
            
            // Certificados: cargar texto de certificados
            const certificadosTexto = window.obtenerCampoCita(cita, 'certificados', '');
            const editCertificados = document.getElementById('editCertificados');
            if (editCertificados) {
                editCertificados.value = certificadosTexto;
            }
            
            // Ubicaci√≥n: cargar ubicaciones si no est√°n cargadas
            if (!window.ubicacionesCR) {
                await cargarUbicaciones();
            }
            
            // Cargar direcci√≥n (link de Waze/Google Maps)
            const direccionLink = cita.metadata?.direccion || '';
            document.getElementById('editDireccion').value = direccionLink || '';
            
            // Cargar coordenadas
            // Primero intentar obtener desde sucursal, luego fallback para citas antiguas
            let coordenadas = null;
            const sucursalIndice = cita.metadata?.sucursalIndice;
            // Obtener tel√©fono desde la fuente de verdad (cita.telefono)
            const clienteTelefono = window.obtenerTelefono(cita);
            
            // Si hay sucursal, obtener coordenadas desde la sucursal (source of truth)
            if (window.esSucursalIndiceValido(sucursalIndice) && clienteTelefono) {
                try {
                    const sucursal = await window.obtenerSucursalPorIndice(clienteTelefono, sucursalIndice);
                    if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                        coordenadas = sucursal.coordenadas;
                    }
                } catch (error) {
                    console.warn('Error obteniendo coordenadas desde sucursal:', error);
                }
            }
            
            // Fallback para citas antiguas que a√∫n tienen coordenadas en metadata (compatibilidad)
            if (!coordenadas && window.sonCoordenadasValidas(cita.metadata?.coordenadas)) {
                coordenadas = cita.metadata.coordenadas;
            }
            
            let lat = null;
            let lng = null;
            if (coordenadas && coordenadas.texto) {
                document.getElementById('editCoordenadas').value = coordenadas.texto;
                // Parsear coordenadas del texto
                const match = coordenadas.texto.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            } else if (window.sonCoordenadasValidas(coordenadas)) {
                lat = coordenadas.lat;
                lng = coordenadas.lng;
                document.getElementById('editCoordenadas').value = `${lat}, ${lng}`;
            } else {
                document.getElementById('editCoordenadas').value = '';
            }
            
            // Cargar otras se√±as
            // otras_se√±as puede estar escrito con gui√≥n bajo o sin gui√≥n
            const otrasSenas = cita.metadata?.otras_se√±as || cita.metadata?.otras_senas || '';
            document.getElementById('editOtrasSenas').value = otrasSenas || '';
            
            // Si la cita tiene datos de ubicaci√≥n estructurados, cargarlos
            // Esto asume que la cita puede tener: provinciaId, cantonId, distritoId
            // o que la direcci√≥n contiene la informaci√≥n parseable
            const provinciaId = window.obtenerCampoCita(cita, 'provinciaId', null);
            const cantonId = window.obtenerCampoCita(cita, 'cantonId', null);
            const distritoId = window.obtenerCampoCita(cita, 'distritoId', null);
            
            // Si hay coordenadas, procesarlas para renderizar el mapa
            if (lat && lng) {
                // Funci√≥n para procesar coordenadas despu√©s de que el modal est√© visible y el mapa inicializado
                const procesarCoordenadasCuandoListo = () => {
                    const intentarProcesar = (intentos = 0) => {
                        if (intentos > 20) {
                            console.warn('‚ö†Ô∏è No se pudo procesar coordenadas despu√©s de varios intentos');
                            return;
                        }
                        
                        // Verificar que el mapa est√© inicializado
                        if (!window.mapaUbicacionEdit || typeof window.mapaUbicacionEdit.setView !== 'function') {
                            setTimeout(() => intentarProcesar(intentos + 1), 300);
                            return;
                        }
                        
                        // Procesar coordenadas para renderizar mapa
                        if (window.procesarCoordenadasEdit && typeof window.procesarCoordenadasEdit === 'function') {
                            window.procesarCoordenadasEdit(lat, lng).then(() => {
                                console.log('‚úÖ Coordenadas procesadas y mapa renderizado');
                            }).catch(error => {
                                console.error('‚ùå Error procesando coordenadas:', error);
                            });
                        } else {
                            console.warn('‚ö†Ô∏è Funci√≥n procesarCoordenadasEdit no est√° disponible');
                        }
                    };
                    
                    // Esperar a que el modal est√© completamente visible
                    const modal = document.getElementById('editCitaModal');
                    if (modal) {
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance && modalInstance._isShown) {
                            // El modal ya est√° visible, esperar un momento para que el mapa se inicialice
                            setTimeout(() => intentarProcesar(), 1000);
                        } else {
                            // Esperar a que el modal se muestre
                            modal.addEventListener('shown.bs.modal', function procesarCoordsOnShow() {
                                modal.removeEventListener('shown.bs.modal', procesarCoordsOnShow);
                                // Esperar m√°s tiempo para que el mapa se inicialice completamente
                                setTimeout(() => intentarProcesar(), 1000);
                            }, { once: true });
                        }
                    }
                };
                
                procesarCoordenadasCuandoListo();
            }
            
       // Funci√≥n para actualizar el mapa despu√©s de que el modal est√© visible
       const actualizarMapaCuandoVisible = () => {
           // Funci√≥n auxiliar para verificar y actualizar el mapa
           const intentarActualizarMapa = (intentos = 0) => {
               if (intentos > 20) {
                   console.warn('‚ö†Ô∏è No se pudo inicializar el mapa despu√©s de varios intentos');
                   return;
               }
               
               // Verificar que el mapa est√© inicializado y sea v√°lido (usar variable local)
               if (!mapaUbicacionEdit || typeof mapaUbicacionEdit.setView !== 'function' || typeof mapaUbicacionEdit.invalidateSize !== 'function') {
                   console.log(`‚ö†Ô∏è Mapa no listo (intento ${intentos + 1}/20), esperando...`, {
                       tieneMapa: !!mapaUbicacionEdit,
                       tipo: typeof mapaUbicacionEdit,
                       tieneSetView: mapaUbicacionEdit ? typeof mapaUbicacionEdit.setView : 'N/A'
                   });
                   setTimeout(() => intentarActualizarMapa(intentos + 1), 300);
                   return;
               }
               
               // El mapa est√° listo, mostrar pol√≠gonos seg√∫n la selecci√≥n
               console.log('‚úÖ Mapa listo, mostrando pol√≠gonos...', { provinciaId, cantonId, distritoId });
               if (provinciaId && cantonId && distritoId) {
                   if (window.mostrarDistritoSeleccionado) {
                       window.mostrarDistritoSeleccionado(provinciaId, cantonId, distritoId);
                   }
               } else if (provinciaId && cantonId) {
                   if (window.mostrarDistritosCanton) {
                       window.mostrarDistritosCanton(provinciaId, cantonId);
                   }
               } else if (provinciaId) {
                   if (window.mostrarCantonesProvincia) {
                       window.mostrarCantonesProvincia(provinciaId);
                   }
               }
           };
           
           // Esperar a que el modal est√© completamente visible
           const modal = document.getElementById('editCitaModal');
           if (modal) {
               const modalInstance = bootstrap.Modal.getInstance(modal);
               if (modalInstance && modalInstance._isShown) {
                   // El modal ya est√° visible, esperar m√°s tiempo para que el mapa se inicialice
                   setTimeout(() => intentarActualizarMapa(), 800);
               } else {
                   // Esperar a que el modal se muestre
                   modal.addEventListener('shown.bs.modal', function actualizarMapaOnShow() {
                       modal.removeEventListener('shown.bs.modal', actualizarMapaOnShow);
                       // Esperar m√°s tiempo para que el mapa se inicialice completamente
                       setTimeout(() => intentarActualizarMapa(), 800);
                   }, { once: true });
               }
           }
       };
            
            if (provinciaId && window.ubicacionesCR) {
                document.getElementById('editProvincia').value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                if (cantonId) {
                    // Esperar un momento para que se carguen los cantones
                    setTimeout(() => {
                        document.getElementById('editCanton').value = cantonId;
                        llenarDistritosEdit(provinciaId, cantonId);
                        
                        if (distritoId) {
                            setTimeout(() => {
                                document.getElementById('editDistrito').value = distritoId;
                                // Actualizar mapa despu√©s de cargar todos los valores
                                actualizarMapaCuandoVisible();
                            }, 150);
                        } else {
                            actualizarMapaCuandoVisible();
                        }
                    }, 150);
                } else {
                    actualizarMapaCuandoVisible();
                }
            } else if (provinciaId) {
                // Si hay provincia pero no hay ubicacionesCR cargadas, esperar
                console.log('‚ö†Ô∏è Ubicaciones CR no cargadas a√∫n, esperando...');
                const checkUbicaciones = setInterval(() => {
                    if (window.ubicacionesCR) {
                        clearInterval(checkUbicaciones);
                        document.getElementById('editProvincia').value = provinciaId;
                        llenarCantonesEdit(provinciaId);
                        if (cantonId) {
                            setTimeout(() => {
                                document.getElementById('editCanton').value = cantonId;
                                llenarDistritosEdit(provinciaId, cantonId);
                                if (distritoId) {
                                    setTimeout(() => {
                                        document.getElementById('editDistrito').value = distritoId;
                                        actualizarMapaCuandoVisible();
                                    }, 150);
                                } else {
                                    actualizarMapaCuandoVisible();
                                }
                            }, 150);
                        } else {
                            actualizarMapaCuandoVisible();
                        }
                    }
                }, 100);
                // Timeout despu√©s de 5 segundos
                setTimeout(() => clearInterval(checkUbicaciones), 5000);
            }
            
            // Agregar event listeners para actualizar resumen financiero
            const serviciosContainer = document.getElementById('editServiciosContainer');
            if (serviciosContainer) {
                serviciosContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        window.actualizarResumenFinanciero();
                    }
                });
            }
            
            const montoVentaInput = document.getElementById('editMontoVenta');
            if (montoVentaInput) {
                // Formatear cuando se presiona Enter o se pierde el foco
                montoVentaInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const valorNumerico = window.extraerValorNumerico(montoVentaInput.value);
                        montoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                        montoVentaInput.blur();
                    }
                });
                montoVentaInput.addEventListener('blur', () => {
                    const valorNumerico = window.extraerValorNumerico(montoVentaInput.value);
                    montoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                });
                montoVentaInput.addEventListener('input', () => {
                    window.actualizarResumenFinanciero();
                });
            }
            
            const costoServicioInput = document.getElementById('editCostoServicio');
            if (costoServicioInput) {
                // Formatear cuando se presiona Enter o se pierde el foco
                costoServicioInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const valorNumerico = window.extraerValorNumerico(costoServicioInput.value);
                        costoServicioInput.value = window.formatearMontoVenta(valorNumerico);
                        costoServicioInput.blur();
                    }
                });
                costoServicioInput.addEventListener('blur', () => {
                    const valorNumerico = window.extraerValorNumerico(costoServicioInput.value);
                    costoServicioInput.value = window.formatearMontoVenta(valorNumerico);
                });
                costoServicioInput.addEventListener('input', () => {
                    window.actualizarResumenFinanciero();
                });
            }
            
            // Actualizar resumen financiero inicial
            setTimeout(() => {
                window.actualizarResumenFinanciero();
            }, 100);
            
            // Obtener descripci√≥n/observaciones
            const descripcion = window.obtenerDescripcion(cita);
            console.log('üîç Descripci√≥n obtenida:', descripcion);
            console.log('üîç Cita completa:', cita);
            console.log('üîç metadata:', cita.metadata);
            console.log('üîç metadata.observaciones:', cita.metadata?.observaciones);
            document.getElementById('editDescription').value = descripcion || '';

            // Resetear bot√≥n antes de abrir modal
            const btnSave = document.getElementById('btnSaveCitaTop');
            if (btnSave) {
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';
                console.log('üîß Bot√≥n reseteado al abrir modal');
            }

            // Mostrar el modal
            console.log('üîç ===== INTENTANDO ABRIR MODAL =====');
            console.log('üîç Elemento modal existe:', !!document.getElementById('editCitaModal'));
            console.log('üîç Bootstrap disponible:', typeof bootstrap !== 'undefined');
            
            const modalElement = document.getElementById('editCitaModal');
            console.log('üîç Modal element:', modalElement);
            console.log('üîç Modal classes:', modalElement ? modalElement.className : 'No encontrado');
            
            try {
                const modal = new bootstrap.Modal(modalElement);
                console.log('üîç Modal instance creada:', modal);
                modal.show();
                console.log('‚úÖ Modal.show() ejecutado');
                
                // Verificar si el modal se abri√≥
                setTimeout(() => {
                    console.log('üîç Modal visible despu√©s de 100ms:', modalElement.classList.contains('show'));
                    console.log('üîç Modal display style:', modalElement.style.display);
                    console.log('üîç Modal aria-hidden:', modalElement.getAttribute('aria-hidden'));
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error al abrir modal:', error);
            }
            
            console.log('üîç ===== FIN abrirModalEdicion =====');
        }

        // Funci√≥n de prueba para verificar event listeners
        function testClick() {
            console.log('Click detectado!');
            alert('Click funcionando correctamente');
        }

        // Event delegation para manejar clicks en elementos din√°micos
        document.addEventListener('click', function(event) {
            // Solo loggear clicks en elementos de cita para no saturar la consola
            if (event.target.closest('.cita-item-dia') || event.target.closest('.cita-bloque') || event.target.closest('.cita-item')) {
                console.log('üîç Click detectado en elemento de cita:', event.target);
                console.log('üîç Clase del elemento:', event.target.className);
                
                const citaElement = event.target.closest('.cita-item-dia') || event.target.closest('.cita-bloque') || event.target.closest('.cita-item');
                console.log('üéØ Elemento cita:', citaElement);
                
                // Buscar el ID de la cita en el elemento
                const citaId = citaElement.getAttribute('data-cita-id');
                console.log('üéØ ID de cita encontrado:', citaId);
                
                if (citaId) {
                    console.log('üéØ Llamando abrirModalEdicion con ID:', citaId);
                    abrirModalEdicion(citaId);
                } else {
                    console.error('‚ùå No se encontr√≥ data-cita-id en el elemento');
                }
            }
        });
    </script>

    <!-- Sistema de Autenticaci√≥n Seguro ya cargado en el head -->
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, getDoc, query, orderBy, doc, updateDoc, deleteDoc, addDoc, setDoc, Timestamp, serverTimestamp, where, limit } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getStorage, ref, getDownloadURL, getBytes } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
        
        // Hacer setDoc disponible globalmente
        window.setDoc = setDoc;
        
        // Hacer funciones disponibles globalmente
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.serverTimestamp = serverTimestamp;
        
        console.log('üîç Iniciando carga de Firebase...');
        
        try {
            console.log('‚úÖ Firebase modules cargados correctamente');

            // Configuraci√≥n de Firebase
            const firebaseConfig = {
                projectId: "cursorwebapp-f376d",
                appId: "1:719990096116:web:07c1ff697e7655b2cd9ea1",
                databaseURL: "https://cursorwebapp-f376d-default-rtdb.firebaseio.com",
                storageBucket: "cursorwebapp-f376d.firebasestorage.app",
                apiKey: "AIzaSyC-IQj0yHR8cELr-mw-v2xlnw6LlJYFUyk",
                authDomain: "cursorwebapp-f376d.firebaseapp.com",
                messagingSenderId: "719990096116",
                measurementId: "G-DJXLKFR7CD"
            };

            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            // Asignar a variables globales
            window.db = db;
            window.storage = storage;
            window.todasLasCitas = window.todasLasCitas || [];
            window.citasFiltradas = window.citasFiltradas || [];
            window.currentDate = window.currentDate || new Date();
            window.diaSeleccionado = window.diaSeleccionado || new Date();
            window.vistaActual = window.vistaActual || 'cronograma';
            window.selectedCita = window.selectedCita || null;
            
            // Asegurar que formatearFecha est√© disponible
            if (!window.formatearFecha) {
                window.formatearFecha = function(timestamp) {
                    if (!timestamp) return null;
                    const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return fecha;
                };
            }
            
            console.log('‚úÖ Firebase inicializado correctamente');
            console.log('‚úÖ Variables globales asignadas');

            // Elementos del DOM
        const calendarGrid = document.getElementById('calendarGrid');
        const datePicker = document.getElementById('datePicker');
        const vehicleFilter = document.getElementById('vehicleFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        // Elementos de navegaci√≥n del calendario
        
        // Elementos de vista de d√≠a
        const vistaDia = document.getElementById('vistaDia');
        const vistaDiaTitulo = document.getElementById('vistaDiaTitulo');
        const vehiculosGrid = document.getElementById('vehiculosGrid');
        const btnPrevDay = document.getElementById('btnPrevDay');
        const btnNextDay = document.getElementById('btnNextDay');
        
        // Elementos de vista de cronograma
        const vistaCronograma = document.getElementById('vistaCronograma');
        const vistaCronogramaTitulo = document.getElementById('vistaCronogramaTitulo');
        const cronogramaContainer = document.getElementById('cronogramaContainer');
        const ejeHoras = document.getElementById('ejeHoras');
        const vehiculosCronograma = document.getElementById('vehiculosCronograma');
        // const btnVistaCronograma = document.getElementById('btnVistaCronograma'); // ELIMINADO
        const btnPrevDayCronograma = document.getElementById('btnPrevDayCronograma');
        const btnNextDayCronograma = document.getElementById('btnNextDayCronograma');
        
        // Funci√≥n auxiliar para formatear fecha a YYYY-MM-DD en zona horaria local
        function formatearFechaParaInput(fecha) {
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const day = String(fecha.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Funci√≥n para formatear montos grandes (220k, 300k, 1M, etc.)
        function formatearMontoGrande(monto) {
            if (!monto || monto === 0) {
                return '0';
            }
            if (monto >= 1000000) {
                const millones = (monto / 1000000).toFixed(1);
                return millones.endsWith('.0') ? millones.replace('.0', '') + 'M' : millones + 'M';
            } else if (monto >= 1000) {
                const miles = (monto / 1000).toFixed(0);
                return miles + 'k';
            }
            return monto.toString();
        }
        
        // Funci√≥n para calcular ventas totales de un d√≠a
        function calcularVentasDia(year, month, day) {
            if (!window.todasLasCitas || window.todasLasCitas.length === 0) {
                return 0;
            }
            
            let totalVentas = 0;
            window.todasLasCitas.forEach(cita => {
                if (!window.obtenerInicio) return;
                
                const inicioCita = window.obtenerInicio(cita);
                if (!inicioCita) return;
                
                const fechaCita = window.formatearFecha(inicioCita);
                if (!fechaCita) return;
                
                if (fechaCita.getFullYear() === year &&
                    fechaCita.getMonth() === month &&
                    fechaCita.getDate() === day) {
                    const monto = window.obtenerMonto(cita) || 0;
                    totalVentas += monto;
                }
            });
            
            return totalVentas;
        }
        
        // Funci√≥n para generar botones de d√≠as del mes
        function generarBotonesDiasMes(fecha) {
            const container = document.getElementById('datePickerContainer');
            if (!container) return;
            
            // Verificar si estamos en vista compacta
            const btnToggle = document.getElementById('btnToggleVistaCompacta');
            const estaEnVistaCompacta = btnToggle && !btnToggle.classList.contains('active');
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const diasSemana = ['DOM', 'LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB'];
            const meses = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            
            let diasAMostrar = [];
            
            if (estaEnVistaCompacta) {
                // Vista compacta: solo mostrar d√≠as de la semana actual
                if (!semanaActual) {
                    semanaActual = obtenerLunesSemana(new Date());
                }
                diasAMostrar = obtenerDiasSemana(semanaActual);
            } else {
                // Vista total: mostrar todos los d√≠as del mes
                const year = fecha.getFullYear();
                const month = fecha.getMonth();
                const diasEnMes = new Date(year, month + 1, 0).getDate();
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    diasAMostrar.push(new Date(year, month, dia));
                }
            }
            
            let html = '';
            diasAMostrar.forEach(fechaDia => {
                const year = fechaDia.getFullYear();
                const month = fechaDia.getMonth();
                const day = fechaDia.getDate();
                const diaSemana = diasSemana[fechaDia.getDay()];
                const mesAbrev = meses[month];
                const fechaString = formatearFechaParaInput(fechaDia);
                
                const esHoy = fechaDia.getTime() === hoy.getTime();
                const esSeleccionado = diaSeleccionado && formatearFechaParaInput(diaSeleccionado) === fechaString;
                const esDomingo = fechaDia.getDay() === 0;
                
                // Calcular ventas del d√≠a
                const ventasDia = calcularVentasDia(year, month, day);
                const ventasFormateadas = formatearMontoGrande(ventasDia);
                
                html += `
                    <button class="btn-dia-mes ${esHoy ? 'today' : ''} ${esSeleccionado ? 'active' : ''} ${esDomingo ? 'domingo' : ''}" 
                            data-fecha="${fechaString}"
                            onclick="seleccionarDia('${fechaString}')">
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; font-weight: 600;">${diaSemana} ${day} ${mesAbrev}</div>
                            <div style="font-size: 0.65rem; margin-top: 2px; font-weight: 500;">${ventasFormateadas}</div>
                        </div>
                    </button>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Funci√≥n para seleccionar un d√≠a
        window.seleccionarDia = async function(fechaString) {
            const [year, month, day] = fechaString.split('-').map(Number);
            const nuevaFecha = new Date(year, month - 1, day, 12, 0, 0);
            currentDate = nuevaFecha;
            diaSeleccionado = nuevaFecha;
            
            // Actualizar input oculto
            const datePicker = document.getElementById('datePicker');
            if (datePicker) {
                datePicker.value = fechaString;
            }
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-dia-mes').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.fecha === fechaString) {
                    btn.classList.add('active');
                }
            });
            
            if (vistaActual === 'cronograma') {
                await generarCronograma();
            }
        };
        
        // Sincronizar datePicker con diaSeleccionado cuando cambien los botones
        const btnPrevMonthCronograma = document.getElementById('btnPrevMonthCronograma');
        const btnNextMonthCronograma = document.getElementById('btnNextMonthCronograma');
        
        if (btnPrevMonthCronograma) {
            btnPrevMonthCronograma.addEventListener('click', async () => {
                const nuevaFecha = new Date(diaSeleccionado);
                nuevaFecha.setMonth(nuevaFecha.getMonth() - 1);
                diaSeleccionado = nuevaFecha;
                generarBotonesDiasMes(nuevaFecha);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }
        
        if (btnNextMonthCronograma) {
            btnNextMonthCronograma.addEventListener('click', async () => {
                const nuevaFecha = new Date(diaSeleccionado);
                nuevaFecha.setMonth(nuevaFecha.getMonth() + 1);
                diaSeleccionado = nuevaFecha;
                generarBotonesDiasMes(nuevaFecha);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }
        
        // Mantener compatibilidad con el c√≥digo anterior (si los botones antiguos a√∫n existen)
        // Nota: btnPrevDayCronograma y btnNextDayCronograma ya est√°n declarados arriba
        if (btnPrevDayCronograma && datePicker) {
            btnPrevDayCronograma.addEventListener('click', async () => {
                diaSeleccionado.setDate(diaSeleccionado.getDate() - 1);
                datePicker.value = formatearFechaParaInput(diaSeleccionado);
                generarBotonesDiasMes(diaSeleccionado);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }
        
        if (btnNextDayCronograma && datePicker) {
            btnNextDayCronograma.addEventListener('click', async () => {
                diaSeleccionado.setDate(diaSeleccionado.getDate() + 1);
                datePicker.value = formatearFechaParaInput(diaSeleccionado);
                generarBotonesDiasMes(diaSeleccionado);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
            // Agregar efecto visual al hacer clic
            btnNextDayCronograma.addEventListener('mousedown', function() {
                this.style.transform = 'scale(0.95)';
            });
            btnNextDayCronograma.addEventListener('mouseup', function() {
                this.style.transform = 'scale(1)';
            });
        }

        // Paleta de colores - Alta intensidad y contraste
        const coloresVehiculos = {
            'APV 01': '#00C853', // Verde fuerte
            'APV 02': '#7B1FA2', // Morado fuerte
            'APV 03': '#FFD600', // Amarillo fuerte
            'APV 04': '#FF6F00', // Naranja fuerte
            'APV 05': '#00B0FF', // Celeste fuerte
            'APV 06': '#E91E63', // Rosada fuerte
            'APV 07': '#424242', // Gris fuerte
            'APV 08': '#1976D2', // Azul fuerte
            'Yaris': '#D32F2F', // Rojo fuerte
            'Kangoo': '#D32F2F', // Rojo fuerte
            'Rojo': '#D32F2F' // Rojo fuerte
        };

        // D√≠as de la semana
        const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        
        // Variable global para empleados
        window.empleados = window.empleados || [];
        let empleados = window.empleados; // Alias para uso dentro del m√≥dulo
        
        // Funci√≥n para cargar empleados activos
        async function cargarEmpleados() {
            try {
                const empleadosQuery = query(collection(window.db, 'empleados'), orderBy('primerNombre'));
                const querySnapshot = await getDocs(empleadosQuery);
                
                window.empleados = [];
                empleados = window.empleados; // Actualizar alias
                querySnapshot.forEach(doc => {
                    const empleado = { id: doc.id, ...doc.data() };
                    // Filtrar solo empleados activos
                    const estado = empleado.estado || empleado.activo;
                    if (estado === 'Activo' || estado === 'activo' || estado === true) {
                        window.empleados.push(empleado);
                    }
                });
                
                console.log('‚úÖ Empleados activos cargados:', window.empleados.length);
                return window.empleados;
            } catch (error) {
                console.error('‚ùå Error cargando empleados:', error);
                return [];
            }
        }
        
        // Funci√≥n para renderizar checkboxes de vendedores (GLOBAL)
        window.renderizarVendedoresCheckboxes = function(vendedoresSeleccionados = []) {
            const container = document.getElementById('editVendedoresContainer');
            if (!container) return;
            
            const empleadosLista = window.empleados || [];
            if (empleadosLista.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-exclamation-triangle me-2"></i>No hay empleados disponibles</div>';
                return;
            }
            
            // Normalizar vendedores seleccionados (pueden ser array de usernames o strings)
            const vendedoresNormalizados = Array.isArray(vendedoresSeleccionados) 
                ? vendedoresSeleccionados.map(v => typeof v === 'string' ? v.trim() : v)
                : (typeof vendedoresSeleccionados === 'string' ? vendedoresSeleccionados.split(',').map(v => v.trim()) : []);
            
            container.innerHTML = empleadosLista.map(empleado => {
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                const username = empleado.username || empleado.id;
                const estaSeleccionado = vendedoresNormalizados.includes(username) || vendedoresNormalizados.includes(nombreCompleto);
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="vendedor_${username}" 
                               value="${username}" 
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="vendedor_${username}">
                            ${nombreCompleto || username}
                        </label>
                    </div>
                `;
            }).join('');
        };
        
        // Funci√≥n para obtener vendedores seleccionados (GLOBAL) - Nueva versi√≥n con badges
        window.obtenerVendedoresSeleccionados = function(containerId = 'editVendedoresSelected') {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const badges = container.querySelectorAll('[data-username]');
            return Array.from(badges).map(badge => badge.getAttribute('data-username'));
        };
        
        // Variables globales para almacenar selecciones
        window.vendedoresSeleccionadosEdit = [];
        window.serviciosSeleccionadosEdit = []; // Array de objetos {id, precio}
        window.productosSeleccionadosEdit = [];
        window.plagasSeleccionadasEdit = [];
        window.vendedoresSeleccionadosNew = [];
        window.serviciosSeleccionadosNew = []; // Array de objetos {id, precio}
        window.productosSeleccionadosNew = [];
        window.plagasSeleccionadasNew = [];
        
        // Lista de plagas disponibles (ordenadas alfab√©ticamente)
        window.plagasDisponibles = [
            'Alacranes',
            'Ara√±as',
            '√Åcaros',
            'Babosas',
            'Caracoles',
            'Chinches de cama',
            'Cucaracha americana',
            'Cucaracha germ√°nica',
            'Garrapatas',
            'Hormigas',
            'Moscas',
            'Murci√©lagos',
            'Polillas',
            'Pulgas',
            'Ratas',
            'Ratones',
            'Termitas',
            'Zancudos'
        ];
        
        // Funci√≥n para inicializar b√∫squeda de vendedores
        window.inicializarBusquedaVendedores = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}VendedorSearch`);
            const dropdownMenu = document.getElementById(`${prefix}VendedoresDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Vendedor`);
            const selectedDiv = document.getElementById(`${prefix}VendedoresSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Funci√≥n para renderizar opciones
            function renderizarOpciones(query = '') {
                const empleados = window.empleados || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfab√©ticamente
                let empleadosFiltrados = empleados;
                if (queryLower) {
                    empleadosFiltrados = empleados.filter(emp => {
                        const nombre = `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim().toLowerCase();
                        const username = (emp.username || emp.id || '').toLowerCase();
                        return nombre.includes(queryLower) || username.includes(queryLower);
                    });
                }
                
                // Ordenar alfab√©ticamente por nombre completo
                empleadosFiltrados.sort((a, b) => {
                    const nombreA = `${a.primerNombre || ''} ${a.primerApellido || ''}`.trim().toLowerCase();
                    const nombreB = `${b.primerNombre || ''} ${b.primerApellido || ''}`.trim().toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener vendedores ya seleccionados
                const selected = prefix === 'edit' ? window.vendedoresSeleccionadosEdit : window.vendedoresSeleccionadosNew;
                
                if (empleadosFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = empleadosFiltrados.map(emp => {
                    const nombre = `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim();
                    const username = emp.username || emp.id;
                    const yaSeleccionado = selected.includes(username);
                    return `
                        <div class="dropdown-item" data-username="${username}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${nombre || username}</span>
                                ${username !== nombre ? `<small style="color: #6c757d; font-size: 0.8rem;">${username}</small>` : ''}
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const username = item.getAttribute('data-username');
                            agregarVendedor(username, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para b√∫squeda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarVendedor(username, prefix) {
                const selected = prefix === 'edit' ? window.vendedoresSeleccionadosEdit : window.vendedoresSeleccionadosNew;
                if (selected.includes(username)) return;
                
                const empleado = window.empleados.find(e => (e.username || e.id) === username);
                const nombre = empleado ? `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() : username;
                
                selected.push(username);
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.style.cssText = 'background: #c8e6c9; color: #000000; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;';
                badge.setAttribute('data-username', username);
                badge.innerHTML = `${nombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                badge.querySelector('i').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = selected.indexOf(username);
                    if (index > -1) selected.splice(index, 1);
                    badge.remove();
                });
                selectedDiv.appendChild(badge);
            }
        }
        
        // Funci√≥n para inicializar b√∫squeda de servicios con dropdown
        window.inicializarBusquedaServicios = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}ServicioSearch`);
            const dropdownMenu = document.getElementById(`${prefix}ServiciosDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Servicio`);
            const selectedDiv = document.getElementById(`${prefix}ServiciosSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Funci√≥n para renderizar opciones
            function renderizarOpciones(query = '') {
                const servicios = window.todosLosServicios || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfab√©ticamente
                let serviciosFiltrados = servicios;
                if (queryLower) {
                    serviciosFiltrados = servicios.filter(serv => {
                        const nombre = (serv.nombre || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfab√©ticamente por nombre
                serviciosFiltrados.sort((a, b) => {
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener servicios ya seleccionados
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                
                if (serviciosFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = serviciosFiltrados.map(serv => {
                    // Verificar si ya est√° seleccionado (comparar por ID)
                    const yaSeleccionado = selected.some(s => {
                        const id = typeof s === 'string' ? s : s.id;
                        return id === serv.id;
                    });
                    return `
                        <div class="dropdown-item" data-servicio-id="${serv.id}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${serv.nombre || 'Sin nombre'}</span>
                                <span style="color: #6c757d; font-size: 0.9rem;">‚Ç°${(serv.precio || 0).toLocaleString('es-CR')}</span>
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const servicioId = item.getAttribute('data-servicio-id');
                            agregarServicio(servicioId, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para b√∫squeda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
                
                // Cerrar dropdown de plagas si est√° abierto
                const plagaDropdown = document.getElementById(`${prefix}PlagasDropdownMenu`);
                if (plagaDropdown && plagaDropdown.style.display !== 'none') {
                    plagaDropdown.style.display = 'none';
                }
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarServicio(servicioId, prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                
                // Verificar si ya est√° seleccionado (comparar por ID)
                if (selected.some(s => (typeof s === 'string' && s === servicioId) || (typeof s === 'object' && s.id === servicioId))) {
                    return;
                }
                
                const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                if (!servicio) return;
                
                // Agregar como objeto con precio inicial del servicio
                const servicioConPrecio = {
                    id: servicioId,
                    precio: servicio.precio || 0
                };
                selected.push(servicioConPrecio);
                
                // Renderizar tabla de servicios
                if (window.renderizarTablaServicios) {
                    window.renderizarTablaServicios(prefix);
                }
                
                // Actualizar resumen financiero
                if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                    window.actualizarResumenFinanciero();
                } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                    window.actualizarResumenFinancieroNew();
                }
            }
            
            // Funci√≥n para renderizar la tabla de servicios (disponible globalmente)
            window.renderizarTablaServicios = function(prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const tabla = document.getElementById(`${prefix}ServiciosTabla`);
                const tbody = document.getElementById(`${prefix}ServiciosTablaBody`);
                
                if (!tabla || !tbody) return;
                
                if (selected.length === 0) {
                    tabla.style.display = 'none';
                    return;
                }
                
                tabla.style.display = 'table';
                
                // Ordenar servicios alfab√©ticamente
                const serviciosOrdenados = selected.map(serv => {
                    const servicio = window.todosLosServicios.find(s => s.id === (typeof serv === 'string' ? serv : serv.id));
                    return {
                        id: typeof serv === 'string' ? serv : serv.id,
                        precio: typeof serv === 'object' && serv.precio !== undefined ? serv.precio : (servicio?.precio || 0),
                        nombre: servicio?.nombre || 'Sin nombre'
                    };
                }).sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                tbody.innerHTML = serviciosOrdenados.map(serv => {
                    const precioFormateado = (serv.precio || 0).toLocaleString('es-CR');
                    return `
                        <tr data-servicio-id="${serv.id}">
                            <td style="font-size: 0.9rem; vertical-align: middle;">${serv.nombre}</td>
                            <td style="vertical-align: middle;">
                                <input 
                                    type="number" 
                                    class="form-control form-control-sm servicio-precio-input" 
                                    value="${serv.precio || 0}" 
                                    min="0" 
                                    step="1"
                                    data-servicio-id="${serv.id}"
                                    data-prefix="${prefix}"
                                    style="font-size: 0.9rem; text-align: right;"
                                    onchange="actualizarPrecioServicioCita('${serv.id}', this.value, '${prefix}')"
                                    onblur="actualizarPrecioServicioCita('${serv.id}', this.value, '${prefix}')"
                                >
                            </td>
                            <td style="vertical-align: middle; text-align: center;">
                                <button 
                                    class="btn btn-sm btn-danger" 
                                    onclick="eliminarServicioCita('${serv.id}', '${prefix}')"
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                    title="Eliminar servicio"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Funci√≥n para actualizar el precio de un servicio en la cita
            window.actualizarPrecioServicioCita = function(servicioId, nuevoPrecio, prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const servicio = selected.find(s => {
                    const id = typeof s === 'string' ? s : s.id;
                    return id === servicioId;
                });
                
                if (servicio) {
                    // Convertir a objeto si es string
                    if (typeof servicio === 'string') {
                        const index = selected.indexOf(servicio);
                        const servicioObj = window.todosLosServicios.find(s => s.id === servicioId);
                        selected[index] = {
                            id: servicioId,
                            precio: parseFloat(nuevoPrecio) || servicioObj?.precio || 0
                        };
                    } else {
                        servicio.precio = parseFloat(nuevoPrecio) || servicio.precio || 0;
                    }
                    
                    // Actualizar resumen financiero
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                        window.actualizarResumenFinanciero();
                    } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                        window.actualizarResumenFinancieroNew();
                    }
                }
            };
            
            // Funci√≥n para eliminar un servicio de la cita
            window.eliminarServicioCita = function(servicioId, prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const index = selected.findIndex(s => {
                    const id = typeof s === 'string' ? s : s.id;
                    return id === servicioId;
                });
                
                if (index > -1) {
                    selected.splice(index, 1);
                    if (window.renderizarTablaServicios) {
                        window.renderizarTablaServicios(prefix);
                    }
                    
                    // Actualizar resumen financiero
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                        window.actualizarResumenFinanciero();
                    } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                        window.actualizarResumenFinancieroNew();
                    }
                }
            };
        }
        
        // Funci√≥n para inicializar b√∫squeda de plagas con dropdown
        window.inicializarBusquedaPlagas = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}PlagaSearch`);
            const dropdownMenu = document.getElementById(`${prefix}PlagasDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Plaga`);
            const selectedDiv = document.getElementById(`${prefix}PlagasSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Funci√≥n para renderizar opciones
            function renderizarOpciones(query = '') {
                const plagas = window.plagasDisponibles || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfab√©ticamente
                let plagasFiltradas = plagas;
                if (queryLower) {
                    plagasFiltradas = plagas.filter(plaga => {
                        const nombre = (plaga || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfab√©ticamente por nombre
                plagasFiltradas.sort((a, b) => {
                    const nombreA = (a || '').toLowerCase();
                    const nombreB = (b || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener plagas ya seleccionadas
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                
                if (plagasFiltradas.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = plagasFiltradas.map(plaga => {
                    const yaSeleccionada = selected.includes(plaga);
                    return `
                        <div class="dropdown-item" data-plaga="${plaga.replace(/"/g, '&quot;')}" style="cursor: pointer; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                            <input 
                                type="checkbox" 
                                ${yaSeleccionada ? 'checked' : ''}
                                style="width: 18px; height: 18px; cursor: pointer;"
                                onchange="togglePlaga('${plaga.replace(/'/g, "\\'")}', '${prefix}')"
                            >
                            <span style="font-weight: 500; color: #000000; flex: 1;">${plaga}</span>
                        </div>
                    `;
                }).join('');
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para b√∫squeda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            // Funci√≥n para actualizar la visualizaci√≥n de plagas seleccionadas
            function actualizarPlagasSeleccionadas() {
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                selectedDiv.innerHTML = '';
                
                selected.forEach(plaga => {
                    const badge = document.createElement('span');
                    badge.className = 'badge';
                    badge.style.cssText = 'background: #e8f5e9; color: #2e7d32; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;';
                    badge.setAttribute('data-plaga', plaga.replace(/"/g, '&quot;'));
                    badge.innerHTML = `${plaga} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                    badge.querySelector('i').addEventListener('click', (e) => {
                        e.stopPropagation();
                        togglePlaga(plaga, prefix);
                    });
                    selectedDiv.appendChild(badge);
                });
            }
            
            // Inicializar visualizaci√≥n
            actualizarPlagasSeleccionadas();
            
            // Funci√≥n para agregar/quitar plaga
            window.togglePlaga = function(nombrePlaga, prefix) {
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                const index = selected.indexOf(nombrePlaga);
                
                if (index === -1) {
                    // Agregar plaga
                    selected.push(nombrePlaga);
                } else {
                    // Quitar plaga
                    selected.splice(index, 1);
                }
                
                // Actualizar visualizaci√≥n
                actualizarPlagasSeleccionadas();
                
                // Re-renderizar dropdown para actualizar checkboxes
                const searchInput = document.getElementById(`${prefix}PlagaSearch`);
                if (searchInput) {
                    renderizarOpciones(searchInput.value);
                }
            };
        }
        
        // Funci√≥n para obtener plagas seleccionadas
        window.obtenerPlagasSeleccionadas = function(prefix = 'edit') {
            if (prefix === 'edit') {
                return window.plagasSeleccionadasEdit || [];
            } else {
                return window.plagasSeleccionadasNew || [];
            }
        };
        
        // Funci√≥n para inicializar b√∫squeda de productos
        window.inicializarBusquedaProductos = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}ProductoSearch`);
            const dropdownMenu = document.getElementById(`${prefix}ProductosDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Producto`);
            const selectedDiv = document.getElementById(`${prefix}ProductosSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Funci√≥n para renderizar opciones
            function renderizarOpciones(query = '') {
                const productos = window.todosLosProductos || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfab√©ticamente
                let productosFiltrados = productos;
                if (queryLower) {
                    productosFiltrados = productos.filter(prod => {
                        const nombre = (prod.nombre || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfab√©ticamente por nombre
                productosFiltrados.sort((a, b) => {
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener productos ya seleccionados
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                
                if (productosFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = productosFiltrados.map(prod => {
                    const yaSeleccionado = selected.includes(prod.id);
                    return `
                        <div class="dropdown-item" data-producto-id="${prod.id}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${prod.nombre || 'Sin nombre'}</span>
                                <span style="color: #6c757d; font-size: 0.9rem;">‚Ç°${(prod.precio_venta || 0).toLocaleString('es-CR')}</span>
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const productoId = item.getAttribute('data-producto-id');
                            agregarProducto(productoId, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para b√∫squeda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarProducto(productoId, prefix) {
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                if (selected.includes(productoId)) return;
                
                const producto = window.todosLosProductos.find(p => p.id === productoId);
                if (!producto) return;
                
                selected.push(productoId);
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.style.cssText = 'background: #c8e6c9; color: #000000; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;';
                badge.setAttribute('data-producto-id', productoId);
                badge.innerHTML = `${producto.nombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                badge.querySelector('i').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = selected.indexOf(productoId);
                    if (index > -1) selected.splice(index, 1);
                    badge.remove();
                    // Actualizar resumen financiero
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                        window.actualizarResumenFinanciero();
                    } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                        window.actualizarResumenFinancieroNew();
                    }
                });
                selectedDiv.appendChild(badge);
                
                // Actualizar resumen financiero
                if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                    window.actualizarResumenFinanciero();
                } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                    window.actualizarResumenFinancieroNew();
                }
            }
        }
        
        // Actualizar funci√≥n obtenerServiciosSeleccionados
        // Devuelve array de objetos {id, precio} para mantener precios personalizados por cita
        window.obtenerServiciosSeleccionados = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
            // Asegurar que todos los servicios est√©n en formato objeto
            return selected.map(serv => {
                if (typeof serv === 'string') {
                    // Convertir string a objeto con precio del servicio base
                    const servicio = window.todosLosServicios.find(s => s.id === serv);
                    return {
                        id: serv,
                        precio: servicio?.precio || 0
                    };
                }
                return serv; // Ya es un objeto
            });
        };
        
        // Actualizar funci√≥n obtenerProductosSeleccionados
        window.obtenerProductosSeleccionados = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
            return [...selected];
        };
        
        // Funci√≥n para inicializar b√∫squeda de equipo
        window.inicializarBusquedaEquipo = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}EquipoSearch`);
            const dropdownMenu = document.getElementById(`${prefix}EquipoDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Equipo`);
            const selectedDiv = document.getElementById(`${prefix}EquipoSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Inicializar arrays si no existen
            if (prefix === 'edit' && !window.equipoSeleccionadoEdit) {
                window.equipoSeleccionadoEdit = [];
            } else if (prefix === 'new' && !window.equipoSeleccionadoNew) {
                window.equipoSeleccionadoNew = [];
            }
            
            // Funci√≥n para renderizar opciones
            function renderizarOpciones(query = '') {
                const equipos = window.todosLosEquipos || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfab√©ticamente
                let equiposFiltrados = equipos;
                if (queryLower) {
                    equiposFiltrados = equipos.filter(equipo => {
                        const nombre = (equipo.nombre || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfab√©ticamente por nombre
                equiposFiltrados.sort((a, b) => {
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener equipo ya seleccionado
                const selectedArray = prefix === 'edit' ? window.equipoSeleccionadoEdit : window.equipoSeleccionadoNew;
                
                if (equiposFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = equiposFiltrados.map(equipo => {
                    const yaSeleccionado = selectedArray.includes(equipo.id);
                    return `
                        <div class="dropdown-item" data-equipo-id="${equipo.id}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${equipo.nombre || 'Sin nombre'}</span>
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const equipoId = item.getAttribute('data-equipo-id');
                            agregarEquipo(equipoId, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para b√∫squeda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarEquipo(equipoId, prefix) {
                const selectedArray = prefix === 'edit' ? window.equipoSeleccionadoEdit : window.equipoSeleccionadoNew;
                if (selectedArray.includes(equipoId)) return;
                
                const equipo = window.todosLosEquipos.find(e => e.id === equipoId);
                if (!equipo) return;
                
                selectedArray.push(equipoId);
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.style.cssText = 'background: #c8e6c9; color: #000000; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;';
                badge.setAttribute('data-equipo-id', equipoId);
                badge.innerHTML = `${equipo.nombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                badge.querySelector('i').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = selectedArray.indexOf(equipoId);
                    if (index > -1) selectedArray.splice(index, 1);
                    badge.remove();
                });
                selectedDiv.appendChild(badge);
            }
        };
        
        // Funci√≥n para obtener equipo seleccionado
        window.obtenerEquipoSeleccionado = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.equipoSeleccionadoEdit : window.equipoSeleccionadoNew;
            return selected ? [...selected] : [];
        };
        
        // Variables globales para almacenar selecciones de equipo
        window.equipoSeleccionadoEdit = [];
        window.equipoSeleccionadoNew = [];
        
        // Funci√≥n para generar certificado de fumigaci√≥n
        window.generarCertificadoFumigacion = function(textoCertificado, fechaInicio, duracion, prefix = 'edit') {
            if (!textoCertificado || !textoCertificado.trim()) {
                alert('Por favor ingrese el texto para el certificado');
                return;
            }
            
            // Verificar que jsPDF est√© disponible
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('Error: La librer√≠a jsPDF no est√° disponible. Por favor recargue la p√°gina.');
                return;
            }
            
            // Obtener fecha y hora de la cita
            const fecha = fechaInicio ? new Date(fechaInicio) : new Date();
            const fechaFormateada = fecha.toLocaleDateString('es-CR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const horaFormateada = fecha.toLocaleTimeString('es-CR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Dividir el texto en l√≠neas/p√°rrafos para generar m√∫ltiples certificados
            const textosCertificados = textoCertificado.split('\n').filter(t => t.trim());
            if (textosCertificados.length === 0) {
                textosCertificados.push(textoCertificado.trim());
            }
            
            // Generar un certificado por cada texto
            textosCertificados.forEach((texto, index) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuraci√≥n de m√°rgenes
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const contentWidth = pageWidth - (margin * 2);
                
                let yPos = margin;
                
                // T√≠tulo del certificado
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('CERTIFICADO DE FUMIGACI√ìN', pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;
                
                // L√≠nea divisoria
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
                
                // Informaci√≥n de la empresa
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Ecofumigadora Ecoplagas SRL', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('C√©dula Jur√≠dica: 3-102-850026-6', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('Autorizado por Ministerio de Salud de Costa Rica', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('Autorizado por Colegio de Qu√≠micos de Costa Rica', pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;
                
                // L√≠nea divisoria
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
                
                // Cuerpo del certificado
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                const textoCertificadoCompleto = `Por medio del presente, certifico que el d√≠a ${fechaFormateada} a las ${horaFormateada}, se realiz√≥ un servicio de fumigaci√≥n en:\n\n${texto.trim()}\n\nEl servicio fue realizado por personal t√©cnico capacitado y autorizado, utilizando productos qu√≠micos registrados y aprobados por el Ministerio de Salud de Costa Rica.`;
                
                // Dividir el texto en l√≠neas que quepan en el ancho de la p√°gina
                const lines = doc.splitTextToSize(textoCertificadoCompleto, contentWidth);
                
                lines.forEach(line => {
                    if (yPos > pageHeight - margin - 20) {
                        doc.addPage();
                        yPos = margin;
                    }
                    doc.text(line, margin, yPos);
                    yPos += 7;
                });
                
                yPos += 10;
                
                // Informaci√≥n adicional
                if (yPos > pageHeight - margin - 40) {
                    doc.addPage();
                    yPos = margin;
                }
                
                doc.setFontSize(10);
                doc.text('Este certificado tiene validez legal y est√° respaldado por:', margin, yPos);
                yPos += 7;
                doc.text('‚Ä¢ Ministerio de Salud de Costa Rica - Registro No. MS-2024-001234', margin + 5, yPos);
                yPos += 7;
                doc.text('‚Ä¢ Colegio de Qu√≠micos de Costa Rica - Licencia No. CQCR-2024-005678', margin + 5, yPos);
                yPos += 7;
                doc.text('‚Ä¢ Certificado de Buenas Pr√°cticas - No. BPM-2024-009012', margin + 5, yPos);
                yPos += 15;
                
                // Firma y sello
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Firma y Sello:', margin, yPos);
                yPos += 20;
                
                doc.setFont(undefined, 'normal');
                doc.text('_________________________', margin, yPos);
                yPos += 7;
                doc.text('T√©cnico Autorizado', margin, yPos);
                yPos += 7;
                doc.text('Ecofumigadora Ecoplagas SRL', margin, yPos);
                yPos += 7;
                doc.text(`Fecha de emisi√≥n: ${new Date().toLocaleDateString('es-CR')}`, margin, yPos);
                
                // Guardar el PDF
                const nombreArchivo = `Certificado_Fumigacion_${fecha.toISOString().split('T')[0]}_${index + 1}.pdf`;
                doc.save(nombreArchivo);
            });
            
            if (textosCertificados.length > 1) {
                alert(`Se generaron ${textosCertificados.length} certificados`);
            }
        };
        
        // Hacer cargarEmpleados global tambi√©n
        window.cargarEmpleados = cargarEmpleados;
        
        // Alias para uso dentro del m√≥dulo
        const renderizarVendedoresCheckboxes = window.renderizarVendedoresCheckboxes;
        const obtenerVendedoresSeleccionados = window.obtenerVendedoresSeleccionados;

        // Funciones helper para compatibilidad con nueva estructura (GLOBALES)
        window.obtenerInicio = function(cita) {
            // Prioridad: inicio_gmt6 (nuevo) > service_start_time (legacy)
            return cita.inicio_gmt6 ?? cita.service_start_time ?? null;
        };
        
        window.obtenerDuracion = function(cita) {
            // Prioridad: duracion_minutos (nuevo) > duration_minutes (legacy) > 60 (default)
            return cita.duracion_minutos ?? cita.duration_minutes ?? 60;
        };
        
        // Funci√≥n para obtener el nombre del cliente desde el documento del cliente
        // Fuente de verdad: clientes/{telefono}.nombre
        window.obtenerClienteNombre = async function(cita) {
            // Obtener tel√©fono desde la fuente de verdad (cita.telefono)
            const telefono = cita.telefono || cita.client_phone;
            if (telefono) {
                try {
                    const cliente = await window.buscarCliente(telefono);
                    if (cliente && cliente.nombre) {
                        return cliente.nombre;
                    }
                } catch (error) {
                    console.warn('Error obteniendo nombre del cliente:', error);
                }
            }
            
            // Fallback: usar nombre guardado en la cita (para compatibilidad con datos antiguos)
            return cita.metadata?.cliente_nombre || cita.client_name || 'Sin nombre';
        };
        
        // Versi√≥n s√≠ncrona para uso inmediato (usa fallback)
        // Nota: Esta funci√≥n usa el fallback para citas antiguas. Para obtener el nombre actualizado,
        // usar la versi√≥n as√≠ncrona obtenerClienteNombre() que consulta desde el documento del cliente.
        window.obtenerClienteNombreSync = function(cita) {
            if (!cita) {
                console.warn('‚ö†Ô∏è [obtenerClienteNombreSync] Cita es null/undefined');
                return 'Sin nombre';
            }
            
            // Para uso inmediato, usar el nombre guardado en la cita como fallback (compatibilidad con citas antiguas)
            // El nombre actualizado se obtiene desde clientes/{telefono}.nombre usando obtenerClienteNombre()
            const nombreMetadata = cita.metadata?.cliente_nombre;
            const nombreClientName = cita.client_name;
            const telefono = cita.telefono || cita.client_phone;
            
            const resultado = nombreMetadata || nombreClientName || 'Sin nombre';
            
            // Log detallado para debugging
            if (resultado === 'Sin nombre') {
                console.log('üîç [obtenerClienteNombreSync] Sin nombre encontrado', {
                    citaId: cita.id,
                    telefono: telefono,
                    tieneMetadata: !!cita.metadata,
                    cliente_nombre: nombreMetadata,
                    client_name: nombreClientName,
                    metadataKeys: cita.metadata ? Object.keys(cita.metadata) : []
                });
            }
            
            // Asegurar que siempre retorne un string, nunca una Promise
            if (typeof resultado !== 'string') {
                console.error('‚ùå [obtenerClienteNombreSync] Resultado no es string:', {
                    tipo: typeof resultado,
                    valor: resultado,
                    citaId: cita.id
                });
                return 'Sin nombre';
            }
            
            return resultado;
        };
        
        // Obtener tel√©fono de la cita
        // Fuente de verdad: cita.telefono (ra√≠z)
        // Fallback: cita.client_phone (compatibilidad con datos antiguos)
        window.obtenerTelefono = function(cita) {
            return cita.telefono || cita.client_phone || '';
        };
        
        window.obtenerRuta = function(cita) {
            const ruta = window.obtenerCampoCita(cita, 'ruta', 'Sin asignar');
            // Normalizar ruta: convertir "9" a "Ruta 9", etc.
            if (ruta && ruta !== 'Sin asignar' && ruta !== null && ruta !== undefined) {
                // Si es un n√∫mero o string num√©rico, convertirlo a "Ruta X"
                const rutaStr = String(ruta).trim();
                const numeroRuta = parseInt(rutaStr);
                if (!isNaN(numeroRuta) && numeroRuta >= 1 && numeroRuta <= 20) {
                    return `Ruta ${numeroRuta}`;
                }
                // Si ya est√° en formato "Ruta X", validarlo
                if (window.validarRuta) {
                    return window.validarRuta(rutaStr);
                }
                // Si contiene "Ruta", retornarlo tal cual
                if (rutaStr.toLowerCase().includes('ruta')) {
                    return rutaStr;
                }
            }
            return ruta || 'Sin asignar';
        };
        
        // Alias para compatibilidad: obtenerVehiculo es lo mismo que obtenerRuta
        // TODO: Verificar si obtenerVehiculo se usa en el c√≥digo, si no, eliminar este alias
        window.obtenerVehiculo = window.obtenerRuta;
        
        // ============================================
        // FUNCIONES PARA CLIENTES Y SUCURSALES
        // ============================================
        
        // Funci√≥n para normalizar tel√©fono (agregar 506 si no est√°)
        window.normalizarTelefono = function(telefono) {
            if (!telefono) return '';
            // Remover espacios, guiones, par√©ntesis
            let limpio = telefono.replace(/[\s\-\(\)]/g, '');
            // Si empieza con 506, removerlo para normalizar
            if (limpio.startsWith('506')) {
                limpio = limpio.substring(3);
            }
            // Validar que sean solo 8 d√≠gitos
            if (!/^\d{8}$/.test(limpio)) {
                return null; // Tel√©fono inv√°lido
            }
            // Retornar con 506
            return '506' + limpio;
        };
        
        // Funci√≥n para formatear tel√©fono para mostrar
        window.formatearTelefono = function(telefono) {
            if (!telefono) return '';
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return telefono;
            const sin506 = normalizado.substring(3);
            return `506-${sin506.substring(0, 4)}-${sin506.substring(4)}`;
        };
        
        // Funci√≥n para generar link de WhatsApp
        window.generarLinkWhatsApp = function(telefono, mensaje = '') {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return '';
            const mensajeEncoded = mensaje ? encodeURIComponent(mensaje) : '';
            return `https://wa.me/${normalizado}${mensajeEncoded ? '?text=' + mensajeEncoded : ''}`;
        };
        
        // Funci√≥n para buscar cliente por tel√©fono
        window.buscarCliente = async function(telefono) {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return null;
            
            try {
                const clienteDoc = await getDoc(doc(window.db, 'clientes', normalizado));
                if (clienteDoc.exists()) {
                    return { id: clienteDoc.id, ...clienteDoc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error buscando cliente:', error);
                return null;
            }
        };
        
        // Funci√≥n para cargar sucursales de un cliente
        window.cargarSucursalesCliente = async function(telefono) {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return [];
            
            try {
                const cliente = await window.buscarCliente(telefono);
                if (!cliente || !cliente.sucursales || cliente.sucursales.length === 0) {
                    return [];
                }
                
                // Cargar todas las sucursales usando el formato: telefono_indice
                const sucursalesPromises = cliente.sucursales.map(indice => {
                    const indiceFormateado = String(indice).padStart(3, '0');
                    return getDoc(doc(window.db, 'sucursales', `${normalizado}_${indiceFormateado}`));
                });
                const sucursalesDocs = await Promise.all(sucursalesPromises);
                
                return sucursalesDocs
                    .filter(doc => doc.exists())
                    .map(doc => ({ indice: doc.data().indice, id: doc.id, ...doc.data() }))
                    .sort((a, b) => {
                        // Ordenar por √≠ndice (ascendente)
                        return a.indice - b.indice;
                    });
            } catch (error) {
                console.error('Error cargando sucursales:', error);
                return [];
            }
        };
        
        // Funci√≥n para poblar select de sucursales
        window.cargarSucursalesEnSelect = async function(selectId, telefono, sucursalIndiceSeleccionada = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Cargando...</option>';
            
            const sucursales = await window.cargarSucursalesCliente(telefono);
            
            if (sucursales.length === 0) {
                select.innerHTML = '<option value="nueva">Crear nueva sucursal</option>';
                return;
            }
            
            select.innerHTML = '';
            sucursales.forEach(sucursal => {
                const option = document.createElement('option');
                option.value = sucursal.indice; // Usar √≠ndice en lugar de ID
                const indiceFormateado = String(sucursal.indice).padStart(3, '0');
                const fechaUltima = sucursal.fechaUltimaFumigacion ? 
                    sucursal.fechaUltimaFumigacion.toDate ? 
                        sucursal.fechaUltimaFumigacion.toDate().toLocaleDateString('es-CR') : 
                        new Date(sucursal.fechaUltimaFumigacion).toLocaleDateString('es-CR') : 
                    '';
                option.textContent = `${indiceFormateado} - ${sucursal.nombre}${fechaUltima ? ' (√öltima: ' + fechaUltima + ')' : ''}`;
                if (sucursal.indice === sucursalIndiceSeleccionada) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Agregar opci√≥n para nueva sucursal
            const optionNueva = document.createElement('option');
            optionNueva.value = 'nueva';
            optionNueva.textContent = '+ Crear nueva sucursal';
            select.appendChild(optionNueva);
        };
        
        // Funci√≥n para crear cliente
        window.crearCliente = async function(telefono, nombreCliente = '') {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) throw new Error('Tel√©fono inv√°lido');
            
            const sin506 = normalizado.substring(3);
            const telefonoFormateado = `${sin506.substring(0, 4)}-${sin506.substring(4)}`;
            
            const clienteData = {
                telefono: normalizado,
                telefonoFormateado: telefonoFormateado,
                nombre: nombreCliente || '',
                fechaCreacion: serverTimestamp(),
                fechaUltimaActualizacion: serverTimestamp(),
                totalCitas: 0,
                sucursales: [] // Array de √≠ndices: [0, 1, 2, 3, ...] (empiezan en 0)
            };
            
            await setDoc(doc(window.db, 'clientes', normalizado), clienteData);
            return { id: normalizado, ...clienteData };
        };
        
        // Funci√≥n para actualizar el nombre del cliente
        window.actualizarNombreCliente = async function(telefono, nombre) {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) {
                throw new Error('Tel√©fono inv√°lido');
            }
            
            try {
                await updateDoc(doc(window.db, 'clientes', normalizado), {
                    nombre: nombre,
                    fechaUltimaActualizacion: serverTimestamp()
                });
                console.log('‚úÖ Nombre del cliente actualizado:', nombre);
            } catch (error) {
                console.error('‚ùå Error actualizando nombre del cliente:', error);
                throw error;
            }
        };
        
        // Funci√≥n para crear sucursal
        window.crearSucursal = async function(clienteTelefono, nombre, coordenadas, provinciaId, cantonId, distritoId, direccion, otrasSenas) {
            const normalizado = window.normalizarTelefono(clienteTelefono);
            if (!normalizado) throw new Error('Tel√©fono inv√°lido');
            
            // Verificar que el cliente exista
            let cliente = await window.buscarCliente(clienteTelefono);
            if (!cliente) {
                cliente = await window.crearCliente(clienteTelefono);
            }
            
            // Calcular el siguiente √≠ndice (empezando de 0)
            const indicesExistentes = cliente.sucursales || [];
            const siguienteIndice = indicesExistentes.length > 0 ? Math.max(...indicesExistentes) + 1 : 0;
            const indiceFormateado = String(siguienteIndice).padStart(3, '0');
            
            // Validar que se proporcione un nombre (obligatorio)
            if (!nombre || nombre.trim() === '') {
                nombre = 'Hogar principal'; // Valor por defecto si est√° vac√≠o
            }
            
            // Las coordenadas GPS son opcionales al crear
            
            // ID de la sucursal: telefono_indice (ej: "50612345678_001")
            const sucursalId = `${normalizado}_${indiceFormateado}`;
            
            const sucursalData = {
                clienteTelefono: normalizado,
                indice: siguienteIndice, // √çndice num√©rico: 0, 1, 2, 3, ...
                nombre: nombre.trim() || 'Hogar principal',
                coordenadas: window.sonCoordenadasValidas(coordenadas) ? {
                    lat: coordenadas.lat,
                    lng: coordenadas.lng,
                    texto: `${coordenadas.lat}, ${coordenadas.lng}`
                } : null,
                provinciaId: provinciaId || '',
                cantonId: cantonId || '',
                distritoId: distritoId || '',
                direccion: direccion || '',
                otrasSenas: otrasSenas || '',
                fechaCreacion: serverTimestamp(),
                fechaUltimaFumigacion: null,
                totalFumigaciones: 0
                // citas: [] removido - no se requiere guardar registro de citas en sucursal
            };
            
            await setDoc(doc(window.db, 'sucursales', sucursalId), sucursalData);
            
            // Actualizar cliente para agregar el √≠ndice de la sucursal
            const sucursalesActualizadas = [...(cliente.sucursales || []), siguienteIndice];
            await updateDoc(doc(window.db, 'clientes', normalizado), {
                sucursales: sucursalesActualizadas,
                fechaUltimaActualizacion: serverTimestamp()
            });
            
            return { id: sucursalId, indice: siguienteIndice, ...sucursalData };
        };
        
        // Funci√≥n para actualizar sucursal
        window.actualizarSucursal = async function(clienteTelefono, indice, datos) {
            const normalizado = window.normalizarTelefono(clienteTelefono);
            if (!normalizado) throw new Error('Tel√©fono inv√°lido');
            
            const indiceFormateado = String(indice).padStart(3, '0');
            const sucursalId = `${normalizado}_${indiceFormateado}`;
            
            const datosActualizacion = {
                ...datos,
                fechaUltimaActualizacion: serverTimestamp()
            };
            await updateDoc(doc(window.db, 'sucursales', sucursalId), datosActualizacion);
        };
        
        // Funci√≥n para obtener sucursal por √≠ndice
        window.obtenerSucursalPorIndice = async function(clienteTelefono, indice) {
            const normalizado = window.normalizarTelefono(clienteTelefono);
            if (!normalizado) return null;
            
            const indiceFormateado = String(indice).padStart(3, '0');
            const sucursalId = `${normalizado}_${indiceFormateado}`;
            
            try {
                const sucursalDoc = await getDoc(doc(window.db, 'sucursales', sucursalId));
                if (sucursalDoc.exists()) {
                    return { indice: indice, id: sucursalDoc.id, ...sucursalDoc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error obteniendo sucursal:', error);
                return null;
            }
        };
        
        // ============================================
        // FUNCIONES HELPER GEN√âRICAS
        // ============================================
        
        /**
         * Funci√≥n gen√©rica para obtener campos de cita con fallback
         * Prioridad: metadata.campo > campo_legacy > valorDefault
         * @param {Object} cita - Objeto cita
         * @param {string} campo - Nombre del campo en metadata
         * @param {*} valorDefault - Valor por defecto si no existe
         * @returns {*} Valor del campo o valor por defecto
         */
        window.obtenerCampoCita = function(cita, campo, valorDefault = null) {
            // Usar nullish coalescing (??) para distinguir entre undefined/null y valores falsy v√°lidos (0, '', false)
            return cita.metadata?.[campo] ?? cita[campo] ?? valorDefault;
        };
        
        /**
         * Verificar si un √≠ndice de sucursal es v√°lido (no es null ni undefined)
         * @param {number|null|undefined} sucursalIndice - √çndice de sucursal
         * @returns {boolean} true si el √≠ndice es v√°lido
         */
        window.esSucursalIndiceValido = function(sucursalIndice) {
            return sucursalIndice !== null && sucursalIndice !== undefined;
        };
        
        /**
         * Verificar si un objeto coordenadas es v√°lido (tiene lat y lng)
         * @param {Object|null|undefined} coordenadas - Objeto coordenadas
         * @returns {boolean} true si las coordenadas son v√°lidas
         */
        window.sonCoordenadasValidas = function(coordenadas) {
            return !!(coordenadas?.lat && coordenadas?.lng);
        };
        
        // ============================================
        // FUNCIONES HELPER ESPEC√çFICAS (usando gen√©rica)
        // ============================================
        
        window.obtenerEstado = function(cita) {
            return window.obtenerCampoCita(cita, 'estado', 'agendada');
        };
        
        window.obtenerMonto = function(cita) {
            return window.obtenerCampoCita(cita, 'monto', 0);
        };
        
        // Funci√≥n para formatear n√∫mero con s√≠mbolo ‚Ç° y puntos para miles
        window.formatearMontoVenta = function(valor) {
            if (!valor || valor === '' || valor === '0') {
                return '';
            }
            // Extraer solo n√∫meros del valor
            const numero = valor.toString().replace(/[^\d]/g, '');
            if (!numero || numero === '0') {
                return '';
            }
            // Convertir a n√∫mero y formatear con puntos para miles
            const numeroFormateado = parseInt(numero, 10).toLocaleString('es-CR');
            return `‚Ç°${numeroFormateado}`;
        };
        
        // Funci√≥n para extraer el valor num√©rico sin formato
        window.extraerValorNumerico = function(valor) {
            if (!valor || valor === '') {
                return '0';
            }
            // Extraer solo n√∫meros
            const numero = valor.toString().replace(/[^\d]/g, '');
            return numero || '0';
        };
        
        window.obtenerCostoServicio = function(cita) {
            return window.obtenerCampoCita(cita, 'costo_servicio', 20000);
        };
        
        window.obtenerVendedores = function(cita) {
            // Fallback especial: tambi√©n verificar cita.vendedores (legacy)
            return cita.metadata?.vendedores ?? cita.vendedores ?? [];
        };
        
        window.obtenerDireccion = function(cita) {
            return window.obtenerCampoCita(cita, 'direccion', '');
        };
        
        // Funci√≥n helper para obtener coordenadas de una cita
        // Fuente de verdad: sucursales/{telefono}_{indice}.coordenadas
        // Sigue el flujo correcto: primero desde sucursal, luego fallback para citas antiguas
        window.obtenerCoordenadasCita = async function(cita) {
            const sucursalIndice = cita.metadata?.sucursalIndice;
            // Obtener tel√©fono desde la fuente de verdad (cita.telefono)
            const clienteTelefono = cita.telefono || cita.client_phone;
            
            // Si hay sucursal, obtener coordenadas desde la sucursal (source of truth)
            if (window.esSucursalIndiceValido(sucursalIndice) && clienteTelefono) {
                try {
                    const sucursal = await window.obtenerSucursalPorIndice(clienteTelefono, sucursalIndice);
                    if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                        return sucursal.coordenadas;
                    }
                } catch (error) {
                    console.warn('Error obteniendo coordenadas desde sucursal:', error);
                }
            }
            
            // Fallback para citas antiguas que a√∫n tienen coordenadas en metadata (compatibilidad)
            if (window.sonCoordenadasValidas(cita.metadata?.coordenadas)) {
                return cita.metadata.coordenadas;
            }
            
            return null;
        };
        
        // Funci√≥n para verificar si una cita tiene coordenadas GPS (desde sucursal)
        window.tieneCoordenadasGPS = async function(cita) {
            const coordenadas = await window.obtenerCoordenadasCita(cita);
            return window.sonCoordenadasValidas(coordenadas);
        };
        
        // Funci√≥n s√≠ncrona para verificar si una cita tiene coordenadas (usa fallback para uso inmediato)
        // IMPORTANTE: Esta funci√≥n solo verifica el fallback de citas antiguas (s√≠ncrono)
        // Para citas nuevas con sucursal, usar tieneCoordenadasGPS() (async) que consulta desde sucursal
        window.tieneCoordenadasGPSSync = function(cita) {
            // Solo verificar fallback para citas antiguas que tienen coordenadas en metadata
            // Las citas nuevas con sucursal deben usar tieneCoordenadasGPS() (async)
            return window.sonCoordenadasValidas(cita.metadata?.coordenadas);
        };
        
        // Funci√≥n para obtener el indicador visual de GPS (async)
        window.obtenerIndicadorGPS = async function(cita) {
            const tieneGPS = await window.tieneCoordenadasGPS(cita);
            if (tieneGPS) {
                return '<i class="fas fa-check-circle indicador-gps" style="color: #28a745; font-size: 0.9rem;" title="Tiene coordenadas GPS"></i>';
            } else {
                return '<i class="fas fa-times-circle indicador-gps" style="color: #dc3545; font-size: 0.9rem;" title="Sin coordenadas GPS"></i>';
            }
        };
        
        // Versi√≥n s√≠ncrona para renderizado r√°pido (usa fallback de citas antiguas)
        window.obtenerIndicadorGPSSync = function(cita) {
            // Verificar si tiene coordenadas en metadata (fallback para citas antiguas)
            const tieneCoordenadas = window.sonCoordenadasValidas(cita.metadata?.coordenadas);
            if (tieneCoordenadas) {
                return '<i class="fas fa-check-circle indicador-gps" style="color: #28a745; font-size: 0.9rem;" title="Tiene coordenadas GPS"></i>';
            }
            
            // Si tiene sucursalIndice v√°lido, probablemente tiene GPS pero no podemos verificarlo s√≠ncronamente
            // Mostrar indicador neutro (se actualizar√° despu√©s si es necesario)
            const tieneSucursal = window.esSucursalIndiceValido(cita.metadata?.sucursalIndice);
            if (tieneSucursal) {
                // No mostrar nada por ahora, se actualizar√° despu√©s con async si es necesario
                return '';
            }
            
            // Si no tiene coordenadas ni sucursal, mostrar X roja
            return '<i class="fas fa-times-circle indicador-gps" style="color: #dc3545; font-size: 0.9rem;" title="Sin coordenadas GPS"></i>';
        };
        
        window.obtenerDescripcion = function(cita) {
            // Prioridad: metadata.observaciones > descripcion_servicio > observaciones > descripcion
            const campos = [
                cita.metadata?.observaciones,
                cita.descripcion_servicio,
                cita.observaciones,
                cita.descripcion
            ];
            // Encontrar el primer campo que tenga valor (no null, undefined, ni string vac√≠o)
            return campos.find(campo => campo && String(campo).trim()) || '';
        };
        
        window.obtenerTurno = function(cita) {
            return window.obtenerCampoCita(cita, 'turno', 'Turno 1');
        };
        
        window.obtenerTurnoEmoji = function(cita) {
            const emoji = window.obtenerCampoCita(cita, 'turno_emoji', null);
            if (emoji) return emoji;
            // Fallback: generar emoji basado en turno
            return window.obtenerTurno(cita) === 'Turno 2' ? 'üåô' : '‚òÄÔ∏è';
        };
        
        window.obtenerServicios = function(cita) {
            return window.obtenerCampoCita(cita, 'servicios', []);
        };
        
        window.obtenerProductos = function(cita) {
            return window.obtenerCampoCita(cita, 'productos', []);
        };
        
        window.obtenerEquipo = function(cita) {
            return window.obtenerCampoCita(cita, 'equipo', []);
        };
        
        // Tambi√©n crear alias sin window para uso dentro del m√≥dulo
        const obtenerInicio = window.obtenerInicio;
        const obtenerDuracion = window.obtenerDuracion;
        
        // ========== GESTI√ìN DE SERVICIOS ==========
        
        // Variable global para almacenar servicios
        window.todosLosServicios = [];
        
        // Funci√≥n para cargar servicios desde Firestore
        window.cargarServicios = async function() {
            try {
                const q = query(collection(window.db, 'servicios'), orderBy('nombre', 'asc'));
                const querySnapshot = await getDocs(q);
                window.todosLosServicios = [];
                querySnapshot.forEach(doc => {
                    window.todosLosServicios.push({ id: doc.id, ...doc.data() });
                });
                console.log('‚úÖ Servicios cargados:', window.todosLosServicios.length);
                return window.todosLosServicios;
            } catch (error) {
                console.error('‚ùå Error cargando servicios:', error);
                return [];
            }
        };
        
        // Funci√≥n para renderizar tabla de servicios
        window.renderizarTablaServicios = function() {
            const tbody = document.getElementById('tablaServicios');
            if (!tbody) return;
            
            if (window.todosLosServicios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-inbox me-2"></i>No hay servicios disponibles. Agrega uno nuevo.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = window.todosLosServicios.map(servicio => `
                <tr data-servicio-id="${servicio.id}">
                    <td class="align-middle">
                        <small class="text-muted">${servicio.id.substring(0, 8)}...</small>
                    </td>
                    <td class="align-middle">
                        <input type="text" 
                               class="form-control form-control-sm servicio-nombre" 
                               value="${servicio.nombre || ''}" 
                               data-servicio-id="${servicio.id}">
                    </td>
                    <td class="align-middle">
                        <input type="number" 
                               class="form-control form-control-sm servicio-precio" 
                               value="${servicio.precio || 0}" 
                               min="0" 
                               step="1"
                               data-servicio-id="${servicio.id}">
                    </td>
                    <td class="align-middle">
                        <button class="btn btn-sm btn-success me-1 btn-guardar-servicio" 
                                data-servicio-id="${servicio.id}" 
                                title="Guardar cambios">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-servicio" 
                                data-servicio-id="${servicio.id}" 
                                title="Eliminar servicio">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Agregar event listeners para guardar cambios
            tbody.querySelectorAll('.btn-guardar-servicio').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const servicioId = e.target.closest('button').getAttribute('data-servicio-id');
                    const fila = e.target.closest('tr');
                    const nombreInput = fila.querySelector('.servicio-nombre');
                    const precioInput = fila.querySelector('.servicio-precio');
                    
                    const nombre = nombreInput.value.trim();
                    const precio = parseInt(precioInput.value) || 0;
                    
                    if (!nombre) {
                        alert('El nombre del servicio es requerido');
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await updateDoc(doc(window.db, 'servicios', servicioId), {
                            nombre: nombre,
                            precio: precio,
                            fecha_actualizacion: serverTimestamp()
                        });
                        
                        // Actualizar en memoria
                        const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                        if (servicio) {
                            servicio.nombre = nombre;
                            servicio.precio = precio;
                        }
                        
                        btn.innerHTML = '<i class="fas fa-check text-success"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-save"></i>';
                            btn.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error guardando servicio:', error);
                        alert('Error guardando servicio: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                    }
                });
            });
            
            // Agregar event listeners para eliminar
            tbody.querySelectorAll('.btn-eliminar-servicio').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const servicioId = e.target.closest('button').getAttribute('data-servicio-id');
                    const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                    
                    if (!confirm(`¬øEst√°s seguro de eliminar el servicio "${servicio?.nombre || servicioId}"?`)) {
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await deleteDoc(doc(window.db, 'servicios', servicioId));
                        
                        // Remover de memoria
                        window.todosLosServicios = window.todosLosServicios.filter(s => s.id !== servicioId);
                        
                        // Re-renderizar tabla
                        window.renderizarTablaServicios();
                    } catch (error) {
                        console.error('Error eliminando servicio:', error);
                        alert('Error eliminando servicio: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-trash"></i>';
                    }
                });
            });
        };
        
        // Funci√≥n para renderizar checkboxes de servicios en el formulario de citas
        window.renderizarServiciosCheckboxes = function(serviciosSeleccionados = []) {
            const container = document.getElementById('editServiciosContainer');
            if (!container) return;
            
            if (window.todosLosServicios.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>No hay servicios disponibles. 
                        <a href="#" onclick="document.getElementById('btnGestionarServicios').click(); return false;">Gestionar servicios</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.todosLosServicios.map(servicio => {
                const estaSeleccionado = serviciosSeleccionados.some(s => 
                    (typeof s === 'string' && s === servicio.id) || 
                    (typeof s === 'object' && s.id === servicio.id)
                );
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" 
                               type="checkbox" 
                               value="${servicio.id}" 
                               id="servicio_${servicio.id}"
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="servicio_${servicio.id}">
                            ${servicio.nombre || 'Sin nombre'} - ‚Ç°${(servicio.precio || 0).toLocaleString('es-CR')}
                        </label>
                    </div>
                `;
            }).join('');
        };
        
        // Funci√≥n para obtener servicios seleccionados
        window.obtenerServiciosSeleccionados = function() {
            const checkboxes = document.querySelectorAll('#editServiciosContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value); // Retorna array de IDs
        };
        
        // ========== GESTI√ìN DE EQUIPO Y HERRAMIENTAS ==========
        
        // Variable global para almacenar equipo
        window.todosLosEquipos = [];
        
        // Funci√≥n para cargar herramientas desde Firestore (solo herramientas, no productos)
        window.cargarEquipo = async function() {
            try {
                // Cargar solo herramientas desde la colecci√≥n 'herramientas'
                const q = query(collection(window.db, 'herramientas'), orderBy('nombre', 'asc'));
                const querySnapshot = await getDocs(q);
                window.todosLosEquipos = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // Solo agregar herramientas activas (si tienen campo activo)
                    if (data.activo !== false) {
                        window.todosLosEquipos.push({ id: doc.id, ...data });
                    }
                });
                console.log('‚úÖ Herramientas cargadas:', window.todosLosEquipos.length);
                return window.todosLosEquipos;
            } catch (error) {
                console.error('‚ùå Error cargando herramientas:', error);
                return [];
            }
        };
        
        // Funci√≥n para renderizar tabla de equipo
        window.renderizarTablaEquipo = function() {
            const tbody = document.getElementById('tablaEquipo');
            if (!tbody) return;
            
            if (window.todosLosEquipos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            <i class="fas fa-inbox me-2"></i>No hay equipo disponible. Agrega uno nuevo.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = window.todosLosEquipos.map(equipo => `
                <tr data-equipo-id="${equipo.id}">
                    <td class="align-middle">
                        <small class="text-muted">${equipo.id.substring(0, 8)}...</small>
                    </td>
                    <td class="align-middle">
                        <input type="text" 
                               class="form-control form-control-sm equipo-nombre" 
                               value="${equipo.nombre || ''}" 
                               data-equipo-id="${equipo.id}">
                    </td>
                    <td class="align-middle">
                        <button class="btn btn-sm btn-success me-1 btn-guardar-equipo" 
                                data-equipo-id="${equipo.id}" 
                                title="Guardar cambios">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-equipo" 
                                data-equipo-id="${equipo.id}" 
                                title="Eliminar equipo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Agregar event listeners para guardar cambios
            tbody.querySelectorAll('.btn-guardar-equipo').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const equipoId = e.target.closest('button').getAttribute('data-equipo-id');
                    const fila = e.target.closest('tr');
                    const nombreInput = fila.querySelector('.equipo-nombre');
                    
                    const nombre = nombreInput.value.trim();
                    
                    if (!nombre) {
                        alert('El nombre del equipo es requerido');
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await updateDoc(doc(window.db, 'equipo', equipoId), {
                            nombre: nombre,
                            fecha_actualizacion: serverTimestamp()
                        });
                        
                        // Actualizar en memoria
                        const equipoIndex = window.todosLosEquipos.findIndex(e => e.id === equipoId);
                        if (equipoIndex !== -1) {
                            window.todosLosEquipos[equipoIndex].nombre = nombre;
                        }
                        
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-save"></i>';
                            btn.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error guardando equipo:', error);
                        alert('Error guardando equipo: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                    }
                });
            });
            
            // Agregar event listeners para eliminar
            tbody.querySelectorAll('.btn-eliminar-equipo').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const equipoId = e.target.closest('button').getAttribute('data-equipo-id');
                    const equipo = window.todosLosEquipos.find(e => e.id === equipoId);
                    
                    if (!confirm(`¬øEst√°s seguro de eliminar el equipo "${equipo?.nombre || equipoId}"?`)) {
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await deleteDoc(doc(window.db, 'equipo', equipoId));
                        
                        // Remover de memoria
                        window.todosLosEquipos = window.todosLosEquipos.filter(e => e.id !== equipoId);
                        
                        // Re-renderizar tabla
                        window.renderizarTablaEquipo();
                    } catch (error) {
                        console.error('Error eliminando equipo:', error);
                        alert('Error eliminando equipo: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-trash"></i>';
                    }
                });
            });
        };
        
        // ========== GESTI√ìN DE UBICACIONES (PROVINCIA, CANT√ìN, DISTRITO) ==========
        window.ubicacionesCR = null;
        let ubicacionesCR = window.ubicacionesCR; // Alias local
        
        // Funci√≥n para parsear coordenadas desde texto
        function parsearCoordenadas(texto) {
            if (!texto || typeof texto !== 'string') return null;
            
            // Limpiar espacios y normalizar
            texto = texto.trim().replace(/\s+/g, ' ');
            
            // Intentar diferentes formatos
            // Formato: "lat, lng" o "lat,lng"
            const match = texto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
            if (match) {
                const lat = parseFloat(match[1]);
                const lng = parseFloat(match[2]);
                
                // Validar rangos (Costa Rica est√° aproximadamente entre 8-11¬∞N y 82-86¬∞W)
                if (!isNaN(lat) && !isNaN(lng) && lat >= 8 && lat <= 11 && lng >= -86 && lng <= -82) {
                    return {
                        lat: lat,
                        lng: lng
                    };
                }
            }
            
            return null;
        }
        
        // Funci√≥n para limpiar y extraer coordenadas de texto pegado (puede contener texto adicional)
        function limpiarYExtraerCoordenadas(texto) {
            if (!texto || typeof texto !== 'string') return null;
            
            // Limpiar el texto: remover caracteres especiales y normalizar espacios
            let textoLimpio = texto.trim();
            
            // Buscar patrones de coordenadas en el texto
            // Patr√≥n 1: "lat, lng" o "lat,lng" (puede estar en cualquier parte del texto)
            const patrones = [
                // Formato est√°ndar: n√∫mero, n√∫mero (con o sin espacios alrededor de la coma)
                /(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/g,
                // Formato con par√©ntesis: (lat, lng)
                /\((-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\)/g,
                // Formato con corchetes: [lat, lng]
                /\[(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\]/g
            ];
            
            for (const patron of patrones) {
                // Usar textoLimpio en lugar de texto
                const matches = [...textoLimpio.matchAll(patron)];
                if (matches.length > 0) {
                    // Tomar el √∫ltimo match (generalmente las coordenadas est√°n al final)
                    const match = matches[matches.length - 1];
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Retornar las coordenadas sin validar primero (la validaci√≥n se hace despu√©s)
                        return {
                            lat: lat,
                            lng: lng,
                            textoLimpio: `${lat}, ${lng}`
                        };
                    }
                }
            }
            
            return null;
        }
        
        // Funci√≥n para validar que las coordenadas est√©n dentro de los l√≠mites de Costa Rica
        function validarCoordenadasCostaRica(lat, lng) {
            if (typeof lat !== 'number' || typeof lng !== 'number') return false;
            if (isNaN(lat) || isNaN(lng)) return false;
            
            // L√≠mites aproximados de Costa Rica
            // Latitud: aproximadamente 8.0¬∞N a 11.2¬∞N
            // Longitud: aproximadamente -85.9¬∞W a -82.5¬∞W (valores negativos)
            const latMin = 8.0;
            const latMax = 11.2;
            const lngMin = -85.9;
            const lngMax = -82.5;
            
            return lat >= latMin && lat <= latMax && lng >= lngMin && lng <= lngMax;
        }
        
        // Funci√≥n para verificar si un punto est√° dentro de un pol√≠gono (Point in Polygon - Ray Casting Algorithm mejorado)
        function puntoEnPoligono(punto, poligono) {
            if (!poligono || poligono.length < 3) return false;
            
            const [lat, lng] = punto;
            let dentro = false;
            
            // Algoritmo Ray Casting mejorado
            for (let i = 0, j = poligono.length - 1; i < poligono.length; j = i++) {
                const [xi, yi] = poligono[i];
                const [xj, yj] = poligono[j];
                
                // Verificar si el rayo cruza la arista
                const intersecta = ((yi > lng) !== (yj > lng)) && 
                                   (lat < ((xj - xi) * (lng - yi) / (yj - yi) + xi));
                if (intersecta) dentro = !dentro;
            }
            
            return dentro;
        }
        
        // Funci√≥n para verificar si un punto est√° dentro de cualquier pol√≠gono de un distrito
        function puntoEnDistrito(punto, distritoKML) {
            if (!distritoKML || !distritoKML.coordenadas) return false;
            
            // Verificar cada pol√≠gono del distrito (puede tener m√∫ltiples pol√≠gonos)
            for (const poligono of distritoKML.coordenadas) {
                if (poligono && poligono.length >= 3) {
                    // Verificar pol√≠gono exterior
                    if (puntoEnPoligono(punto, poligono)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // Funci√≥n para calcular la distancia m√≠nima de un punto a un pol√≠gono
        function distanciaPuntoAPoligono(punto, poligono) {
            if (!poligono || poligono.length < 2) return Infinity;
            
            const [lat, lng] = punto;
            let distanciaMinima = Infinity;
            
            // Calcular distancia a cada arista del pol√≠gono
            for (let i = 0; i < poligono.length; i++) {
                const j = (i + 1) % poligono.length;
                const [x1, y1] = poligono[i];
                const [x2, y2] = poligono[j];
                
                // Distancia del punto a la l√≠nea segmento
                const A = lat - x1;
                const B = lng - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                let param = -1;
                
                if (lenSq !== 0) {
                    param = dot / lenSq;
                }
                
                let xx, yy;
                
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }
                
                const dx = lat - xx;
                const dy = lng - yy;
                const distancia = Math.sqrt(dx * dx + dy * dy);
                
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                }
            }
            
            return distanciaMinima;
        }
        
        // Funci√≥n para encontrar el distrito m√°s cercano a unas coordenadas (versi√≥n mejorada y precisa)
        async function encontrarDistritoPorCoordenadas(lat, lng) {
            if (!window.datosKML || !window.ubicacionesCR) {
                console.warn('‚ö†Ô∏è Datos KML o ubicaciones no cargados');
                return null;
            }
            
            const punto = [lat, lng];
            let distritoEncontrado = null;
            let distanciaMinima = Infinity;
            let distritosCandidatos = [];
            
            // PRIMERA PASADA: Buscar distritos donde el punto est√° DENTRO del pol√≠gono
            for (const clave in window.datosKML) {
                const distritoKML = window.datosKML[clave];
                if (distritoKML && distritoKML.coordenadas) {
                    if (puntoEnDistrito(punto, distritoKML)) {
                        // Punto est√° dentro del pol√≠gono - este es el m√°s preciso
                        distritoEncontrado = {
                            provinciaId: distritoKML.COD_PROV,
                            cantonId: distritoKML.COD_CANT,
                            distritoId: distritoKML.COD_DIST,
                            nombreProvincia: distritoKML.NOM_PROV,
                            nombreCanton: distritoKML.NOM_CANT,
                            nombreDistrito: distritoKML.NOM_DIST,
                            precision: 'exacta',
                            distancia: 0
                        };
                        console.log('‚úÖ Punto encontrado DENTRO del distrito:', distritoEncontrado.nombreDistrito);
                        return distritoEncontrado;
                    }
                }
            }
            
            // SEGUNDA PASADA: Si no est√° dentro, calcular distancia real a cada pol√≠gono
            for (const clave in window.datosKML) {
                const distritoKML = window.datosKML[clave];
                if (distritoKML && distritoKML.coordenadas) {
                    let distanciaDistrito = Infinity;
                    
                    // Calcular la distancia m√≠nima a cualquier pol√≠gono de este distrito
                    for (const poligono of distritoKML.coordenadas) {
                        if (poligono && poligono.length >= 3) {
                            const distancia = distanciaPuntoAPoligono(punto, poligono);
                            if (distancia < distanciaDistrito) {
                                distanciaDistrito = distancia;
                            }
                        }
                    }
                    
                    if (distanciaDistrito < Infinity) {
                        distritosCandidatos.push({
                            provinciaId: distritoKML.COD_PROV,
                            cantonId: distritoKML.COD_CANT,
                            distritoId: distritoKML.COD_DIST,
                            nombreProvincia: distritoKML.NOM_PROV,
                            nombreCanton: distritoKML.NOM_CANT,
                            nombreDistrito: distritoKML.NOM_DIST,
                            precision: 'cercano',
                            distancia: distanciaDistrito
                        });
                    }
                }
            }
            
            // Ordenar por distancia y tomar el m√°s cercano
            if (distritosCandidatos.length > 0) {
                distritosCandidatos.sort((a, b) => a.distancia - b.distancia);
                distritoEncontrado = distritosCandidatos[0];
                console.log(`‚úÖ Distrito m√°s cercano encontrado: ${distritoEncontrado.nombreDistrito} (distancia: ${distritoEncontrado.distancia.toFixed(6)} grados)`);
            }
            
            return distritoEncontrado;
        }
        
        // Funci√≥n para procesar coordenadas y llenar autom√°ticamente provincia, cant√≥n y distrito (Nueva Cita)
        async function procesarCoordenadasNew(lat, lng) {
            try {
                // Validar que las coordenadas est√©n dentro de Costa Rica
                if (!validarCoordenadasCostaRica(lat, lng)) {
                    const inputCoords = document.getElementById('newCoordenadas');
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#dc3545';
                        alert(`Las coordenadas (${lat}, ${lng}) est√°n fuera de los l√≠mites de Costa Rica. Por favor, ingrese coordenadas v√°lidas.`);
                        return false;
                    }
                }
                
                // Mostrar indicador de carga
                const inputCoords = document.getElementById('newCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#ffc107';
                }
                
                // Buscar distrito en KML
                const distrito = await encontrarDistritoPorCoordenadas(lat, lng);
                
                if (distrito) {
                    const selectProvincia = document.getElementById('newProvincia');
                    const selectCanton = document.getElementById('newCanton');
                    const selectDistrito = document.getElementById('newDistrito');
                    
                    if (selectProvincia) {
                        // Cargar provincias si no est√°n cargadas
                        if (!window.ubicacionesCR) {
                            await cargarUbicaciones();
                        }
                        
                        // Llenar provincias
                        if (window.ubicacionesCR) {
                            selectProvincia.innerHTML = '<option value="">Seleccionar provincia...</option>';
                            Object.keys(window.ubicacionesCR).forEach(provId => {
                                const option = document.createElement('option');
                                option.value = provId;
                                option.textContent = window.ubicacionesCR[provId].nombre;
                                selectProvincia.appendChild(option);
                            });
                            selectProvincia.value = distrito.provinciaId;
                        }
                        
                        // Llenar cantones
                        if (window.ubicacionesCR && window.ubicacionesCR[distrito.provinciaId]) {
                            const cantones = window.ubicacionesCR[distrito.provinciaId].cantones || {};
                            selectCanton.innerHTML = '<option value="">Seleccionar cant√≥n...</option>';
                            Object.keys(cantones).forEach(cantId => {
                                const option = document.createElement('option');
                                option.value = cantId;
                                option.textContent = cantones[cantId].nombre;
                                selectCanton.appendChild(option);
                            });
                            selectCanton.value = distrito.cantonId;
                            selectCanton.disabled = false;
                        }
                        
                        // Llenar distritos
                        if (window.ubicacionesCR && 
                            window.ubicacionesCR[distrito.provinciaId] && 
                            window.ubicacionesCR[distrito.provinciaId].cantones &&
                            window.ubicacionesCR[distrito.provinciaId].cantones[distrito.cantonId]) {
                            const distritos = window.ubicacionesCR[distrito.provinciaId].cantones[distrito.cantonId].distritos || {};
                            selectDistrito.innerHTML = '<option value="">Seleccionar distrito...</option>';
                            Object.keys(distritos).forEach(distId => {
                                const option = document.createElement('option');
                                option.value = distId;
                                option.textContent = distritos[distId].nombre;
                                selectDistrito.appendChild(option);
                            });
                            selectDistrito.value = distrito.distritoId;
                            selectDistrito.disabled = false;
                        }
                        
                        // Actualizar encabezado autom√°tico
                        setTimeout(() => {
                            // actualizarEncabezadoAutoNuevaCita(); // Funci√≥n eliminada - encabezado removido
                        }, 100);
                        
                        // Generar links de Google Maps y Waze autom√°ticamente
                        const linkGoogleMaps = `https://maps.google.com/?q=${lat},${lng}`;
                        const linkWaze = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
                        const linksCombinados = `Google Maps: ${linkGoogleMaps}\nWaze: ${linkWaze}`;
                        
                        // Llenar campo de direcci√≥n con los links
                        const inputDireccion = document.getElementById('newDireccion');
                        if (inputDireccion) {
                            inputDireccion.value = linksCombinados;
                        }
                        
                        // Inicializar o actualizar mapa con las coordenadas
                        const contenedorMapa = document.getElementById('mapaUbicacionNew');
                        if (contenedorMapa) {
                            // Si el mapa ya existe, actualizarlo
                            if (window.mapaUbicacionNew && typeof window.mapaUbicacionNew.setView === 'function') {
                                window.mapaUbicacionNew.setView([lat, lng], 15);
                                window.mapaUbicacionNew.invalidateSize();
                                
                                // Remover marcador anterior si existe
                                if (window.marcadorUbicacionNew) {
                                    window.mapaUbicacionNew.removeLayer(window.marcadorUbicacionNew);
                                }
                                
                                // Agregar nuevo marcador
                                window.marcadorUbicacionNew = L.marker([lat, lng]).addTo(window.mapaUbicacionNew);
                                const popupContent = `
                                    <b>${distrito.nombreDistrito}</b><br>
                                    ${distrito.nombreCanton}, ${distrito.nombreProvincia}<br>
                                    <a href="${linkGoogleMaps}" target="_blank" rel="noopener noreferrer" style="color: #4285f4; text-decoration: none;">
                                        <i class="fas fa-map-marker-alt"></i> Google Maps
                                    </a> | 
                                    <a href="${linkWaze}" target="_blank" rel="noopener noreferrer" style="color: #33ccff; text-decoration: none;">
                                        <i class="fas fa-route"></i> Waze
                                    </a>
                                `;
                                window.marcadorUbicacionNew.bindPopup(popupContent).openPopup();
                                
                                // Mostrar distrito y cant√≥n en el mapa
                                setTimeout(() => {
                                    mostrarDistritoYCantonNew(distrito.provinciaId, distrito.cantonId, distrito.distritoId);
                                }, 200);
                                
                                // Actualizar encabezado autom√°tico
                                // actualizarEncabezadoAutoNuevaCita(); // Funci√≥n eliminada - encabezado removido
                            } else {
                                // Si el mapa no existe, inicializarlo
                                setTimeout(() => {
                                    try {
                                        // Limpiar contenedor si tiene un mapa anterior
                                        if (contenedorMapa._leaflet_id) {
                                            try {
                                                const mapaExistente = window.L && window.L.DomUtil && window.L.DomUtil.get(contenedorMapa);
                                                if (mapaExistente && mapaExistente.remove) {
                                                    mapaExistente.remove();
                                                }
                                            } catch (e) {
                                                contenedorMapa.innerHTML = '';
                                            }
                                        }
                                        
                                        // Crear nuevo mapa centrado en las coordenadas
                                        const nuevoMapa = L.map('mapaUbicacionNew').setView([lat, lng], 15);
                                        window.mapaUbicacionNew = nuevoMapa;
                                        
                                        // Agregar capa de tiles
                                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                                            attribution: '¬© Esri',
                                            maxZoom: 19
                                        }).addTo(nuevoMapa);
                                        
                                        // Agregar marcador
                                        window.marcadorUbicacionNew = L.marker([lat, lng]).addTo(nuevoMapa);
                                        const popupContent = `
                                            <b>${distrito.nombreDistrito}</b><br>
                                            ${distrito.nombreCanton}, ${distrito.nombreProvincia}<br>
                                            <a href="${linkGoogleMaps}" target="_blank" style="color: #4285f4; text-decoration: none;">
                                                <i class="fas fa-map-marker-alt"></i> Google Maps
                                            </a> | 
                                            <a href="${linkWaze}" target="_blank" style="color: #33ccff; text-decoration: none;">
                                                <i class="fas fa-route"></i> Waze
                                            </a>
                                        `;
                                        window.marcadorUbicacionNew.bindPopup(popupContent).openPopup();
                                        
                                        // Invalidar tama√±o para asegurar renderizado correcto
                                        setTimeout(() => {
                                            if (window.mapaUbicacionNew && typeof window.mapaUbicacionNew.invalidateSize === 'function') {
                                                window.mapaUbicacionNew.invalidateSize();
                                                
                                                // Mostrar distrito y cant√≥n en el mapa
                                                if (window.mostrarDistritoYCantonNew) {
                                                    window.mostrarDistritoYCantonNew(distrito.provinciaId, distrito.cantonId, distrito.distritoId);
                                                }
                                            }
                                        }, 200);
                                        
                                        // Actualizar encabezado autom√°tico
                                        // actualizarEncabezadoAutoNuevaCita(); // Funci√≥n eliminada - encabezado removido
                                    } catch (error) {
                                        console.error('‚ùå Error inicializando mapa:', error);
                                    }
                                }, 300);
                            }
                            
                            // Actualizar encabezado autom√°tico
                            // actualizarEncabezadoAutoNuevaCita(); // Funci√≥n eliminada - encabezado removido
                        }
                        
                        // Mostrar √©xito
                        if (inputCoords) {
                            inputCoords.style.borderColor = '#28a745';
                        }
                    }
                } else {
                    // No se encontr√≥ distrito
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#dc3545';
                    }
                    console.warn('‚ö†Ô∏è No se pudo encontrar el distrito para las coordenadas:', lat, lng);
                }
            } catch (error) {
                console.error('‚ùå Error procesando coordenadas:', error);
                const inputCoords = document.getElementById('newCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#dc3545';
                }
            }
        }
        
        // Funci√≥n para procesar coordenadas y llenar autom√°ticamente provincia, cant√≥n y distrito
        window.procesarCoordenadasEdit = async function(lat, lng) {
            try {
                // Mostrar indicador de carga
                const inputCoords = document.getElementById('editCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#ffc107';
                }
                
                // Buscar distrito en KML
                const distrito = await encontrarDistritoPorCoordenadas(lat, lng);
                
                if (distrito) {
                    const selectProvincia = document.getElementById('editProvincia');
                    const selectCanton = document.getElementById('editCanton');
                    const selectDistrito = document.getElementById('editDistrito');
                    
                    if (selectProvincia) {
                        selectProvincia.value = distrito.provinciaId;
                        llenarCantonesEdit(distrito.provinciaId);
                        
                        setTimeout(() => {
                            if (selectCanton) {
                                selectCanton.value = distrito.cantonId;
                                llenarDistritosEdit(distrito.provinciaId, distrito.cantonId);
                                
                                setTimeout(() => {
                                    if (selectDistrito) {
                                        selectDistrito.value = distrito.distritoId;
                                        
                                        // Disparar eventos change
                                        const changeEvent = new Event('change', { bubbles: true });
                                        selectDistrito.dispatchEvent(changeEvent);
                                        
                                        // Mostrar distrito en el mapa
                                        if (window.mostrarDistritoSeleccionado) {
                                            window.mostrarDistritoSeleccionado(distrito.provinciaId, distrito.cantonId, distrito.distritoId);
                                        }
                                    }
                                }, 150);
                            }
                        }, 150);
                    }
                    
                    // Generar links de Google Maps y Waze autom√°ticamente
                    const linkGoogleMaps = `https://maps.google.com/?q=${lat},${lng}`;
                    const linkWaze = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
                    const linksCombinados = `Google Maps: ${linkGoogleMaps}\nWaze: ${linkWaze}`;
                    
                    // Llenar campo de direcci√≥n con los links
                    const inputDireccion = document.getElementById('editDireccion');
                    if (inputDireccion) {
                        inputDireccion.value = linksCombinados;
                    }
                    
                    // Actualizar mapa con marcador
                    if (window.mapaUbicacionEdit) {
                        window.mapaUbicacionEdit.setView([lat, lng], 15);
                        window.mapaUbicacionEdit.invalidateSize();
                        
                        // Remover marcador anterior
                        if (window.marcadorUbicacionEdit) {
                            window.mapaUbicacionEdit.removeLayer(window.marcadorUbicacionEdit);
                        }
                        
                        // Agregar nuevo marcador con popup que incluye los links
                        window.marcadorUbicacionEdit = L.marker([lat, lng]).addTo(window.mapaUbicacionEdit);
                        const popupContent = `
                            <b>${distrito.nombreDistrito}</b><br>
                            ${distrito.nombreCanton}, ${distrito.nombreProvincia}<br>
                            <a href="${linkGoogleMaps}" target="_blank" rel="noopener noreferrer" style="color: #4285f4; text-decoration: none;">
                                <i class="fas fa-map-marker-alt"></i> Google Maps
                            </a> | 
                            <a href="${linkWaze}" target="_blank" rel="noopener noreferrer" style="color: #33ccff; text-decoration: none;">
                                <i class="fas fa-route"></i> Waze
                            </a>
                        `;
                        window.marcadorUbicacionEdit.bindPopup(popupContent).openPopup();
                    }
                    
                    // Restaurar borde del input
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#ced4da';
                    }
                    
                    console.log('‚úÖ Distrito encontrado:', distrito);
                    console.log('‚úÖ Links generados:', { googleMaps: linkGoogleMaps, waze: linkWaze });
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è No se encontr√≥ distrito para las coordenadas:', lat, lng);
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#dc3545';
                    }
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error procesando coordenadas:', error);
                const inputCoords = document.getElementById('editCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#dc3545';
                }
                return false;
            }
        }
        
        // Variables para el mapa de edici√≥n (GLOBALES para asegurar acceso desde cualquier funci√≥n)
        // Usamos window para que sean accesibles desde cualquier scope
        window.mapaUbicacionEdit = null;
        window.marcadorUbicacionEdit = null;
        window.datosKML = null; // Datos del KML
        window.poligonosEdit = null; // Grupo de pol√≠gonos en el mapa
        // Alias locales para compatibilidad
        let mapaUbicacionEdit = window.mapaUbicacionEdit;
        let marcadorUbicacionEdit = window.marcadorUbicacionEdit;
        
        // Cargar ubicaciones de Costa Rica (sin inicializar mapa)
        async function cargarUbicacionesSolo() {
            try {
                const response = await fetch('ubicaciones-cr.json');
                window.ubicacionesCR = await response.json();
                ubicacionesCR = window.ubicacionesCR; // Sincronizar alias local
                console.log('‚úÖ Ubicaciones de Costa Rica cargadas');
                return true;
            } catch (error) {
                console.error('‚ùå Error cargando ubicaciones:', error);
                return false;
            }
        }
        
        // Cargar ubicaciones de Costa Rica e inicializar mapa de edici√≥n
        async function cargarUbicaciones() {
            const cargado = await cargarUbicacionesSolo();
            if (cargado) {
                llenarProvinciasEdit();
                await cargarKML();
                inicializarMapaEdit();
            }
        }
        
        // Cargar y parsear KML
        // NOTA: El archivo debe estar en public/ para evitar problemas de CORS con Firebase Storage
        async function cargarKML() {
            try {
                // Cargar desde public/ (mismo dominio, sin problemas de CORS)
                const response = await fetch('Distritos_de_Costa_Rica.kml');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const textoKML = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(textoKML, 'text/xml');
                
                const placemarks = xmlDoc.querySelectorAll('Placemark');
                window.datosKML = {};
                
                placemarks.forEach(placemark => {
                    const extendedData = placemark.querySelector('ExtendedData');
                    if (!extendedData) return;
                    
                    const datos = {};
                    const simpleData = extendedData.querySelectorAll('SimpleData');
                    simpleData.forEach(data => {
                        const name = data.getAttribute('name');
                        const value = data.textContent;
                        datos[name] = value;
                    });
                    
                    const polygon = placemark.querySelector('Polygon');
                    if (polygon) {
                        const allCoords = [];
                        
                        const outerBoundary = polygon.querySelector('outerBoundaryIs coordinates');
                        if (outerBoundary) {
                            const coordsText = outerBoundary.textContent.trim();
                            const coordsArray = coordsText.split(/\s+/).map(coord => {
                                const parts = coord.split(',');
                                if (parts.length >= 2) {
                                    const lon = parseFloat(parts[0]);
                                    const lat = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lon)) {
                                        return [lat, lon];
                                    }
                                }
                                return null;
                            }).filter(coord => coord !== null);
                            
                            if (coordsArray.length > 0) {
                                allCoords.push(coordsArray);
                            }
                        }
                        
                        const innerBoundaries = polygon.querySelectorAll('innerBoundaryIs coordinates');
                        innerBoundaries.forEach(innerBoundary => {
                            const coordsText = innerBoundary.textContent.trim();
                            const coordsArray = coordsText.split(/\s+/).map(coord => {
                                const parts = coord.split(',');
                                if (parts.length >= 2) {
                                    const lon = parseFloat(parts[0]);
                                    const lat = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lon)) {
                                        return [lat, lon];
                                    }
                                }
                                return null;
                            }).filter(coord => coord !== null);
                            
                            if (coordsArray.length > 0) {
                                allCoords.push(coordsArray);
                            }
                        });
                        
                        if (allCoords.length > 0) {
                            const clave = `${datos.COD_PROV}-${datos.COD_CANT}-${datos.COD_DIST}`;
                            
                            if (!window.datosKML[clave]) {
                                window.datosKML[clave] = {
                                    COD_PROV: datos.COD_PROV,
                                    COD_CANT: datos.COD_CANT,
                                    COD_DIST: datos.COD_DIST,
                                    CODIGO: datos.CODIGO,
                                    NOM_PROV: datos.NOM_PROV,
                                    NOM_CANT: datos.NOM_CANT,
                                    NOM_DIST: datos.NOM_DIST,
                                    coordenadas: allCoords
                                };
                            } else {
                                window.datosKML[clave].coordenadas.push(...allCoords);
                            }
                        }
                    }
                });
                
                console.log(`‚úÖ KML cargado: ${Object.keys(window.datosKML).length} distritos √∫nicos`);
                return true;
            } catch (error) {
                console.error('‚ùå Error cargando KML:', error);
                return false;
            }
        }
        
        // Limpiar pol√≠gonos del mapa
        window.limpiarPoligonosEdit = function() {
            if (window.poligonosEdit && window.mapaUbicacionEdit) {
                window.mapaUbicacionEdit.removeLayer(window.poligonosEdit);
                window.poligonosEdit = null;
            }
        }
        
        // Mostrar todas las provincias del pa√≠s
        function mostrarProvinciasPais() {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            // Agrupar distritos por provincia
            const provinciasMap = {};
            
            Object.keys(window.datosKML).forEach(clave => {
                const distrito = window.datosKML[clave];
                const provinciaId = distrito.COD_PROV;
                
                if (!provinciasMap[provinciaId]) {
                    provinciasMap[provinciaId] = {
                        id: provinciaId,
                        nombre: distrito.NOM_PROV,
                        coordenadas: []
                    };
                }
                
                // Agregar todas las coordenadas de los distritos de esta provincia
                if (distrito.coordenadas) {
                    distrito.coordenadas.forEach(coords => {
                        if (coords && coords.length > 0) {
                            provinciasMap[provinciaId].coordenadas.push(coords);
                        }
                    });
                }
            });
            
            const provincias = Object.values(provinciasMap);
            const colores = generarColores(provincias.length);
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            provincias.forEach((provincia, index) => {
                const color = colores[index];
                
                // Crear un pol√≠gono por cada conjunto de coordenadas de la provincia
                provincia.coordenadas.forEach(coords => {
                    if (coords && coords.length > 0) {
                        const polygon = L.polygon(coords, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.25,
                            weight: 2
                        });
                        
                        const info = `<b>${provincia.nombre}</b><br>Provincia de Costa Rica`;
                        polygon.bindPopup(info);
                        
                        // Click para seleccionar provincia
                        polygon.on('click', function() {
                            seleccionarProvinciaDesdeMapa(provincia.id);
                        });
                        
                        polygon.on('mouseover', function() {
                            this.setStyle({ weight: 3, fillOpacity: 0.4 });
                        });
                        
                        polygon.on('mouseout', function() {
                            this.setStyle({ weight: 2, fillOpacity: 0.25 });
                        });
                        
                        // Guardar informaci√≥n de la provincia
                        polygon._provinciaId = provincia.id;
                        polygon._provinciaNombre = provincia.nombre;
                        
                        window.poligonosEdit.addLayer(polygon);
                        bounds.push(polygon.getBounds());
                    }
                });
            });
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds);
            }
        }
        
        // Seleccionar provincia desde el mapa
        function seleccionarProvinciaDesdeMapa(provinciaId) {
            const selectProvincia = document.getElementById('editProvincia');
            
            if (selectProvincia) {
                selectProvincia.value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                // Disparar evento change para que se ejecuten los listeners
                const changeEvent = new Event('change', { bubbles: true });
                selectProvincia.dispatchEvent(changeEvent);
                
                // Mostrar cantones en el mapa
                setTimeout(() => {
                    mostrarCantonesProvincia(provinciaId);
                }, 100);
            }
        }
        
        // Mostrar cantones de una provincia
        window.mostrarCantonesProvincia = function(provinciaId) {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones) return;
            
            const cantones = Object.values(provincia.cantones);
            const colores = generarColores(cantones.length);
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            cantones.forEach((canton, index) => {
                const color = colores[index];
                let tienePoligonos = false;
                
                // Buscar todos los distritos de este cant√≥n
                if (canton.distritos) {
                    Object.values(canton.distritos).forEach(distrito => {
                        const clave = `${provinciaId}-${canton.id}-${distrito.id}`;
                        const distritoKML = window.datosKML[clave];
                        
                        if (distritoKML && distritoKML.coordenadas) {
                            distritoKML.coordenadas.forEach(coords => {
                                if (coords && coords.length > 0) {
                                    tienePoligonos = true;
                                    const polygon = L.polygon(coords, {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: 0.3,
                                        weight: 2
                                    });
                                    
                                    const info = `<b>${distritoKML.NOM_CANT}</b><br>Distrito: ${distritoKML.NOM_DIST}`;
                                    polygon.bindPopup(info);
                                    
                                    // Click para seleccionar cant√≥n
                                    polygon.on('click', function() {
                                        seleccionarCantonDesdeMapa(provinciaId, canton.id);
                                    });
                                    
                                    polygon.on('mouseover', function() {
                                        this.setStyle({ weight: 3, fillOpacity: 0.5 });
                                    });
                                    
                                    polygon.on('mouseout', function() {
                                        this.setStyle({ weight: 2, fillOpacity: 0.3 });
                                    });
                                    
                                    // Guardar informaci√≥n del cant√≥n
                                    polygon._provinciaId = provinciaId;
                                    polygon._cantonId = canton.id;
                                    polygon._cantonNombre = canton.nombre;
                                    
                                    window.poligonosEdit.addLayer(polygon);
                                    bounds.push(polygon.getBounds());
                                }
                            });
                        }
                    });
                }
            });
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds);
            }
        }
        
        // Mostrar distritos de un cant√≥n
        window.mostrarDistritosCanton = function(provinciaId, cantonId) {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones || !provincia.cantones[cantonId]) return;
            
            const canton = provincia.cantones[cantonId];
            if (!canton || !canton.distritos) return;
            
            const distritos = Object.values(canton.distritos);
            const colores = generarColores(distritos.length);
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            distritos.forEach((distrito, index) => {
                const color = colores[index];
                const clave = `${provinciaId}-${cantonId}-${distrito.id}`;
                const distritoKML = window.datosKML[clave];
                
                if (distritoKML && distritoKML.coordenadas) {
                    distritoKML.coordenadas.forEach(coords => {
                        if (coords && coords.length > 0) {
                            const polygon = L.polygon(coords, {
                                color: color,
                                fillColor: color,
                                fillOpacity: 0.4,
                                weight: 2
                            });
                            
                            const info = `<b>${distritoKML.NOM_DIST}</b><br>Cant√≥n: ${distritoKML.NOM_CANT}`;
                            polygon.bindPopup(info);
                            
                            // Click para seleccionar distrito
                            polygon.on('click', function() {
                                seleccionarDistritoDesdeMapa(provinciaId, cantonId, distrito.id);
                            });
                            
                            polygon.on('mouseover', function() {
                                this.setStyle({ weight: 4, fillOpacity: 0.6 });
                            });
                            
                            polygon.on('mouseout', function() {
                                this.setStyle({ weight: 2, fillOpacity: 0.4 });
                            });
                            
                            // Guardar informaci√≥n del distrito
                            polygon._provinciaId = provinciaId;
                            polygon._cantonId = cantonId;
                            polygon._distritoId = distrito.id;
                            polygon._distritoNombre = distrito.nombre;
                            
                            window.poligonosEdit.addLayer(polygon);
                            bounds.push(polygon.getBounds());
                        }
                    });
                }
            });
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds);
            }
        }
        
        // Mostrar distrito seleccionado (para mapa de edici√≥n)
        window.mostrarDistritoSeleccionado = function(provinciaId, cantonId, distritoId) {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            // Mostrar todos los distritos del cant√≥n (en color m√°s claro) y resaltar el seleccionado
            const provincia = window.ubicacionesCR[provinciaId];
            if (provincia && provincia.cantones && provincia.cantones[cantonId]) {
                const canton = provincia.cantones[cantonId];
                if (canton && canton.distritos) {
                    const distritos = Object.values(canton.distritos);
                    distritos.forEach((distrito) => {
                        const claveCanton = `${provinciaId}-${cantonId}-${distrito.id}`;
                        const distritoKML = window.datosKML[claveCanton];
                        
                        if (distritoKML && distritoKML.coordenadas) {
            distritoKML.coordenadas.forEach(coords => {
                if (coords && coords.length > 0) {
                                    // Color rojo para el distrito seleccionado, azul claro para los dem√°s
                                    const color = distrito.id === distritoId ? '#ff0000' : '#0066ff';
                                    const opacity = distrito.id === distritoId ? 0.5 : 0.2;
                                    const weight = distrito.id === distritoId ? 3 : 2;
                                    
                    const polygon = L.polygon(coords, {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: opacity,
                                        weight: weight
                    });
                    
                    const info = `<b>${distritoKML.NOM_DIST}</b><br>Cant√≥n: ${distritoKML.NOM_CANT}<br>Provincia: ${distritoKML.NOM_PROV}`;
                                    polygon.bindPopup(info);
                                    
                                    // Abrir popup solo para el distrito seleccionado
                                    if (distrito.id === distritoId) {
                                        polygon.openPopup();
                                    }
                    
                    window.poligonosEdit.addLayer(polygon);
                    bounds.push(polygon.getBounds());
                }
            });
                        }
                    });
                }
            }
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds, { padding: [20, 20] });
            }
        }
        
        // Mostrar distrito y cant√≥n en el mapa de nueva cita
        window.mostrarDistritoYCantonNew = function(provinciaId, cantonId, distritoId) {
            if (!window.mapaUbicacionNew || !window.datosKML || !window.ubicacionesCR) return;
            
            // Limpiar pol√≠gonos anteriores
            if (window.poligonosNew) {
                window.mapaUbicacionNew.removeLayer(window.poligonosNew);
            }
            
            window.poligonosNew = L.layerGroup();
            const bounds = [];
            
            // Primero mostrar todos los distritos del cant√≥n (en color m√°s claro)
            const provincia = window.ubicacionesCR[provinciaId];
            if (provincia && provincia.cantones && provincia.cantones[cantonId]) {
                const canton = provincia.cantones[cantonId];
                if (canton && canton.distritos) {
                    const distritos = Object.values(canton.distritos);
                    distritos.forEach((distrito) => {
                        const claveCanton = `${provinciaId}-${cantonId}-${distrito.id}`;
                        const distritoKML = window.datosKML[claveCanton];
                        
                        if (distritoKML && distritoKML.coordenadas) {
                            distritoKML.coordenadas.forEach(coords => {
                                if (coords && coords.length > 0) {
                                    // Color m√°s claro para todos los distritos del cant√≥n
                                    const color = distrito.id === distritoId ? '#ff0000' : '#0066ff';
                                    const opacity = distrito.id === distritoId ? 0.5 : 0.2;
                                    const weight = distrito.id === distritoId ? 3 : 2;
                                    
                                    const polygon = L.polygon(coords, {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: opacity,
                                        weight: weight
                                    });
                                    
                                    const info = `<b>${distritoKML.NOM_DIST}</b><br>Cant√≥n: ${distritoKML.NOM_CANT}<br>Provincia: ${distritoKML.NOM_PROV}`;
                                    polygon.bindPopup(info);
                                    
                                    window.poligonosNew.addLayer(polygon);
                                    bounds.push(polygon.getBounds());
                                }
                            });
                        }
                    });
                }
            }
            
            // Agregar pol√≠gonos al mapa
            if (bounds.length > 0) {
                window.poligonosNew.addTo(window.mapaUbicacionNew);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionNew.fitBounds(groupBounds, { padding: [20, 20] });
            }
        }
        
        // Funci√≥n para actualizar encabezado autom√°tico de Nueva Cita - ELIMINADA (encabezado removido)
        
        // Generar colores para pol√≠gonos
        function generarColores(cantidad) {
            const colores = [];
            for (let i = 0; i < cantidad; i++) {
                const hue = (i * 137.508) % 360;
                const saturation = 60 + (i % 3) * 10;
                const lightness = 45 + (i % 2) * 10;
                colores.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
            }
            return colores;
        }
        
        // Seleccionar cant√≥n desde el mapa
        function seleccionarCantonDesdeMapa(provinciaId, cantonId) {
            const selectProvincia = document.getElementById('editProvincia');
            const selectCanton = document.getElementById('editCanton');
            
            if (selectProvincia && selectCanton) {
                // Establecer provincia y disparar evento change
                selectProvincia.value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                // Disparar evento change para que se ejecuten los listeners
                const changeEvent = new Event('change', { bubbles: true });
                selectProvincia.dispatchEvent(changeEvent);
                
                // Esperar a que se llenen los cantones
                setTimeout(() => {
                    if (selectCanton.options.length > 1) {
                        selectCanton.disabled = false;
                        selectCanton.value = cantonId;
                        
                        // Disparar evento change del cant√≥n
                        const cantonChangeEvent = new Event('change', { bubbles: true });
                        selectCanton.dispatchEvent(cantonChangeEvent);
                        
                        // Mostrar distritos en el mapa
                        setTimeout(() => {
                            if (window.mostrarDistritosCanton) {
                                window.mostrarDistritosCanton(provinciaId, cantonId);
                            }
                        }, 50);
                    }
                }, 150);
            }
        }
        
        // Seleccionar distrito desde el mapa
        function seleccionarDistritoDesdeMapa(provinciaId, cantonId, distritoId) {
            const selectProvincia = document.getElementById('editProvincia');
            const selectCanton = document.getElementById('editCanton');
            const selectDistrito = document.getElementById('editDistrito');
            
            if (selectProvincia && selectCanton && selectDistrito) {
                // Establecer provincia y disparar evento change
                selectProvincia.value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                // Disparar evento change para que se ejecuten los listeners
                const provinciaChangeEvent = new Event('change', { bubbles: true });
                selectProvincia.dispatchEvent(provinciaChangeEvent);
                
                // Esperar a que se llenen los cantones
                setTimeout(() => {
                    if (selectCanton.options.length > 1) {
                        selectCanton.disabled = false;
                        selectCanton.value = cantonId;
                        llenarDistritosEdit(provinciaId, cantonId);
                        
                        // Disparar evento change del cant√≥n
                        const cantonChangeEvent = new Event('change', { bubbles: true });
                        selectCanton.dispatchEvent(cantonChangeEvent);
                        
                        // Esperar a que se llenen los distritos
                        setTimeout(() => {
                            if (selectDistrito.options.length > 1) {
                                selectDistrito.disabled = false;
                                selectDistrito.value = distritoId;
                                
                                // Disparar evento change del distrito
                                const distritoChangeEvent = new Event('change', { bubbles: true });
                                selectDistrito.dispatchEvent(distritoChangeEvent);
                                
                                // Mostrar distrito en el mapa
                                setTimeout(() => {
                                    if (window.mostrarDistritoSeleccionado) {
                                        window.mostrarDistritoSeleccionado(provinciaId, cantonId, distritoId);
                                    }
                                }, 50);
                            }
                        }, 150);
                    }
                }, 150);
            }
        }
        
        // Funci√≥n para generar y descargar CSV de ubicaciones
        function descargarUbicacionesCSV() {
            if (!window.ubicacionesCR) {
                alert('‚ö†Ô∏è Las ubicaciones no est√°n cargadas. Por favor, espera un momento e intenta de nuevo.');
                return;
            }
            
            // Crear array para almacenar todas las combinaciones
            const combinaciones = [];
            
            // Encabezados del CSV
            combinaciones.push(['Provincia ID', 'Provincia Nombre', 'Cant√≥n ID', 'Cant√≥n Nombre', 'Distrito ID', 'Distrito Nombre']);
            
            // Recorrer todas las provincias
            Object.values(window.ubicacionesCR).forEach(provincia => {
                const provinciaId = provincia.id || '';
                const provinciaNombre = provincia.nombre || '';
                
                // Si la provincia no tiene cantones, agregar solo la provincia
                if (!provincia.cantones || Object.keys(provincia.cantones).length === 0) {
                    combinaciones.push([provinciaId, provinciaNombre, '', '', '', '']);
                } else {
                    // Recorrer todos los cantones de la provincia
                    Object.values(provincia.cantones).forEach(canton => {
                        const cantonId = canton.id || '';
                        const cantonNombre = canton.nombre || '';
                        
                        // Si el cant√≥n no tiene distritos, agregar solo provincia y cant√≥n
                        if (!canton.distritos || Object.keys(canton.distritos).length === 0) {
                            combinaciones.push([provinciaId, provinciaNombre, cantonId, cantonNombre, '', '']);
                        } else {
                            // Recorrer todos los distritos del cant√≥n
                            Object.values(canton.distritos).forEach(distrito => {
                                const distritoId = distrito.id || '';
                                const distritoNombre = distrito.nombre || '';
                                
                                // Agregar la combinaci√≥n completa
                                combinaciones.push([provinciaId, provinciaNombre, cantonId, cantonNombre, distritoId, distritoNombre]);
                            });
                        }
                    });
                }
            });
            
            // Convertir array a CSV
            const csvContent = combinaciones.map(row => {
                // Escapar comillas y envolver en comillas si contiene comas o comillas
                return row.map(cell => {
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',');
            }).join('\n');
            
            // Crear blob y descargar
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para Excel
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ubicaciones-costa-rica-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`‚úÖ CSV descargado con ${combinaciones.length - 1} combinaciones de ubicaciones`);
        }
        
        // Variable para evitar m√∫ltiples event listeners
        let mapaEditListenerAgregado = false;
        
        // Inicializar mapa en modal de edici√≥n (COPIADO EXACTAMENTE de citas_registradas.html)
        function inicializarMapaEdit() {
            const mapaContainer = document.getElementById('mapaUbicacionEdit');
            if (!mapaContainer || mapaUbicacionEdit) return;
            
            // Esperar a que el modal est√© visible antes de inicializar
            const modal = document.getElementById('editCitaModal');
            if (modal) {
                // Solo agregar el event listener una vez
                if (!mapaEditListenerAgregado) {
                    mapaEditListenerAgregado = true;
                    
                    // Escuchar cuando el modal se muestre
                    modal.addEventListener('shown.bs.modal', function() {
                        if (!mapaUbicacionEdit) {
                            // Peque√±o delay para asegurar que el contenedor est√© visible
                            setTimeout(() => {
                                try {
                                    const contenedor = document.getElementById('mapaUbicacionEdit');
                                    if (!contenedor) {
                                        console.warn('‚ö†Ô∏è Contenedor mapaUbicacionEdit no encontrado');
                                        return;
                                    }
                                    
                                    // Verificar si ya hay un mapa en el contenedor
                                    if (contenedor._leaflet_id) {
                                        console.log('‚ö†Ô∏è Ya hay un mapa en el contenedor, limpiando...');
                                        // Intentar obtener el mapa existente y removerlo
                                        try {
                                            const mapaExistente = contenedor._leaflet_id ? window.L && window.L.DomUtil && window.L.DomUtil.get(contenedor) : null;
                                            if (mapaExistente && mapaExistente.remove) {
                                                mapaExistente.remove();
                                            }
                                        } catch (e) {
                                            // Si no se puede remover, limpiar el contenedor
                                            contenedor.innerHTML = '';
                                        }
                                    }
                                    
                                    // Centro de Costa Rica
                                    const nuevoMapa = L.map('mapaUbicacionEdit').setView([9.7489, -83.7534], 8);
                                    
                                    // IMPORTANTE: Asignar a la variable global ANTES de agregar capas
                                    window.mapaUbicacionEdit = nuevoMapa;
                                    mapaUbicacionEdit = nuevoMapa; // Sincronizar alias local
                                    
                                    // Agregar capa de Esri World Street Map (similar a Google Maps)
                                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                                        attribution: '¬© Esri',
                                        maxZoom: 19
                                    }).addTo(mapaUbicacionEdit);
                                    
                                    // Verificar que la asignaci√≥n fue correcta
                                    if (window.mapaUbicacionEdit && typeof window.mapaUbicacionEdit.setView === 'function') {
                                        console.log('‚úÖ Mapa de edici√≥n inicializado correctamente', {
                                            tipo: typeof window.mapaUbicacionEdit,
                                            tieneSetView: typeof window.mapaUbicacionEdit.setView,
                                            tieneInvalidateSize: typeof window.mapaUbicacionEdit.invalidateSize
                                        });
                                        
                                        // Invalidar tama√±o para asegurar que se renderice correctamente
                                        setTimeout(() => {
                                            if (window.mapaUbicacionEdit && typeof window.mapaUbicacionEdit.invalidateSize === 'function') {
                                                window.mapaUbicacionEdit.invalidateSize();
                                                
                                                // Mostrar provincias del pa√≠s al inicio si no hay selecci√≥n
                                                if (window.datosKML && window.ubicacionesCR) {
                                                    const selectProvincia = document.getElementById('editProvincia');
                                                    if (selectProvincia && !selectProvincia.value) {
                                                        mostrarProvinciasPais();
                                                    }
                                                }
                                            }
                                        }, 100);
                                    } else {
                                        console.error('‚ùå Error: mapaUbicacionEdit no es v√°lido despu√©s de la asignaci√≥n');
                                        window.mapaUbicacionEdit = null;
                                        mapaUbicacionEdit = null;
                                    }
                                } catch (error) {
                                    console.error('‚ùå Error al inicializar mapa:', error);
                                    window.mapaUbicacionEdit = null;
                                    mapaUbicacionEdit = null;
                                }
                            }, 300);
                        } else {
                            // Si ya existe, solo invalidar tama√±o y mostrar provincias si no hay selecci√≥n
                            setTimeout(() => {
                                if (window.mapaUbicacionEdit && typeof window.mapaUbicacionEdit.invalidateSize === 'function') {
                                    window.mapaUbicacionEdit.invalidateSize();
                                    
                                    // Mostrar provincias del pa√≠s si no hay selecci√≥n
                                    if (window.datosKML && window.ubicacionesCR) {
                                        const selectProvincia = document.getElementById('editProvincia');
                                        if (selectProvincia && !selectProvincia.value) {
                                            mostrarProvinciasPais();
                                        }
                                    }
                                }
                            }, 100);
                        }
                    });
                }
            } else {
                // Si no hay modal, inicializar directamente
                try {
                    window.mapaUbicacionEdit = L.map('mapaUbicacionEdit').setView([9.7489, -83.7534], 8);
                    mapaUbicacionEdit = window.mapaUbicacionEdit;
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '¬© Esri',
                        maxZoom: 19
                    }).addTo(mapaUbicacionEdit);
                } catch (error) {
                    console.error('‚ùå Error al inicializar mapa:', error);
                    window.mapaUbicacionEdit = null;
                    mapaUbicacionEdit = null;
                }
            }
        }
        
        // Funci√≥n para mostrar ruta en mapa
        window.mostrarRutaVehiculo = async function(rutaNombre, rutaId) {
            try {
                // Obtener citas desde la variable global
                if (!window.citasPorRutaRuta || !window.citasPorRutaRuta[rutaId]) {
                    alert('No se encontraron citas para esta ruta.');
                    return;
                }
                const citas = window.citasPorRutaRuta[rutaId];
                
                // Filtrar citas con coordenadas GPS (desde sucursales)
                const citasConUbicacion = [];
                for (const cita of citas) {
                    const sucursalIndice = cita.metadata?.sucursalIndice;
                    // Obtener tel√©fono desde la fuente de verdad (cita.telefono)
                    const clienteTelefono = window.obtenerTelefono(cita);
                    
                    if (window.esSucursalIndiceValido(sucursalIndice) && clienteTelefono) {
                        try {
                            const sucursal = await window.obtenerSucursalPorIndice(clienteTelefono, sucursalIndice);
                            if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                                citasConUbicacion.push({ cita, coordenadas: sucursal.coordenadas });
                            }
                        } catch (error) {
                            console.warn('Error obteniendo coordenadas de sucursal:', error);
                        }
                    }
                    // Fallback para citas antiguas que a√∫n tienen coordenadas en metadata
                    else if (window.sonCoordenadasValidas(cita.metadata?.coordenadas)) {
                        citasConUbicacion.push({ cita, coordenadas: cita.metadata.coordenadas });
                    }
                }
                
                if (citasConUbicacion.length === 0) {
                    alert('No hay citas con coordenadas GPS para esta ruta.');
                    return;
                }
                
                // Ordenar citas por hora
                citasConUbicacion.sort((a, b) => {
                    const fechaA = window.formatearFecha(window.obtenerInicio(a.cita));
                    const fechaB = window.formatearFecha(window.obtenerInicio(b.cita));
                    if (!fechaA || !fechaB) return 0;
                    return fechaA.getTime() - fechaB.getTime();
                });
                
                // Obtener coordenadas GPS desde sucursales
                const puntosRuta = [];
                for (let i = 0; i < citasConUbicacion.length; i++) {
                    const { cita, coordenadas } = citasConUbicacion[i];
                    
                    if (coordenadas && coordenadas.lat && coordenadas.lng) {
                        const fechaInicio = window.formatearFecha(window.obtenerInicio(cita));
                        const horaInicio = fechaInicio ? fechaInicio.toLocaleTimeString('es-CR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }) : 'N/A';
                        
                        // Obtener informaci√≥n adicional de la cita
                        // Usar versi√≥n s√≠ncrona para evitar Promises
                        const cliente = window.obtenerClienteNombreSync ? window.obtenerClienteNombreSync(cita) : (cita.metadata?.cliente_nombre || cita.client_name || 'Sin nombre');
                        const descripcion = window.obtenerDescripcion(cita);
                        const otrasSenas = cita.metadata?.otras_se√±as || '';
                        
                        // Construir ubicaci√≥n usando coordenadas y otras se√±as si est√°n disponibles
                        let ubicacionTexto = `Lat: ${coordenadas.lat.toFixed(6)}, Lng: ${coordenadas.lng.toFixed(6)}`;
                        if (otrasSenas) {
                            ubicacionTexto += ` - ${otrasSenas}`;
                        }
                        
                        puntosRuta.push({
                            numero: i + 1,
                            lat: coordenadas.lat,
                            lon: coordenadas.lng,
                            cliente: cliente,
                            hora: horaInicio,
                            descripcion: descripcion,
                            ubicacion: ubicacionTexto,
                            otrasSenas: otrasSenas
                        });
                    }
                }
                
                if (puntosRuta.length === 0) {
                    alert('No se pudieron obtener coordenadas para las citas.');
                    return;
                }
                
                // Actualizar nombre de la ruta en el modal
                document.getElementById('rutaVehiculoNombre').textContent = rutaNombre;
                
                // Informaci√≥n de la ruta (calcular antes de mostrar el modal) - Formato visual mejorado y compacto
                let infoHtml = `
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem; border: 2px solid #1976D2;">
                        <h6 style="color: #1976D2; font-weight: 700; margin-bottom: 0.4rem; text-align: center; font-size: 0.95rem;">
                            <i class="fas fa-route me-2"></i>Ruta con ${puntosRuta.length} paradas
                        </h6>
                        <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                `;
                
                puntosRuta.forEach((punto, index) => {
                    const cita = citasConUbicacion[index];
                    
                    // Calcular duraci√≥n de la cita
                    let duracionCita = '';
                    if (cita) {
                        const duracionMinutos = window.obtenerDuracion(cita);
                        const horas = Math.floor(duracionMinutos / 60);
                        const minutos = duracionMinutos % 60;
                        if (horas > 0) {
                            duracionCita = `${horas}h ${minutos}m`;
                        } else {
                            duracionCita = `${minutos}m`;
                        }
                    }
                    
                    // Calcular tiempo de traslado al siguiente punto
                    let tiempoTraslado = '';
                    let distanciaKm = '';
                    if (index < puntosRuta.length - 1 && cita) {
                        const fechaInicio = window.formatearFecha(window.obtenerInicio(cita));
                        const duracionMinutos = window.obtenerDuracion(cita);
                        const fechaFinCita = new Date(fechaInicio.getTime() + (duracionMinutos * 60000));
                        
                        const siguienteCita = citasConUbicacion[index + 1];
                        if (siguienteCita) {
                            const fechaInicioSiguiente = window.formatearFecha(window.obtenerInicio(siguienteCita));
                            const tiempoTrasladoMs = fechaInicioSiguiente.getTime() - fechaFinCita.getTime();
                            const tiempoTrasladoMinutos = Math.floor(tiempoTrasladoMs / 60000);
                            
                            if (tiempoTrasladoMinutos > 0) {
                                const horasTraslado = Math.floor(tiempoTrasladoMinutos / 60);
                                const minutosTraslado = tiempoTrasladoMinutos % 60;
                                if (horasTraslado > 0) {
                                    tiempoTraslado = `${horasTraslado}h ${minutosTraslado}m`;
                                } else {
                                    tiempoTraslado = `${minutosTraslado}m`;
                                }
                            }
                            
                            // Calcular distancia
                            const lat1 = punto.lat;
                            const lon1 = punto.lon;
                            const lat2 = puntosRuta[index + 1].lat;
                            const lon2 = puntosRuta[index + 1].lon;
                            const R = 6371; // Radio de la Tierra en km
                            const dLat = (lat2 - lat1) * Math.PI / 180;
                            const dLon = (lon2 - lon1) * Math.PI / 180;
                            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                      Math.sin(dLon/2) * Math.sin(dLon/2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            distanciaKm = (R * c).toFixed(1);
                        }
                    }
                    
                    infoHtml += `
                        <div style="display: flex; align-items: center; gap: 0.4rem; background: white; border-radius: 5px; padding: 0.4rem; box-shadow: 0 1px 2px rgba(25, 118, 210, 0.15); border-left: 3px solid #1976D2;">
                            <div style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem; flex-shrink: 0; box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);">
                                ${punto.numero}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #212529; font-size: 0.85rem; margin-bottom: 0.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${punto.cliente}
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #6c757d; flex-wrap: wrap;">
                                    <span style="display: flex; align-items: center; gap: 0.2rem;">
                                        <i class="fas fa-clock" style="color: #1976D2; font-size: 0.7rem;"></i>
                                        <span style="font-weight: 600; color: #495057;">${punto.hora}</span>
                                    </span>
                                    ${duracionCita ? `
                                        <span style="background: #e8f5e9; color: #2e7d32; padding: 0.1rem 0.35rem; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">
                                            <i class="fas fa-hourglass-half" style="font-size: 0.65rem;"></i> ${duracionCita}
                                        </span>
                                    ` : ''}
                                    ${distanciaKm ? `
                                        <span style="background: #e3f2fd; color: #1976D2; padding: 0.1rem 0.35rem; border-radius: 3px; font-weight: 600; font-size: 0.7rem; border: 1px solid #90caf9;">
                                            <i class="fas fa-route" style="font-size: 0.65rem;"></i> ${distanciaKm} km
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Agregar informaci√≥n de traslado entre paradas
                    if (index < puntosRuta.length - 1 && tiempoTraslado) {
                        infoHtml += `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.2rem 0.4rem; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 4px; margin: 0 0.3rem; border: 1px solid #ffb74d;">
                                <i class="fas fa-arrow-down" style="color: #f57c00; font-size: 0.8rem;"></i>
                                <span style="font-size: 0.7rem; color: #e65100; font-weight: 600;">
                                    <i class="fas fa-car" style="font-size: 0.65rem;"></i> Traslado: ${tiempoTraslado}
                                </span>
                                <i class="fas fa-arrow-down" style="color: #f57c00; font-size: 0.8rem;"></i>
                            </div>
                        `;
                    }
                });
                
                infoHtml += `
                        </div>
                    </div>
                `;
                
                document.getElementById('rutaInfo').innerHTML = infoHtml;
                
                // Obtener referencia al modal
                const modalElement = document.getElementById('modalRutaVehiculo');
                if (!modalElement) {
                    console.error('‚ùå Modal modalRutaVehiculo no encontrado en el DOM');
                    alert('Error: El modal de ruta no se encuentra. Por favor recarga la p√°gina.');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement);
                
                // Limpiar mapa anterior si existe
                if (window.mapaRutaVehiculo) {
                    window.mapaRutaVehiculo.remove();
                    window.mapaRutaVehiculo = null;
                }
                
                // Verificar que el contenedor del mapa exista antes de mostrar el modal
                // Buscar de m√∫ltiples formas para asegurar que se encuentre
                console.log('üîç Buscando contenedor del mapa...');
                console.log('Modal element:', modalElement);
                console.log('Modal innerHTML length:', modalElement.innerHTML.length);
                
                let mapaContainerCheck = null;
                
                // Intentar buscar por ID directamente primero (m√°s confiable)
                mapaContainerCheck = document.getElementById('mapaRutaVehiculo');
                if (mapaContainerCheck) {
                    console.log('‚úÖ Contenedor encontrado por getElementById');
                } else {
                    // Buscar dentro del modal
                    mapaContainerCheck = modalElement.querySelector('#mapaRutaVehiculo');
                    if (mapaContainerCheck) {
                        console.log('‚úÖ Contenedor encontrado dentro del modal');
                    } else {
                        // Buscar cualquier div dentro del modal-body
                        const modalBody = modalElement.querySelector('.modal-body');
                        if (modalBody) {
                            console.log('Modal body encontrado, buscando divs...');
                            const divs = modalBody.querySelectorAll('div');
                            console.log('Divs encontrados:', divs.length);
                            for (let div of divs) {
                                if (div.id && div.id.includes('mapa')) {
                                    mapaContainerCheck = div;
                                    console.log('‚úÖ Contenedor encontrado por b√∫squeda de divs:', div.id);
                                    break;
                                }
                            }
                        }
                    }
                }
                
                if (!mapaContainerCheck) {
                    console.error('‚ùå Contenedor mapaRutaVehiculo no encontrado dentro del modal');
                    console.log('Modal HTML (primeros 1000 caracteres):', modalElement.innerHTML.substring(0, 1000));
                    // Intentar crear el contenedor si no existe
                    const modalBody = modalElement.querySelector('.modal-body');
                    if (modalBody) {
                        console.log('‚ö†Ô∏è Creando contenedor del mapa din√°micamente...');
                        const nuevoContenedor = document.createElement('div');
                        nuevoContenedor.id = 'mapaRutaVehiculo';
                        nuevoContenedor.style.cssText = 'height: 600px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6;';
                        modalBody.insertBefore(nuevoContenedor, modalBody.firstChild);
                        mapaContainerCheck = nuevoContenedor;
                        console.log('‚úÖ Contenedor del mapa creado din√°micamente');
                    } else {
                        alert('Error: El modal no tiene un cuerpo v√°lido. Por favor recarga la p√°gina.');
                        return;
                    }
                } else {
                    console.log('‚úÖ Contenedor del mapa encontrado antes de mostrar modal');
                }
                
                // Esperar a que el modal est√© completamente visible antes de inicializar el mapa
                modalElement.addEventListener('shown.bs.modal', function inicializarMapaRuta() {
                    // Remover el listener para evitar m√∫ltiples inicializaciones
                    modalElement.removeEventListener('shown.bs.modal', inicializarMapaRuta);
                    
                    // Contador de reintentos
                    let intentos = 0;
                    const maxIntentos = 20; // M√°ximo 20 intentos (1 segundo)
                    
                    // Funci√≥n para intentar inicializar el mapa
                    const intentarInicializarMapa = () => {
                        intentos++;
                        
                        // Verificar si se excedi√≥ el l√≠mite de intentos
                        if (intentos > maxIntentos) {
                            console.error('‚ùå No se pudo encontrar el contenedor del mapa despu√©s de', maxIntentos, 'intentos');
                            alert('Error: No se pudo inicializar el mapa. Por favor, cierra y vuelve a abrir el modal.');
                            return;
                        }
                        
                        // Buscar el contenedor dentro del modal
                        const mapaContainer = modalElement.querySelector('#mapaRutaVehiculo') || document.getElementById('mapaRutaVehiculo');
                        
                        if (!mapaContainer) {
                            console.warn(`‚ö†Ô∏è Contenedor del mapa a√∫n no disponible (intento ${intentos}/${maxIntentos}), reintentando...`);
                            setTimeout(intentarInicializarMapa, 50);
                            return;
                        }
                        
                        // Verificar que el contenedor tenga dimensiones
                        if (mapaContainer.offsetWidth === 0 || mapaContainer.offsetHeight === 0) {
                            console.warn(`‚ö†Ô∏è Contenedor del mapa sin dimensiones (intento ${intentos}/${maxIntentos}), reintentando...`);
                            setTimeout(intentarInicializarMapa, 50);
                            return;
                        }
                        
                        console.log('‚úÖ Contenedor del mapa encontrado, inicializando...');
                        
                        // Verificar que el contenedor est√© en el DOM
                        if (!mapaContainer.isConnected || !mapaContainer.parentNode) {
                            console.warn('‚ö†Ô∏è Contenedor no est√° conectado al DOM, reintentando...');
                            setTimeout(intentarInicializarMapa, 50);
                            return;
                        }
                        
                        // Crear mapa usando el elemento DOM directamente, no el ID
                        window.mapaRutaVehiculo = L.map(mapaContainer).setView([puntosRuta[0].lat, puntosRuta[0].lon], 11);
                        
                        // Agregar capa CartoDB Voyager (muestra mejor carreteras y divisiones administrativas)
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                            subdomains: 'abcd',
                            maxZoom: 19
                        }).addTo(window.mapaRutaVehiculo);
                        
                        // Agregar marcadores numerados y l√≠neas
                        const coordenadasRuta = [];
                        puntosRuta.forEach((punto, index) => {
                            coordenadasRuta.push([punto.lat, punto.lon]);
                            
                            // Crear icono personalizado con n√∫mero
                            const icono = L.divIcon({
                                className: 'marcador-ruta',
                                html: `<div style="background: #1976D2; color: white; border-radius: 50%; width: 30px; height: 30px; 
                                              display: flex; align-items: center; justify-content: center; font-weight: bold; 
                                              font-size: 14px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                        ${punto.numero}
                                      </div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            });
                            
                            // Agregar marcador
                            const marcador = L.marker([punto.lat, punto.lon], { icon: icono }).addTo(window.mapaRutaVehiculo);
                            
                            // Popup con informaci√≥n
                            const popupContent = `
                                <div style="font-size: 0.9rem;">
                                    <strong>üìç Parada ${punto.numero}</strong><br>
                                    <strong>Cliente:</strong> ${punto.cliente}<br>
                                    <strong>Hora:</strong> ${punto.hora}<br>
                                    ${punto.descripcion ? `<strong>Descripci√≥n:</strong> ${punto.descripcion}<br>` : ''}
                                    <strong>Coordenadas:</strong> ${punto.lat.toFixed(6)}, ${punto.lon.toFixed(6)}<br>
                                    ${punto.otrasSenas ? `<strong>Otras Se√±as:</strong> ${punto.otrasSenas}<br>` : ''}
                                    <a href="https://www.google.com/maps?q=${punto.lat},${punto.lon}" target="_blank" rel="noopener noreferrer" style="color: #1976D2; text-decoration: none;">
                                        <i class="fas fa-map-marker-alt"></i> Ver en Google Maps
                                    </a> | 
                                    <a href="https://waze.com/ul?ll=${punto.lat},${punto.lon}&navigate=yes" target="_blank" rel="noopener noreferrer" style="color: #1976D2; text-decoration: none;">
                                        <i class="fas fa-route"></i> Ver en Waze
                                    </a>
                                </div>
                            `;
                            marcador.bindPopup(popupContent);
                            
                            // L√≠nea desde el punto anterior (si existe)
                            if (index > 0) {
                                const puntoAnterior = puntosRuta[index - 1];
                                const distancia = window.mapaRutaVehiculo.distance([puntoAnterior.lat, puntoAnterior.lon], [punto.lat, punto.lon]);
                                const distanciaKm = (distancia / 1000).toFixed(1);
                                
                                // L√≠nea con flecha
                                const polyline = L.polyline(
                                    [[puntoAnterior.lat, puntoAnterior.lon], [punto.lat, punto.lon]],
                                    {
                                        color: '#1976D2',
                                        weight: 3,
                                        opacity: 0.7
                                    }
                                ).addTo(window.mapaRutaVehiculo);
                                
                                // Agregar popup a la l√≠nea con distancia
                                polyline.bindPopup(`<strong>Distancia:</strong> ${distanciaKm} km`);
                            }
                        });
                        
                        // Ajustar vista para mostrar todos los puntos
                        if (coordenadasRuta.length > 0) {
                            const bounds = L.latLngBounds(coordenadasRuta);
                            window.mapaRutaVehiculo.fitBounds(bounds, { padding: [50, 50] });
                        }
                        
                        // Invalidar tama√±o del mapa para asegurar renderizado correcto
                        setTimeout(() => {
                            if (window.mapaRutaVehiculo) {
                                window.mapaRutaVehiculo.invalidateSize();
                            }
                        }, 100);
                    };
                    
                    // Intentar inicializar despu√©s de un peque√±o delay
                    setTimeout(intentarInicializarMapa, 100);
                }, { once: true });
                
                // Mostrar modal
                modal.show();
                
            } catch (error) {
                console.error('Error mostrando ruta:', error);
                alert('Error al mostrar la ruta: ' + error.message);
            }
        };
        
        // ========== GESTI√ìN DE PRODUCTOS ==========
        
        // ========== GESTI√ìN DE RUTEADOR ==========
        
        // Variables globales para ruteador
        window.ruteadorActual = {
            fecha: null,
            ruta: null,
            tecnicos: [],
            vehiculos: []
        };
        
        // Lista de veh√≠culos disponibles
        const vehiculosDisponibles = [
            'APV 01', 'APV 02', 'APV 03', 'APV 04', 'APV 05', 
            'APV 06', 'APV 07', 'APV 08', 'Kangoo', 'Yaris', 'Prado', 'Rojo'
        ];
        
        // Funci√≥n para generar ID √∫nico de ruteador (fecha_ruta)
        function generarIdRuteador(fecha, ruta) {
            // fecha en formato YYYY-MM-DD, ruta como "Ruta 1" -> "Ruta-1"
            const fechaFormateada = fecha;
            const rutaFormateada = ruta.replace(' ', '-');
            return `${fechaFormateada}_${rutaFormateada}`;
        }
        
        // Funci√≥n para cargar datos de ruteador desde Firestore
        async function cargarRuteador(fecha, ruta) {
            try {
                const ruteadorId = generarIdRuteador(fecha, ruta);
                const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                const ruteadorDoc = await getDoc(ruteadorRef);
                
                if (ruteadorDoc.exists()) {
                    const data = ruteadorDoc.data();
                    // Normalizar t√©cnicos: convertir IDs a usernames si es necesario
                    const tecnicosNormalizados = (data.tecnicos || []).map(tecnicoId => {
                        if (!tecnicoId || String(tecnicoId).trim() === '') return null;
                        // Buscar empleado por ID o username
                        const empleado = window.empleados?.find(e => 
                            e.id === tecnicoId || 
                            e.username === tecnicoId ||
                            (e.username && e.id === tecnicoId) ||
                            (e.id && e.username === tecnicoId)
                        );
                        // Usar username si existe, sino usar el ID guardado
                        return empleado ? (empleado.username || empleado.id) : tecnicoId;
                    }).filter(t => t !== null);
                    
                    // Normalizar veh√≠culos: trim y filtrar vac√≠os
                    const vehiculosNormalizados = (data.vehiculos || [])
                        .map(v => v ? String(v).trim() : '')
                        .filter(v => v !== '');
                    
                    // Log para depuraci√≥n
                    if (vehiculosNormalizados.length > 0) {
                        console.log('[CARGAR_RUTEADOR] üìã Veh√≠culos cargados desde Firebase', {
                            ruta: ruta,
                            fecha: fecha,
                            vehiculosOriginales: data.vehiculos || [],
                            vehiculosNormalizados: vehiculosNormalizados,
                            vehiculosDetalle: vehiculosNormalizados.map(v => ({
                                valor: v,
                                longitud: v.length,
                                tieneEspacios: v !== v.trim(),
                                caracteres: Array.from(v).map(c => c.charCodeAt(0))
                            }))
                        });
                    }
                    
                    return {
                        fecha: data.fecha || fecha,
                        ruta: data.ruta || ruta,
                        tecnicos: tecnicosNormalizados,
                        vehiculos: vehiculosNormalizados
                    };
                } else {
                    return {
                        fecha: fecha,
                        ruta: ruta,
                        tecnicos: [],
                        vehiculos: []
                    };
                }
            } catch (error) {
                console.error('Error cargando ruteador:', error);
                return {
                    fecha: fecha,
                    ruta: ruta,
                    tecnicos: [],
                    vehiculos: []
                };
            }
        }
        
        // Funci√≥n para validar que no haya duplicados en otras rutas del mismo d√≠a
        async function validarDuplicadosRuteador(fecha, ruta, tecnicos, vehiculos) {
            const errores = [];
            
            try {
                // Filtrar valores vac√≠os o nulos
                const tecnicosValidos = (tecnicos || []).filter(t => t && t.trim() !== '');
                const vehiculosValidos = (vehiculos || []).filter(v => v && v.trim() !== '');
                
                // Si no hay recursos v√°lidos, no hay nada que validar
                if (tecnicosValidos.length === 0 && vehiculosValidos.length === 0) {
                    return [];
                }
                
                // Cargar todos los ruteadores del mismo d√≠a
                const ruteadoresQuery = query(
                    collection(window.db, 'ruteador'),
                    where('fecha', '==', fecha)
                );
                const querySnapshot = await getDocs(ruteadoresQuery);
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const ruteadorId = generarIdRuteador(fecha, ruta);
                    
                    // Ignorar el ruteador actual que estamos editando
                    if (doc.id === ruteadorId) return;
                    
                    // Verificar duplicados de t√©cnicos (solo valores v√°lidos)
                    const tecnicosDuplicados = tecnicosValidos.filter(t => {
                        const tecnicosRuta = (data.tecnicos || []).filter(tr => tr && tr.trim() !== '');
                        return tecnicosRuta.includes(t);
                    });
                    if (tecnicosDuplicados.length > 0) {
                        const empleado = window.empleados?.find(e => e.username === tecnicosDuplicados[0] || e.id === tecnicosDuplicados[0]);
                        const nombreEmpleado = empleado ? `${empleado.primerNombre} ${empleado.primerApellido}` : tecnicosDuplicados[0];
                        errores.push(`El t√©cnico "${nombreEmpleado}" ya est√° asignado a ${data.ruta}`);
                    }
                    
                    // Verificar duplicados de veh√≠culos (solo valores v√°lidos)
                    const vehiculosDuplicados = vehiculosValidos.filter(v => {
                        const vehiculosRuta = (data.vehiculos || []).filter(vr => vr && vr.trim() !== '');
                        return vehiculosRuta.includes(v);
                    });
                    if (vehiculosDuplicados.length > 0) {
                        errores.push(`El veh√≠culo "${vehiculosDuplicados[0]}" ya est√° asignado a ${data.ruta}`);
                    }
                });
                
                return errores;
            } catch (error) {
                console.error('Error validando duplicados:', error);
                return [];
            }
        }
        
        // Funci√≥n para editar ruteador
        window.editarRuteador = async function(ruta, fecha) {
            try {
                // Cargar empleados si no est√°n cargados
                if (!window.empleados || window.empleados.length === 0) {
                    await window.cargarEmpleados();
                }
                
                // Guardar datos actuales
                window.ruteadorActual.fecha = fecha;
                window.ruteadorActual.ruta = ruta;
                
                // Cargar datos existentes
                const datosRuteador = await cargarRuteador(fecha, ruta);
                window.ruteadorActual.tecnicos = datosRuteador.tecnicos || [];
                window.ruteadorActual.vehiculos = datosRuteador.vehiculos || [];
                
                // Actualizar modal
                document.getElementById('ruteadorRutaNombre').textContent = ruta;
                document.getElementById('ruteadorFechaNombre').textContent = new Date(fecha).toLocaleDateString('es-CR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Renderizar t√©cnicos
                renderizarTecnicosRuteador();
                
                // Renderizar veh√≠culos
                renderizarVehiculosRuteador();
                
                // Ocultar errores
                document.getElementById('ruteadorErrores').style.display = 'none';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalRuteador'));
                modal.show();
            } catch (error) {
                console.error('Error editando ruteador:', error);
                alert('Error al cargar datos del ruteador: ' + error.message);
            }
        };
        
        // Funci√≥n para renderizar checkboxes de t√©cnicos
        function renderizarTecnicosRuteador() {
            const container = document.getElementById('ruteadorTecnicosContainer');
            if (!container) return;
            
            const empleadosLista = window.empleados || [];
            if (empleadosLista.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-exclamation-triangle me-2"></i>No hay empleados disponibles</div>';
                return;
            }
            
            container.innerHTML = empleadosLista.map(empleado => {
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                // Usar username como identificador principal, id como fallback
                const username = empleado.username || empleado.id;
                // Verificar si est√° seleccionado comparando con username o id
                const estaSeleccionado = window.ruteadorActual.tecnicos.some(t => 
                    t === username || 
                    t === empleado.username || 
                    t === empleado.id ||
                    (empleado.username && t === empleado.username) ||
                    (empleado.id && t === empleado.id)
                );
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="tecnico_ruteador_${username}" 
                               value="${username}" 
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="tecnico_ruteador_${username}">
                            ${nombreCompleto || username}
                        </label>
                    </div>
                `;
            }).join('');
        }
        
        // Funci√≥n para renderizar checkboxes de veh√≠culos
        function renderizarVehiculosRuteador() {
            const container = document.getElementById('ruteadorVehiculosContainer');
            if (!container) return;
            
            container.innerHTML = vehiculosDisponibles.map(vehiculo => {
                const estaSeleccionado = window.ruteadorActual.vehiculos.includes(vehiculo);
                const vehiculoId = vehiculo.replace(' ', '-');
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="vehiculo_ruteador_${vehiculoId}" 
                               value="${vehiculo}" 
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="vehiculo_ruteador_${vehiculoId}">
                            ${vehiculo}
                        </label>
                    </div>
                `;
            }).join('');
        }
        
        // Funci√≥n para guardar ruteador
        window.guardarRuteador = async function() {
            try {
                // Obtener t√©cnicos seleccionados
                const tecnicosCheckboxes = document.querySelectorAll('#ruteadorTecnicosContainer input[type="checkbox"]:checked');
                // Normalizar: convertir IDs a usernames si es necesario
                const tecnicosSeleccionados = Array.from(tecnicosCheckboxes).map(cb => {
                    const valor = cb.value;
                    // Si el valor es un ID, buscar el empleado y usar su username
                    const empleado = window.empleados?.find(e => e.id === valor || e.username === valor);
                    return empleado ? (empleado.username || empleado.id) : valor;
                }).filter(v => v && v.trim() !== '');
                
                // Obtener veh√≠culos seleccionados
                const vehiculosCheckboxes = document.querySelectorAll('#ruteadorVehiculosContainer input[type="checkbox"]:checked');
                const vehiculosSeleccionados = Array.from(vehiculosCheckboxes).map(cb => cb.value);
                
                // Validar duplicados
                const errores = await validarDuplicadosRuteador(
                    window.ruteadorActual.fecha,
                    window.ruteadorActual.ruta,
                    tecnicosSeleccionados,
                    vehiculosSeleccionados
                );
                
                if (errores.length > 0) {
                    const erroresContainer = document.getElementById('ruteadorErrores');
                    erroresContainer.innerHTML = '<strong>‚ö†Ô∏è Conflictos detectados:</strong><ul class="mb-0 mt-2">' +
                        errores.map(e => `<li>${e}</li>`).join('') + '</ul>';
                    erroresContainer.style.display = 'block';
                    return;
                }
                
                // Ocultar errores si no hay
                document.getElementById('ruteadorErrores').style.display = 'none';
                
                // Guardar en Firestore
                const ruteadorId = generarIdRuteador(window.ruteadorActual.fecha, window.ruteadorActual.ruta);
                const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                
                await setDoc(ruteadorRef, {
                    fecha: window.ruteadorActual.fecha,
                    ruta: window.ruteadorActual.ruta,
                    tecnicos: tecnicosSeleccionados,
                    vehiculos: vehiculosSeleccionados,
                    fecha_actualizacion: serverTimestamp()
                }, { merge: true });
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalRuteador'));
                modal.hide();
                
                // Mostrar notificaci√≥n
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Ruteador guardado exitosamente';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
                
                // Recargar cronograma para mostrar cambios
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            } catch (error) {
                console.error('Error guardando ruteador:', error);
                alert('Error al guardar: ' + error.message);
            }
        };
        
        // Funci√≥n para renderizar recursos sin asignar
        function renderizarRecursosSinAsignar(tecnicos, vehiculos, fecha) {
            console.log('[RENDER] üé® Iniciando renderizado de recursos sin asignar', {
                fecha: fecha,
                totalTecnicos: tecnicos.length,
                totalVehiculos: vehiculos.length,
                tecnicos: tecnicos.map(t => ({
                    username: t.username || t.id || 'VAC√çO',
                    nombre: t.nombre || 'VAC√çO',
                    id: t.id || 'VAC√çO'
                }))
            });
            
            const tecnicosContainer = document.getElementById('tecnicosSinAsignarContainer');
            const vehiculosContainer = document.getElementById('vehiculosSinAsignarContainer');
            
            if (!tecnicosContainer || !vehiculosContainer) {
                console.error('[RENDER] ‚ùå Contenedores no encontrados', {
                    tecnicosContainer: !!tecnicosContainer,
                    vehiculosContainer: !!vehiculosContainer
                });
                return;
            }
            
            // Renderizar t√©cnicos
            const tecnicosFiltrados = tecnicos.filter(t => {
                const username = t.username || t.id;
                const tieneUsername = username && String(username).trim() !== '';
                if (!tieneUsername) {
                    console.warn('[RENDER] ‚ö†Ô∏è T√©cnico sin username v√°lido, omitiendo', {
                        tecnico: { id: t.id, nombre: t.nombre, username: t.username }
                    });
                }
                return tieneUsername;
            });
            
            console.log('[RENDER] üìã T√©cnicos filtrados', {
                totalAntes: tecnicos.length,
                totalDespues: tecnicosFiltrados.length,
                filtrados: tecnicosFiltrados.map(t => ({
                    username: t.username || t.id,
                    nombre: t.nombre
                }))
            });
            
            tecnicosContainer.innerHTML = tecnicosFiltrados.length > 0
                ? tecnicos.filter(t => {
                    // Asegurar que tenemos un username v√°lido
                    const username = t.username || t.id;
                    if (!username || String(username).trim() === '') {
                        return false;
                    }
                    return true;
                }).map(t => {
                    // IMPORTANTE: Usar username como identificador principal, id como fallback
                    // NO usar t.nombre para el username
                    const username = t.username || t.id || '';
                    const nombre = t.nombre || username;
                    
                    // Escapar comillas y caracteres especiales para HTML
                    const usernameEscapado = String(username).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const nombreEscapado = String(nombre).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    // Validar que username no est√© vac√≠o (solo log si es cr√≠tico)
                    if (!usernameEscapado || usernameEscapado.trim() === '') {
                        console.error('[RENDER] ‚ùå T√©cnico sin username al renderizar recurso', {
                            empleado: { id: t.id, nombre: nombre },
                            problema: 'No se puede crear badge sin username v√°lido'
                        });
                    }
                    
                    // Determinar si es fumigaci√≥n para aplicar color
                    const departamento = (t.departamento || '').trim().toLowerCase();
                    const esFumigacion = departamento === 'fumigaci√≥n' || departamento === 'fumigacion';
                    
                    // Si es fumigaci√≥n, usar clase naranja (recurso-tecnico), si no, usar estilo gris
                    const estiloColor = esFumigacion 
                        ? '' 
                        : 'background: #9E9E9E !important; color: white !important;';
                    
                    const htmlGenerado = `
                    <div class="recurso-item recurso-tecnico" 
                         draggable="true" 
                         data-tipo="tecnico" 
                         data-username="${usernameEscapado}"
                         data-nombre="${nombreEscapado}"
                         ${estiloColor ? `style="${estiloColor}"` : ''}>
                        ${nombre}
                    </div>
                `;
                    
                    console.log('[RENDER] ‚úÖ HTML generado para t√©cnico', {
                        username: usernameEscapado,
                        nombre: nombreEscapado,
                        html: htmlGenerado.substring(0, 200) + '...'
                    });
                    
                    return htmlGenerado;
                }).join('')
                : '<div class="text-muted" style="font-size: 0.8rem; padding: 10px;">Todos los t√©cnicos est√°n asignados</div>';
            
            console.log('[RENDER] üìù HTML final de t√©cnicos', {
                longitud: tecnicosContainer.innerHTML.length,
                preview: tecnicosContainer.innerHTML.substring(0, 500) + '...'
            });
            
            // Renderizar veh√≠culos (normalizar antes de renderizar)
            console.log('[RENDER] üöó Renderizando veh√≠culos sin asignar', {
                totalVehiculos: vehiculos.length,
                vehiculos: vehiculos.map(v => ({
                    original: v,
                    tipo: typeof v,
                    normalizado: v ? String(v).trim() : '',
                    longitud: v ? String(v).trim().length : 0
                }))
            });
            
            vehiculosContainer.innerHTML = vehiculos.length > 0
                ? vehiculos.map(v => {
                    // Normalizar el veh√≠culo (trim y asegurar que sea string)
                    const vNormalizado = v ? String(v).trim() : '';
                    if (!vNormalizado) {
                        console.warn('[RENDER] ‚ö†Ô∏è Veh√≠culo vac√≠o o inv√°lido, omitiendo', { vehiculo: v });
                        return null;
                    }
                    
                    // Escapar comillas y caracteres especiales para HTML
                    const vEscapado = vNormalizado.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    console.log('[RENDER] ‚úÖ HTML generado para veh√≠culo', {
                        original: v,
                        normalizado: vNormalizado,
                        escapado: vEscapado,
                        dataVehiculo: vEscapado
                    });
                    
                    return `
                    <div class="recurso-item recurso-vehiculo" 
                         draggable="true" 
                         data-tipo="vehiculo" 
                         data-vehiculo="${vEscapado}">
                        ${vEscapado}
                    </div>
                `;
                }).filter(html => html !== null).join('')
                : '<div class="text-muted" style="font-size: 0.8rem; padding: 10px;">Todos los veh√≠culos est√°n asignados</div>';
            
            // Verificar que los elementos se crearon correctamente en el DOM
            setTimeout(() => {
                const elementosCreados = document.querySelectorAll('.recurso-item[draggable="true"]');
                console.log('[RENDER] ‚úÖ Verificaci√≥n post-renderizado', {
                    totalElementosEnDOM: elementosCreados.length,
                    elementosDetalle: Array.from(elementosCreados).map(el => ({
                        className: el.className,
                        draggable: el.getAttribute('draggable'),
                        dataTipo: el.getAttribute('data-tipo'),
                        dataUsername: el.getAttribute('data-username'),
                        dataNombre: el.getAttribute('data-nombre'),
                        dataVehiculo: el.getAttribute('data-vehiculo'),
                        textContent: el.textContent?.trim(),
                        tieneListener: el.onclick !== null || el.getAttribute('onclick') !== null
                    }))
                });
            }, 50);
        }
        
        // Variable global para almacenar el tipo de recurso que se est√° arrastrando
        let tipoRecursoArrastrando = null;
        
        // Variables globales para almacenar los datos del recurso que se est√° arrastrando
        let datosRecursoArrastrando = {
            tipo: null,
            username: null,
            nombre: null,
            vehiculo: null,
            rutaOrigen: null
        };
        
        // Variable para rastrear si ya se configuraron los listeners de citas
        let dragAndDropCitasConfigurado = false;
        
        // Funci√≥n para inicializar drag and drop de recursos
        function inicializarDragAndDropRecursos(fecha) {
            console.log('[DRAG&DROP] üîß Inicializando drag and drop de recursos...', { fecha });
            
            // Obtener todos los recursos actuales
            const recursos = document.querySelectorAll('.recurso-item[draggable="true"], .ruta-badge-item[draggable="true"]');
            const rutasInfoRows = document.querySelectorAll('.ruta-info-row');
            
            console.log('[DRAG&DROP] üìä Elementos encontrados', {
                totalRecursos: recursos.length,
                totalRutasInfoRows: rutasInfoRows.length,
                recursosDetalle: Array.from(recursos).map(r => ({
                    className: r.className,
                    tipo: r.dataset.tipo || r.getAttribute('data-tipo') || 'NO DEFINIDO',
                    username: r.dataset.username || r.getAttribute('data-username') || 'NO DEFINIDO',
                    textContent: r.textContent?.trim()
                }))
            });
            
            // Agregar listeners a todos los recursos (sin asignar y ya asignados)
            let listenersAgregados = 0;
            let listenersOmitidos = 0;
            
            document.querySelectorAll('.recurso-item[draggable="true"], .ruta-badge-item[draggable="true"]').forEach(recurso => {
                // Verificar que el elemento tiene data-tipo antes de agregar listener
                const tipoInicial = recurso.dataset.tipo || recurso.getAttribute('data-tipo');
                if (!tipoInicial) {
                    console.error('[DRAG&DROP] ‚ùå No se puede agregar listener - elemento sin data-tipo', {
                        elemento: {
                            className: recurso.className,
                            textContent: recurso.textContent?.trim(),
                            attributes: Array.from(recurso.attributes).map(a => `${a.name}="${a.value}"`),
                            draggable: recurso.getAttribute('draggable'),
                            dataset: recurso.dataset
                        }
                    });
                    listenersOmitidos++;
                    return; // Saltar este elemento
                }
                
                listenersAgregados++;
                
                // Guardar referencia al elemento para logging
                const elementoRef = recurso;
                const tipoRef = tipoInicial;
                
                recurso.addEventListener('dragstart', function dragstartHandler(e) {
                    console.log('[DRAG&DROP] üöÄ ========== DRAGSTART INICIADO ==========');
                    console.log('[DRAG&DROP] üìç Paso 1: Evento capturado', {
                        timestamp: new Date().toISOString(),
                        eventType: e.type,
                        target: {
                            tagName: e.target.tagName,
                            className: e.target.className,
                            id: e.target.id,
                            textContent: e.target.textContent?.trim()
                        },
                        currentTarget: {
                            tagName: e.currentTarget.tagName,
                            className: e.currentTarget.className,
                            textContent: e.currentTarget.textContent?.trim()
                        },
                        elementoOriginal: {
                            tipo: tipoRef,
                            textContent: elementoRef.textContent?.trim(),
                            className: elementoRef.className,
                            id: elementoRef.id,
                            dataset: {
                                tipo: elementoRef.dataset.tipo,
                                username: elementoRef.dataset.username,
                                nombre: elementoRef.dataset.nombre,
                                vehiculo: elementoRef.dataset.vehiculo,
                                ruta: elementoRef.dataset.ruta
                            },
                            attributes: Array.from(elementoRef.attributes).map(a => ({
                                name: a.name,
                                value: a.value
                            })),
                            draggable: elementoRef.getAttribute('draggable'),
                            tieneListener: elementoRef.onclick !== null
                        }
                    });
                    
                    console.log('[DRAG&DROP] üìç Paso 2: Configurando dataTransfer', {
                        effectAllowedAntes: e.dataTransfer.effectAllowed,
                        typesAntes: Array.from(e.dataTransfer.types || []),
                        dropEffectAntes: e.dataTransfer.dropEffect
                    });
                    
                    e.dataTransfer.effectAllowed = 'move';
                    
                    console.log('[DRAG&DROP] üìç Paso 3: effectAllowed configurado', {
                        effectAllowedDespues: e.dataTransfer.effectAllowed
                    });
                    
                    // Obtener tipo de m√∫ltiples formas para asegurar que se capture
                    const tipo = recurso.dataset.tipo || 
                                 recurso.getAttribute('data-tipo') || 
                                 (recurso.classList.contains('recurso-tecnico') || recurso.classList.contains('ruta-badge-tecnico') ? 'tecnico' : '') ||
                                 (recurso.classList.contains('recurso-vehiculo') || recurso.classList.contains('ruta-badge-vehiculo') ? 'vehiculo' : '') ||
                                 '';
                    
                    // Si el tipo sigue vac√≠o, es un error cr√≠tico
                    if (!tipo || tipo.trim() === '') {
                        console.error('[DRAG&DROP] ‚ùå Error cr√≠tico - no se puede determinar el tipo del elemento', {
                            elemento: {
                                className: recurso.className,
                                dataset: recurso.dataset,
                                attributes: Array.from(recurso.attributes).map(a => `${a.name}="${a.value}"`),
                                textContent: recurso.textContent?.trim()
                            },
                            sugerencia: 'El elemento no tiene data-tipo y no se puede inferir de las clases CSS'
                        });
                        e.preventDefault();
                        return;
                    }
                    
                    tipoRecursoArrastrando = tipo;
                    
                    // Guardar datos en variable global tambi√©n
                    datosRecursoArrastrando.tipo = tipo;
                    datosRecursoArrastrando.username = null;
                    datosRecursoArrastrando.nombre = null;
                    datosRecursoArrastrando.vehiculo = null;
                    datosRecursoArrastrando.rutaOrigen = null;
                    
                    console.log('[DRAG&DROP] üìç Paso 4: Guardando datos en dataTransfer', {
                        tipoAGuardar: tipo,
                        tiposDisponiblesAntes: Array.from(e.dataTransfer.types || [])
                    });
                    
                    // Guardar en m√∫ltiples formatos para compatibilidad con diferentes navegadores
                    try {
                    e.dataTransfer.setData('tipo', tipo);
                        console.log('[DRAG&DROP] ‚úÖ Tipo guardado en formato "tipo"');
                    } catch (err) {
                        console.error('[DRAG&DROP] ‚ùå Error al guardar tipo en formato "tipo"', { error: err.message });
                    }
                    
                    try {
                        e.dataTransfer.setData('text/plain', tipo);
                        console.log('[DRAG&DROP] ‚úÖ Tipo guardado en formato "text/plain"');
                    } catch (err) {
                        console.error('[DRAG&DROP] ‚ùå Error al guardar tipo en formato "text/plain"', { error: err.message });
                    }
                    
                    // Verificar que se guard√≥ correctamente
                    const tipoVerificado1 = e.dataTransfer.getData('tipo');
                    const tipoVerificado2 = e.dataTransfer.getData('text/plain');
                    const tiposDisponibles = Array.from(e.dataTransfer.types || []);
                    
                    console.log('[DRAG&DROP] üìç Paso 5: Verificaci√≥n de datos guardados', {
                        tipoOriginal: tipo,
                        tipoVerificadoFormato1: tipoVerificado1,
                        tipoVerificadoFormato2: tipoVerificado2,
                        tiposDisponibles: tiposDisponibles,
                        coincideFormato1: tipoVerificado1 === tipo,
                        coincideFormato2: tipoVerificado2 === tipo,
                        dataTransferCompleto: {
                            effectAllowed: e.dataTransfer.effectAllowed,
                            dropEffect: e.dataTransfer.dropEffect,
                            types: tiposDisponibles
                        }
                    });
                    
                    if (tipoVerificado1 !== tipo && tipoVerificado2 !== tipo) {
                        console.error('[DRAG&DROP] ‚ùå ERROR CR√çTICO - Tipo no se guard√≥ correctamente', {
                            tipoOriginal: tipo,
                            tipoVerificadoFormato1: tipoVerificado1,
                            tipoVerificadoFormato2: tipoVerificado2,
                            tiposDisponibles: tiposDisponibles,
                            dataTransfer: {
                                effectAllowed: e.dataTransfer.effectAllowed,
                                dropEffect: e.dataTransfer.dropEffect
                            }
                        });
                    }
                    
                    if (tipo === 'tecnico') {
                        console.log('[DRAG&DROP] üìç Paso 6: Procesando t√©cnico', {
                            elementoDataset: {
                                username: elementoRef.dataset.username,
                                nombre: elementoRef.dataset.nombre
                            },
                            elementoAttributes: {
                                dataUsername: elementoRef.getAttribute('data-username'),
                                dataNombre: elementoRef.getAttribute('data-nombre')
                            }
                        });
                        
                        // Intentar obtener username de m√∫ltiples formas
                        let username = elementoRef.dataset.username || 
                                      elementoRef.getAttribute('data-username') ||
                                      '';
                        
                        console.log('[DRAG&DROP] üìç Paso 6.1: Username obtenido (intento 1)', {
                            username: username,
                            fuente: elementoRef.dataset.username ? 'dataset' : elementoRef.getAttribute('data-username') ? 'attribute' : 'VAC√çO'
                        });
                        
                        // Si a√∫n est√° vac√≠o, intentar obtener del texto o del elemento
                        if (!username || username.trim() === '') {
                            const parent = elementoRef.closest('[data-username]');
                            if (parent) {
                                username = parent.dataset.username || parent.getAttribute('data-username') || '';
                                console.log('[DRAG&DROP] üìç Paso 6.2: Username obtenido del padre', { username });
                            }
                        }
                        
                        // Si a√∫n est√° vac√≠o, intentar obtener del innerHTML o textContent
                        if (!username || username.trim() === '') {
                            const nombreMostrado = (elementoRef.textContent?.trim() || elementoRef.innerHTML?.trim() || '').replace(/\s+/g, ' ').trim();
                            console.log('[DRAG&DROP] üìç Paso 6.3: Buscando por nombre mostrado', {
                                nombreMostrado: nombreMostrado,
                                totalEmpleados: window.empleados?.length || 0
                            });
                            
                            if (nombreMostrado && window.empleados) {
                                const empleadoEncontrado = window.empleados.find(emp => {
                                    const primerNombre = (emp.primerNombre || '').trim();
                                    const primerApellido = (emp.primerApellido || '').trim();
                                    const inicialApellido = primerApellido ? primerApellido.charAt(0).toUpperCase() + '.' : '';
                                    const nombreFormateado = `${primerNombre} ${inicialApellido}`.trim();
                                    const nombreCompleto = `${primerNombre} ${primerApellido}`.trim();
                                    return nombreFormateado === nombreMostrado || 
                                           nombreCompleto === nombreMostrado ||
                                           (emp.username && emp.username === nombreMostrado) ||
                                           (emp.id && emp.id === nombreMostrado);
                                });
                                
                                if (empleadoEncontrado) {
                                    username = empleadoEncontrado.username || empleadoEncontrado.id || '';
                                    console.log('[DRAG&DROP] üìç Paso 6.4: Empleado encontrado por nombre', {
                                        username: username,
                                        empleado: {
                                            id: empleadoEncontrado.id,
                                            username: empleadoEncontrado.username,
                                            nombre: `${empleadoEncontrado.primerNombre} ${empleadoEncontrado.primerApellido}`
                                        }
                                    });
                                } else {
                                    console.warn('[DRAG&DROP] ‚ö†Ô∏è No se encontr√≥ empleado por nombre', { nombreMostrado });
                                }
                            }
                        }
                        
                        const nombre = elementoRef.dataset.nombre || elementoRef.getAttribute('data-nombre') || '';
                        
                        console.log('[DRAG&DROP] üìç Paso 7: Validaci√≥n final de username', {
                            username: username,
                            nombre: nombre,
                            usernameValido: username && username.trim() !== '',
                            nombreValido: nombre && nombre.trim() !== ''
                        });
                        
                        if (!username || username.trim() === '') {
                            const nombreMostrado = elementoRef.textContent?.trim() || 'desconocido';
                            console.error('[DRAG&DROP] ‚ùå ERROR CR√çTICO - No se puede arrastrar t√©cnico - username vac√≠o', {
                                nombreMostrado: nombreMostrado,
                                elemento: {
                                tipo: tipo,
                                    dataUsername: elementoRef.dataset.username || 'no definido',
                                    dataNombre: elementoRef.dataset.nombre || 'no definido',
                                    textContent: elementoRef.textContent?.trim() || 'vac√≠o',
                                    attributes: Array.from(elementoRef.attributes).map(a => `${a.name}="${a.value}"`)
                                },
                                contexto: {
                                    totalEmpleados: window.empleados?.length || 0,
                                    sugerencia: 'Verifique que el badge tenga el atributo data-username correctamente configurado'
                                }
                            });
                            e.preventDefault();
                            return;
                        }
                        
                        // Asegurar que el username se guarde correctamente
                        const usernameFinal = String(username).trim();
                        const nombreFinal = (nombre || usernameFinal).trim();
                        
                        // Guardar en variable global tambi√©n
                        datosRecursoArrastrando.username = usernameFinal;
                        datosRecursoArrastrando.nombre = nombreFinal;
                        
                        console.log('[DRAG&DROP] üìç Paso 8: Guardando username y nombre', {
                            usernameFinal: usernameFinal,
                            nombreFinal: nombreFinal,
                            tiposAntes: Array.from(e.dataTransfer.types || [])
                        });
                        
                        // Guardar en m√∫ltiples formatos para compatibilidad
                        try {
                        e.dataTransfer.setData('username', usernameFinal);
                            console.log('[DRAG&DROP] ‚úÖ Username guardado en formato "username"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ‚ùå Error al guardar username', { error: err.message });
                        }
                        
                        try {
                        e.dataTransfer.setData('nombre', nombreFinal);
                            console.log('[DRAG&DROP] ‚úÖ Nombre guardado en formato "nombre"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ‚ùå Error al guardar nombre', { error: err.message });
                        }
                        
                        try {
                            e.dataTransfer.setData('text/username', usernameFinal);
                            console.log('[DRAG&DROP] ‚úÖ Username guardado en formato "text/username"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ‚ùå Error al guardar username (respaldo)', { error: err.message });
                        }
                        
                        try {
                            e.dataTransfer.setData('text/nombre', nombreFinal);
                            console.log('[DRAG&DROP] ‚úÖ Nombre guardado en formato "text/nombre"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ‚ùå Error al guardar nombre (respaldo)', { error: err.message });
                        }
                        
                        // Verificar que se guardaron correctamente
                        const usernameVerificado1 = e.dataTransfer.getData('username');
                        const usernameVerificado2 = e.dataTransfer.getData('text/username');
                        const nombreVerificado1 = e.dataTransfer.getData('nombre');
                        const nombreVerificado2 = e.dataTransfer.getData('text/nombre');
                        const tiposDisponibles = Array.from(e.dataTransfer.types || []);
                        
                        console.log('[DRAG&DROP] üìç Paso 9: Verificaci√≥n final de datos guardados', {
                                usernameOriginal: usernameFinal,
                            usernameVerificadoFormato1: usernameVerificado1,
                            usernameVerificadoFormato2: usernameVerificado2,
                            nombreOriginal: nombreFinal,
                            nombreVerificadoFormato1: nombreVerificado1,
                            nombreVerificadoFormato2: nombreVerificado2,
                            tiposDisponibles: tiposDisponibles,
                            usernameCoincide1: usernameVerificado1 === usernameFinal,
                            usernameCoincide2: usernameVerificado2 === usernameFinal,
                            nombreCoincide1: nombreVerificado1 === nombreFinal,
                            nombreCoincide2: nombreVerificado2 === nombreFinal
                        });
                        
                        if (usernameVerificado1 !== usernameFinal && usernameVerificado2 !== usernameFinal) {
                            console.error('[DRAG&DROP] ‚ùå ERROR CR√çTICO - Username no se guard√≥ correctamente', {
                                usernameOriginal: usernameFinal,
                                usernameVerificadoFormato1: usernameVerificado1,
                                usernameVerificadoFormato2: usernameVerificado2,
                                tiposDisponibles: tiposDisponibles
                            });
                        }
                        
                        if (nombreVerificado1 !== nombreFinal && nombreVerificado2 !== nombreFinal) {
                            console.error('[DRAG&DROP] ‚ùå ERROR CR√çTICO - Nombre no se guard√≥ correctamente', {
                                nombreOriginal: nombreFinal,
                                nombreVerificadoFormato1: nombreVerificado1,
                                nombreVerificadoFormato2: nombreVerificado2,
                                tiposDisponibles: tiposDisponibles
                            });
                        }
                    } else {
                        // Intentar obtener veh√≠culo de m√∫ltiples formas
                        let vehiculo = recurso.dataset.vehiculo || 
                                      recurso.getAttribute('data-vehiculo') ||
                                      '';
                        
                        // Si a√∫n est√° vac√≠o, intentar obtener del texto o del elemento
                        if (!vehiculo || vehiculo.trim() === '') {
                            // Buscar en el elemento padre o en los atributos
                            const parent = recurso.closest('[data-vehiculo]');
                            if (parent) {
                                vehiculo = parent.dataset.vehiculo || parent.getAttribute('data-vehiculo') || '';
                            }
                        }
                        
                        if (!vehiculo || vehiculo.trim() === '') {
                            const nombreMostrado = recurso.textContent?.trim() || 'desconocido';
                            console.error('[DRAG&DROP] ‚ùå No se puede arrastrar veh√≠culo - nombre vac√≠o', {
                                nombreMostrado: nombreMostrado,
                                elemento: {
                                    tipo: tipo,
                                    dataVehiculo: recurso.dataset.vehiculo || 'no definido',
                                    textContent: recurso.textContent?.trim() || 'vac√≠o'
                                },
                                sugerencia: 'Verifique que el badge tenga el atributo data-vehiculo correctamente configurado'
                            });
                            e.preventDefault();
                            return;
                        }
                        const vehiculoFinal = String(vehiculo).trim();
                        e.dataTransfer.setData('vehiculo', vehiculoFinal);
                        e.dataTransfer.setData('text/vehiculo', vehiculoFinal); // Respaldo
                        
                        // Guardar en variable global tambi√©n
                        datosRecursoArrastrando.vehiculo = vehiculoFinal;
                        
                        console.log('[DRAG&DROP] üìç Paso 6.5: Veh√≠culo guardado en variable global', {
                            vehiculoFinal: vehiculoFinal,
                            datosRecursoArrastrando: {
                                tipo: datosRecursoArrastrando.tipo,
                                vehiculo: datosRecursoArrastrando.vehiculo,
                                rutaOrigen: datosRecursoArrastrando.rutaOrigen
                            }
                        });
                        
                        // Verificar que se guard√≥ correctamente
                        const vehiculoVerificado = e.dataTransfer.getData('vehiculo');
                        if (vehiculoVerificado !== vehiculoFinal) {
                            console.error('[DRAG&DROP] ‚ùå Error al guardar veh√≠culo en dataTransfer', {
                                vehiculoOriginal: vehiculoFinal,
                                vehiculoVerificado: vehiculoVerificado
                            });
                        } else {
                            console.log('[DRAG&DROP] ‚úÖ Veh√≠culo guardado correctamente en dataTransfer', {
                                vehiculo: vehiculoFinal
                            });
                        }
                    }
                    // Guardar la ruta de origen si existe (puede ser null si viene de "Sin asignar")
                    const rutaOrigen = elementoRef.dataset.ruta || elementoRef.getAttribute('data-ruta') || '';
                    const rutaOrigenFinal = rutaOrigen || ''; // Siempre guardar, incluso si est√° vac√≠o
                    
                    // Guardar en variable global tambi√©n
                    datosRecursoArrastrando.rutaOrigen = rutaOrigenFinal;
                    
                    console.log('[DRAG&DROP] üìç Paso 10: Guardando ruta de origen', {
                        rutaOrigen: rutaOrigenFinal,
                        tiposAntes: Array.from(e.dataTransfer.types || [])
                    });
                    
                    try {
                        e.dataTransfer.setData('rutaOrigen', rutaOrigenFinal);
                        e.dataTransfer.setData('text/rutaOrigen', rutaOrigenFinal);
                        console.log('[DRAG&DROP] ‚úÖ Ruta de origen guardada');
                    } catch (err) {
                        console.error('[DRAG&DROP] ‚ùå Error al guardar ruta de origen', { error: err.message });
                    }
                    
                    // Verificar que todos los datos se guardaron correctamente
                    console.log('[DRAG&DROP] üìç Paso 11: Verificaci√≥n final completa', {
                        tiposDisponibles: Array.from(e.dataTransfer.types || []),
                        dataTransferCompleto: {
                            effectAllowed: e.dataTransfer.effectAllowed,
                            dropEffect: e.dataTransfer.dropEffect,
                            types: Array.from(e.dataTransfer.types || [])
                        }
                    });
                    
                    const tipoVerificadoFinal = e.dataTransfer.getData('tipo');
                    const tipoVerificadoFinal2 = e.dataTransfer.getData('text/plain');
                    const datosVerificados = {
                        tipo: tipoVerificadoFinal || tipoVerificadoFinal2 || 'VAC√çO',
                        rutaOrigen: e.dataTransfer.getData('rutaOrigen') || e.dataTransfer.getData('text/rutaOrigen') || 'VAC√çO'
                    };
                    
                    if (tipo === 'tecnico') {
                        datosVerificados.username = e.dataTransfer.getData('username') || e.dataTransfer.getData('text/username') || 'VAC√çO';
                        datosVerificados.nombre = e.dataTransfer.getData('nombre') || e.dataTransfer.getData('text/nombre') || 'VAC√çO';
                    } else if (tipo === 'vehiculo') {
                        datosVerificados.vehiculo = e.dataTransfer.getData('vehiculo') || e.dataTransfer.getData('text/vehiculo') || datosRecursoArrastrando.vehiculo || 'VAC√çO';
                    }
                    
                    console.log('[DRAG&DROP] üìç Paso 12: Resumen final de datos guardados', {
                        tipoEsperado: tipo,
                        datosVerificados: datosVerificados,
                        todosLosTipos: Array.from(e.dataTransfer.types || []),
                        todosLosDatos: {
                            tipo: e.dataTransfer.getData('tipo'),
                            tipoTextPlain: e.dataTransfer.getData('text/plain'),
                            username: e.dataTransfer.getData('username'),
                            usernameText: e.dataTransfer.getData('text/username'),
                            nombre: e.dataTransfer.getData('nombre'),
                            nombreText: e.dataTransfer.getData('text/nombre'),
                            vehiculo: e.dataTransfer.getData('vehiculo'),
                            vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                            rutaOrigen: e.dataTransfer.getData('rutaOrigen'),
                            rutaOrigenText: e.dataTransfer.getData('text/rutaOrigen')
                        }
                    });
                    
                    // Log de √©xito solo si todo est√° correcto
                    if (tipoVerificadoFinal === tipo || tipoVerificadoFinal2 === tipo) {
                        console.log('[DRAG&DROP] ‚úÖ ========== DRAGSTART EXITOSO ==========', {
                            tipo: tipo,
                            datos: datosVerificados,
                            elemento: {
                                textContent: elementoRef.textContent?.trim(),
                                className: elementoRef.className
                            },
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        console.error('[DRAG&DROP] ‚ùå ========== ERROR DE VERIFICACI√ìN EN DRAGSTART ==========', {
                            tipoEsperado: tipo,
                            tipoVerificadoFormato1: tipoVerificadoFinal,
                            tipoVerificadoFormato2: tipoVerificadoFinal2,
                            datos: datosVerificados,
                            tiposDisponibles: Array.from(e.dataTransfer.types || []),
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    elementoRef.classList.add('dragging');
                    console.log('[DRAG&DROP] üìç Paso 13: Clase "dragging" agregada al elemento');
                });
                
                recurso.addEventListener('dragend', (e) => {
                    recurso.classList.remove('dragging');
                    rutasInfoRows.forEach(row => {
                        row.classList.remove('drop-zone', 'drop-zone-active');
                    });
                    
                    // NO limpiar las variables globales inmediatamente
                    // Esperar un poco para que el drop pueda leerlas si es necesario
                    // El drop deber√≠a leer primero del dataTransfer, pero las variables globales
                    // son un respaldo importante
                    setTimeout(() => {
                        tipoRecursoArrastrando = null;
                        datosRecursoArrastrando = {
                            tipo: null,
                            username: null,
                            nombre: null,
                            vehiculo: null,
                            rutaOrigen: null
                        };
                        console.log('[DRAG&DROP] üßπ Variables globales limpiadas despu√©s del drop');
                    }, 500); // Esperar 500ms para que el drop termine
                });
            });
            
            console.log('[DRAG&DROP] ‚úÖ Listeners agregados', {
                totalAgregados: listenersAgregados,
                totalOmitidos: listenersOmitidos,
                totalEncontrados: recursos.length
            });
            
            rutasInfoRows.forEach((row) => {
                // Usar data-tipo-fila para determinar el tipo de fila
                const tipoFila = row.dataset.tipoFila;
                
                if (!tipoFila) {
                    console.warn('Fila sin data-tipo-fila:', row);
                    return;
                }
                
                row.addEventListener('dragover', (e) => {
                    // Usar la variable global en lugar de getData (que no funciona en dragover)
                    if (!tipoRecursoArrastrando) {
                        e.dataTransfer.dropEffect = 'none';
                        return;
                    }
                    
                    // Validar que el tipo de recurso coincida con el tipo de fila
                    const esVehiculo = tipoFila === 'vehiculo' && tipoRecursoArrastrando === 'vehiculo';
                    const esTecnico = tipoFila === 'tecnico' && tipoRecursoArrastrando === 'tecnico';
                    
                    if (esVehiculo || esTecnico) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.dataTransfer.dropEffect = 'move';
                        row.classList.add('drop-zone-active');
                    } else {
                        // No permitir drop si no coincide el tipo
                        e.dataTransfer.dropEffect = 'none';
                    }
                });
                
                row.addEventListener('dragleave', (e) => {
                    // Solo remover si realmente salimos de la fila
                    if (!row.contains(e.relatedTarget)) {
                        row.classList.remove('drop-zone-active');
                    }
                });
                
                // Variable para prevenir ejecuci√≥n m√∫ltiple
                let dropProcesando = false;
                
                row.addEventListener('drop', async (e) => {
                    // Prevenir ejecuci√≥n m√∫ltiple
                    if (dropProcesando) {
                        console.log('[DRAG&DROP] ‚ö†Ô∏è Drop ya en proceso, ignorando ejecuci√≥n duplicada');
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    
                    // Marcar como procesando inmediatamente
                    dropProcesando = true;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('[DRAG&DROP] üì• ========== DROP INICIADO ==========');
                    console.log('[DRAG&DROP] üìç Drop Paso 1: Evento capturado', {
                        timestamp: new Date().toISOString(),
                        eventType: e.type,
                        target: {
                            tagName: e.target.tagName,
                            className: e.target.className
                        },
                        currentTarget: {
                            tagName: e.currentTarget.tagName,
                            className: e.currentTarget.className,
                            dataset: e.currentTarget.dataset
                        },
                        row: {
                            dataset: row.dataset,
                            tipoFila: row.dataset.tipoFila,
                            ruta: row.dataset.ruta,
                            attributes: Array.from(row.attributes).map(a => `${a.name}="${a.value}"`)
                        }
                    });
                    row.classList.remove('drop-zone', 'drop-zone-active');
                    
                    console.log('[DRAG&DROP] üìç Drop Paso 2: Estado del dataTransfer', {
                        effectAllowed: e.dataTransfer.effectAllowed,
                        dropEffect: e.dataTransfer.dropEffect,
                        types: Array.from(e.dataTransfer.types || []),
                        files: e.dataTransfer.files?.length || 0,
                        items: e.dataTransfer.items?.length || 0
                    });
                    
                    // Obtener todos los datos del dataTransfer para debugging
                    // Intentar leer de m√∫ltiples formatos para compatibilidad
                    console.log('[DRAG&DROP] üìç Drop Paso 3: Leyendo datos del dataTransfer', {
                        intentandoLeer: ['tipo', 'text/plain', 'username', 'text/username', 'nombre', 'text/nombre', 'vehiculo', 'text/vehiculo', 'rutaOrigen', 'text/rutaOrigen']
                    });
                    
                    let tipo = e.dataTransfer.getData('tipo');
                    const tipoTextPlain = e.dataTransfer.getData('text/plain');
                    if (!tipo) tipo = tipoTextPlain;
                    
                    const tipoFila = row.dataset.tipoFila;
                    
                    let rutaOrigen = e.dataTransfer.getData('rutaOrigen');
                    const rutaOrigenText = e.dataTransfer.getData('text/rutaOrigen');
                    if (!rutaOrigen) rutaOrigen = rutaOrigenText;
                    
                    const rutaDestino = row.dataset.ruta;
                    
                    // Obtener fecha de la fila (vista compacta) o del d√≠a seleccionado (vista total)
                    let fecha;
                    if (row.dataset.fechaRuta) {
                        fecha = row.dataset.fechaRuta;
                    } else {
                        // Vista total: usar el d√≠a seleccionado
                        fecha = formatearFechaParaInput(diaSeleccionado);
                    }
                    
                    // Obtener datos espec√≠ficos seg√∫n el tipo (guardar valores reales, no 'VAC√çO')
                    let username = e.dataTransfer.getData('username');
                    const usernameText = e.dataTransfer.getData('text/username');
                    if (!username) username = usernameText;
                    
                    let nombre = e.dataTransfer.getData('nombre');
                    const nombreText = e.dataTransfer.getData('text/nombre');
                    if (!nombre) nombre = nombreText;
                    
                    let vehiculo = e.dataTransfer.getData('vehiculo');
                    const vehiculoText = e.dataTransfer.getData('text/vehiculo');
                    if (!vehiculo) vehiculo = vehiculoText;
                    
                    // Log completo de lo recibido en el drop (solo para logging)
                    const datosRecibidos = {
                        tipo: tipo || 'VAC√çO',
                        tipoTextPlain: tipoTextPlain || 'VAC√çO',
                        rutaOrigen: rutaOrigen || 'VAC√çO',
                        rutaOrigenText: rutaOrigenText || 'VAC√çO',
                        username: username || 'VAC√çO',
                        usernameText: usernameText || 'VAC√çO',
                        nombre: nombre || 'VAC√çO',
                        nombreText: nombreText || 'VAC√çO',
                        vehiculo: vehiculo || 'VAC√çO',
                        vehiculoText: vehiculoText || 'VAC√çO',
                        tiposDisponibles: Array.from(e.dataTransfer.types || [])
                    };
                    
                    console.log('[DRAG&DROP] üìç Drop Paso 4: Datos le√≠dos del dataTransfer', {
                        datosRecibidos: datosRecibidos,
                        destino: {
                            ruta: rutaDestino,
                            tipoFila: tipoFila
                        },
                        todosLosDatosRaw: {
                            tipo: e.dataTransfer.getData('tipo'),
                            tipoTextPlain: e.dataTransfer.getData('text/plain'),
                            username: e.dataTransfer.getData('username'),
                            usernameText: e.dataTransfer.getData('text/username'),
                            nombre: e.dataTransfer.getData('nombre'),
                            nombreText: e.dataTransfer.getData('text/nombre'),
                            vehiculo: e.dataTransfer.getData('vehiculo'),
                            vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                            rutaOrigen: e.dataTransfer.getData('rutaOrigen'),
                            rutaOrigenText: e.dataTransfer.getData('text/rutaOrigen')
                        }
                    });
                    
                    // Si rutaOrigen est√° vac√≠o, significa que viene de "Sin asignar"
                    if (!rutaOrigen || rutaOrigen.trim() === '') {
                        rutaOrigen = null;
                    }
                    
                    // Validar que el tipo de recurso coincida con el tipo de fila
                    if ((tipoFila === 'vehiculo' && tipo !== 'vehiculo') || 
                        (tipoFila === 'tecnico' && tipo !== 'tecnico')) {
                        console.warn('[DRAG&DROP] ‚ö†Ô∏è Tipo de recurso no coincide con el tipo de fila', {
                            tipoRecurso: tipo,
                            tipoFila: tipoFila,
                            datosRecibidos: datosRecibidos
                        });
                        return;
                    }
                    
                    // Validar que el tipo no est√© vac√≠o
                    if (!tipo || tipo.trim() === '') {
                        console.error('[DRAG&DROP] ‚ùå Error cr√≠tico - tipo vac√≠o en drop', {
                            datosRecibidos: datosRecibidos,
                            destino: {
                                ruta: rutaDestino,
                            tipoFila: tipoFila
                            },
                            problema: 'El dataTransfer no contiene el tipo del recurso. El dragstart puede no haberse ejecutado correctamente.',
                            sugerencia: 'Verifique que el elemento tenga el atributo data-tipo y que el dragstart se ejecute correctamente'
                        });
                        alert('Error: No se pudo determinar el tipo de recurso. Por favor, intente nuevamente.');
                        return;
                    }
                    
                    if (!rutaDestino) {
                        console.error('[DRAG&DROP] ‚ùå No se pudo determinar la ruta destino', {
                            datosRecibidos: datosRecibidos,
                            row: {
                                dataset: row.dataset,
                                attributes: Array.from(row.attributes).map(a => `${a.name}="${a.value}"`)
                            }
                        });
                        return;
                    }
                    
                    // Si es "Sin asignar", no permitir asignar recursos
                    if (rutaDestino === 'Sin asignar') {
                        return;
                    }
                    
                    try {
                        // Cargar datos actuales del ruteador destino
                        const datosActuales = await cargarRuteador(fecha, rutaDestino);
                        const tecnicosActuales = datosActuales.tecnicos || [];
                        const vehiculosActuales = datosActuales.vehiculos || [];
                        
                        let nuevosTecnicos = [...tecnicosActuales];
                        let nuevosVehiculos = [...vehiculosActuales];
                        
                        if (tipo === 'tecnico') {
                            // Usar las variables ya le√≠das en el Paso 4 (username y usernameText est√°n disponibles en este scope)
                            // username ya tiene el valor de usernameText si estaba vac√≠o (l√≠nea 8173)
                            
                            // Fallback a variable global si dataTransfer est√° vac√≠o (como en el formulario)
                            if (!username || username.trim() === '') {
                                if (datosRecursoArrastrando.username) {
                                    username = datosRecursoArrastrando.username;
                                    console.log('[DRAG&DROP] üìç Username obtenido de variable global (fallback)');
                                }
                            }
                            
                            if (!username || username.trim() === '') {
                                console.error('[DRAG&DROP] ‚ùå Username vac√≠o en drop de ruta', {
                                    dataTransfer: {
                                        username: username,
                                        usernameText: usernameText
                                    },
                                    variableGlobal: datosRecursoArrastrando.username
                                });
                                alert('No se puede asignar el t√©cnico porque no tiene un username v√°lido.');
                                return;
                            }
                            
                            // Normalizar username
                            const empleado = window.empleados?.find(e => e.id === username || e.username === username);
                            if (empleado) {
                                username = empleado.username || empleado.id;
                            }
                            username = String(username).trim();
                            
                            console.log('[DRAG&DROP] ‚úÖ Asignando t√©cnico', {
                                username: username,
                                origen: rutaOrigen || 'sin asignar',
                                destino: rutaDestino
                            });
                            // Si viene de otra ruta, removerlo de ah√≠ primero
                            if (rutaOrigen && rutaOrigen !== rutaDestino) {
                                const datosOrigen = await cargarRuteador(fecha, rutaOrigen);
                                // Filtrar el t√©cnico removido (igual que en guardarRuteador)
                                const tecnicosOrigen = (datosOrigen.tecnicos || []).filter(t => {
                                    const tNormalizado = String(t).trim();
                                    const usernameNormalizado = String(username).trim();
                                    return tNormalizado !== '' && tNormalizado !== usernameNormalizado;
                                });
                                const vehiculosOrigen = (datosOrigen.vehiculos || []).filter(v => v && String(v).trim() !== '');
                                const idRuteadorOrigen = generarIdRuteador(fecha, rutaOrigen);
                                const ruteadorRefOrigen = doc(window.db, 'ruteador', idRuteadorOrigen);
                                await setDoc(ruteadorRefOrigen, {
                                    fecha: fecha,
                                    ruta: rutaOrigen,
                                    tecnicos: tecnicosOrigen,
                                    vehiculos: vehiculosOrigen,
                                    fecha_actualizacion: serverTimestamp()
                                }, { merge: true });
                            }
                            // Agregar a la nueva ruta si no est√° ya
                            if (!nuevosTecnicos.includes(username)) {
                                nuevosTecnicos.push(username);
                            }
                        } else if (tipo === 'vehiculo') {
                            // Intentar leer el veh√≠culo de m√∫ltiples fuentes (como en drop de cita)
                            let vehiculo = null;
                            
                            // Primero intentar desde la variable global (m√°s confiable, evita problemas de Tracking Prevention)
                            if (datosRecursoArrastrando.vehiculo) {
                                vehiculo = datosRecursoArrastrando.vehiculo;
                                console.log('[DRAG&DROP] üìç Veh√≠culo obtenido de variable global (drop ruta)', { vehiculo });
                            }
                            
                            // Si no est√° en la variable global, intentar desde dataTransfer
                            if (!vehiculo || vehiculo.trim() === '') {
                                vehiculo = e.dataTransfer.getData('vehiculo');
                                if (!vehiculo) vehiculo = e.dataTransfer.getData('text/vehiculo');
                                if (!vehiculo) vehiculo = e.dataTransfer.getData('text/plain');
                                if (vehiculo) {
                                    console.log('[DRAG&DROP] üìç Veh√≠culo obtenido de dataTransfer (drop ruta)', { vehiculo });
                                }
                            }
                            
                            // Si a√∫n no se encuentra, intentar obtener del elemento que se arrastr√≥
                            if (!vehiculo || vehiculo.trim() === '') {
                                const elementoArrastrado = document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging');
                                if (elementoArrastrado) {
                                    vehiculo = elementoArrastrado.dataset.vehiculo || 
                                              elementoArrastrado.getAttribute('data-vehiculo') ||
                                              elementoArrastrado.textContent?.trim() || '';
                                    console.log('[DRAG&DROP] üìç Veh√≠culo obtenido del elemento (drop ruta)', { vehiculo });
                                }
                            }
                            
                            if (!vehiculo || vehiculo.trim() === '') {
                                console.error('[DRAG&DROP] ‚ùå Veh√≠culo vac√≠o en drop de ruta', {
                                    datosGlobales: datosRecursoArrastrando,
                                    dataTransfer: {
                                        types: Array.from(e.dataTransfer.types || []),
                                        vehiculo: e.dataTransfer.getData('vehiculo'),
                                        vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                                        textPlain: e.dataTransfer.getData('text/plain')
                                    },
                                    elementoArrastrado: document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging')?.textContent
                                });
                                alert('No se puede asignar el veh√≠culo porque no tiene un nombre v√°lido.');
                                return;
                            }
                            
                            vehiculo = String(vehiculo).trim();
                            
                            console.log('[DRAG&DROP] ‚úÖ Asignando veh√≠culo', {
                                vehiculo: vehiculo,
                                origen: rutaOrigen || 'sin asignar',
                                destino: rutaDestino
                            });
                            // Si viene de otra ruta, removerlo de ah√≠ primero
                            if (rutaOrigen && rutaOrigen !== rutaDestino) {
                                const datosOrigen = await cargarRuteador(fecha, rutaOrigen);
                                // Filtrar el veh√≠culo removido (igual que en guardarRuteador)
                                const vehiculosOrigen = (datosOrigen.vehiculos || []).filter(v => {
                                    const vNormalizado = String(v).trim();
                                    const vehiculoNormalizado = String(vehiculo).trim();
                                    return vNormalizado !== '' && vNormalizado !== vehiculoNormalizado;
                                });
                                const tecnicosOrigen = (datosOrigen.tecnicos || []).filter(t => t && String(t).trim() !== '');
                                const idRuteadorOrigen = generarIdRuteador(fecha, rutaOrigen);
                                const ruteadorRefOrigen = doc(window.db, 'ruteador', idRuteadorOrigen);
                                await setDoc(ruteadorRefOrigen, {
                                    fecha: fecha,
                                    ruta: rutaOrigen,
                                    tecnicos: tecnicosOrigen,
                                    vehiculos: vehiculosOrigen,
                                    fecha_actualizacion: serverTimestamp()
                                }, { merge: true });
                            }
                            // Agregar a la nueva ruta si no est√° ya
                            if (!nuevosVehiculos.includes(vehiculo)) {
                                nuevosVehiculos.push(vehiculo);
                            }
                        }
                        
                        // Filtrar valores vac√≠os antes de guardar
                        nuevosTecnicos = nuevosTecnicos.filter(t => t && t.trim() !== '');
                        nuevosVehiculos = nuevosVehiculos.filter(v => v && v.trim() !== '');
                        
                        // Validar duplicados (solo si viene de sin asignar)
                        if (!rutaOrigen || rutaOrigen === rutaDestino) {
                            const duplicados = await validarDuplicadosRuteador(fecha, rutaDestino, nuevosTecnicos, nuevosVehiculos);
                            if (duplicados.length > 0) {
                                alert('No se puede asignar: ' + duplicados.join(', ') + ' ya est√° asignado a otra ruta en este d√≠a.');
                                return;
                            }
                        }
                        
                        // Filtrar valores vac√≠os antes de guardar (igual que en guardarRuteador)
                        const tecnicosFiltrados = nuevosTecnicos.filter(t => t && String(t).trim() !== '');
                        const vehiculosFiltrados = nuevosVehiculos.filter(v => v && String(v).trim() !== '');
                        
                        // Guardar en Firestore (usando la misma l√≥gica que guardarRuteador)
                        const idRuteador = generarIdRuteador(fecha, rutaDestino);
                        const ruteadorRef = doc(window.db, 'ruteador', idRuteador);
                        
                        try {
                        await setDoc(ruteadorRef, {
                            fecha: fecha,
                            ruta: rutaDestino,
                            tecnicos: tecnicosFiltrados,
                            vehiculos: vehiculosFiltrados,
                            fecha_actualizacion: serverTimestamp()
                        }, { merge: true });
                            
                            console.log('[DRAG&DROP] ‚úÖ Asignaci√≥n completada exitosamente', {
                                ruta: rutaDestino,
                                fecha: fecha,
                                tecnicos: tecnicosFiltrados.length,
                                vehiculos: vehiculosFiltrados.length
                            });
                        
                        // Recargar cronograma (esto tambi√©n actualizar√° las cajas de recursos sin asignar)
                        await generarCronograma();
                        } catch (error) {
                            console.error('[DRAG&DROP] ‚ùå Error al guardar asignaci√≥n', {
                                ruta: rutaDestino,
                                fecha: fecha,
                                error: error.message,
                                stack: error.stack
                            });
                            alert('Error al guardar la asignaci√≥n. Por favor, intente nuevamente.');
                            return;
                        }
                        
                        // Mostrar notificaci√≥n
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Recurso asignado exitosamente';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 2000);
                    } catch (error) {
                        console.error('Error asignando recurso:', error);
                        const errorMessage = error.message || error.toString() || 'Error desconocido';
                        alert('Error al asignar recurso: ' + errorMessage);
                    } finally {
                        // Liberar el flag despu√©s de un breve delay para permitir que termine completamente
                        setTimeout(() => {
                            dropProcesando = false;
                        }, 100);
                    }
                });
            });
            
            // Agregar soporte para arrastrar a las citas individuales
            // Buscar citas en todas las vistas (calendario mensual, vista diaria, cronograma)
            const citas = document.querySelectorAll('.cita-item[data-cita-id], .cita-bloque[data-cita-id]');
            console.log('[DRAG&DROP] üìä Citas encontradas para configurar drop', {
                totalCitas: citas.length,
                citasItem: document.querySelectorAll('.cita-item[data-cita-id]').length,
                citasBloque: document.querySelectorAll('.cita-bloque[data-cita-id]').length
            });
            
            citas.forEach(cita => {
                const citaId = cita.getAttribute('data-cita-id');
                
                cita.addEventListener('dragover', (e) => {
                    // Usar la variable global en lugar de getData (que no funciona en dragover)
                    if (!tipoRecursoArrastrando) {
                        e.dataTransfer.dropEffect = 'none';
                        return;
                    }
                    
                    // Permitir drop de t√©cnicos y veh√≠culos en cualquier cita
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'move';
                    cita.classList.add('drop-zone-active');
                });
                
                cita.addEventListener('dragleave', (e) => {
                    // Solo remover si realmente salimos de la cita
                    if (!cita.contains(e.relatedTarget)) {
                        cita.classList.remove('drop-zone-active');
                    }
                });
                
                cita.addEventListener('drop', async (e) => {
                    console.log('[DRAG&DROP] üì• ========== DROP EN CITA INICIADO ==========');
                    console.log('[DRAG&DROP] üìç Drop en Cita Paso 1: Evento capturado', {
                        timestamp: new Date().toISOString(),
                        citaId: citaId,
                        eventType: e.type
                    });
                    
                    e.preventDefault();
                    e.stopPropagation();
                    cita.classList.remove('drop-zone-active');
                    
                    // Obtener datos del dataTransfer
                    console.log('[DRAG&DROP] üìç Drop en Cita - Estado del dataTransfer', {
                        types: Array.from(e.dataTransfer.types || []),
                        effectAllowed: e.dataTransfer.effectAllowed,
                        dropEffect: e.dataTransfer.dropEffect,
                        todosLosDatos: {
                            tipo: e.dataTransfer.getData('tipo'),
                            tipoTextPlain: e.dataTransfer.getData('text/plain'),
                            vehiculo: e.dataTransfer.getData('vehiculo'),
                            vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                            username: e.dataTransfer.getData('username'),
                            usernameText: e.dataTransfer.getData('text/username')
                        }
                    });
                    
                    let tipo = e.dataTransfer.getData('tipo');
                    const tipoTextPlain = e.dataTransfer.getData('text/plain');
                    if (!tipo) tipo = tipoTextPlain;
                    
                    if (!tipo || tipo.trim() === '') {
                        console.error('[DRAG&DROP] ‚ùå Error - tipo vac√≠o en drop de cita', {
                            types: Array.from(e.dataTransfer.types || []),
                            todosLosDatos: {
                                tipo: e.dataTransfer.getData('tipo'),
                                tipoTextPlain: e.dataTransfer.getData('text/plain')
                            }
                        });
                        return;
                    }
                    
                    // Obtener la cita desde Firestore para conocer su ruta
                    try {
                        const citaRef = doc(window.db, 'citas', citaId);
                        const citaDoc = await getDoc(citaRef);
                        
                        if (!citaDoc.exists()) {
                            console.error('[DRAG&DROP] ‚ùå Cita no encontrada', { citaId });
                            alert('No se pudo encontrar la cita. Por favor, intente nuevamente.');
                            return;
                        }
                        
                        const citaData = citaDoc.data();
                        const rutaCita = citaData.ruta || 'Sin asignar';
                        
                        if (rutaCita === 'Sin asignar') {
                            alert('No se puede asignar un recurso a una cita sin ruta. Por favor, asigne primero una ruta a la cita.');
                            return;
                        }
                        
                        console.log('[DRAG&DROP] üìç Drop en Cita Paso 2: Datos de la cita', {
                            citaId: citaId,
                            ruta: rutaCita,
                            tipo: tipo
                        });
                        
                        // Obtener la fecha de la cita
                        const inicioCita = citaData.inicio?.toDate ? citaData.inicio.toDate() : new Date(citaData.inicio);
                        const fechaCita = `${inicioCita.getFullYear()}-${String(inicioCita.getMonth() + 1).padStart(2, '0')}-${String(inicioCita.getDate()).padStart(2, '0')}`;
                        
                        // Cargar datos actuales del ruteador
                        const datosActuales = await cargarRuteador(fechaCita, rutaCita);
                        const tecnicosActuales = datosActuales.tecnicos || [];
                        const vehiculosActuales = datosActuales.vehiculos || [];
                        
                        let nuevosTecnicos = [...tecnicosActuales];
                        let nuevosVehiculos = [...vehiculosActuales];
                        
                        if (tipo === 'tecnico') {
                            let username = e.dataTransfer.getData('username');
                            const usernameText = e.dataTransfer.getData('text/username');
                            if (!username) username = usernameText;
                            
                            if (!username || username.trim() === '') {
                                console.error('[DRAG&DROP] ‚ùå Username vac√≠o en drop de cita');
                                alert('No se puede asignar el t√©cnico porque no tiene un username v√°lido.');
                                return;
                            }
                            
                            // Normalizar username
                            const empleado = window.empleados?.find(e => e.id === username || e.username === username);
                            if (empleado) {
                                username = empleado.username || empleado.id;
                            }
                            username = String(username).trim();
                            
                            // Agregar si no est√° ya
                            if (!nuevosTecnicos.includes(username)) {
                                nuevosTecnicos.push(username);
                            }
                        } else if (tipo === 'vehiculo') {
                            // Intentar leer el veh√≠culo de m√∫ltiples fuentes
                            let vehiculo = null;
                            
                            // Primero intentar desde la variable global (m√°s confiable)
                            if (datosRecursoArrastrando.vehiculo) {
                                vehiculo = datosRecursoArrastrando.vehiculo;
                                console.log('[DRAG&DROP] üìç Veh√≠culo obtenido de variable global', { vehiculo });
                            }
                            
                            // Si no est√° en la variable global, intentar desde dataTransfer
                            if (!vehiculo || vehiculo.trim() === '') {
                                vehiculo = e.dataTransfer.getData('vehiculo');
                                if (!vehiculo) vehiculo = e.dataTransfer.getData('text/vehiculo');
                                if (!vehiculo) vehiculo = e.dataTransfer.getData('text/plain');
                                if (vehiculo) {
                                    console.log('[DRAG&DROP] üìç Veh√≠culo obtenido de dataTransfer', { vehiculo });
                                }
                            }
                            
                            // Si a√∫n no se encuentra, intentar obtener del elemento que se arrastr√≥
                            if (!vehiculo || vehiculo.trim() === '') {
                                console.warn('[DRAG&DROP] ‚ö†Ô∏è Veh√≠culo no encontrado en dataTransfer ni variable global, intentando obtener del elemento...', {
                                    datosGlobales: datosRecursoArrastrando,
                                    tiposDisponibles: Array.from(e.dataTransfer.types || []),
                                    todosLosDatos: {
                                        vehiculo: e.dataTransfer.getData('vehiculo'),
                                        vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                                        textPlain: e.dataTransfer.getData('text/plain'),
                                        tipo: e.dataTransfer.getData('tipo')
                                    }
                                });
                                
                                // Intentar obtener del elemento original usando la variable global
                                const elementoArrastrado = document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging');
                                if (elementoArrastrado) {
                                    vehiculo = elementoArrastrado.dataset.vehiculo || 
                                              elementoArrastrado.getAttribute('data-vehiculo') ||
                                              elementoArrastrado.textContent?.trim() || '';
                                    console.log('[DRAG&DROP] üìç Veh√≠culo obtenido del elemento', { vehiculo });
                                }
                            }
                            
                            if (!vehiculo || vehiculo.trim() === '') {
                                console.error('[DRAG&DROP] ‚ùå Veh√≠culo vac√≠o en drop de cita', {
                                    datosGlobales: datosRecursoArrastrando,
                                    dataTransfer: {
                                        types: Array.from(e.dataTransfer.types || []),
                                        vehiculo: e.dataTransfer.getData('vehiculo'),
                                        vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                                        textPlain: e.dataTransfer.getData('text/plain')
                                    },
                                    elementoArrastrado: document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging')?.textContent
                                });
                                alert('No se puede asignar el veh√≠culo porque no tiene un nombre v√°lido.');
                                return;
                            }
                            
                            vehiculo = String(vehiculo).trim();
                            
                            console.log('[DRAG&DROP] ‚úÖ Veh√≠culo obtenido correctamente', { vehiculo });
                            
                            // Agregar si no est√° ya
                            if (!nuevosVehiculos.includes(vehiculo)) {
                                nuevosVehiculos.push(vehiculo);
                            }
                        }
                        
                        // Filtrar valores vac√≠os
                        nuevosTecnicos = nuevosTecnicos.filter(t => t && String(t).trim() !== '');
                        nuevosVehiculos = nuevosVehiculos.filter(v => v && String(v).trim() !== '');
                        
                        // Guardar en Firestore
                        const idRuteador = generarIdRuteador(fechaCita, rutaCita);
                        const ruteadorRef = doc(window.db, 'ruteador', idRuteador);
                        
                        await setDoc(ruteadorRef, {
                            fecha: fechaCita,
                            ruta: rutaCita,
                            tecnicos: nuevosTecnicos,
                            vehiculos: nuevosVehiculos,
                            fecha_actualizacion: serverTimestamp()
                        }, { merge: true });
                        
                        console.log('[DRAG&DROP] ‚úÖ Recurso asignado a la ruta de la cita exitosamente', {
                            citaId: citaId,
                            ruta: rutaCita,
                            fecha: fechaCita,
                            tipo: tipo
                        });
                        
                        // Recargar cronograma
                        await generarCronograma();
                        
                        // Mostrar notificaci√≥n
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Recurso asignado exitosamente a la ruta de la cita';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 2000);
                    } catch (error) {
                        console.error('[DRAG&DROP] ‚ùå Error al asignar recurso a la cita', {
                            citaId: citaId,
                            error: error.message,
                            stack: error.stack
                        });
                        alert('Error al asignar recurso: ' + error.message);
                    }
                });
            });
            
            console.log('[DRAG&DROP] ‚úÖ Listeners de drop agregados a citas', {
                totalCitas: citas.length
            });
            
            dragAndDropCitasConfigurado = true;
            
            // Tambi√©n configurar listeners para citas que se agreguen din√°micamente despu√©s
            // usando un MutationObserver o reconfigurando despu√©s de un peque√±o delay
            setTimeout(() => {
                const citasTardias = document.querySelectorAll('.cita-item[data-cita-id]:not([data-drag-configured]), .cita-bloque[data-cita-id]:not([data-drag-configured])');
                if (citasTardias.length > 0) {
                    console.log('[DRAG&DROP] üìä Configurando drop para citas agregadas tard√≠amente', {
                        totalCitasTardias: citasTardias.length
                    });
                    // Reconfigurar para estas citas tambi√©n (la funci√≥n ya maneja esto, pero marcamos para evitar duplicados)
                    citasTardias.forEach(cita => {
                        cita.setAttribute('data-drag-configured', 'true');
                    });
                }
            }, 500);
        }
        
        // Configurar listeners autom√°ticamente cuando se detecten citas en el DOM
        // Esto asegura que funcione incluso si las citas se generan despu√©s de que se llame inicializarDragAndDropRecursos
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver((mutations) => {
                const citasNuevas = document.querySelectorAll('.cita-item[data-cita-id]:not([data-drag-configured]), .cita-bloque[data-cita-id]:not([data-drag-configured])');
                if (citasNuevas.length > 0 && dragAndDropCitasConfigurado) {
                    // Si ya se configur√≥ antes, solo agregar listeners a las citas nuevas
                    console.log('[DRAG&DROP] üìä Detectadas citas nuevas, configurando drop...', {
                        totalCitasNuevas: citasNuevas.length
                    });
                    // Obtener la fecha actual del d√≠a seleccionado o usar la fecha actual
                    const fechaActual = window.diaSeleccionado ? 
                        `${window.diaSeleccionado.getFullYear()}-${String(window.diaSeleccionado.getMonth() + 1).padStart(2, '0')}-${String(window.diaSeleccionado.getDate()).padStart(2, '0')}` :
                        new Date().toISOString().split('T')[0];
                    inicializarDragAndDropRecursos(fechaActual);
                }
            });
            
            // Observar cambios en el DOM
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        // Variable global para almacenar productos
        window.todosLosProductos = [];
        
        // Funci√≥n para cargar productos desde Firestore
        window.cargarProductos = async function() {
            try {
                const q = query(collection(window.db, 'productos'), where('activo', '==', true), orderBy('nombre', 'asc'));
                const querySnapshot = await getDocs(q);
                window.todosLosProductos = [];
                querySnapshot.forEach(doc => {
                    window.todosLosProductos.push({ id: doc.id, ...doc.data() });
                });
                console.log('‚úÖ Productos cargados:', window.todosLosProductos.length);
                return window.todosLosProductos;
            } catch (error) {
                // Si el error es por √≠ndice en construcci√≥n o no disponible, usar fallback
                if (error.code === 'failed-precondition' || error.message.includes('index') || error.message.includes('building')) {
                    console.log('‚ÑπÔ∏è √çndice en construcci√≥n, usando fallback sin filtro activo...');
                } else {
                console.error('‚ùå Error cargando productos:', error);
                }
                // Si falla por falta de √≠ndice, intentar sin el filtro activo
                try {
                    const q2 = query(collection(window.db, 'productos'), orderBy('nombre', 'asc'));
                    const querySnapshot2 = await getDocs(q2);
                    window.todosLosProductos = [];
                    querySnapshot2.forEach(doc => {
                        const data = doc.data();
                        if (data.activo !== false) { // Incluir si activo no es false expl√≠citamente
                            window.todosLosProductos.push({ id: doc.id, ...data });
                        }
                    });
                    console.log('‚úÖ Productos cargados (sin filtro activo):', window.todosLosProductos.length);
                    return window.todosLosProductos;
                } catch (error2) {
                    console.error('‚ùå Error cargando productos (intento 2):', error2);
                    return [];
                }
            }
        };
        
        // Funci√≥n para renderizar productos con cantidad en el formulario de citas
        window.renderizarProductosCheckboxes = function(productosSeleccionados = []) {
            const container = document.getElementById('editProductosContainer');
            if (!container) return;
            
            if (window.todosLosProductos.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>No hay productos disponibles.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.todosLosProductos.map(producto => {
                // Buscar si el producto est√° seleccionado y obtener su cantidad
                const productoSeleccionado = productosSeleccionados.find(p => 
                    (typeof p === 'string' && p === producto.id) || 
                    (typeof p === 'object' && p.id === producto.id)
                );
                
                const cantidad = productoSeleccionado 
                    ? (typeof productoSeleccionado === 'object' ? productoSeleccionado.cantidad : 1)
                    : 0;
                
                const estaSeleccionado = cantidad > 0;
                const costo = producto.precioUnitario || producto.precio || 0;
                
                return `
                    <div class="d-flex align-items-center mb-3 p-2 border rounded" style="background-color: ${estaSeleccionado ? '#e7f3ff' : '#f8f9fa'};">
                        <div class="form-check me-3">
                            <input class="form-check-input producto-checkbox" 
                                   type="checkbox" 
                                   value="${producto.id}" 
                                   id="producto_${producto.id}"
                                   data-costo="${costo}"
                                   ${estaSeleccionado ? 'checked' : ''}>
                        </div>
                        <label class="form-check-label flex-grow-1" for="producto_${producto.id}" style="cursor: pointer;">
                            <strong>${producto.nombre || 'Sin nombre'}</strong>
                            <br>
                            <small class="text-muted">Costo unitario: ‚Ç°${costo.toLocaleString('es-CR')}</small>
                        </label>
                        <div class="ms-3" style="min-width: 120px;">
                            <label class="form-label small mb-0">Cantidad:</label>
                            <input type="number" 
                                   class="form-control form-control-sm producto-cantidad" 
                                   id="cantidad_${producto.id}"
                                   value="${cantidad}"
                                   min="0"
                                   step="1"
                                   data-producto-id="${producto.id}"
                                   data-costo="${costo}"
                                   ${!estaSeleccionado ? 'disabled' : ''}
                                   style="width: 80px;">
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners para checkboxes
            container.querySelectorAll('.producto-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const productoId = e.target.value;
                    const cantidadInput = document.getElementById(`cantidad_${productoId}`);
                    
                    if (e.target.checked) {
                        cantidadInput.disabled = false;
                        if (parseInt(cantidadInput.value) <= 0) {
                            cantidadInput.value = 1;
                        }
                    } else {
                        cantidadInput.disabled = true;
                        cantidadInput.value = 0;
                    }
                    
                    // Actualizar estilo del contenedor
                    const contenedor = e.target.closest('.border.rounded');
                    if (e.target.checked) {
                        contenedor.style.backgroundColor = '#e7f3ff';
                    } else {
                        contenedor.style.backgroundColor = '#f8f9fa';
                    }
                    
                    window.actualizarResumenFinanciero();
                });
            });
            
            // Agregar event listeners para inputs de cantidad
            container.querySelectorAll('.producto-cantidad').forEach(input => {
                input.addEventListener('input', () => {
                    window.actualizarResumenFinanciero();
                });
                
                input.addEventListener('change', (e) => {
                    const cantidad = parseInt(e.target.value) || 0;
                    const checkbox = document.getElementById(`producto_${e.target.getAttribute('data-producto-id')}`);
                    
                    if (cantidad <= 0) {
                        checkbox.checked = false;
                        e.target.disabled = true;
                        e.target.value = 0;
                        const contenedor = checkbox.closest('.border.rounded');
                        contenedor.style.backgroundColor = '#f8f9fa';
                    } else {
                        checkbox.checked = true;
                        e.target.disabled = false;
                        const contenedor = checkbox.closest('.border.rounded');
                        contenedor.style.backgroundColor = '#e7f3ff';
                    }
                    
                    window.actualizarResumenFinanciero();
                });
            });
        };
        
        // Funci√≥n para obtener productos seleccionados con cantidades
        window.obtenerProductosSeleccionados = function() {
            const checkboxes = document.querySelectorAll('#editProductosContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => {
                const productoId = cb.value;
                const cantidadInput = document.getElementById(`cantidad_${productoId}`);
                const cantidad = parseInt(cantidadInput ? cantidadInput.value : 1) || 1;
                
                return {
                    id: productoId,
                    cantidad: cantidad
                };
            });
        };
        
        // Funci√≥n para calcular y actualizar resumen financiero
        window.actualizarResumenFinanciero = function() {
            // Calcular total de servicios (usando precios personalizados si existen)
            const serviciosSeleccionados = window.obtenerServiciosSeleccionados('edit');
            let totalServicios = 0;
            serviciosSeleccionados.forEach(serv => {
                // serv puede ser string (ID) u objeto {id, precio}
                const servicioId = typeof serv === 'string' ? serv : serv.id;
                const precio = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : 
                              (window.todosLosServicios.find(s => s.id === servicioId)?.precio || 0);
                totalServicios += precio;
            });
            
            // Calcular total de productos (costos)
            const productosSeleccionados = window.obtenerProductosSeleccionados('edit');
            let totalProductos = 0;
            productosSeleccionados.forEach(item => {
                const producto = window.todosLosProductos.find(p => p.id === item.id);
                if (producto) {
                    const costoUnitario = producto.precioUnitario || producto.precio || 0;
                    const cantidad = item.cantidad || 1;
                    totalProductos += costoUnitario * cantidad;
                }
            });
            
            // Obtener costo del servicio (extraer valor num√©rico sin formato)
            const costoServicioInput = document.getElementById('editCostoServicio');
            const valorNumericoCosto = costoServicioInput ? window.extraerValorNumerico(costoServicioInput.value) : '0';
            const costoServicio = parseFloat(valorNumericoCosto) || 0;
            
            // Total de costos (servicios + productos + costo del servicio)
            const totalCostos = totalServicios + totalProductos + costoServicio;
            
            // Obtener monto de venta (extraer valor num√©rico sin formato)
            const montoVentaInput = document.getElementById('editMontoVenta');
            const valorNumerico = montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0';
            const montoVenta = parseFloat(valorNumerico) || 0;
            
            // Calcular neto
            const neto = montoVenta - totalCostos;
            
            // Actualizar UI
            document.getElementById('totalServicios').textContent = `‚Ç°${totalServicios.toLocaleString('es-CR')}`;
            document.getElementById('totalProductos').textContent = `‚Ç°${totalProductos.toLocaleString('es-CR')}`;
            document.getElementById('costoServicioDisplay').textContent = `‚Ç°${costoServicio.toLocaleString('es-CR')}`;
            document.getElementById('totalCostos').textContent = `‚Ç°${totalCostos.toLocaleString('es-CR')}`;
            document.getElementById('montoVentaDisplay').textContent = `‚Ç°${montoVenta.toLocaleString('es-CR')}`;
            
            const netoElement = document.getElementById('netoVenta');
            netoElement.textContent = `‚Ç°${neto.toLocaleString('es-CR')}`;
            if (neto >= 0) {
                netoElement.style.color = '#27ae60';
                netoElement.className = 'float-end';
            } else {
                netoElement.style.color = '#e74c3c';
                netoElement.className = 'float-end';
            }
            netoElement.style.fontWeight = '700';
            netoElement.style.fontSize = '1.2em';
        };
        
        // Funci√≥n para calcular y actualizar resumen financiero del modal de nueva cita
        window.actualizarResumenFinancieroNew = function() {
            // Calcular total de servicios (usando precios personalizados si existen)
            const serviciosSeleccionados = window.obtenerServiciosSeleccionados('new');
            let totalServicios = 0;
            serviciosSeleccionados.forEach(serv => {
                // serv puede ser string (ID) u objeto {id, precio}
                const servicioId = typeof serv === 'string' ? serv : serv.id;
                const precio = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : 
                              (window.todosLosServicios?.find(s => s.id === servicioId)?.precio || 0);
                totalServicios += precio;
            });
            
            // Calcular total de productos (costos)
            const productosSeleccionados = window.productosSeleccionadosNew || [];
            let totalProductos = 0;
            productosSeleccionados.forEach(item => {
                const producto = window.todosLosProductos?.find(p => p.id === item.id);
                if (producto) {
                    const costoUnitario = producto.precioUnitario || producto.precio || 0;
                    const cantidad = item.cantidad || 1;
                    totalProductos += costoUnitario * cantidad;
                }
            });
            
            // Obtener costo del servicio (extraer valor num√©rico sin formato)
            const costoServicioInput = document.getElementById('newCostoServicio');
            const valorNumericoCosto = costoServicioInput ? window.extraerValorNumerico(costoServicioInput.value) : '0';
            const costoServicio = parseFloat(valorNumericoCosto) || 0;
            
            // Total de costos (servicios + productos + costo del servicio)
            const totalCostos = totalServicios + totalProductos + costoServicio;
            
            // Obtener monto de venta (extraer valor num√©rico sin formato)
            const montoVentaInput = document.getElementById('newMontoVenta');
            const valorNumerico = montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0';
            const montoVenta = parseFloat(valorNumerico) || 0;
            
            // Calcular neto
            const neto = montoVenta - totalCostos;
            
            // Actualizar UI
            const totalServiciosEl = document.getElementById('newTotalServicios');
            const totalProductosEl = document.getElementById('newTotalProductos');
            const costoServicioEl = document.getElementById('newCostoServicioDisplay');
            const totalCostosEl = document.getElementById('newTotalCostos');
            const montoVentaEl = document.getElementById('newMontoVentaDisplay');
            const netoEl = document.getElementById('newNetoVenta');
            
            if (totalServiciosEl) totalServiciosEl.textContent = `‚Ç°${totalServicios.toLocaleString('es-CR')}`;
            if (totalProductosEl) totalProductosEl.textContent = `‚Ç°${totalProductos.toLocaleString('es-CR')}`;
            if (costoServicioEl) costoServicioEl.textContent = `‚Ç°${costoServicio.toLocaleString('es-CR')}`;
            if (totalCostosEl) totalCostosEl.textContent = `‚Ç°${totalCostos.toLocaleString('es-CR')}`;
            if (montoVentaEl) montoVentaEl.textContent = `‚Ç°${montoVenta.toLocaleString('es-CR')}`;
            
            if (netoEl) {
                netoEl.textContent = `‚Ç°${neto.toLocaleString('es-CR')}`;
                if (neto >= 0) {
                    netoEl.style.color = '#27ae60';
                } else {
                    netoEl.style.color = '#e74c3c';
                }
            }
        };
        
        // Nota: obtenerProductos puede retornar array de IDs o array de objetos {id, cantidad}
        // Esta versi√≥n simplificada retorna el array tal cual est√° en metadata
        // Si se necesita normalizar a objetos, hacerlo en el c√≥digo que lo usa
        // window.obtenerProductos ya est√° definido arriba usando obtenerCampoCita
        
        // Funci√≥n para generar y descargar proforma PNG
        window.generarProformaPNG = async function() {
            if (!selectedCita) {
                alert('No hay cita seleccionada');
                return;
            }
            
            try {
                // Obtener todos los datos de la cita
                const clienteNombre = window.obtenerClienteNombre(selectedCita);
                const telefonoRaw = window.obtenerTelefono(selectedCita);
                
                // Formatear tel√©fono: remover 506 y formatear como XXXX-XXXX
                let telefonoFormateado = telefonoRaw || '';
                if (telefonoFormateado.startsWith('506')) {
                    telefonoFormateado = telefonoFormateado.substring(3); // Remover "506"
                }
                // Remover cualquier car√°cter no num√©rico y tomar √∫ltimos 8 d√≠gitos
                const soloNumeros = telefonoFormateado.replace(/\D/g, '');
                if (soloNumeros.length >= 8) {
                    const ultimos8 = soloNumeros.slice(-8);
                    telefonoFormateado = `${ultimos8.slice(0, 4)}-${ultimos8.slice(4)}`;
                } else if (soloNumeros.length > 0) {
                    // Si tiene menos de 8 d√≠gitos, mostrar como est√° pero con guion si es posible
                    telefonoFormateado = soloNumeros;
                }
                
                const direccion = window.obtenerDireccion(selectedCita) || 'No especificada';
                const fechaInicio = window.formatearFecha(window.obtenerInicio(selectedCita));
                const duracion = window.obtenerDuracion(selectedCita);
                const montoVenta = window.obtenerMonto(selectedCita) || 0;
                const costoServicio = window.obtenerCostoServicio(selectedCita) || 0;
                
                // Obtener datos de ubicaci√≥n (provincia, cant√≥n, distrito)
                const provinciaId = window.obtenerCampoCita(selectedCita, 'provinciaId', null);
                const cantonId = window.obtenerCampoCita(selectedCita, 'cantonId', null);
                const distritoId = selectedCita.metadata?.distritoId || selectedCita.distritoId || null;
                
                let provinciaNombre = '';
                let cantonNombre = '';
                let distritoNombre = '';
                let coordenadasMapa = null;
                
                // Cargar ubicaciones si no est√°n cargadas
                if (!window.ubicacionesCR) {
                    await cargarUbicaciones();
                }
                
                if (provinciaId && window.ubicacionesCR && window.ubicacionesCR[provinciaId]) {
                    provinciaNombre = window.ubicacionesCR[provinciaId].nombre || '';
                    
                    if (cantonId && window.ubicacionesCR[provinciaId].cantones && window.ubicacionesCR[provinciaId].cantones[cantonId]) {
                        cantonNombre = window.ubicacionesCR[provinciaId].cantones[cantonId].nombre || '';
                        
                        if (distritoId && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                            distritoNombre = window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre || '';
                        }
                    }
                    
                    // Intentar obtener coordenadas para el mapa (m√°xima jerarqu√≠a al distrito)
                    try {
                        let data = null;
                        
                        // Intentar b√∫squedas progresivas, priorizando distrito
                        const queries = [];
                        
                        // 1. Solo distrito + cant√≥n (m√°xima jerarqu√≠a al distrito)
                        if (distritoNombre && cantonNombre) {
                            queries.push(`${distritoNombre}, ${cantonNombre}, Costa Rica`);
                        }
                        
                        // 2. Solo distrito (m√°xima especificidad)
                        if (distritoNombre) {
                            queries.push(`${distritoNombre}, Costa Rica`);
                        }
                        
                        // 3. Distrito + cant√≥n + provincia (fallback)
                        if (distritoNombre && cantonNombre && provinciaNombre) {
                            queries.push(`${distritoNombre}, ${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                        }
                        
                        // 4. Cant√≥n + provincia (si no hay distrito)
                        if (!distritoNombre && cantonNombre && provinciaNombre) {
                            queries.push(`${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                        }
                        
                        // 5. Solo provincia (√∫ltimo recurso)
                        if (!distritoNombre && !cantonNombre && provinciaNombre) {
                            queries.push(`${provinciaNombre}, Costa Rica`);
                        }
                        
                        // Intentar cada query hasta encontrar resultados
                        for (const query of queries) {
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                            const result = await response.json();
                            
                            if (result && result.length > 0) {
                                data = result;
                                break;
                            }
                        }
                        
                        if (data && data.length > 0) {
                            coordenadasMapa = {
                                lat: parseFloat(data[0].lat),
                                lon: parseFloat(data[0].lon)
                            };
                        }
                    } catch (error) {
                        console.warn('No se pudieron obtener coordenadas para el mapa:', error);
                    }
                }
                
                // Formatear fecha y hora (compacto pero con d√≠a de la semana)
                let fechaFormateada = 'No especificada';
                let horaFormateada = 'No especificada';
                
                if (fechaInicio) {
                    const diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
                    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    
                    const diaSemana = diasSemana[fechaInicio.getDay()];
                    const dia = fechaInicio.getDate();
                    const mes = meses[fechaInicio.getMonth()];
                    const a√±o = fechaInicio.getFullYear();
                    
                    fechaFormateada = `${diaSemana}, ${dia} de ${mes} de ${a√±o}`;
                    
                    horaFormateada = fechaInicio.toLocaleTimeString('es-CR', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true
                    });
                }
                
                // Obtener servicios (con precios personalizados)
                const serviciosSeleccionados = window.obtenerServiciosSeleccionados('edit');
                let totalServicios = 0;
                const serviciosDetalle = serviciosSeleccionados.map(serv => {
                    // serv puede ser string (ID) u objeto {id, precio}
                    const servicioId = typeof serv === 'string' ? serv : serv.id;
                    const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                    if (servicio) {
                        // Usar precio personalizado si existe, sino usar precio del servicio base
                        const precio = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : (servicio.precio || 0);
                        totalServicios += precio;
                        return {
                            nombre: servicio.nombre || 'Sin nombre',
                            precio: precio
                        };
                    }
                    return null;
                }).filter(s => s !== null);
                
                // Obtener productos
                const productosSeleccionados = window.obtenerProductosSeleccionados('edit');
                let totalProductos = 0;
                const productosDetalle = productosSeleccionados.map(item => {
                    const producto = window.todosLosProductos.find(p => p.id === item.id);
                    if (producto) {
                        const costoUnitario = producto.precioUnitario || producto.precio || 0;
                        const cantidad = item.cantidad || 1;
                        const subtotal = costoUnitario * cantidad;
                        totalProductos += subtotal;
                        return {
                            nombre: producto.nombre || 'Sin nombre',
                            cantidad: cantidad,
                            costoUnitario: costoUnitario,
                            subtotal: subtotal
                        };
                    }
                    return null;
                }).filter(p => p !== null);
                
                // Calcular totales (incluyendo costo del servicio)
                const totalCostos = totalServicios + totalProductos + costoServicio;
                const descuento = totalCostos > montoVenta ? totalCostos - montoVenta : 0;
                const neto = montoVenta - totalCostos;
                
                // Crear elemento HTML para la proforma
                const proformaDiv = document.createElement('div');
                proformaDiv.id = 'proforma-container';
                proformaDiv.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    width: 600px;
                    max-width: 100vw;
                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 5%, #ffffff 95%, #f8f9fa 100%);
                    padding: 0;
                    font-family: 'Arial', sans-serif;
                    color: #333;
                    box-shadow: 0 0 0 6px #4CAF50, 0 0 0 10px #e8f5e9, 0 0 0 14px #4CAF50, 0 10px 40px rgba(0,0,0,0.15);
                    border-radius: 4px;
                    overflow: hidden;
                `;
                
                proformaDiv.innerHTML = `
                    <!-- Marco decorativo superior -->
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); height: 8px; width: 100%;"></div>
                    
                    <!-- Contenido principal con padding -->
                    <div style="padding: 15px; background: white;">
                    <div style="text-align: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #4CAF50; position: relative;">
                        <!-- Decoraci√≥n de esquinas -->
                        <div style="position: absolute; top: -2px; left: 0; width: 15px; height: 15px; border-top: 2px solid #4CAF50; border-left: 2px solid #4CAF50;"></div>
                        <div style="position: absolute; top: -2px; right: 0; width: 15px; height: 15px; border-top: 2px solid #4CAF50; border-right: 2px solid #4CAF50;"></div>
                        
                        <img src="Logo Eco Plagas.png" alt="Eco Plagas" style="max-width: 80px; height: auto; margin-bottom: 3px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));" onerror="this.style.display='none'">
                        <h1 style="color: #4CAF50; margin: 2px 0; font-size: 24px; font-weight: bold; letter-spacing: 2px;">PROFORMA</h1>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 8px 10px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">üë§</span><strong style="color: #4CAF50;">${clienteNombre}</strong></p>
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">üì±</span>${telefonoFormateado}</p>
                        ${provinciaNombre ? `
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">üó∫Ô∏è</span><strong>Provincia:</strong> ${provinciaNombre}${cantonNombre ? ` | <strong>Cant√≥n:</strong> ${cantonNombre}${distritoNombre ? ` | <strong>Distrito:</strong> ${distritoNombre}` : ''}` : ''}</p>
                        ` : ''}
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">üìç</span>${direccion}</p>
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">üìÖ</span>${fechaFormateada} <span style="color: #666; font-size: 16px;">üïê ${horaFormateada} (m√°ximo ${duracion} min)</span></p>
                    </div>
                    
                    ${coordenadasMapa ? `
                    <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <h4 style="color: #4CAF50; font-size: 18px; margin-bottom: 6px; font-weight: bold;">üó∫Ô∏è Ubicaci√≥n en el Mapa</h4>
                        <div id="mapaProforma" style="height: 200px; width: 100%; border-radius: 6px; border: 1px solid #dee2e6; background: #e9ecef;"></div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 10px;">
                        <h3 style="color: #4CAF50; font-size: 20px; margin-bottom: 5px; padding-bottom: 3px; border-bottom: 2px solid #4CAF50; font-weight: bold;">‚úì Servicios</h3>
                        ${serviciosDetalle.length > 0 ? `
                        <div style="background: #f8f9fa; padding: 6px; border-radius: 6px; border-left: 3px solid #4CAF50;">
                            ${serviciosDetalle.map(s => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e0e0e0; font-size: 19px;">
                                    <span style="color: #333; font-weight: 500;">${s.nombre}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : '<p style="font-size: 18px; color: #666; margin: 3px 0; padding: 6px; background: #f8f9fa; border-radius: 6px;">Sin servicios</p>'}
                    </div>
                    
                    ${productosDetalle.length > 0 ? `
                    <div style="margin-bottom: 10px;">
                        <h3 style="color: #4CAF50; font-size: 20px; margin-bottom: 5px; padding-bottom: 3px; border-bottom: 2px solid #4CAF50; font-weight: bold;">üì¶ Productos</h3>
                        <div style="background: #f8f9fa; padding: 6px; border-radius: 6px; border-left: 3px solid #4CAF50;">
                            ${productosDetalle.map(p => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e0e0e0; font-size: 19px;">
                                    <span style="color: #333; font-weight: 500;">${p.nombre}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 10px; padding: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                        <table style="width: 100%; border-collapse: collapse; color: white;">
                            ${serviciosDetalle.length > 0 ? `
                            <tr>
                                <td style="padding: 5px 0; font-size: 17px;">‚úì Servicios:</td>
                                <td style="padding: 5px 0; text-align: right; font-size: 17px; font-weight: bold;">‚Ç°${totalServicios.toLocaleString('es-CR')}</td>
                            </tr>
                            ` : ''}
                            ${productosDetalle.length > 0 ? `
                            <tr>
                                <td style="padding: 5px 0; font-size: 17px;">üì¶ Productos:</td>
                                <td style="padding: 5px 0; text-align: right; font-size: 17px; font-weight: bold;">‚Ç°${totalProductos.toLocaleString('es-CR')}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 5px 0; font-size: 17px;">üîß Costo Servicio:</td>
                                <td style="padding: 5px 0; text-align: right; font-size: 17px; font-weight: bold;">‚Ç°${costoServicio.toLocaleString('es-CR')}</td>
                            </tr>
                            <tr style="border-top: 1px solid rgba(255,255,255,0.3);">
                                <td style="padding: 6px 0; font-size: 18px; font-weight: bold;">Total:</td>
                                <td style="padding: 6px 0; text-align: right; font-size: 18px; font-weight: bold;">‚Ç°${totalCostos.toLocaleString('es-CR')}</td>
                            </tr>
                            ${descuento > 0 ? `
                            <tr style="background-color: rgba(255, 87, 34, 0.9); border-radius: 4px;">
                                <td style="padding: 8px 6px; font-size: 19px; font-weight: bold; color: white;">üéâ Descuento:</td>
                                <td style="padding: 8px 6px; text-align: right; font-size: 19px; font-weight: bold; color: white;">-‚Ç°${descuento.toLocaleString('es-CR')}</td>
                            </tr>
                            ` : ''}
                            <tr style="border-top: 3px solid rgba(255,255,255,0.8); background-color: rgba(0,0,0,0.2); border-radius: 0 0 8px 8px;">
                                <td style="padding: 12px 0 8px 0; font-size: 28px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">üí∞ Total a Pagar:</td>
                                <td style="padding: 12px 0 8px 0; text-align: right; font-size: 32px; font-weight: bold; text-shadow: 0 2px 6px rgba(0,0,0,0.4);">‚Ç°${montoVenta.toLocaleString('es-CR')}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 8px; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); border-left: 4px solid #2196F3; border-radius: 6px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 19px; color: #1976D2; font-weight: bold;">üí≥ Pago</h4>
                        <div style="background: white; padding: 6px; border-radius: 4px; border: 1px solid #e0e0e0;">
                            <p style="margin: 5px 0; font-size: 17px; color: #333;"><strong style="color: #1976D2;">üè¶ Banco Nacional:</strong> 200-01-000-123456-7</p>
                            <p style="margin: 5px 0; font-size: 17px; color: #333;"><strong style="color: #1976D2;">üè¶ Banco de Costa Rica:</strong> 152-010-000-123456-7</p>
                            <p style="margin: 5px 0; font-size: 17px; color: #333;"><strong style="color: #1976D2;">üè¶ Banco Popular:</strong> 001-123456-7</p>
                            <p style="margin: 6px 0 0 0; font-size: 16px; color: #666; padding-top: 6px; border-top: 1px solid #e0e0e0;"><strong>A nombre de:</strong> <span style="color: #4CAF50; font-weight: bold;">Ecofumigadora Hermanos Paniagua SRL</span></p>
                            <p style="margin: 3px 0 0 0; font-size: 14px; color: #666;">C√©dula Jur√≠dica: 3102850026</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding-top: 8px; border-top: 2px solid #e0e0e0; color: #666; font-size: 16px; position: relative;">
                        <!-- Decoraci√≥n de esquinas inferiores -->
                        <div style="position: absolute; bottom: -2px; left: 0; width: 15px; height: 15px; border-bottom: 2px solid #e0e0e0; border-left: 2px solid #e0e0e0;"></div>
                        <div style="position: absolute; bottom: -2px; right: 0; width: 15px; height: 15px; border-bottom: 2px solid #e0e0e0; border-right: 2px solid #e0e0e0;"></div>
                        
                        <p style="margin: 3px 0; color: #4CAF50; font-weight: 500; font-size: 18px;">üìû (506) 1234-5678 | ‚úâÔ∏è info@800fumigar.com</p>
                        <p style="margin: 3px 0; font-style: italic; color: #999; font-size: 14px;">Proforma sin validez fiscal</p>
                    </div>
                    </div>
                    
                    <!-- Marco decorativo inferior -->
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); height: 8px; width: 100%;"></div>
                `;
                
                document.body.appendChild(proformaDiv);
                
                // Inicializar mapa en la proforma si hay coordenadas
                if (coordenadasMapa) {
                    const mapaProformaDiv = proformaDiv.querySelector('#mapaProforma');
                    if (mapaProformaDiv) {
                        // Crear mapa Leaflet
                        const mapaProforma = L.map('mapaProforma', {
                            zoomControl: false,
                            attributionControl: false
                        }).setView([coordenadasMapa.lat, coordenadasMapa.lon], 13);
                        
                        // Agregar capa de Esri World Street Map (similar a Google Maps)
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                            attribution: '',
                            maxZoom: 19
                        }).addTo(mapaProforma);
                        
                        // Agregar marcador
                        L.marker([coordenadasMapa.lat, coordenadasMapa.lon]).addTo(mapaProforma);
                        
                        // Esperar a que el mapa se renderice
                        await new Promise((resolve) => {
                            setTimeout(() => {
                                mapaProforma.invalidateSize();
                                setTimeout(resolve, 1000); // Esperar 1 segundo para que se carguen los tiles
                            }, 100);
                        });
                    }
                }
                
                // Esperar a que la imagen del logo se cargue
                await new Promise((resolve) => {
                    const img = proformaDiv.querySelector('img');
                    if (img && img.complete) {
                        resolve();
                    } else if (img) {
                        img.onload = resolve;
                        img.onerror = resolve; // Continuar aunque falle la imagen
                        setTimeout(resolve, 2000); // Timeout de 2 segundos
                    } else {
                        resolve();
                    }
                });
                
                // Generar PNG con html2canvas - optimizado para m√≥viles
                const canvas = await html2canvas(proformaDiv, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: 600,
                    height: proformaDiv.scrollHeight,
                    windowWidth: 600
                });
                
                // Convertir a blob y descargar
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const fechaStr = fechaInicio ? fechaInicio.toISOString().slice(0, 10) : 'proforma';
                    link.download = `Proforma_${clienteNombre.replace(/\s+/g, '_')}_${fechaStr}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    // Limpiar
                    document.body.removeChild(proformaDiv);
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Error generando proforma:', error);
                alert('Error al generar la proforma: ' + error.message);
            }
        };
        // Wrapper seguro para obtenerClienteNombreSync que siempre retorna string
        const obtenerClienteNombre = function(cita) {
            if (!window.obtenerClienteNombreSync) {
                console.error('‚ùå [GLOBAL] obtenerClienteNombreSync no est√° disponible');
                return cita.metadata?.cliente_nombre || cita.client_name || 'Sin nombre';
            }
            
            try {
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('‚ùå [GLOBAL] obtenerClienteNombreSync retorn√≥ una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                // Asegurar que sea string
                if (typeof resultado !== 'string') {
                    console.error('‚ùå [GLOBAL] obtenerClienteNombreSync no retorn√≥ string', {
                        citaId: cita.id,
                        tipo: typeof resultado,
                        valor: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado;
            } catch (error) {
                console.error('‚ùå [GLOBAL] Error en obtenerClienteNombreSync', {
                    citaId: cita.id,
                    error: error.message
                });
                return 'Sin nombre';
            }
        };
        
        const obtenerTelefono = window.obtenerTelefono;
        const obtenerVehiculo = window.obtenerVehiculo;
        const obtenerEstado = window.obtenerEstado;
        const obtenerMonto = window.obtenerMonto;
        const obtenerVendedores = window.obtenerVendedores;
        const obtenerDireccion = window.obtenerDireccion;
        const obtenerDescripcion = window.obtenerDescripcion;
        const obtenerTurno = window.obtenerTurno;
        const obtenerTurnoEmoji = window.obtenerTurnoEmoji;
        
        // Funci√≥n para cargar nombres de clientes de forma as√≠ncrona y actualizar metadata
        async function cargarNombresClientesParaCitas() {
            if (!window.todasLasCitas || window.todasLasCitas.length === 0) return;
            
            // Identificar citas que no tienen cliente_nombre en metadata
            const citasSinNombre = window.todasLasCitas.filter(cita => {
                const tieneNombre = cita.metadata?.cliente_nombre || cita.client_name;
                return !tieneNombre && cita.telefono;
            });
            
            if (citasSinNombre.length === 0) {
                console.log('‚úÖ Todas las citas ya tienen nombre en metadata');
                return;
            }
            
            console.log(`üîç Cargando nombres para ${citasSinNombre.length} citas sin nombre...`);
            
            // Obtener tel√©fonos √∫nicos
            const telefonosUnicos = [...new Set(citasSinNombre.map(c => c.telefono))];
            
            // Cargar clientes en paralelo
            const clientesPromesas = telefonosUnicos.map(telefono => 
                window.buscarCliente(telefono).then(cliente => ({ telefono, cliente }))
            );
            
            const resultados = await Promise.all(clientesPromesas);
            const clientesMap = new Map();
            resultados.forEach(({ telefono, cliente }) => {
                if (cliente && cliente.nombre) {
                    clientesMap.set(telefono, cliente.nombre);
                }
            });
            
            // Actualizar citas en memoria con nombres encontrados
            let actualizadas = 0;
            citasSinNombre.forEach(cita => {
                const nombreCliente = clientesMap.get(cita.telefono);
                if (nombreCliente) {
                    // Actualizar en memoria (no en Firestore todav√≠a)
                    if (!cita.metadata) {
                        cita.metadata = {};
                    }
                    cita.metadata.cliente_nombre = nombreCliente;
                    actualizadas++;
                }
            });
            
            console.log(`‚úÖ Actualizados ${actualizadas} nombres de clientes en memoria`);
            
            // Opcional: Actualizar en Firestore (en batch para no hacer muchas escrituras)
            // Por ahora solo actualizamos en memoria para que se muestre inmediatamente
            // Las pr√≥ximas veces que se guarde la cita, se guardar√° el nombre en metadata
            
            return actualizadas; // Retornar cantidad de nombres cargados
        }

        // Funci√≥n para cargar encuestas y crear mapas
        async function cargarMapaEncuestas() {
            try {
                mapaLinksEncuestas.clear();
                mapaRespuestasEncuestas.clear();
                mapaJustificacionesSinEncuesta.clear();
                
                // Cargar links generados (encuestas_id)
                // ‚ö†Ô∏è SEGURIDAD: Limitar a 5000 para prevenir dumpeado masivo
                const encuestasIdQuery = query(collection(window.db, 'encuestas_id'), limit(5000));
                const encuestasIdSnapshot = await getDocs(encuestasIdQuery);
                encuestasIdSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const telefono = data.telefono || '';
                    const fechaServicio = data.fecha_servicio;
                    const idEncuesta = data.id_encuesta || doc.id;
                    
                    if (telefono && fechaServicio) {
                        // Normalizar tel√©fono (quitar 506 si existe)
                        let telefonoNormalizado = telefono.replace(/\D/g, '');
                        if (telefonoNormalizado.startsWith('506')) {
                            telefonoNormalizado = telefonoNormalizado.substring(3);
                        }
                        
                        // Crear clave √∫nica: telefono_fechaServicio (timestamp)
                        const fechaTimestamp = fechaServicio.toMillis ? fechaServicio.toMillis() : (fechaServicio.seconds * 1000);
                        const clave = `${telefonoNormalizado}_${fechaTimestamp}`;
                        mapaLinksEncuestas.set(clave, idEncuesta); // Guardar el id_encuesta para verificar respuesta
                    }
                });
                
                // Cargar respuestas recibidas (encuestas)
                // ‚ö†Ô∏è SEGURIDAD: Limitar a 5000 para prevenir dumpeado masivo
                const encuestasQuery = query(collection(window.db, 'encuestas'), limit(5000));
                const encuestasSnapshot = await getDocs(encuestasQuery);
                encuestasSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const idEncuesta = data.id_encuesta || doc.id;
                    if (idEncuesta) {
                        mapaRespuestasEncuestas.set(idEncuesta, true);
                    }
                });
                
                // Cargar justificaciones de citas sin encuesta
                // El ID del documento ES el cita_id (se guarda con doc(window.db, 'justificaciones_sin_encuesta', citaId))
                // ‚ö†Ô∏è SEGURIDAD: Limitar a 1000 para prevenir dumpeado masivo
                const justificacionesQuery = query(collection(window.db, 'justificaciones_sin_encuesta'), limit(1000));
                const justificacionesSnapshot = await getDocs(justificacionesQuery);
                console.log(`üìã Cargando justificaciones: ${justificacionesSnapshot.size} documentos encontrados`);
                justificacionesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const citaId = doc.id; // El ID del documento es el cita_id
                    if (citaId && data.justificacion) {
                        mapaJustificacionesSinEncuesta.set(citaId, data.justificacion);
                        console.log(`‚úÖ Justificaci√≥n cargada para cita ${citaId}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Justificaci√≥n incompleta - Doc ID: ${citaId}, tiene justificacion: ${!!data.justificacion}`);
                    }
                });
                console.log(`‚úÖ Total justificaciones cargadas en mapa: ${mapaJustificacionesSinEncuesta.size}`);
                
                console.log(`‚úÖ Mapas de encuestas cargados: ${mapaLinksEncuestas.size} links generados, ${mapaRespuestasEncuestas.size} respuestas recibidas, ${mapaJustificacionesSinEncuesta.size} justificaciones`);
            } catch (error) {
                console.error('‚ùå Error cargando mapas de encuestas:', error);
            }
        }

        // Funci√≥n para obtener el estado de la encuesta de una cita
        // Retorna: 0 = sin link, 1 = link generado sin respuesta, 2 = cliente respondi√≥, 3 = justificada sin encuesta
        function obtenerEstadoEncuesta(cita) {
            if (!cita || !cita.id) return 0;
            
            // Primero verificar si tiene justificaci√≥n
            if (mapaJustificacionesSinEncuesta.has(cita.id)) {
                return 3; // Justificada sin encuesta
            }
            
            if (!cita.telefono || !cita.inicio_gmt6) return 0;
            
            // Normalizar tel√©fono
            let telefonoNormalizado = cita.telefono.replace(/\D/g, '');
            if (telefonoNormalizado.startsWith('506')) {
                telefonoNormalizado = telefonoNormalizado.substring(3);
            }
            
            // Obtener timestamp de inicio_gmt6
            const fechaTimestamp = cita.inicio_gmt6.toMillis ? cita.inicio_gmt6.toMillis() : (cita.inicio_gmt6.seconds * 1000);
            const clave = `${telefonoNormalizado}_${fechaTimestamp}`;
            
            // Verificar si se gener√≥ el link
            const idEncuesta = mapaLinksEncuestas.get(clave);
            if (!idEncuesta) {
                return 0; // Sin link generado
            }
            
            // Verificar si el cliente respondi√≥
            if (mapaRespuestasEncuestas.has(idEncuesta)) {
                return 2; // Cliente respondi√≥
            }
            
            return 1; // Link generado pero sin respuesta
        }

        // Funci√≥n para obtener la justificaci√≥n de una cita
        function obtenerJustificacion(cita) {
            if (!cita || !cita.id) return null;
            return mapaJustificacionesSinEncuesta.get(cita.id) || null;
        }

        // Funci√≥n para cargar datos
        window.cargarDatos = async function cargarDatos() {
            console.log('üîÑ ===== INICIANDO cargarDatos =====');
            try {
                console.log('üîÑ Cargando datos del calendario...');
                
                // Cargar mapa de encuestas en paralelo
                await cargarMapaEncuestas();

                console.log('üîç Creando query para Firebase...');
                // NOTA: Esta consulta es para VISUALIZACI√ìN (mostrar calendario)
                // El calendario necesita todas las citas para filtrar y mostrar correctamente
                // ‚ö†Ô∏è SEGURIDAD: Limitar a 5000 citas para prevenir dumpeado masivo en visualizaci√≥n
                // Si necesitas m√°s, implementar paginaci√≥n o filtrar por rango de fechas
                const q = query(collection(window.db, 'citas'), orderBy('inicio_gmt6', 'desc'), limit(5000));
                console.log('üîç Ejecutando query...');
                const querySnapshot = await getDocs(q);
                console.log('‚úÖ Query ejecutado, documentos encontrados:', querySnapshot.size);
                
                todasLasCitas = [];
                querySnapshot.forEach((doc) => {
                    todasLasCitas.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                window.todasLasCitas = todasLasCitas;
                console.log('‚úÖ Citas cargadas en window.todasLasCitas:', todasLasCitas.length);
                
                // Cargar nombres de clientes de forma as√≠ncrona para citas que no tienen cliente_nombre en metadata
                console.log('üîç Cargando nombres de clientes para citas sin nombre...');
                await cargarNombresClientesParaCitas();
                console.log('‚úÖ Nombres de clientes cargados');

                console.log('üîç Aplicando filtros...');
                aplicarFiltros();
                console.log('‚úÖ Filtros aplicados, citas filtradas:', citasFiltradas.length);
                
                // Actualizar botones de d√≠as despu√©s de cargar datos
                if (diaSeleccionado) {
                    generarBotonesDiasMes(diaSeleccionado);
                }
                
                console.log('üîç Vista actual:', vistaActual);
                
                // Generar vista inicial
                if (vistaActual === 'mes') {
                    console.log('üîç Generando vista mes...');
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    console.log('üîç Generando vista d√≠a...');
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    console.log('üîç Generando cronograma...');
                    await generarCronograma();
                }
                
                // Si se cargaron nombres de clientes, regenerar la vista para mostrarlos
                // (solo si se actualizaron nombres)
                const nombresCargados = await cargarNombresClientesParaCitas();
                if (nombresCargados > 0) {
                    console.log(`üîÑ Regenerando vista con ${nombresCargados} nombres de clientes actualizados...`);
                    if (vistaActual === 'cronograma') {
                        await generarCronograma();
                    } else if (vistaActual === 'mes') {
                        generarCalendario();
                    } else if (vistaActual === 'dia') {
                        generarVistaDia();
                    }
                }
                
                console.log('‚úÖ ===== FIN cargarDatos =====');

            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error cargando datos: ' + error.message);
            } finally {
                console.log('‚úÖ Carga de datos completada');
            }
        }

        // Funci√≥n para aplicar filtros
        function aplicarFiltros() {
            citasFiltradas = todasLasCitas.filter(cita => {
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const vehicleFilterValue = vehicleFilter ? vehicleFilter.value : '';
                const statusFilterValue = statusFilter ? statusFilter.value : '';

                if (searchTerm && !obtenerClienteNombre(cita)?.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (vehicleFilterValue && obtenerRuta(cita) !== vehicleFilterValue) {
                    return false;
                }
                if (statusFilterValue && obtenerEstado(cita) !== statusFilterValue) {
                    return false;
                }

                return true;
            });
            window.citasFiltradas = citasFiltradas;
        }

        // Funci√≥n para cambiar vista
        async function cambiarVista(vista) {
            vistaActual = vista;
            window.vistaActual = vistaActual;
            
            // Ocultar todas las vistas
            calendarGrid.style.display = 'none';
            vistaDia.style.display = 'none';
            vistaCronograma.style.display = 'none';
            
            // Remover clases activas (bot√≥n de cronograma ya no existe en el men√∫)
            const btnVistaCronograma = document.getElementById('btnVistaCronograma');
            if (btnVistaCronograma) {
                btnVistaCronograma.classList.remove('active');
            }
            
            if (vista === 'cronograma') {
                // Vista de cronograma (bot√≥n removido del men√∫, pero la funcionalidad sigue disponible)
                vistaCronograma.style.display = 'block';
                if (btnVistaCronograma) {
                    btnVistaCronograma.classList.add('active');
                }
                await generarCronograma();
            } else if (vista === 'mes' || vista === 'dia') {
                // Mostrar calendario mensual o vista de d√≠a
                if (vista === 'mes') {
                    calendarGrid.style.display = 'grid';
                    generarCalendario();
                } else if (vista === 'dia') {
                    vistaDia.style.display = 'block';
                    generarVistaDia();
                }
            }
        }

        // Funci√≥n para generar vista de d√≠a
        function generarVistaDia() {
            // Usar versi√≥n s√≠ncrona para renderizado r√°pido
            const obtenerClienteNombre = function(cita) {
                if (!window.obtenerClienteNombreSync) {
                    console.error('‚ùå [generarVistaDia] obtenerClienteNombreSync no est√° disponible');
                    return cita.metadata?.cliente_nombre || cita.client_name || 'Sin nombre';
                }
                
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('‚ùå [generarVistaDia] obtenerClienteNombreSync retorn√≥ una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado || 'Sin nombre';
            };
            
            const year = diaSeleccionado.getFullYear();
            const month = diaSeleccionado.getMonth();
            const day = diaSeleccionado.getDate();
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const dayNames = [
                'Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'
            ];
            
            vistaDiaTitulo.innerHTML = `
                <i class="fas fa-calendar-day me-2"></i>
                ${dayNames[diaSeleccionado.getDay()]}, ${day} de ${monthNames[month]} de ${year}
            `;

            // Obtener citas del d√≠a
            const citasDelDia = citasFiltradas.filter(cita => {
                const fechaCita = window.formatearFecha(obtenerInicio(cita));
                if (!fechaCita) return false;
                return fechaCita.getDate() === day && 
                       fechaCita.getMonth() === month && 
                       fechaCita.getFullYear() === year;
            });
            
            // Calcular facturaci√≥n total del d√≠a
            const facturacionTotalDia = citasDelDia.reduce((sum, cita) => {
                const monto = obtenerMonto(cita);
                return sum + (monto || 0);
            }, 0);
            
            // Mostrar facturaci√≥n total del d√≠a
            const facturacionTotalDiaElement = document.getElementById('facturacionTotalDia');
            const montoTotalDiaElement = document.getElementById('montoTotalDia');
            if (facturacionTotalDiaElement && montoTotalDiaElement) {
                montoTotalDiaElement.textContent = `‚Ç°${facturacionTotalDia.toLocaleString('es-CR')}`;
                facturacionTotalDiaElement.style.display = 'block';
            }

            // Agrupar citas por ruta
            const citasPorRuta = {};
            citasDelDia.forEach(cita => {
                const ruta = obtenerRuta(cita);
                if (!citasPorRuta[ruta]) {
                    citasPorRuta[ruta] = [];
                }
                citasPorRuta[ruta].push(cita);
            });

            // Ordenar citas por hora
            Object.keys(citasPorRuta).forEach(ruta => {
                citasPorRuta[ruta].sort((a, b) => {
                    const fechaA = window.formatearFecha(obtenerInicio(a));
                    const fechaB = window.formatearFecha(obtenerInicio(b));
                    if (!fechaA || !fechaB) return 0;
                    return fechaA.getTime() - fechaB.getTime();
                });
            });

            // Generar columnas de rutas
            const rutasOrdenadas = Object.keys(citasPorRuta).sort((a, b) => {
                // Ordenar "Sin asignar" primero, luego rutas num√©ricamente
                if (a === 'Sin asignar') return -1;
                if (b === 'Sin asignar') return 1;
                const numA = parseInt(a.replace('Ruta ', '')) || 0;
                const numB = parseInt(b.replace('Ruta ', '')) || 0;
                return numA - numB;
            });

            vehiculosGrid.innerHTML = rutasOrdenadas.map(ruta => {
                const citas = citasPorRuta[ruta];
                const totalCitas = citas.length;
                const totalDuracion = citas.reduce((sum, cita) => sum + obtenerDuracion(cita), 0);
                const totalVentas = citas.reduce((sum, cita) => sum + obtenerMonto(cita), 0);
                
                // Filtrar citas con ubicaci√≥n completa
                const citasConUbicacion = citas.filter(cita => {
                    const provinciaId = cita.metadata?.provinciaId || cita.provinciaId;
                    const cantonId = cita.metadata?.cantonId || cita.cantonId;
                    const distritoId = cita.metadata?.distritoId || cita.distritoId;
                    return provinciaId && cantonId && distritoId;
                });
                
                // Almacenar citas en variable global para acceso desde el bot√≥n
                const rutaId = ruta.replace(/[^a-zA-Z0-9]/g, '-');
                if (!window.citasPorRutaRuta) {
                    window.citasPorRutaRuta = {};
                }
                window.citasPorRutaRuta[rutaId] = citas;

                return `
                    <div class="vehiculo-columna">
                        <div class="vehiculo-header ${ruta.replace(' ', '-')}">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1; flex-wrap: wrap;">
                                    <span style="font-weight: 600;"><i class="fas fa-route me-2"></i>${ruta}</span>
                                    <span style="font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 4px; white-space: nowrap;">
                                        <i class="fas fa-calendar-check me-1"></i><strong>${totalCitas}</strong> ${totalCitas === 1 ? 'cita' : 'citas'}
                                    </span>
                                    <span style="font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 4px; white-space: nowrap;">
                                        <i class="fas fa-money-bill-wave me-1"></i><strong>‚Ç°${totalVentas.toLocaleString('es-CR')}</strong>
                                    </span>
                                </div>
                                ${citasConUbicacion.length > 0 ? `
                                <button onclick="window.mostrarRutaVehiculo('${ruta.replace(/'/g, "\\'")}', '${rutaId}')" 
                                        style="background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.4); 
                                               color: white; padding: 5px 12px; border-radius: 4px; font-size: 0.75rem; 
                                               cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                                        onmouseover="this.style.background='rgba(255,255,255,0.35)'; this.style.transform='scale(1.02)'"
                                        onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1)'">
                                    <i class="fas fa-route me-1"></i>Ver Ruta (${citasConUbicacion.length})
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="vehiculo-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <strong>${totalCitas}</strong><br>
                                    <small>Citas</small>
                                </div>
                                <div class="col-4">
                                    <strong>${totalDuracion}min</strong><br>
                                    <small>Duraci√≥n</small>
                                </div>
                                <div class="col-4">
                                    <strong>‚Ç°${totalVentas.toLocaleString()}</strong><br>
                                    <small>Ventas</small>
                                </div>
                            </div>
                        </div>
                        <div class="citas-container">
                            ${citas.length > 0 ? (() => {
                                // Agrupar citas por hora (redondeando a la misma franja horaria)
                                const citasPorHora = {};
                                
                                citas.forEach(cita => {
                                    const fechaInicio = window.formatearFecha(obtenerInicio(cita));
                                    if (!fechaInicio) return;
                                    
                                    // Redondear a la misma franja horaria (mismo hora y minuto)
                                    const hora = fechaInicio.getHours();
                                    const minuto = fechaInicio.getMinutes();
                                    const claveHora = `${hora}:${String(minuto).padStart(2, '0')}`;
                                    
                                    if (!citasPorHora[claveHora]) {
                                        citasPorHora[claveHora] = [];
                                    }
                                    citasPorHora[claveHora].push(cita);
                                });
                                
                                // Ordenar las horas
                                const horasOrdenadas = Object.keys(citasPorHora).sort((a, b) => {
                                    const [horaA, minA] = a.split(':').map(Number);
                                    const [horaB, minB] = b.split(':').map(Number);
                                    return (horaA * 60 + minA) - (horaB * 60 + minB);
                                });
                                
                                // Renderizar citas agrupadas por hora
                                return horasOrdenadas.map(claveHora => {
                                    const citasEnHora = citasPorHora[claveHora];
                                    const tieneMultiples = citasEnHora.length > 1;
                                    
                                    // Si hay m√∫ltiples citas en la misma hora, usar contenedor flex
                                    const contenedorClase = tieneMultiples ? 'citas-misma-hora' : '';
                                    
                                    const citasHTML = citasEnHora.map(cita => {
                                        const fechaInicio = window.formatearFecha(obtenerInicio(cita));
                                        const horaInicio = fechaInicio ? fechaInicio.toLocaleTimeString('es-CR', { 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        }) : 'N/A';
                                        
                                        // Determinar emoji de turno
                                        const emojiTurno = obtenerTurnoEmoji(cita);
                                        
                                        const citaElement = document.createElement('div');
                                        citaElement.className = 'cita-item-dia';
                                        citaElement.setAttribute('data-cita-id', cita.id);
                                        citaElement.style.cursor = 'pointer';
                                        
                                        // Obtener nombre del cliente con validaci√≥n
                                        let clienteNombre = obtenerClienteNombre(cita);
                                        
                                        // Asegurar que sea string
                                        if (clienteNombre && typeof clienteNombre.then === 'function') {
                                            console.error('‚ùå [generarVistaDia] clienteNombre es una Promise!', cita.id);
                                            clienteNombre = 'Sin nombre';
                                        }
                                        clienteNombre = clienteNombre || 'Sin nombre';
                                        
                                        // Usar versi√≥n s√≠ncrona del indicador GPS para evitar [object Promise]
                                        const indicadorGPS = window.obtenerIndicadorGPSSync ? window.obtenerIndicadorGPSSync(cita) : '';
                                        
                                        // Obtener estado de la encuesta
                                        const estadoEncuesta = obtenerEstadoEncuesta(cita);
                                        let indicadorEncuesta = '';
                                        if (estadoEncuesta === 0) {
                                            // Sin link generado - rojo
                                            indicadorEncuesta = '<i class="fas fa-heart" style="color: #f44336; font-size: 14px; margin-left: 4px;" title="Encuesta no enviada"></i>';
                                        } else if (estadoEncuesta === 1) {
                                            // Link generado sin respuesta - amarillo
                                            indicadorEncuesta = '<i class="fas fa-heart" style="color: #ffc107; font-size: 14px; margin-left: 4px;" title="Encuesta enviada, esperando respuesta"></i>';
                                        } else if (estadoEncuesta === 2) {
                                            // Cliente respondi√≥ - verde
                                            indicadorEncuesta = '<i class="fas fa-heart" style="color: #4caf50; font-size: 14px; margin-left: 4px;" title="Cliente respondi√≥ la encuesta"></i>';
                                        } else if (estadoEncuesta === 3) {
                                            // Justificada sin encuesta - azul
                                            const justificacion = obtenerJustificacion(cita);
                                            const tituloJustificacion = justificacion ? `Justificada: ${justificacion.substring(0, 50)}${justificacion.length > 50 ? '...' : ''}` : 'Cita justificada sin encuesta';
                                            indicadorEncuesta = `<i class="fas fa-heart" style="color: #2196f3; font-size: 14px; margin-left: 4px;" title="${tituloJustificacion}"></i>`;
                                        }
                                        
                                        // Obtener datos para mostrar en las citas (usando datos existentes de los formularios)
                                        const metadata = cita.metadata || {};
                                        
                                        // Obtener vendedor
                                        const vendedores = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                                        const vendedorMostrar = vendedores && vendedores.length > 0 ? vendedores[0] : '';
                                        const vendedorTexto = vendedorMostrar || 'Sin vendedor';
                                        
                                        // Obtener hora
                                        const horaMostrar = horaInicio;
                                        
                                        // Obtener precio
                                        const precioMostrar = window.obtenerMonto && window.obtenerMonto(cita) ? window.formatearMontoVenta(window.obtenerMonto(cita)) : '';
                                        
                                        // Obtener ubicaci√≥n (Provincia, Cant√≥n, Distrito en ese orden)
                                        const ubicacionPartes = [];
                                        const provinciaId = metadata.provinciaId;
                                        const cantonId = metadata.cantonId;
                                        const distritoId = metadata.distritoId;
                                        
                                        // Convertir IDs a nombres usando ubicacionesCR - Orden: Provincia, Cant√≥n, Distrito
                                        if (window.ubicacionesCR && provinciaId && window.ubicacionesCR[provinciaId]) {
                                            ubicacionPartes.push(window.ubicacionesCR[provinciaId].nombre || '');
                                            
                                            if (cantonId && window.ubicacionesCR[provinciaId].cantones && window.ubicacionesCR[provinciaId].cantones[cantonId]) {
                                                ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].nombre || '');
                                                
                                                if (distritoId && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                                                    ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre || '');
                                                }
                                            }
                                        }
                                        const ubicacionTexto = ubicacionPartes.length > 0 ? ubicacionPartes.join(', ') : '';
                                        
                                        // Construir l√≠nea principal: Vendedor + Hora + Precio
                                        const infoPrincipal = [];
                                        if (vendedorTexto) infoPrincipal.push(vendedorTexto);
                                        if (horaMostrar) infoPrincipal.push(horaMostrar);
                                        if (precioMostrar) infoPrincipal.push(precioMostrar);
                                        const textoPrincipal = infoPrincipal.join(' ‚Ä¢ ');
                                        
                                        // Construir l√≠nea inferior: Ubicaci√≥n + Cliente
                                        const lineaInferior = [];
                                        if (ubicacionTexto) lineaInferior.push(ubicacionTexto);
                                        if (clienteNombre && clienteNombre !== 'Sin nombre') lineaInferior.push(clienteNombre);
                                        
                                        citaElement.innerHTML = `
                                            ${indicadorGPS}
                                            <div class="cita-duracion">${obtenerDuracion(cita)}min</div>
                                            <div class="cita-hora">${emojiTurno} ${textoPrincipal}${indicadorEncuesta}</div>
                                            ${lineaInferior.length > 0 ? `<div style="font-size: 0.7rem; line-height: 1.3; margin-top: 0.15rem; color: #ffffff;">${lineaInferior.join(' ‚Ä¢ ')}</div>` : ''}
                                            <div class="cita-descripcion">${obtenerDescripcion(cita)}</div>
                                            <div class="mt-2">
                                                <span class="cita-estado ${obtenerEstado(cita)}">${obtenerEstado(cita)}</span>
                                            </div>
                                        `;
                                        
                                        return citaElement.outerHTML;
                                    }).join('');
                                    
                                    // Si hay m√∫ltiples citas, envolver en contenedor flex
                                    return tieneMultiples 
                                        ? `<div class="${contenedorClase}">${citasHTML}</div>` 
                                        : citasHTML;
                                }).join('');
                            })() : `
                                <div class="sin-citas">
                                    <i class="fas fa-calendar-times"></i>
                                    <p>No hay citas programadas</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            // Si no hay citas para ninguna ruta, mostrar mensaje
            if (rutasOrdenadas.length === 0) {
                vehiculosGrid.innerHTML = `
                    <div class="col-12">
                        <div class="sin-citas">
                            <i class="fas fa-calendar-times"></i>
                            <h5>No hay citas programadas para este d√≠a</h5>
                            <p>Selecciona otro d√≠a o crea una nueva cita</p>
                        </div>
                    </div>
                `;
            }
        }

        // Variable para rastrear si los listeners ya est√°n agregados
        let dragAndDropInicializado = false;
        
        // Funci√≥n para inicializar drag and drop de citas
        function inicializarDragAndDrop() {
            // Si ya est√° inicializado, no hacer nada
            if (dragAndDropInicializado) {
                return;
            }
            
            // Usar event delegation para evitar problemas con listeners duplicados
            const cronogramaContainerDiurnas = document.getElementById('vehiculosCronogramaDiurnas');
            const cronogramaContainerNocturnas = document.getElementById('vehiculosCronogramaNocturnas');
            const cronogramaContainers = [cronogramaContainerDiurnas, cronogramaContainerNocturnas].filter(c => c);
            if (cronogramaContainers.length === 0) return;
            
            // Aplicar listeners a todos los contenedores
            cronogramaContainers.forEach(cronogramaContainer => {
            // Event delegation para dragstart en bloques de citas
            // Variable global para almacenar datos del arrastre (offset, mouse inicial, etc.)
            window.datosArrastreCita = null;
            
            cronogramaContainer.addEventListener('dragstart', (e) => {
                const citaBloque = e.target.closest('.cita-bloque[draggable="true"]');
                if (!citaBloque) return;
                
                // Guardar la posici√≥n actual del borde superior de la cita relativa al timeline
                const timeline = citaBloque.closest('.citas-timeline');
                if (timeline) {
                    const timelineRect = timeline.getBoundingClientRect();
                    const citaRect = citaBloque.getBoundingClientRect();
                    const topRelativoAlTimeline = citaRect.top - timelineRect.top;
                    e.dataTransfer.setData('topInicial', topRelativoAlTimeline.toString());
                }
                
                // Guardar tambi√©n el offset del mouse para referencia
                const rect = citaBloque.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', citaBloque.getAttribute('data-cita-id'));
                e.dataTransfer.setData('offsetY', offsetY.toString());
                
                // Guardar datos globales del arrastre para acceder en dragover (algunos navegadores no permiten getData)
                window.datosArrastreCita = {
                    offsetY,
                    mouseInicioY: e.clientY,
                    citaId: citaBloque.getAttribute('data-cita-id')
                };
                citaBloque.classList.add('dragging');
            }, true);
            
            // Event delegation para dragend
            cronogramaContainer.addEventListener('dragend', (e) => {
                const citaBloque = e.target.closest('.cita-bloque');
                if (citaBloque) {
                    citaBloque.classList.remove('dragging');
                }
                // Remover clases de drag-over de todos los timelines
                document.querySelectorAll('.citas-timeline').forEach(timeline => {
                    timeline.classList.remove('drag-over');
                });
                // Ocultar tooltip al terminar el arrastre
                if (tooltipHora) {
                    tooltipHora.style.display = 'none';
                }
                // Limpiar datos globales del arrastre
                window.datosArrastreCita = null;
            }, true);
            
            // Crear tooltip flotante para mostrar la hora
            let tooltipHora = null;
            
            // Event delegation para dragover en timelines
            cronogramaContainer.addEventListener('dragover', (e) => {
                const timeline = e.target.closest('.citas-timeline');
                if (!timeline) {
                    // Si salimos del timeline, ocultar tooltip
                    if (tooltipHora) {
                        tooltipHora.style.display = 'none';
                    }
                    return;
                }
                
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                timeline.classList.add('drag-over');
                
                // Calcular la hora basada en la posici√≥n del borde superior de la cita (no del mouse)
                // USAR EXACTAMENTE LA MISMA L√ìGICA QUE EN EL EVENTO DROP
                const rect = timeline.getBoundingClientRect();
                const yMouse = e.clientY - rect.top;
                const offsetY = (window.datosArrastreCita && typeof window.datosArrastreCita.offsetY === 'number')
                    ? window.datosArrastreCita.offsetY
                    : (parseFloat(e.dataTransfer.getData('offsetY')) || 0);
                
                // Calcular d√≥nde quedar√≠a el borde superior de la cita
                // Restamos el offset para obtener la posici√≥n del inicio de la cita
                const yInicioCita = Math.max(0, yMouse - offsetY);
                
                // Detectar si estamos en vista compacta
                const btnToggle = document.getElementById('btnToggleVistaCompacta');
                const estaCompacta = btnToggle && btnToggle.classList.contains('active');
                
                // Determinar a qu√© secci√≥n pertenece este timeline (diurnas o nocturnas) - IGUAL QUE EN DROP
                const contenedorPadre = timeline.closest('#vehiculosCronogramaDiurnas, #vehiculosCronogramaNocturnas');
                const esDiurnas = contenedorPadre && contenedorPadre.id === 'vehiculosCronogramaDiurnas';
                
                // Obtener el offset de inicio del timeline visible - IGUAL QUE EN DROP
                let offsetInicioTimeline = 0; // En vista total, empieza en 5 AM (0 minutos desde 5 AM)
                
                if (estaCompacta && window.rangosHoras) {
                    // En vista compacta, el timeline visible puede empezar en una hora diferente
                    const rango = esDiurnas ? window.rangosHoras.diurnas : window.rangosHoras.nocturnas;
                    if (rango && rango.inicio !== null) {
                        // El offset es cu√°ntos minutos desde las 5 AM empieza el timeline visible
                        offsetInicioTimeline = rango.inicio;
                    }
                }
                
                // Calcular minutos desde el inicio del timeline visible - IGUAL QUE EN DROP
                // En vista total: yInicioCita = 0px corresponde a 5 AM (0 minutos desde 5 AM)
                // En vista compacta: yInicioCita = 0px corresponde a minutosInicioConMargen
                const minutosDesdeInicioTimeline = (yInicioCita / 33) * 60;
                
                // Convertir a minutos desde las 5 AM (sumando el offset del inicio del timeline) - IGUAL QUE EN DROP
                const minutosDesde5AM = Math.max(0, Math.min(1439, minutosDesdeInicioTimeline + offsetInicioTimeline));
                
                // Redondear al intervalo de 15 minutos m√°s cercano - IGUAL QUE EN DROP
                // Esto asegura que la hora de inicio sea exactamente 00, 15, 30, o 45 minutos
                const minutosRedondeadosDesde5AM = Math.round(minutosDesde5AM / 15) * 15;
                
                // Convertir minutos desde 5 AM a minutos desde medianoche reales - IGUAL QUE EN DROP
                // Si minutosDesde5AM < 1140 (19 horas), es del d√≠a actual (5 AM - 11:59 PM)
                // Si minutosDesde5AM >= 1140, es del d√≠a siguiente (12 AM - 4:59 AM)
                let minutosDesdeMedianoche;
                if (minutosRedondeadosDesde5AM < 1140) {
                    // Hora entre 5:00 AM y 11:59 PM del d√≠a actual
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM + (5 * 60); // Sumar 5 horas
                } else {
                    // Hora entre 12:00 AM y 4:59 AM del d√≠a siguiente
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM - 1140; // Restar 19 horas (0-300 minutos)
                }
                
                // Calcular hora y minuto (ya redondeados a intervalos de 15 minutos) - IGUAL QUE EN DROP
                const nuevaHora = Math.floor(minutosDesdeMedianoche / 60);
                const nuevoMinuto = minutosDesdeMedianoche % 60;
                
                // Asegurar que el minuto est√© en intervalos de 15 (0, 15, 30, 45) - IGUAL QUE EN DROP
                const minutoRedondeado = Math.round(nuevoMinuto / 15) * 15;
                
                // Formatear hora para mostrar - IGUAL QUE EN DROP
                const hora12 = nuevaHora === 0 ? 12 : nuevaHora > 12 ? nuevaHora - 12 : nuevaHora;
                const ampm = nuevaHora < 12 ? 'AM' : 'PM';
                const horaFormateada = `${hora12}:${minutoRedondeado.toString().padStart(2, '0')} ${ampm}`;
                
                // Crear o actualizar tooltip
                if (!tooltipHora) {
                    tooltipHora = document.createElement('div');
                    tooltipHora.id = 'tooltip-hora-cita';
                    document.body.appendChild(tooltipHora);
                }
                
                // Aplicar estilos con !important para asegurar que est√© al frente
                tooltipHora.style.cssText = 'position: fixed !important; background: rgba(0, 0, 0, 0.95) !important; color: white !important; padding: 6px 10px !important; border-radius: 6px !important; font-size: 0.75rem !important; font-weight: 600 !important; pointer-events: none !important; z-index: 9999999 !important; box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important; white-space: nowrap !important;';
                
                tooltipHora.textContent = horaFormateada;
                tooltipHora.style.display = 'block';
                
                // Posicionar el tooltip cerca del borde superior de la cita, no del mouse
                const yInicioCitaAbsoluto = rect.top + yInicioCita;
                tooltipHora.style.left = (rect.left + 10) + 'px';
                tooltipHora.style.top = (yInicioCitaAbsoluto - 35) + 'px';
            }, true);
            
            // Event delegation para dragleave
            cronogramaContainer.addEventListener('dragleave', (e) => {
                const timeline = e.target.closest('.citas-timeline');
                if (timeline) {
                    timeline.classList.remove('drag-over');
                }
                // Ocultar tooltip al salir del timeline
                if (tooltipHora) {
                    tooltipHora.style.display = 'none';
                }
            }, true);
            
            // Event delegation para drop
            cronogramaContainer.addEventListener('drop', async (e) => {
                const timeline = e.target.closest('.citas-timeline');
                if (!timeline) return;
                
                e.preventDefault();
                timeline.classList.remove('drag-over');
                
                // Ocultar tooltip al soltar
                if (tooltipHora) {
                    tooltipHora.style.display = 'none';
                }
                
                const citaId = e.dataTransfer.getData('text/plain');
                if (!citaId) return;
                
                // Obtener la posici√≥n Y relativa al timeline
                const rect = timeline.getBoundingClientRect();
                const yMouse = e.clientY - rect.top;
                
                // Obtener el offset del mouse dentro de la cita (desde dragstart)
                const offsetY = parseFloat(e.dataTransfer.getData('offsetY')) || 0;
                
                // Calcular d√≥nde quedar√≠a el borde superior de la cita
                // Restamos el offset para obtener la posici√≥n del inicio de la cita
                const yInicioCita = Math.max(0, yMouse - offsetY);
                
                // Detectar si estamos en vista compacta
                const btnToggle = document.getElementById('btnToggleVistaCompacta');
                const estaCompacta = btnToggle && btnToggle.classList.contains('active');
                
                // Determinar a qu√© secci√≥n pertenece este timeline (diurnas o nocturnas)
                const contenedorPadre = timeline.closest('#vehiculosCronogramaDiurnas, #vehiculosCronogramaNocturnas');
                const esDiurnas = contenedorPadre && contenedorPadre.id === 'vehiculosCronogramaDiurnas';
                
                // Obtener el offset de inicio del timeline visible
                let offsetInicioTimeline = 0; // En vista total, empieza en 5 AM (0 minutos desde 5 AM)
                
                if (estaCompacta && window.rangosHoras) {
                    // En vista compacta, el timeline visible puede empezar en una hora diferente
                    const rango = esDiurnas ? window.rangosHoras.diurnas : window.rangosHoras.nocturnas;
                    if (rango && rango.inicio !== null) {
                        // El offset es cu√°ntos minutos desde las 5 AM empieza el timeline visible
                        offsetInicioTimeline = rango.inicio;
                    }
                }
                
                // Calcular minutos desde el inicio del timeline visible
                // En vista total: yInicioCita = 0px corresponde a 5 AM (0 minutos desde 5 AM)
                // En vista compacta: yInicioCita = 0px corresponde a minutosInicioConMargen
                const minutosDesdeInicioTimeline = (yInicioCita / 33) * 60;
                
                // Convertir a minutos desde las 5 AM (sumando el offset del inicio del timeline)
                const minutosDesde5AM = Math.max(0, Math.min(1439, minutosDesdeInicioTimeline + offsetInicioTimeline));
                
                // Redondear al intervalo de 15 minutos m√°s cercano
                // Esto asegura que la hora de inicio sea exactamente 00, 15, 30, o 45 minutos
                const minutosRedondeadosDesde5AM = Math.round(minutosDesde5AM / 15) * 15;
                
                // Convertir minutos desde 5 AM a minutos desde medianoche reales
                // Si minutosDesde5AM < 1140 (19 horas), es del d√≠a actual (5 AM - 11:59 PM)
                // Si minutosDesde5AM >= 1140, es del d√≠a siguiente (12 AM - 4:59 AM)
                let minutosDesdeMedianoche;
                let diaOffset = 0; // D√≠as a agregar (0 = mismo d√≠a, 1 = d√≠a siguiente)
                
                if (minutosRedondeadosDesde5AM < 1140) {
                    // Hora entre 5:00 AM y 11:59 PM del d√≠a actual
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM + (5 * 60); // Sumar 5 horas
                    diaOffset = 0;
                } else {
                    // Hora entre 12:00 AM y 4:59 AM del d√≠a siguiente
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM - 1140; // Restar 19 horas (0-300 minutos)
                    diaOffset = 1;
                }
                
                // Calcular hora y minuto (ya redondeados a intervalos de 15 minutos)
                const nuevaHora = Math.floor(minutosDesdeMedianoche / 60);
                const nuevoMinuto = minutosDesdeMedianoche % 60;
                
                // Asegurar que el minuto est√© en intervalos de 15 (0, 15, 30, 45)
                const minutoRedondeado = Math.round(nuevoMinuto / 15) * 15;
                
                // Obtener la ruta destino
                const rutaDestino = timeline.getAttribute('data-ruta');
                
                // Obtener la cita original
                const citaOriginal = window.citasFiltradas.find(c => c.id === citaId);
                if (!citaOriginal) return;
                
                // Obtener la fecha del d√≠a seleccionado (no la fecha original de la cita)
                // Esto asegura que las citas que se mueven al d√≠a siguiente sigan apareciendo
                // en el cronograma del d√≠a laborable actual
                const year = diaSeleccionado.getFullYear();
                const month = diaSeleccionado.getMonth();
                const day = diaSeleccionado.getDate();
                
                // Crear nueva fecha basada en el d√≠a seleccionado, no en la fecha original de la cita
                // Si diaOffset = 1, es del d√≠a siguiente (pero sigue siendo parte del d√≠a laborable del d√≠a seleccionado)
                const nuevaFecha = new Date(year, month, day + diaOffset, nuevaHora, minutoRedondeado, 0, 0);
                
                console.log('üîç Moviendo cita:', {
                    diaSeleccionado: `${year}-${month + 1}-${day}`,
                    diaOffset,
                    nuevaHora,
                    minutoRedondeado,
                    nuevaFecha: nuevaFecha.toISOString(),
                    nuevaFechaLocal: nuevaFecha.toString()
                });
                
                // Convertir a Timestamp (Firestore almacena en UTC)
                // Timestamp.fromDate() convierte la fecha local a UTC autom√°ticamente
                const timestampGMT6 = Timestamp.fromDate(nuevaFecha);
                
                try {
                    // Actualizar la cita en Firestore
                    const citaRef = doc(window.db, 'citas', citaId);
                    const citaActual = window.citasFiltradas.find(c => c.id === citaId);
                    
                    // Obtener metadata actual o crear nueva
                    const metadataActual = citaActual?.metadata || {};
                        const nuevaMetadata = {
                            ...metadataActual,
                            ruta: rutaDestino
                        };
                    
                    // Obtener duraci√≥n actual de la cita y redondearla a 15 minutos
                    const duracionActual = obtenerDuracion(citaActual);
                    const duracionRedondeada = Math.max(15, Math.round(duracionActual / 15) * 15); // M√≠nimo 15 minutos, redondeado a 15
                    
                    await updateDoc(citaRef, {
                        inicio_gmt6: timestampGMT6,
                        duracion_minutos: duracionRedondeada,
                        metadata: nuevaMetadata
                    });
                    
                    console.log('‚úÖ Cita actualizada, recargando cronograma...');
                    
                    // Recargar datos y regenerar cronograma
                    await cargarDatos();
                    if (vistaActual === 'cronograma') {
                        await generarCronograma();
                    }
                } catch (error) {
                    console.error('Error actualizando cita:', error);
                    alert('Error al mover la cita: ' + error.message);
                }
            }, true);
            }); // Cerrar forEach de contenedores
            
            dragAndDropInicializado = true;
        }

        // Funci√≥n para inicializar arrastre para crear citas en el cronograma
        function inicializarArrastreCrearCitas(fecha) {
            console.log('üéØ Inicializando arrastre para crear citas en cronograma', { fecha });
            
            // Obtener todos los timelines del cronograma
            const timelines = document.querySelectorAll('.citas-timeline');
            
            timelines.forEach(timeline => {
                const ruta = timeline.getAttribute('data-ruta');
                if (!ruta) return;
                
                // Variables para el arrastre
                let isDragging = false;
                let dragStartY = 0;
                let dragEndY = 0;
                let dragPreview = null;
                
                // Handlers globales
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    
                    const rect = timeline.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    dragEndY = Math.max(0, Math.min(y, timeline.offsetHeight));
                    
                    actualizarDragPreview();
                    e.preventDefault();
                };
                
                const handleMouseUp = (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    // Remover listeners globales
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    
                    const alturaTimeline = timeline.offsetHeight;
                    const alturaMinima = 20;
                    const alturaArrastrada = Math.abs(dragEndY - dragStartY);
                    
                    if (alturaArrastrada < alturaMinima) {
                        if (dragPreview) {
                            dragPreview.remove();
                            dragPreview = null;
                        }
                        return;
                    }
                    
                    // Calcular hora basada en posici√≥n Y (usando la misma l√≥gica que en drag-and-drop de citas existentes)
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    
                    // Detectar si estamos en vista compacta
                    const btnToggle = document.getElementById('btnToggleVistaCompacta');
                    const estaCompacta = btnToggle && btnToggle.classList.contains('active');
                    
                    // Determinar a qu√© secci√≥n pertenece este timeline (diurnas o nocturnas)
                    const contenedorPadre = timeline.closest('#vehiculosCronogramaDiurnas, #vehiculosCronogramaNocturnas');
                    const esDiurnas = contenedorPadre && contenedorPadre.id === 'vehiculosCronogramaDiurnas';
                    
                    // Obtener el offset de inicio del timeline visible
                    let offsetInicioTimeline = 0; // En vista total, empieza en 5 AM (0 minutos desde 5 AM)
                    
                    if (estaCompacta && window.rangosHoras) {
                        // En vista compacta, el timeline visible puede empezar en una hora diferente
                        const rango = esDiurnas ? window.rangosHoras.diurnas : window.rangosHoras.nocturnas;
                        if (rango && rango.inicio !== null) {
                            // El offset es cu√°ntos minutos desde las 5 AM empieza el timeline visible
                            offsetInicioTimeline = rango.inicio;
                        }
                    }
                    
                    // Calcular minutos desde el inicio del timeline visible
                    // En vista total: inicioY = 0px corresponde a 5 AM (0 minutos desde 5 AM)
                    // En vista compacta: inicioY = 0px corresponde a minutosInicioConMargen
                    const minutosDesdeInicioTimeline = (inicioY / 33) * 60;
                    
                    // Convertir a minutos desde las 5 AM (sumando el offset del inicio del timeline)
                    const minutosDesde5AM = Math.max(0, Math.min(1439, minutosDesdeInicioTimeline + offsetInicioTimeline));
                    
                    // Redondear al intervalo de 15 minutos m√°s cercano
                    const minutosRedondeadosDesde5AM = Math.round(minutosDesde5AM / 15) * 15;
                    
                    // Convertir minutos desde 5 AM a minutos desde medianoche reales
                    // Si minutosDesde5AM < 1140 (19 horas), es del d√≠a actual (5 AM - 11:59 PM)
                    // Si minutosDesde5AM >= 1140, es del d√≠a siguiente (12 AM - 4:59 AM)
                    let minutosDesdeMedianoche;
                    let diaOffset = 0; // D√≠as a agregar (0 = mismo d√≠a, 1 = d√≠a siguiente)
                    
                    if (minutosRedondeadosDesde5AM < 1140) {
                        // Hora entre 5:00 AM y 11:59 PM del d√≠a actual
                        minutosDesdeMedianoche = minutosRedondeadosDesde5AM + (5 * 60); // Sumar 5 horas
                        diaOffset = 0;
                    } else {
                        // Hora entre 12:00 AM y 4:59 AM del d√≠a siguiente
                        minutosDesdeMedianoche = minutosRedondeadosDesde5AM - 1140; // Restar 19 horas (0-300 minutos)
                        diaOffset = 1;
                    }
                    
                    // Calcular hora y minuto (ya redondeados a intervalos de 15 minutos)
                    const horaRealInicio = Math.floor(minutosDesdeMedianoche / 60);
                    const minutosInicio = minutosDesdeMedianoche % 60;
                    const minutosRedondeadosInicio = Math.round(minutosInicio / 15) * 15;
                    
                    // Calcular duraci√≥n basada en finY
                    const minutosDesdeInicioTimelineFin = (finY / 33) * 60;
                    const minutosDesde5AMFin = Math.max(0, Math.min(1439, minutosDesdeInicioTimelineFin + offsetInicioTimeline));
                    const minutosRedondeadosDesde5AMFin = Math.round(minutosDesde5AMFin / 15) * 15;
                    const duracionMinutos = Math.max(15, minutosRedondeadosDesde5AMFin - minutosRedondeadosDesde5AM);
                    const duracionRedondeada = Math.max(15, Math.round(duracionMinutos / 15) * 15);
                    
                    // Obtener fecha del d√≠a seleccionado
                    const year = diaSeleccionado.getFullYear();
                    const month = diaSeleccionado.getMonth();
                    const day = diaSeleccionado.getDate();
                    
                    // Crear fecha con la hora calculada (en hora local)
                    const fechaInicio = new Date(year, month, day + diaOffset, horaRealInicio, minutosRedondeadosInicio, 0, 0);
                    
                    // Formatear para datetime-local en hora local (no UTC)
                    const yearFormatted = fechaInicio.getFullYear();
                    const monthFormatted = String(fechaInicio.getMonth() + 1).padStart(2, '0');
                    const dayFormatted = String(fechaInicio.getDate()).padStart(2, '0');
                    const hoursFormatted = String(fechaInicio.getHours()).padStart(2, '0');
                    const minutesFormatted = String(fechaInicio.getMinutes()).padStart(2, '0');
                    const fechaFormateada = `${yearFormatted}-${monthFormatted}-${dayFormatted}T${hoursFormatted}:${minutesFormatted}`;
                    
                    console.log('‚úÖ Abriendo modal desde cronograma', {
                        fechaFormateada,
                        duracionRedondeada,
                        ruta,
                        hora: `${horaRealInicio}:${minutosRedondeadosInicio.toString().padStart(2, '0')}`
                    });
                    
                    // Limpiar preview
                    if (dragPreview) {
                        dragPreview.remove();
                        dragPreview = null;
                    }
                    
                    // Abrir modal con ruta prellenada
                    abrirModalNuevaCitaDesdeArrastreCronograma(fechaFormateada, duracionRedondeada, ruta);
                    
                    e.preventDefault();
                };
                
                // Event listener para mousedown
                timeline.addEventListener('mousedown', (e) => {
                    // Solo iniciar si no se hace click en una cita existente
                    if (e.target.closest('.cita-bloque')) {
                        return;
                    }
                    
                    console.log('üñ±Ô∏è [CRONOGRAMA] Iniciando arrastre en timeline', { ruta, offsetY: e.offsetY });
                    
                    isDragging = true;
                    dragStartY = e.offsetY;
                    dragEndY = e.offsetY;
                    
                    // Crear preview
                    dragPreview = document.createElement('div');
                    dragPreview.className = 'drag-preview';
                    dragPreview.style.position = 'absolute';
                    dragPreview.style.left = '0';
                    dragPreview.style.right = '0';
                    dragPreview.style.backgroundColor = 'rgba(102, 126, 234, 0.3)';
                    dragPreview.style.border = '2px dashed #667eea';
                    dragPreview.style.borderRadius = '4px';
                    dragPreview.style.pointerEvents = 'none';
                    dragPreview.style.zIndex = '1000';
                    timeline.appendChild(dragPreview);
                    
                    actualizarDragPreview();
                    
                    // Agregar listeners globales
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    
                    e.stopPropagation();
                    e.preventDefault();
                }, true);
                
                function actualizarDragPreview() {
                    if (!dragPreview) return;
                    
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    const altura = finY - inicioY;
                    
                    dragPreview.style.top = `${inicioY}px`;
                    dragPreview.style.height = `${Math.max(altura, 20)}px`;
                }
            });
            
            console.log('‚úÖ Arrastre para crear citas inicializado en', timelines.length, 'timelines');
        }

        // Funci√≥n para obtener el lunes de la semana de una fecha
        function obtenerLunesSemana(fecha) {
            const fechaCopia = new Date(fecha);
            const dia = fechaCopia.getDay();
            const diff = fechaCopia.getDate() - dia + (dia === 0 ? -6 : 1); // Ajustar para que lunes sea 0
            return new Date(fechaCopia.setDate(diff));
        }
        
        // Funci√≥n para obtener los d√≠as de la semana (lunes a domingo)
        function obtenerDiasSemana(fecha) {
            const lunes = obtenerLunesSemana(fecha);
            const dias = [];
            for (let i = 0; i < 7; i++) {
                const dia = new Date(lunes);
                dia.setDate(lunes.getDate() + i);
                dias.push(dia);
            }
            return dias;
        }
        
        // Funci√≥n para generar cronograma
        async function generarCronograma() {
            // Verificar si estamos en vista compacta
            const btnToggle = document.getElementById('btnToggleVistaCompacta');
            const estaEnVistaCompacta = btnToggle && !btnToggle.classList.contains('active');
            
            // Si est√° en vista compacta, usar la semana actual; si no, usar el d√≠a seleccionado
            let diasAMostrar = [];
            if (estaEnVistaCompacta) {
                // Inicializar semanaActual si no est√° definida
                if (!semanaActual) {
                    semanaActual = obtenerLunesSemana(new Date());
                }
                diasAMostrar = obtenerDiasSemana(semanaActual);
                
                // Mostrar navegaci√≥n de semana
                const navegacionSemana = document.getElementById('navegacionSemana');
                if (navegacionSemana) {
                    navegacionSemana.style.display = 'flex';
                }
                
                // Actualizar rango de semana
                const rangoSemana = document.getElementById('rangoSemana');
                if (rangoSemana) {
                    const lunes = diasAMostrar[0];
                    const domingo = diasAMostrar[6];
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    rangoSemana.textContent = `${lunes.getDate()} ${monthNames[lunes.getMonth()]} - ${domingo.getDate()} ${monthNames[domingo.getMonth()]}`;
                }
            } else {
                // Vista total: solo el d√≠a seleccionado
                diasAMostrar = [diaSeleccionado];
                
                // Ocultar navegaci√≥n de semana
                const navegacionSemana = document.getElementById('navegacionSemana');
                if (navegacionSemana) {
                    navegacionSemana.style.display = 'none';
                }
            }
            
            const year = diaSeleccionado.getFullYear();
            const month = diaSeleccionado.getMonth();
            const day = diaSeleccionado.getDate();
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const dayNames = [
                'Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'
            ];
            
            // T√≠tulo del cronograma eliminado (ya no se muestra)

            // Generar ejes de horas para cada secci√≥n por separado
            const ejeHorasDiurnas = document.getElementById('ejeHorasDiurnas');
            const ejeHorasNocturnas = document.getElementById('ejeHorasNocturnas');
            
            // Funci√≥n para generar marcadores de hora en el eje
            const generarMarcadoresHora = () => {
                let html = '';
                for (let hora = 0; hora < 24; hora++) {
                    const top = hora * 33; // Posici√≥n desde el inicio (33px por hora)
                    const horaFormateada = hora === 0 ? '12:00 AM' : 
                                         hora < 12 ? `${hora}:00 AM` : 
                                         hora === 12 ? '12:00 PM' : 
                                         `${hora - 12}:00 PM`;
                    html += `
                        <div class="marcador-hora-timeline" style="top: ${top}px; position: absolute; left: 0; width: 100%; height: 33px;">
                            <span class="marcador-hora-timeline-label" style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: #000000; font-weight: 700;">${horaFormateada}</span>
                        </div>
                    `;
                }
                return html;
            };
            
            // Ocultar ejes externos, usar marcadores internos en "Sin asignar"
            if (ejeHorasDiurnas) {
                ejeHorasDiurnas.style.display = 'none';
            }
            if (ejeHorasNocturnas) {
                ejeHorasNocturnas.style.display = 'none';
            }

            // Obtener citas para todos los d√≠as a mostrar
            const citasPorDia = {};
            
            diasAMostrar.forEach(fechaDia => {
                const yearDia = fechaDia.getFullYear();
                const monthDia = fechaDia.getMonth();
                const dayDia = fechaDia.getDate();
                
                // Obtener citas del d√≠a laborable (5 AM del d√≠a hasta 4:59 AM del d√≠a siguiente)
                const fechaInicioDiaLaborable = new Date(yearDia, monthDia, dayDia, 5, 0, 0);
                const fechaFinDiaLaborable = new Date(yearDia, monthDia, dayDia + 1, 4, 59, 59);
                
                const citasDelDia = citasFiltradas.filter(cita => {
                    const fechaCita = window.formatearFecha(obtenerInicio(cita));
                    if (!fechaCita) return false;
                    
                    // Incluir citas que empiecen o terminen en el rango del d√≠a laborable
                    const duracion = obtenerDuracion(cita);
                    const fechaFinCita = new Date(fechaCita.getTime() + duracion * 60000);
                    
                    // Verificar si la cita se superpone con el rango del d√≠a laborable
                    const estaEnRango = (fechaCita >= fechaInicioDiaLaborable && fechaCita <= fechaFinDiaLaborable) ||
                                       (fechaFinCita >= fechaInicioDiaLaborable && fechaFinCita <= fechaFinDiaLaborable) ||
                                       (fechaCita <= fechaInicioDiaLaborable && fechaFinCita >= fechaFinDiaLaborable);
                    
                    return estaEnRango;
                });
                
                citasPorDia[`${yearDia}-${monthDia + 1}-${dayDia}`] = citasDelDia;
            });
            
            console.log('üîç Filtro de citas:', {
                diasAMostrar: diasAMostrar.length,
                citasPorDia: Object.keys(citasPorDia).map(key => ({ dia: key, cantidad: citasPorDia[key].length })),
                totalCitasFiltradas: citasFiltradas.length
            });

            // Lista completa de rutas disponibles + "Sin asignar"
            const rutasDisponibles = [
                'Sin asignar',
                'Ruta 1', 'Ruta 2', 'Ruta 3', 'Ruta 4', 'Ruta 5', 
                'Ruta 6', 'Ruta 7', 'Ruta 8', 'Ruta 9', 'Ruta 10',
                'Ruta 11', 'Ruta 12', 'Ruta 13', 'Ruta 14', 'Ruta 15',
                'Ruta 16', 'Ruta 17', 'Ruta 18', 'Ruta 19', 'Ruta 20'
            ];

            // Agrupar citas por d√≠a y por ruta
            const citasPorDiaYRuta = {};
            
            diasAMostrar.forEach(fechaDia => {
                const yearDia = fechaDia.getFullYear();
                const monthDia = fechaDia.getMonth();
                const dayDia = fechaDia.getDate();
                const keyDia = `${yearDia}-${monthDia + 1}-${dayDia}`;
                const citasDelDia = citasPorDia[keyDia] || [];
                
                citasPorDiaYRuta[keyDia] = {};
                rutasDisponibles.forEach(ruta => {
                    citasPorDiaYRuta[keyDia][ruta] = [];
                });
                
                citasDelDia.forEach(cita => {
                    const ruta = obtenerRuta(cita);
                    if (citasPorDiaYRuta[keyDia][ruta]) {
                        citasPorDiaYRuta[keyDia][ruta].push(cita);
                    } else {
                        citasPorDiaYRuta[keyDia]['Sin asignar'].push(cita);
                    }
                });
            });

            // Ordenar rutas: "Sin asignar" primero, luego rutas num√©ricamente
            const rutasOrdenadas = rutasDisponibles.sort((a, b) => {
                if (a === 'Sin asignar') return -1;
                if (b === 'Sin asignar') return 1;
                // Extraer n√∫meros de "Ruta X" y comparar
                const numA = parseInt(a.replace('Ruta ', '')) || 0;
                const numB = parseInt(b.replace('Ruta ', '')) || 0;
                return numA - numB;
            });

            // Cargar datos de ruteador para todas las rutas y d√≠as
            const datosRuteadorMap = {};
            
            if (estaEnVistaCompacta) {
                // Vista compacta: cargar datos para todos los d√≠as de la semana
                const promesasRuteador = [];
                diasAMostrar.forEach(fechaDia => {
                    const yearDia = fechaDia.getFullYear();
                    const monthDia = fechaDia.getMonth();
                    const dayDia = fechaDia.getDate();
                    const fechaFormateadaDia = `${yearDia}-${String(monthDia + 1).padStart(2, '0')}-${String(dayDia).padStart(2, '0')}`;
                    
                    rutasOrdenadas.forEach(ruta => {
                        promesasRuteador.push(
                            cargarRuteador(fechaFormateadaDia, ruta).then(datos => ({
                                fecha: fechaFormateadaDia,
                                ruta: ruta,
                                datos: datos
                            }))
                        );
                    });
                });
                
                const resultadosRuteador = await Promise.all(promesasRuteador);
                resultadosRuteador.forEach(({ fecha, ruta, datos }) => {
                    const key = `${fecha}_${ruta}`;
                    datosRuteadorMap[key] = datos;
                });
            } else {
                // Vista total: cargar datos solo para el d√≠a seleccionado
                const fechaFormateada = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const datosRuteadorPromesas = rutasOrdenadas.map(async ruta => {
                    const datos = await cargarRuteador(fechaFormateada, ruta);
                    return { ruta, datos };
                });
                
                const datosRuteadorArray = await Promise.all(datosRuteadorPromesas);
                datosRuteadorArray.forEach(({ ruta, datos }) => {
                    datosRuteadorMap[ruta] = datos;
                });
            }
            
            // Definir fechaFormateada para usar en renderizarRecursosSinAsignar
            // En vista compacta, usar el primer d√≠a de la semana; en vista total, usar el d√≠a seleccionado
            let fechaFormateada;
            if (estaEnVistaCompacta && semanaActual) {
                const lunes = obtenerLunesSemana(semanaActual);
                fechaFormateada = `${lunes.getFullYear()}-${String(lunes.getMonth() + 1).padStart(2, '0')}-${String(lunes.getDate()).padStart(2, '0')}`;
            } else {
                fechaFormateada = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            
            // Crear citasPorRuta para la vista total (compatibilidad)
            const citasPorRuta = {};
            if (!estaEnVistaCompacta) {
                const keyDia = `${year}-${month + 1}-${day}`;
                rutasDisponibles.forEach(ruta => {
                    citasPorRuta[ruta] = citasPorDiaYRuta[keyDia]?.[ruta] || [];
                });
            }
            
            // Recolectar todos los veh√≠culos y t√©cnicos disponibles para saber cu√°les no est√°n asignados
            const todosLosVehiculos = ['APV 01', 'APV 02', 'APV 03', 'APV 04', 'APV 05', 
                                       'APV 06', 'APV 07', 'APV 08', 'Kangoo', 'Yaris', 'Prado', 'Rojo'];
            
            // Separar rutas en diurnas (1-10) y nocturnas/especiales (11-20)
            const rutasDiurnas = ['Sin asignar', ...rutasOrdenadas.filter(r => {
                if (r === 'Sin asignar') return false;
                const num = parseInt(r.replace('Ruta ', '')) || 0;
                return num >= 1 && num <= 10;
            })];
            
            const rutasNocturnas = ['Sin asignar', ...rutasOrdenadas.filter(r => {
                if (r === 'Sin asignar') return false;
                const num = parseInt(r.replace('Ruta ', '')) || 0;
                return num >= 11 && num <= 20;
            })];
            
            // Obtener veh√≠culos y t√©cnicos asignados en todas las rutas (excepto "Sin asignar")
            const vehiculosAsignados = new Set();
            const tecnicosAsignados = new Set();
            
            if (estaEnVistaCompacta) {
                // Vista compacta: buscar en datosRuteadorMap con formato ${fecha}_${ruta}
                diasAMostrar.forEach(fechaDia => {
                    const yearDia = fechaDia.getFullYear();
                    const monthDia = fechaDia.getMonth();
                    const dayDia = fechaDia.getDate();
                    const fechaFormateadaDia = `${yearDia}-${String(monthDia + 1).padStart(2, '0')}-${String(dayDia).padStart(2, '0')}`;
                    
                    [...rutasDiurnas, ...rutasNocturnas].forEach(r => {
                        if (r !== 'Sin asignar') {
                            const key = `${fechaFormateadaDia}_${r}`;
                            const datos = datosRuteadorMap[key] || { tecnicos: [], vehiculos: [] };
                            // Normalizar veh√≠culos antes de agregarlos al Set (trim y convertir a string)
                            datos.vehiculos.forEach(v => {
                                const vNormalizado = v ? String(v).trim() : '';
                                if (vNormalizado) {
                                    vehiculosAsignados.add(vNormalizado);
                                }
                            });
                            datos.tecnicos.forEach(t => tecnicosAsignados.add(t));
                        }
                    });
                });
            } else {
                // Vista total: buscar en datosRuteadorMap con formato ${ruta}
                [...rutasDiurnas, ...rutasNocturnas].forEach(r => {
                    if (r !== 'Sin asignar') {
                        const datos = datosRuteadorMap[r] || { tecnicos: [], vehiculos: [] };
                        // Normalizar veh√≠culos antes de agregarlos al Set (trim y convertir a string)
                        datos.vehiculos.forEach(v => {
                            const vNormalizado = v ? String(v).trim() : '';
                            if (vNormalizado) {
                                vehiculosAsignados.add(vNormalizado);
                            }
                        });
                        datos.tecnicos.forEach(t => tecnicosAsignados.add(t));
                    }
                });
            }
            
            // Calcular veh√≠culos y t√©cnicos sin asignar
            // Normalizar tambi√©n los veh√≠culos de la lista hardcodeada para comparar correctamente
            const vehiculosSinAsignar = todosLosVehiculos.filter(v => {
                const vNormalizado = String(v).trim();
                return !vehiculosAsignados.has(vNormalizado);
            });
            const tecnicosSinAsignar = (window.empleados || [])
                .filter(e => {
                    // IMPORTANTE: Usar username como identificador principal, id como fallback
                    const username = e.username || e.id;
                    if (!username || String(username).trim() === '') {
                        return false;
                    }
                    return !tecnicosAsignados.has(username);
                })
                .map(e => {
                    // IMPORTANTE: Usar username como identificador principal, id como fallback
                    // NO usar el nombre como username
                    const username = e.username || e.id;
                    if (!username || String(username).trim() === '') {
                        return null;
                    }
                    
                    // Generar el nombre formateado para mostrar (solo para visualizaci√≥n)
                    const primerNombre = (e.primerNombre || '').trim();
                    const primerApellido = (e.primerApellido || '').trim();
                    const inicialApellido = primerApellido ? primerApellido.charAt(0).toUpperCase() + '.' : '';
                    const nombreFormateado = `${primerNombre} ${inicialApellido}`.trim() || username;
                    
                    return {
                        username: username, // SIEMPRE usar el username real del empleado, NO el nombre
                        id: e.id,
                        nombre: nombreFormateado, // El nombre es solo para mostrar en la UI
                        departamento: e.departamento || '' // Departamento del empleado para ordenamiento
                    };
                })
                .filter(t => t !== null && t.username && String(t.username).trim() !== '') // Filtrar nulos y sin username
                .sort((a, b) => {
                    // Ordenar: empleados de Fumigaci√≥n primero, luego el resto
                    const depA = (a.departamento || '').trim().toLowerCase();
                    const depB = (b.departamento || '').trim().toLowerCase();
                    const esFumigacionA = depA === 'fumigaci√≥n' || depA === 'fumigacion';
                    const esFumigacionB = depB === 'fumigaci√≥n' || depB === 'fumigacion';
                    
                    if (esFumigacionA && !esFumigacionB) return -1;
                    if (!esFumigacionA && esFumigacionB) return 1;
                    return 0; // Mantener el orden original para el resto
                });

            // Renderizar cajas de recursos sin asignar
            renderizarRecursosSinAsignar(tecnicosSinAsignar, vehiculosSinAsignar, fechaFormateada);
            
            // Usar alturas fijas para mantener consistencia visual
            // Veh√≠culos: 28px fijo (delgado)
            // T√©cnicos: altura autom√°tica para permitir m√∫ltiples t√©cnicos
            const alturaFijaVehiculos = 28;
            const alturaMinimaTecnicos = 50; // Altura m√≠nima para permitir m√∫ltiples t√©cnicos
            
            // Aplicar altura uniforme fija a todas las filas usando estilos din√°micos
            let styleElement = document.getElementById('estilos-filas-rutas');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'estilos-filas-rutas';
                document.head.appendChild(styleElement);
            }
            styleElement.textContent = `
                .ruta-info-row:nth-of-type(1) { 
                    min-height: ${alturaFijaVehiculos}px !important; 
                    height: ${alturaFijaVehiculos}px !important; 
                    max-height: ${alturaFijaVehiculos}px !important; 
                }
                .ruta-info-row:nth-of-type(2) { 
                    min-height: ${alturaMinimaTecnicos}px !important; 
                    height: auto !important; 
                    max-height: none !important; 
                }
            `;

            // Funci√≥n auxiliar para generar HTML de una columna de ruta
            const generarColumnaRuta = (ruta, citasParam = null, fechaParam = null) => {
                // Si se pasan citas y fecha como par√°metros, usarlas; si no, usar las globales
                const citas = citasParam || citasPorRuta[ruta];
                const fechaFormateadaParaRuta = fechaParam || (estaEnVistaCompacta ? null : `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                
                // Obtener datos del ruteador seg√∫n la fecha
                let datosRuteador = { tecnicos: [], vehiculos: [] };
                if (estaEnVistaCompacta && fechaParam) {
                    const key = `${fechaParam}_${ruta}`;
                    datosRuteador = datosRuteadorMap[key] || { tecnicos: [], vehiculos: [] };
                } else {
                    datosRuteador = datosRuteadorMap[ruta] || { tecnicos: [], vehiculos: [] };
                }
                
                // Calcular total de citas
                const totalCitas = citas ? citas.length : 0;
                
                // Calcular monto total y cantidad de citas con precio > 0
                const citasConPrecio = citas.filter(cita => {
                    const monto = obtenerMonto(cita);
                    return monto && monto > 0;
                });
                const montoTotal = citasConPrecio.reduce((sum, cita) => sum + obtenerMonto(cita), 0);
                const cantidadCitasConPrecio = citasConPrecio.length;
                
                // Formatear monto en miles (ej: 195000 -> ‚Ç°195m)
                let montoFormateado = '‚Ç°0m';
                if (montoTotal > 0) {
                    const montoEnMiles = Math.round(montoTotal / 1000);
                    montoFormateado = `‚Ç°${montoEnMiles}m`;
                }
                
                // Determinar icono del badge de facturaci√≥n seg√∫n el monto
                let iconoBadge = '';
                if (citas.length > 0 && montoTotal > 0) {
                    if (montoTotal > 200000) {
                        iconoBadge = '<i class="fas fa-check-circle" style="color: #4caf50; font-size: 0.9rem;"></i>';
                    } else if (montoTotal >= 100000) {
                        iconoBadge = '<i class="fas fa-exclamation-triangle" style="color: #ffc107; font-size: 0.9rem;"></i>';
                    } else {
                        iconoBadge = '<i class="fas fa-times-circle" style="color: #f44336; font-size: 0.9rem;"></i>';
                    }
                }
                // Si es 0 o no hay citas, no mostrar icono
                
                // Fondo: gris medio para rutas sin citas (excepto "Sin asignar"), blanco para rutas con citas o "Sin asignar"
                const colorFondo = (ruta === 'Sin asignar' || (citas && citas.length > 0)) ? '#ffffff' : '#e0e0e0';
                
                // Filtrar citas con coordenadas GPS
                // Usar funci√≥n s√≠ncrona que verifica fallback y asume que citas con sucursal pueden tener coordenadas
                // Las coordenadas se obtendr√°n correctamente desde sucursal cuando se necesiten (en mostrarRutaVehiculo)
                const citasConUbicacion = citas.filter(cita => {
                    // Verificar si tiene sucursal (puede tener coordenadas en sucursal)
                    const tieneSucursal = window.esSucursalIndiceValido(cita.metadata?.sucursalIndice);
                    
                    // Si tiene sucursal, incluirla (las coordenadas se obtendr√°n desde sucursal despu√©s)
                    if (tieneSucursal) {
                        return true;
                    }
                    
                    // Si no tiene sucursal, verificar fallback para citas antiguas
                    const coordenadas = cita.metadata?.coordenadas;
                    return coordenadas && coordenadas.lat && coordenadas.lng;
                });
                
                // Formatear t√©cnicos asignados
                const tecnicosNombres = datosRuteador.tecnicos.map(username => {
                    const empleado = window.empleados?.find(e => e.username === username || e.id === username);
                    return empleado ? `${empleado.primerNombre} ${empleado.primerApellido}`.trim() : username;
                }).join(', ') || 'Sin asignar';
                
                // Formatear veh√≠culos asignados
                const vehiculosTexto = datosRuteador.vehiculos.join(', ') || 'Sin asignar';
                
                // Almacenar citas en variable global para acceso desde el bot√≥n
                const rutaId = ruta.replace(/[^a-zA-Z0-9]/g, '-');
                const fechaKey = fechaFormateadaParaRuta ? fechaFormateadaParaRuta.replace(/-/g, '') : '';
                const claveCompleta = fechaKey ? `${fechaKey}_${rutaId}` : rutaId;
                if (!window.citasPorRutaRuta) {
                    window.citasPorRutaRuta = {};
                }
                window.citasPorRutaRuta[claveCompleta] = citas;
                
                const tieneCitas = citas && citas.length > 0;
                // "Sin asignar" siempre debe tener fondo blanco, nunca gris
                const colorHeader = (ruta === 'Sin asignar' || tieneCitas) ? '' : 'background: #e0e0e0 !important;';
                const colorContenido = (ruta === 'Sin asignar' || tieneCitas) ? '' : 'background: #e0e0e0 !important;';
                const colorInfoRow = (ruta === 'Sin asignar' || tieneCitas) ? '' : 'background: #e0e0e0 !important;';
                
                // Estilos para ruta sin citas (deshabilitada/dormida)
                const estiloCirculoDeshabilitado = tieneCitas ? '' : 'opacity: 0.5; background: #bdbdbd !important; border: 2.5px solid #9e9e9e !important; position: relative;';
                const simboloDormida = tieneCitas ? '' : '<i class="fas fa-moon" style="position: absolute; top: 2px; right: 2px; font-size: 0.45rem; color: #757575; background: white; border-radius: 50%; padding: 1px; border: 1px solid #9e9e9e;"></i>';
                
                // Determinar el texto a mostrar en el c√≠rculo
                let textoCirculo = ruta.replace('Ruta ', '');
                let tamanoCirculo = '32px';
                let tamanoFuente = '1rem';
                if (ruta === 'Ruta 19') {
                    textoCirculo = 'Rural';
                    tamanoCirculo = 'auto';
                    tamanoFuente = '0.8rem';
                } else if (ruta === 'Ruta 20') {
                    textoCirculo = 'Cancelaciones';
                    tamanoCirculo = 'auto';
                    tamanoFuente = '0.7rem';
                }
                
                return `
                    <div class="vehiculo-columna-cronograma" style="background: ${colorFondo};">
                        <div class="vehiculo-header-cronograma ${ruta.replace(' ', '-')}" style="${colorHeader}">
                            <div class="ruta-nombre-header" 
                                 style="${ruta === 'Sin asignar' ? 'cursor: default;' : ''}">
                                <!-- L√≠nea 1: N√∫mero de ruta -->
                                <div style="display: flex; align-items: center; justify-content: center; height: 32px; margin-bottom: 3px; position: relative; flex-shrink: 0;">
                                    ${ruta === 'Sin asignar' ? 
                                        `<span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: white; border: 2.5px solid #000; font-size: 0.75rem; font-weight: 800; color: #000; position: relative; ${!tieneCitas ? 'opacity: 0.5; background: #bdbdbd !important; border: 2.5px solid #9e9e9e !important;' : ''}">S/A${!tieneCitas ? '<i class="fas fa-moon" style="position: absolute; top: 2px; right: 2px; font-size: 0.45rem; color: #757575; background: white; border-radius: 50%; padding: 1px; border: 1px solid #9e9e9e;"></i>' : ''}</span>` : 
                                        `<span style="display: inline-flex; align-items: center; justify-content: center; min-width: ${tamanoCirculo}; ${(ruta === 'Ruta 19' || ruta === 'Ruta 20') ? 'width: auto; padding: 0 6px; border-radius: 16px;' : 'width: ' + tamanoCirculo + '; height: ' + tamanoCirculo + '; border-radius: 50%;'} background: white; border: 2.5px solid #000; font-size: ${tamanoFuente}; font-weight: 800; color: #000; ${estiloCirculoDeshabilitado}">${textoCirculo}</span>${simboloDormida}`
                                    }
                            </div>
                                
                                <!-- L√≠nea 2: Cantidad de citas y Facturaci√≥n -->
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; margin-top: 4px; flex-shrink: 0;">
                                    ${totalCitas > 0 ? `
                                        <div style="display: flex; align-items: center; gap: 4px; font-size: clamp(0.6rem, 1vw, 0.7rem); font-weight: 600; background: rgba(255,255,255,0.25); padding: 2px 6px; border-radius: 4px; white-space: nowrap;">
                                            <i class="fas fa-calendar-check" style="font-size: 0.7rem;"></i>
                                            <span><strong>${totalCitas}</strong> ${totalCitas === 1 ? 'cita' : 'citas'}</span>
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; justify-content: center; align-items: center; height: 22px; flex-shrink: 0;">
                                        <span class="ruta-monto-badge" style="background: #ffffff; color: #000000; border: 1px solid rgba(0,0,0,0.2); display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                                            ${iconoBadge}${montoFormateado !== '‚Ç°0m' ? montoFormateado : '‚Ç°0'}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- L√≠nea 3: Botones (todos del mismo tama√±o y estilo) -->
                                <div style="display: flex; justify-content: center; align-items: flex-start; gap: 3px; min-height: 48px; height: auto; flex-shrink: 0; flex-wrap: wrap; padding-top: 2px;">
                                    ${citasConUbicacion.length > 0 ? `
                                    <button onclick="window.mostrarRutaVehiculo('${ruta.replace(/'/g, "\\'")}', '${claveCompleta}')" 
                                            style="background: ${ruta === 'Sin asignar' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}; border: 1px solid ${ruta === 'Sin asignar' ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.5)'}; color: ${ruta === 'Sin asignar' ? '#000000' : 'white'}; padding: 3px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 45px; height: 22px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); font-weight: 600; white-space: nowrap;" 
                                            onmouseover="this.style.background='${ruta === 'Sin asignar' ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.4)'}'; this.style.transform='scale(1.05)'" 
                                            onmouseout="this.style.background='${ruta === 'Sin asignar' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}'; this.style.transform='scale(1)'"
                                            title="Ver Ruta (${citasConUbicacion.length} citas)">
                                        <i class="fas fa-map-marked-alt" style="font-size: 0.65rem; margin-right: 2px;"></i>Ruta
                                    </button>
                                    ` : ''}
                                    ${citas.length > 0 && ruta !== 'Sin asignar' ? `
                                    <button onclick="window.abrirModalMigrarRuta('${ruta.replace(/'/g, "\\'")}', '${fechaFormateadaParaRuta}')" 
                                            style="background: rgba(255,193,7,0.9); border: 1px solid rgba(255,255,255,0.5); color: #000; padding: 3px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 45px; height: 22px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); font-weight: 600; white-space: nowrap;" 
                                            onmouseover="this.style.background='rgba(255,193,7,1)'; this.style.transform='scale(1.05)'" 
                                            onmouseout="this.style.background='rgba(255,193,7,0.9)'; this.style.transform='scale(1)'"
                                            title="Migrar citas de esta ruta">
                                        <i class="fas fa-exchange-alt" style="font-size: 0.65rem; margin-right: 2px;"></i>Migrar
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="ruta-contenido-blanco" style="${colorContenido}">
                                <div class="ruta-info-row ${datosRuteador.vehiculos.length === 0 ? 'drop-zone-empty' : ''}" data-tipo-fila="vehiculo" data-ruta="${ruta.replace(/'/g, "\\'")}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}" title="Arrastre veh√≠culos aqu√≠" style="${colorInfoRow}">
                                    ${datosRuteador.vehiculos.length > 0 
                                        ? datosRuteador.vehiculos.filter(v => v && String(v).trim() !== '').map(v => {
                                            const vehiculoEscapado = String(v).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                            const rutaEscapada = ruta.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                            return `<span class="ruta-badge-item ruta-badge-vehiculo" draggable="true" data-tipo="vehiculo" data-vehiculo="${vehiculoEscapado}" data-ruta="${rutaEscapada}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}">${v}</span>`;
                                        }).join('')
                                        : '<span style="color: #2196F3; font-size: 0.6rem; font-style: italic; opacity: 0.8; font-weight: 500;">Arrastre veh√≠culos aqu√≠</span>'
                                    }
                            </div>
                                <div class="ruta-info-row ${datosRuteador.tecnicos.length === 0 ? 'drop-zone-empty' : ''}" data-tipo-fila="tecnico" data-ruta="${ruta.replace(/'/g, "\\'")}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}" title="Arrastre t√©cnicos aqu√≠" style="${colorInfoRow}">
                                    ${datosRuteador.tecnicos.length > 0 
                                        ? datosRuteador.tecnicos.filter(tecnicoId => tecnicoId && String(tecnicoId).trim() !== '').map(tecnicoId => {
                                            // Buscar empleado por username o id (puede estar guardado como cualquiera de los dos)
                                            const empleado = window.empleados?.find(e => 
                                                (e.username && e.username === tecnicoId) || 
                                                (e.id && e.id === tecnicoId) ||
                                                (e.username && e.id === tecnicoId) ||
                                                (e.id && e.username === tecnicoId)
                                            );
                                            
                                            // Usar el username del empleado si existe, sino usar el ID guardado
                                            let usernameFinal = empleado ? (empleado.username || empleado.id) : tecnicoId;
                                            
                                            // Validar que usernameFinal no est√© vac√≠o
                                            if (!usernameFinal || String(usernameFinal).trim() === '') {
                                                console.error('[RENDER] ‚ùå T√©cnico sin username v√°lido al crear badge', {
                                                    tecnicoId: tecnicoId,
                                                    empleado: empleado ? { id: empleado.id, nombre: `${empleado.primerNombre} ${empleado.primerApellido}`.trim() } : 'no encontrado',
                                                    problema: 'No se puede crear badge sin username v√°lido'
                                                });
                                                return null; // Retornar null para filtrarlo despu√©s
                                            }
                                            
                                            usernameFinal = String(usernameFinal).trim();
                                            
                                            let nombre = String(tecnicoId);
                                            if (empleado) {
                                                const primerNombre = empleado.primerNombre || '';
                                                const primerApellido = empleado.primerApellido || '';
                                                const inicialApellido = primerApellido ? primerApellido.charAt(0).toUpperCase() + '.' : '';
                                                nombre = `${primerNombre} ${inicialApellido}`.trim() || nombre;
                                            }
                                            // Escapar comillas y caracteres especiales para HTML
                                            const usernameEscapado = String(usernameFinal).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                            const nombreEscapado = String(nombre).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                            const rutaEscapada = ruta.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                            return `<span class="ruta-badge-item ruta-badge-tecnico" draggable="true" data-tipo="tecnico" data-username="${usernameEscapado}" data-nombre="${nombreEscapado}" data-ruta="${rutaEscapada}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}">${nombre}</span>`;
                                          }).filter(badge => badge !== null).join('')
                                        : '<span style="color: #FF9800; font-size: 0.6rem; font-style: italic; opacity: 0.8; font-weight: 500;">Arrastre t√©cnicos aqu√≠</span>'
                                    }
                            </div>
                        </div>
                        </div>
                        <div class="citas-timeline" id="timeline-${(fechaFormateadaParaRuta || '').replace(/-/g, '')}-${ruta.replace(/ /g, '-')}" data-ruta="${ruta}" data-fecha="${fechaFormateadaParaRuta || ''}">
                            ${generarCitasTimeline(citas, ruta)}
                        </div>
                    </div>
                `;
            };

            // Generar HTML en dos contenedores completamente separados
            const vehiculosCronogramaDiurnas = document.getElementById('vehiculosCronogramaDiurnas');
            const vehiculosCronogramaNocturnas = document.getElementById('vehiculosCronogramaNocturnas');
            
            // Generar secci√≥n diurnas
            if (vehiculosCronogramaDiurnas) {
                let htmlDiurnas = '';
                if (estaEnVistaCompacta) {
                    // Vista compacta: generar columnas directamente en el contenedor, agrupadas por d√≠a visualmente
                    diasAMostrar.forEach((fechaDia, indexDia) => {
                        const yearDia = fechaDia.getFullYear();
                        const monthDia = fechaDia.getMonth();
                        const dayDia = fechaDia.getDate();
                        const keyDia = `${yearDia}-${monthDia + 1}-${dayDia}`;
                        const fechaFormateadaDia = `${yearDia}-${String(monthDia + 1).padStart(2, '0')}-${String(dayDia).padStart(2, '0')}`;
                        
                        // Encabezado del d√≠a como columna separada (para alinearlo con las rutas)
                        const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                        const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        const nombreDia = dayNames[fechaDia.getDay()];
                        
                        // Generar columna de encabezado del d√≠a
                        htmlDiurnas += `<div class="vehiculo-columna-cronograma" style="min-width: 120px; flex-shrink: 0; border-right: 2px solid #e0e0e0;">
                            <div class="vehiculo-header-cronograma" style="background: #4CAF50; color: white; padding: 12px 8px; text-align: center; font-weight: 600; font-size: 0.9rem;">
                                ${nombreDia}<br>${dayDia} ${monthNames[monthDia]}
                            </div>
                            <div class="ruta-contenido-blanco" style="height: 792px;"></div>
                        </div>`;
                        
                        // Columnas de rutas para este d√≠a (directamente en el contenedor padre)
                        rutasDiurnas.forEach(ruta => {
                            const citasDelDia = citasPorDiaYRuta[keyDia]?.[ruta] || [];
                            htmlDiurnas += generarColumnaRuta(ruta, citasDelDia, fechaFormateadaDia);
                        });
                        
                        // Separador visual entre d√≠as (excepto el √∫ltimo)
                        if (indexDia < diasAMostrar.length - 1) {
                            htmlDiurnas += `<div style="width: 4px; background: #e0e0e0; flex-shrink: 0; margin: 0 4px;"></div>`;
                        }
                    });
                } else {
                    // Vista total: solo un d√≠a
                    htmlDiurnas = rutasDiurnas.map(ruta => generarColumnaRuta(ruta)).join('');
                }
                vehiculosCronogramaDiurnas.innerHTML = htmlDiurnas;
            }
            
            // Generar secci√≥n nocturnas
            if (vehiculosCronogramaNocturnas && rutasNocturnas.length > 0) {
                let htmlNocturnas = '';
                if (estaEnVistaCompacta) {
                    // Vista compacta: generar columnas directamente en el contenedor, agrupadas por d√≠a visualmente
                    diasAMostrar.forEach((fechaDia, indexDia) => {
                        const yearDia = fechaDia.getFullYear();
                        const monthDia = fechaDia.getMonth();
                        const dayDia = fechaDia.getDate();
                        const keyDia = `${yearDia}-${monthDia + 1}-${dayDia}`;
                        const fechaFormateadaDia = `${yearDia}-${String(monthDia + 1).padStart(2, '0')}-${String(dayDia).padStart(2, '0')}`;
                        
                        // Encabezado del d√≠a como columna separada (para alinearlo con las rutas)
                        const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                        const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        const nombreDia = dayNames[fechaDia.getDay()];
                        
                        // Generar columna de encabezado del d√≠a
                        htmlNocturnas += `<div class="vehiculo-columna-cronograma" style="min-width: 120px; flex-shrink: 0; border-right: 2px solid #e0e0e0;">
                            <div class="vehiculo-header-cronograma" style="background: #FF9800; color: white; padding: 12px 8px; text-align: center; font-weight: 600; font-size: 0.9rem;">
                                ${nombreDia}<br>${dayDia} ${monthNames[monthDia]}
                            </div>
                            <div class="ruta-contenido-blanco" style="height: 792px;"></div>
                        </div>`;
                        
                        // Columnas de rutas para este d√≠a (directamente en el contenedor padre)
                        rutasNocturnas.forEach(ruta => {
                            const citasDelDia = citasPorDiaYRuta[keyDia]?.[ruta] || [];
                            htmlNocturnas += generarColumnaRuta(ruta, citasDelDia, fechaFormateadaDia);
                        });
                        
                        // Separador visual entre d√≠as (excepto el √∫ltimo)
                        if (indexDia < diasAMostrar.length - 1) {
                            htmlNocturnas += `<div style="width: 4px; background: #e0e0e0; flex-shrink: 0; margin: 0 4px;"></div>`;
                        }
                    });
                } else {
                    // Vista total: solo un d√≠a
                    htmlNocturnas = rutasNocturnas.map(ruta => generarColumnaRuta(ruta)).join('');
                }
                vehiculosCronogramaNocturnas.innerHTML = htmlNocturnas;
            }

            // Siempre mostrar todas las rutas, incluso sin citas
            
            // Funci√≥n para calcular y actualizar rangos de horas en los t√≠tulos y colapsar filas fuera del rango
            const actualizarRangosEnTitulos = () => {
                // Funci√≥n auxiliar para obtener minutos desde medianoche
                const obtenerMinutosDesdeMedianoche = (cita) => {
                    const timestamp = obtenerInicio(cita);
                    if (!timestamp) return null;
                    
                    let fechaLocal;
                    if (timestamp && timestamp.toDate) {
                        fechaLocal = timestamp.toDate();
                    } else if (timestamp instanceof Date) {
                        fechaLocal = timestamp;
                    } else {
                        return null;
                    }
                    
                    const horaInicio = fechaLocal.getHours();
                    const minutoInicio = fechaLocal.getMinutes();
                    const minutosDesdeMedianoche = horaInicio * 60 + minutoInicio;
                    
                    // Convertir a minutos desde las 5 AM (d√≠a laborable)
                    // Si la hora es antes de las 5 AM, pertenece al d√≠a siguiente (sumar 19 horas)
                    // Si la hora es 5 AM o despu√©s, restar 5 horas
                    if (horaInicio < 5) {
                        // Hora entre 0:00 y 4:59 AM -> pertenece al d√≠a siguiente
                        return minutosDesdeMedianoche + (19 * 60); // Sumar 19 horas (1140 minutos)
                    } else {
                        // Hora entre 5:00 AM y 23:59 -> restar 5 horas (300 minutos)
                        return minutosDesdeMedianoche - (5 * 60);
                    }
                };
                
                // Funci√≥n para formatear minutos a hora legible
                const formatearMinutosAHora = (minutos) => {
                    if (minutos === null || minutos === undefined) return '';
                    const horas = Math.floor(minutos / 60);
                    const mins = minutos % 60;
                    const hora12 = horas === 0 ? 12 : horas > 12 ? horas - 12 : horas;
                    const ampm = horas < 12 ? 'AM' : 'PM';
                    return `${hora12}:${mins.toString().padStart(2, '0')} ${ampm}`;
                };
                
                // Calcular rango para rutas diurnas
                let minInicioDiurnas = null;
                let maxFinDiurnas = null;
                rutasDiurnas.forEach(ruta => {
                    const citas = citasPorRuta[ruta] || [];
                    citas.forEach(cita => {
                        const minutosInicio = obtenerMinutosDesdeMedianoche(cita);
                        if (minutosInicio !== null) {
                            const duracion = obtenerDuracion(cita);
                            const minutosFin = minutosInicio + duracion;
                            
                            if (minInicioDiurnas === null || minutosInicio < minInicioDiurnas) {
                                minInicioDiurnas = minutosInicio;
                            }
                            if (maxFinDiurnas === null || minutosFin > maxFinDiurnas) {
                                maxFinDiurnas = minutosFin;
                            }
                        }
                    });
                });
                
                // Calcular rango para rutas nocturnas
                let minInicioNocturnas = null;
                let maxFinNocturnas = null;
                rutasNocturnas.forEach(ruta => {
                    const citas = citasPorRuta[ruta] || [];
                    citas.forEach(cita => {
                        const minutosInicio = obtenerMinutosDesdeMedianoche(cita);
                        if (minutosInicio !== null) {
                            const duracion = obtenerDuracion(cita);
                            const minutosFin = minutosInicio + duracion;
                            
                            if (minInicioNocturnas === null || minutosInicio < minInicioNocturnas) {
                                minInicioNocturnas = minutosInicio;
                            }
                            if (maxFinNocturnas === null || minutosFin > maxFinNocturnas) {
                                maxFinNocturnas = minutosFin;
                            }
                        }
                    });
                });
                
                // Agregar 1 hora de margen antes y despu√©s (en minutos)
                const minutosInicioDiurnasConMargen = minInicioDiurnas !== null ? Math.max(0, minInicioDiurnas - 60) : null;
                const minutosFinDiurnasConMargen = maxFinDiurnas !== null ? Math.min(1440, maxFinDiurnas + 60) : null;
                
                const minutosInicioNocturnasConMargen = minInicioNocturnas !== null ? Math.max(0, minInicioNocturnas - 60) : null;
                const minutosFinNocturnasConMargen = maxFinNocturnas !== null ? Math.min(1440, maxFinNocturnas + 60) : null;
                
                // Actualizar t√≠tulo de secci√≥n diurnas (sin rango de horas)
                const tituloDiurnas = document.querySelector('#seccionRutasDiurnas .seccion-titulo');
                if (tituloDiurnas) {
                    tituloDiurnas.innerHTML = `<i class="fas fa-sun me-2"></i>Rutas Diurnas (Sin asignar, Ruta 1-10)`;
                }
                
                // Actualizar t√≠tulo de secci√≥n nocturnas (sin rango de horas)
                const tituloNocturnas = document.querySelector('#seccionRutasNocturnas .seccion-titulo');
                if (tituloNocturnas) {
                    tituloNocturnas.innerHTML = `<i class="fas fa-moon me-2"></i>Rutas Nocturnas / Especiales (Ruta 11-Cancelaciones)`;
                }
                
                // Funci√≥n para ocultar/mostrar filas de horas fuera del rango en una secci√≥n
                const colapsarFilasHoras = (contenedorId, minutosInicioConMargen, minutosFinConMargen, colapsar = true) => {
                    const contenedor = document.getElementById(contenedorId);
                    if (!contenedor) return;
                    
                    // Calcular altura del timeline en vista compacta
                    let alturaTimeline = 792; // Altura por defecto (24 horas * 33px)
                    let offsetTop = 0; // Offset para reposicionar elementos
                    
                    if (colapsar && minutosInicioConMargen !== null && minutosFinConMargen !== null) {
                        // Calcular altura basada en el rango visible (con margen)
                        const minutosTotales = minutosFinConMargen - minutosInicioConMargen;
                        alturaTimeline = (minutosTotales / 60) * 33;
                        offsetTop = (minutosInicioConMargen / 60) * 33; // Offset para reposicionar
                    }
                    
                    // Obtener todas las columnas de rutas en esta secci√≥n
                    const columnas = contenedor.querySelectorAll('.vehiculo-columna-cronograma');
                    
                    columnas.forEach(columna => {
                        const timeline = columna.querySelector('.citas-timeline');
                        if (!timeline) return;
                        
                        // Ajustar altura del timeline
                        if (colapsar && minutosInicioConMargen !== null && minutosFinConMargen !== null) {
                            timeline.style.height = `${alturaTimeline}px`;
                            timeline.style.minHeight = `${alturaTimeline}px`;
                            timeline.style.overflow = 'hidden';
                        } else {
                            // Vista total: restaurar altura original
                            timeline.style.height = '792px';
                            timeline.style.minHeight = '792px';
                            timeline.style.overflow = 'visible';
                        }
                        
                        // Ocultar/mostrar y reposicionar marcadores de hora
                        const marcadores = timeline.querySelectorAll('.marcador-hora-timeline');
                        marcadores.forEach(marcador => {
                            const topOriginal = parseFloat(marcador.style.top) || 0;
                            // Convertir top (px) a minutos desde las 5 AM: top / 33 * 60
                            const minutosDesde5AM = (topOriginal / 33) * 60;
                            
                            if (!colapsar || minutosInicioConMargen === null || minutosFinConMargen === null) {
                                // Vista total: mostrar todas las horas en su posici√≥n original
                                marcador.style.display = 'block';
                                marcador.style.top = `${topOriginal}px`;
                                marcador.style.transform = 'none';
                            } else {
                                // Vista compacta: ocultar fuera del rango y reposicionar los visibles
                                if (minutosDesde5AM < minutosInicioConMargen || minutosDesde5AM > minutosFinConMargen) {
                                    marcador.style.display = 'none';
                                } else {
                                    marcador.style.display = 'block';
                                    // Reposicionar: restar el offset para que empiece desde 0
                                    const nuevoTop = topOriginal - offsetTop;
                                    marcador.style.top = `${nuevoTop}px`;
                                }
                            }
                        });
                        
                        // Ocultar/mostrar y reposicionar l√≠neas divisorias
                        const lineas = timeline.querySelectorAll('.linea-divisoria-hora');
                        lineas.forEach(linea => {
                            const topOriginal = parseFloat(linea.style.top) || 0;
                            // Convertir top (px) a minutos desde las 5 AM: top / 33 * 60
                            const minutosDesde5AM = (topOriginal / 33) * 60;
                            
                            if (!colapsar || minutosInicioConMargen === null || minutosFinConMargen === null) {
                                // Vista total: mostrar todas las l√≠neas en su posici√≥n original
                                linea.style.display = 'block';
                                linea.style.top = `${topOriginal}px`;
                            } else {
                                // Vista compacta: ocultar fuera del rango y reposicionar las visibles
                                if (minutosDesde5AM < minutosInicioConMargen || minutosDesde5AM > minutosFinConMargen) {
                                    linea.style.display = 'none';
                                } else {
                                    linea.style.display = 'block';
                                    // Reposicionar: restar el offset para que empiece desde 0
                                    const nuevoTop = topOriginal - offsetTop;
                                    linea.style.top = `${nuevoTop}px`;
                                }
                            }
                        });
                        
                        // Reposicionar citas en vista compacta
                        if (colapsar && minutosInicioConMargen !== null && minutosFinConMargen !== null) {
                            const citas = timeline.querySelectorAll('.cita-bloque');
                            citas.forEach(cita => {
                                const topOriginal = parseFloat(cita.style.top) || 0;
                                const alturaCita = parseFloat(cita.style.height) || 0;
                                const minutosCitaInicio = (topOriginal / 33) * 60;
                                const minutosCitaFin = minutosCitaInicio + (alturaCita / 33) * 60;
                                
                                // Verificar si la cita est√° dentro del rango visible (o se superpone)
                                if (minutosCitaFin >= minutosInicioConMargen && minutosCitaInicio <= minutosFinConMargen) {
                                    // La cita est√° dentro o se superpone con el rango visible
                                    cita.style.display = 'block';
                                    // Reposicionar: restar el offset para que empiece desde 0
                                    const nuevoTop = topOriginal - offsetTop;
                                    cita.style.top = `${nuevoTop}px`;
                                } else {
                                    // La cita est√° completamente fuera del rango visible
                                    cita.style.display = 'none';
                                }
                            });
                        } else {
                            // Vista total: mostrar todas las citas y restaurar posiciones originales
                            const citas = timeline.querySelectorAll('.cita-bloque');
                            citas.forEach(cita => {
                                cita.style.display = 'block';
                                // Las posiciones se restauran al regenerar el cronograma
                            });
                        }
                    });
                };
                
                // Guardar rangos en variables globales para poder usarlos desde el toggle
                window.rangosHoras = {
                    diurnas: {
                        inicio: minutosInicioDiurnasConMargen,
                        fin: minutosFinDiurnasConMargen
                    },
                    nocturnas: {
                        inicio: minutosInicioNocturnasConMargen,
                        fin: minutosFinNocturnasConMargen
                    }
                };
                
                // Aplicar colapso seg√∫n el estado del toggle
                const btnToggle = document.getElementById('btnToggleVistaCompacta');
                const estaCompacta = btnToggle && btnToggle.classList.contains('active');
                
                // Colapsar filas de horas para secci√≥n diurnas
                colapsarFilasHoras('vehiculosCronogramaDiurnas', minutosInicioDiurnasConMargen, minutosFinDiurnasConMargen, estaCompacta);
                
                // Colapsar filas de horas para secci√≥n nocturnas
                colapsarFilasHoras('vehiculosCronogramaNocturnas', minutosInicioNocturnasConMargen, minutosFinNocturnasConMargen, estaCompacta);
            };
            
            // Actualizar rangos en los t√≠tulos
            actualizarRangosEnTitulos();
            
            // Calcular y actualizar resumen de ventas por ruta
            const calcularResumenVentasPorRuta = () => {
                const ventasPorRuta = {};
                
                // Calcular ventas totales por ruta
                Object.keys(citasPorRuta).forEach(ruta => {
                    const citas = citasPorRuta[ruta];
                    const totalVentas = citas.reduce((sum, cita) => {
                        const monto = obtenerMonto(cita);
                        return sum + (monto || 0);
                    }, 0);
                    
                    // Solo contar rutas que tienen citas
                    if (citas.length > 0) {
                        ventasPorRuta[ruta] = totalVentas;
                    }
                });
            };
            
            // Inicializar drag and drop
            setTimeout(() => {
                inicializarDragAndDrop();
                inicializarDragAndDropRecursos(fechaFormateada);
                inicializarArrastreCrearCitas(fechaFormateada);
            }, 100);
        }

        // Funci√≥n para generar timeline de citas
        function generarCitasTimeline(citas, ruta) {
            // Usar versi√≥n s√≠ncrona para renderizado r√°pido
            const obtenerClienteNombre = function(cita) {
                if (!window.obtenerClienteNombreSync) {
                    console.error('‚ùå [generarCitasTimeline] obtenerClienteNombreSync no est√° disponible');
                    return cita.metadata?.cliente_nombre || cita.client_name || 'Sin nombre';
                }
                
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('‚ùå [generarCitasTimeline] obtenerClienteNombreSync retorn√≥ una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado || 'Sin nombre';
            };
            
            // Generar marcadores de hora dentro del timeline (basados en el contenedor de citas)
            let timelineHTML = '';
            
            // Agregar l√≠neas divisorias de hora en todas las columnas (grises delgadas)
            // D√≠a laborable: 5 AM a 4:59 AM del d√≠a siguiente (24 horas desplazadas)
            for (let i = 0; i < 24; i++) {
                // Hora del d√≠a laborable: 5 AM + i horas
                const horaReal = (5 + i) % 24; // 5, 6, 7, ..., 23, 0, 1, 2, 3, 4
                const top = i * 33; // Posici√≥n desde el inicio del contenedor (sin offset de header)
                timelineHTML += `
                    <div class="linea-divisoria-hora" style="top: ${top}px;"></div>
                `;
            }
            
            // Agregar marcadores de hora con texto en la columna "Sin asignar"
            if (ruta === 'Sin asignar') {
                // Agregar marcadores de hora (24 horas, empezando desde 5 AM)
                for (let i = 0; i < 24; i++) {
                    const horaReal = (5 + i) % 24; // 5, 6, 7, ..., 23, 0, 1, 2, 3, 4
                    const top = i * 33; // Posici√≥n desde el inicio del contenedor (sin offset de header)
                    const horaFormateada = horaReal === 0 ? '12:00 AM' : 
                                         horaReal < 12 ? `${horaReal}:00 AM` : 
                                         horaReal === 12 ? '12:00 PM' : 
                                         `${horaReal - 12}:00 PM`;
                    timelineHTML += `
                        <div class="marcador-hora-timeline" style="top: ${top}px;">
                            <span class="marcador-hora-timeline-label">${horaFormateada}</span>
                        </div>
                    `;
                }
            }
            
            if (citas.length === 0) {
                // Solo retornar las l√≠neas divisorias, sin mensaje ni √≠cono
                return timelineHTML;
            }

            // Ordenar citas por hora
            citas.sort((a, b) => {
                const fechaA = window.formatearFecha(obtenerInicio(a));
                const fechaB = window.formatearFecha(obtenerInicio(b));
                if (!fechaA || !fechaB) return 0;
                return fechaA.getTime() - fechaB.getTime();
            });

            let ultimaHoraFin = 0; // 12:00 AM en minutos

            citas.forEach((cita, index) => {
                const fechaInicio = window.formatearFecha(obtenerInicio(cita));
                if (!fechaInicio) return;

                // Obtener hora y minuto correctamente del timestamp
                // El timestamp de Firestore almacena en UTC, pero representa la hora en GMT-6
                const timestamp = obtenerInicio(cita);
                let horaInicio, minutoInicio;
                
                if (timestamp && timestamp.toDate) {
                    // Es un Timestamp de Firestore
                    // El timestamp fue creado con Timestamp.fromDate(fechaInicio)
                    // donde fechaInicio es un Date que representa GMT-6
                    // Firestore almacena el timestamp en UTC
                    const fechaUTC = timestamp.toDate();
                    
                    // Obtener componentes UTC (el timestamp interno es UTC)
                    const utcHours = fechaUTC.getUTCHours();
                    const utcMinutes = fechaUTC.getUTCMinutes();
                    
                    // Cuando se guard√≥: fechaInicio (GMT-6) -> Timestamp (UTC)
                    // Al leer: Timestamp (UTC) -> fechaUTC (UTC)
                    // Para obtener GMT-6: UTC - 6 horas
                    let horaGMT6 = utcHours - 6;
                    if (horaGMT6 < 0) {
                        horaGMT6 += 24;
                    } else if (horaGMT6 >= 24) {
                        horaGMT6 -= 24;
                    }
                    
                    horaInicio = horaGMT6;
                    minutoInicio = utcMinutes;
                    
                } else {
                    // Es un Date normal, usar directamente
                    horaInicio = fechaInicio.getHours();
                    minutoInicio = fechaInicio.getMinutes();
                }
                
                const minutosInicioDesdeMedianoche = horaInicio * 60 + minutoInicio;
                
                // Convertir a minutos desde las 5 AM (d√≠a laborable)
                let minutosDesde5AM;
                if (horaInicio < 5) {
                    // Hora entre 0:00 y 4:59 AM -> pertenece al d√≠a siguiente (sumar 19 horas)
                    minutosDesde5AM = minutosInicioDesdeMedianoche + (19 * 60);
                } else {
                    // Hora entre 5:00 AM y 23:59 -> restar 5 horas
                    minutosDesde5AM = minutosInicioDesdeMedianoche - (5 * 60);
                }
                
                const duracion = obtenerDuracion(cita);
                const minutosFinDesde5AM = minutosDesde5AM + duracion;

                // Calcular posici√≥n y altura (33px por hora)
                // 5:00 AM = 0px, cada hora = 33px
                // Las citas est√°n dentro del contenedor .citas-timeline, que comienza despu√©s del header
                const top = (minutosDesde5AM / 60) * 33; // Posici√≥n desde las 5 AM
                const height = Math.max((duracion / 60) * 33, 20); // M√≠nimo 20px de altura

                // Ya no mostramos "Tiempo libre", solo las l√≠neas divisorias de hora
                // Las l√≠neas ya est√°n agregadas al inicio de la funci√≥n

                // Generar bloque de cita
                const horaFormateada = horaInicio === 0 ? '12' : 
                                     horaInicio < 12 ? horaInicio.toString() : 
                                     horaInicio === 12 ? '12' : 
                                     (horaInicio - 12).toString();
                const ampm = horaInicio < 12 ? 'AM' : 'PM';
                const minutoFormateado = minutoInicio.toString().padStart(2, '0');
                
                // Determinar emoji de turno
                const emojiTurno = obtenerTurnoEmoji(cita);
                
                const citaBloque = document.createElement('div');
                citaBloque.className = `cita-bloque ${ruta.replace(' ', '-')}`;
                citaBloque.style.cssText = `top: ${top}px; height: ${height}px; cursor: move;`;
                citaBloque.setAttribute('data-cita-id', cita.id);
                citaBloque.setAttribute('draggable', 'true');
                citaBloque.setAttribute('data-ruta-origen', ruta);
                
                // Obtener nombre del cliente con validaci√≥n
                let clienteNombre = obtenerClienteNombre(cita);
                
                // Log detallado para debugging
                console.log('üîç [generarCitasTimeline] Renderizando cita en timeline', {
                    citaId: cita.id,
                    ruta: ruta,
                    telefono: cita.telefono,
                    clienteNombre: clienteNombre,
                    tipoClienteNombre: typeof clienteNombre,
                    esPromise: clienteNombre && typeof clienteNombre.then === 'function',
                    metadata: cita.metadata ? Object.keys(cita.metadata) : []
                });
                
                // Asegurar que sea string
                if (clienteNombre && typeof clienteNombre.then === 'function') {
                    console.error('‚ùå [generarCitasTimeline] clienteNombre es una Promise!', cita.id);
                    clienteNombre = 'Sin nombre';
                }
                clienteNombre = clienteNombre || 'Sin nombre';
                
                // Usar versi√≥n s√≠ncrona del indicador GPS para evitar [object Promise]
                const indicadorGPS = window.obtenerIndicadorGPSSync ? window.obtenerIndicadorGPSSync(cita) : '';
                
                // Obtener estado de la encuesta
                const estadoEncuesta = obtenerEstadoEncuesta(cita);
                let indicadorEncuesta = '';
                if (estadoEncuesta === 0) {
                    // Sin link generado - rojo
                    indicadorEncuesta = '<i class="fas fa-heart" style="color: #f44336; font-size: 14px; margin-left: 4px;" title="Encuesta no enviada"></i>';
                } else if (estadoEncuesta === 1) {
                    // Link generado sin respuesta - amarillo
                    indicadorEncuesta = '<i class="fas fa-heart" style="color: #ffc107; font-size: 14px; margin-left: 4px;" title="Encuesta enviada, esperando respuesta"></i>';
                } else if (estadoEncuesta === 2) {
                    // Cliente respondi√≥ - verde
                    indicadorEncuesta = '<i class="fas fa-heart" style="color: #4caf50; font-size: 14px; margin-left: 4px;" title="Cliente respondi√≥ la encuesta"></i>';
                } else if (estadoEncuesta === 3) {
                    // Justificada sin encuesta - azul
                    const justificacion = obtenerJustificacion(cita);
                    const tituloJustificacion = justificacion ? `Justificada: ${justificacion.substring(0, 50)}${justificacion.length > 50 ? '...' : ''}` : 'Cita justificada sin encuesta';
                    indicadorEncuesta = `<i class="fas fa-heart" style="color: #2196f3; font-size: 14px; margin-left: 4px;" title="${tituloJustificacion}"></i>`;
                }
                
                // Obtener datos para mostrar en las citas (usando datos existentes de los formularios)
                const metadata = cita.metadata || {};
                
                // Obtener vendedor
                const vendedores = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                const vendedorMostrar = vendedores && vendedores.length > 0 ? vendedores[0] : '';
                const vendedorTexto = vendedorMostrar || 'Sin vendedor';
                
                // Obtener hora
                const horaMostrar = `${horaFormateada}:${minutoFormateado} ${ampm}`;
                
                // Obtener precio
                const precioMostrar = window.obtenerMonto && window.obtenerMonto(cita) ? window.formatearMontoVenta(window.obtenerMonto(cita)) : '';
                
                // Obtener ubicaci√≥n (Provincia, Cant√≥n, Distrito en ese orden)
                const ubicacionPartes = [];
                const provinciaId = metadata.provinciaId;
                const cantonId = metadata.cantonId;
                const distritoId = metadata.distritoId;
                
                // Convertir IDs a nombres usando ubicacionesCR - Orden: Provincia, Cant√≥n, Distrito
                if (window.ubicacionesCR && provinciaId && window.ubicacionesCR[provinciaId]) {
                    ubicacionPartes.push(window.ubicacionesCR[provinciaId].nombre || '');
                    
                    if (cantonId && window.ubicacionesCR[provinciaId].cantones && window.ubicacionesCR[provinciaId].cantones[cantonId]) {
                        ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].nombre || '');
                        
                        if (distritoId && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                            ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre || '');
                        }
                    }
                }
                const ubicacionTexto = ubicacionPartes.length > 0 ? ubicacionPartes.join(', ') : '';
                
                // Construir l√≠nea principal: Vendedor + Hora + Precio
                const infoPrincipal = [];
                if (vendedorTexto) infoPrincipal.push(vendedorTexto);
                if (horaMostrar) infoPrincipal.push(horaMostrar);
                if (precioMostrar) infoPrincipal.push(precioMostrar);
                const textoPrincipal = infoPrincipal.join(' ‚Ä¢ ');
                
                // Construir l√≠nea inferior: Ubicaci√≥n + Cliente
                const lineaInferior = [];
                if (ubicacionTexto) lineaInferior.push(ubicacionTexto);
                if (clienteNombre && clienteNombre !== 'Sin nombre') lineaInferior.push(clienteNombre);
                
                citaBloque.innerHTML = `
                    <div class="cita-estado-cronograma ${obtenerEstado(cita)}"></div>
                    ${indicadorGPS}
                    <div class="cita-hora-cronograma">
                        ${emojiTurno} ${textoPrincipal}${indicadorEncuesta}
                    </div>
                    ${lineaInferior.length > 0 ? `<div style="font-size: 0.65rem; line-height: 1.2; margin-top: 0.15rem; color: #ffffff; opacity: 0.9;">${lineaInferior.join(' ‚Ä¢ ')}</div>` : ''}
                `;
                
                timelineHTML += citaBloque.outerHTML;

                ultimaHoraFin = Math.max(ultimaHoraFin, minutosFinDesde5AM);
            });

            // Ya no mostramos "Tiempo libre" al final, solo las l√≠neas divisorias de hora
            // Las l√≠neas ya est√°n agregadas al inicio de la funci√≥n

            return timelineHTML;
        }


        // Funci√≥n para generar el calendario
        function generarCalendario() {
            // Usar versi√≥n s√≠ncrona para renderizado r√°pido
            const obtenerClienteNombre = function(cita) {
                if (!window.obtenerClienteNombreSync) {
                    console.error('‚ùå [generarCalendario] obtenerClienteNombreSync no est√° disponible');
                    return cita.metadata?.cliente_nombre || cita.client_name || 'Sin nombre';
                }
                
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('‚ùå [generarCalendario] obtenerClienteNombreSync retorn√≥ una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado || 'Sin nombre';
            };
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Actualizar t√≠tulo del mes
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            // currentMonth.textContent = `${monthNames[month]} ${year}`; // Elemento eliminado

            // Obtener primer d√≠a del mes y cu√°ntos d√≠as tiene
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Limpiar calendario
            calendarGrid.innerHTML = '';

            // Agregar encabezados de d√≠as
            diasSemana.forEach(dia => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = dia;
                calendarGrid.appendChild(dayHeader);
            });

            // Agregar d√≠as del mes anterior
            const prevMonth = new Date(year, month - 1, 0);
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${prevMonth.getDate() - i}</div>`;
                calendarGrid.appendChild(dayElement);
            }

            // Agregar d√≠as del mes actual
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dayDate = new Date(year, month, day);
                const isToday = dayDate.toDateString() === new Date().toDateString();
                
                dayElement.className = `calendar-day ${isToday ? 'today' : ''}`;
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                dayElement.setAttribute('data-day', day);
                dayElement.setAttribute('data-month', month);
                dayElement.setAttribute('data-year', year);
                dayElement.style.position = 'relative';
                dayElement.style.cursor = 'crosshair';
                
                // Agregar citas del d√≠a
                const citasDelDia = citasFiltradas.filter(cita => {
                    const fechaCita = window.formatearFecha(obtenerInicio(cita));
                    if (!fechaCita) return false;
                    return fechaCita.getDate() === day && 
                           fechaCita.getMonth() === month && 
                           fechaCita.getFullYear() === year;
                });

                citasDelDia.forEach(cita => {
                    const citaElement = document.createElement('div');
                    const ruta = obtenerRuta(cita);
                    citaElement.className = `cita-item ${ruta?.replace(' ', '-')}`;
                    citaElement.setAttribute('data-cita-id', cita.id);
                    citaElement.style.cursor = 'pointer';
                    citaElement.style.position = 'relative';
                    citaElement.style.zIndex = '10'; // Citas por encima pero permiten eventos en √°reas vac√≠as
                    
                    // Determinar emoji de turno
                    const emojiTurno = obtenerTurnoEmoji(cita);
                    
                    // Crear contenido con indicador GPS en esquina superior derecha (usar versi√≥n s√≠ncrona)
                    const indicadorGPS = window.obtenerIndicadorGPSSync ? window.obtenerIndicadorGPSSync(cita) : '';
                    const vehiculo = obtenerRuta(cita);
                    // Usar la versi√≥n s√≠ncrona definida al inicio de la funci√≥n
                    let clienteNombre = obtenerClienteNombre(cita);
                    
                    // Log detallado para debugging
                    console.log('üîç [generarCalendario] Renderizando cita', {
                        citaId: cita.id,
                        telefono: cita.telefono,
                        clienteNombre: clienteNombre,
                        tipoClienteNombre: typeof clienteNombre,
                        esPromise: clienteNombre && typeof clienteNombre.then === 'function',
                        metadata: cita.metadata ? Object.keys(cita.metadata) : []
                    });
                    
                    // Asegurar que sea string
                    if (clienteNombre && typeof clienteNombre.then === 'function') {
                        console.error('‚ùå [generarCalendario] clienteNombre es una Promise!', cita.id);
                        clienteNombre = 'Sin nombre';
                    }
                    clienteNombre = clienteNombre || 'Sin nombre';
                    
                    // Obtener estado de la encuesta
                    const estadoEncuesta = obtenerEstadoEncuesta(cita);
                    let indicadorEncuesta = '';
                    if (estadoEncuesta === 0) {
                        // Sin link generado - rojo
                        indicadorEncuesta = '<i class="fas fa-heart" style="color: #f44336; font-size: 12px; margin-left: 4px;" title="Encuesta no enviada"></i>';
                    } else if (estadoEncuesta === 1) {
                        // Link generado sin respuesta - amarillo
                        indicadorEncuesta = '<i class="fas fa-heart" style="color: #ffc107; font-size: 12px; margin-left: 4px;" title="Encuesta enviada, esperando respuesta"></i>';
                    } else if (estadoEncuesta === 2) {
                        // Cliente respondi√≥ - verde
                        indicadorEncuesta = '<i class="fas fa-heart" style="color: #4caf50; font-size: 12px; margin-left: 4px;" title="Cliente respondi√≥ la encuesta"></i>';
                    } else if (estadoEncuesta === 3) {
                        // Justificada sin encuesta - azul
                        const justificacion = obtenerJustificacion(cita);
                        const tituloJustificacion = justificacion ? `Justificada: ${justificacion.substring(0, 50)}${justificacion.length > 50 ? '...' : ''}` : 'Cita justificada sin encuesta';
                        indicadorEncuesta = `<i class="fas fa-heart" style="color: #2196f3; font-size: 12px; margin-left: 4px;" title="${tituloJustificacion}"></i>`;
                    }
                    
                    // Obtener datos para mostrar en las citas (usando datos existentes de los formularios)
                    const metadata = cita.metadata || {};
                    
                    // Obtener vendedor
                    const vendedoresVista = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                    const vendedorMostrarVista = vendedoresVista && vendedoresVista.length > 0 ? vendedoresVista[0] : '';
                    const vendedorTexto = vendedorMostrarVista || 'Sin vendedor';
                    
                    // Obtener hora
                    const fechaInicioVista = window.formatearFecha ? window.formatearFecha(window.obtenerInicio(cita)) : null;
                    const horaMostrarVista = fechaInicioVista ? fechaInicioVista.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' }) : '';
                    
                    // Obtener precio
                    const precioMostrarVista = window.obtenerMonto && window.obtenerMonto(cita) ? window.formatearMontoVenta(window.obtenerMonto(cita)) : '';
                    
                    // Obtener ubicaci√≥n (Provincia, Cant√≥n, Distrito en ese orden)
                    const ubicacionPartesVista = [];
                    const provinciaIdVista = metadata.provinciaId;
                    const cantonIdVista = metadata.cantonId;
                    const distritoIdVista = metadata.distritoId;
                    
                    // Convertir IDs a nombres usando ubicacionesCR - Orden: Provincia, Cant√≥n, Distrito
                    if (window.ubicacionesCR && provinciaIdVista && window.ubicacionesCR[provinciaIdVista]) {
                        ubicacionPartesVista.push(window.ubicacionesCR[provinciaIdVista].nombre || '');
                        
                        if (cantonIdVista && window.ubicacionesCR[provinciaIdVista].cantones && window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista]) {
                            ubicacionPartesVista.push(window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].nombre || '');
                            
                            if (distritoIdVista && window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].distritos && window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].distritos[distritoIdVista]) {
                                ubicacionPartesVista.push(window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].distritos[distritoIdVista].nombre || '');
                            }
                        }
                    }
                    const ubicacionTextoVista = ubicacionPartesVista.length > 0 ? ubicacionPartesVista.join(', ') : '';
                    
                    // Construir l√≠nea principal: Vendedor + Hora + Precio
                    const infoPrincipal = [];
                    if (vendedorTexto) infoPrincipal.push(vendedorTexto);
                    if (horaMostrarVista) infoPrincipal.push(horaMostrarVista);
                    if (precioMostrarVista) infoPrincipal.push(precioMostrarVista);
                    const textoPrincipal = infoPrincipal.join(' ‚Ä¢ ');
                    
                    // Construir l√≠nea inferior: Ubicaci√≥n + Cliente
                    const lineaInferiorVista = [];
                    if (ubicacionTextoVista) lineaInferiorVista.push(ubicacionTextoVista);
                    if (clienteNombre && clienteNombre !== 'Sin nombre') lineaInferiorVista.push(clienteNombre);
                    
                    citaElement.innerHTML = `
                        ${indicadorGPS}
                        <span>${emojiTurno} ${textoPrincipal}${indicadorEncuesta}</span>
                        ${lineaInferiorVista.length > 0 ? `<div style="font-size: 0.65rem; line-height: 1.2; margin-top: 0.15rem; color: #ffffff; opacity: 0.9;">${lineaInferiorVista.join(' ‚Ä¢ ')}</div>` : ''}
                    `;
                    // GPS ahora se obtiene desde la sucursal, no desde la cita
                    const tieneSucursal = window.esSucursalIndiceValido(cita.metadata?.sucursalIndice);
                    const tituloVendedor = vendedorMostrarVista || 'Sin vendedor';
                    citaElement.title = `Vendedor: ${tituloVendedor}\n${vehiculo}\n${obtenerDescripcion(cita)}\nTurno: ${obtenerTurno(cita)}\nSucursal: ${tieneSucursal ? 'S√≠' : 'No'}`;
                    
                    // Agregar click handler para abrir edici√≥n
                    citaElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (window.abrirModalEdicion) {
                            window.abrirModalEdicion(cita.id);
                        }
                    });
                    
                    dayElement.appendChild(citaElement);
                });
                
                // Agregar funcionalidad de arrastre para crear citas
                let isDragging = false;
                let dragStartY = 0;
                let dragEndY = 0;
                let dragPreview = null;
                
                // Handlers globales para mousemove y mouseup
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    
                    // Calcular posici√≥n relativa al dayElement
                    const rect = dayElement.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    dragEndY = Math.max(0, Math.min(y, dayElement.offsetHeight));
                    
                    actualizarDragPreview();
                    
                    e.preventDefault();
                };
                
                const handleMouseUp = (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    // Remover listeners globales primero
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    
                    // Calcular duraci√≥n basada en el rango arrastrado
                    const alturaCelda = dayElement.offsetHeight;
                    const alturaMinima = 20; // M√≠nimo 20px para considerar un arrastre v√°lido
                    const alturaArrastrada = Math.abs(dragEndY - dragStartY);
                    
                    console.log('üñ±Ô∏è Finalizando arrastre', {
                        alturaCelda,
                        alturaArrastrada,
                        dragStartY,
                        dragEndY
                    });
                    
                    if (alturaArrastrada < alturaMinima) {
                        // Si el arrastre es muy peque√±o, no crear cita
                        if (dragPreview) {
                            dragPreview.remove();
                            dragPreview = null;
                        }
                        return;
                    }
                    
                    // Calcular hora de inicio y duraci√≥n
                    // Asumimos que la celda representa todo el d√≠a (24 horas)
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    
                    // Convertir posici√≥n Y a hora del d√≠a (0-24)
                    const horaInicio = (inicioY / alturaCelda) * 24;
                    const horaFin = (finY / alturaCelda) * 24;
                    const duracionHoras = horaFin - horaInicio;
                    const duracionMinutos = Math.max(15, Math.round(duracionHoras * 60));
                    const duracionRedondeada = Math.max(15, Math.round(duracionMinutos / 15) * 15);
                    
                    // Calcular hora y minuto de inicio
                    const horasInicio = Math.floor(horaInicio);
                    const minutosInicio = Math.round((horaInicio - horasInicio) * 60);
                    const minutosRedondeados = Math.round(minutosInicio / 15) * 15;
                    
                    // Crear fecha con la hora calculada (en hora local)
                    const fechaInicio = new Date(year, month, day, horasInicio, minutosRedondeados, 0, 0);
                    
                    // Formatear para datetime-local en hora local (no UTC)
                    const yearFormatted = fechaInicio.getFullYear();
                    const monthFormatted = String(fechaInicio.getMonth() + 1).padStart(2, '0');
                    const dayFormatted = String(fechaInicio.getDate()).padStart(2, '0');
                    const hoursFormatted = String(fechaInicio.getHours()).padStart(2, '0');
                    const minutesFormatted = String(fechaInicio.getMinutes()).padStart(2, '0');
                    const fechaFormateada = `${yearFormatted}-${monthFormatted}-${dayFormatted}T${hoursFormatted}:${minutesFormatted}`;
                    
                    console.log('‚úÖ Abriendo modal con:', {
                        fechaFormateada,
                        duracionRedondeada,
                        horaInicio: `${horasInicio}:${minutosRedondeados.toString().padStart(2, '0')}`
                    });
                    
                    // Limpiar preview
                    if (dragPreview) {
                        dragPreview.remove();
                        dragPreview = null;
                    }
                    
                    // Abrir modal de nueva cita con datos prellenados
                    abrirModalNuevaCitaDesdeArrastre(fechaFormateada, duracionRedondeada, day, month, year);
                    
                    e.preventDefault();
                };
                
                // Usar captura de eventos para asegurar que se capture antes que otros elementos
                dayElement.addEventListener('mousedown', (e) => {
                    // Solo iniciar arrastre si no se hace click en una cita existente o en el n√∫mero del d√≠a
                    const target = e.target;
                    console.log('üñ±Ô∏è [DEBUG] mousedown detectado', {
                        target: target.tagName,
                        className: target.className,
                        isCitaItem: !!target.closest('.cita-item'),
                        isDayNumber: target.classList.contains('day-number'),
                        day: day
                    });
                    
                    if (target.closest('.cita-item') || target.classList.contains('day-number')) {
                        console.log('üñ±Ô∏è [DEBUG] Click en cita o n√∫mero, ignorando arrastre');
                        return;
                    }
                    
                    console.log('üñ±Ô∏è Iniciando arrastre en d√≠a', day, 'offsetY:', e.offsetY);
                    
                    isDragging = true;
                    dragStartY = e.offsetY;
                    dragEndY = e.offsetY;
                    
                    // Crear preview visual del rango
                    dragPreview = document.createElement('div');
                    dragPreview.className = 'drag-preview';
                    dragPreview.style.position = 'absolute';
                    dragPreview.style.left = '0';
                    dragPreview.style.right = '0';
                    dragPreview.style.backgroundColor = 'rgba(102, 126, 234, 0.3)';
                    dragPreview.style.border = '2px dashed #667eea';
                    dragPreview.style.borderRadius = '4px';
                    dragPreview.style.pointerEvents = 'none';
                    dragPreview.style.zIndex = '1000';
                    dayElement.appendChild(dragPreview);
                    
                    actualizarDragPreview();
                    
                    // Agregar listeners globales para que funcionen incluso fuera del elemento
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    
                    e.stopPropagation();
                    e.preventDefault();
                }, true); // Usar captura
                
                function actualizarDragPreview() {
                    if (!dragPreview) return;
                    
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    const altura = finY - inicioY;
                    
                    dragPreview.style.top = `${inicioY}px`;
                    dragPreview.style.height = `${Math.max(altura, 20)}px`;
                }

                calendarGrid.appendChild(dayElement);
            }

            // Agregar d√≠as del mes siguiente para completar la grilla
            const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                calendarGrid.appendChild(dayElement);
            }
        }

        // Funci√≥n para determinar el turno basado en la hora
        function determinarTurno(horaInicio) {
            if (!horaInicio) return 'Turno 1';
            
            const match = horaInicio.match(/(\d{1,2}):(\d{2})/);
            if (!match) return 'Turno 1';
            
            const hora = parseInt(match[1]);
            const minuto = parseInt(match[2]);
            const horaDecimal = hora + (minuto / 60);
            
            return horaDecimal < 17 ? 'Turno 1' : 'Turno 2';
        }

        // Funci√≥n para obtener el emoji del turno
        function obtenerEmojiTurno(turno) {
            return turno === 'Turno 1' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Funci√≥n para guardar cita editada
        async function guardarCita() {
            if (!selectedCita) return;

            // Definir originalText fuera del try para que est√© disponible en finally
            const btnSave = document.getElementById('btnSaveCitaTop');
            const originalText = '<i class="fas fa-save me-2"></i>Guardar Cambios';

            try {
                // Validar solo campos indispensables
                const clientPhone = document.getElementById('editClientPhone').value.trim();
                const startTime = document.getElementById('editStartTime').value;
                const duration = document.getElementById('editDuration').value;
                const ruta = document.getElementById('editRuta').value;
                const vendedoresSeleccionados = window.vendedoresSeleccionadosEdit || [];

                if (!clientPhone || !startTime || !duration || !ruta) {
                    alert('Por favor completa todos los campos indispensables: Tel√©fono, Fecha y Hora de Inicio, Duraci√≥n y Ruta.');
                    return;
                }
                
                // Campos opcionales
                const clientName = document.getElementById('editClientName').value.trim();
                const montoVentaInput = document.getElementById('editMontoVenta');
                const valorNumerico = montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0';
                const montoVenta = valorNumerico || '0';

                const fechaInicio = new Date(startTime);
                console.log('üîç Hora ingresada por usuario:', startTime);
                console.log('üîç Fecha convertida a objeto Date:', fechaInicio);
                console.log('üîç Fecha en UTC (lo que se guardar√°):', fechaInicio.toISOString());
                
                // Turno eliminado - usar valor por defecto
                const turnoSeleccionado = 'Turno 1';
                const emojiTurno = '‚òÄÔ∏è';
                
                // Calcular hora de fin
                const duracion = parseInt(document.getElementById('editDuration').value);
                const fechaFin = new Date(fechaInicio.getTime() + (duracion * 60000));
                
                // Mostrar indicador de carga (footer y header)
                btnSave.disabled = true;
                btnSave.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                const btnSaveCitaTop = document.getElementById('btnSaveCitaTop');
                if (btnSaveCitaTop) {
                    btnSaveCitaTop.disabled = true;
                    btnSaveCitaTop.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }

                // Convertir fecha a Timestamp GMT-06
                const timestampGMT6 = Timestamp.fromDate(fechaInicio);
                
                // Normalizar tel√©fono usando funci√≥n helper
                const telefonoNormalizado = window.normalizarTelefono(clientPhone);
                if (!telefonoNormalizado) {
                    alert('Por favor ingrese un tel√©fono v√°lido de 8 d√≠gitos');
                    return;
                }
                
                // Generar link de WhatsApp
                const editWhatsApp = document.getElementById('editWhatsApp');
                if (editWhatsApp) {
                    editWhatsApp.value = window.generarLinkWhatsApp(telefonoNormalizado, 'Hola desde Ecoplagas');
                }
                
                // Obtener o crear cliente
                let cliente = await window.buscarCliente(telefonoNormalizado);
                if (!cliente) {
                    cliente = await window.crearCliente(telefonoNormalizado, clientName);
                } else {
                    // Actualizar nombre del cliente si fue modificado
                    if (clientName && clientName.trim()) {
                        await window.actualizarNombreCliente(telefonoNormalizado, clientName.trim());
                        // Actualizar tambi√©n en el objeto cliente local
                        cliente.nombre = clientName.trim();
                    }
                }
                
                // Obtener nombre del cliente para guardarlo en metadata (fallback para renderizado r√°pido)
                const nombreClienteParaMetadata = cliente?.nombre || clientName || '';
                
                // Obtener sucursal seleccionada o crear nueva
                const sucursalSelect = document.getElementById('editSucursal');
                const sucursalSeleccionada = sucursalSelect?.value;
                let sucursalIndice = null;
                
                if (sucursalSeleccionada === 'nueva' || !sucursalSeleccionada) {
                    // Crear nueva sucursal
                    const nombreSucursal = document.getElementById('editNombreSucursal')?.value.trim() || 'Hogar principal';
                    const coordsTexto = document.getElementById('editCoordenadas')?.value.trim();
                    
                    // Intentar parsear coordenadas (opcional)
                    let coordsParsed = null;
                    if (coordsTexto) {
                        if (window.limpiarYExtraerCoordenadas) {
                            coordsParsed = window.limpiarYExtraerCoordenadas(coordsTexto);
                        }
                        // Si no funciona, intentar parseo directo
                        if (!coordsParsed) {
                            const match = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                            if (match) {
                                coordsParsed = {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                };
                            }
                        }
                        
                        // Validar que las coordenadas sean v√°lidas (solo si se ingresaron)
                        if (coordsParsed && (!isNaN(coordsParsed.lat) && !isNaN(coordsParsed.lng))) {
                            // Validar que est√©n dentro de Costa Rica
                            if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(coordsParsed.lat, coordsParsed.lng)) {
                                alert('Las coordenadas deben estar dentro de los l√≠mites de Costa Rica.');
                                return;
                            }
                        } else if (coordsTexto) {
                            // Si se ingres√≥ texto pero no se pudo parsear
                            alert('Las coordenadas GPS ingresadas no son v√°lidas. Por favor, ingrese coordenadas v√°lidas (ej: 9.936672, -84.144741) o deje el campo vac√≠o.');
                            return;
                        }
                    }
                    
                    const provinciaId = document.getElementById('editProvincia')?.value || '';
                    const cantonId = document.getElementById('editCanton')?.value || '';
                    const distritoId = document.getElementById('editDistrito')?.value || '';
                    const direccion = document.getElementById('editDireccion')?.value.trim() || '';
                    const otrasSenas = document.getElementById('editOtrasSenas')?.value.trim() || '';
                    
                    const nuevaSucursal = await window.crearSucursal(
                        telefonoNormalizado,
                        nombreSucursal,
                        coordsParsed,
                        provinciaId,
                        cantonId,
                        distritoId,
                        direccion,
                        otrasSenas
                    );
                    sucursalIndice = nuevaSucursal.indice;
                } else {
                    // Usar sucursal existente - validar que existe
                    const indiceSeleccionado = parseInt(sucursalSeleccionada);
                    
                    // Validar que la sucursal existe en cliente.sucursales[]
                    if (!cliente.sucursales || !cliente.sucursales.includes(indiceSeleccionado)) {
                        alert(`La sucursal seleccionada (√≠ndice ${indiceSeleccionado}) no existe para este cliente. Por favor seleccione una sucursal v√°lida o cree una nueva.`);
                        return;
                    }
                    
                    sucursalIndice = indiceSeleccionado;
                    
                    // Obtener sucursal actual para verificar si tiene GPS
                    const sucursalActual = await window.obtenerSucursalPorIndice(telefonoNormalizado, sucursalIndice);
                    const tieneGPSActual = window.sonCoordenadasValidas(sucursalActual?.coordenadas);
                    
                    // Actualizar sucursal si cambian coordenadas o nombre
                    const coordsTexto = document.getElementById('editCoordenadas')?.value.trim();
                    const nombreSucursal = document.getElementById('editNombreSucursal')?.value.trim();
                    const provinciaId = document.getElementById('editProvincia')?.value || '';
                    const cantonId = document.getElementById('editCanton')?.value || '';
                    const distritoId = document.getElementById('editDistrito')?.value || '';
                    const direccion = document.getElementById('editDireccion')?.value.trim() || '';
                    const otrasSenas = document.getElementById('editOtrasSenas')?.value.trim() || '';
                    
                    const datosActualizacion = {
                        provinciaId: provinciaId,
                        cantonId: cantonId,
                        distritoId: distritoId,
                        direccion: direccion,
                        otrasSenas: otrasSenas
                    };
                    
                    // Procesar coordenadas si se ingresaron
                    let coordsParsed = null;
                    if (coordsTexto) {
                        if (window.limpiarYExtraerCoordenadas) {
                            coordsParsed = window.limpiarYExtraerCoordenadas(coordsTexto);
                        }
                        if (!coordsParsed) {
                            const match = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                            if (match) {
                                coordsParsed = {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                };
                            }
                        }
                        
                        if (coordsParsed && !isNaN(coordsParsed.lat) && !isNaN(coordsParsed.lng)) {
                            // Validar que est√©n dentro de Costa Rica
                            if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(coordsParsed.lat, coordsParsed.lng)) {
                                alert('Las coordenadas deben estar dentro de los l√≠mites de Costa Rica.');
                                return;
                            }
                            
                            // Verificar si se est√° cambiando un GPS existente
                            if (tieneGPSActual) {
                                const latActual = sucursalActual.coordenadas.lat;
                                const lngActual = sucursalActual.coordenadas.lng;
                                const latNueva = coordsParsed.lat;
                                const lngNueva = coordsParsed.lng;
                                
                                // Verificar si las coordenadas son diferentes (con tolerancia de 0.0001)
                                const sonDiferentes = Math.abs(latActual - latNueva) > 0.0001 || Math.abs(lngActual - lngNueva) > 0.0001;
                                
                                if (sonDiferentes) {
                                    const confirmar = confirm(
                                        `‚ö†Ô∏è ADVERTENCIA: Esta sucursal ya tiene coordenadas GPS guardadas (${latActual}, ${lngActual}).\n\n` +
                                        `Est√° intentando cambiarlas a (${latNueva}, ${lngNueva}).\n\n` +
                                        `¬øDesea continuar y actualizar las coordenadas?`
                                    );
                                    if (!confirmar) {
                                        return; // Cancelar si el usuario no confirma
                                    }
                                }
                            }
                            
                            datosActualizacion.coordenadas = {
                                lat: coordsParsed.lat,
                                lng: coordsParsed.lng,
                                texto: `${coordsParsed.lat}, ${coordsParsed.lng}`
                            };
                        } else if (coordsTexto) {
                            alert('Las coordenadas GPS ingresadas no son v√°lidas. Por favor, ingrese coordenadas v√°lidas (ej: 9.936672, -84.144741) o deje el campo vac√≠o.');
                            return;
                        }
                    } else if (tieneGPSActual) {
                        // Si se borra el campo de coordenadas pero hab√≠a GPS, preguntar si desea eliminarlo
                        const confirmar = confirm(
                            `‚ö†Ô∏è ADVERTENCIA: Esta sucursal tiene coordenadas GPS guardadas (${sucursalActual.coordenadas.lat}, ${sucursalActual.coordenadas.lng}).\n\n` +
                            `El campo de coordenadas est√° vac√≠o. ¬øDesea eliminar las coordenadas GPS de esta sucursal?`
                        );
                        if (confirmar) {
                            datosActualizacion.coordenadas = null;
                        } else {
                            // Restaurar las coordenadas originales en el campo
                            document.getElementById('editCoordenadas').value = `${sucursalActual.coordenadas.lat}, ${sucursalActual.coordenadas.lng}`;
                            return;
                        }
                    }
                    
                    if (nombreSucursal) {
                        datosActualizacion.nombre = nombreSucursal;
                    }
                    
                    await window.actualizarSucursal(telefonoNormalizado, sucursalIndice, datosActualizacion);
                }

                // Obtener servicios seleccionados
                const serviciosSeleccionados = window.obtenerServiciosSeleccionados('edit');
                
                // Obtener plagas seleccionadas
                const plagasSeleccionadas = window.obtenerPlagasSeleccionadas('edit');
                
                // Obtener productos seleccionados
                const productosSeleccionados = window.obtenerProductosSeleccionados('edit');
                
                // Obtener equipo seleccionado
                const equipoSeleccionado = window.obtenerEquipoSeleccionado('edit');
                
                // Obtener certificados
                const certificadosTexto = document.getElementById('editCertificados')?.value.trim() || '';
                
                // Obtener costo del servicio (extraer valor num√©rico sin formato)
                const costoServicioInput = document.getElementById('editCostoServicio');
                const valorNumericoCosto = costoServicioInput ? window.extraerValorNumerico(costoServicioInput.value) : '0';
                const costoServicio = parseInt(valorNumericoCosto) || 0;
                
                // Obtener valores de ubicaci√≥n
                const provinciaId = document.getElementById('editProvincia')?.value || '';
                const cantonId = document.getElementById('editCanton')?.value || '';
                const distritoId = document.getElementById('editDistrito')?.value || '';
                
                // Actualizar todos los campos, incluyendo los "invariables" ya que el usuario quiere poder editarlos
                await updateDoc(doc(window.db, 'citas', selectedCita.id), {
                    telefono: telefonoNormalizado, // Fuente de verdad: tel√©fono en ra√≠z
                    inicio_gmt6: timestampGMT6,  // Permitir editar fecha/hora
                    duracion_minutos: duracion,  // Permitir editar duraci√≥n
                    metadata: {
                        // cliente_nombre: guardado como fallback para renderizado r√°pido (el nombre oficial est√° en clientes/{telefono}.nombre)
                        cliente_nombre: nombreClienteParaMetadata,
                        // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                        sucursalIndice: sucursalIndice, // √çndice de la sucursal (0, 1, 2, 3, ...) o null si no tiene sucursal
                        ruta: window.validarRuta ? window.validarRuta(document.getElementById('editRuta')?.value || 'Sin asignar') : (document.getElementById('editRuta')?.value || 'Sin asignar'),
                        estado: document.getElementById('editStatus')?.value || 'agendada',
                        monto: parseInt(montoVenta) || 0,
                        costo_servicio: costoServicio, // Costo del servicio (siempre presente)
                        vendedores: vendedoresSeleccionados, // Array de usernames
                        servicios: serviciosSeleccionados, // Array de objetos {id, precio} con precios personalizados por cita
                        plagas: plagasSeleccionadas, // Array de nombres de plagas
                        productos: productosSeleccionados, // Array de IDs de productos
                        equipo: equipoSeleccionado, // Array de IDs de equipo
                        certificados: certificadosTexto, // Texto para generar certificados
                        direccion: document.getElementById('editDireccion')?.value.trim() || '', // Link de Waze/Google Maps
                        whatsapp: document.getElementById('editWhatsApp')?.value.trim() || '', // Link de WhatsApp
                        // coordenadas removido - las coordenadas pertenecen solo a la sucursal, no a la cita
                        // Para obtener coordenadas: buscar sucursal por sucursalIndice y usar sucursal.coordenadas
                        otras_se√±as: document.getElementById('editOtrasSenas')?.value.trim() || '',
                        observaciones: document.getElementById('editDescription')?.value.trim() || '',
                    turno: turnoSeleccionado,
                        turno_emoji: emojiTurno,
                        provinciaId: provinciaId,
                        cantonId: cantonId,
                        distritoId: distritoId,
                        metodoPago: document.getElementById('editMetodoPago')?.value || '',
                        numeroFactura: document.getElementById('editNumeroFactura')?.value.trim() || '',
                        // Campos de la secci√≥n "R√°pido"
                        hora_rapida: horaRapida,
                        precio_rapido: precioRapido,
                        vendedor_rapido: vendedorRapido,
                        canton_rapido: cantonRapido,
                        distrito_rapido: distritoRapido,
                        provincia_rapida: provinciaRapida,
                        nombre_cliente_rapido: nombreClienteRapido
                    },
                    fecha_actualizacion: serverTimestamp()
                });

                bootstrap.Modal.getInstance(document.getElementById('editCitaModal')).hide();
                await cargarDatos();
                
                // Mostrar notificaci√≥n de √©xito
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Cita actualizada exitosamente';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('Error guardando cita:', error);
                alert('Error guardando cita: ' + error.message);
            } finally {
                // Restaurar botones (footer y header)
                console.log('üîß Restaurando bot√≥n...');
                if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.innerHTML = originalText;
                    console.log('‚úÖ Bot√≥n restaurado correctamente');
                } else {
                    console.error('‚ùå No se encontr√≥ el bot√≥n btnSaveCita');
                }
                const btnSaveCitaTop = document.getElementById('btnSaveCitaTop');
                if (btnSaveCitaTop) {
                    btnSaveCitaTop.disabled = false;
                    btnSaveCitaTop.innerHTML = originalText;
                }
            }
        }

        // Funci√≥n para guardar nueva cita
        async function guardarNuevaCita() {
            const btnSave = document.getElementById('btnSaveNewCitaTop');
            const originalText = '<i class="fas fa-save me-2"></i>Guardar Cita';

            try {
                // Validar campos requeridos
                const clientPhone = document.getElementById('newClientPhone').value.trim();
                const startTime = document.getElementById('newStartTime').value;
                const duration = document.getElementById('newDuration').value;
                const ruta = document.getElementById('newRuta').value;
                const vendedoresSeleccionados = window.obtenerVendedoresSeleccionados ? window.obtenerVendedoresSeleccionados('newVendedoresContainer') : [];

                if (!clientPhone || !startTime || !duration || !ruta) {
                    alert('Por favor completa todos los campos indispensables: Tel√©fono, Fecha y Hora de Inicio, Duraci√≥n y Ruta.');
                    return;
                }
                
                const clientName = document.getElementById('newClientName').value.trim();
                const montoVentaInput = document.getElementById('newMontoVenta');
                const valorNumerico = montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0';
                const montoVenta = valorNumerico || '0';

                const fechaInicio = new Date(startTime);
                console.log('üîç Hora ingresada por usuario:', startTime);
                console.log('üîç Fecha convertida a objeto Date:', fechaInicio);
                console.log('üîç Fecha en UTC (lo que se guardar√°):', fechaInicio.toISOString());
                
                // Turno eliminado - usar valor por defecto
                const turnoSeleccionado = 'Turno 1';
                const emojiTurno = '‚òÄÔ∏è';
                
                // Calcular hora de fin
                const duracion = parseInt(document.getElementById('newDuration').value);
                const fechaFin = new Date(fechaInicio.getTime() + (duracion * 60000));
                
                // Mostrar indicador de carga (footer y header)
                if (btnSave) {
                    btnSave.disabled = true;
                    btnSave.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }
                const btnSaveNewCitaTop = document.getElementById('btnSaveNewCitaTop');
                if (btnSaveNewCitaTop) {
                    btnSaveNewCitaTop.disabled = true;
                    btnSaveNewCitaTop.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }

                // Convertir fecha a Timestamp GMT-06
                const timestampGMT6 = Timestamp.fromDate(fechaInicio);
                
                // Normalizar tel√©fono usando funci√≥n helper
                const telefonoNormalizado = window.normalizarTelefono(clientPhone);
                if (!telefonoNormalizado) {
                    alert('Por favor ingrese un tel√©fono v√°lido de 8 d√≠gitos');
                    return;
                }
                
                // Generar link de WhatsApp
                const newWhatsApp = document.getElementById('newWhatsApp');
                if (newWhatsApp) {
                    newWhatsApp.value = window.generarLinkWhatsApp(telefonoNormalizado, 'Hola desde Ecoplagas');
                }
                
                // Obtener o crear cliente
                let cliente = await window.buscarCliente(telefonoNormalizado);
                if (!cliente) {
                    cliente = await window.crearCliente(telefonoNormalizado, clientName);
                } else {
                    // Actualizar nombre del cliente si fue modificado
                    if (clientName && clientName.trim()) {
                        await window.actualizarNombreCliente(telefonoNormalizado, clientName.trim());
                        // Actualizar tambi√©n en el objeto cliente local
                        cliente.nombre = clientName.trim();
                    }
                }
                
                // Obtener nombre del cliente para guardarlo en metadata (fallback para renderizado r√°pido)
                const nombreClienteParaMetadata = cliente?.nombre || clientName || '';
                
                // Obtener sucursal seleccionada o crear nueva
                const sucursalSelect = document.getElementById('newSucursal');
                const sucursalSeleccionada = sucursalSelect?.value;
                let sucursalIndice = null;
                
                if (sucursalSeleccionada === 'nueva' || !sucursalSeleccionada) {
                    // Crear nueva sucursal
                    const nombreSucursal = document.getElementById('newNombreSucursal')?.value.trim() || 'Hogar principal';
                    const coordsTexto = document.getElementById('newCoordenadas')?.value.trim();
                    
                    // Intentar parsear coordenadas (opcional)
                    let coordsParsed = null;
                    if (coordsTexto) {
                        if (window.limpiarYExtraerCoordenadas) {
                            coordsParsed = window.limpiarYExtraerCoordenadas(coordsTexto);
                        }
                        // Si no funciona, intentar parseo directo
                        if (!coordsParsed) {
                            const match = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                            if (match) {
                                coordsParsed = {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                };
                            }
                        }
                        
                        // Validar que las coordenadas sean v√°lidas (solo si se ingresaron)
                        if (coordsParsed && (!isNaN(coordsParsed.lat) && !isNaN(coordsParsed.lng))) {
                            // Validar que est√©n dentro de Costa Rica
                            if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(coordsParsed.lat, coordsParsed.lng)) {
                                alert('Las coordenadas deben estar dentro de los l√≠mites de Costa Rica.');
                                return;
                            }
                        } else if (coordsTexto) {
                            // Si se ingres√≥ texto pero no se pudo parsear
                            alert('Las coordenadas GPS ingresadas no son v√°lidas. Por favor, ingrese coordenadas v√°lidas (ej: 9.936672, -84.144741) o deje el campo vac√≠o.');
                            return;
                        }
                    }
                    
                    const provinciaId = document.getElementById('newProvincia')?.value || '';
                    const cantonId = document.getElementById('newCanton')?.value || '';
                    const distritoId = document.getElementById('newDistrito')?.value || '';
                    const direccion = document.getElementById('newDireccion')?.value.trim() || '';
                    const otrasSenas = document.getElementById('newOtrasSenas')?.value.trim() || '';
                    
                    const nuevaSucursal = await window.crearSucursal(
                        telefonoNormalizado,
                        nombreSucursal,
                        coordsParsed,
                        provinciaId,
                        cantonId,
                        distritoId,
                        direccion,
                        otrasSenas
                    );
                    sucursalIndice = nuevaSucursal.indice;
                } else {
                    // Usar sucursal existente - validar que existe
                    const indiceSeleccionado = parseInt(sucursalSeleccionada);
                    
                    // Validar que la sucursal existe en cliente.sucursales[]
                    if (!cliente.sucursales || !cliente.sucursales.includes(indiceSeleccionado)) {
                        alert(`La sucursal seleccionada (√≠ndice ${indiceSeleccionado}) no existe para este cliente. Por favor seleccione una sucursal v√°lida o cree una nueva.`);
                        return;
                    }
                    
                    sucursalIndice = indiceSeleccionado;
                }

                // Obtener servicios seleccionados
                const serviciosSeleccionados = window.serviciosSeleccionadosNew || [];
                
                // Obtener plagas seleccionadas
                const plagasSeleccionadas = window.obtenerPlagasSeleccionadas('new');
                
                // Obtener productos seleccionados
                const productosSeleccionados = window.productosSeleccionadosNew || [];
                
                // Obtener equipo seleccionado
                const equipoSeleccionado = window.obtenerEquipoSeleccionado('new');
                
                // Obtener certificados
                const certificadosTexto = document.getElementById('newCertificados')?.value.trim() || '';
                
                // Obtener costo del servicio (extraer valor num√©rico sin formato)
                const costoServicioInput = document.getElementById('newCostoServicio');
                const valorNumericoCosto = costoServicioInput ? window.extraerValorNumerico(costoServicioInput.value) : '0';
                const costoServicio = parseInt(valorNumericoCosto) || 0;
                
                // Obtener valores de ubicaci√≥n
                const provinciaId = document.getElementById('newProvincia')?.value || '';
                const cantonId = document.getElementById('newCanton')?.value || '';
                const distritoId = document.getElementById('newDistrito')?.value || '';
                
                // Funci√≥n helper para parsear coordenadas
                function parsearCoordenadas(texto) {
                    const match = texto.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                    if (match) {
                        return {
                            lat: parseFloat(match[1]),
                            lng: parseFloat(match[2])
                        };
                    }
                    return null;
                }
                
                // Crear nueva cita
                const nuevaCita = {
                    telefono: telefonoNormalizado, // Fuente de verdad: tel√©fono en ra√≠z
                    inicio_gmt6: timestampGMT6,
                    duracion_minutos: duracion,
                    metadata: {
                        // cliente_nombre: guardado como fallback para renderizado r√°pido (el nombre oficial est√° en clientes/{telefono}.nombre)
                        cliente_nombre: nombreClienteParaMetadata,
                        // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                        sucursalIndice: sucursalIndice, // √çndice de la sucursal (0, 1, 2, 3, ...) o null si no tiene sucursal
                        ruta: window.validarRuta ? window.validarRuta(document.getElementById('newRuta')?.value || 'Sin asignar') : (document.getElementById('newRuta')?.value || 'Sin asignar'),
                        estado: document.getElementById('newStatus')?.value || 'agendada', // Opcional, por defecto 'agendada'
                        monto: parseInt(montoVenta) || 0,
                        costo_servicio: costoServicio,
                        vendedores: vendedoresSeleccionados,
                        servicios: serviciosSeleccionados,
                        plagas: plagasSeleccionadas, // Array de nombres de plagas
                        productos: productosSeleccionados,
                        equipo: equipoSeleccionado, // Array de IDs de equipo
                        certificados: certificadosTexto, // Texto para generar certificados
                        direccion: document.getElementById('newDireccion')?.value.trim() || '',
                        whatsapp: document.getElementById('newWhatsApp')?.value.trim() || '', // Link de WhatsApp
                        // coordenadas removido - las coordenadas pertenecen solo a la sucursal, no a la cita
                        // Para obtener coordenadas: buscar sucursal por sucursalIndice y usar sucursal.coordenadas
                        otras_se√±as: document.getElementById('newOtrasSenas')?.value.trim() || '',
                        observaciones: document.getElementById('newDescription')?.value.trim() || '',
                        turno: turnoSeleccionado,
                        turno_emoji: emojiTurno,
                        provinciaId: provinciaId,
                        cantonId: cantonId,
                        distritoId: distritoId,
                        metodoPago: document.getElementById('newMetodoPago')?.value || '',
                        numeroFactura: document.getElementById('newNumeroFactura')?.value.trim() || ''
                    },
                    fecha_creacion: serverTimestamp(),
                    fecha_actualizacion: serverTimestamp(),
                    version_esquema: 1
                };

                await addDoc(collection(window.db, 'citas'), nuevaCita);

                bootstrap.Modal.getInstance(document.getElementById('nuevaCitaModal')).hide();
                await cargarDatos();
                
                // Mostrar notificaci√≥n de √©xito
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Cita creada exitosamente';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('Error guardando nueva cita:', error);
                alert('Error guardando nueva cita: ' + error.message);
            } finally {
                // Restaurar botones (footer y header)
                if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.innerHTML = originalText;
                }
                const btnSaveNewCitaTop = document.getElementById('btnSaveNewCitaTop');
                if (btnSaveNewCitaTop) {
                    btnSaveNewCitaTop.disabled = false;
                    btnSaveNewCitaTop.innerHTML = originalText;
                }
            }
        }

        // Funci√≥n para eliminar cita
        async function eliminarCita() {
            if (!selectedCita) return;

            const confirmacion = confirm(`¬øEst√°s seguro de que deseas eliminar la cita de ${window.obtenerClienteNombre(selectedCita)}?`);
            if (!confirmacion) return;

            try {
                const btnDelete = document.getElementById('btnDeleteCita');
                const originalText = '<i class="fas fa-trash me-2"></i>Eliminar Cita';
                btnDelete.disabled = true;
                btnDelete.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';

                await deleteDoc(doc(window.db, 'citas', selectedCita.id));

                bootstrap.Modal.getInstance(document.getElementById('editCitaModal')).hide();
                await cargarDatos();
                
                // Mostrar notificaci√≥n de √©xito
                const notification = document.createElement('div');
                notification.className = 'alert alert-danger position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-trash me-2"></i>Cita eliminada exitosamente';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('Error eliminando cita:', error);
                alert('Error eliminando cita: ' + error.message);
            } finally {
                // Restaurar bot√≥n
                const btnDelete = document.getElementById('btnDeleteCita');
                btnDelete.disabled = false;
                btnDelete.innerHTML = '<i class="fas fa-trash me-2"></i>Eliminar Cita';
            }
        }

        // Event listeners eliminados para btnPrevMonth, btnNextMonth, btnToday

        if (datePicker) {
        datePicker.addEventListener('change', async () => {
            // Crear fecha en zona horaria local (no UTC)
            const fechaString = datePicker.value; // Formato: YYYY-MM-DD
            const [year, month, day] = fechaString.split('-').map(Number);
            const nuevaFecha = new Date(year, month - 1, day, 12, 0, 0); // Mediod√≠a para evitar problemas de zona horaria
            currentDate = nuevaFecha;
            diaSeleccionado = nuevaFecha;
            
            // Actualizar botones de d√≠as
            generarBotonesDiasMes(nuevaFecha);
            
            console.log('üîç DatePicker cambi√≥:', {
                valor: fechaString,
                fechaCreada: nuevaFecha.toString(),
                diaSeleccionado: diaSeleccionado.toString()
            });
            
                if (vistaActual === 'cronograma') {
                await generarCronograma();
            }
        });
        }
        
        // Inicializar botones de d√≠as al cargar
        if (diaSeleccionado) {
            generarBotonesDiasMes(diaSeleccionado);
        }

        if (searchInput) {
            searchInput.addEventListener('input', async () => {
                aplicarFiltros();
                if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }

        if (vehicleFilter) {
            vehicleFilter.addEventListener('change', async () => {
                aplicarFiltros();
                if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }

        if (statusFilter) {
            statusFilter.addEventListener('change', async () => {
                aplicarFiltros();
                if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }

        // Funci√≥n para generar id_encuesta alfanum√©rico √∫nico (m√°ximo 9 caracteres)
        // Usa base36 (0-9, a-z) para generar IDs cortos pero dif√≠ciles de adivinar
        window.generarIdEncuestaUnico = async function() {
            const db = window.db;
            const maxIntentos = 10; // M√°ximo de intentos para encontrar un ID √∫nico
            const longitudId = 9; // M√°ximo 9 caracteres alfanum√©ricos
            
            for (let intento = 0; intento < maxIntentos; intento++) {
                // Generar n√∫mero aleatorio grande y convertir a base36
                // Base36 usa 0-9 y a-z, as√≠ que 9 caracteres = 36^9 = ~101 trillones de posibilidades
                const numeroAleatorio = Math.floor(Math.random() * Math.pow(36, longitudId));
                const idEncuesta = numeroAleatorio.toString(36).padStart(longitudId, '0').substring(0, longitudId);
                
                // Verificar si ya existe en encuestas_id
                const encuestaIdRef = doc(db, 'encuestas_id', idEncuesta);
                const encuestaIdSnap = await getDoc(encuestaIdRef);
                
                if (!encuestaIdSnap.exists()) {
                    console.log(`‚úÖ ID √∫nico generado: ${idEncuesta} (intento ${intento + 1})`);
                    return idEncuesta;
                }
                
                console.log(`‚ö†Ô∏è ID ${idEncuesta} ya existe, intentando otro...`);
            }
            
            // Si no se encontr√≥ un ID √∫nico despu√©s de maxIntentos, usar timestamp como fallback
            console.warn('‚ö†Ô∏è No se pudo generar ID √∫nico despu√©s de varios intentos, usando timestamp');
            const timestampBase36 = Date.now().toString(36).substring(0, longitudId);
            return timestampBase36;
        };
        
        window.generarLinkEncuesta = async function(cita) {
            if (!cita) {
                console.error('‚ùå No se puede generar link: cita no proporcionada');
                return null;
            }
            
            const telefono = cita.telefono || '';
            if (!telefono) {
                console.warn('‚ö†Ô∏è No se puede generar link: tel√©fono no disponible');
                return null;
            }
            
            const fechaInicio = window.formatearFecha(cita.inicio_gmt6);
            if (!fechaInicio) {
                console.error('‚ùå No se puede generar link: fecha inv√°lida');
                return null;
            }
            
            try {
                // Generar id_encuesta √∫nico
                const idEncuesta = await window.generarIdEncuestaUnico();
                if (idEncuesta === null) {
                    console.error('‚ùå No se pudo generar ID √∫nico para la encuesta');
                    return null;
                }
                
                // Normalizar tel√©fono (mantener formato completo con 506)
                let telefonoNormalizado = telefono.replace(/\D/g, '');
                if (!telefonoNormalizado.startsWith('506')) {
                    telefonoNormalizado = '506' + telefonoNormalizado;
                }
                
                // Convertir fecha a Timestamp
                const fechaTimestamp = fechaInicio instanceof Date 
                    ? Timestamp.fromDate(fechaInicio)
                    : Timestamp.fromMillis(fechaInicio);
                
                // Guardar en encuestas_id (usando id_encuesta como ID del documento)
                const encuestaIdRef = doc(db, 'encuestas_id', idEncuesta);
                await setDoc(encuestaIdRef, {
                    id_encuesta: idEncuesta,
                    telefono: telefonoNormalizado,
                    fecha_servicio: fechaTimestamp,
                    fecha_creacion: serverTimestamp(),
                    cita_id: cita.id || null
                });
                
                console.log(`‚úÖ Mapeo guardado en encuestas_id/${idEncuesta}`);
                
                // Actualizar el mapa de links de encuestas en memoria
                let telefonoParaMapa = telefonoNormalizado.replace(/\D/g, '');
                if (telefonoParaMapa.startsWith('506')) {
                    telefonoParaMapa = telefonoParaMapa.substring(3);
                }
                const fechaTimestampMillis = fechaTimestamp.toMillis ? fechaTimestamp.toMillis() : (fechaTimestamp.seconds * 1000);
                const clave = `${telefonoParaMapa}_${fechaTimestampMillis}`;
                mapaLinksEncuestas.set(clave, idEncuesta);
                console.log(`‚úÖ Mapa de links de encuestas actualizado para cita ${cita.id}`);
                
                // Regenerar la vista actual para mostrar el check
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                } else if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                }
                
                // Generar URL con solo el id_encuesta
                const baseUrl = window.location.origin + '/encuesta.html';
                const url = `${baseUrl}?e=${idEncuesta}`;
                
                console.log('‚úÖ Link de encuesta generado:', url);
                return url;
            } catch (error) {
                console.error('‚ùå Error generando link de encuesta:', error);
                return null;
            }
        };
        
        // Funci√≥n para manejar el bot√≥n de encuesta (simplificada: copia directamente)
        async function manejarBotonEncuesta() {
            // window.selectedCita puede ser el objeto completo o el ID
            let cita = null;
            
            if (!window.selectedCita) {
                return;
            }
            
            // Si selectedCita es un string (ID), buscar la cita
            if (typeof window.selectedCita === 'string') {
                cita = window.todasLasCitas.find(c => c.id === window.selectedCita);
            } else {
                // Si es un objeto, usarlo directamente
                cita = window.selectedCita;
            }
            
            if (!cita) {
                return;
            }
            
            try {
                // Esperar a que se genere el link (ahora es async porque genera hash)
                const linkEncuesta = await window.generarLinkEncuesta(cita);
                if (!linkEncuesta) {
                    console.warn('‚ö†Ô∏è No se pudo generar el link de encuesta');
                    return;
                }
                
                console.log('üìã Link generado, copiando al portapapeles:', linkEncuesta);
                
                // Crear mensaje completo para WhatsApp
                const mensajeEncuesta = `Nos apoyar√≠a con una encuesta de satisfacci√≥n con el objetivo de mejorar o reforzar √°reas de oportunidad en el siguiente link:\n\n${linkEncuesta}`;
                
                // Copiar mensaje completo al portapapeles
                await navigator.clipboard.writeText(mensajeEncuesta);
                console.log('‚úÖ Mensaje con link copiado al portapapeles exitosamente');
            } catch (err) {
                console.error('‚ùå Error generando o copiando link de encuesta:', err);
            }
        }
        
        // Los datos se cargan autom√°ticamente al inicializar
        // btnSaveCita movido al header como btnSaveCitaTop
        document.getElementById('btnDeleteCita').addEventListener('click', eliminarCita);
        // Funci√≥n para manejar el bot√≥n de justificar sin encuesta
        async function manejarJustificarSinEncuesta() {
            if (!window.selectedCita) {
                console.warn('‚ö†Ô∏è No hay cita seleccionada');
                return;
            }

            let cita = null;
            if (typeof window.selectedCita === 'string') {
                cita = window.todasLasCitas.find(c => c.id === window.selectedCita);
            } else {
                cita = window.selectedCita;
            }

            if (!cita || !cita.id) {
                console.error('‚ùå No se pudo encontrar la cita');
                return;
            }

            // Verificar si ya existe justificaci√≥n
            const justificacionExistente = obtenerJustificacion(cita);
            
            // Mostrar modal de justificaci√≥n
            const modalJustificar = document.getElementById('modalJustificarSinEncuesta');
            const textareaJustificacion = document.getElementById('justificacionSinEncuesta');
            const divJustificacionExistente = document.getElementById('justificacionExistente');
            const textoJustificacionExistente = document.getElementById('textoJustificacionExistente');

            if (justificacionExistente) {
                // Mostrar justificaci√≥n existente
                textoJustificacionExistente.textContent = justificacionExistente;
                divJustificacionExistente.style.display = 'block';
                textareaJustificacion.value = justificacionExistente;
            } else {
                // Ocultar justificaci√≥n existente
                divJustificacionExistente.style.display = 'none';
                textareaJustificacion.value = '';
            }

            const modal = new bootstrap.Modal(modalJustificar);
            modal.show();

            // Guardar referencia de la cita en el modal
            modalJustificar.dataset.citaId = cita.id;
        }

        // Event listener para bot√≥n de justificar sin encuesta
        document.getElementById('btnJustificarSinEncuesta').addEventListener('click', async (e) => {
            e.preventDefault();
            await manejarJustificarSinEncuesta();
        });

        // Event listener para guardar justificaci√≥n
        document.getElementById('btnGuardarJustificacion').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const modalJustificar = document.getElementById('modalJustificarSinEncuesta');
            const citaId = modalJustificar.dataset.citaId;
            const justificacion = document.getElementById('justificacionSinEncuesta').value.trim();

            if (!citaId) {
                alert('Error: No se encontr√≥ la cita');
                return;
            }

            if (!justificacion) {
                alert('Por favor, ingrese una justificaci√≥n');
                return;
            }

            try {
                // Guardar justificaci√≥n en Firestore
                const justificacionRef = doc(window.db, 'justificaciones_sin_encuesta', citaId);
                await setDoc(justificacionRef, {
                    cita_id: citaId,
                    justificacion: justificacion,
                    fecha_creacion: serverTimestamp(),
                    fecha_actualizacion: serverTimestamp()
                }, { merge: true });

                // Actualizar mapa en memoria
                mapaJustificacionesSinEncuesta.set(citaId, justificacion);

                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(modalJustificar);
                modal.hide();

                // Regenerar vista actual
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                } else if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                }

                console.log('‚úÖ Justificaci√≥n guardada exitosamente');
            } catch (error) {
                console.error('‚ùå Error guardando justificaci√≥n:', error);
                alert('Error al guardar la justificaci√≥n. Por favor, intente nuevamente.');
            }
        });

        // Event listener para bot√≥n de encuesta (ahora en el header)
        const btnEnviarEncuesta = document.getElementById('btnEnviarEncuesta');
        if (btnEnviarEncuesta) {
            btnEnviarEncuesta.addEventListener('click', async (e) => {
                e.preventDefault();
                await manejarBotonEncuesta();
            });
        }
        
        // Event listeners para botones del header (editar cita)
        const btnSaveCitaTop = document.getElementById('btnSaveCitaTop');
        if (btnSaveCitaTop) {
            btnSaveCitaTop.addEventListener('click', guardarCita);
        }
        
        // Event listener para bot√≥n del header (nueva cita)
        const btnSaveNewCitaTop = document.getElementById('btnSaveNewCitaTop');
        if (btnSaveNewCitaTop) {
            btnSaveNewCitaTop.addEventListener('click', guardarNuevaCita);
        }
        
        // Event listeners para botones adicionales de Nueva Cita
        const btnDescargarProformaNew = document.getElementById('btnDescargarProformaNew');
        if (btnDescargarProformaNew) {
            btnDescargarProformaNew.addEventListener('click', async () => {
                btnDescargarProformaNew.disabled = true;
                btnDescargarProformaNew.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
                try {
                    await window.generarProformaPNG();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al generar la proforma: ' + error.message);
                } finally {
                    btnDescargarProformaNew.disabled = false;
                    btnDescargarProformaNew.innerHTML = '<i class="fas fa-download me-2"></i>Descargar Proforma PNG';
                }
            });
        }
        
        const btnJustificarSinEncuestaNew = document.getElementById('btnJustificarSinEncuestaNew');
        if (btnJustificarSinEncuestaNew) {
            btnJustificarSinEncuestaNew.addEventListener('click', async (e) => {
                e.preventDefault();
                await manejarJustificarSinEncuesta();
            });
        }
        
        const btnEnviarEncuestaNew = document.getElementById('btnEnviarEncuestaNew');
        if (btnEnviarEncuestaNew) {
            btnEnviarEncuestaNew.addEventListener('click', async (e) => {
                e.preventDefault();
                await manejarBotonEncuesta();
            });
        }
        
        const btnDeleteCitaNew = document.getElementById('btnDeleteCitaNew');
        if (btnDeleteCitaNew) {
            btnDeleteCitaNew.addEventListener('click', eliminarCita);
        }
        
        // Funci√≥n para abrir modal de nueva cita desde arrastre en cronograma
        async function abrirModalNuevaCitaDesdeArrastreCronograma(fechaInicio, duracion, ruta) {
            // Prellenar campos del formulario
            const newStartTime = document.getElementById('newStartTime');
            const newDuration = document.getElementById('newDuration');
            const newRuta = document.getElementById('newRuta');
            
            if (newStartTime) newStartTime.value = fechaInicio;
            if (newDuration) {
                // Seleccionar la opci√≥n m√°s cercana
                const opcionesDuracion = [15, 30, 45, 60, 75, 90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345, 360, 375, 390, 405, 420, 435, 450, 465, 480, 540, 600, 660, 720];
                let duracionSeleccionada = 60; // Valor por defecto
                for (let i = 0; i < opcionesDuracion.length; i++) {
                    if (duracion <= opcionesDuracion[i]) {
                        duracionSeleccionada = opcionesDuracion[i];
                        break;
                    }
                }
                if (duracion > 720) duracionSeleccionada = 720;
                newDuration.value = duracionSeleccionada;
            }
            if (newRuta) newRuta.value = ruta; // Usar la ruta del timeline donde se hizo el arrastre
            
            // Limpiar otros campos (solo los que existen)
            const newClientName = document.getElementById('newClientName');
            const newClientPhone = document.getElementById('newClientPhone');
            const newCoordenadas = document.getElementById('newCoordenadas');
            const newOtrasSenas = document.getElementById('newOtrasSenas');
            const newStatus = document.getElementById('newStatus');
            const newMontoVenta = document.getElementById('newMontoVenta');
            const newCostoServicio = document.getElementById('newCostoServicio');
            const newDescription = document.getElementById('newDescription');
            
            if (newClientName) newClientName.value = '';
            if (newClientPhone) newClientPhone.value = '';
            if (newCoordenadas) newCoordenadas.value = '';
            if (newOtrasSenas) newOtrasSenas.value = '';
            if (newStatus) newStatus.value = 'agendada';
            if (newMontoVenta) newMontoVenta.value = '';
            if (newCostoServicio) {
                const costoServicioFormateado = window.formatearMontoVenta('20000');
                newCostoServicio.value = costoServicioFormateado;
            }
            if (newDescription) newDescription.value = '';
            
            // Limpiar selecciones de vendedores, servicios y productos
            window.vendedoresSeleccionadosNew = [];
            window.serviciosSeleccionadosNew = [];
            window.productosSeleccionadosNew = [];
            
            const newVendedoresSelected = document.getElementById('newVendedoresSelected');
            const newServiciosSelected = document.getElementById('newServiciosSelected');
            const newProductosSelected = document.getElementById('newProductosSelected');
            
            if (newVendedoresSelected) newVendedoresSelected.innerHTML = '';
            // Renderizar tabla de servicios (vac√≠a inicialmente)
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('new');
            }
            if (newProductosSelected) newProductosSelected.innerHTML = '';
            
            // Limpiar campos de b√∫squeda
            const newVendedorSearch = document.getElementById('newVendedorSearch');
            const newServicioSearch = document.getElementById('newServicioSearch');
            const newProductoSearch = document.getElementById('newProductoSearch');
            
            if (newVendedorSearch) newVendedorSearch.value = '';
            if (newServicioSearch) newServicioSearch.value = '';
            if (newProductoSearch) newProductoSearch.value = '';
            
            // Ocultar resultados de b√∫squeda
            const newVendedoresResults = document.getElementById('newVendedoresResults');
            const newServiciosResults = document.getElementById('newServiciosResults');
            const newProductosResults = document.getElementById('newProductosResults');
            
            if (newVendedoresResults) newVendedoresResults.style.display = 'none';
            if (newServiciosResults) newServiciosResults.style.display = 'none';
            if (newProductosResults) newProductosResults.style.display = 'none';
            
            // Inicializar b√∫squedas si no est√°n inicializadas
            if (window.empleados && window.empleados.length > 0 && window.inicializarBusquedaVendedores) {
                window.inicializarBusquedaVendedores('new');
            }
            if (window.todosLosServicios && window.todosLosServicios.length > 0 && window.inicializarBusquedaServicios) {
                window.inicializarBusquedaServicios('new');
            }
            if (window.todosLosProductos && window.todosLosProductos.length > 0 && window.inicializarBusquedaProductos) {
                window.inicializarBusquedaProductos('new');
            }
            // Inicializar b√∫squeda de plagas
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('new');
            }
            // Inicializar b√∫squeda de equipo
            if (!window.todosLosEquipos || window.todosLosEquipos.length === 0) {
                await window.cargarEquipo();
            }
            if (window.inicializarBusquedaEquipo) {
                window.inicializarBusquedaEquipo('new');
            }
            
            // Limpiar campo de certificados
            const newCertificados = document.getElementById('newCertificados');
            if (newCertificados) newCertificados.value = '';
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('nuevaCitaModal'));
            modal.show();
            
            // Actualizar resumen financiero cuando el modal se muestre
            const modalElement = document.getElementById('nuevaCitaModal');
            if (modalElement) {
                const actualizarResumenOnShow = () => {
                    setTimeout(() => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                    }, 300);
                };
                modalElement.addEventListener('shown.bs.modal', actualizarResumenOnShow, { once: true });
            }
            
            // Agregar event listeners para actualizar resumen financiero
            setTimeout(() => {
                const newMontoVentaInput = document.getElementById('newMontoVenta');
                if (newMontoVentaInput) {
                    // Formatear cuando se presiona Enter o se pierde el foco
                    newMontoVentaInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const valorNumerico = window.extraerValorNumerico(newMontoVentaInput.value);
                            newMontoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                            newMontoVentaInput.blur();
                        }
                    });
                    newMontoVentaInput.addEventListener('blur', () => {
                        const valorNumerico = window.extraerValorNumerico(newMontoVentaInput.value);
                        newMontoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                    });
                    newMontoVentaInput.addEventListener('input', () => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                        // actualizarEncabezadoAutoNuevaCita(); // Funci√≥n eliminada - encabezado removido
                    });
                }
                
                const newCostoServicioInput = document.getElementById('newCostoServicio');
                if (newCostoServicioInput) {
                    newCostoServicioInput.addEventListener('input', () => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                    });
                }
                
                // Event listeners para actualizar encabezado autom√°tico
                const newClientNameInput = document.getElementById('newClientName');
                if (newClientNameInput) {
                    newClientNameInput.addEventListener('input', actualizarEncabezadoAutoNuevaCita);
                }
                
                const newProvinciaSelect = document.getElementById('newProvincia');
                if (newProvinciaSelect) {
                    // newProvinciaSelect.addEventListener('change', actualizarEncabezadoAutoNuevaCita); // Funci√≥n eliminada
                }
                
                const newCantonSelect = document.getElementById('newCanton');
                if (newCantonSelect) {
                    // newCantonSelect.addEventListener('change', actualizarEncabezadoAutoNuevaCita); // Funci√≥n eliminada
                }
                
                const newDistritoSelect = document.getElementById('newDistrito');
                if (newDistritoSelect) {
                    // newDistritoSelect.addEventListener('change', actualizarEncabezadoAutoNuevaCita); // Funci√≥n eliminada
                }
                
                // Observar cambios en vendedores seleccionados usando MutationObserver
                const newVendedoresSelected = document.getElementById('newVendedoresSelected');
                if (newVendedoresSelected) {
                    const observer = new MutationObserver(() => {
                        actualizarEncabezadoAutoNuevaCita();
                    });
                    observer.observe(newVendedoresSelected, { childList: true, subtree: true });
                }
                
                // Actualizar encabezado inicial
                actualizarEncabezadoAutoNuevaCita();
            }, 500);
        }

        // Funci√≥n para abrir modal de nueva cita desde arrastre
        async function abrirModalNuevaCitaDesdeArrastre(fechaInicio, duracion, day, month, year) {
            // Prellenar campos del formulario
            const newStartTime = document.getElementById('newStartTime');
            const newDuration = document.getElementById('newDuration');
            const newRuta = document.getElementById('newRuta');
            
            if (newStartTime) newStartTime.value = fechaInicio;
            if (newDuration) {
                // Seleccionar la opci√≥n m√°s cercana
                const opcionesDuracion = [15, 30, 45, 60, 75, 90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345, 360, 375, 390, 405, 420, 435, 450, 465, 480, 540, 600, 660, 720];
                let duracionSeleccionada = 60; // Valor por defecto
                for (let i = 0; i < opcionesDuracion.length; i++) {
                    if (duracion <= opcionesDuracion[i]) {
                        duracionSeleccionada = opcionesDuracion[i];
                        break;
                    }
                }
                if (duracion > 720) duracionSeleccionada = 720;
                newDuration.value = duracionSeleccionada;
            }
            if (newRuta) newRuta.value = 'Sin asignar'; // Ruta por defecto
            
            // Limpiar otros campos (solo los que existen)
            const newClientName = document.getElementById('newClientName');
            const newClientPhone = document.getElementById('newClientPhone');
            const newCoordenadas = document.getElementById('newCoordenadas');
            const newOtrasSenas = document.getElementById('newOtrasSenas');
            const newStatus = document.getElementById('newStatus');
            const newMontoVenta = document.getElementById('newMontoVenta');
            const newCostoServicio = document.getElementById('newCostoServicio');
            const newDescription = document.getElementById('newDescription');
            
            if (newClientName) newClientName.value = '';
            if (newClientPhone) newClientPhone.value = '';
            if (newCoordenadas) newCoordenadas.value = '';
            if (newOtrasSenas) newOtrasSenas.value = '';
            if (newStatus) newStatus.value = 'agendada';
            if (newMontoVenta) newMontoVenta.value = '';
            if (newCostoServicio) {
                const costoServicioFormateado = window.formatearMontoVenta('20000');
                newCostoServicio.value = costoServicioFormateado;
            }
            if (newDescription) newDescription.value = '';
            
            // Limpiar selecciones de vendedores, servicios y productos
            window.vendedoresSeleccionadosNew = [];
            window.serviciosSeleccionadosNew = [];
            window.productosSeleccionadosNew = [];
            
            const newVendedoresSelected = document.getElementById('newVendedoresSelected');
            const newServiciosSelected = document.getElementById('newServiciosSelected');
            const newProductosSelected = document.getElementById('newProductosSelected');
            
            if (newVendedoresSelected) newVendedoresSelected.innerHTML = '';
            // Renderizar tabla de servicios (vac√≠a inicialmente)
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('new');
            }
            if (newProductosSelected) newProductosSelected.innerHTML = '';
            
            // Limpiar campos de b√∫squeda
            const newVendedorSearch = document.getElementById('newVendedorSearch');
            const newServicioSearch = document.getElementById('newServicioSearch');
            const newProductoSearch = document.getElementById('newProductoSearch');
            
            if (newVendedorSearch) newVendedorSearch.value = '';
            if (newServicioSearch) newServicioSearch.value = '';
            if (newProductoSearch) newProductoSearch.value = '';
            
            // Ocultar resultados de b√∫squeda
            const newVendedoresResults = document.getElementById('newVendedoresResults');
            const newServiciosResults = document.getElementById('newServiciosResults');
            const newProductosResults = document.getElementById('newProductosResults');
            
            if (newVendedoresResults) newVendedoresResults.style.display = 'none';
            if (newServiciosResults) newServiciosResults.style.display = 'none';
            if (newProductosResults) newProductosResults.style.display = 'none';
            
            // Inicializar b√∫squedas si no est√°n inicializadas
            if (window.empleados && window.empleados.length > 0 && window.inicializarBusquedaVendedores) {
                window.inicializarBusquedaVendedores('new');
            }
            if (window.todosLosServicios && window.todosLosServicios.length > 0 && window.inicializarBusquedaServicios) {
                window.inicializarBusquedaServicios('new');
            }
            if (window.todosLosProductos && window.todosLosProductos.length > 0 && window.inicializarBusquedaProductos) {
                window.inicializarBusquedaProductos('new');
            }
            // Inicializar b√∫squeda de plagas
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('new');
            }
            // Inicializar b√∫squeda de equipo
            if (!window.todosLosEquipos || window.todosLosEquipos.length === 0) {
                await window.cargarEquipo();
            }
            if (window.inicializarBusquedaEquipo) {
                window.inicializarBusquedaEquipo('new');
            }
            
            // Limpiar campo de certificados
            const newCertificados = document.getElementById('newCertificados');
            if (newCertificados) newCertificados.value = '';
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('nuevaCitaModal'));
            modal.show();
            
            // Actualizar resumen financiero cuando el modal se muestre
            const modalElement = document.getElementById('nuevaCitaModal');
            if (modalElement) {
                const actualizarResumenOnShow = () => {
                    setTimeout(() => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                    }, 300);
                };
                modalElement.addEventListener('shown.bs.modal', actualizarResumenOnShow, { once: true });
            }
            
            // Agregar event listeners para actualizar resumen financiero
            setTimeout(() => {
                const newMontoVentaInput = document.getElementById('newMontoVenta');
                if (newMontoVentaInput) {
                    newMontoVentaInput.addEventListener('input', () => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                    });
                }
                
                const newCostoServicioInput = document.getElementById('newCostoServicio');
                if (newCostoServicioInput) {
                    newCostoServicioInput.addEventListener('input', () => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                    });
                }
            }, 500);
        }
        
        const btnDescargarProforma = document.getElementById('btnDescargarProforma');
        if (btnDescargarProforma) {
            btnDescargarProforma.addEventListener('click', async () => {
                btnDescargarProforma.disabled = true;
                btnDescargarProforma.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
                try {
                    await window.generarProformaPNG();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al generar la proforma: ' + error.message);
                } finally {
                    btnDescargarProforma.disabled = false;
                    btnDescargarProforma.innerHTML = '<i class="fas fa-download me-2"></i>Descargar Proforma PNG';
                }
            });
        }
        
        // Event listener para actualizar turno autom√°ticamente cuando cambie la hora
        // Campo editTurno eliminado - este listener ya no es necesario

        // Event listeners para vistas
        // Event listener para Cronograma - ELIMINADO (bot√≥n removido del men√∫)
        // const btnVistaCronograma = document.getElementById('btnVistaCronograma');
        // if (btnVistaCronograma) {
        //     btnVistaCronograma.addEventListener('click', async () => {
        //         await cambiarVista('cronograma');
        //         const menuHamburguesa = document.getElementById('menuHamburguesa');
        //         if (menuHamburguesa) menuHamburguesa.style.display = 'none';
        //     });
        // }
        
        // Event listener para toggle de vista compacta
        // Event listeners para navegaci√≥n de semana
        const btnSemanaAnterior = document.getElementById('btnSemanaAnterior');
        const btnSemanaSiguiente = document.getElementById('btnSemanaSiguiente');
        
        if (btnSemanaAnterior) {
            btnSemanaAnterior.addEventListener('click', async () => {
                if (!semanaActual) {
                    semanaActual = obtenerLunesSemana(new Date());
                }
                semanaActual.setDate(semanaActual.getDate() - 7);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                    // Actualizar botones de d√≠as para mostrar la nueva semana
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    }
                }
            });
        }
        
        if (btnSemanaSiguiente) {
            btnSemanaSiguiente.addEventListener('click', async () => {
                if (!semanaActual) {
                    semanaActual = obtenerLunesSemana(new Date());
                }
                semanaActual.setDate(semanaActual.getDate() + 7);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                    // Actualizar botones de d√≠as para mostrar la nueva semana
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    }
                }
            });
        }
        
        const btnToggleVistaCompacta = document.getElementById('btnToggleVistaCompacta');
        if (btnToggleVistaCompacta) {
            btnToggleVistaCompacta.addEventListener('click', async () => {
                const estaActiva = btnToggleVistaCompacta.classList.contains('active');
                
                if (estaActiva) {
                    // Desactivar vista compacta - mostrar todas las horas
                    btnToggleVistaCompacta.classList.remove('active');
                    btnToggleVistaCompacta.style.background = '#6c757d';
                    btnToggleVistaCompacta.innerHTML = '<i class="fas fa-compress-alt me-2"></i>Vista Compacta';
                    
                    // Restaurar vista total: mostrar todas las horas y restaurar altura
                    const restaurarVistaTotal = (contenedorId) => {
                        const contenedor = document.getElementById(contenedorId);
                        if (!contenedor) return;
                        const columnas = contenedor.querySelectorAll('.vehiculo-columna-cronograma');
                        columnas.forEach(columna => {
                            const timeline = columna.querySelector('.citas-timeline');
                            if (!timeline) return;
                            
                            // Restaurar altura original
                            timeline.style.height = '792px';
                            timeline.style.minHeight = '792px';
                            timeline.style.overflow = 'visible';
                            
                            // Restaurar marcadores de hora
                            const marcadores = timeline.querySelectorAll('.marcador-hora-timeline');
                            marcadores.forEach(m => {
                                m.style.display = 'block';
                                // Restaurar posici√≥n original (se recalcula desde minutos)
                                const minutosDesdeMedianoche = parseFloat(m.getAttribute('data-minutos-original')) || (parseFloat(m.style.top) || 0) / 33 * 60;
                                m.style.top = `${(minutosDesdeMedianoche / 60) * 33}px`;
                            });
                            
                            // Restaurar l√≠neas divisorias
                            const lineas = timeline.querySelectorAll('.linea-divisoria-hora');
                            lineas.forEach(l => {
                                l.style.display = 'block';
                                // Restaurar posici√≥n original
                                const minutosDesdeMedianoche = parseFloat(l.getAttribute('data-minutos-original')) || (parseFloat(l.style.top) || 0) / 33 * 60;
                                l.style.top = `${(minutosDesdeMedianoche / 60) * 33}px`;
                            });
                            
                            // Las citas se reposicionan autom√°ticamente al regenerar el cronograma
                        });
                    };
                    
                    // Regenerar cronograma para restaurar posiciones originales
                    await generarCronograma();
                    // Actualizar botones de d√≠as para mostrar todo el mes
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    }
                } else {
                    // Activar vista compacta - colapsar horas fuera del rango
                    btnToggleVistaCompacta.classList.add('active');
                    btnToggleVistaCompacta.style.background = '#4CAF50';
                    btnToggleVistaCompacta.innerHTML = '<i class="fas fa-expand-alt me-2"></i>Vista Total';
                    
                    // Inicializar semana actual si no est√° definida
                    if (!semanaActual) {
                        semanaActual = obtenerLunesSemana(new Date());
                    }
                    // Actualizar botones de d√≠as para mostrar solo la semana
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    }
                    // Regenerar cronograma
                    await generarCronograma();
                    
                    // Colapsar filas de horas fuera del rango
                    if (window.rangosHoras) {
                        const colapsarFilasHoras = (contenedorId, minutosInicio, minutosFin) => {
                            if (minutosInicio === null || minutosFin === null) return;
                            
                            const contenedor = document.getElementById(contenedorId);
                            if (!contenedor) return;
                            
                            // Calcular altura del timeline en vista compacta
                            const minutosTotales = minutosFin - minutosInicio;
                            const alturaTimeline = (minutosTotales / 60) * 33;
                            const offsetTop = (minutosInicio / 60) * 33;
                            
                            const columnas = contenedor.querySelectorAll('.vehiculo-columna-cronograma');
                            columnas.forEach(columna => {
                                const timeline = columna.querySelector('.citas-timeline');
                                if (!timeline) return;
                                
                                // Ajustar altura del timeline
                                timeline.style.height = `${alturaTimeline}px`;
                                timeline.style.minHeight = `${alturaTimeline}px`;
                                timeline.style.overflow = 'hidden';
                                
                                // Reposicionar marcadores de hora
                                const marcadores = timeline.querySelectorAll('.marcador-hora-timeline');
                                marcadores.forEach(marcador => {
                                    const topOriginal = parseFloat(marcador.style.top) || 0;
                                    const minutosDesde5AM = (topOriginal / 33) * 60; // Ya est√° en minutos desde 5 AM
                                    if (minutosDesde5AM < minutosInicio || minutosDesde5AM > minutosFin) {
                                        marcador.style.display = 'none';
                                    } else {
                                        marcador.style.display = 'block';
                                        const nuevoTop = topOriginal - offsetTop;
                                        marcador.style.top = `${nuevoTop}px`;
                                    }
                                });
                                
                                // Reposicionar l√≠neas divisorias
                                const lineas = timeline.querySelectorAll('.linea-divisoria-hora');
                                lineas.forEach(linea => {
                                    const topOriginal = parseFloat(linea.style.top) || 0;
                                    const minutosDesde5AM = (topOriginal / 33) * 60; // Ya est√° en minutos desde 5 AM
                                    if (minutosDesde5AM < minutosInicio || minutosDesde5AM > minutosFin) {
                                        linea.style.display = 'none';
                                    } else {
                                        linea.style.display = 'block';
                                        const nuevoTop = topOriginal - offsetTop;
                                        linea.style.top = `${nuevoTop}px`;
                                    }
                                });
                                
                                // Reposicionar u ocultar citas
                                const citas = timeline.querySelectorAll('.cita-bloque');
                                citas.forEach(cita => {
                                    const topOriginal = parseFloat(cita.style.top) || 0;
                                    const alturaCita = parseFloat(cita.style.height) || 0;
                                    const minutosCitaInicio = (topOriginal / 33) * 60; // Ya est√° en minutos desde 5 AM
                                    const minutosCitaFin = minutosCitaInicio + (alturaCita / 33) * 60;
                                    
                                    // Verificar si la cita est√° dentro del rango visible (o se superpone)
                                    if (minutosCitaFin >= minutosInicio && minutosCitaInicio <= minutosFin) {
                                        // La cita est√° dentro o se superpone con el rango visible
                                        cita.style.display = 'block';
                                        const nuevoTop = topOriginal - offsetTop;
                                        cita.style.top = `${nuevoTop}px`;
                                    } else {
                                        // La cita est√° completamente fuera del rango visible
                                        cita.style.display = 'none';
                                    }
                                });
                            });
                        };
                        
                        colapsarFilasHoras('vehiculosCronogramaDiurnas', window.rangosHoras.diurnas.inicio, window.rangosHoras.diurnas.fin);
                        colapsarFilasHoras('vehiculosCronogramaNocturnas', window.rangosHoras.nocturnas.inicio, window.rangosHoras.nocturnas.fin);
                    }
                }
            });
        }
        

        // Event listeners del reporte t√°ctico removidos - ahora est√° en reporte_tactico.html
        
        // Men√∫ hamburguesa
        const btnMenuHamburguesa = document.getElementById('btnMenuHamburguesa');
        const menuHamburguesa = document.getElementById('menuHamburguesa');
        
        if (btnMenuHamburguesa && menuHamburguesa) {
            btnMenuHamburguesa.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = menuHamburguesa.style.display === 'block';
                menuHamburguesa.style.display = isVisible ? 'none' : 'block';
            });
            
            // Cerrar men√∫ al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!btnMenuHamburguesa.contains(e.target) && !menuHamburguesa.contains(e.target)) {
                    menuHamburguesa.style.display = 'none';
                }
            });
            
            // Cerrar men√∫ al hacer clic en cualquier bot√≥n del men√∫
            const botonesMenu = menuHamburguesa.querySelectorAll('button');
            botonesMenu.forEach(btn => {
                btn.addEventListener('click', () => {
                    menuHamburguesa.style.display = 'none';
                });
            });
        }
        
        // Event listener para pre-cargar citas - ELIMINADO

        // Event listeners para cargar CSV
        const btnCargarCSV = document.getElementById('btnCargarCSV');
        const inputCSV = document.getElementById('inputCSV');
        
        if (btnCargarCSV) {
            btnCargarCSV.addEventListener('click', cargarCitasDesdeCSV);
        }
        
        if (inputCSV) {
            inputCSV.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    procesarArchivoCSV(e.target.files[0]);
                }
            });
        }
        
        // Event listeners para actualizar desde CSV
        const btnActualizarCSV = document.getElementById('btnActualizarCSV');
        const inputCSVActualizar = document.getElementById('inputCSVActualizar');
        
        if (btnActualizarCSV) {
            btnActualizarCSV.addEventListener('click', () => {
                if (inputCSVActualizar) {
                    inputCSVActualizar.click();
                }
            });
        }
        
        if (inputCSVActualizar) {
            inputCSVActualizar.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    procesarArchivoCSVActualizar(e.target.files[0]);
                }
            });
        }
        
        // Event listeners para Google Sheets
        const btnCargarGoogleSheets = document.getElementById('btnCargarGoogleSheets');
        const btnActualizarGoogleSheets = document.getElementById('btnActualizarGoogleSheets');
        
        if (btnCargarGoogleSheets) {
            btnCargarGoogleSheets.addEventListener('click', () => {
                solicitarURLGoogleSheets(false); // false = cargar (no actualizar)
            });
        }
        
        if (btnActualizarGoogleSheets) {
            btnActualizarGoogleSheets.addEventListener('click', () => {
                solicitarURLGoogleSheets(true); // true = actualizar
            });
        }
        
        // Bot√≥n para actualizar desde Google Sheets oficial (URL predefinida)
        const btnActualizarGoogleSheetsAuto = document.getElementById('btnActualizarGoogleSheetsAuto');
        if (btnActualizarGoogleSheetsAuto) {
            btnActualizarGoogleSheetsAuto.addEventListener('click', () => {
                // URL oficial de Google Sheets - Hoja "vaciado" (gid=0)
                const urlOficial = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhFnfEHF0IuYIhXM8FWaPjbHqUFbdYpzWTd6Fs_xm8VZgEp-MnVBrIdscsbk-owo5ID3g1hbmBAvBe/pubhtml?gid=0&single=true';
                const urlCSV = convertirURLGoogleSheetsACSV(urlOficial);
                if (urlCSV) {
                    procesarGoogleSheetsActualizar(urlCSV);
                } else {
                    alert('Error: No se pudo convertir la URL de Google Sheets');
                }
            });
        }

        // Event listener para eliminar todas las citas
        const btnEliminarTodasCitas = document.getElementById('btnEliminarTodasCitas');
        if (btnEliminarTodasCitas) {
            btnEliminarTodasCitas.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('modalEliminarCitas'));
                modal.show();
            });
        }
        
        // L√≥gica del modal de eliminaci√≥n
        const tipoEliminacion = document.getElementById('tipoEliminacion');
        const opcionesRango = document.getElementById('opcionesRango');
        const opcionesMayor = document.getElementById('opcionesMayor');
        const opcionesMenor = document.getElementById('opcionesMenor');
        const vistaPreviaEliminacion = document.getElementById('vistaPreviaEliminacion');
        const textoVistaPrevia = document.getElementById('textoVistaPrevia');
        const btnConfirmarEliminacion = document.getElementById('btnConfirmarEliminacion');
        
        if (tipoEliminacion) {
            tipoEliminacion.addEventListener('change', () => {
                const tipo = tipoEliminacion.value;
                
                // Ocultar todas las opciones
                if (opcionesRango) opcionesRango.style.display = 'none';
                if (opcionesMayor) opcionesMayor.style.display = 'none';
                if (opcionesMenor) opcionesMenor.style.display = 'none';
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
                
                // Mostrar opciones seg√∫n el tipo
                if (tipo === 'rango' && opcionesRango) {
                    opcionesRango.style.display = 'block';
                } else if (tipo === 'mayor' && opcionesMayor) {
                    opcionesMayor.style.display = 'block';
                } else if (tipo === 'menor' && opcionesMenor) {
                    opcionesMenor.style.display = 'block';
                }
                
                // Actualizar vista previa
                actualizarVistaPreviaEliminacion();
            });
        }
        
        // Actualizar vista previa cuando cambian las fechas
        const fechaInicioRango = document.getElementById('fechaInicioRango');
        const fechaFinRango = document.getElementById('fechaFinRango');
        const fechaMayor = document.getElementById('fechaMayor');
        const fechaMenor = document.getElementById('fechaMenor');
        
        if (fechaInicioRango) fechaInicioRango.addEventListener('change', actualizarVistaPreviaEliminacion);
        if (fechaFinRango) fechaFinRango.addEventListener('change', actualizarVistaPreviaEliminacion);
        if (fechaMayor) fechaMayor.addEventListener('change', actualizarVistaPreviaEliminacion);
        if (fechaMenor) fechaMenor.addEventListener('change', actualizarVistaPreviaEliminacion);
        
        function actualizarVistaPreviaEliminacion() {
            const tipo = tipoEliminacion?.value;
            if (!tipo) {
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
                return;
            }
            
            let texto = '';
            if (tipo === 'todas') {
                texto = 'Se eliminar√°n <strong>TODAS</strong> las citas de la base de datos.';
            } else if (tipo === 'rango') {
                const inicio = fechaInicioRango?.value;
                const fin = fechaFinRango?.value;
                if (inicio && fin) {
                    texto = `Se eliminar√°n todas las citas cuya fecha de inicio est√© entre <strong>${inicio}</strong> y <strong>${fin}</strong> (inclusive).`;
                } else {
                    texto = 'Complete las fechas para ver la vista previa.';
                }
            } else if (tipo === 'mayor') {
                const fecha = fechaMayor?.value;
                if (fecha) {
                    texto = `Se eliminar√°n todas las citas cuya fecha de inicio sea mayor o igual a <strong>${fecha}</strong> (inclusive).`;
                } else {
                    texto = 'Complete la fecha para ver la vista previa.';
                }
            } else if (tipo === 'menor') {
                const fecha = fechaMenor?.value;
                if (fecha) {
                    texto = `Se eliminar√°n todas las citas cuya fecha de inicio sea menor o igual a <strong>${fecha}</strong> (inclusive).`;
                } else {
                    texto = 'Complete la fecha para ver la vista previa.';
                }
            }
            
            if (texto && textoVistaPrevia) {
                textoVistaPrevia.innerHTML = texto;
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'block';
            } else {
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
            }
        }
        
        // Event listener para confirmar eliminaci√≥n
        if (btnConfirmarEliminacion) {
            btnConfirmarEliminacion.addEventListener('click', async () => {
                const tipo = tipoEliminacion?.value;
                if (!tipo) {
                    alert('Por favor, seleccione un tipo de eliminaci√≥n.');
                    return;
                }
                
                // Validar fechas seg√∫n el tipo
                if (tipo === 'rango') {
                    const inicio = fechaInicioRango?.value;
                    const fin = fechaFinRango?.value;
                    if (!inicio || !fin) {
                        alert('Por favor, complete ambas fechas del rango.');
                        return;
                    }
                    if (new Date(inicio) > new Date(fin)) {
                        alert('La fecha de inicio no puede ser mayor que la fecha de fin.');
                        return;
                    }
                } else if (tipo === 'mayor') {
                    if (!fechaMayor?.value) {
                        alert('Por favor, complete la fecha l√≠mite.');
                        return;
                    }
                } else if (tipo === 'menor') {
                    if (!fechaMenor?.value) {
                        alert('Por favor, complete la fecha l√≠mite.');
                        return;
                    }
                }
                
                // Confirmaci√≥n
                let mensajeConfirmacion = '';
                if (tipo === 'todas') {
                    mensajeConfirmacion = '‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° TODAS las citas de la base de datos.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro de que deseas continuar?';
                } else if (tipo === 'rango') {
                    mensajeConfirmacion = `‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° todas las citas entre ${fechaInicioRango.value} y ${fechaFinRango.value}.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro de que deseas continuar?`;
                } else if (tipo === 'mayor') {
                    mensajeConfirmacion = `‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° todas las citas mayores o iguales a ${fechaMayor.value}.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro de que deseas continuar?`;
                } else if (tipo === 'menor') {
                    mensajeConfirmacion = `‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° todas las citas menores o iguales a ${fechaMenor.value}.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro de que deseas continuar?`;
                }
                
                if (!confirm(mensajeConfirmacion)) {
                    return;
                }
                
                // Ejecutar eliminaci√≥n
                await eliminarCitasPorFiltro(tipo);
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminarCitas'));
                if (modal) {
                    modal.hide();
                }
                
                // Limpiar formulario
                if (tipoEliminacion) tipoEliminacion.value = '';
                if (fechaInicioRango) fechaInicioRango.value = '';
                if (fechaFinRango) fechaFinRango.value = '';
                if (fechaMayor) fechaMayor.value = '';
                if (fechaMenor) fechaMenor.value = '';
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
            });
        }
        
        // Event listener para descargar CSV de ubicaciones
        // Event listener para descargar ubicaciones CSV - ELIMINADO
        // const btnDescargarUbicacionesCSV = document.getElementById('btnDescargarUbicacionesCSV');
        
        // Funci√≥n para abrir modal de migraci√≥n desde una ruta espec√≠fica
        window.abrirModalMigrarRuta = function(rutaOrigen, fechaFormateada) {
            const rutaOrigenInput = document.getElementById('rutaOrigenMigrar');
            const fechaDiaInput = document.getElementById('fechaDiaMigrar');
            const previewDiv = document.getElementById('previewMigracion');
            const btnConfirmar = document.getElementById('btnConfirmarMigracion');
            
            if (!rutaOrigenInput || !fechaDiaInput) {
                console.error('Elementos del modal no encontrados');
                return;
            }
            
            rutaOrigenInput.value = rutaOrigen;
            fechaDiaInput.value = fechaFormateada || '';
            if (previewDiv) previewDiv.style.display = 'none';
            if (btnConfirmar) btnConfirmar.disabled = true;
            
            const modalElement = document.getElementById('modalMigrarRutas');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('Modal modalMigrarRutas no encontrado');
            }
        };
        
        // Agregar listeners para actualizar preview cuando cambien las rutas
        const rutaOrigenSelect = document.getElementById('rutaOrigenMigrar');
        const rutaDestinoSelect = document.getElementById('rutaDestinoMigrar');
        if (rutaOrigenSelect) {
            rutaOrigenSelect.addEventListener('change', () => {
                const previewDiv = document.getElementById('previewMigracion');
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                if (previewDiv) previewDiv.style.display = 'none';
                if (btnConfirmar) btnConfirmar.disabled = true;
            });
        }
        if (rutaDestinoSelect) {
            rutaDestinoSelect.addEventListener('change', () => {
                const previewDiv = document.getElementById('previewMigracion');
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                if (previewDiv) previewDiv.style.display = 'none';
                if (btnConfirmar) btnConfirmar.disabled = true;
            });
        }
        
        btnPrevDay.addEventListener('click', () => {
            diaSeleccionado.setDate(diaSeleccionado.getDate() - 1);
            if (vistaActual === 'dia') {
                generarVistaDia();
            }
        });
        
        btnNextDay.addEventListener('click', () => {
            diaSeleccionado.setDate(diaSeleccionado.getDate() + 1);
            if (vistaActual === 'dia') {
                generarVistaDia();
            }
        });

        // Event listeners para cronograma ya configurados arriba

        // Poblar filtros
        function poblarFiltros() {
            const rutasUnicas = [...new Set(todasLasCitas.map(cita => obtenerRuta(cita)).filter(r => r))];
            if (vehicleFilter) {
                vehicleFilter.innerHTML = '<option value="">Todas las rutas</option>' +
                    rutasUnicas.map(ruta => 
                        `<option value="${ruta}">${ruta}</option>`
                    ).join('');
            }
        }

        // Funci√≥n para pre-cargar citas ficticias
        async function precargarCitasFicticias() {
            const btnPrecargar = document.getElementById('btnPrecargarCitas');
            if (!btnPrecargar) return;

            const confirmacion = confirm('¬øDeseas crear citas ficticias para el 14 de noviembre de 2025?\n\nHorario: 6:00 AM - 3:00 PM\nDuraci√≥n: 60 minutos cada una\nEspacio entre citas: 1 hora\nTodas se crear√°n en "Sin asignar"');
            
            if (!confirmacion) return;

            try {
                btnPrecargar.disabled = true;
                btnPrecargar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando citas...';

                // Fecha: 14 de noviembre de 2025
                const fechaBase = new Date('2025-11-14T00:00:00-06:00'); // GMT-06 (Costa Rica)
                
                // Horarios: 6:00 AM, 7:00 AM, 8:00 AM, ..., 2:00 PM (14:00)
                const horas = [6, 7, 8, 9, 10, 11, 12, 13, 14]; // 6am a 2pm (9 citas)
                const duracionMinutos = 60;
                
                let citasCreadas = 0;
                
                for (let i = 0; i < horas.length; i++) {
                    const hora = horas[i];
                    const fechaInicio = new Date(fechaBase);
                    fechaInicio.setHours(hora, 0, 0, 0);
                    
                    // Convertir a Timestamp GMT-06
                    const timestampGMT6 = Timestamp.fromDate(fechaInicio);
                    
                    // Tel√©fono ficticio
                    const telefonoFicticio = `506${String(80000000 + i).padStart(8, '0')}`;
                    const nombreClienteFicticio = `Cliente Ficticio ${i + 1}`;
                    
                    // Crear o actualizar cliente primero (siguiendo principios de jerarqu√≠a)
                    try {
                        let cliente = await window.buscarCliente(telefonoFicticio);
                        if (!cliente) {
                            await window.crearCliente(telefonoFicticio, nombreClienteFicticio);
                        } else if (cliente.nombre !== nombreClienteFicticio) {
                            await window.actualizarNombreCliente(telefonoFicticio, nombreClienteFicticio);
                        }
                    } catch (error) {
                        console.warn(`Error creando/actualizando cliente ficticio ${i + 1}:`, error);
                    }
                    
                    // Crear cita con estructura nueva (sin cliente_nombre en metadata)
                    const nuevaCita = {
                        telefono: telefonoFicticio, // Fuente de verdad: tel√©fono en ra√≠z
                        inicio_gmt6: timestampGMT6,
                        duracion_minutos: duracionMinutos,
                        metadata: {
                            // cliente_nombre removido - el nombre pertenece al documento del cliente, no a la cita
                            // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                            sucursalIndice: null, // Citas ficticias sin sucursal
                            vehiculo: 'Sin asignar',
                            ruta: 'Sin asignar',
                            estado: 'agendada',
                            monto: 0,
                            costo_servicio: 20000, // Costo del servicio por defecto
                            vendedores: [], // Array vac√≠o para citas ficticias
                            observaciones: `Cita de prueba ${i + 1}`
                        },
                        fecha_creacion: serverTimestamp(),
                        version_esquema: 1
                    };
                    
                    await addDoc(collection(window.db, 'citas'), nuevaCita);
                    citasCreadas++;
                }

                // Recargar datos
                await cargarDatos();
                
                // Mostrar notificaci√≥n de √©xito
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `<i class="fas fa-check-circle me-2"></i>${citasCreadas} citas ficticias creadas exitosamente`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);

            } catch (error) {
                console.error('Error pre-cargando citas:', error);
                alert('Error pre-cargando citas: ' + error.message);
            } finally {
                btnPrecargar.disabled = false;
                btnPrecargar.innerHTML = '<i class="fas fa-magic me-2"></i>Pre-cargar Citas';
            }
        }

        // Funci√≥n mejorada para parsear CSV (maneja saltos de l√≠nea dentro de campos entre comillas)
        // Funci√≥n para actualizar citas desde CSV (reemplaza solo las del rango de fechas)
        async function procesarArchivoCSVActualizar(archivo) {
            if (!archivo) return;

            if (!archivo.name.endsWith('.csv')) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }

            const btnActualizarCSV = document.getElementById('btnActualizarCSV');
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    btnActualizarCSV.disabled = true;
                    btnActualizarCSV.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analizando CSV...';

                    const textoCSV = e.target.result;
                    const datos = parsearCSV(textoCSV);

                    if (datos.length === 0) {
                        throw new Error('No se encontraron datos en el CSV');
                    }

                    // Determinar rango de fechas del CSV
                    let fechaMin = null;
                    let fechaMax = null;
                    
                    for (const fila of datos) {
                        if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') continue;
                        
                        try {
                            const fechaInicio = new Date(fila.inicio_gmt6);
                            if (isNaN(fechaInicio.getTime())) continue;
                            
                            if (!fechaMin || fechaInicio < fechaMin) {
                                fechaMin = new Date(fechaInicio);
                            }
                            if (!fechaMax || fechaInicio > fechaMax) {
                                fechaMax = new Date(fechaInicio);
                            }
                        } catch (error) {
                            console.warn('Error parseando fecha:', fila.inicio_gmt6, error);
                        }
                    }

                    if (!fechaMin || !fechaMax) {
                        throw new Error('No se pudieron determinar las fechas del CSV. Verifica que la columna inicio_gmt6 tenga fechas v√°lidas.');
                    }

                    // Ajustar rango para incluir todo el d√≠a (00:00:00 a 23:59:59)
                    fechaMin.setHours(0, 0, 0, 0);
                    fechaMax.setHours(23, 59, 59, 999);

                    const fechaMinStr = fechaMin.toLocaleDateString('es-CR');
                    const fechaMaxStr = fechaMax.toLocaleDateString('es-CR');

                    // Confirmar antes de actualizar
                    const confirmacion = confirm(
                        `Se encontraron ${datos.length} citas en el CSV.\n\n` +
                        `Rango de fechas del CSV: ${fechaMinStr} a ${fechaMaxStr}\n\n` +
                        `‚ö†Ô∏è ADVERTENCIA: Se eliminar√°n TODAS las citas existentes en este rango de fechas y se crear√°n las nuevas del CSV.\n\n` +
                        `Las citas fuera de este rango NO se modificar√°n.\n\n` +
                        `¬øDeseas continuar?`
                    );

                    if (!confirmacion) {
                        btnActualizarCSV.disabled = false;
                        btnActualizarCSV.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV';
                        document.getElementById('inputCSVActualizar').value = '';
                        return;
                    }

                    btnActualizarCSV.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando citas del rango...';

                    // Buscar y eliminar citas en el rango de fechas
                    const q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '>=', Timestamp.fromDate(fechaMin)),
                        where('inicio_gmt6', '<=', Timestamp.fromDate(fechaMax)),
                        orderBy('inicio_gmt6', 'desc')
                    );

                    const querySnapshot = await getDocs(q);
                    const citasAEliminar = [];
                    querySnapshot.forEach((docSnapshot) => {
                        citasAEliminar.push(docSnapshot.id);
                    });

                    let citasEliminadas = 0;
                    if (citasAEliminar.length > 0) {
                        // Eliminar en lotes de 10
                        const batchSize = 10;
                        for (let i = 0; i < citasAEliminar.length; i += batchSize) {
                            const batch = citasAEliminar.slice(i, i + batchSize);
                            const promises = batch.map(citaId => 
                                deleteDoc(doc(window.db, 'citas', citaId))
                            );
                            await Promise.all(promises);
                            citasEliminadas += batch.length;
                        }
                    }

                    console.log(`‚úÖ Eliminadas ${citasEliminadas} citas del rango ${fechaMinStr} a ${fechaMaxStr}`);

                    // Ahora crear las nuevas citas del CSV (reutilizar la l√≥gica de procesarArchivoCSV)
                    btnActualizarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;

                    let citasCreadas = 0;
                    let errores = [];

                    for (let i = 0; i < datos.length; i++) {
                        const fila = datos[i];
                        
                        try {
                            // Validar fecha de inicio
                            if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                                errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                                continue;
                            }

                            // Parsear fecha (formato: 2025-11-14T01:00:00-06:00)
                            const fechaInicio = new Date(fila.inicio_gmt6);
                            if (isNaN(fechaInicio.getTime())) {
                                errores.push(`Fila ${i + 2}: Fecha de inicio inv√°lida: ${fila.inicio_gmt6}`);
                                continue;
                            }

                            // Validar tel√©fono
                            let telefono = fila.telefono ? fila.telefono.trim() : '';
                            if (telefono) {
                                telefono = window.normalizarTelefono ? window.normalizarTelefono(telefono) : telefono;
                            }
                            
                            // Si no hay tel√©fono, crear uno temporal
                            if (!telefono || telefono === '') {
                                telefono = `temp_${Date.now()}_${i}`;
                            }

                            // Validar duraci√≥n
                            const duracionMinutos = parseInt(fila.duracion_minutos) || 60;
                            if (duracionMinutos <= 0) {
                                errores.push(`Fila ${i + 2}: Duraci√≥n inv√°lida: ${fila.duracion_minutos}`);
                                continue;
                            }

                            // Validar y normalizar ruta (el CSV tiene columna ruta)
                            const ruta = window.validarRuta ? window.validarRuta(fila.ruta || 'Sin asignar') : (fila.ruta || 'Sin asignar');
                            
                            // Estado
                            const estado = fila.estado && fila.estado.trim() !== '' 
                                ? fila.estado.trim() 
                                : 'agendada';

                            // Monto
                            const monto = parseInt(fila.monto) || 0;

                            // Cliente nombre
                            const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                                ? fila.cliente_nombre.trim() 
                                : 'Sin nombre';

                            // Iniciales
                            const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                                ? fila.iniciales.trim() 
                                : '';

                            // Observaciones
                            let observaciones = '';
                            if (fila.observaciones && fila.observaciones.trim() !== '') {
                                observaciones = fila.observaciones.trim();
                            }

                            // Direcci√≥n
                            let direccion = '';
                            if (fila.direccion && fila.direccion.trim() !== '') {
                                direccion = fila.direccion.trim();
                            } else if (observaciones) {
                                const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                                if (urlMatch) {
                                    direccion = urlMatch[0];
                                }
                            }

                            // Parsear vendedores
                            let vendedores = [];
                            if (fila.vendedores && fila.vendedores.trim() !== '') {
                                let vendedoresStr = String(fila.vendedores).trim();
                                while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                       (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                    vendedoresStr = vendedoresStr.slice(1, -1).trim();
                                }
                                
                                if (vendedoresStr && vendedoresStr !== '') {
                                    try {
                                        const parsed = JSON.parse(vendedoresStr);
                                        if (Array.isArray(parsed)) {
                                            vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                        } else {
                                            vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                        }
                                    } catch (e) {
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                    
                                    vendedores = vendedores
                                        .map(v => {
                                            let vendedor = v.trim();
                                            while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                                   (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                                vendedor = vendedor.slice(1, -1).trim();
                                            }
                                            return vendedor;
                                        })
                                        .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                        .map(v => v.toLowerCase());
                                }
                            }

                            // Convertir fecha a Timestamp GMT-06
                            const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                            // Crear o actualizar documento del cliente con el nombre
                            if (telefono && !telefono.startsWith('temp_')) {
                                try {
                                    let cliente = await window.buscarCliente(telefono);
                                    if (!cliente) {
                                        await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                    } else {
                                        if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                            await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        }
                                    }
                                } catch (error) {
                                    console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                                }
                            }

                            // Crear objeto metadata
                            const metadata = {
                                cliente_nombre: clienteNombre !== 'Sin nombre' ? clienteNombre : '',
                                sucursalIndice: null,
                                ruta: ruta,
                                estado: estado,
                                monto: monto,
                                costo_servicio: 20000,
                                vendedores: vendedores,
                                observaciones: observaciones
                            };

                            // Agregar campos opcionales
                            if (fila.vehiculo) {
                                metadata.vehiculo = fila.vehiculo;
                            }
                            if (iniciales) {
                                metadata.iniciales = iniciales;
                            }
                            if (direccion) {
                                metadata.direccion = direccion;
                            }

                            // Crear cita
                            const nuevaCita = {
                                telefono: telefono,
                                inicio_gmt6: timestampGMT6,
                                duracion_minutos: duracionMinutos,
                                metadata: metadata,
                                fecha_creacion: serverTimestamp(),
                                version_esquema: 1
                            };

                            await addDoc(collection(window.db, 'citas'), nuevaCita);
                            citasCreadas++;

                            btnActualizarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;

                        } catch (error) {
                            console.error(`Error procesando fila ${i + 2}:`, error);
                            errores.push(`Fila ${i + 2}: ${error.message}`);
                        }
                    }

                    // Mostrar resultado
                    let mensaje = `‚úÖ Actualizaci√≥n completada:\n\n`;
                    mensaje += `- Citas eliminadas del rango: ${citasEliminadas}\n`;
                    mensaje += `- Citas creadas desde CSV: ${citasCreadas}\n`;
                    mensaje += `- Rango de fechas: ${fechaMinStr} a ${fechaMaxStr}\n`;
                    
                    if (errores.length > 0) {
                        mensaje += `\n‚ö†Ô∏è Errores (${errores.length}):\n${errores.slice(0, 10).join('\n')}`;
                        if (errores.length > 10) {
                            mensaje += `\n... y ${errores.length - 10} m√°s`;
                        }
                    }

                    alert(mensaje);

                    // Recargar datos
                    if (window.cargarDatos) {
                        await window.cargarDatos();
                    }

                    btnActualizarCSV.disabled = false;
                    btnActualizarCSV.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV';
                    document.getElementById('inputCSVActualizar').value = '';

                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error procesando CSV: ' + error.message);
                    btnActualizarCSV.disabled = false;
                    btnActualizarCSV.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV';
                    document.getElementById('inputCSVActualizar').value = '';
                }
            };

            reader.readAsText(archivo);
        }

        function parsearCSV(texto) {
            const lineas = [];
            let lineaActual = '';
            let dentroComillas = false;
            
            // Primero, reconstruir las l√≠neas correctamente manejando saltos de l√≠nea dentro de comillas
            for (let i = 0; i < texto.length; i++) {
                const char = texto[i];
                const nextChar = texto[i + 1];
                
                if (char === '"') {
                    // Manejar comillas dobles escapadas ("")
                    if (dentroComillas && nextChar === '"') {
                        lineaActual += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        dentroComillas = !dentroComillas;
                        lineaActual += char;
                    }
                } else if (char === '\n' || char === '\r') {
                    if (dentroComillas) {
                        // Si estamos dentro de comillas, mantener el salto de l√≠nea como parte del valor
                        lineaActual += char === '\n' ? '\n' : '';
                    } else {
                        // Si no estamos dentro de comillas, es un separador de fila
                        if (lineaActual.trim()) {
                            lineas.push(lineaActual);
                            lineaActual = '';
                        }
                        // Saltar \r\n
                        if (char === '\r' && nextChar === '\n') {
                            i++;
                        }
                    }
                } else {
                    lineaActual += char;
                }
            }
            
            // Agregar la √∫ltima l√≠nea si existe
            if (lineaActual.trim()) {
                lineas.push(lineaActual);
            }
            
            if (lineas.length < 2) {
                throw new Error('El CSV debe tener al menos una fila de encabezados y una fila de datos');
            }

            // Parsear encabezados
            const encabezados = parsearLineaCSVCompleta(lineas[0]);
            
            // Validar campos requeridos
            const camposRequeridos = ['inicio_gmt6', 'duracion_minutos'];
            const camposFaltantes = camposRequeridos.filter(campo => !encabezados.includes(campo));
            if (camposFaltantes.length > 0) {
                throw new Error(`Faltan campos requeridos: ${camposFaltantes.join(', ')}`);
            }

            // Parsear datos
            const datos = [];
            for (let i = 1; i < lineas.length; i++) {
                const valores = parsearLineaCSVCompleta(lineas[i]);
                
                // Asegurar que tenemos suficientes valores (rellenar con strings vac√≠os si faltan)
                while (valores.length < encabezados.length) {
                    valores.push('');
                }
                
                const fila = {};
                encabezados.forEach((encabezado, indice) => {
                    let valor = valores[indice] || '';
                    // Limpiar el valor: remover comillas exteriores y espacios
                    valor = limpiarValorCSV(valor);
                    fila[encabezado] = valor;
                });
                datos.push(fila);
            }

            return datos;
        }

        // Funci√≥n para parsear una l√≠nea CSV completa
        function parsearLineaCSVCompleta(linea) {
            const valores = [];
            let valorActual = '';
            let dentroComillas = false;
            
            for (let i = 0; i < linea.length; i++) {
                const char = linea[i];
                const nextChar = linea[i + 1];
                
                if (char === '"') {
                    // Manejar comillas dobles escapadas ("")
                    if (dentroComillas && nextChar === '"') {
                        valorActual += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        dentroComillas = !dentroComillas;
                        // No agregar las comillas al valor
                    }
                } else if (char === ',' && !dentroComillas) {
                    valores.push(valorActual);
                    valorActual = '';
                } else {
                    valorActual += char;
                }
            }
            
            // Agregar el √∫ltimo valor
            valores.push(valorActual);
            
            return valores;
        }

        // Funci√≥n para limpiar valores del CSV
        function limpiarValorCSV(valor) {
            if (!valor) return '';
            
            // Remover espacios al inicio y final
            valor = valor.trim();
            
            // Remover comillas exteriores si existen
            if ((valor.startsWith('"') && valor.endsWith('"')) || 
                (valor.startsWith("'") && valor.endsWith("'"))) {
                valor = valor.slice(1, -1);
            }
            
            return valor;
        }

        function normalizarTelefono(telefono) {
            if (!telefono || telefono.trim() === '') {
                return null; // Permitir tel√©fono vac√≠o
            }
            let telefonoNormalizado = telefono.trim();
            // Remover espacios, guiones, par√©ntesis
            telefonoNormalizado = telefonoNormalizado.replace(/[\s\-\(\)]/g, '');
            // Agregar c√≥digo de pa√≠s si no lo tiene
            if (!telefonoNormalizado.startsWith('506')) {
                telefonoNormalizado = '506' + telefonoNormalizado;
            }
            return telefonoNormalizado;
        }

        function validarRuta(ruta) {
            const rutasValidas = [
                'Sin asignar', 'Ruta 1', 'Ruta 2', 'Ruta 3', 'Ruta 4', 
                'Ruta 5', 'Ruta 6', 'Ruta 7', 'Ruta 8', 
                'Ruta 9', 'Ruta 10', 'Ruta 11', 'Ruta 12', 'Ruta 13', 'Ruta 14', 'Ruta 15',
                'Ruta 16', 'Ruta 17', 'Ruta 18', 'Ruta 19', 'Ruta 20'
            ];
            if (!ruta || ruta.trim() === '') {
                return 'Sin asignar';
            }
            const rutaNormalizada = ruta.trim();
            
            // Si ya est√° en el formato correcto, retornarlo
            if (rutasValidas.includes(rutaNormalizada)) {
                return rutaNormalizada;
            }
            
            // Si es solo un n√∫mero (1-20), convertirlo a "Ruta X"
            const numeroRuta = parseInt(rutaNormalizada);
            if (!isNaN(numeroRuta) && numeroRuta >= 1 && numeroRuta <= 20) {
                return `Ruta ${numeroRuta}`;
            }
            
            // Si no es v√°lido, retornar "Sin asignar"
            return 'Sin asignar';
        }
        
        // Exponer validarRuta a window para que est√© disponible globalmente
        window.validarRuta = validarRuta;
        
        // Funci√≥n para convertir veh√≠culo (APV 01, APV 02, etc.) a ruta (Ruta 1, Ruta 2, etc.)
        function vehiculoARuta(vehiculo) {
            if (!vehiculo || vehiculo.trim() === '') {
                return 'Sin asignar';
            }
            
            const vehiculoNormalizado = vehiculo.trim();
            
            // Mapeo directo: APV 01 -> Ruta 1, APV 02 -> Ruta 2, etc.
            const matchAPV = vehiculoNormalizado.match(/^APV\s*0?(\d+)$/i);
            if (matchAPV) {
                const numeroRuta = parseInt(matchAPV[1]);
                if (numeroRuta >= 1 && numeroRuta <= 20) {
                    return `Ruta ${numeroRuta}`;
                }
            }
            
            // Si no es APV, usar validarRuta para otros formatos
            return validarRuta(vehiculoNormalizado);
        }
        
        // Mantener compatibilidad temporal
        function validarVehiculo(vehiculo) {
            return vehiculoARuta(vehiculo);
        }

        async function cargarCitasDesdeCSV() {
            const inputCSV = document.getElementById('inputCSV');
            const btnCargarCSV = document.getElementById('btnCargarCSV');
            
            if (!inputCSV || !btnCargarCSV) return;

            // Abrir selector de archivos
            inputCSV.click();
        }
        
        // Funci√≥n para solicitar URL de Google Sheets
        function solicitarURLGoogleSheets(esActualizar) {
            const mensaje = esActualizar 
                ? 'Ingresa la URL p√∫blica de Google Sheets (debe estar publicada como CSV)\n\nEjemplo: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing\n\nO la URL directa del CSV: https://docs.google.com/spreadsheets/d/ID/export?format=csv&gid=0'
                : 'Ingresa la URL p√∫blica de Google Sheets (debe estar publicada como CSV)\n\nEjemplo: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing\n\nO la URL directa del CSV: https://docs.google.com/spreadsheets/d/ID/export?format=csv&gid=0';
            
            const url = prompt(mensaje);
            if (!url || url.trim() === '') {
                return;
            }
            
            // Convertir URL de Google Sheets a URL de exportaci√≥n CSV si es necesario
            let urlCSV = convertirURLGoogleSheetsACSV(url.trim());
            
            if (esActualizar) {
                procesarGoogleSheetsActualizar(urlCSV);
            } else {
                procesarGoogleSheets(urlCSV);
            }
        }
        
        // Funci√≥n para convertir URL de Google Sheets a URL de exportaci√≥n CSV
        function convertirURLGoogleSheetsACSV(url) {
            // Si ya es una URL de exportaci√≥n CSV, retornarla tal cual
            if (url.includes('/export?format=csv') || url.includes('output=csv')) {
                return url;
            }
            
            // Formato 1: URL de "Publicar en la web" (pubhtml)
            // Ejemplo: https://docs.google.com/spreadsheets/d/e/2PACX-.../pubhtml?gid=0&single=true
            const matchPub = url.match(/\/spreadsheets\/d\/e\/([a-zA-Z0-9-_]+)/);
            if (matchPub && matchPub[1]) {
                const pubId = matchPub[1];
                const gidMatch = url.match(/[#&?]gid=(\d+)/);
                const gid = gidMatch ? gidMatch[1] : '0';
                // Convertir pubhtml a pub con output=csv
                return `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?output=csv&gid=${gid}`;
            }
            
            // Formato 2: URL normal de Google Sheets
            // Ejemplo: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!match || !match[1]) {
                alert('URL de Google Sheets inv√°lida. Por favor, verifica que sea una URL v√°lida de Google Sheets.');
                return null;
            }
            
            const sheetId = match[1];
            
            // Extraer el GID si est√° presente (n√∫mero de hoja)
            const gidMatch = url.match(/[#&?]gid=(\d+)/);
            const gid = gidMatch ? gidMatch[1] : '0';
            
            // Construir URL de exportaci√≥n CSV
            return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
        }
        
        // Funci√≥n auxiliar para descargar CSV desde Google Sheets con manejo de CORS
        async function descargarCSVDesdeGoogleSheets(urlCSV) {
            // M√©todo 1: Intentar fetch directo
            try {
                console.log('üîÑ Intentando descarga directa...', urlCSV);
                const response = await fetch(urlCSV, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const texto = await response.text();
                    if (texto && texto.trim().length > 0) {
                        console.log('‚úÖ Descarga directa exitosa');
                        return texto;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Fetch directo fall√≥:', error.message);
            }
            
            // M√©todo 2: Usar proxy p√∫blico de CORS
            try {
                console.log('üîÑ Intentando con proxy CORS...');
                const proxyURL = `https://api.allorigins.win/raw?url=${encodeURIComponent(urlCSV)}`;
                const response = await fetch(proxyURL);
                
                if (response.ok) {
                    const texto = await response.text();
                    if (texto && texto.trim().length > 0) {
                        console.log('‚úÖ Descarga con proxy exitosa');
                        return texto;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Proxy fall√≥:', error.message);
            }
            
            // Si todos los m√©todos fallan
            throw new Error(`No se pudo descargar el Google Sheets debido a restricciones de CORS.\n\nPor favor:\n1. Aseg√∫rate de que la hoja est√© publicada como "Cualquiera con el enlace puede ver"\n2. Ve a Archivo ‚Üí Compartir ‚Üí Publicar en la web ‚Üí Publicar como CSV\n3. O descarga el CSV manualmente y √∫salo con el bot√≥n "Cargar CSV"`);
        }
        
        // Funci√≥n para procesar Google Sheets (cargar)
        async function procesarGoogleSheets(urlCSV) {
            if (!urlCSV) return;
            
            const btnCargar = document.getElementById('btnCargarGoogleSheets');
            const textoOriginal = btnCargar ? btnCargar.innerHTML : '';
            
            try {
                if (btnCargar) {
                    btnCargar.disabled = true;
                    btnCargar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cargando desde Google Sheets...';
                }
                
                // Descargar CSV desde la URL usando funci√≥n auxiliar
                const textoCSV = await descargarCSVDesdeGoogleSheets(urlCSV);
                const datos = parsearCSV(textoCSV);
                
                if (datos.length === 0) {
                    throw new Error('No se encontraron datos en el Google Sheets');
                }
                
                // Confirmar antes de crear
                const confirmacion = confirm(
                    `Se encontraron ${datos.length} citas en Google Sheets.\n\n` +
                    `¬øDeseas crear estas citas en el sistema?\n\n` +
                    `Nota: Las citas con tel√©fono vac√≠o se crear√°n sin tel√©fono.`
                );
                
                if (!confirmacion) {
                    if (btnCargar) {
                        btnCargar.disabled = false;
                        btnCargar.innerHTML = textoOriginal;
                    }
                    return;
                }
                
                // Usar la misma l√≥gica que procesarArchivoCSV
                const btnCargarCSV = document.getElementById('btnCargarCSV');
                let citasCreadas = 0;
                let errores = [];
                
                if (btnCargarCSV) {
                    btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;
                }
                
                // Procesar cada fila (reutilizar l√≥gica de procesarArchivoCSV)
                for (let i = 0; i < datos.length; i++) {
                    const fila = datos[i];
                    
                    try {
                        // Validar fecha de inicio
                        if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                            errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                            continue;
                        }

                        // Parsear fecha (formato: 2025-11-14T01:00:00-06:00)
                        const fechaInicio = new Date(fila.inicio_gmt6);
                        if (isNaN(fechaInicio.getTime())) {
                            errores.push(`Fila ${i + 2}: Fecha de inicio inv√°lida: ${fila.inicio_gmt6}`);
                            continue;
                        }

                        // Validar tel√©fono
                        let telefono = fila.telefono ? fila.telefono.trim() : '';
                        if (telefono) {
                            telefono = window.normalizarTelefono ? window.normalizarTelefono(telefono) : telefono;
                        }
                        
                        // Si no hay tel√©fono, crear uno temporal
                        if (!telefono || telefono === '') {
                            telefono = `temp_${Date.now()}_${i}`;
                        }

                        // Validar duraci√≥n
                        const duracionMinutos = parseInt(fila.duracion_minutos) || 60;
                        if (duracionMinutos <= 0) {
                            errores.push(`Fila ${i + 2}: Duraci√≥n inv√°lida: ${fila.duracion_minutos}`);
                            continue;
                        }

                        // Validar y normalizar ruta (el CSV tiene columna ruta)
                        const ruta = window.validarRuta ? window.validarRuta(fila.ruta || 'Sin asignar') : (fila.ruta || 'Sin asignar');
                        
                        // Estado
                        const estado = fila.estado && fila.estado.trim() !== '' 
                            ? fila.estado.trim() 
                            : 'agendada';

                        // Monto
                        const monto = parseInt(fila.monto) || 0;

                        // Cliente nombre
                        const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                            ? fila.cliente_nombre.trim() 
                            : 'Sin nombre';

                        // Iniciales
                        const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                            ? fila.iniciales.trim() 
                            : '';

                        // Observaciones
                        let observaciones = '';
                        if (fila.observaciones && fila.observaciones.trim() !== '') {
                            observaciones = fila.observaciones.trim();
                        }

                        // Direcci√≥n
                        let direccion = '';
                        if (fila.direccion && fila.direccion.trim() !== '') {
                            direccion = fila.direccion.trim();
                        } else if (observaciones) {
                            const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                            if (urlMatch) {
                                direccion = urlMatch[0];
                            }
                        }

                        // Parsear vendedores
                        let vendedores = [];
                        if (fila.vendedores && fila.vendedores.trim() !== '') {
                            let vendedoresStr = String(fila.vendedores).trim();
                            while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                   (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                vendedoresStr = vendedoresStr.slice(1, -1).trim();
                            }
                            
                            if (vendedoresStr && vendedoresStr !== '') {
                                try {
                                    const parsed = JSON.parse(vendedoresStr);
                                    if (Array.isArray(parsed)) {
                                        vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                    } else {
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                } catch (e) {
                                    vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                }
                                
                                vendedores = vendedores
                                    .map(v => {
                                        let vendedor = v.trim();
                                        while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                               (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                            vendedor = vendedor.slice(1, -1).trim();
                                        }
                                        return vendedor;
                                    })
                                    .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                    .map(v => v.toLowerCase());
                            }
                        }

                        // Convertir fecha a Timestamp GMT-06
                        const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                        // Crear o actualizar documento del cliente con el nombre
                        if (telefono && !telefono.startsWith('temp_')) {
                            try {
                                let cliente = await window.buscarCliente(telefono);
                                if (!cliente) {
                                    await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                } else {
                                    if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                        await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        cliente.nombre = clienteNombre.trim();
                                    }
                                }
                            } catch (error) {
                                console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                            }
                        }

                        // Obtener nombre del cliente para guardarlo en metadata (fallback para renderizado r√°pido)
                        const nombreClienteParaMetadata = clienteNombre !== 'Sin nombre' ? clienteNombre : '';

                        // Crear objeto metadata
                        const metadata = {
                            cliente_nombre: nombreClienteParaMetadata,
                            sucursalIndice: null,
                            ruta: ruta,
                            estado: estado,
                            monto: monto,
                            costo_servicio: 20000,
                            vendedores: vendedores,
                            observaciones: observaciones
                        };

                        // Agregar campos opcionales
                        if (fila.vehiculo) {
                            metadata.vehiculo = fila.vehiculo;
                        }
                        if (iniciales) {
                            metadata.iniciales = iniciales;
                        }
                        if (direccion) {
                            metadata.direccion = direccion;
                        }

                        // Verificar si ya existe una cita duplicada (mismo tel√©fono, fecha/hora y ruta)
                        // Solo verificar en modo "Cargar" (no "Actualizar", que ya elimina el rango)
                        let esDuplicado = false;
                        if (btnCargarCSV) {
                            try {
                                const qDuplicado = query(
                                    collection(window.db, 'citas'),
                                    where('telefono', '==', telefono),
                                    where('inicio_gmt6', '==', timestampGMT6)
                                );
                                const snapshotDuplicado = await getDocs(qDuplicado);
                                
                                snapshotDuplicado.forEach(doc => {
                                    const citaExistente = doc.data();
                                    const rutaExistente = citaExistente.metadata?.ruta || citaExistente.ruta || '';
                                    if (rutaExistente === ruta) {
                                        esDuplicado = true;
                                    }
                                });
                            } catch (error) {
                                // Si falla la query (por ejemplo, falta √≠ndice), continuar sin verificar
                                console.warn(`No se pudo verificar duplicado para fila ${i + 2}:`, error);
                            }
                        }
                        
                        if (esDuplicado) {
                            console.warn(`‚ö†Ô∏è Cita duplicada omitida (fila ${i + 2}): tel√©fono=${telefono}, fecha=${timestampGMT6.toDate().toLocaleString('es-ES')}, ruta=${ruta}`);
                            errores.push(`Fila ${i + 2}: Cita duplicada (ya existe con mismo tel√©fono, fecha y ruta)`);
                            continue;
                        }

                        // Crear cita
                        const nuevaCita = {
                            telefono: telefono,
                            inicio_gmt6: timestampGMT6,
                            duracion_minutos: duracionMinutos,
                            metadata: metadata,
                            fecha_creacion: serverTimestamp(),
                            version_esquema: 1
                        };

                        await addDoc(collection(window.db, 'citas'), nuevaCita);
                        citasCreadas++;

                        if (btnCargarCSV) {
                            btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;
                        }

                    } catch (error) {
                        console.error(`Error procesando fila ${i + 2}:`, error);
                        errores.push(`Fila ${i + 2}: ${error.message}`);
                    }
                }

                // Mostrar resultado
                let mensaje = `‚úÖ Citas creadas desde Google Sheets: ${citasCreadas}\n`;
                if (errores.length > 0) {
                    mensaje += `\n‚ö†Ô∏è Errores (${errores.length}):\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} m√°s`;
                    }
                }

                alert(mensaje);

                // Recargar datos
                if (window.cargarDatos) {
                    await window.cargarDatos();
                }

                if (btnCargarCSV) {
                    btnCargarCSV.disabled = false;
                    btnCargarCSV.innerHTML = '<i class="fas fa-file-csv me-2"></i>Cargar CSV';
                }
                
                if (btnCargar) {
                    btnCargar.disabled = false;
                    btnCargar.innerHTML = textoOriginal;
                }
                
            } catch (error) {
                console.error('Error procesando Google Sheets:', error);
                alert('Error al cargar desde Google Sheets: ' + error.message + '\n\nAseg√∫rate de que:\n1. La hoja est√© publicada como "Cualquiera con el enlace puede ver"\n2. La URL sea correcta\n3. La hoja tenga datos');
                if (btnCargar) {
                    btnCargar.disabled = false;
                    btnCargar.innerHTML = textoOriginal;
                }
            }
        }
        
        // Funci√≥n para procesar Google Sheets (actualizar)
        async function procesarGoogleSheetsActualizar(urlCSV) {
            if (!urlCSV) return;
            
            const btnActualizar = document.getElementById('btnActualizarGoogleSheets');
            const textoOriginal = btnActualizar ? btnActualizar.innerHTML : '';
            
            try {
                if (btnActualizar) {
                    btnActualizar.disabled = true;
                    btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analizando Google Sheets...';
                }
                
                // Descargar CSV desde la URL usando funci√≥n auxiliar
                const textoCSV = await descargarCSVDesdeGoogleSheets(urlCSV);
                const datos = parsearCSV(textoCSV);
                
                if (datos.length === 0) {
                    throw new Error('No se encontraron datos en el Google Sheets');
                }

                // Determinar rango de fechas del Google Sheets
                let fechaMin = null;
                let fechaMax = null;
                
                for (const fila of datos) {
                    if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') continue;
                    
                    try {
                        const fechaInicio = new Date(fila.inicio_gmt6);
                        if (isNaN(fechaInicio.getTime())) continue;
                        
                        if (!fechaMin || fechaInicio < fechaMin) {
                            fechaMin = new Date(fechaInicio);
                        }
                        if (!fechaMax || fechaInicio > fechaMax) {
                            fechaMax = new Date(fechaInicio);
                        }
                    } catch (error) {
                        console.warn('Error parseando fecha:', fila.inicio_gmt6, error);
                    }
                }

                if (!fechaMin || !fechaMax) {
                    throw new Error('No se pudieron determinar las fechas del Google Sheets. Verifica que la columna inicio_gmt6 tenga fechas v√°lidas.');
                }

                // Ajustar rango para incluir todo el d√≠a (00:00:00 a 23:59:59)
                fechaMin.setHours(0, 0, 0, 0);
                fechaMax.setHours(23, 59, 59, 999);

                const fechaMinStr = fechaMin.toLocaleDateString('es-CR');
                const fechaMaxStr = fechaMax.toLocaleDateString('es-CR');

                // Confirmar antes de actualizar
                const confirmacion = confirm(
                    `Se encontraron ${datos.length} citas en Google Sheets.\n\n` +
                    `Rango de fechas: ${fechaMinStr} a ${fechaMaxStr}\n\n` +
                    `‚ö†Ô∏è ADVERTENCIA: Se eliminar√°n TODAS las citas existentes en este rango de fechas y se crear√°n las nuevas del Google Sheets.\n\n` +
                    `Las citas fuera de este rango NO se modificar√°n.\n\n` +
                    `¬øDeseas continuar?`
                );

                if (!confirmacion) {
                    if (btnActualizar) {
                        btnActualizar.disabled = false;
                        btnActualizar.innerHTML = textoOriginal;
                    }
                    return;
                }

                if (btnActualizar) {
                    btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando citas del rango...';
                }

                // Buscar y eliminar citas en el rango de fechas
                const q = query(
                    collection(window.db, 'citas'),
                    where('inicio_gmt6', '>=', Timestamp.fromDate(fechaMin)),
                    where('inicio_gmt6', '<=', Timestamp.fromDate(fechaMax)),
                    orderBy('inicio_gmt6', 'desc')
                );

                const querySnapshot = await getDocs(q);
                const citasAEliminar = [];
                querySnapshot.forEach((docSnapshot) => {
                    citasAEliminar.push(docSnapshot.id);
                });

                let citasEliminadas = 0;
                if (citasAEliminar.length > 0) {
                    // Eliminar en lotes de 10
                    const batchSize = 10;
                    for (let i = 0; i < citasAEliminar.length; i += batchSize) {
                        const batch = citasAEliminar.slice(i, i + batchSize);
                        const promises = batch.map(citaId => 
                            deleteDoc(doc(window.db, 'citas', citaId))
                        );
                        await Promise.all(promises);
                        citasEliminadas += batch.length;
                    }
                }

                console.log(`‚úÖ Eliminadas ${citasEliminadas} citas del rango ${fechaMinStr} a ${fechaMaxStr}`);

                // Ahora crear las nuevas citas (reutilizar l√≥gica de procesarGoogleSheets)
                if (btnActualizar) {
                    btnActualizar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;
                }

                // Reutilizar la misma l√≥gica de creaci√≥n que procesarGoogleSheets
                let citasCreadas = 0;
                let errores = [];

                for (let i = 0; i < datos.length; i++) {
                    const fila = datos[i];
                    
                    try {
                        // Validar fecha de inicio
                        if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                            errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                            continue;
                        }

                        // Parsear fecha
                        const fechaInicio = new Date(fila.inicio_gmt6);
                        if (isNaN(fechaInicio.getTime())) {
                            errores.push(`Fila ${i + 2}: Fecha de inicio inv√°lida: ${fila.inicio_gmt6}`);
                            continue;
                        }

                        // Validar tel√©fono
                        let telefono = fila.telefono ? fila.telefono.trim() : '';
                        if (telefono) {
                            telefono = window.normalizarTelefono ? window.normalizarTelefono(telefono) : telefono;
                        }
                        
                        if (!telefono || telefono === '') {
                            telefono = `temp_${Date.now()}_${i}`;
                        }

                        // Validar duraci√≥n
                        const duracionMinutos = parseInt(fila.duracion_minutos) || 60;
                        if (duracionMinutos <= 0) {
                            errores.push(`Fila ${i + 2}: Duraci√≥n inv√°lida: ${fila.duracion_minutos}`);
                            continue;
                        }

                        // Validar y normalizar ruta
                        const ruta = window.validarRuta ? window.validarRuta(fila.ruta || 'Sin asignar') : (fila.ruta || 'Sin asignar');
                        
                        // Estado
                        const estado = fila.estado && fila.estado.trim() !== '' 
                            ? fila.estado.trim() 
                            : 'agendada';

                        // Monto
                        const monto = parseInt(fila.monto) || 0;

                        // Cliente nombre
                        const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                            ? fila.cliente_nombre.trim() 
                            : 'Sin nombre';

                        // Iniciales
                        const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                            ? fila.iniciales.trim() 
                            : '';

                        // Observaciones
                        let observaciones = '';
                        if (fila.observaciones && fila.observaciones.trim() !== '') {
                            observaciones = fila.observaciones.trim();
                        }

                        // Direcci√≥n
                        let direccion = '';
                        if (fila.direccion && fila.direccion.trim() !== '') {
                            direccion = fila.direccion.trim();
                        } else if (observaciones) {
                            const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                            if (urlMatch) {
                                direccion = urlMatch[0];
                            }
                        }

                        // Parsear vendedores
                        let vendedores = [];
                        if (fila.vendedores && fila.vendedores.trim() !== '') {
                            let vendedoresStr = String(fila.vendedores).trim();
                            while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                   (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                vendedoresStr = vendedoresStr.slice(1, -1).trim();
                            }
                            
                            if (vendedoresStr && vendedoresStr !== '') {
                                try {
                                    const parsed = JSON.parse(vendedoresStr);
                                    if (Array.isArray(parsed)) {
                                        vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                    } else {
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                } catch (e) {
                                    vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                }
                                
                                vendedores = vendedores
                                    .map(v => {
                                        let vendedor = v.trim();
                                        while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                               (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                            vendedor = vendedor.slice(1, -1).trim();
                                        }
                                        return vendedor;
                                    })
                                    .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                    .map(v => v.toLowerCase());
                            }
                        }

                        // Convertir fecha a Timestamp GMT-06
                        const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                        // Crear o actualizar documento del cliente
                        if (telefono && !telefono.startsWith('temp_')) {
                            try {
                                let cliente = await window.buscarCliente(telefono);
                                if (!cliente) {
                                    await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                } else {
                                    if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                        await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        cliente.nombre = clienteNombre.trim();
                                    }
                                }
                            } catch (error) {
                                console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                            }
                        }

                        // Obtener nombre del cliente para metadata
                        const nombreClienteParaMetadata = clienteNombre !== 'Sin nombre' ? clienteNombre : '';

                        // Crear objeto metadata
                        const metadata = {
                            cliente_nombre: nombreClienteParaMetadata,
                            sucursalIndice: null,
                            ruta: ruta,
                            estado: estado,
                            monto: monto,
                            costo_servicio: 20000,
                            vendedores: vendedores,
                            observaciones: observaciones
                        };

                        // Agregar campos opcionales
                        if (fila.vehiculo) {
                            metadata.vehiculo = fila.vehiculo;
                        }
                        if (iniciales) {
                            metadata.iniciales = iniciales;
                        }
                        if (direccion) {
                            metadata.direccion = direccion;
                        }

                        // Crear cita
                        const nuevaCita = {
                            telefono: telefono,
                            inicio_gmt6: timestampGMT6,
                            duracion_minutos: duracionMinutos,
                            metadata: metadata,
                            fecha_creacion: serverTimestamp(),
                            version_esquema: 1
                        };

                        await addDoc(collection(window.db, 'citas'), nuevaCita);
                        citasCreadas++;

                        if (btnActualizar) {
                            btnActualizar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;
                        }

                    } catch (error) {
                        console.error(`Error procesando fila ${i + 2}:`, error);
                        errores.push(`Fila ${i + 2}: ${error.message}`);
                    }
                }

                // Mostrar resultado
                let mensaje = `‚úÖ Actualizaci√≥n completada:\n\n`;
                mensaje += `- Citas eliminadas del rango: ${citasEliminadas}\n`;
                mensaje += `- Citas creadas desde Google Sheets: ${citasCreadas}\n`;
                mensaje += `- Rango de fechas: ${fechaMinStr} a ${fechaMaxStr}\n`;
                
                if (errores.length > 0) {
                    mensaje += `\n‚ö†Ô∏è Errores (${errores.length}):\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} m√°s`;
                    }
                }

                alert(mensaje);

                // Recargar datos
                if (window.cargarDatos) {
                    await window.cargarDatos();
                }
                
                if (btnActualizar) {
                    btnActualizar.disabled = false;
                    btnActualizar.innerHTML = textoOriginal;
                }
                
            } catch (error) {
                console.error('Error procesando Google Sheets:', error);
                alert('Error al actualizar desde Google Sheets: ' + error.message + '\n\nAseg√∫rate de que:\n1. La hoja est√© publicada como "Cualquiera con el enlace puede ver"\n2. La URL sea correcta\n3. La hoja tenga datos');
                if (btnActualizar) {
                    btnActualizar.disabled = false;
                    btnActualizar.innerHTML = textoOriginal;
                }
            }
        }

        async function procesarArchivoCSV(archivo) {
            if (!archivo) return;

            if (!archivo.name.endsWith('.csv')) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }

            const btnCargarCSV = document.getElementById('btnCargarCSV');
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    btnCargarCSV.disabled = true;
                    btnCargarCSV.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';

                    const textoCSV = e.target.result;
                    const datos = parsearCSV(textoCSV);

                    if (datos.length === 0) {
                        throw new Error('No se encontraron datos en el CSV');
                    }

                    // Confirmar antes de crear
                    const confirmacion = confirm(
                        `Se encontraron ${datos.length} citas en el CSV.\n\n` +
                        `¬øDeseas crear estas citas en el sistema?\n\n` +
                        `Nota: Las citas con tel√©fono vac√≠o se crear√°n sin tel√©fono.`
                    );

                    if (!confirmacion) {
                        btnCargarCSV.disabled = false;
                        btnCargarCSV.innerHTML = '<i class="fas fa-file-csv me-2"></i>Cargar CSV';
                        return;
                    }

                    let citasCreadas = 0;
                    let errores = [];

                    btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;

                    for (let i = 0; i < datos.length; i++) {
                        const fila = datos[i];
                        
                        try {
                            // Validar fecha de inicio
                            if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                                errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                                continue;
                            }

                            // Parsear fecha (formato: 2025-11-14T01:00:00-06:00)
                            const fechaInicio = new Date(fila.inicio_gmt6);
                            if (isNaN(fechaInicio.getTime())) {
                                errores.push(`Fila ${i + 2}: Fecha de inicio inv√°lida: ${fila.inicio_gmt6}`);
                                continue;
                            }

                            // Validar duraci√≥n
                            const duracion = parseInt(fila.duracion_minutos) || 60;
                            if (duracion < 15) {
                                errores.push(`Fila ${i + 2}: Duraci√≥n m√≠nima es 15 minutos`);
                                continue;
                            }

                            // Normalizar tel√©fono
                            let telefono = normalizarTelefono(fila.telefono);
                            
                            // Si no hay tel√©fono, crear uno temporal √∫nico
                            if (!telefono) {
                                telefono = `temp_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 9)}`;
                            }

                            // Validar y normalizar ruta
                            const ruta = validarRuta(fila.ruta);

                            // Veh√≠culo (guardar en metadata aunque no se use para la ruta)
                            const vehiculo = fila.vehiculo && fila.vehiculo.trim() !== '' 
                                ? fila.vehiculo.trim() 
                                : '';

                            // Parsear monto
                            const monto = fila.monto && fila.monto.trim() !== '' 
                                ? parseInt(fila.monto) || 0 
                                : 0;

                            // Validar estado
                            const estado = fila.estado && fila.estado.trim() !== '' 
                                ? fila.estado.trim() 
                                : 'agendada';

                            // Cliente nombre
                            const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                                ? fila.cliente_nombre.trim() 
                                : 'Sin nombre';

                            // Iniciales (guardar en metadata)
                            const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                                ? fila.iniciales.trim() 
                                : '';

                            // Observaciones (preservar saltos de l√≠nea y HTML, pero limpiar espacios innecesarios)
                            let observaciones = '';
                            if (fila.observaciones && fila.observaciones.trim() !== '') {
                                observaciones = fila.observaciones.trim();
                                // Preservar saltos de l√≠nea y contenido HTML tal como viene
                            }

                            // Direcci√≥n (puede venir en observaciones o como campo separado)
                            let direccion = '';
                            if (fila.direccion && fila.direccion.trim() !== '') {
                                direccion = fila.direccion.trim();
                            } else if (observaciones) {
                                // Intentar extraer direcci√≥n de observaciones si contiene enlaces de Google Maps o Waze
                                const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                                if (urlMatch) {
                                    direccion = urlMatch[0];
                                }
                            }

                            // Parsear vendedores
                            // Formato esperado: string separado por comas (ej: "username1,username2") o array JSON
                            let vendedores = [];
                            if (fila.vendedores && fila.vendedores.trim() !== '') {
                                let vendedoresStr = String(fila.vendedores).trim();
                                
                                // Remover comillas exteriores si existen (puede haber m√∫ltiples niveles)
                                while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                       (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                    vendedoresStr = vendedoresStr.slice(1, -1).trim();
                                }
                                
                                // Si est√° vac√≠o despu√©s de limpiar, salir
                                if (!vendedoresStr || vendedoresStr === '') {
                                    vendedores = [];
                                } else {
                                    try {
                                        // Intentar parsear como JSON array primero
                                        const parsed = JSON.parse(vendedoresStr);
                                        if (Array.isArray(parsed)) {
                                            vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                        } else {
                                            // Si no es array, tratarlo como string separado por comas
                                            vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                        }
                                    } catch (e) {
                                        // Si falla el parse JSON, tratarlo como string separado por comas
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                    
                                    // Limpiar y validar cada vendedor
                                    vendedores = vendedores
                                        .map(v => {
                                            // Remover comillas adicionales que puedan quedar
                                            let vendedor = v.trim();
                                            while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                                   (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                                vendedor = vendedor.slice(1, -1).trim();
                                            }
                                            return vendedor;
                                        })
                                        .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                        .map(v => v.toLowerCase()); // Normalizar a min√∫sculas para consistencia
                                }
                                
                                console.log(`üìã Vendedores parseados para fila ${i + 2} (original: "${fila.vendedores}"):`, vendedores);
                            }

                            // Convertir fecha a Timestamp GMT-06
                            const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                            // Crear o actualizar documento del cliente con el nombre
                            // El nombre pertenece SOLO al nivel de Cliente, no a la cita
                            // Solo hacerlo si el tel√©fono es v√°lido (no es temporal)
                            if (telefono && !telefono.startsWith('temp_')) {
                                try {
                                    let cliente = await window.buscarCliente(telefono);
                                    if (!cliente) {
                                        // Crear nuevo cliente
                                        await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                    } else {
                                        // Actualizar nombre del cliente si fue modificado
                                        if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                            await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        }
                                    }
                                } catch (error) {
                                    console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                                    // Continuar con la creaci√≥n de la cita aunque falle la actualizaci√≥n del cliente
                                }
                            }

                            // Crear objeto metadata con todos los campos relevantes
                            // cliente_nombre: guardado como fallback para renderizado r√°pido (el nombre oficial est√° en clientes/{telefono}.nombre)
                            const metadata = {
                                    cliente_nombre: clienteNombre !== 'Sin nombre' ? clienteNombre : '', // Guardar nombre del CSV en metadata para renderizado r√°pido
                                    // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                                    sucursalIndice: null, // No hay informaci√≥n de sucursal en CSV, puede ser null
                                    ruta: ruta,
                                    estado: estado,
                                    monto: monto,
                                    costo_servicio: 20000, // Costo del servicio por defecto
                                vendedores: vendedores, // Array de usernames
                                    observaciones: observaciones
                            };

                            // Agregar campos opcionales solo si tienen valor
                            if (vehiculo) {
                                metadata.vehiculo = vehiculo;
                            }
                            if (iniciales) {
                                metadata.iniciales = iniciales;
                            }
                            if (direccion) {
                                metadata.direccion = direccion;
                            }

                            // Crear cita
                            const nuevaCita = {
                                telefono: telefono,
                                inicio_gmt6: timestampGMT6,
                                duracion_minutos: duracion,
                                metadata: metadata,
                                fecha_creacion: serverTimestamp(),
                                version_esquema: 1
                            };

                            await addDoc(collection(window.db, 'citas'), nuevaCita);
                            citasCreadas++;

                            // Actualizar progreso cada 10 citas
                            if (citasCreadas % 10 === 0 || citasCreadas === datos.length) {
                                btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;
                            }

                        } catch (error) {
                            console.error(`Error creando cita de fila ${i + 2}:`, error);
                            errores.push(`Fila ${i + 2}: ${error.message}`);
                        }
                    }

                    // Recargar datos
                    await cargarDatos();

                    // Mostrar resultado
                    let mensaje = `‚úÖ ${citasCreadas} citas creadas exitosamente`;
                    if (errores.length > 0) {
                        mensaje += `\n\n‚ö†Ô∏è ${errores.length} errores:\n${errores.slice(0, 10).join('\n')}`;
                        if (errores.length > 10) {
                            mensaje += `\n... y ${errores.length - 10} errores m√°s`;
                        }
                    }

                    const notification = document.createElement('div');
                    notification.className = errores.length > 0 ? 'alert alert-warning position-fixed' : 'alert alert-success position-fixed';
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; white-space: pre-line;';
                    notification.innerHTML = `<i class="fas fa-${errores.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>${mensaje}`;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, errores.length > 0 ? 10000 : 5000);

                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error procesando CSV: ' + error.message);
                } finally {
                    btnCargarCSV.disabled = false;
                    btnCargarCSV.innerHTML = '<i class="fas fa-file-csv me-2"></i>Cargar CSV';
                    // Limpiar input
                    document.getElementById('inputCSV').value = '';
                }
            };

            reader.readAsText(archivo);
        }

        // Funci√≥n para eliminar citas por filtro
        async function eliminarCitasPorFiltro(tipo) {
            const btnEliminar = document.getElementById('btnConfirmarEliminacion');
            if (!btnEliminar) return;

            try {
                btnEliminar.disabled = true;
                btnEliminar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';

                let q;
                const fechaInicioRango = document.getElementById('fechaInicioRango');
                const fechaFinRango = document.getElementById('fechaFinRango');
                const fechaMayor = document.getElementById('fechaMayor');
                const fechaMenor = document.getElementById('fechaMenor');

                // Construir query seg√∫n el tipo
                if (tipo === 'todas') {
                    // Obtener todas las citas
                    q = query(collection(window.db, 'citas'));
                } else if (tipo === 'rango') {
                    // Rango de fechas (inclusive)
                    const inicio = fechaInicioRango?.value;
                    const fin = fechaFinRango?.value;
                    
                    if (!inicio || !fin) {
                        alert('Por favor, complete ambas fechas del rango.');
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n';
                        return;
                    }
                    
                    // Crear timestamps para inicio y fin del d√≠a
                    const fechaInicio = new Date(inicio + 'T00:00:00');
                    const fechaFin = new Date(fin + 'T23:59:59');
                    const timestampInicio = Timestamp.fromDate(fechaInicio);
                    const timestampFin = Timestamp.fromDate(fechaFin);
                    
                    q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '>=', timestampInicio),
                        where('inicio_gmt6', '<=', timestampFin)
                    );
                } else if (tipo === 'mayor') {
                    // Mayor o igual a una fecha (inclusive)
                    const fecha = fechaMayor?.value;
                    
                    if (!fecha) {
                        alert('Por favor, complete la fecha l√≠mite.');
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n';
                        return;
                    }
                    
                    // Crear timestamp para inicio del d√≠a
                    const fechaLimite = new Date(fecha + 'T00:00:00');
                    const timestampLimite = Timestamp.fromDate(fechaLimite);
                    
                    q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '>=', timestampLimite)
                    );
                } else if (tipo === 'menor') {
                    // Menor o igual a una fecha (inclusive)
                    const fecha = fechaMenor?.value;
                    
                    if (!fecha) {
                        alert('Por favor, complete la fecha l√≠mite.');
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n';
                        return;
                    }
                    
                    // Crear timestamp para fin del d√≠a
                    const fechaLimite = new Date(fecha + 'T23:59:59');
                    const timestampLimite = Timestamp.fromDate(fechaLimite);
                    
                    q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '<=', timestampLimite)
                    );
                } else {
                    alert('Tipo de eliminaci√≥n no v√°lido.');
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n';
                    return;
                }

                const querySnapshot = await getDocs(q);
                const totalCitas = querySnapshot.size;
                
                if (totalCitas === 0) {
                    alert('No hay citas que coincidan con los criterios seleccionados.');
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n';
                    return;
                }

                btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (0/${totalCitas})...`;

                let citasEliminadas = 0;
                let errores = [];

                // Eliminar cada cita
                for (const docSnapshot of querySnapshot.docs) {
                    try {
                        await deleteDoc(doc(window.db, 'citas', docSnapshot.id));
                        citasEliminadas++;

                        // Actualizar progreso cada 10 citas
                        if (citasEliminadas % 10 === 0 || citasEliminadas === totalCitas) {
                            btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (${citasEliminadas}/${totalCitas})...`;
                        }
                    } catch (error) {
                        console.error(`Error eliminando cita ${docSnapshot.id}:`, error);
                        errores.push(`Error eliminando cita ${docSnapshot.id}: ${error.message}`);
                    }
                }

                // Recargar datos
                await cargarDatos();

                // Mostrar resultado
                let mensaje = `‚úÖ ${citasEliminadas} citas eliminadas exitosamente`;
                if (errores.length > 0) {
                    mensaje += `\n\n‚ö†Ô∏è ${errores.length} errores:\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} errores m√°s`;
                    }
                }

                const notification = document.createElement('div');
                notification.className = errores.length > 0 ? 'alert alert-warning position-fixed' : 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; white-space: pre-line;';
                notification.innerHTML = `<i class="fas fa-${errores.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>${mensaje}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, errores.length > 0 ? 10000 : 5000);

            } catch (error) {
                console.error('Error eliminando citas:', error);
                alert('Error eliminando citas: ' + error.message);
            } finally {
                if (btnEliminar) {
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n';
                }
            }
        }

        // Funci√≥n para eliminar todas las citas (SOLO PARA PRUEBAS) - DEPRECADA, usar eliminarCitasPorFiltro
        async function eliminarTodasLasCitas() {
            const btnEliminar = document.getElementById('btnEliminarTodasCitas');
            if (!btnEliminar) return;

            // Primera confirmaci√≥n
            const confirmacion1 = confirm(
                '‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° TODAS las citas de la base de datos.\n\n' +
                'Esta acci√≥n NO se puede deshacer.\n\n' +
                '¬øEst√°s seguro de que deseas continuar?'
            );

            if (!confirmacion1) return;

            // Segunda confirmaci√≥n (doble verificaci√≥n)
            const confirmacion2 = confirm(
                '‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\n' +
                'Vas a eliminar TODAS las citas permanentemente.\n\n' +
                'Escribe "ELIMINAR" en el siguiente prompt para confirmar.'
            );

            if (!confirmacion2) return;

            // Tercera confirmaci√≥n con texto
            const textoConfirmacion = prompt(
                'Para confirmar, escribe exactamente: ELIMINAR TODAS LAS CITAS\n\n' +
                '(Escribe el texto completo para continuar)'
            );

            if (textoConfirmacion !== 'ELIMINAR TODAS LAS CITAS') {
                alert('Operaci√≥n cancelada. El texto no coincide.');
                return;
            }

            try {
                btnEliminar.disabled = true;
                btnEliminar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';

                // Obtener todas las citas
                const q = query(collection(window.db, 'citas'));
                const querySnapshot = await getDocs(q);
                
                const totalCitas = querySnapshot.size;
                
                if (totalCitas === 0) {
                    alert('No hay citas para eliminar.');
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Eliminar Todas';
                    return;
                }

                btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (0/${totalCitas})...`;

                let citasEliminadas = 0;
                let errores = [];

                // Eliminar cada cita
                for (const docSnapshot of querySnapshot.docs) {
                    try {
                        await deleteDoc(doc(window.db, 'citas', docSnapshot.id));
                        citasEliminadas++;

                        // Actualizar progreso cada 10 citas
                        if (citasEliminadas % 10 === 0 || citasEliminadas === totalCitas) {
                            btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (${citasEliminadas}/${totalCitas})...`;
                        }
                    } catch (error) {
                        console.error(`Error eliminando cita ${docSnapshot.id}:`, error);
                        errores.push(`Error eliminando cita ${docSnapshot.id}: ${error.message}`);
                    }
                }

                // Recargar datos
                await cargarDatos();

                // Mostrar resultado
                let mensaje = `‚úÖ ${citasEliminadas} citas eliminadas exitosamente`;
                if (errores.length > 0) {
                    mensaje += `\n\n‚ö†Ô∏è ${errores.length} errores:\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} errores m√°s`;
                    }
                }

                const notification = document.createElement('div');
                notification.className = errores.length > 0 ? 'alert alert-warning position-fixed' : 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; white-space: pre-line;';
                notification.innerHTML = `<i class="fas fa-${errores.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>${mensaje}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, errores.length > 0 ? 10000 : 5000);

            } catch (error) {
                console.error('Error eliminando citas:', error);
                alert('Error eliminando citas: ' + error.message);
            } finally {
                btnEliminar.disabled = false;
                btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Eliminar Todas';
            }
        }

            // Event listeners para gesti√≥n de servicios
            const btnGestionarServicios = document.getElementById('btnGestionarServicios');
            if (btnGestionarServicios) {
                btnGestionarServicios.addEventListener('click', async () => {
                    // Cargar servicios antes de abrir el modal
                    await window.cargarServicios();
                    window.renderizarTablaServicios();
                    const modal = new bootstrap.Modal(document.getElementById('modalGestionarServicios'));
                    modal.show();
                });
            }
            
            // Event listeners para gesti√≥n de equipo
            const btnGestionarEquipo = document.getElementById('btnGestionarEquipo');
            if (btnGestionarEquipo) {
                btnGestionarEquipo.addEventListener('click', async () => {
                    // Cargar equipo antes de abrir el modal
                    await window.cargarEquipo();
                    window.renderizarTablaEquipo();
                    const modal = new bootstrap.Modal(document.getElementById('modalGestionarEquipo'));
                    modal.show();
                });
            }
            
            const btnAgregarEquipo = document.getElementById('btnAgregarEquipo');
            if (btnAgregarEquipo) {
                btnAgregarEquipo.addEventListener('click', async () => {
                    const nombreInput = document.getElementById('nuevoEquipoNombre');
                    
                    const nombre = nombreInput.value.trim();
                    
                    if (!nombre) {
                        alert('El nombre del equipo es requerido');
                        return;
                    }
                    
                    try {
                        btnAgregarEquipo.disabled = true;
                        btnAgregarEquipo.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando...';
                        
                        const nuevoEquipo = {
                            nombre: nombre,
                            fecha_creacion: serverTimestamp(),
                            fecha_actualizacion: serverTimestamp()
                        };
                        
                        const docRef = await addDoc(collection(window.db, 'equipo'), nuevoEquipo);
                        console.log('‚úÖ Equipo creado con ID:', docRef.id);
                        
                        // Limpiar formulario
                        nombreInput.value = '';
                        
                        // Recargar equipo y actualizar tabla
                        await window.cargarEquipo();
                        window.renderizarTablaEquipo();
                        
                        btnAgregarEquipo.innerHTML = '<i class="fas fa-check me-2"></i>Agregado';
                        setTimeout(() => {
                            btnAgregarEquipo.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Equipo';
                            btnAgregarEquipo.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error agregando equipo:', error);
                        alert('Error agregando equipo: ' + error.message);
                        btnAgregarEquipo.disabled = false;
                        btnAgregarEquipo.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Equipo';
                    }
                });
            }
            
            // Event listeners para botones de generar certificado
            const btnGenerarCertificadoEdit = document.getElementById('btnGenerarCertificadoEdit');
            if (btnGenerarCertificadoEdit) {
                btnGenerarCertificadoEdit.addEventListener('click', () => {
                    const textoCertificado = document.getElementById('editCertificados')?.value.trim() || '';
                    const fechaInicioInput = document.getElementById('editStartTime');
                    const duracionInput = document.getElementById('editDuration');
                    
                    if (!fechaInicioInput || !fechaInicioInput.value) {
                        alert('Por favor ingrese la fecha y hora de inicio de la cita');
                        return;
                    }
                    
                    const fechaInicio = new Date(fechaInicioInput.value);
                    const duracion = parseInt(duracionInput?.value || 0);
                    
                    if (window.generarCertificadoFumigacion) {
                        window.generarCertificadoFumigacion(textoCertificado, fechaInicio, duracion, 'edit');
                    }
                });
            }
            
            const btnGenerarCertificadoNew = document.getElementById('btnGenerarCertificadoNew');
            if (btnGenerarCertificadoNew) {
                btnGenerarCertificadoNew.addEventListener('click', () => {
                    const textoCertificado = document.getElementById('newCertificados')?.value.trim() || '';
                    const fechaInicioInput = document.getElementById('newStartTime');
                    const duracionInput = document.getElementById('newDuration');
                    
                    if (!fechaInicioInput || !fechaInicioInput.value) {
                        alert('Por favor ingrese la fecha y hora de inicio de la cita');
                        return;
                    }
                    
                    const fechaInicio = new Date(fechaInicioInput.value);
                    const duracion = parseInt(duracionInput?.value || 0);
                    
                    if (window.generarCertificadoFumigacion) {
                        window.generarCertificadoFumigacion(textoCertificado, fechaInicio, duracion, 'new');
                    }
                });
            }
            
            const btnAgregarServicio = document.getElementById('btnAgregarServicio');
            if (btnAgregarServicio) {
                btnAgregarServicio.addEventListener('click', async () => {
                    const nombreInput = document.getElementById('nuevoServicioNombre');
                    const precioInput = document.getElementById('nuevoServicioPrecio');
                    
                    const nombre = nombreInput.value.trim();
                    const precio = parseInt(precioInput.value) || 0;
                    
                    if (!nombre) {
                        alert('El nombre del servicio es requerido');
                        return;
                    }
                    
                    if (precio <= 0) {
                        alert('El precio debe ser mayor a 0');
                        return;
                    }
                    
                    try {
                        btnAgregarServicio.disabled = true;
                        btnAgregarServicio.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando...';
                        
                        const nuevoServicio = {
                            nombre: nombre,
                            precio: precio,
                            fecha_creacion: serverTimestamp(),
                            fecha_actualizacion: serverTimestamp()
                        };
                        
                        const docRef = await addDoc(collection(window.db, 'servicios'), nuevoServicio);
                        console.log('‚úÖ Servicio creado con ID:', docRef.id);
                        
                        // Limpiar formulario
                        nombreInput.value = '';
                        precioInput.value = '';
                        
                        // Recargar servicios y actualizar tabla
                        await window.cargarServicios();
                        window.renderizarTablaServicios();
                        
                        btnAgregarServicio.innerHTML = '<i class="fas fa-check me-2"></i>Agregado';
                        setTimeout(() => {
                            btnAgregarServicio.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Servicio';
                            btnAgregarServicio.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error agregando servicio:', error);
                        alert('Error agregando servicio: ' + error.message);
                        btnAgregarServicio.disabled = false;
                        btnAgregarServicio.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Servicio';
                    }
                });
        }

            // Event listeners para los selectores de ubicaci√≥n en edici√≥n
            const selectEditProvincia = document.getElementById('editProvincia');
            if (selectEditProvincia) {
                selectEditProvincia.addEventListener('change', function() {
                    const provinciaId = this.value;
                    
                    // Si no hay provincia seleccionada, mostrar todas las provincias
                    if (!provinciaId) {
                        const selectCanton = document.getElementById('editCanton');
                        const selectDistrito = document.getElementById('editDistrito');
                        if (selectCanton) {
                            selectCanton.innerHTML = '<option value="">Primero seleccione una provincia</option>';
                            selectCanton.disabled = true;
                        }
                        if (selectDistrito) {
                            selectDistrito.innerHTML = '<option value="">Primero seleccione un cant√≥n</option>';
                            selectDistrito.disabled = true;
                        }
                        // Mostrar todas las provincias del pa√≠s
                        mostrarProvinciasPais();
                        return;
                    }
                    
                    // Llenar cantones
                    llenarCantonesEdit(provinciaId);
                    
                    // Limpiar selecci√≥n de distrito (pero no de cant√≥n si ya est√° seleccionado)
                    const selectDistrito = document.getElementById('editDistrito');
                    if (selectDistrito) {
                        selectDistrito.innerHTML = '<option value="">Primero seleccione un cant√≥n</option>';
                        selectDistrito.disabled = true;
                    }
                    
                    // Mostrar cantones en el mapa
                    mostrarCantonesProvincia(provinciaId);
                });
            }
            
            const selectEditCanton = document.getElementById('editCanton');
            if (selectEditCanton) {
                selectEditCanton.addEventListener('change', function() {
                    const provinciaId = selectEditProvincia ? selectEditProvincia.value : null;
                    const cantonId = this.value;
                    
                    // Solo limpiar si no hay cant√≥n seleccionado
                    if (!cantonId) {
                        const selectDistrito = document.getElementById('editDistrito');
                        if (selectDistrito) {
                            selectDistrito.innerHTML = '<option value="">Primero seleccione un cant√≥n</option>';
                            selectDistrito.disabled = true;
                        }
                        // Volver a mostrar cantones si hay provincia
                        if (provinciaId) {
                            mostrarCantonesProvincia(provinciaId);
                        } else {
                            limpiarPoligonosEdit();
                        }
                        return;
                    }
                    
                    // Llenar distritos
                    llenarDistritosEdit(provinciaId, cantonId);
                    
                    // Mostrar distritos en el mapa
                    if (provinciaId && cantonId) {
                        mostrarDistritosCanton(provinciaId, cantonId);
                    } else if (provinciaId) {
                        mostrarCantonesProvincia(provinciaId);
                    } else {
                        limpiarPoligonosEdit();
                    }
                });
            }
            
            const selectEditDistrito = document.getElementById('editDistrito');
            if (selectEditDistrito) {
                selectEditDistrito.addEventListener('change', function() {
                    const provinciaId = selectEditProvincia ? selectEditProvincia.value : null;
                    const cantonId = selectEditCanton ? selectEditCanton.value : null;
                    const distritoId = this.value;
                    
                    // Mostrar distrito seleccionado en el mapa
                    if (provinciaId && cantonId && distritoId) {
                        if (window.mostrarDistritoSeleccionado) {
                            window.mostrarDistritoSeleccionado(provinciaId, cantonId, distritoId);
                        }
                    } else if (provinciaId && cantonId) {
                        if (window.mostrarDistritosCanton) {
                            window.mostrarDistritosCanton(provinciaId, cantonId);
                        }
                    } else if (provinciaId) {
                        if (window.mostrarCantonesProvincia) {
                            window.mostrarCantonesProvincia(provinciaId);
                        }
                    } else {
                        if (window.limpiarPoligonosEdit) {
                            window.limpiarPoligonosEdit();
                        }
                    }
                });
            }
            
            // Event listener para coordenadas en edici√≥n
            const inputEditCoordenadas = document.getElementById('editCoordenadas');
            if (inputEditCoordenadas) {
                // Event listener para limpiar texto pegado
                inputEditCoordenadas.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const textoPegado = (e.clipboardData || window.clipboardData).getData('text');
                    const coordenadasLimpias = limpiarYExtraerCoordenadas(textoPegado);
                    
                    if (coordenadasLimpias) {
                        this.value = coordenadasLimpias.textoLimpio;
                        // Disparar evento blur para procesar las coordenadas
                        setTimeout(() => {
                            this.dispatchEvent(new Event('blur'));
                        }, 100);
                    } else {
                        // Si no se encontraron coordenadas, mostrar error
                        this.style.borderColor = '#dc3545';
                        alert('No se encontraron coordenadas v√°lidas en el texto pegado. Por favor, pegue solo las coordenadas en formato: lat, lng');
                    }
                });
                inputEditCoordenadas.addEventListener('blur', async function() {
                    const texto = this.value.trim();
                    if (texto) {
                        // Intentar limpiar y extraer coordenadas primero
                        let coords = limpiarYExtraerCoordenadas(texto);
                        if (!coords) {
                            // Si no funciona, intentar parseo normal
                            coords = parsearCoordenadas(texto);
                        }
                        
                        if (coords) {
                            // Validar que est√©n dentro de Costa Rica
                            if (!validarCoordenadasCostaRica(coords.lat, coords.lng)) {
                                this.setCustomValidity(`Las coordenadas (${coords.lat}, ${coords.lng}) est√°n fuera de los l√≠mites de Costa Rica.`);
                                this.reportValidity();
                                this.style.borderColor = '#dc3545';
                                return;
                            }
                            
                            // Actualizar el campo con el texto limpio
                            if (coords.textoLimpio) {
                                this.value = coords.textoLimpio;
                            }
                            
                            // Procesar coordenadas y llenar autom√°ticamente provincia, cant√≥n y distrito
                            const resultado = await procesarCoordenadasEdit(coords.lat, coords.lng);
                            if (!resultado) {
                                this.style.borderColor = '#dc3545';
                            }
                        } else {
                            // Mostrar error si el formato es inv√°lido
                            this.setCustomValidity('Formato inv√°lido. Usa: latitud, longitud (ej: 9.838501, -83.866745)');
                            this.reportValidity();
                            this.style.borderColor = '#dc3545';
                        }
                    } else {
                        this.setCustomValidity('');
                        this.style.borderColor = '#ced4da';
                    }
                });
                
                inputEditCoordenadas.addEventListener('input', function() {
                    // Limpiar validaci√≥n mientras se escribe
                    this.setCustomValidity('');
                    this.style.borderColor = '#ced4da';
                });
        }
            
            // Event listener para coordenadas en nueva cita
            const inputNewCoordenadas = document.getElementById('newCoordenadas');
            if (inputNewCoordenadas) {
                // Event listener para limpiar texto pegado
                inputNewCoordenadas.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const textoPegado = (e.clipboardData || window.clipboardData).getData('text');
                    const coordenadasLimpias = limpiarYExtraerCoordenadas(textoPegado);
                    
                    if (coordenadasLimpias) {
                        this.value = coordenadasLimpias.textoLimpio;
                        // Disparar evento blur para procesar las coordenadas
                        setTimeout(() => {
                            this.dispatchEvent(new Event('blur'));
                        }, 100);
                    } else {
                        // Si no se encontraron coordenadas, mostrar error
                        this.style.borderColor = '#dc3545';
                        alert('No se encontraron coordenadas v√°lidas en el texto pegado. Por favor, pegue solo las coordenadas en formato: lat, lng');
                    }
                });
                
                inputNewCoordenadas.addEventListener('blur', async function() {
                    const texto = this.value.trim();
                    if (texto) {
                        // Intentar limpiar y extraer coordenadas primero
                        let coords = limpiarYExtraerCoordenadas(texto);
                        if (!coords) {
                            // Si no funciona, intentar parseo normal
                            coords = parsearCoordenadas(texto);
                        }
                        
                        if (coords) {
                            // Validar que est√©n dentro de Costa Rica
                            if (!validarCoordenadasCostaRica(coords.lat, coords.lng)) {
                                this.setCustomValidity(`Las coordenadas (${coords.lat}, ${coords.lng}) est√°n fuera de los l√≠mites de Costa Rica.`);
                                this.reportValidity();
                                this.style.borderColor = '#dc3545';
                                return;
                            }
                            
                            // Actualizar el campo con el texto limpio
                            if (coords.textoLimpio) {
                                this.value = coords.textoLimpio;
                            }
                            
                            // Procesar coordenadas y llenar autom√°ticamente provincia, cant√≥n y distrito
                            const resultado = await procesarCoordenadasNew(coords.lat, coords.lng);
                            if (!resultado) {
                                this.style.borderColor = '#dc3545';
                            }
                        } else {
                            // Mostrar error si el formato es inv√°lido
                            this.setCustomValidity('Formato inv√°lido. Usa: latitud, longitud (ej: 9.838501, -83.866745)');
                            this.reportValidity();
                            this.style.borderColor = '#dc3545';
                        }
                    } else {
                        this.setCustomValidity('');
                        this.style.borderColor = '#ced4da';
                    }
                });
                
                inputNewCoordenadas.addEventListener('input', function() {
                    // Limpiar validaci√≥n mientras se escribe
                    this.setCustomValidity('');
                    this.style.borderColor = '#ced4da';
                });
        }

            // Event listeners para campos de tel√©fono
            const editClientPhone = document.getElementById('editClientPhone');
            const newClientPhone = document.getElementById('newClientPhone');
            const editPhoneDisplay = document.getElementById('editPhoneDisplay');
            const newPhoneDisplay = document.getElementById('newPhoneDisplay');
            
            // Funci√≥n para manejar cambios en tel√©fono
            async function manejarCambioTelefono(input, display, sucursalSelectId, whatsappId, nombreSucursalId) {
                const valor = input.value.trim();
                
                // Validar que sean solo n√∫meros
                input.value = valor.replace(/\D/g, '').substring(0, 8);
                
                if (input.value.length === 8) {
                    const telefonoNormalizado = window.normalizarTelefono(input.value);
                    if (telefonoNormalizado && display) {
                        display.textContent = window.formatearTelefono(telefonoNormalizado);
                    }
                    
                    // Generar link de WhatsApp
                    if (whatsappId) {
                        const whatsappField = document.getElementById(whatsappId);
                        if (whatsappField && telefonoNormalizado) {
                            whatsappField.value = window.generarLinkWhatsApp(telefonoNormalizado, 'Hola desde Ecoplagas');
                        }
                    }
                    
                    // Cargar sucursales
                    if (sucursalSelectId && telefonoNormalizado) {
                        await window.cargarSucursalesEnSelect(sucursalSelectId, telefonoNormalizado);
                        
                        // Si hay solo una sucursal, pre-seleccionarla
                        const select = document.getElementById(sucursalSelectId);
                        if (select && select.options.length === 2) { // 1 sucursal + opci√≥n "nueva"
                            select.value = select.options[0].value;
                            // Pre-llenar datos de la sucursal
                            const sucursales = await window.cargarSucursalesCliente(telefonoNormalizado);
                            if (sucursales.length === 1) {
                                const sucursal = sucursales[0];
                                if (nombreSucursalId) {
                                    const nombreField = document.getElementById(nombreSucursalId);
                                    if (nombreField) nombreField.value = sucursal.nombre;
                                }
                                // Pre-llenar coordenadas y ubicaci√≥n si existen
                                if (sucursal.coordenadas) {
                                    const coordsField = document.getElementById(sucursalSelectId.replace('Sucursal', 'Coordenadas'));
                                    if (coordsField) coordsField.value = `${sucursal.coordenadas.lat}, ${sucursal.coordenadas.lng}`;
                                }
                            }
                        }
                    }
                } else {
                    if (display) display.textContent = '';
                    if (whatsappId) {
                        const whatsappField = document.getElementById(whatsappId);
                        if (whatsappField) whatsappField.value = '';
                    }
                    if (sucursalSelectId) {
                        const select = document.getElementById(sucursalSelectId);
                        if (select) select.innerHTML = '<option value="">Ingrese tel√©fono primero</option>';
                    }
                }
            }
            
            // Event listener para tel√©fono en formulario de edici√≥n
            if (editClientPhone) {
                editClientPhone.addEventListener('input', async function() {
                    await manejarCambioTelefono(this, editPhoneDisplay, 'editSucursal', 'editWhatsApp', 'editNombreSucursal');
                });
                
                editClientPhone.addEventListener('blur', async function() {
                    await manejarCambioTelefono(this, editPhoneDisplay, 'editSucursal', 'editWhatsApp', 'editNombreSucursal');
                });
            }
            
            // Event listener para tel√©fono en formulario de nueva cita
            if (newClientPhone) {
                newClientPhone.addEventListener('input', async function() {
                    await manejarCambioTelefono(this, newPhoneDisplay, 'newSucursal', 'newWhatsApp', 'newNombreSucursal');
                });
                
                newClientPhone.addEventListener('blur', async function() {
                    await manejarCambioTelefono(this, newPhoneDisplay, 'newSucursal', 'newWhatsApp', 'newNombreSucursal');
                });
            }
            
            // Event listeners para selecci√≥n de sucursal
            const editSucursal = document.getElementById('editSucursal');
            const newSucursal = document.getElementById('newSucursal');
            const editNombreSucursal = document.getElementById('editNombreSucursal');
            const newNombreSucursal = document.getElementById('newNombreSucursal');
            const btnNuevaSucursalEdit = document.getElementById('btnNuevaSucursalEdit');
            const btnNuevaSucursalNew = document.getElementById('btnNuevaSucursalNew');
            
            async function manejarCambioSucursal(select, nombreField, btnNueva, esEdit = false) {
                if (select.value === 'nueva') {
                    if (nombreField) nombreField.style.display = 'block';
                    if (btnNueva) btnNueva.disabled = true;
                    // Limpiar campos de coordenadas si se crea nueva
                    if (esEdit) {
                        document.getElementById('editCoordenadas').value = '';
                        document.getElementById('editProvincia').value = '';
                        document.getElementById('editCanton').value = '';
                        document.getElementById('editDistrito').value = '';
                        document.getElementById('editDireccion').value = '';
                        document.getElementById('editOtrasSenas').value = '';
                    } else {
                        document.getElementById('newCoordenadas').value = '';
                        document.getElementById('newProvincia').value = '';
                        document.getElementById('newCanton').value = '';
                        document.getElementById('newDistrito').value = '';
                        document.getElementById('newDireccion').value = '';
                        document.getElementById('newOtrasSenas').value = '';
                    }
                } else if (select.value) {
                    if (nombreField) nombreField.style.display = 'none';
                    if (btnNueva) btnNueva.disabled = false;
                    
                    // Cargar datos de la sucursal seleccionada
                    try {
                        // Obtener tel√©fono del cliente
                        const telefonoInput = esEdit ? 
                            document.getElementById('editClientPhone') : 
                            document.getElementById('newClientPhone');
                        const telefono = telefonoInput?.value.trim();
                        
                        if (!telefono) return;
                        
                        const telefonoNormalizado = window.normalizarTelefono(telefono);
                        if (!telefonoNormalizado) return;
                        
                        const sucursalIndice = parseInt(select.value);
                        const sucursal = await window.obtenerSucursalPorIndice(telefonoNormalizado, sucursalIndice);
                        
                        if (sucursal) {
                            
                            // Pre-llenar nombre de sucursal
                            if (nombreField) nombreField.value = sucursal.nombre || '';
                            
                            // Pre-llenar coordenadas
                            if (sucursal.coordenadas) {
                                const coordsTexto = `${sucursal.coordenadas.lat}, ${sucursal.coordenadas.lng}`;
                                if (esEdit) {
                                    document.getElementById('editCoordenadas').value = coordsTexto;
                                    // Procesar coordenadas para actualizar mapa y ubicaci√≥n
                                    if (window.procesarCoordenadasEdit) {
                                        await window.procesarCoordenadasEdit(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
                                    }
                                } else {
                                    document.getElementById('newCoordenadas').value = coordsTexto;
                                    // Procesar coordenadas para actualizar mapa y ubicaci√≥n
                                    if (window.procesarCoordenadasNew) {
                                        await window.procesarCoordenadasNew(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
                                    }
                                }
                            }
                            
                            // Pre-llenar ubicaci√≥n
                            if (esEdit) {
                                if (sucursal.provinciaId) document.getElementById('editProvincia').value = sucursal.provinciaId;
                                if (sucursal.cantonId) document.getElementById('editCanton').value = sucursal.cantonId;
                                if (sucursal.distritoId) document.getElementById('editDistrito').value = sucursal.distritoId;
                                if (sucursal.direccion) document.getElementById('editDireccion').value = sucursal.direccion;
                                if (sucursal.otrasSenas) document.getElementById('editOtrasSenas').value = sucursal.otrasSenas;
                            } else {
                                if (sucursal.provinciaId) document.getElementById('newProvincia').value = sucursal.provinciaId;
                                if (sucursal.cantonId) document.getElementById('newCanton').value = sucursal.cantonId;
                                if (sucursal.distritoId) document.getElementById('newDistrito').value = sucursal.distritoId;
                                if (sucursal.direccion) document.getElementById('newDireccion').value = sucursal.direccion;
                                if (sucursal.otrasSenas) document.getElementById('newOtrasSenas').value = sucursal.otrasSenas;
                            }
                        }
                    } catch (error) {
                        console.error('Error cargando datos de sucursal:', error);
                    }
                }
            }
            
            if (editSucursal) {
                editSucursal.addEventListener('change', async function() {
                    await manejarCambioSucursal(this, editNombreSucursal, btnNuevaSucursalEdit, true);
                });
            }
            
            if (newSucursal) {
                newSucursal.addEventListener('change', async function() {
                    await manejarCambioSucursal(this, newNombreSucursal, btnNuevaSucursalNew, false);
                });
            }
            
            if (btnNuevaSucursalEdit) {
                btnNuevaSucursalEdit.addEventListener('click', function() {
                    if (editSucursal) {
                        editSucursal.value = 'nueva';
                        editSucursal.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            if (btnNuevaSucursalNew) {
                btnNuevaSucursalNew.addEventListener('click', function() {
                    if (newSucursal) {
                        newSucursal.value = 'nueva';
                        newSucursal.dispatchEvent(new Event('change'));
                    }
                });
        }

            // Inicializar
            window.addEventListener('load', async () => {
                // Cargar ubicaciones al iniciar
                await cargarUbicaciones();
                
                if (datePicker) {
                    datePicker.value = formatearFechaParaInput(diaSeleccionado);
                }
                
                // Inicializar botones de d√≠as del mes
                if (diaSeleccionado) {
                    generarBotonesDiasMes(diaSeleccionado);
                }
                
                // Cargar empleados al inicio
                await cargarEmpleados();
                // Cargar servicios al inicio
                await window.cargarServicios();
                // Cargar productos al inicio
                await window.cargarProductos();
                // Cargar herramientas al inicio (para el dropdown de Equipo y Herramientas)
                await window.cargarEquipo();
                // Mostrar cronograma por defecto
                await cambiarVista('cronograma');
                await cargarDatos();
            });
            
        // Variables globales para gr√°ficos
        // C√≥digo del reporte t√°ctico movido a reporte_tactico.html
            
        // C√≥digo del reporte t√°ctico movido a reporte_tactico.html
            
        } catch (error) {
            console.error('‚ùå Error al cargar Firebase:', error);
            alert('Error al cargar Firebase. Verifica la consola para m√°s detalles.');
        }
    </script>

    <script>
        // Funcionalidad para desplegar/colapsar secci√≥n Adicional
        function initAdicionalToggle() {
            const toggleEdit = document.getElementById('toggleAdicionalEdit');
            const contentEdit = document.getElementById('contentAdicionalEdit');
            const toggleNew = document.getElementById('toggleAdicionalNew');
            const contentNew = document.getElementById('contentAdicionalNew');
            
            if (toggleEdit && contentEdit) {
                toggleEdit.addEventListener('click', function() {
                    const isVisible = contentEdit.style.display === 'block';
                    contentEdit.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible) {
                        contentEdit.classList.add('show');
                    } else {
                        contentEdit.classList.remove('show');
                    }
                });
            }
            
            if (toggleNew && contentNew) {
                toggleNew.addEventListener('click', function() {
                    const isVisible = contentNew.style.display === 'block';
                    contentNew.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible) {
                        contentNew.classList.add('show');
                    } else {
                        contentNew.classList.remove('show');
                    }
                });
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAdicionalToggle);
        } else {
            initAdicionalToggle();
        }
        
        // Verificar autenticaci√≥n al cargar la p√°gina
        window.addEventListener('load', async function() {
            // Verificar permisos de acceso
            if (!checkPagePermissions()) {
                return;
            }
            // Verificar que el body est√© autenticado (ya verificado en el head)
            if (document.body && !document.body.classList.contains('authenticated')) {
                console.log('‚è≥ [CALENDARIO_SECURE] Esperando verificaci√≥n de autenticaci√≥n del head...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (!document.body.classList.contains('authenticated')) {
                    if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                        console.log('‚ùå [CALENDARIO_SECURE] No autenticado, redirigiendo...');
                        if (!window.location.pathname.includes('iniciar_sesion.html')) {
                            window.location.replace('iniciar_sesion.html');
                        }
                        return;
                    } else {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                }
            }
            
            // Esperar a secureAuthManager
            if (!window.secureAuthManager) {
                let retries = 0;
                while (!window.secureAuthManager && retries < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
            }
            
            if (window.secureAuthManager) {
                window.authManager = window.secureAuthManager;
            }
            
            if (window.authManager && window.authManager.isAuthenticated()) {
                // Mostrar informaci√≥n del usuario (desde load-headersecure.js)
                if (window.headerLoader && window.headerLoader.showUserInfo) {
                    window.headerLoader.showUserInfo();
                }
                // Agregar funcionalidad de logout (desde load-headersecure.js)
                if (window.headerLoader && window.headerLoader.addLogoutButton) {
                    window.headerLoader.addLogoutButton();
                }
            }
        });
        
        // Funci√≥n para vista previa de migraci√≥n
        window.previewMigracionRutas = async function() {
            const rutaOrigen = document.getElementById('rutaOrigenMigrar').value;
            const rutaDestino = document.getElementById('rutaDestinoMigrar').value;
            const fechaDia = document.getElementById('fechaDiaMigrar').value;
            
            if (!rutaOrigen || !rutaDestino) {
                alert('Por favor selecciona la ruta destino');
                return;
            }
            
            if (rutaOrigen === rutaDestino) {
                alert('La ruta origen y destino no pueden ser la misma');
                return;
            }
            
            try {
                const btnPreview = document.getElementById('btnPreviewMigracion');
                btnPreview.disabled = true;
                btnPreview.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Buscando...';
                
                // Obtener el d√≠a seleccionado del calendario
                const diaSeleccionado = window.diaSeleccionado || new Date();
                const year = diaSeleccionado.getFullYear();
                const month = diaSeleccionado.getMonth();
                const day = diaSeleccionado.getDate();
                
                // Calcular rango del d√≠a laborable (5am a 5am del siguiente d√≠a)
                const fechaInicioDiaLaborable = new Date(year, month, day, 5, 0, 0);
                const fechaFinDiaLaborable = new Date(year, month, day + 1, 4, 59, 59);
                
                // Buscar citas de la ruta origen solo del d√≠a laborable seleccionado
                const todasLasCitas = window.todasLasCitas || [];
                const citasFiltradas = todasLasCitas.filter(cita => {
                    const rutaCita = window.obtenerRuta(cita);
                    if (rutaCita !== rutaOrigen) return false;
                    
                    const fechaCita = window.formatearFecha(window.obtenerInicio(cita));
                    if (!fechaCita) return false;
                    
                    // Verificar si la cita est√° en el rango del d√≠a laborable
                    const duracion = window.obtenerDuracion ? window.obtenerDuracion(cita) : (cita.duracion_minutos || 60);
                    const fechaFinCita = new Date(fechaCita.getTime() + duracion * 60000);
                    
                    const estaEnRango = (fechaCita >= fechaInicioDiaLaborable && fechaCita <= fechaFinDiaLaborable) ||
                                       (fechaFinCita >= fechaInicioDiaLaborable && fechaFinCita <= fechaFinDiaLaborable) ||
                                       (fechaCita <= fechaInicioDiaLaborable && fechaFinCita >= fechaFinDiaLaborable);
                    
                    return estaEnRango;
                });
                
                // Mostrar preview
                document.getElementById('totalCitasMigrar').textContent = citasFiltradas.length;
                document.getElementById('previewRutaOrigen').textContent = rutaOrigen;
                document.getElementById('previewRutaDestino').textContent = rutaDestino;
                document.getElementById('previewMigracion').style.display = 'block';
                document.getElementById('btnConfirmarMigracion').disabled = false;
                
                btnPreview.disabled = false;
                btnPreview.innerHTML = '<i class="fas fa-eye me-2"></i>Vista Previa';
                
            } catch (error) {
                console.error('Error en vista previa:', error);
                alert('Error al generar vista previa: ' + error.message);
                const btnPreview = document.getElementById('btnPreviewMigracion');
                btnPreview.disabled = false;
                btnPreview.innerHTML = '<i class="fas fa-eye me-2"></i>Vista Previa';
            }
        };
        
        // Funci√≥n para confirmar y ejecutar migraci√≥n
        window.confirmarMigracionRutas = async function() {
            const rutaOrigen = document.getElementById('rutaOrigenMigrar').value;
            const rutaDestino = document.getElementById('rutaDestinoMigrar').value;
            
            if (!rutaOrigen || !rutaDestino) {
                alert('Por favor selecciona la ruta destino');
                return;
            }
            
            if (rutaOrigen === rutaDestino) {
                alert('La ruta origen y destino no pueden ser la misma');
                return;
            }
            
            // Confirmaci√≥n final
            const confirmacion = confirm(
                `¬øEst√°s seguro de migrar todas las citas de "${rutaOrigen}" a "${rutaDestino}" del d√≠a seleccionado?\n\n` +
                `Esta acci√≥n actualizar√° la ruta de todas las citas del d√≠a laborable (5am a 5am del siguiente d√≠a).`
            );
            
            if (!confirmacion) return;
            
            try {
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Migrando...';
                
                // Obtener el d√≠a seleccionado del calendario
                const diaSeleccionado = window.diaSeleccionado || new Date();
                const year = diaSeleccionado.getFullYear();
                const month = diaSeleccionado.getMonth();
                const day = diaSeleccionado.getDate();
                
                // Calcular rango del d√≠a laborable (5am a 5am del siguiente d√≠a)
                const fechaInicioDiaLaborable = new Date(year, month, day, 5, 0, 0);
                const fechaFinDiaLaborable = new Date(year, month, day + 1, 4, 59, 59);
                
                // Buscar citas de la ruta origen solo del d√≠a laborable seleccionado
                const todasLasCitas = window.todasLasCitas || [];
                const citasAMigrar = todasLasCitas.filter(cita => {
                    const rutaCita = window.obtenerRuta(cita);
                    if (rutaCita !== rutaOrigen) return false;
                    
                    const fechaCita = window.formatearFecha(window.obtenerInicio(cita));
                    if (!fechaCita) return false;
                    
                    // Verificar si la cita est√° en el rango del d√≠a laborable
                    const duracion = window.obtenerDuracion ? window.obtenerDuracion(cita) : (cita.duracion_minutos || 60);
                    const fechaFinCita = new Date(fechaCita.getTime() + duracion * 60000);
                    
                    const estaEnRango = (fechaCita >= fechaInicioDiaLaborable && fechaCita <= fechaFinDiaLaborable) ||
                                       (fechaFinCita >= fechaInicioDiaLaborable && fechaFinCita <= fechaFinDiaLaborable) ||
                                       (fechaCita <= fechaInicioDiaLaborable && fechaFinCita >= fechaFinDiaLaborable);
                    
                    return estaEnRango;
                });
                
                if (citasAMigrar.length === 0) {
                    alert('No se encontraron citas para migrar del d√≠a seleccionado');
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar Migraci√≥n';
                    return;
                }
                
                // Migrar cada cita
                let migradas = 0;
                let errores = 0;
                
                for (const cita of citasAMigrar) {
                    try {
                        // Obtener metadata actual o crear nueva
                        const metadataActual = cita.metadata || {};
                        
                        // Actualizar solo la ruta en metadata
                        await window.updateDoc(window.doc(window.db, 'citas', cita.id), {
                            metadata: {
                                ...metadataActual,
                                ruta: rutaDestino
                            },
                            fecha_actualizacion: window.serverTimestamp()
                        });
                        
                        migradas++;
                    } catch (error) {
                        console.error(`Error migrando cita ${cita.id}:`, error);
                        errores++;
                    }
                }
                
                // Mostrar resultado
                if (errores === 0) {
                    alert(`‚úÖ Migraci√≥n completada exitosamente\n\n${migradas} cita(s) migrada(s) de "${rutaOrigen}" a "${rutaDestino}"`);
                } else {
                    alert(`‚ö†Ô∏è Migraci√≥n completada con algunos errores\n\n‚úÖ Migradas: ${migradas}\n‚ùå Errores: ${errores}`);
                }
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('modalMigrarRutas')).hide();
                
                // Limpiar formulario
                document.getElementById('rutaOrigenMigrar').value = '';
                document.getElementById('rutaDestinoMigrar').value = '';
                document.getElementById('fechaDiaMigrar').value = '';
                document.getElementById('previewMigracion').style.display = 'none';
                document.getElementById('btnConfirmarMigracion').disabled = true;
                
                // Recargar datos
                if (window.cargarDatos) {
                    await window.cargarDatos();
                }
                
            } catch (error) {
                console.error('Error en migraci√≥n:', error);
                alert('Error al migrar citas: ' + error.message);
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar Migraci√≥n';
            }
        };
    </script>

    <!-- Modal para Eliminar Citas -->
    <div class="modal fade" id="modalEliminarCitas" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-trash-alt me-2"></i>Eliminar Citas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> Esta acci√≥n NO se puede deshacer. Por favor, seleccione el tipo de eliminaci√≥n.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Eliminaci√≥n <span class="text-danger">*</span></label>
                        <select id="tipoEliminacion" class="form-select" required>
                            <option value="">Seleccione una opci√≥n...</option>
                            <option value="todas">Eliminar Todas las Citas</option>
                            <option value="rango">Eliminar por Rango de Fechas</option>
                            <option value="mayor">Eliminar Citas Mayores o Iguales a una Fecha</option>
                            <option value="menor">Eliminar Citas Menores o Iguales a una Fecha</option>
                        </select>
                    </div>
                    
                    <!-- Rango de Fechas -->
                    <div id="opcionesRango" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" id="fechaInicioRango" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" id="fechaFinRango" class="form-control">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>Se eliminar√°n todas las citas cuya fecha de inicio est√© dentro del rango especificado (inclusive).</small>
                        </div>
                    </div>
                    
                    <!-- Mayor o Igual -->
                    <div id="opcionesMayor" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha L√≠mite <span class="text-danger">*</span></label>
                            <input type="date" id="fechaMayor" class="form-control">
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>Se eliminar√°n todas las citas cuya fecha de inicio sea mayor o igual a la fecha especificada (inclusive).</small>
                        </div>
                    </div>
                    
                    <!-- Menor o Igual -->
                    <div id="opcionesMenor" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha L√≠mite <span class="text-danger">*</span></label>
                            <input type="date" id="fechaMenor" class="form-control">
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>Se eliminar√°n todas las citas cuya fecha de inicio sea menor o igual a la fecha especificada (inclusive).</small>
                        </div>
                    </div>
                    
                    <!-- Vista Previa -->
                    <div id="vistaPreviaEliminacion" class="alert alert-secondary" style="display: none;">
                        <strong>Vista Previa:</strong>
                        <div id="textoVistaPrevia" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnConfirmarEliminacion" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i>Confirmar Eliminaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Cargador de Header Unificado -->
    <script src="cache-buster.js"></script>
    <script type="module" src="load-headersecure.js"></script>
</body>
</html>

