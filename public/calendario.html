<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Servicios Seguro - Eco Plagas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="eco-plagas-styles.css" rel="stylesheet">
    <link href="unified-styles.css?v=1.0" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha384-JcnsjUPPylna1s1fvi1u12X5qjY5OL56iySh75FdtrwhO/SWXgMjoVqcKyIIWOLk" crossorigin="anonymous"></script>
    <script src="check-permissions.js"></script>
    <script type="module" src="csrf-token.js"></script>
    <!-- Sistema de Autenticación Seguro -->
    <script type="module">
        import { auth } from './auth-secure.js';
        
        // Guardar auth en window para uso global
        window.firebaseAuth = auth;
        
        // VERIFICACIÓN INMEDIATA DE AUTENTICACIÓN - Redirigir antes de cargar contenido
        (async function() {
            // Prevenir múltiples ejecuciones
            if (window.authCheckInProgress) {
                return;
            }
            window.authCheckInProgress = true;
            
            // Ocultar body inmediatamente
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Esperar a que auth-secure.js se cargue completamente
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verificar si ya estamos en iniciar_sesion.html (evitar loop)
            if (window.location.pathname.includes('iniciar_sesion.html')) {
                window.authCheckInProgress = false;
                return;
            }
            
            // Verificar autenticación de manera simple
            let retries = 0;
            const maxRetries = 100; // 10 segundos
            
            while (retries < maxRetries) {
                // Verificar Firebase Auth directamente
                if (auth.currentUser) {
                    if (window.safeLogger) {
                        window.safeLogger.success('✅ [CALENDARIO_SECURE] Usuario autenticado');
                    } else {
                        console.log('✅ [CALENDARIO_SECURE] Usuario autenticado');
                    }
                    
                    // Esperar a secureAuthManager
                    if (window.secureAuthManager) {
                        window.authManager = window.secureAuthManager;
                    } else {
                        // Esperar un poco más
                        await new Promise(resolve => setTimeout(resolve, 300));
                        if (window.secureAuthManager) {
                            window.authManager = window.secureAuthManager;
                        }
                    }
                    
                    // Mostrar body
                    if (document.body) {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                    
                    window.authCheckInProgress = false;
                    return; // Usuario autenticado, continuar
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            // Si llegamos aquí, no hay autenticación
            console.log('❌ [CALENDARIO_SECURE] No autenticado después de esperar');
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Solo redirigir si no estamos ya en loginsecure
            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                try {
                    sessionStorage.setItem('postLoginRedirect', window.location.href);
                } catch (e) { console.error('Error saving redirect:', e); }
                window.location.replace('iniciar_sesion.html');
            }
            
            window.authCheckInProgress = false;
        })();
    </script>
    <style>
        /* Ocultar contenido hasta verificar autenticación */
        body {
            display: none !important;
        }
        body.authenticated {
            display: block !important;
        }
        /* Estilos específicos del calendario - sin header */
        .controls-section {
            background: var(--light-color);
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .calendar-container {
            padding: 30px;
            background: white;
        }

        .menu-hamburguesa {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            min-width: 220px;
            z-index: 1000;
            margin-top: 8px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            padding: 10px 15px;
            background: var(--light-gradient);
            border-radius: 15px;
        }
        /* Una sola fila: filtros de días + hamburguesa al final a la derecha */
        .calendar-header-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            flex-wrap: nowrap !important;
        }
        .calendar-header-row .date-filter-container {
            flex: 1;
            min-width: 0;
        }
        .calendar-header-row .hamburger-wrap {
            flex-shrink: 0;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-calendar {
            background: var(--primary-gradient);
            color: var(--eco-black);
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: var(--primary-gradient);
            color: var(--eco-black);
            padding: 15px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #f8f9fa;
            position: relative;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--eco-black);
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #ccc;
        }

        .drag-preview {
            background: rgba(102, 126, 234, 0.3) !important;
            border: 2px dashed #667eea !important;
            border-radius: 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cita-item {
            background: var(--primary-gradient);
            color: var(--eco-black);
            padding: 4px 6px;
            border-radius: 8px;
            border: 2px solid;
            font-size: 0.75rem;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        /* Contenedor de los tres indicadores (confirmación + encuesta + arqueo): centrado vertical, borde derecho */
        .cita-indicadores-derecha {
            position: absolute;
            top: 50%;
            right: -9px; /* centro del círculo (18px/2) sobre el borde derecho */
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            z-index: 10;
        }
        /* Puntos con ícono dentro: mayor radio para mostrar check, corazón, dólar */
        .indicador-confirmada-punto,
        .indicador-encuesta-punto,
        .indicador-pago-punto {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            border-radius: 50%;
            box-sizing: border-box;
            border: 2px solid rgba(0,0,0,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .indicador-confirmada-punto .indicador-icono,
        .indicador-encuesta-punto .indicador-icono,
        .indicador-pago-punto .indicador-icono {
            color: rgba(255,255,255,0.95);
            font-size: 9px;
            line-height: 1;
        }
        /* Confirmación: gris = fuera de ventana, rojo = pendiente, verde = confirmada */
        .indicador-confirmada-punto.gris { background-color: #9e9e9e; }
        .indicador-confirmada-punto.no-confirmada { background-color: #f44336; }
        .indicador-confirmada-punto.confirmada { background-color: #4caf50; }

        /* Encuesta: gris = cita no ha pasado, luego rojo/amarillo/verde/azul según estado */
        .indicador-encuesta-punto.gris { background-color: #9e9e9e; }
        .indicador-encuesta-punto.rojo { background-color: #f44336; }
        .indicador-encuesta-punto.amarillo { background-color: #ffc107; }
        .indicador-encuesta-punto.verde { background-color: #4caf50; }
        .indicador-encuesta-punto.azul { background-color: #2196f3; }

        /* Arqueo de pagos: gris = cita no ha pasado, rojo = pendiente, verde = indicado */
        .indicador-pago-punto.pago-gris { background-color: #9e9e9e; }
        .indicador-pago-punto.pago-pendiente { background-color: #f44336; }
        .indicador-pago-punto.pago-indicado { background-color: #4caf50; }

        /* Borde del punto = color de la cita en versión oscura (mismo border-color que la tarjeta) */
        .cita-item.Ruta-1 .indicador-encuesta-punto, .cita-bloque.Ruta-1 .indicador-encuesta-punto, .cita-item-dia.Ruta-1 .indicador-encuesta-punto { border-color: #258A59; }
        .cita-item.Ruta-2 .indicador-encuesta-punto, .cita-bloque.Ruta-2 .indicador-encuesta-punto, .cita-item-dia.Ruta-2 .indicador-encuesta-punto { border-color: #7E3290; }
        .cita-item.Ruta-3 .indicador-encuesta-punto, .cita-bloque.Ruta-3 .indicador-encuesta-punto, .cita-item-dia.Ruta-3 .indicador-encuesta-punto { border-color: #B89928; }
        .cita-item.Ruta-4 .indicador-encuesta-punto, .cita-bloque.Ruta-4 .indicador-encuesta-punto, .cita-item-dia.Ruta-4 .indicador-encuesta-punto { border-color: #C55A20; }
        .cita-item.Ruta-5 .indicador-encuesta-punto, .cita-bloque.Ruta-5 .indicador-encuesta-punto, .cita-item-dia.Ruta-5 .indicador-encuesta-punto { border-color: #3B8BC4; }
        .cita-item.Ruta-6 .indicador-encuesta-punto, .cita-bloque.Ruta-6 .indicador-encuesta-punto, .cita-item-dia.Ruta-6 .indicador-encuesta-punto { border-color: #A1564C; }
        .cita-item.Ruta-7 .indicador-encuesta-punto, .cita-bloque.Ruta-7 .indicador-encuesta-punto, .cita-item-dia.Ruta-7 .indicador-encuesta-punto { border-color: #4A5662; }
        .cita-item.Ruta-8 .indicador-encuesta-punto, .cita-bloque.Ruta-8 .indicador-encuesta-punto, .cita-item-dia.Ruta-8 .indicador-encuesta-punto { border-color: #2A3890; }
        .cita-item.Ruta-9 .indicador-encuesta-punto, .cita-bloque.Ruta-9 .indicador-encuesta-punto, .cita-item-dia.Ruta-9 .indicador-encuesta-punto { border-color: #25633A; }
        .cita-item.Ruta-10 .indicador-encuesta-punto, .cita-bloque.Ruta-10 .indicador-encuesta-punto, .cita-item-dia.Ruta-10 .indicador-encuesta-punto { border-color: #840000; }
        .cita-item.Ruta-11 .indicador-encuesta-punto, .cita-bloque.Ruta-11 .indicador-encuesta-punto, .cita-item-dia.Ruta-11 .indicador-encuesta-punto { border-color: #258A59; }
        .cita-item.Ruta-12 .indicador-encuesta-punto, .cita-bloque.Ruta-12 .indicador-encuesta-punto, .cita-item-dia.Ruta-12 .indicador-encuesta-punto { border-color: #7E3290; }
        .cita-item.Ruta-13 .indicador-encuesta-punto, .cita-bloque.Ruta-13 .indicador-encuesta-punto, .cita-item-dia.Ruta-13 .indicador-encuesta-punto { border-color: #B89928; }
        .cita-item.Ruta-14 .indicador-encuesta-punto, .cita-bloque.Ruta-14 .indicador-encuesta-punto, .cita-item-dia.Ruta-14 .indicador-encuesta-punto { border-color: #C55A20; }
        .cita-item.Ruta-15 .indicador-encuesta-punto, .cita-bloque.Ruta-15 .indicador-encuesta-punto, .cita-item-dia.Ruta-15 .indicador-encuesta-punto { border-color: #3B8BC4; }
        .cita-item.Ruta-16 .indicador-encuesta-punto, .cita-bloque.Ruta-16 .indicador-encuesta-punto, .cita-item-dia.Ruta-16 .indicador-encuesta-punto { border-color: #A1564C; }
        .cita-item.Ruta-17 .indicador-encuesta-punto, .cita-bloque.Ruta-17 .indicador-encuesta-punto, .cita-item-dia.Ruta-17 .indicador-encuesta-punto { border-color: #4A5662; }
        .cita-item.Ruta-18 .indicador-encuesta-punto, .cita-bloque.Ruta-18 .indicador-encuesta-punto, .cita-item-dia.Ruta-18 .indicador-encuesta-punto { border-color: #2A3890; }
        .cita-item.Ruta-19 .indicador-encuesta-punto, .cita-bloque.Ruta-19 .indicador-encuesta-punto, .cita-item-dia.Ruta-19 .indicador-encuesta-punto { border-color: #25633A; }
        .cita-item.Ruta-20 .indicador-encuesta-punto, .cita-bloque.Ruta-20 .indicador-encuesta-punto, .cita-item-dia.Ruta-20 .indicador-encuesta-punto { border-color: #840000; }
        .cita-item.Sin-asignar .indicador-encuesta-punto, .cita-bloque.Sin-asignar .indicador-encuesta-punto, .cita-item-dia.Sin-asignar .indicador-encuesta-punto { border-color: #424242; }

        /* Borde del punto pago = color de la ruta (mismo que encuesta) */
        .cita-item.Ruta-1 .indicador-pago-punto, .cita-bloque.Ruta-1 .indicador-pago-punto, .cita-item-dia.Ruta-1 .indicador-pago-punto { border-color: #258A59; }
        .cita-item.Ruta-2 .indicador-pago-punto, .cita-bloque.Ruta-2 .indicador-pago-punto, .cita-item-dia.Ruta-2 .indicador-pago-punto { border-color: #7E3290; }
        .cita-item.Ruta-3 .indicador-pago-punto, .cita-bloque.Ruta-3 .indicador-pago-punto, .cita-item-dia.Ruta-3 .indicador-pago-punto { border-color: #B89928; }
        .cita-item.Ruta-4 .indicador-pago-punto, .cita-bloque.Ruta-4 .indicador-pago-punto, .cita-item-dia.Ruta-4 .indicador-pago-punto { border-color: #C55A20; }
        .cita-item.Ruta-5 .indicador-pago-punto, .cita-bloque.Ruta-5 .indicador-pago-punto, .cita-item-dia.Ruta-5 .indicador-pago-punto { border-color: #3B8BC4; }
        .cita-item.Ruta-6 .indicador-pago-punto, .cita-bloque.Ruta-6 .indicador-pago-punto, .cita-item-dia.Ruta-6 .indicador-pago-punto { border-color: #A1564C; }
        .cita-item.Ruta-7 .indicador-pago-punto, .cita-bloque.Ruta-7 .indicador-pago-punto, .cita-item-dia.Ruta-7 .indicador-pago-punto { border-color: #4A5662; }
        .cita-item.Ruta-8 .indicador-pago-punto, .cita-bloque.Ruta-8 .indicador-pago-punto, .cita-item-dia.Ruta-8 .indicador-pago-punto { border-color: #2A3890; }
        .cita-item.Ruta-9 .indicador-pago-punto, .cita-bloque.Ruta-9 .indicador-pago-punto, .cita-item-dia.Ruta-9 .indicador-pago-punto { border-color: #25633A; }
        .cita-item.Ruta-10 .indicador-pago-punto, .cita-bloque.Ruta-10 .indicador-pago-punto, .cita-item-dia.Ruta-10 .indicador-pago-punto { border-color: #840000; }
        .cita-item.Ruta-11 .indicador-pago-punto, .cita-bloque.Ruta-11 .indicador-pago-punto, .cita-item-dia.Ruta-11 .indicador-pago-punto { border-color: #258A59; }
        .cita-item.Ruta-12 .indicador-pago-punto, .cita-bloque.Ruta-12 .indicador-pago-punto, .cita-item-dia.Ruta-12 .indicador-pago-punto { border-color: #7E3290; }
        .cita-item.Ruta-13 .indicador-pago-punto, .cita-bloque.Ruta-13 .indicador-pago-punto, .cita-item-dia.Ruta-13 .indicador-pago-punto { border-color: #B89928; }
        .cita-item.Ruta-14 .indicador-pago-punto, .cita-bloque.Ruta-14 .indicador-pago-punto, .cita-item-dia.Ruta-14 .indicador-pago-punto { border-color: #C55A20; }
        .cita-item.Ruta-15 .indicador-pago-punto, .cita-bloque.Ruta-15 .indicador-pago-punto, .cita-item-dia.Ruta-15 .indicador-pago-punto { border-color: #3B8BC4; }
        .cita-item.Ruta-16 .indicador-pago-punto, .cita-bloque.Ruta-16 .indicador-pago-punto, .cita-item-dia.Ruta-16 .indicador-pago-punto { border-color: #A1564C; }
        .cita-item.Ruta-17 .indicador-pago-punto, .cita-bloque.Ruta-17 .indicador-pago-punto, .cita-item-dia.Ruta-17 .indicador-pago-punto { border-color: #4A5662; }
        .cita-item.Ruta-18 .indicador-pago-punto, .cita-bloque.Ruta-18 .indicador-pago-punto, .cita-item-dia.Ruta-18 .indicador-pago-punto { border-color: #2A3890; }
        .cita-item.Ruta-19 .indicador-pago-punto, .cita-bloque.Ruta-19 .indicador-pago-punto, .cita-item-dia.Ruta-19 .indicador-pago-punto { border-color: #25633A; }
        .cita-item.Ruta-20 .indicador-pago-punto, .cita-bloque.Ruta-20 .indicador-pago-punto, .cita-item-dia.Ruta-20 .indicador-pago-punto { border-color: #840000; }
        .cita-item.Sin-asignar .indicador-pago-punto, .cita-bloque.Sin-asignar .indicador-pago-punto, .cita-item-dia.Sin-asignar .indicador-pago-punto { border-color: #424242; }

        /* Borde del punto confirmada = color de la ruta */
        .cita-item.Ruta-1 .indicador-confirmada-punto, .cita-bloque.Ruta-1 .indicador-confirmada-punto, .cita-item-dia.Ruta-1 .indicador-confirmada-punto { border-color: #258A59; }
        .cita-item.Ruta-2 .indicador-confirmada-punto, .cita-bloque.Ruta-2 .indicador-confirmada-punto, .cita-item-dia.Ruta-2 .indicador-confirmada-punto { border-color: #7E3290; }
        .cita-item.Ruta-3 .indicador-confirmada-punto, .cita-bloque.Ruta-3 .indicador-confirmada-punto, .cita-item-dia.Ruta-3 .indicador-confirmada-punto { border-color: #B89928; }
        .cita-item.Ruta-4 .indicador-confirmada-punto, .cita-bloque.Ruta-4 .indicador-confirmada-punto, .cita-item-dia.Ruta-4 .indicador-confirmada-punto { border-color: #C55A20; }
        .cita-item.Ruta-5 .indicador-confirmada-punto, .cita-bloque.Ruta-5 .indicador-confirmada-punto, .cita-item-dia.Ruta-5 .indicador-confirmada-punto { border-color: #3B8BC4; }
        .cita-item.Ruta-6 .indicador-confirmada-punto, .cita-bloque.Ruta-6 .indicador-confirmada-punto, .cita-item-dia.Ruta-6 .indicador-confirmada-punto { border-color: #A1564C; }
        .cita-item.Ruta-7 .indicador-confirmada-punto, .cita-bloque.Ruta-7 .indicador-confirmada-punto, .cita-item-dia.Ruta-7 .indicador-confirmada-punto { border-color: #4A5662; }
        .cita-item.Ruta-8 .indicador-confirmada-punto, .cita-bloque.Ruta-8 .indicador-confirmada-punto, .cita-item-dia.Ruta-8 .indicador-confirmada-punto { border-color: #2A3890; }
        .cita-item.Ruta-9 .indicador-confirmada-punto, .cita-bloque.Ruta-9 .indicador-confirmada-punto, .cita-item-dia.Ruta-9 .indicador-confirmada-punto { border-color: #25633A; }
        .cita-item.Ruta-10 .indicador-confirmada-punto, .cita-bloque.Ruta-10 .indicador-confirmada-punto, .cita-item-dia.Ruta-10 .indicador-confirmada-punto { border-color: #840000; }
        .cita-item.Ruta-11 .indicador-confirmada-punto, .cita-bloque.Ruta-11 .indicador-confirmada-punto, .cita-item-dia.Ruta-11 .indicador-confirmada-punto { border-color: #258A59; }
        .cita-item.Ruta-12 .indicador-confirmada-punto, .cita-bloque.Ruta-12 .indicador-confirmada-punto, .cita-item-dia.Ruta-12 .indicador-confirmada-punto { border-color: #7E3290; }
        .cita-item.Ruta-13 .indicador-confirmada-punto, .cita-bloque.Ruta-13 .indicador-confirmada-punto, .cita-item-dia.Ruta-13 .indicador-confirmada-punto { border-color: #B89928; }
        .cita-item.Ruta-14 .indicador-confirmada-punto, .cita-bloque.Ruta-14 .indicador-confirmada-punto, .cita-item-dia.Ruta-14 .indicador-confirmada-punto { border-color: #C55A20; }
        .cita-item.Ruta-15 .indicador-confirmada-punto, .cita-bloque.Ruta-15 .indicador-confirmada-punto, .cita-item-dia.Ruta-15 .indicador-confirmada-punto { border-color: #3B8BC4; }
        .cita-item.Ruta-16 .indicador-confirmada-punto, .cita-bloque.Ruta-16 .indicador-confirmada-punto, .cita-item-dia.Ruta-16 .indicador-confirmada-punto { border-color: #A1564C; }
        .cita-item.Ruta-17 .indicador-confirmada-punto, .cita-bloque.Ruta-17 .indicador-confirmada-punto, .cita-item-dia.Ruta-17 .indicador-confirmada-punto { border-color: #4A5662; }
        .cita-item.Ruta-18 .indicador-confirmada-punto, .cita-bloque.Ruta-18 .indicador-confirmada-punto, .cita-item-dia.Ruta-18 .indicador-confirmada-punto { border-color: #2A3890; }
        .cita-item.Ruta-19 .indicador-confirmada-punto, .cita-bloque.Ruta-19 .indicador-confirmada-punto, .cita-item-dia.Ruta-19 .indicador-confirmada-punto { border-color: #25633A; }
        .cita-item.Ruta-20 .indicador-confirmada-punto, .cita-bloque.Ruta-20 .indicador-confirmada-punto, .cita-item-dia.Ruta-20 .indicador-confirmada-punto { border-color: #840000; }
        .cita-item.Sin-asignar .indicador-confirmada-punto, .cita-bloque.Sin-asignar .indicador-confirmada-punto, .cita-item-dia.Sin-asignar .indicador-confirmada-punto { border-color: #424242; }

        .cita-item:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .cita-item.Ruta-1 { background: #2EAA6F; border-color: #258A59; color: #fff; font-weight: 600; }
        .cita-item.Ruta-2 { background: #9B3DAB; border-color: #7E3290; color: #fff; font-weight: 600; }
        .cita-item.Ruta-3 { background: #E8C040; border-color: #B89928; color: #fff; font-weight: 600; }
        .cita-item.Ruta-4 { background: #E87030; border-color: #C55A20; color: #fff; font-weight: 600; }
        .cita-item.Ruta-5 { background: #4A9FD4; border-color: #3B8BC4; color: #fff; font-weight: 600; }
        .cita-item.Ruta-6 { background: #C96B5F; border-color: #A1564C; color: #fff; font-weight: 600; }
        .cita-item.Ruta-7 { background: #5C6B7A; border-color: #4A5662; color: #fff; font-weight: 600; }
        .cita-item.Ruta-8 { background: #3547A0; border-color: #2A3890; color: #fff; font-weight: 600; }
        .cita-item.Ruta-9 { background: #2E7D4A; border-color: #25633A; color: #fff; font-weight: 600; }
        .cita-item.Ruta-10 { background: #A50000; border-color: #840000; color: #fff; font-weight: 600; }
        .cita-item.Ruta-11 { background: #2EAA6F; border-color: #258A59; color: #fff; font-weight: 600; }
        .cita-item.Ruta-12 { background: #9B3DAB; border-color: #7E3290; color: #fff; font-weight: 600; }
        .cita-item.Ruta-13 { background: #E8C040; border-color: #B89928; color: #fff; font-weight: 600; }
        .cita-item.Ruta-14 { background: #E87030; border-color: #C55A20; color: #fff; font-weight: 600; }
        .cita-item.Ruta-15 { background: #4A9FD4; border-color: #3B8BC4; color: #fff; font-weight: 600; }
        .cita-item.Ruta-16 { background: #C96B5F; border-color: #A1564C; color: #fff; font-weight: 600; }
        .cita-item.Ruta-17 { background: #5C6B7A; border-color: #4A5662; color: #fff; font-weight: 600; }
        .cita-item.Ruta-18 { background: #3547A0; border-color: #2A3890; color: #fff; font-weight: 600; }
        .cita-item.Ruta-19 { background: #2E7D4A; border-color: #25633A; color: #fff; font-weight: 600; }
        .cita-item.Ruta-20 { background: #A50000; border-color: #840000; color: #fff; font-weight: 600; }
        .cita-item.Sin-asignar { background: #B0BEC5; border-color: #9E9E9E; color: #000; font-weight: 600; }

        /* --- Pills/badges: padding y line-height mínimos para que quepan 3 líneas --- */
        .vendedor-badge {
            display: inline-flex;
            align-items: center;
            padding: 0 3px;
            border-radius: 4px;
            font-size: 0.5rem;
            line-height: 1;
            background: #000;
            color: #fff;
            font-weight: 700;
            white-space: nowrap;
            box-sizing: border-box;
            max-width: fit-content;
        }
        .cita-hora-texto, .cita-monto-texto, .cita-monto-cero, .cita-cliente-texto, .cita-ubicacion-texto, .cita-ubicacion-pendiente {
            display: inline-flex;
            align-items: center;
            padding: 0 3px;
            border-radius: 4px;
            font-size: 0.5rem;
            line-height: 1;
            white-space: nowrap;
            box-sizing: border-box;
            max-width: fit-content;
        }
        .cita-hora-texto, .cita-monto-texto, .cita-cliente-texto, .cita-ubicacion-texto { background: #455a64; color: #fff; font-weight: 400; }
        .cita-monto-cero, .cita-ubicacion-pendiente { background: #c62828; color: #fff; font-weight: 400; }
        .cita-cliente-texto, .cita-ubicacion-texto { max-width: 100%; overflow: hidden; text-overflow: ellipsis; }

        /* Contenedor 3 líneas: columna, gap mínimo entre filas */
        .cita-tres-lineas {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            line-height: 1;
            margin: 0;
            padding: 0;
            font-size: 0.5rem;
            box-sizing: border-box;
            max-width: 100%;
        }
        .cita-tres-lineas > * { margin: 0; padding: 0; line-height: 1; font-size: 0.5rem; }

        .cita-linea-badges {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .cita-linea-principal { white-space: nowrap; line-height: 1; font-size: 0.5rem; }
        .cita-linea-recursos {
            margin: 0;
            padding: 0;
            line-height: 1;
            font-size: 0.5rem;
            min-height: 0;
            display: flex;
            align-items: center;
            max-width: 100%;
            min-width: 0;
        }

        .filters-section {
            background: var(--light-gradient);
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal {
            z-index: 9999 !important;
        }
        
        .modal-backdrop {
            z-index: 9998 !important;
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            z-index: 10000 !important;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: var(--eco-black);
            border-radius: 20px 20px 0 0;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner-modern {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: var(--light-gradient);
            border-radius: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
        }

        .no-citas {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-citas i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Estilos para Vista de Día */
        .vista-dia {
            margin-top: 0;
        }

        .vista-dia-header {
            background: var(--light-gradient);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .vehiculos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        /* Estilos para cronograma con eje Y */
        .cronograma-container {
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 0;
            max-height: 1250px; /* Cabeceras (~250px) + timeline 24h (960px) para ver hasta 5am del día siguiente */
            overflow-y: auto; /* Permitir scroll vertical (se sobrescribirá cuando se aplique recorte) */
            overflow-x: hidden; /* No permitir scroll horizontal aquí */
            position: relative; /* Necesario para que el overflow funcione correctamente */
        }
        
        /* Cuando se aplica recorte, el contenedor debe tener overflow: hidden */
        .cronograma-container[style*="overflow: hidden"],
        .cronograma-container[style*="overflow:hidden"] {
            overflow: hidden !important;
            overflow-y: hidden !important;
        }

        .eje-horas {
            width: 80px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            padding: 0 10px;
            min-height: 960px; /* Altura del timeline (24 horas * 40px = 1cm por hora) */
            position: relative; /* Posición relativa para que el transform funcione dentro del contenedor */
            flex-shrink: 0; /* No reducir tamaño */
            z-index: 5;
            overflow: visible; /* Permitir que los marcadores se vean aunque estén fuera del contenedor inicialmente */
        }

        .hora-marcador {
            height: 40px; /* 1cm por hora */
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #e9ecef;
            position: relative;
        }

        .hora-marcador:last-child {
            border-bottom: none;
        }

        .vehiculos-cronograma {
            flex: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; /* El scroll vertical lo maneja el contenedor padre */
            position: relative; /* Necesario para que los elementos absolutos dentro funcionen */
        }

        .vehiculo-columna-cronograma {
            min-width: 90px;
            max-width: 180px;
            width: clamp(90px, 8vw, 180px);
            flex: 1 1 auto;
            border-right: 2px solid #000000;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 1200px) {
            .vehiculo-columna-cronograma {
                width: clamp(120px, 10vw, 200px);
                max-width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .vehiculo-columna-cronograma {
                min-width: 80px;
                width: clamp(80px, 12vw, 120px);
                max-width: 120px;
            }
        }

        .vehiculo-columna-cronograma:last-child {
            border-right: none;
        }
        
        /* Cajas de recursos sin asignar - base */
        .recursos-sin-asignar-container {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .recurso-caja {
            flex: 1;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            min-height: 80px;
        }
        
        .recurso-caja-header {
            background: #f5f5f5;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.8rem;
            border-bottom: 1px solid #e0e0e0;
            color: #000000;
        }
        
        .recurso-caja-body {
            padding: 0.5rem 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 50px;
            max-height: 120px;
            overflow-y: auto;
            justify-content: center;
            align-items: flex-start;
            background: #ffffff;
            color: #000000;
        }
        
        .recurso-item {
            display: inline-block;
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: move;
            user-select: none;
            transition: all 0.2s;
            text-align: center;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .recurso-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .recurso-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .recurso-tecnico {
            background: #0b7835;
            color: #ffffff;
        }
        
        .recurso-vehiculo {
            background: #2196F3;
            color: #ffffff;
        }
        
        .ruta-info-row.drop-zone {
            border: 2px dashed #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .ruta-info-row.drop-zone-active {
            border-color: #2e7d32;
            background: rgba(76, 175, 80, 0.2);
        }

        /* Card de ruta: grid de filas fijas para que nada se sobreponga */
        .vehiculo-header-cronograma {
            padding: 0;
            color: var(--eco-black);
            font-weight: 700;
            font-size: 0.8rem;
            text-align: center;
            position: relative;
            top: 0;
            z-index: 10;
            /* Altura exacta de las 7 filas (35+22+22+48+28+78+22=265) para no dejar espacio vacío bajo la fila hora */
            height: 265px;
            min-height: 265px;
            max-height: 265px;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 35px 22px 22px 48px 28px 78px 22px; /* 7 filas; técnicos 50% más alto (78px) para ~3 filas de nombres */
            overflow: hidden;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* Cada fila usa todo el ancho de la celda */
        .ruta-row {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            overflow: hidden;
            width: 100%;
            min-width: 0;
            padding: 0 4px;
            box-sizing: border-box;
        }
        .ruta-row-numero  { grid-row: 1; width: 100%; }
        .ruta-row-citas   { grid-row: 2; width: 100%; }
        .ruta-row-monto   { grid-row: 3; width: 100%; }
        .ruta-row-botones { grid-row: 4; width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 4px; flex-wrap: nowrap; }
        .ruta-row-vehiculos { grid-row: 5; width: 100%; justify-content: stretch; padding: 0 4px; box-sizing: border-box; }
        .ruta-row-tecnicos  { grid-row: 6; width: 100%; align-items: stretch; overflow-y: auto; overflow-x: hidden; justify-content: stretch; padding: 0 4px; box-sizing: border-box; }
        .ruta-row-hora      { grid-row: 7; width: 100%; justify-content: center; padding: 0 4px; box-sizing: border-box; }
        
        .ruta-row-botones .btn-slot-icon {
            width: 26px;
            min-width: 26px;
            height: 22px;
            padding: 2px;
        }
        .ruta-row-botones .btn-slot-placeholder {
            width: 26px;
            min-width: 26px;
            height: 22px;
            visibility: hidden;
            pointer-events: none;
        }
        /* Citas y monto: el contenido usa todo el ancho de la celda (texto centrado) */
        .ruta-row-citas > *,
        .ruta-row-monto > * {
            width: 100%;
            text-align: center;
            justify-content: center;
        }
        
        .ruta-nombre-header {
            font-size: clamp(0.65rem, 1.2vw, 0.75rem);
            font-weight: 700;
            padding: 0;
            color: #ffffff;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .ruta-citas-badge,
        .ruta-monto-badge {
            background: #ffffff !important;
            color: #000000 !important;
        }
        .ruta-monto-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: clamp(0.55rem, 1vw, 0.65rem);
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Filas de asignaciones: fondo blanco, borde sólido */
        .ruta-row-vehiculos { background: #ffffff; border: 2px solid #2196F3; }
        .ruta-row-tecnicos  { background: #ffffff; border: 2px solid #FF9800; }
        .ruta-row-hora      { background: #ffffff; border: 2px solid #2196F3; }
        .ruta-row-hora .btn-editar-hora-ruta { flex-shrink: 0; margin-left: 4px; }
        .ruta-row-hora .btn-editar-hora-ruta:hover { color: #0D47A1; }
        
        .ruta-info-row {
            font-size: clamp(0.5rem, 1vw, 0.55rem);
            text-align: center;
            padding: 1px 4px;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-weight: 500;
            color: #000;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Fila vehículos: ocupa todo el ancho de la celda */
        .ruta-row-vehiculos.ruta-info-row {
            min-height: 0;
            height: 100%;
            max-height: 28px;
            overflow: hidden;
            flex: 1 1 100%;
            min-width: 0;
        }
        
        .ruta-info-row[data-tipo-fila="vehiculo"] {
            background: #ffffff !important;
        }
        
        .ruta-info-row[data-tipo-fila="vehiculo"].drop-zone-empty {
            border: 2px solid #2196F3;
        }
        
        /* Celda técnicos: ocupa todo el ancho de la fila */
        .ruta-row-tecnicos .ruta-cell-tecnicos {
            min-height: 100%;
            width: 100%;
            min-width: 0;
            flex: 1 1 100%;
            overflow: visible;
            box-sizing: border-box;
        }
        
        .ruta-info-row[data-tipo-fila="tecnico"] {
            background: transparent;
            min-height: 78px;
            height: auto;
            max-height: none;
        }
        
        .ruta-info-row[data-tipo-fila="tecnico"].drop-zone-empty {
            background: #ffffff !important;
            border: 2px solid transparent;
        }
        
        
        /* Asegurar que todas las filas de info tengan la misma altura */
        .vehiculos-cronograma {
            display: flex;
            align-items: flex-start;
        }
        
        .vehiculo-columna-cronograma {
            display: flex;
            flex-direction: column;
            position: relative; /* Para contener elementos posicionados */
            overflow: visible; /* Permitir que las citas se vean */
        }
        
        
        .ruta-info-row:first-of-type {
            border-top: none;
        }
        
        .ruta-badge-item {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.55rem;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: move;
            user-select: none;
            transition: all 0.2s;
            text-align: center;
        }
        
        .ruta-badge-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .ruta-badge-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .ruta-badge-vehiculo {
            background: #2196F3;
        }
        
        .ruta-badge-tecnico {
            background: #FF9800;
        }
        
        .ruta-badge-sin-asignar {
            background: #9E9E9E;
            opacity: 0.6;
        }

        .vehiculo-header-cronograma.Ruta-1 { background: #2EAA6F; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-2 { background: #9B3DAB; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-3 { background: #E8C040; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-4 { background: #E87030; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-5 { background: #4A9FD4; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-6 { background: #C96B5F; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-7 { background: #5C6B7A; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-8 { background: #3547A0; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-9 { background: #2E7D4A; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-10 { background: #A50000; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-11 { background: #2EAA6F; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-12 { background: #9B3DAB; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-13 { background: #E8C040; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-14 { background: #E87030; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-15 { background: #4A9FD4; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-16 { background: #C96B5F; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-17 { background: #5C6B7A; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-18 { background: #3547A0; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-19 { background: #2E7D4A; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Ruta-20 { background: #A50000; color: #ffffff; font-weight: 600; }
        .vehiculo-header-cronograma.Sin-asignar { 
            background: #ffffff !important; 
            color: #000000 !important; 
            font-weight: 600; 
        }

        .citas-timeline {
            position: relative;
            height: 960px; /* Altura del timeline (24 horas * 40px = 1cm por hora) */
            min-height: 960px; /* Mantener altura mínima */
            max-height: 960px; /* Altura máxima fija */
            padding-left: 0; /* Sin padding para que los marcadores estén alineados */
            margin-top: 0; /* Sin margen superior */
            top: 0; /* Empezar justo después del header */
            flex-shrink: 0; /* No reducir tamaño */
            box-sizing: border-box;
            z-index: 2; /* Asegurar que esté sobre el header */
            background: white; /* Fondo para que las citas se vean claramente */
        }
        
        /* Marcadores de hora dentro del timeline */
        .marcador-hora-timeline {
            position: absolute;
            left: 0;
            width: 100%;
            height: 40px; /* 1cm por hora */
            /* Sin border-bottom, las líneas divisorias ya están manejadas por .linea-divisoria-hora */
            pointer-events: none;
            z-index: 1;
        }
        
        .marcador-hora-timeline-label {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: #000000;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        /* Líneas divisorias de hora (grises delgadas, uniformes) */
        .linea-divisoria-hora {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background-color: rgba(200, 200, 200, 0.6);
            pointer-events: none;
            z-index: 1; /* Detrás de las citas pero más visible */
            /* Asegurar que no haya bordes adicionales que cambien el grosor */
            border: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .cita-bloque {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 4px;
            padding: 4px 6px;
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid;
            z-index: 2;
            user-select: none;
            box-sizing: border-box;
            max-width: 100%;
        }

        .cita-bloque:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .cita-bloque.dragging {
            opacity: 0.5;
            z-index: 1000;
            cursor: grabbing;
        }

        .citas-timeline.drag-over {
            background-color: rgba(76, 175, 80, 0.1);
            border: 2px dashed rgba(76, 175, 80, 0.5);
        }
        
        /* Línea de hora de convocatoria en el timeline (arrastrable) - color por ruta */
        .linea-convocatoria {
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            z-index: 10;
            cursor: ns-resize;
            pointer-events: auto;
        }
        .linea-convocatoria:hover { height: 5px; opacity: 1; }
        .linea-convocatoria.dragging { opacity: 0.9; }
        .linea-convocatoria-label {
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            pointer-events: none;
        }
        .linea-convocatoria-caja {
            border: 2px solid;
            border-radius: 2px;
            padding: 0 4px;
            white-space: nowrap;
            color: #fff;
        }
        .linea-convocatoria.Ruta-1 { background: #258A59; }
        .linea-convocatoria.Ruta-1 .linea-convocatoria-caja { background: #2EAA6F; border-color: #1B5E3A; }
        .linea-convocatoria.Ruta-2 { background: #7E3290; }
        .linea-convocatoria.Ruta-2 .linea-convocatoria-caja { background: #9B3DAB; border-color: #5E2470; }
        .linea-convocatoria.Ruta-3 { background: #B89928; }
        .linea-convocatoria.Ruta-3 .linea-convocatoria-caja { background: #E8C040; border-color: #8B7319; }
        .linea-convocatoria.Ruta-4 { background: #C55A20; }
        .linea-convocatoria.Ruta-4 .linea-convocatoria-caja { background: #E87030; border-color: #8B3E16; }
        .linea-convocatoria.Ruta-5 { background: #3B8BC4; }
        .linea-convocatoria.Ruta-5 .linea-convocatoria-caja { background: #4A9FD4; border-color: #2A6390; }
        .linea-convocatoria.Ruta-6 { background: #A1564C; }
        .linea-convocatoria.Ruta-6 .linea-convocatoria-caja { background: #C96B5F; border-color: #6B382F; }
        .linea-convocatoria.Ruta-7 { background: #4A5662; }
        .linea-convocatoria.Ruta-7 .linea-convocatoria-caja { background: #5C6B7A; border-color: #2F3740; }
        .linea-convocatoria.Ruta-8 { background: #2A3890; }
        .linea-convocatoria.Ruta-8 .linea-convocatoria-caja { background: #3547A0; border-color: #1E2866; }
        .linea-convocatoria.Ruta-9 { background: #25633A; }
        .linea-convocatoria.Ruta-9 .linea-convocatoria-caja { background: #2E7D4A; border-color: #184726; }
        .linea-convocatoria.Ruta-10 { background: #840000; }
        .linea-convocatoria.Ruta-10 .linea-convocatoria-caja { background: #A50000; border-color: #5C0000; }
        .linea-convocatoria.Ruta-11 { background: #258A59; }
        .linea-convocatoria.Ruta-11 .linea-convocatoria-caja { background: #2EAA6F; border-color: #1B5E3A; }
        .linea-convocatoria.Ruta-12 { background: #7E3290; }
        .linea-convocatoria.Ruta-12 .linea-convocatoria-caja { background: #9B3DAB; border-color: #5E2470; }
        .linea-convocatoria.Ruta-13 { background: #B89928; }
        .linea-convocatoria.Ruta-13 .linea-convocatoria-caja { background: #E8C040; border-color: #8B7319; }
        .linea-convocatoria.Ruta-14 { background: #C55A20; }
        .linea-convocatoria.Ruta-14 .linea-convocatoria-caja { background: #E87030; border-color: #8B3E16; }
        .linea-convocatoria.Ruta-15 { background: #3B8BC4; }
        .linea-convocatoria.Ruta-15 .linea-convocatoria-caja { background: #4A9FD4; border-color: #2A6390; }
        .linea-convocatoria.Ruta-16 { background: #A1564C; }
        .linea-convocatoria.Ruta-16 .linea-convocatoria-caja { background: #C96B5F; border-color: #6B382F; }
        .linea-convocatoria.Ruta-17 { background: #4A5662; }
        .linea-convocatoria.Ruta-17 .linea-convocatoria-caja { background: #5C6B7A; border-color: #2F3740; }
        .linea-convocatoria.Ruta-18 { background: #2A3890; }
        .linea-convocatoria.Ruta-18 .linea-convocatoria-caja { background: #3547A0; border-color: #1E2866; }
        .linea-convocatoria.Ruta-19 { background: #25633A; }
        .linea-convocatoria.Ruta-19 .linea-convocatoria-caja { background: #2E7D4A; border-color: #184726; }
        .linea-convocatoria.Ruta-20 { background: #840000; }
        .linea-convocatoria.Ruta-20 .linea-convocatoria-caja { background: #A50000; border-color: #5C0000; }
        /* Sin citas: línea y cajitas grises, muy discretas */
        .linea-convocatoria.sin-citas { background: #c8c8c8 !important; opacity: 0.5; }
        .linea-convocatoria.sin-citas .linea-convocatoria-caja { background: #e5e5e5 !important; border-color: #b0b0b0 !important; color: #777 !important; }
        .linea-convocatoria.sin-citas:hover { opacity: 0.65; }

        .cita-bloque.Ruta-1 { border-color: #258A59; background: #2EAA6F; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-2 { border-color: #7E3290; background: #9B3DAB; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-3 { border-color: #B89928; background: #E8C040; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-4 { border-color: #C55A20; background: #E87030; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-5 { border-color: #3B8BC4; background: #4A9FD4; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-6 { border-color: #A1564C; background: #C96B5F; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-7 { border-color: #4A5662; background: #5C6B7A; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-8 { border-color: #2A3890; background: #3547A0; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-9 { border-color: #25633A; background: #2E7D4A; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-10 { border-color: #840000; background: #A50000; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-11 { border-color: #258A59; background: #2EAA6F; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-12 { border-color: #7E3290; background: #9B3DAB; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-13 { border-color: #B89928; background: #E8C040; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-14 { border-color: #C55A20; background: #E87030; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-15 { border-color: #3B8BC4; background: #4A9FD4; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-16 { border-color: #A1564C; background: #C96B5F; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-17 { border-color: #4A5662; background: #5C6B7A; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-18 { border-color: #2A3890; background: #3547A0; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-19 { border-color: #25633A; background: #2E7D4A; color: #fff; font-weight: 600; }
        .cita-bloque.Ruta-20 { border-color: #840000; background: #A50000; color: #fff; font-weight: 600; }
        .cita-bloque.Sin-asignar { border-color: #424242; background: #616161; color: #fff; font-weight: 600; }

        .cita-hora-cronograma {
            font-weight: 400;
            font-size: 0.5rem;
            color: #ffffff;
            margin: 0;
            line-height: 1;
            white-space: nowrap;
        }

        .cita-cliente-cronograma {
            font-weight: 600;
            font-size: 0.55rem;
            color: #ffffff;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .cita-descripcion-cronograma {
            font-size: 0.55rem;
            color: #ffffff;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-weight: 500;
        }

        .cita-estado-cronograma {
            display: none; /* Ocultar el punto azul */
        }

        .cita-estado-cronograma.agendada { background: #1976d2; }
        .cita-estado-cronograma.confirmada { background: #2e7d32; }
        .cita-estado-cronograma.completada { background: #7b1fa2; }
        .cita-estado-cronograma.cancelada { background: #c62828; }
        .cita-estado-cronograma.confirmada-24-48 { background: #2e7d32; }
        
        /* Indicador GPS en esquina superior derecha */
        .indicador-gps {
            position: absolute;
            top: 2px;
            right: 2px;
            z-index: 10;
            font-size: 0.75rem !important;
        }
        
        .cita-item-dia {
            position: relative;
        }
        
        .cita-item {
            position: relative;
        }

        .tiempo-libre {
            position: absolute;
            left: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.02);
            border: 1px dashed #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.7rem;
            font-style: italic;
        }

        .tiempo-libre:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
            color: #667eea;
        }

        .vehiculo-columna {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .vehiculo-columna:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .vehiculo-header {
            padding: 20px;
            color: var(--eco-black);
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            position: relative;
        }

        .vehiculo-header.Ruta-1 { background: #2EAA6F; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-2 { background: #9B3DAB; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-3 { background: #E8C040; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-4 { background: #E87030; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-5 { background: #4A9FD4; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-6 { background: #C96B5F; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-7 { background: #5C6B7A; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-8 { background: #3547A0; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-9 { background: #2E7D4A; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-10 { background: #A50000; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-11 { background: #2EAA6F; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-12 { background: #9B3DAB; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-13 { background: #E8C040; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-14 { background: #E87030; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-15 { background: #4A9FD4; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-16 { background: #C96B5F; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-17 { background: #5C6B7A; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-18 { background: #3547A0; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-19 { background: #2E7D4A; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Ruta-20 { background: #A50000; color: #ffffff; font-weight: 600; }
        .vehiculo-header.Sin-asignar { background: #616161; color: white; font-weight: 600; }
        .vehiculo-header.Sin-asignar { background: #616161; color: white; font-weight: 700; }
        .vehiculo-header-cronograma.Sin-asignar { background: #616161; color: white; font-weight: 700; }

        .vehiculo-stats {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
            color: #666;
        }

        .citas-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Contenedor para citas en la misma hora - lado a lado */
        .citas-misma-hora {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .citas-misma-hora .cita-item-dia {
            flex: 1 1 calc(50% - 4px);
            min-width: 200px;
        }
        
        /* Si hay 3 o más citas, hacer más pequeñas */
        .citas-misma-hora:has(.cita-item-dia:nth-child(3)) .cita-item-dia {
            flex: 1 1 calc(33.333% - 6px);
            min-width: 150px;
        }

        .cita-item-dia {
            padding: 6px 10px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-sizing: border-box;
            max-width: 100%;
        }

        .cita-item-dia:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .cita-item-dia:last-child {
            border-bottom: none;
        }

        .cita-hora {
            font-weight: 400;
            color: #667eea;
            font-size: 0.5rem;
            margin: 0;
            white-space: nowrap;
            line-height: 1;
        }

        .cita-cliente {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .cita-descripcion {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .cita-estado {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .cita-estado.agendada { background: #1976d2; color: white; font-weight: 700; }
        .cita-estado.confirmada { background: #2e7d32; color: white; font-weight: 700; }
        .cita-estado.completada { background: #7b1fa2; color: white; font-weight: 700; }
        .cita-estado.cancelada { background: #c62828; color: white; font-weight: 700; }
        .cita-estado.confirmada-24-48 { background: #2e7d32; color: white; font-weight: 700; }

        .cita-duracion {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sin-citas {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .sin-citas i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Botones personalizados para calendario */
        .btn-primary-modern {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }
        .btn-primary-modern:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%) !important;
            border-color: #45a049 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-success-modern {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }
        .btn-success-modern:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%) !important;
            border-color: #45a049 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-warning-modern {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%) !important;
            border-color: #FF9800 !important;
            color: white !important;
        }
        .btn-warning-modern:hover {
            background: linear-gradient(135deg, #F57C00 0%, #E65100 100%) !important;
            border-color: #F57C00 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }

        .btn-danger-modern {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%) !important;
            border-color: #F44336 !important;
            color: white !important;
        }
        .btn-danger-modern:hover {
            background: linear-gradient(135deg, #D32F2F 0%, #C62828 100%) !important;
            border-color: #D32F2F !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
        }

        .btn-info-modern {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important;
            border-color: #2196F3 !important;
            color: white !important;
        }
        .btn-info-modern:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important;
            border-color: #1976D2 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }

        .btn-outline-primary {
            border-color: #4CAF50 !important;
            color: #4CAF50 !important;
        }
        .btn-outline-primary:hover {
            background: #4CAF50 !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #757575 0%, #616161 100%) !important;
            border-color: #757575 !important;
            color: white !important;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #616161 0%, #424242 100%) !important;
            border-color: #616161 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(117, 117, 117, 0.3);
        }

        /* Botón de cronograma - Verde */
        #btnVistaCronograma {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }

        #btnVistaCronograma:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%) !important;
            border-color: #45a049 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        #btnVistaCronograma.active {
            background: linear-gradient(135deg, #3d8b40 0%, #2e7d32 100%) !important;
            border-color: #3d8b40 !important;
            color: white !important;
        }
        /* Icono animado de despliegue */
        @keyframes pulse-down {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(8px) scale(1.15);
            }
        }
        
        .icon-expand-pulse {
            animation: pulse-down 1.5s ease-in-out infinite;
        }
        
        /* Jerarquía de secciones en formularios Editar / Nueva cita */
        .form-section-title {
            font-size: 1rem !important;
            font-weight: 600 !important;
            color: #000000 !important;
            font-family: 'Inter', sans-serif !important;
        }
        .form-subsection-title {
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            color: #2c3e50 !important;
            font-family: 'Inter', sans-serif !important;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .form-subsection-title:first-of-type { margin-top: 0; }
        
        /* Estilos para dropdown con buscador */
        .dropdown-container {
            position: relative;
        }
        
        .dropdown-menu {
            width: 100%;
            margin-top: 0.25rem;
        }
        
        .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: #f5f5f5;
        }
        
        .dropdown-item:active {
            background-color: #e0e0e0;
        }
        
        /* Estilos para botones de días del mes - 3 líneas por botón */
        .btn-dia-mes {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 4px 4px;
            font-size: 0.6rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 44px;
            max-width: 52px;
            text-align: center;
            color: #333;
            white-space: normal;
            flex: 0 0 auto;
            line-height: 1.2;
        }
        .btn-dia-mes .linea-dia-semana,
        .btn-dia-mes .linea-fecha,
        .btn-dia-mes .linea-ventas {
            display: block;
            width: 100%;
        }
        
        /* Domingo y feriado: no mostrar línea de meta (meta = 0) */
        .day-bar-cell-sin-meta .day-bar-meta-line {
            display: none !important;
        }
        
        .btn-dia-mes:hover {
            background: #f0f0f0;
            border-color: #4CAF50;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-dia-mes.active {
            background: #2E7D32 !important;
            color: white !important;
            border: 2px solid #1B5E20 !important;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.5);
            transform: scale(1.05);
        }
        
        .btn-dia-mes.today {
            border-color: #4CAF50;
            border-width: 2px;
        }
        
        .btn-dia-mes.domingo {
            background: #9E9E9E !important;
            color: white !important;
            border-color: #757575 !important;
        }
        
        .btn-dia-mes.domingo:hover {
            background: #757575 !important;
            border-color: #616161 !important;
        }
        
        .btn-dia-mes.domingo.active {
            background: #37474F !important;
            color: white !important;
            border: 2px solid #263238 !important;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }

        /* ========== Línea gráfica Eco Plagas (guía_linea_grafica.html) ========== */
        /* Fondos: #f5f5f5 contenedor externo, #ffffff contenido. Texto #000000. Márgenes mínimos. */
        .controls-section {
            background: #f5f5f5 !important;
            padding: 0.75rem 1rem !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }
        .calendar-container {
            padding: 0.75rem 1rem !important;
            background: #f5f5f5 !important;
        }
        .calendar-header {
            background: #ffffff !important;
            border-radius: 8px !important;
            padding: 0.75rem 1rem !important;
            color: #000000 !important;
            border: 1px solid #e0e0e0 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
        }
        .menu-hamburguesa {
            background: #ffffff !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            padding: 0.75rem 1rem !important;
        }
        .calendar-grid {
            background: #f5f5f5 !important;
            border-radius: 8px !important;
        }
        .calendar-day-header {
            background: #0b7835 !important;
            color: #ffffff !important;
            padding: 0.75rem !important;
        }
        .calendar-day {
            background: #ffffff !important;
            border: 1px solid #f5f5f5 !important;
            padding: 0.5rem 0.75rem !important;
        }
        .calendar-day:hover {
            background: #f5f5f5 !important;
        }
        .calendar-day.today {
            background: #fbdc02 !important;
            color: #000000 !important;
        }
        .calendar-day.other-month {
            background: #f5f5f5 !important;
            color: #000000 !important;
        }
        .current-month {
            color: #000000 !important;
        }
        .btn-calendar {
            background: #0b7835 !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 0.75rem 1rem !important;
            font-weight: 600 !important;
            box-shadow: 0 3px 6px rgba(0,0,0,0.25), inset 0 2px 0 rgba(255,255,255,0.25), inset 0 -1px 0 rgba(0,0,0,0.2) !important;
        }
        .btn-calendar:hover {
            box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 2px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.25) !important;
        }
        .filters-section {
            background: #f5f5f5 !important;
            padding: 0.75rem 1rem !important;
        }
        .vista-dia-header {
            background: #ffffff !important;
            color: #000000 !important;
            border-radius: 8px !important;
            padding: 1rem !important;
            margin-bottom: 1rem !important;
            border: 1px solid #e0e0e0 !important;
        }
        .cronograma-container {
            background: #ffffff !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            border: 1px solid #e0e0e0 !important;
        }
        #vistaCronograma .buscador-citas-container {
            background: #ffffff !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            padding: 0.75rem 1rem !important;
            box-shadow: none !important;
        }
        .recursos-sin-asignar-container {
            background: #f5f5f5 !important;
            border-radius: 8px !important;
            padding: 0.75rem 1rem !important;
            border: 1px solid #e0e0e0 !important;
        }
        .recurso-caja {
            background: #ffffff !important;
            border-radius: 8px !important;
            border: 1px solid #e0e0e0 !important;
        }
        .recurso-caja-header {
            padding: 0.5rem 0.75rem !important;
            border-bottom: 1px solid #e0e0e0 !important;
            color: #000000 !important;
        }
        /* Encabezados pastel según guía: verde pastel / azul pastel */
        .recurso-caja[data-section="tecnicos-sin-asignar"] .recurso-caja-header {
            background: #c8e6c9 !important;
        }
        .recurso-caja[data-section="vehiculos-sin-asignar"] .recurso-caja-header {
            background: #BBDEFB !important;
        }
        .recurso-caja-body {
            background: #ffffff !important;
            color: #000000 !important;
        }
        .eje-horas {
            background: #f5f5f5 !important;
            border-right: 1px solid #e0e0e0 !important;
        }
        .hora-marcador {
            color: #000000 !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }
        .no-citas {
            color: #000000 !important;
        }
        .legend {
            background: #f5f5f5 !important;
            padding: 1rem !important;
            border-radius: 8px !important;
        }
        .modal-content {
            border-radius: 12px !important;
            border: 1px solid #e0e0e0 !important;
        }
        .modal-header {
            background: #0b7835 !important;
            color: #ffffff !important;
            border-radius: 12px 12px 0 0 !important;
        }
        .drag-preview {
            background: rgba(33, 150, 243, 0.2) !important;
            border: 2px dashed #2196F3 !important;
        }
        .btn-dia-mes.active {
            background: #0b7835 !important;
            border-color: #0b7835 !important;
        }
        .date-filter-container {
            background: #ffffff !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
        }
        #vistaCronograma .buscador-citas-container label,
        #vistaCronograma .buscador-citas-container .form-label {
            color: #000000 !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header se carga dinámicamente -->

        <!-- Calendario -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-header-row">
                    <!-- ========== SECCIÓN: FILTROS ========== -->
                    <!-- data-section="filtros" -->
                    <div class="date-filter-container" data-section="filtros" style="display: flex; align-items: center; gap: 6px; background: white; padding: 6px 10px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <button id="btnPrevMonthCronograma" class="btn-date-nav" style="background: #f5f5f5; border: none; border-radius: 8px; width: 32px; height: 32px; min-width: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #4CAF50;" onmouseover="this.style.background='#4CAF50'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#4CAF50';">
                            <i class="fas fa-chevron-left" style="font-size: 0.85rem;"></i>
                        </button>
                        <div class="date-picker-and-bars" style="flex: 1; min-width: 0; overflow-x: auto; display: flex; flex-direction: column; gap: 2px;">
                            <div id="dayBarsWrapper" class="day-bars-wrapper" style="display: flex; flex-direction: column; gap: 2px;">
                                <div id="dayBarsResumenWrap" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 0.7rem; font-weight: 700; color: #1a1a1a; padding: 2px 2px 4px 2px; line-height: 1.2; border-bottom: 1px solid #e0e0e0; margin-bottom: 2px;">
                                    <span style="display: flex; align-items: center; gap: 6px;">
                                        <span id="dayBarsResumen">Ventas: 0  Meta: 0  % de avance: 0%</span>
                                        <button type="button" id="btnCopiarVentasMes" title="Copiar ventas por día (TSV) para pegar en Excel" style="padding: 2px 6px; font-size: 0.65rem; border: 1px solid #ccc; border-radius: 4px; background: #f8f9fa; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-copy"></i> Copiar</button>
                                        <button type="button" id="btnDescargarCSVMes" title="Descargar CSV del mes actual con datos de Firebase (mismo formato que agenda ventas)" style="padding: 2px 6px; font-size: 0.65rem; border: 1px solid #ccc; border-radius: 4px; background: #f8f9fa; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-file-csv"></i> Descargar CSV</button>
                                    </span>
                                    <label style="font-weight: 600; font-size: 0.65rem; display: inline-flex; align-items: center; gap: 4px;">Meta mes (M): <input type="number" id="inputMetaMesM" min="0" step="0.1" value="0" placeholder="1.7/día" style="width: 52px; padding: 2px 4px; font-size: 0.65rem; border: 1px solid #ccc; border-radius: 4px;"></label>
                                </div>
                                <div id="dayBarsAxis" class="day-bars-axis" style="display: flex; justify-content: space-between; font-size: 0.6rem; font-weight: 600; color: #6c757d; padding: 0 2px; line-height: 1;">0</div>
                                <div id="dayBarsRow" class="day-bars-row" style="position: relative; display: flex; flex-wrap: nowrap; gap: 3px; padding: 2px 0; height: 100px; align-items: flex-end;">
                                    <!-- Capa de línea de meta (1.8M) y barras se generan dinámicamente -->
                                </div>
                            </div>
                            <div id="datePickerContainer" style="display: flex; flex-wrap: nowrap; gap: 3px; padding: 2px; align-items: stretch;">
                                <!-- Los botones de días se generarán dinámicamente (alineados con las barras) -->
                            </div>
                            <div id="dayBarsVendedoresWrap" style="display: flex; flex-direction: column; gap: 6px; padding: 6px 2px 4px; border-top: 1px solid #e0e0e0; margin-top: 4px;">
                                <div style="font-size: 0.65rem; font-weight: 700; color: #333;">Ventas por vendedor (mes)</div>
                                <div id="dayBarsVendedores" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; min-height: 20px; align-content: start; width: 100%; min-width: 0;"></div>
                            </div>
                            <div style="border-top: 1px solid #e0e0e0; margin-top: 6px; padding-top: 6px;">
                                <button type="button" id="btnToggleCancelaciones" style="display: flex; align-items: center; gap: 6px; width: 100%; padding: 6px 8px; font-size: 0.7rem; font-weight: 600; color: #666; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; text-align: left;"><i class="fas fa-chevron-right" id="iconToggleCancelaciones" style="transition: transform 0.2s;"></i> Ver ventas perdidas (Cancelaciones Ruta 20)</button>
                                <div id="cancelacionesRuta20Wrap" style="display: none; flex-direction: column; gap: 6px; padding: 8px 2px 4px; margin-top: 6px;">
                                    <div id="dayBarsResumenCancelaciones" style="font-size: 0.7rem; font-weight: 700; color: #333; padding: 2px 0;">Ventas perdidas (Ruta 20): ₡0</div>
                                    <div id="dayBarsAxisCancelaciones" class="day-bars-axis" style="display: flex; justify-content: space-between; font-size: 0.6rem; font-weight: 600; color: #6c757d; padding: 0 2px; line-height: 1;">0</div>
                                    <div id="dayBarsRowCancelaciones" class="day-bars-row" style="position: relative; display: flex; flex-wrap: nowrap; gap: 3px; padding: 2px 0; height: 80px; align-items: flex-end;"></div>
                                    <div style="font-size: 0.65rem; font-weight: 700; color: #333;">Ventas perdidas por vendedor (Ruta 20)</div>
                                    <div id="dayBarsVendedoresCancelaciones" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; min-height: 20px; align-content: start; width: 100%; min-width: 0;"></div>
                                </div>
                            </div>
                        </div>
                        <button id="btnNextMonthCronograma" class="btn-date-nav" style="background: #f5f5f5; border: none; border-radius: 8px; width: 32px; height: 32px; min-width: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #4CAF50;" onmouseover="this.style.background='#4CAF50'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#4CAF50';">
                            <i class="fas fa-chevron-right" style="font-size: 0.85rem;"></i>
                        </button>
                        <!-- Input oculto para mantener compatibilidad -->
                        <input type="date" id="datePicker" style="display: none;">
                    </div>
                    <div class="hamburger-wrap position-relative">
                        <button id="btnMenuHamburguesa" class="btn btn-outline-secondary" style="font-size: 1.1rem; padding: 6px 10px;" title="Menú">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div id="menuHamburguesa" class="menu-hamburguesa" style="display: none;">
                            <!-- SECCIÓN: ACTUALIZAR DATA -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar Data
                                </h6>
                                <button id="btnActualizarCSV" class="btn btn-warning-modern btn-modern w-100 mb-2" title="Actualizar citas desde CSV (reemplaza solo las del rango de fechas del CSV)">
                                    <i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV
                                </button>
                                <input type="file" id="inputCSVActualizar" accept=".csv" style="display: none;">
                            </div>
                            
                            <!-- SECCIÓN: REPORTES -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-chart-bar me-1"></i>Reportes
                                </h6>
                                <a href="reporte_tactico.html" class="btn btn-danger-modern btn-modern w-100 mb-2" title="Reporte Táctico 2025 - Ventas por día y empleado">
                                    🔥🪖 Táctico 2025
                                </a>
                                <a href="reporte_encuestas.html" class="btn btn-info-modern btn-modern w-100 mb-2" title="Reporte de Encuestas de Satisfacción">
                                    <i class="fas fa-clipboard-check me-2"></i>Encuestas
                                </a>
                            </div>
                            
                            <!-- SECCIÓN: AGREGAR -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-plus-circle me-1"></i>Agregar
                                </h6>
                                <button id="btnGestionarServicios" class="btn btn-warning-modern btn-modern w-100 mb-2" title="Gestionar servicios disponibles">
                                    <i class="fas fa-cog me-2"></i>Servicios
                                </button>
                                <button id="btnGestionarEquipo" class="btn btn-info-modern btn-modern w-100 mb-2" title="Gestionar equipo y herramientas disponibles">
                                    <i class="fas fa-tools me-2"></i>Equipo
                                </button>
                            </div>
                            
                            <!-- OTRAS OPCIONES -->
                            <div class="mb-3">
                                <h6 class="text-muted text-uppercase small mb-2" style="font-weight: 600; letter-spacing: 0.5px;">
                                    <i class="fas fa-cog me-1"></i>Opciones
                                </h6>
                                <button id="btnEliminarTodasCitas" class="btn btn-danger-modern btn-modern w-100 mb-2" title="⚠️ ELIMINAR TODAS LAS CITAS (Solo para pruebas)">
                                    <i class="fas fa-trash-alt me-2"></i>Eliminar Todas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Los días del calendario se generarán dinámicamente -->
            </div>

            <!-- ========== SECCIÓN: AGENDA / CITAS DEL DÍA ========== -->
            <!-- data-section="agenda" -->
            <div id="vistaDia" class="vista-dia" data-section="agenda" style="display: none;">
                <div class="vista-dia-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 id="vistaDiaTitulo" class="mb-0">
                            <i class="fas fa-calendar-day me-2"></i>Citas del Día
                        </h3>
                        <div id="facturacionTotalDia" class="text-end" style="display: none;">
                            <strong style="font-size: 1.2rem; color: #28a745;">
                                <i class="fas fa-money-bill-wave me-2"></i>
                                Facturación Total: <span id="montoTotalDia">₡0</span>
                            </strong>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <button id="btnPrevDay" class="btn btn-calendar">
                            <i class="fas fa-chevron-left"></i> Día Anterior
                        </button>
                        <button id="btnNextDay" class="btn btn-calendar">
                            Día Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="vehiculos-grid" id="vehiculosGrid">
                    <!-- Las columnas de vehículos se generarán dinámicamente -->
                </div>
            </div>

            <!-- ========== SECCIÓN: CRONOGRAMA ========== -->
            <!-- data-section="cronograma" -->
            <div id="vistaCronograma" class="vista-dia" data-section="cronograma" style="display: none; margin-top: 0; padding-top: 0;">
                <!-- ========== SUBSECCIÓN: BUSCADOR DE CITAS ========== -->
                <!-- data-section="buscador-citas" -->
                <div class="buscador-citas-container mb-3" data-section="buscador-citas" style="padding: 6px 8px; margin-top: 0; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="position-relative">
                        <label class="form-label mb-2" style="font-size: 0.9rem; font-weight: 600; color: #000000;">
                            <i class="fas fa-search me-2"></i>Buscar Citas por Cliente o Teléfono
                        </label>
                        <input type="text" id="buscadorCitas" class="form-control" placeholder="Escribe el nombre del cliente o número de teléfono..." 
                               style="border: 1px solid #e0e0e0; font-size: 1rem; padding: 0.75rem; border-radius: 8px;">
                        <div id="resultadosBusquedaCitas" class="dropdown-menu" style="display: none; width: 100%; max-height: 400px; overflow-y: auto; z-index: 1050; margin-top: 4px;">
                            <!-- Los resultados se mostrarán aquí -->
                        </div>
                    </div>
                </div>
                
                <!-- ========== SUBSECCIÓN: RECURSOS SIN ASIGNAR ========== -->
                <!-- data-section="recursos-sin-asignar" -->
                <div class="recursos-sin-asignar-container mb-1" data-section="recursos-sin-asignar" style="padding: 8px; margin-top: 0;">
                    <!-- ========== TÉCNICOS SIN ASIGNAR ========== -->
                    <!-- data-section="tecnicos-sin-asignar" -->
                    <div class="recurso-caja" data-section="tecnicos-sin-asignar">
                        <div class="recurso-caja-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-users me-2"></i>Técnicos Sin Asignar</span>
                            <button id="btnActualizarTecnicos" class="btn btn-sm btn-primary" style="padding: 4px 8px; font-size: 0.75rem;" title="Mover todos los técnicos asignados de vuelta a sin asignar">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                        <div class="recurso-caja-body" id="tecnicosSinAsignarContainer">
                            <!-- Los técnicos se generarán dinámicamente -->
                        </div>
                    </div>
                    <!-- ========== VEHÍCULOS SIN ASIGNAR ========== -->
                    <!-- data-section="vehiculos-sin-asignar" -->
                    <div class="recurso-caja" data-section="vehiculos-sin-asignar">
                        <div class="recurso-caja-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-truck me-2"></i>Vehículos Sin Asignar</span>
                            <button id="btnActualizarVehiculos" class="btn btn-sm btn-primary" style="padding: 4px 8px; font-size: 0.75rem;" title="Mover todos los vehículos asignados de vuelta a sin asignar">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                        <div class="recurso-caja-body" id="vehiculosSinAsignarContainer">
                            <!-- Los vehículos se generarán dinámicamente -->
                        </div>
                    </div>
                </div>
                <!-- ========== SECCIÓN: RUTAS DIURNAS ========== -->
                <!-- data-section="rutas-diurnas" -->
                <!-- Sección Rutas Diurnas - BLOQUE COMPLETAMENTE INDEPENDIENTE -->
                <div id="seccionRutasDiurnas" data-section="rutas-diurnas" style="width: 100%; margin-bottom: 2px; padding: 4px; background: #f8f9fa; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div class="seccion-titulo" style="background: #0D47A1; color: white; padding: 6px 15px; margin-bottom: 0; border-radius: 6px 6px 0 0; font-weight: bold; text-align: center; font-size: 0.9rem;">
                        <i class="fas fa-sun me-2"></i>Rutas Diurnas (Ruta 1-10)
                    </div>
                    <div class="cronograma-container" style="width: 100%;">
                        <!-- Eje de horas oculto, usando marcadores internos en "Sin asignar" -->
                        <div class="eje-horas" id="ejeHorasDiurnas" style="display: none;">
                            <!-- Oculto -->
                        </div>
                        <div class="vehiculos-cronograma" id="vehiculosCronogramaDiurnas" style="flex: 1; display: flex; overflow-x: auto; overflow-y: hidden; margin-bottom: 0; padding-bottom: 0;">
                            <!-- Las columnas de rutas diurnas se generarán dinámicamente -->
                    </div>
                </div>
            </div>

                <!-- Cajas de recursos sin asignar para Rutas Nocturnas -->
                <div class="recursos-sin-asignar-container mb-1" style="padding: 8px; margin-top: 2px; margin-bottom: 2px;">
                    <div class="recurso-caja">
                        <div class="recurso-caja-header">
                            <i class="fas fa-users me-2"></i>Técnicos
                        </div>
                        <div class="recurso-caja-body" id="tecnicosNocturnasContainer">
                            <!-- Los técnicos se generarán dinámicamente -->
                        </div>
                    </div>
                    <div class="recurso-caja">
                        <div class="recurso-caja-header">
                            <i class="fas fa-truck me-2"></i>Vehículos (APV's)
                        </div>
                        <div class="recurso-caja-body" id="vehiculosNocturnasContainer">
                            <!-- Los vehículos se generarán dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- ========== SECCIÓN: RUTAS NOCTURNAS ========== -->
                <!-- data-section="rutas-nocturnas" -->
                <!-- ========== SECCIÓN: RUTAS NOCTURNAS ========== -->
                <!-- data-section="rutas-nocturnas" -->
                <!-- Sección Rutas Nocturnas / Especiales - BLOQUE COMPLETAMENTE INDEPENDIENTE -->
                <div id="seccionRutasNocturnas" data-section="rutas-nocturnas" style="width: 100%; margin-top: 2px; padding: 4px; background: #f5f3ff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div class="seccion-titulo" style="background: #000000; color: white; padding: 6px 15px; margin-bottom: 0; border-radius: 6px 6px 0 0; font-weight: bold; text-align: center; font-size: 0.9rem;">
                        <i class="fas fa-moon me-2"></i>Rutas Nocturnas / Especiales (Ruta 11-Cancelaciones)
                    </div>
                    <div class="cronograma-container" style="width: 100%;">
                        <!-- Eje de horas oculto, usando marcadores internos en "Sin asignar" -->
                        <div class="eje-horas" id="ejeHorasNocturnas" style="display: none;">
                            <!-- Oculto -->
                        </div>
                        <div class="vehiculos-cronograma" id="vehiculosCronogramaNocturnas" style="flex: 1; display: flex; overflow-x: auto; overflow-y: hidden; margin-bottom: 0; padding-bottom: 0;">
                            <!-- Las columnas de rutas nocturnas se generarán dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>


                </div>
                </div>

    <!-- ========== MODAL: EDITAR CITA ========== -->
    <!-- data-section="modal-editar-cita" -->
    <div class="modal fade" id="editCitaModal" data-section="modal-editar-cita" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center" style="flex-wrap: wrap; gap: 0.35rem;">
                    <h5 class="modal-title mb-0" style="color: #8B0000 !important; font-size: 1.1rem;"><i class="fas fa-edit me-1"></i>Editar Cita</h5>
                    <div class="d-flex gap-1 flex-wrap align-items-center">
                        <button type="button" id="btnDescargarProforma" title="Descargar proforma PNG" style="background: #fbdc02; color: #000; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-download me-1"></i>Proforma
                        </button>
                        <button type="button" id="btnJustificarSinEncuesta" title="Justificar por qué esta cita no lleva encuesta" style="background: #fbdc02; color: #000; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-heart me-1"></i>Justificar
                        </button>
                        <button type="button" id="btnEnviarEncuesta" title="Generar link de encuesta post-servicio" style="background: #fbdc02; color: #000; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-clipboard-check me-1"></i>Encuesta
                        </button>
                        <button type="button" id="btnVerResultadoEncuesta" title="Ver resultado de la encuesta" style="display: none; background: #0b7835; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-chart-bar me-1"></i>Ver resultado encuesta
                        </button>
                        <button type="button" id="btnVerHistorial" title="Ver historial de ediciones" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-history me-1"></i>Ver historial
                        </button>
                        <button type="button" id="btnDeleteCita" title="Eliminar cita" style="background: #ea0e2a; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" title="Cancelar" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" id="btnSaveCitaTop" title="Guardar cambios" style="background: #0b7835; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-save me-1"></i>Guardar
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="padding: 0.35rem;"></button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 0.75rem; background: #f5f5f5;">
                    <!-- Campos Indispensables -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title">Requerido</h5>
                </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Teléfono -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 140px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Teléfono <span style="color: #ea0e2a;">*</span></label>
                                    <input type="text" id="editClientPhone" class="form-control" placeholder="12345678" maxlength="8" pattern="[0-9]{8}" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small id="editPhoneDisplay" class="d-block mt-1" style="font-size: 0.75rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;"></small>
                </div>
                                
                                <!-- Sucursal -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 200px;">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label mb-0" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Sucursal <span style="color: #ea0e2a;">*</span></label>
                                        <button type="button" id="btnEditarSucursalEdit" class="btn btn-sm p-0" style="display: none; color: #6c757d; font-size: 0.85rem;" title="Editar datos de la sucursal" aria-label="Editar sucursal"><i class="fas fa-pen"></i></button>
                                    </div>
                                    <div class="input-group">
                                        <select id="editSucursal" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px 0 0 8px; color: #000000;">
                                            <option value="">Cargando...</option>
                                        </select>
                                        <button type="button" id="btnNuevaSucursalEdit" class="btn" style="border: 1px solid #e0e0e0; border-left: none; border-radius: 0 8px 8px 0; background: #ffffff; color: #000000; padding: 0.75rem;" title="Crear nueva sucursal">
                                            <i class="fas fa-plus" style="opacity: 0.7;"></i>
                                        </button>
                </div>
                                    <input type="text" id="editNombreSucursal" class="form-control mt-2" placeholder="Nombre de la sucursal" style="display: none; border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.8rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Seleccione o cree una sucursal</small>
                </div>
                                
                                <!-- Fecha y Hora de Inicio -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 230px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Fecha y Hora <span style="color: #ea0e2a;">*</span></label>
                                    <input type="datetime-local" id="editStartTime" class="form-control" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                </div>
                                
                                <!-- Duración -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 150px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Duración <span style="color: #ea0e2a;">*</span></label>
                                    <select id="editDuration" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="15">15 minutos</option>
                                        <option value="30">30 minutos</option>
                                        <option value="45">45 minutos</option>
                                        <option value="60" selected>1 hora</option>
                                        <option value="75">1 hora 15 minutos</option>
                                        <option value="90">1 hora 30 minutos</option>
                                        <option value="105">1 hora 45 minutos</option>
                                        <option value="120">2 horas</option>
                                        <option value="135">2 horas 15 minutos</option>
                                        <option value="150">2 horas 30 minutos</option>
                                        <option value="165">2 horas 45 minutos</option>
                                        <option value="180">3 horas</option>
                                        <option value="195">3 horas 15 minutos</option>
                                        <option value="210">3 horas 30 minutos</option>
                                        <option value="225">3 horas 45 minutos</option>
                                        <option value="240">4 horas</option>
                                        <option value="255">4 horas 15 minutos</option>
                                        <option value="270">4 horas 30 minutos</option>
                                        <option value="285">4 horas 45 minutos</option>
                                        <option value="300">5 horas</option>
                                        <option value="315">5 horas 15 minutos</option>
                                        <option value="330">5 horas 30 minutos</option>
                                        <option value="345">5 horas 45 minutos</option>
                                        <option value="360">6 horas</option>
                                        <option value="375">6 horas 15 minutos</option>
                                        <option value="390">6 horas 30 minutos</option>
                                        <option value="405">6 horas 45 minutos</option>
                                        <option value="420">7 horas</option>
                                        <option value="435">7 horas 15 minutos</option>
                                        <option value="450">7 horas 30 minutos</option>
                                        <option value="465">7 horas 45 minutos</option>
                                        <option value="480">8 horas</option>
                                        <option value="540">9 horas</option>
                                        <option value="600">10 horas</option>
                                        <option value="660">11 horas</option>
                                        <option value="720">12 horas</option>
                                    </select>
                                </div>
                                
                                <!-- Hora de Fin (calculada) -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 230px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Hora de Fin</label>
                                    <input type="text" id="editEndTime" class="form-control" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f8f9fa; border-radius: 8px; color: #000000; cursor: not-allowed;">
                                </div>
                                
                                <!-- Ruta -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 120px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Ruta <span style="color: #ea0e2a;">*</span></label>
                                    <select id="editRuta" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="Sin asignar">Sin asignar</option>
                                        <option value="Ruta 1">Ruta 1</option>
                                        <option value="Ruta 2">Ruta 2</option>
                                        <option value="Ruta 3">Ruta 3</option>
                                        <option value="Ruta 4">Ruta 4</option>
                                        <option value="Ruta 5">Ruta 5</option>
                                        <option value="Ruta 6">Ruta 6</option>
                                        <option value="Ruta 7">Ruta 7</option>
                                        <option value="Ruta 8">Ruta 8</option>
                                        <option value="Ruta 9">Ruta 9</option>
                                        <option value="Ruta 10">Ruta 10</option>
                                        <option value="Ruta 11">Ruta 11</option>
                                        <option value="Ruta 12">Ruta 12</option>
                                        <option value="Ruta 13">Ruta 13</option>
                                        <option value="Ruta 14">Ruta 14</option>
                                        <option value="Ruta 15">Ruta 15</option>
                                        <option value="Ruta 16">Ruta 16</option>
                                        <option value="Ruta 17">Ruta 17</option>
                                        <option value="Ruta 18">Ruta 18</option>
                                        <option value="Ruta 19">Ruta 19</option>
                                        <option value="Ruta 20">Ruta 20</option>
                                    </select>
                </div>
                                
                                <!-- Nombre del Cliente -->
                                <div class="col-12 col-md" style="flex: 1 1 0; min-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Nombre del Cliente</label>
                                    <input type="text" id="editClientName" class="form-control" placeholder="Ingrese el nombre completo" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                
                                <!-- Vendedores -->
                                <div class="col-12 col-md" style="flex: 1 1 0; min-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Vendedores *</label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="editVendedorSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar vendedor" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editVendedoresDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditVendedor" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editVendedoresSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                
                                <!-- Confirmada dentro de 24-48 horas -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; min-width: 220px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Confirmada dentro de 24-48 horas</label>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="editConfirmada24_48" role="switch" aria-label="Cliente avisado">
                                        <label class="form-check-label" for="editConfirmada24_48">Cliente avisado (recordatorio enviado)</label>
                                    </div>
                                    <small id="editConfirmada24_48Mensaje" class="text-muted d-block mt-1"></small>
                                    <small id="editConfirmada24_48Timestamp" class="d-block mt-1" style="display:none;"></small>
                                </div>
                                        </div>
                                    </div>
                                </div>
                                
                    <!-- Detalles de la cita -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title">Detalles</h5>
                </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Ubicación -->
                                <div class="col-12">
                                    <h6 class="form-subsection-title mb-2">Ubicación</h6>
                                </div>
                                
                                <!-- Fila 1: Coordenadas, Otras Señas, Provincia, Cantón y Distrito en la misma línea -->
                                <div class="col-12">
                                    <div class="row" style="gap: 0.5rem 0.75rem; margin: 0;">
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Coordenadas (Lat, Lng)</label>
                                            <input type="text" id="editCoordenadas" class="form-control" placeholder="9.838501, -83.866745" pattern="^-?\d+\.?\d*,\s*-?\d+\.?\d*$" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Otras Señas</label>
                                            <input type="text" id="editOtrasSenas" class="form-control" placeholder="Ej: 200mts norte del supermercado, casa azul" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Provincia</label>
                                            <select id="editProvincia" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                                <option value="">Seleccionar provincia...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Cantón</label>
                                            <select id="editCanton" class="form-select" disabled style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                                <option value="">Primero seleccione una provincia</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Distrito</label>
                                            <select id="editDistrito" class="form-select" disabled style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                                <option value="">Primero seleccione un cantón</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fila 2: Link de Ubicación y WhatsApp -->
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Link de Ubicación (Waze/Google Maps)</label>
                                    <textarea id="editDireccion" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generarán automáticamente al ingresar coordenadas"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">WhatsApp</label>
                                    <textarea id="editWhatsApp" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generará automáticamente con el teléfono"></textarea>
                                </div>
                                
                                <!-- Mapa -->
                                <div class="col-12" style="margin-top: 0.5rem;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Vista del Mapa</label>
                                    <div id="mapaUbicacionEdit" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #e0e0e0;"></div>
                                </div>
                                
                                <!-- Enfoque de plaga -->
                                <div class="col-12" style="position: relative; z-index: 999;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <h6 class="form-subsection-title mb-2">Enfoque de plaga</h6>
                                    <div class="dropdown-container" style="position: relative; z-index: 1000;">
                                        <input type="text" id="editPlagaSearch" aria-label="Enfoque de plaga" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar enfoque de plaga" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editPlagasDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1001 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditPlaga" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editPlagasSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
            </div>
        </div>
    </div>

                    <!-- Precio y monto de venta (card de primer nivel) -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title"><i class="fas fa-calculator me-2"></i>Precio y monto de venta</h5>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <p class="mb-3" style="font-size: 0.8rem; color: #6c757d;">Complete servicios, productos y costo; el monto total se actualiza solo. Puede editarlo al final si lo necesita.</p>
                            <div class="row" style="gap: 0.75rem 0;">
                                <div class="col-12" style="position: relative; z-index: 1000;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Servicios</label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1001;">
                                        <input type="text" id="editServicioSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar servicio" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editServiciosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1002 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditServicio" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editServiciosSelected" class="mb-2 mt-2">
                                        <table class="table table-sm table-bordered" id="editServiciosTabla" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="font-size: 0.9rem; font-weight: 600;">Servicio</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 100px;">Cantidad</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Precio Unit. (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Total (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="editServiciosTablaBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-12 mt-3" style="position: relative; z-index: 999;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Productos de inventario</label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1000;">
                                        <input type="text" id="editProductoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar producto" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editProductosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1001 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditProducto" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editProductosSelected" class="mb-2 mt-2">
                                        <table class="table table-sm table-bordered" id="editProductosTabla" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="font-size: 0.9rem; font-weight: 600;">Producto</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 100px;">Cantidad</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Precio Unit. (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Total (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="editProductosTablaBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-12 mt-3" style="position: relative; z-index: 998;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Equipo y Herramientas
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="editEquipoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar equipo" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="editEquipoDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsEditEquipo" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="editEquipoSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                <div class="col-12 mt-2">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Monto de Venta (₡)</label>
                                    <input type="text" id="editMontoVenta" class="form-control" placeholder="0" style="border: 1px solid #27ae60; font-size: 1rem; font-weight: 600; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f0fff4; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.8rem; color: #6c757d;">Servicios + Productos. Edítelo aquí si desea cambiarlo.</small>
                                </div>
                                <div class="col-12 mt-3">
                                    <div style="background-color: #f8f9fa; padding: 0.75rem; border-radius: 6px; border: 1px solid #dee2e6;">
                                        <p class="mb-2" style="color: #7f8c8d; font-size: 0.8rem;">Composición del Monto de Venta (Servicios + Productos):</p>
                                        <div class="d-flex justify-content-between align-items-center mb-2"><span style="color: #34495e; font-size: 0.9rem;">Total Servicios:</span><span id="totalServicios" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">₡0</span></div>
                                        <div class="d-flex justify-content-between align-items-center mb-2"><span style="color: #34495e; font-size: 0.9rem;">Total Productos:</span><span id="totalProductos" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">₡0</span></div>
                                        <div class="d-flex justify-content-between align-items-center pt-2" style="border-top: 2px solid #27ae60;"><strong style="color: #27ae60; font-size: 1rem;">Monto de Venta (total):</strong><span id="montoVentaDisplay" style="color: #27ae60; font-weight: 700; font-size: 1.1rem;">₡0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos contables (card de primer nivel, como Requerido/Detalles) -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title"><i class="fas fa-file-invoice-dollar me-2"></i>Campos contables</h5>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Método de Pago</label>
                                    <select id="editMetodoPago" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="">Seleccionar método de pago</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Datáfono (tarjeta)">Datáfono (tarjeta)</option>
                                        <option value="SINPE">SINPE</option>
                                        <option value="Transferencia bancaria">Transferencia bancaria</option>
                                        <option value="Cuenta por cobrar">Cuenta por cobrar</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">N° Factura</label>
                                    <input type="text" id="editNumeroFactura" class="form-control" placeholder="Ingrese el número de factura" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certificados y descripción (vendedores movido a Requerido) -->
                    <div class="card mb-2" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; z-index: 1;">
                        <div class="card-header" style="background: #e8eef4; border-bottom: 1px solid #dee2e6; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0;">
                            <h5 class="mb-0 form-section-title">Certificados y descripción</h5>
                </div>
                        <div class="card-body" id="contentAdicionalEdit" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-certificate me-1" style="opacity: 0.7;"></i>Certificados de Fumigación
                                    </label>
                                    <textarea id="editCertificados" class="form-control" rows="3" placeholder="Ingrese el texto para generar uno o más certificados de fumigación. Cada línea o párrafo generará un certificado separado." style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #ffffff; border-radius: 8px; color: #000000;"></textarea>
                                    <small class="d-block mt-1" style="font-size: 0.85rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Cada línea o párrafo generará un certificado separado para la fecha y hora de esta cita</small>
                                    <button type="button" id="btnGenerarCertificadoEdit" class="btn mt-2" style="background: #0b7835; color: white; border: none; border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-file-pdf me-2"></i>Generar PDF
                                    </button>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label mb-2 fw-bold" style="font-size: 1rem; color: #212529;">
                                        Descripción del Servicio
                                    </label>
                                    <textarea id="editDescription" class="form-control" rows="6" placeholder="Detalles adicionales sobre el servicio a realizar...&#10;&#10;Puede escribir listas usando guiones:&#10;- Item 1&#10;- Item 2&#10;- Item 3" style="border: 2px solid #dee2e6; font-size: 1rem; padding: 0.75rem; background-color: #ffffff; border-radius: 6px; font-family: 'Inter', monospace; white-space: pre-wrap; word-wrap: break-word;"></textarea>
                                    <small class="form-text text-muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
                                        <i class="fas fa-info-circle"></i> Puede escribir listas verticales usando guiones (-) o asteriscos (*) al inicio de cada línea.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light" style="display: none;">
                    <!-- Botones movidos al header -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Justificar Cita sin Encuesta -->
    <div class="modal fade" id="modalJustificarSinEncuesta" tabindex="-1" aria-labelledby="modalJustificarSinEncuestaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalJustificarSinEncuestaLabel">
                        <i class="fas fa-heart me-2"></i>Justificar Cita sin Encuesta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="justificacionSinEncuesta" class="form-label">
                            <strong>Justificación:</strong>
                            <small class="text-muted">Explique por qué esta cita no lleva encuesta</small>
                        </label>
                        <textarea class="form-control" id="justificacionSinEncuesta" rows="4" placeholder="Ejemplo: Cita cancelada, cliente no atendió, servicio no realizado, etc."></textarea>
                    </div>
                    <div id="justificacionExistente" class="alert alert-info" style="display: none;">
                        <strong>Justificación actual:</strong>
                        <p id="textoJustificacionExistente" class="mb-0 mt-2"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnGuardarJustificacion">
                        <i class="fas fa-save me-2"></i>Guardar Justificación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Historial de ediciones de la cita -->
    <div class="modal fade" id="modalHistorialEdiciones" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="modalHistorialLabel"><i class="fas fa-history me-2"></i>Historial de ediciones</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="historialSinRegistros" class="p-4 text-muted text-center" style="display: none;">No hay registros de edición para esta cita.</div>
                    <div id="historialContenedorTabla" class="table-responsive" style="display: none;">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Fecha y hora</th>
                                    <th>Usuario</th>
                                    <th>Campo</th>
                                    <th>Valor anterior</th>
                                    <th>Valor nuevo</th>
                                </tr>
                            </thead>
                            <tbody id="historialCuerpoTabla"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resultado de encuesta (cliente ya respondió) -->
    <div class="modal fade" id="modalResultadoEncuesta" tabindex="-1" aria-labelledby="modalResultadoEncuestaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #0b7835 0%, #0d5c28 100%);">
                    <h5 class="modal-title" id="modalResultadoEncuestaLabel"><i class="fas fa-chart-bar me-2"></i>Resultado de encuesta de satisfacción</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0" id="modalResultadoEncuestaBody">
                    <div id="modalResultadoEncuestaCargando" class="p-4 text-center text-muted">
                        <div class="spinner-border text-success mb-2" role="status"></div>
                        <p class="mb-0">Cargando resultado...</p>
                    </div>
                    <div id="modalResultadoEncuestaContenido" style="display: none;"></div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar datos de la sucursal (sin cambiar ID) -->
    <div class="modal fade" id="modalEditarSucursal" tabindex="-1" aria-labelledby="modalEditarSucursalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="modalEditarSucursalLabel"><i class="fas fa-building me-2"></i>Editar sucursal</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-2">El ID de la sucursal no se puede cambiar. Solo puede editar los datos de ubicación y nombre.</p>
                    <div class="mb-2">
                        <label class="form-label mb-0">Nombre de la sucursal</label>
                        <input type="text" id="sucursalModalNombre" class="form-control" placeholder="Ej: Hogar principal">
                    </div>
                    <div class="mb-2">
                        <label class="form-label mb-0">Coordenadas (lat, lng)</label>
                        <input type="text" id="sucursalModalCoordenadas" class="form-control" placeholder="9.936672, -84.144741">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4">
                            <label class="form-label mb-0">Provincia</label>
                            <select id="sucursalModalProvincia" class="form-select form-select-sm"><option value="">Provincia...</option></select>
                        </div>
                        <div class="col-4">
                            <label class="form-label mb-0">Cantón</label>
                            <select id="sucursalModalCanton" class="form-select form-select-sm" disabled><option value="">Cantón...</option></select>
                        </div>
                        <div class="col-4">
                            <label class="form-label mb-0">Distrito</label>
                            <select id="sucursalModalDistrito" class="form-select form-select-sm" disabled><option value="">Distrito...</option></select>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label mb-0">Dirección / Link (Waze/Google)</label>
                        <input type="text" id="sucursalModalDireccion" class="form-control" placeholder="Link o dirección">
                    </div>
                    <div class="mb-0">
                        <label class="form-label mb-0">Otras señas</label>
                        <input type="text" id="sucursalModalOtrasSenas" class="form-control" placeholder="Ej: 200mts norte del super">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarSucursalModal"><i class="fas fa-save me-1"></i>Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: NUEVA CITA ========== -->
    <!-- data-section="modal-nueva-cita" -->
    <div class="modal fade" id="nuevaCitaModal" data-section="modal-nueva-cita" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center" style="flex-wrap: wrap; gap: 0.35rem;">
                    <h5 class="modal-title mb-0" style="color: #8B0000 !important; font-size: 1.1rem;"><i class="fas fa-plus me-1"></i>Nueva Cita</h5>
                    <div class="d-flex gap-1 flex-wrap align-items-center">
                        <button type="button" id="btnDescargarProformaNew" title="Descargar proforma PNG" style="background: #fbdc02; color: #000; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-download me-1"></i>Proforma
                        </button>
                        <button type="button" id="btnJustificarSinEncuestaNew" title="Justificar por qué esta cita no lleva encuesta" style="background: #fbdc02; color: #000; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-heart me-1"></i>Justificar
                        </button>
                        <button type="button" id="btnEnviarEncuestaNew" title="Generar link de encuesta post-servicio" style="background: #fbdc02; color: #000; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-clipboard-check me-1"></i>Encuesta
                        </button>
                        <button type="button" id="btnDeleteCitaNew" title="Eliminar cita" style="background: #ea0e2a; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" title="Cancelar" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" id="btnSaveNewCitaTop" title="Guardar cita" style="background: #0b7835; color: white; border: none; border-radius: 8px; padding: 0.4rem 0.65rem; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-save me-1"></i>Guardar
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="padding: 0.35rem;"></button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 0.75rem; background: #f5f5f5;">
                    <!-- Campos Indispensables -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title">Requerido</h5>
                </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Teléfono -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 140px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Teléfono <span style="color: #ea0e2a;">*</span></label>
                                    <input type="text" id="newClientPhone" class="form-control" placeholder="12345678" maxlength="8" pattern="[0-9]{8}" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small id="newPhoneDisplay" class="d-block mt-1" style="font-size: 0.75rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;"></small>
                </div>
                                
                                <!-- Sucursal -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 200px;">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label mb-0" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Sucursal <span style="color: #ea0e2a;">*</span></label>
                                        <button type="button" id="btnEditarSucursalNew" class="btn btn-sm p-0" style="display: none; color: #6c757d; font-size: 0.85rem;" title="Editar datos de la sucursal" aria-label="Editar sucursal"><i class="fas fa-pen"></i></button>
                                    </div>
                                    <div class="input-group">
                                        <select id="newSucursal" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px 0 0 8px; color: #000000;">
                                            <option value="">Ingrese teléfono primero</option>
                                        </select>
                                        <button type="button" id="btnNuevaSucursalNew" class="btn" style="border: 1px solid #e0e0e0; border-left: none; border-radius: 0 8px 8px 0; background: #ffffff; color: #000000; padding: 0.75rem;" title="Crear nueva sucursal">
                                            <i class="fas fa-plus" style="opacity: 0.7;"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="newNombreSucursal" class="form-control mt-2" placeholder="Nombre de la sucursal" style="display: none; border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.8rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Seleccione o cree una sucursal</small>
                </div>
                                
                                <!-- Fecha y Hora de Inicio -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 230px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Fecha y Hora <span style="color: #ea0e2a;">*</span></label>
                                    <input type="datetime-local" id="newStartTime" class="form-control" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                
                                <!-- Duración -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 150px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Duración <span style="color: #ea0e2a;">*</span></label>
                                    <select id="newDuration" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="15">15 minutos</option>
                                        <option value="30">30 minutos</option>
                                        <option value="45">45 minutos</option>
                                        <option value="60" selected>1 hora</option>
                                        <option value="75">1 hora 15 minutos</option>
                                        <option value="90">1 hora 30 minutos</option>
                                        <option value="105">1 hora 45 minutos</option>
                                        <option value="120">2 horas</option>
                                        <option value="135">2 horas 15 minutos</option>
                                        <option value="150">2 horas 30 minutos</option>
                                        <option value="165">2 horas 45 minutos</option>
                                        <option value="180">3 horas</option>
                                        <option value="195">3 horas 15 minutos</option>
                                        <option value="210">3 horas 30 minutos</option>
                                        <option value="225">3 horas 45 minutos</option>
                                        <option value="240">4 horas</option>
                                        <option value="255">4 horas 15 minutos</option>
                                        <option value="270">4 horas 30 minutos</option>
                                        <option value="285">4 horas 45 minutos</option>
                                        <option value="300">5 horas</option>
                                        <option value="315">5 horas 15 minutos</option>
                                        <option value="330">5 horas 30 minutos</option>
                                        <option value="345">5 horas 45 minutos</option>
                                        <option value="360">6 horas</option>
                                        <option value="375">6 horas 15 minutos</option>
                                        <option value="390">6 horas 30 minutos</option>
                                        <option value="405">6 horas 45 minutos</option>
                                        <option value="420">7 horas</option>
                                        <option value="435">7 horas 15 minutos</option>
                                        <option value="450">7 horas 30 minutos</option>
                                        <option value="465">7 horas 45 minutos</option>
                                        <option value="480">8 horas</option>
                                        <option value="540">9 horas</option>
                                        <option value="600">10 horas</option>
                                        <option value="660">11 horas</option>
                                        <option value="720">12 horas</option>
                                    </select>
                                </div>
                                
                                <!-- Hora de Fin (calculada) -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 230px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Hora de Fin</label>
                                    <input type="text" id="newEndTime" class="form-control" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f8f9fa; border-radius: 8px; color: #000000; cursor: not-allowed;">
                                </div>
                                
                                <!-- Ruta -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; max-width: 120px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Ruta <span style="color: #ea0e2a;">*</span></label>
                                    <select id="newRuta" class="form-select" required style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="Sin asignar">Sin asignar</option>
                                <option value="Ruta 1">Ruta 1</option>
                                <option value="Ruta 2">Ruta 2</option>
                                <option value="Ruta 3">Ruta 3</option>
                                <option value="Ruta 4">Ruta 4</option>
                                <option value="Ruta 5">Ruta 5</option>
                                <option value="Ruta 6">Ruta 6</option>
                                <option value="Ruta 7">Ruta 7</option>
                                <option value="Ruta 8">Ruta 8</option>
                                <option value="Ruta 9">Ruta 9</option>
                                <option value="Ruta 10">Ruta 10</option>
                                <option value="Ruta 11">Ruta 11</option>
                                <option value="Ruta 12">Ruta 12</option>
                                <option value="Ruta 13">Ruta 13</option>
                                <option value="Ruta 14">Ruta 14</option>
                                <option value="Ruta 15">Ruta 15</option>
                                <option value="Ruta 16">Ruta 16</option>
                                <option value="Ruta 17">Ruta 17</option>
                                <option value="Ruta 18">Ruta 18</option>
                                <option value="Ruta 19">Ruta 19</option>
                                <option value="Ruta 20">Ruta 20</option>
                            </select>
                        </div>
                                
                                <!-- Nombre del Cliente -->
                                <div class="col-12 col-md" style="flex: 1 1 0; min-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Nombre del Cliente</label>
                                    <input type="text" id="newClientName" class="form-control" placeholder="Ingrese el nombre completo" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                                
                                <!-- Vendedores -->
                                <div class="col-12 col-md" style="flex: 1 1 0; min-width: 200px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Vendedores *</label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="newVendedorSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar vendedor" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newVendedoresDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewVendedor" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newVendedoresSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                
                                <!-- Confirmada dentro de 24-48 horas -->
                                <div class="col-12 col-md" style="flex: 0 0 auto; min-width: 220px;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Confirmada dentro de 24-48 horas</label>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="newConfirmada24_48" role="switch" aria-label="Cliente avisado">
                                        <label class="form-check-label" for="newConfirmada24_48">Cliente avisado (recordatorio enviado)</label>
                                    </div>
                                    <small id="newConfirmada24_48Mensaje" class="text-muted d-block mt-1"></small>
                                    <small id="newConfirmada24_48Timestamp" class="d-block mt-1" style="display:none;"></small>
                                </div>
                                    </div>
                                </div>
                                        </div>
                    
                    <!-- Detalles de la cita -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title">Detalles</h5>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <!-- Ubicación -->
                                <div class="col-12">
                                    <h6 class="form-subsection-title mb-2">Ubicación</h6>
                        </div>
                                
                                <!-- Fila 1: Coordenadas, Otras Señas, Provincia, Cantón y Distrito en la misma línea -->
                                <div class="col-12">
                                    <div class="row" style="gap: 0.5rem 0.75rem; margin: 0;">
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Coordenadas (Lat, Lng)</label>
                                            <input type="text" id="newCoordenadas" class="form-control" placeholder="9.838501, -83.866745" pattern="^-?\d+\.?\d*,\s*-?\d+\.?\d*$" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Otras Señas</label>
                                            <input type="text" id="newOtrasSenas" class="form-control" placeholder="Ej: 200mts norte del supermercado, casa azul" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Provincia</label>
                                            <select id="newProvincia" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                                <option value="">Seleccionar provincia...</option>
                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Cantón</label>
                                            <select id="newCanton" class="form-select" disabled style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                                <option value="">Primero seleccione una provincia</option>
                            </select>
                                        </div>
                                        
                                        <div class="col" style="flex: 1 1 0; min-width: 0;">
                                            <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Distrito</label>
                                            <select id="newDistrito" class="form-select" disabled style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                                <option value="">Primero seleccione un cantón</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fila 2: Link de Ubicación y WhatsApp -->
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Link de Ubicación (Waze/Google Maps)</label>
                                    <textarea id="newDireccion" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generarán automáticamente al ingresar coordenadas"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">WhatsApp</label>
                                    <textarea id="newWhatsApp" class="form-control" rows="2" readonly style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #f5f5f5; border-radius: 8px; color: #000000; opacity: 0.7;" placeholder="Se generará automáticamente con el teléfono"></textarea>
                                </div>
                                
                                <!-- Mapa -->
                                <div class="col-12" style="margin-top: 0.5rem;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Vista del Mapa</label>
                                    <div id="mapaUbicacionNew" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #e0e0e0;"></div>
                                        </div>
                                
                                <!-- Enfoque de plaga -->
                                <div class="col-12" style="position: relative; z-index: 999;">
                                    <hr style="margin: 0.75rem 0; border-color: #e0e0e0; border-width: 1px;">
                                    <h6 class="form-subsection-title mb-2">Enfoque de plaga</h6>
                                    <div class="dropdown-container" style="position: relative; z-index: 1000;">
                                        <input type="text" id="newPlagaSearch" aria-label="Enfoque de plaga" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar enfoque de plaga" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newPlagasDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1001 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewPlaga" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newPlagasSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                        </div>
                        </div>
                    </div>

                    <!-- Precio y monto de venta (card de primer nivel) -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title"><i class="fas fa-calculator me-2"></i>Precio y monto de venta</h5>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <p class="mb-3" style="font-size: 0.8rem; color: #6c757d;">Complete servicios, productos y costo; el monto total se actualiza solo. Puede editarlo al final si lo necesita.</p>
                            <div class="row" style="gap: 0.75rem 0;">
                                <div class="col-12" style="position: relative; z-index: 1000;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Servicios</label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1001;">
                                        <input type="text" id="newServicioSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar servicio" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newServiciosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1002 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewServicio" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newServiciosSelected" class="mb-2 mt-2">
                                        <table class="table table-sm table-bordered" id="newServiciosTabla" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="font-size: 0.9rem; font-weight: 600;">Servicio</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 100px;">Cantidad</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Precio Unit. (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Total (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="newServiciosTablaBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-12 mt-3" style="position: relative; z-index: 999;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Productos de inventario</label>
                                    <div class="dropdown-container" style="position: relative; z-index: 1000;">
                                        <input type="text" id="newProductoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar producto" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newProductosDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1001 !important; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewProducto" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newProductosSelected" class="mb-2 mt-2">
                                        <table class="table table-sm table-bordered" id="newProductosTabla" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="font-size: 0.9rem; font-weight: 600;">Producto</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 100px;">Cantidad</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Precio Unit. (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 150px;">Total (₡)</th>
                                                    <th style="font-size: 0.9rem; font-weight: 600; width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="newProductosTablaBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-12 mt-3" style="position: relative; z-index: 998;">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Equipo y Herramientas
                                    </label>
                                    <div class="dropdown-container" style="position: relative;">
                                        <input type="text" id="newEquipoSearch" class="form-control dropdown-toggle" placeholder="Buscar o seleccionar equipo" autocomplete="off" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <div class="dropdown-menu" id="newEquipoDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-top: 0.25rem;">
                                            <div class="dropdown-item text-muted" id="noResultsNewEquipo" style="display: none; padding: 0.75rem; color: #6c757d; font-size: 0.9rem;">No se encontraron resultados</div>
                                        </div>
                                    </div>
                                    <div id="newEquipoSelected" class="d-flex flex-wrap gap-1 mb-2 mt-2"></div>
                                </div>
                                <div class="col-12 mt-2">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Monto de Venta (₡)</label>
                                    <input type="text" id="newMontoVenta" class="form-control" placeholder="0" style="border: 1px solid #27ae60; font-size: 1rem; font-weight: 600; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #f0fff4; border-radius: 8px; color: #000000;">
                                    <small class="d-block mt-1" style="font-size: 0.8rem; color: #6c757d;">Servicios + Productos. Edítelo aquí si desea cambiarlo.</small>
                                </div>
                                <div class="col-12 mt-3">
                                    <div style="background-color: #f8f9fa; padding: 0.75rem; border-radius: 6px; border: 1px solid #dee2e6;">
                                        <p class="mb-2" style="color: #7f8c8d; font-size: 0.8rem;">Composición del Monto de Venta (Servicios + Productos):</p>
                                        <div class="d-flex justify-content-between align-items-center mb-2"><span style="color: #34495e; font-size: 0.9rem;">Total Servicios:</span><span id="newTotalServicios" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">₡0</span></div>
                                        <div class="d-flex justify-content-between align-items-center mb-2"><span style="color: #34495e; font-size: 0.9rem;">Total Productos:</span><span id="newTotalProductos" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">₡0</span></div>
                                        <div class="d-flex justify-content-between align-items-center pt-2" style="border-top: 2px solid #27ae60;"><strong style="color: #27ae60; font-size: 1rem;">Monto de Venta (total):</strong><span id="newMontoVentaDisplay" style="color: #27ae60; font-weight: 700; font-size: 1.1rem;">₡0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos contables (card de primer nivel) -->
                    <div class="card mb-3" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div class="card-header" style="background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 0.75rem;">
                            <h5 class="mb-0 form-section-title"><i class="fas fa-file-invoice-dollar me-2"></i>Campos contables</h5>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">Método de Pago</label>
                                    <select id="newMetodoPago" class="form-select" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                        <option value="">Seleccionar método de pago</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Datáfono (tarjeta)">Datáfono (tarjeta)</option>
                                        <option value="SINPE">SINPE</option>
                                        <option value="Transferencia bancaria">Transferencia bancaria</option>
                                        <option value="Cuenta por cobrar">Cuenta por cobrar</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">N° Factura</label>
                                    <input type="text" id="newNumeroFactura" class="form-control" placeholder="Ingrese el número de factura" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; height: auto; background-color: #ffffff; border-radius: 8px; color: #000000;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Equipo, Certificados y descripción (vendedores movido a Requerido) -->
                    <div class="card mb-2" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; z-index: 1;">
                        <div class="card-header" style="background: #e8eef4; border-bottom: 1px solid #dee2e6; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0;">
                            <h5 class="mb-0 form-section-title">Equipo, certificados y descripción</h5>
                        </div>
                        <div class="card-body" id="contentAdicionalNew" style="padding: 1rem;">
                            <div class="row" style="gap: 0.75rem 0;">
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-certificate me-1" style="opacity: 0.7;"></i>Certificados de Fumigación
                                    </label>
                                    <textarea id="newCertificados" class="form-control" rows="3" placeholder="Ingrese el texto para generar uno o más certificados de fumigación. Cada línea o párrafo generará un certificado separado." style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', sans-serif; padding: 0.75rem; resize: vertical; background-color: #ffffff; border-radius: 8px; color: #000000;"></textarea>
                                    <small class="d-block mt-1" style="font-size: 0.85rem; color: #000000; opacity: 0.7; font-family: 'Inter', sans-serif;">Cada línea o párrafo generará un certificado separado para la fecha y hora de esta cita</small>
                                    <button type="button" id="btnGenerarCertificadoNew" class="btn mt-2" style="background: #0b7835; color: white; border: none; border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 1rem; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); font-family: 'Inter', sans-serif;">
                                        <i class="fas fa-file-pdf me-2"></i>Generar PDF
                                    </button>
                        </div>
                                <div class="col-12">
                                    <label class="form-label mb-1" style="font-size: 0.9rem; font-weight: 600; color: #000000; font-family: 'Inter', sans-serif;">
                                        Descripción del Servicio
                                    </label>
                                    <textarea id="newDescription" class="form-control" rows="6" placeholder="Detalles adicionales sobre el servicio a realizar...&#10;&#10;Puede escribir listas usando guiones:&#10;- Item 1&#10;- Item 2&#10;- Item 3" style="border: 1px solid #e0e0e0; font-size: 1rem; font-weight: 400; font-family: 'Inter', monospace; padding: 0.75rem; background-color: #ffffff; border-radius: 8px; color: #000000; resize: vertical; white-space: pre-wrap; word-wrap: break-word;"></textarea>
                                    <small class="form-text text-muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
                                        <i class="fas fa-info-circle"></i> Puede escribir listas verticales usando guiones (-) o asteriscos (*) al inicio de cada línea.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light" style="display: none;">
                    <!-- Botones movidos al header -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gestionar Servicios -->
    <!-- Modal para Mapa de Ruta del Vehículo -->
    <div class="modal fade" id="modalRutaVehiculo" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important; border-bottom: 2px solid #0d47a1;">
                    <h5 class="modal-title" style="color: #FFFFFF !important; font-weight: 700 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="fas fa-route me-2"></i>Ruta del Vehículo: <span id="rutaVehiculoNombre" style="color: #FFD700 !important; font-weight: 800 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">-</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 0.5rem; background: #f5f7fa;">
                    <div id="mapaRutaVehiculo" style="height: 400px; width: 100%; border-radius: 6px; border: 2px solid #1976D2; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);"></div>
                    <div id="rutaInfo" class="mt-2" style="font-size: 0.85rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ASIGNAR TÉCNICOS Y VEHÍCULOS ========== -->
    <!-- data-section="modal-ruteador" -->
    <!-- Modal para Editar Ruteador (Técnicos y Vehículos) -->
    <div class="modal fade" id="modalRuteador" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important; border-bottom: 2px solid #2e7d32;">
                    <h5 class="modal-title" style="color: #FFFFFF !important; font-weight: 700 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        <i class="fas fa-users-cog me-2"></i>Asignar Técnicos y Vehículos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 1.5rem;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ruta:</label>
                        <div id="ruteadorRutaNombre" class="fw-bold text-primary" style="font-size: 1.1rem;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fecha:</label>
                        <div id="ruteadorFechaNombre" class="text-muted"></div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-4 p-3 rounded border border-primary border-2" id="wrapRuteadorHoraConvocatoria" style="background-color: #e8f4fd;">
                        <label class="form-label fw-bold mb-2 text-primary">
                            <i class="fas fa-clock me-2"></i>Hora de convocatoria
                        </label>
                        <input type="time" id="ruteadorHoraConvocatoria" class="form-control form-control-lg" style="min-height: 48px; font-size: 1.25rem; max-width: 180px;">
                        <small class="text-muted d-block mt-1">Hora a la que deben presentarse los técnicos ese día para esta ruta</small>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-2">
                            <i class="fas fa-users me-2"></i>Técnicos Asignados
                        </label>
                        <div id="ruteadorTecnicosContainer" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando empleados...
                            </div>
                        </div>
                        <small class="text-muted">Seleccione uno o más técnicos</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold mb-2">
                            <i class="fas fa-truck me-2"></i>Vehículos Asignados
                        </label>
                        <div id="ruteadorVehiculosContainer" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <!-- Los vehículos se generarán dinámicamente -->
                        </div>
                        <small class="text-muted">Seleccione uno o más vehículos</small>
                    </div>
                    
                    <div id="ruteadorErrores" class="alert alert-warning" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="window.guardarRuteador()">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: MIGRAR CITAS ========== -->
    <!-- data-section="modal-migrar-citas" -->
    <!-- Modal para Migrar Citas entre Rutas -->
    <div class="modal fade" id="modalMigrarRutas" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Migrar Citas entre Rutas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instrucciones:</strong> Esta herramienta migrará todas las citas de la ruta origen a la ruta destino 
                        <strong>solo del día laborable seleccionado</strong> (5am a 5am del siguiente día). 
                        Las citas se migrarán manteniendo todas sus demás propiedades.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-arrow-left me-2"></i>Ruta Origen <span class="text-danger">*</span>
                            </label>
                            <input type="text" id="rutaOrigenMigrar" class="form-control" readonly>
                            <input type="hidden" id="fechaDiaMigrar" value="">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-arrow-right me-2"></i>Ruta Destino <span class="text-danger">*</span>
                            </label>
                            <select id="rutaDestinoMigrar" class="form-select">
                                <option value="">Seleccionar ruta destino...</option>
                                <option value="Sin asignar">Sin asignar</option>
                                <option value="Ruta 1">Ruta 1</option>
                                <option value="Ruta 2">Ruta 2</option>
                                <option value="Ruta 3">Ruta 3</option>
                                <option value="Ruta 4">Ruta 4</option>
                                <option value="Ruta 5">Ruta 5</option>
                                <option value="Ruta 6">Ruta 6</option>
                                <option value="Ruta 7">Ruta 7</option>
                                <option value="Ruta 8">Ruta 8</option>
                                <option value="Ruta 9">Ruta 9</option>
                                <option value="Ruta 10">Ruta 10</option>
                                <option value="Ruta 11">Ruta 11</option>
                                <option value="Ruta 12">Ruta 12</option>
                                <option value="Ruta 13">Ruta 13</option>
                                <option value="Ruta 14">Ruta 14</option>
                                <option value="Ruta 15">Ruta 15</option>
                                <option value="Ruta 16">Ruta 16</option>
                                <option value="Ruta 17">Ruta 17</option>
                                <option value="Ruta 18">Ruta 18</option>
                                <option value="Ruta 19">Ruta 19</option>
                                <option value="Ruta 20">Ruta 20</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="previewMigracion" class="mt-4" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Vista Previa</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Citas a migrar:</strong> <span id="totalCitasMigrar">0</span></p>
                                <p class="mb-0 text-muted small">Se migrarán todas las citas de "<span id="previewRutaOrigen"></span>" a "<span id="previewRutaDestino"></span>"</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnPreviewMigracion" onclick="previewMigracionRutas()">
                        <i class="fas fa-eye me-2"></i>Vista Previa
                    </button>
                    <button type="button" class="btn btn-success" id="btnConfirmarMigracion" onclick="confirmarMigracionRutas()" disabled>
                        <i class="fas fa-check me-2"></i>Confirmar Migración
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: GESTIONAR SERVICIOS ========== -->
    <!-- data-section="modal-gestionar-servicios" -->
    <div class="modal fade" id="modalGestionarServicios" data-section="modal-gestionar-servicios" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Gestionar Servicios</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Formulario para agregar nuevo servicio -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Nuevo Servicio</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-7 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-1"></i>Nombre del Servicio <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="nuevoServicioNombre" class="form-control form-control-modern" placeholder="Ej: Termonebulización">
                                </div>
                                <div class="col-md-5 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-dollar-sign me-1"></i>Precio (₡) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" id="nuevoServicioPrecio" class="form-control form-control-modern" placeholder="20000" min="0" step="1">
                                </div>
                            </div>
                            <button type="button" id="btnAgregarServicio" class="btn btn-success-modern btn-modern">
                                <i class="fas fa-plus me-2"></i>Agregar Servicio
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de servicios existentes -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Servicios Disponibles</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 5%;">ID</th>
                                            <th style="width: 50%;">Nombre</th>
                                            <th style="width: 30%;">Precio (₡)</th>
                                            <th style="width: 15%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaServicios">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando servicios...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: GESTIONAR EQUIPO ========== -->
    <!-- data-section="modal-gestionar-equipo" -->
    <!-- Modal para Gestionar Equipo y Herramientas -->
    <div class="modal fade" id="modalGestionarEquipo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-tools me-2"></i>Gestionar Equipo y Herramientas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Formulario para agregar nuevo equipo -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Nuevo Equipo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-1"></i>Nombre del Equipo/Herramienta <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="nuevoEquipoNombre" class="form-control form-control-modern" placeholder="Ej: Termonebulizador portátil, Bomba de presión, etc.">
                                </div>
                            </div>
                            <button type="button" id="btnAgregarEquipo" class="btn btn-success-modern btn-modern">
                                <i class="fas fa-plus me-2"></i>Agregar Equipo
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de equipo existente -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Equipo y Herramientas Disponibles</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 5%;">ID</th>
                                            <th style="width: 80%;">Nombre</th>
                                            <th style="width: 15%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaEquipo">
                                        <tr>
                                            <td colspan="3" class="text-center text-muted py-4">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando equipo...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let todasLasCitas = [];
        let citasFiltradas = [];
        let selectedCita = null;
        console.log('🔍 [CALENDARIO] Variables globales inicializándose...');
        let currentDate = new Date();
        let diaSeleccionado = new Date();
        // Inicializar semanaActual como el lunes de la semana actual
        function obtenerLunesSemanaInit(fecha) {
            const d = new Date(fecha);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajustar para que lunes sea 0
            return new Date(d.setDate(diff));
        }
        let semanaActual = obtenerLunesSemanaInit(new Date()); // Fecha del lunes de la semana actual en vista compacta
        console.log('🔍 [CALENDARIO] Variables globales inicializadas');
        // Mapas de encuestas:
        // - mapEncuestasCitas: lógica primaria - clave = cita_id, valor = { estado: 'pendiente'|'respondida' }
        // - mapaLinksEncuestas: legacy - clave = "telefono_fechaServicio"
        // - mapaRespuestasEncuestas: legacy - clave = "id_encuesta"
        // - mapaJustificacionesSinEncuesta: justificaciones - clave = "cita_id"
        let mapEncuestasCitas = new Map();
        let mapaLinksEncuestas = new Map();
        let mapaRespuestasEncuestas = new Map();
        let mapaJustificacionesSinEncuesta = new Map();
        let vistaActual = 'cronograma';

        // Función global para formatear fecha
        window.formatearFecha = function(timestamp) {
            if (!timestamp) return null;
            const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return fecha;
        };
        
        // Alias para uso dentro del módulo
        const formatearFecha = window.formatearFecha;

        // ========== GESTIÓN DE UBICACIONES (PROVINCIA, CANTÓN, DISTRITO) - Funciones de llenado ==========
        // Llenar selector de provincias en modal de edición
        function llenarProvinciasEdit() {
            const selectProvincia = document.getElementById('editProvincia');
            if (!selectProvincia || !window.ubicacionesCR) return;
            
            selectProvincia.innerHTML = '<option value="">Seleccionar provincia...</option>';
            
            Object.values(window.ubicacionesCR).forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia.id;
                option.textContent = provincia.nombre;
                selectProvincia.appendChild(option);
            });
        }
        
        // Llenar selector de cantones según provincia seleccionada (edición)
        function llenarCantonesEdit(provinciaId) {
            const selectCanton = document.getElementById('editCanton');
            const selectDistrito = document.getElementById('editDistrito');
            
            if (!selectCanton || !window.ubicacionesCR || !provinciaId) {
                if (selectCanton) {
                    selectCanton.innerHTML = '<option value="">Primero seleccione una provincia</option>';
                    selectCanton.disabled = true;
                }
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones) {
                if (selectCanton) {
                    selectCanton.innerHTML = '<option value="">No hay cantones disponibles</option>';
                    selectCanton.disabled = true;
                }
                return;
            }
            
            selectCanton.innerHTML = '<option value="">Seleccionar cantón...</option>';
            
            Object.values(provincia.cantones).forEach(canton => {
                const option = document.createElement('option');
                option.value = canton.id;
                option.textContent = canton.nombre;
                selectCanton.appendChild(option);
            });
            
            selectCanton.disabled = false;
            
            // Limpiar distritos
            if (selectDistrito) {
                selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                selectDistrito.disabled = true;
            }
        }
        
        // Llenar selector de distritos según cantón seleccionado (edición)
        function llenarDistritosEdit(provinciaId, cantonId) {
            const selectDistrito = document.getElementById('editDistrito');
            
            if (!selectDistrito || !window.ubicacionesCR || !provinciaId || !cantonId) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones || !provincia.cantones[cantonId]) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">No hay distritos disponibles</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const canton = provincia.cantones[cantonId];
            if (!canton || !canton.distritos) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">No hay distritos disponibles</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            selectDistrito.innerHTML = '<option value="">Seleccionar distrito...</option>';
            
            Object.values(canton.distritos).forEach(distrito => {
                const option = document.createElement('option');
                option.value = distrito.id;
                option.textContent = distrito.nombre;
                selectDistrito.appendChild(option);
            });
            
            selectDistrito.disabled = false;
        }
        
        // ========== FUNCIONES PARA FORMULARIO NUEVA CITA ==========
        // Llenar selector de provincias en modal de nueva cita
        function llenarProvinciasNew() {
            const selectProvincia = document.getElementById('newProvincia');
            if (!selectProvincia || !window.ubicacionesCR) return;
            
            selectProvincia.innerHTML = '<option value="">Seleccionar provincia...</option>';
            
            Object.values(window.ubicacionesCR).forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia.id;
                option.textContent = provincia.nombre;
                selectProvincia.appendChild(option);
            });
        }
        
        // Llenar selector de cantones según provincia seleccionada (nueva cita)
        function llenarCantonesNew(provinciaId) {
            const selectCanton = document.getElementById('newCanton');
            const selectDistrito = document.getElementById('newDistrito');
            
            if (!selectCanton || !window.ubicacionesCR || !provinciaId) {
                if (selectCanton) {
                    selectCanton.innerHTML = '<option value="">Primero seleccione una provincia</option>';
                    selectCanton.disabled = true;
                }
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones) {
                if (selectCanton) {
                    selectCanton.innerHTML = '<option value="">No hay cantones disponibles</option>';
                    selectCanton.disabled = true;
                }
                return;
            }
            
            selectCanton.innerHTML = '<option value="">Seleccionar cantón...</option>';
            
            Object.values(provincia.cantones).forEach(canton => {
                const option = document.createElement('option');
                option.value = canton.id;
                option.textContent = canton.nombre;
                selectCanton.appendChild(option);
            });
            
            selectCanton.disabled = false;
            
            // Limpiar distritos
            if (selectDistrito) {
                selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                selectDistrito.disabled = true;
            }
        }
        
        // Llenar selector de distritos según cantón seleccionado (nueva cita)
        function llenarDistritosNew(provinciaId, cantonId) {
            const selectDistrito = document.getElementById('newDistrito');
            
            if (!selectDistrito || !window.ubicacionesCR || !provinciaId || !cantonId) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones || !provincia.cantones[cantonId]) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">No hay distritos disponibles</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            const canton = provincia.cantones[cantonId];
            if (!canton || !canton.distritos) {
                if (selectDistrito) {
                    selectDistrito.innerHTML = '<option value="">No hay distritos disponibles</option>';
                    selectDistrito.disabled = true;
                }
                return;
            }
            
            selectDistrito.innerHTML = '<option value="">Seleccionar distrito...</option>';
            
            Object.values(canton.distritos).forEach(distrito => {
                const option = document.createElement('option');
                option.value = distrito.id;
                option.textContent = distrito.nombre;
                selectDistrito.appendChild(option);
            });
            
            selectDistrito.disabled = false;
        }
        
        // Actualizar mapa de ubicación en modal de edición
        // Actualizar mapa según ubicación seleccionada (COPIADO EXACTAMENTE de citas_registradas.html)
        async function actualizarMapaUbicacionEdit(provinciaId, cantonId, distritoId) {
            console.log('🔍 actualizarMapaUbicacionEdit llamado con:', { provinciaId, cantonId, distritoId });
            
            // Verificar que el mapa esté inicializado y sea válido
            const contenedor = document.getElementById('mapaUbicacionEdit');
            
            // Usar la variable global
            mapaUbicacionEdit = window.mapaUbicacionEdit;
            
            if (!mapaUbicacionEdit || typeof mapaUbicacionEdit.setView !== 'function' || typeof mapaUbicacionEdit.invalidateSize !== 'function') {
                console.warn('⚠️ Mapa no está inicializado o no es válido', {
                    tieneMapa: !!mapaUbicacionEdit,
                    tipo: typeof mapaUbicacionEdit,
                    tieneSetView: mapaUbicacionEdit ? typeof mapaUbicacionEdit.setView : 'N/A',
                    tieneLeafletId: contenedor ? !!contenedor._leaflet_id : false
                });
                // Si el mapa no está inicializado, intentar inicializarlo
                if (!mapaUbicacionEdit) {
                    inicializarMapaEdit();
                }
                // Esperar un momento y reintentar
                setTimeout(() => actualizarMapaUbicacionEdit(provinciaId, cantonId, distritoId), 500);
                return;
            }
            
            if (!ubicacionesCR) {
                console.warn('⚠️ ubicacionesCR no está cargado');
                return;
            }
            
            // Asegurar que el mapa tenga el tamaño correcto
            setTimeout(() => {
                if (mapaUbicacionEdit && typeof mapaUbicacionEdit.invalidateSize === 'function') {
                    mapaUbicacionEdit.invalidateSize();
                }
            }, 50);
            
            let ubicacionTexto = '';
            
            // Priorizar: Distrito > Cantón > Provincia (más específico primero)
            if (provinciaId && ubicacionesCR[provinciaId]) {
                const provinciaNombre = ubicacionesCR[provinciaId].nombre;
                let cantonNombre = '';
                let distritoNombre = '';
                
                if (cantonId && ubicacionesCR[provinciaId].cantones && ubicacionesCR[provinciaId].cantones[cantonId]) {
                    cantonNombre = ubicacionesCR[provinciaId].cantones[cantonId].nombre;
                    
                    if (distritoId && ubicacionesCR[provinciaId].cantones[cantonId].distritos && ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                        distritoNombre = ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre;
                    }
                }
                
                // Construir búsqueda priorizando distrito
                if (distritoNombre) {
                    ubicacionTexto = `${distritoNombre}, ${cantonNombre}, ${provinciaNombre}`;
                } else if (cantonNombre) {
                    ubicacionTexto = `${cantonNombre}, ${provinciaNombre}`;
                } else {
                    ubicacionTexto = provinciaNombre;
                }
            }
            
            console.log('📍 Ubicación texto construido:', ubicacionTexto);
            
            if (!ubicacionTexto) {
                console.warn('⚠️ No hay texto de ubicación, centrando en Costa Rica');
                // Si no hay ubicación, mostrar centro de Costa Rica
                mapaUbicacionEdit.setView([9.7489, -83.7534], 8);
                if (window.marcadorUbicacionEdit) {
                    mapaUbicacionEdit.removeLayer(window.marcadorUbicacionEdit);
                    window.marcadorUbicacionEdit = null;
                    marcadorUbicacionEdit = null;
                }
                return;
            }
            
            // Geocodificar la ubicación usando Nominatim (OpenStreetMap)
            // Priorizar distrito con múltiples intentos de búsqueda
            try {
                let data = null;
                let queryUsado = '';
                
                // Extraer nombres individuales para búsquedas progresivas
                const partes = ubicacionTexto.split(', ');
                const distritoNombre = partes[0];
                const cantonNombre = partes.length > 1 ? partes[1] : '';
                const provinciaNombre = partes.length > 2 ? partes[2] : '';
                
                // Intentar búsquedas progresivas, priorizando distrito
                const queries = [];
                
                // 1. Solo distrito + cantón (máxima jerarquía al distrito)
                if (distritoNombre && cantonNombre) {
                    queries.push(`${distritoNombre}, ${cantonNombre}, Costa Rica`);
                }
                
                // 2. Solo distrito (máxima especificidad)
                if (distritoNombre) {
                    queries.push(`${distritoNombre}, Costa Rica`);
                }
                
                // 3. Distrito + cantón + provincia (fallback)
                if (distritoNombre && cantonNombre && provinciaNombre) {
                    queries.push(`${distritoNombre}, ${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                }
                
                // 4. Cantón + provincia (si no hay distrito)
                if (!distritoNombre && cantonNombre && provinciaNombre) {
                    queries.push(`${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                }
                
                // 5. Solo provincia (último recurso)
                if (!distritoNombre && !cantonNombre && provinciaNombre) {
                    queries.push(`${provinciaNombre}, Costa Rica`);
                }
                
                // Intentar cada query hasta encontrar resultados
                for (const query of queries) {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                    const result = await response.json();
                    
                    if (result && result.length > 0) {
                        data = result;
                        queryUsado = query;
                        break;
                    }
                }
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    // Centrar mapa en la ubicación
                    mapaUbicacionEdit.setView([lat, lon], 13);
                    
                    // Invalidar tamaño antes de agregar marcador
                    mapaUbicacionEdit.invalidateSize();
                    
                // Remover marcador anterior si existe
                if (window.marcadorUbicacionEdit) {
                    mapaUbicacionEdit.removeLayer(window.marcadorUbicacionEdit);
                }
                
                // Agregar nuevo marcador
                window.marcadorUbicacionEdit = L.marker([lat, lon]).addTo(mapaUbicacionEdit);
                marcadorUbicacionEdit = window.marcadorUbicacionEdit; // Sincronizar alias local
                window.marcadorUbicacionEdit.bindPopup(`<b>${ubicacionTexto}</b>`).openPopup();
                    
                    // Invalidar tamaño nuevamente después de agregar marcador
                    setTimeout(() => {
                        mapaUbicacionEdit.invalidateSize();
                    }, 100);
                    
                    console.log('✅ Mapa actualizado para:', ubicacionTexto, '(búsqueda:', queryUsado, ')');
                } else {
                    console.warn('⚠️ No se encontró ubicación para:', ubicacionTexto);
                }
            } catch (error) {
                console.error('❌ Error geocodificando ubicación:', error);
            }
        }

        // Función global para abrir modal de edición
        // Función para calcular y mostrar la hora de fin basándose en la hora de inicio y duración
        window.calcularHoraFin = function(prefix = 'edit') {
            const startTimeInput = document.getElementById(prefix === 'edit' ? 'editStartTime' : 'newStartTime');
            const durationSelect = document.getElementById(prefix === 'edit' ? 'editDuration' : 'newDuration');
            const endTimeInput = document.getElementById(prefix === 'edit' ? 'editEndTime' : 'newEndTime');
            
            if (!startTimeInput || !durationSelect || !endTimeInput) {
                return;
            }
            
            const startTimeValue = startTimeInput.value;
            const durationValue = parseInt(durationSelect.value) || 0;
            
            if (!startTimeValue || durationValue === 0) {
                endTimeInput.value = '';
                return;
            }
            
            try {
                // Crear objeto Date desde el valor datetime-local
                const startDate = new Date(startTimeValue);
                
                if (isNaN(startDate.getTime())) {
                    endTimeInput.value = '';
                    return;
                }
                
                // Agregar la duración en minutos
                const endDate = new Date(startDate.getTime() + durationValue * 60000);
                
                // Formatear la fecha de fin en formato legible (DD/MM/YYYY HH:MM AM/PM)
                const day = String(endDate.getDate()).padStart(2, '0');
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const year = endDate.getFullYear();
                const hours = endDate.getHours();
                const minutes = String(endDate.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'p. m.' : 'a. m.';
                const hours12 = hours % 12 || 12;
                
                const horaFinFormateada = `${day}/${month}/${year} ${hours12}:${minutes} ${ampm}`;
                endTimeInput.value = horaFinFormateada;
            } catch (error) {
                console.error('Error calculando hora de fin:', error);
                endTimeInput.value = '';
            }
        };
        
        async function abrirModalEdicion(citaId) {
            console.log('🔍 ===== INICIANDO abrirModalEdicion =====');
            console.log('🔍 Cita ID recibido:', citaId);
            console.log('🔍 Tipo de citaId:', typeof citaId);
            console.log('📊 window.todasLasCitas existe:', !!window.todasLasCitas);
            console.log('📊 window.todasLasCitas es array:', Array.isArray(window.todasLasCitas));
            console.log('📊 Total de citas disponibles:', window.todasLasCitas ? window.todasLasCitas.length : 0);
            
            if (window.todasLasCitas && window.todasLasCitas.length > 0) {
                console.log('📋 Primeras 3 citas:', window.todasLasCitas.slice(0, 3).map(c => ({ id: c.id, cliente: window.obtenerClienteNombre ? window.obtenerClienteNombre(c) : 'N/A' })));
            }
            
            // Buscar la cita en las variables globales
            const cita = window.todasLasCitas ? window.todasLasCitas.find(c => c.id === citaId) : null;
            
            console.log('🔍 Búsqueda de cita - resultado:', cita ? 'ENCONTRADA' : 'NO ENCONTRADA');
            
            if (!cita) {
                console.error('❌ Cita no encontrada:', citaId);
                console.log('🔍 IDs disponibles:', window.todasLasCitas ? window.todasLasCitas.map(c => c.id) : 'No hay citas');
                console.log('🔍 Comparación exacta de IDs:');
                if (window.todasLasCitas) {
                    window.todasLasCitas.forEach((c, index) => {
                        console.log(`  [${index}] ID: "${c.id}" (tipo: ${typeof c.id}) === "${citaId}" (tipo: ${typeof citaId}) = ${c.id === citaId}`);
                    });
                }
                alert('Error: No se pudo encontrar la cita seleccionada');
                return;
            }
            
            console.log('✅ Cita encontrada:', cita);
            // Usar versión síncrona para logging
            const nombreClienteLog = window.obtenerClienteNombreSync ? window.obtenerClienteNombreSync(cita) : 'N/A';
            console.log('✅ Cliente:', nombreClienteLog);
            console.log('✅ Vehículo:', window.obtenerVehiculo ? window.obtenerVehiculo(cita) : 'N/A');
            
            // Asignar a variable global
            window.selectedCita = cita;
            selectedCita = cita;
            
            // Verificar que las funciones helper estén disponibles
            if (!window.obtenerClienteNombre) {
                console.error('❌ Funciones helper no están disponibles aún');
                alert('Error: Las funciones helper no están cargadas. Por favor, recarga la página.');
                return;
            }
            
            // LIMPIAR selecciones antes de cargar datos de la cita
            // Esto asegura que cada cita tenga sus propias selecciones independientes
            window.serviciosSeleccionadosEdit = [];
            window.plagasSeleccionadasEdit = [];
            
            // Renderizar tablas/vistas vacías antes de cargar datos
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('edit');
            }
            // Inicializar búsqueda de plagas para renderizar estado vacío
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('edit');
            }
            
            // Llenar provincias en el formulario de edición
            if (window.llenarProvinciasEdit) {
                llenarProvinciasEdit();
            }
            
            // Llenar el formulario con todos los datos
            // Obtener nombre del cliente desde el documento del cliente (source of truth)
            const telefonoCita = window.obtenerTelefono(cita);
            let nombreCliente = 'Sin nombre';
            if (telefonoCita) {
                const cliente = await window.buscarCliente(telefonoCita);
                if (cliente && cliente.nombre) {
                    nombreCliente = cliente.nombre;
                } else {
                    // Fallback: usar nombre guardado en la cita (compatibilidad con datos antiguos)
                    nombreCliente = window.obtenerClienteNombreSync(cita);
                }
            } else {
                nombreCliente = window.obtenerClienteNombreSync(cita);
            }
            document.getElementById('editClientName').value = nombreCliente;
            
            // Teléfono: mostrar solo 8 dígitos (sin 506)
            const telefonoActual = window.obtenerTelefono(cita);
            const telefonoSin506 = telefonoActual && telefonoActual.startsWith('506') ? telefonoActual.substring(3) : (telefonoActual || '');
            document.getElementById('editClientPhone').value = telefonoSin506;
            
            // Actualizar display del teléfono
            const phoneDisplay = document.getElementById('editPhoneDisplay');
            if (phoneDisplay && telefonoActual) {
                phoneDisplay.textContent = window.formatearTelefono(telefonoActual);
            }
            
            // Generar link de WhatsApp
            const editWhatsApp = document.getElementById('editWhatsApp');
            if (editWhatsApp && telefonoActual) {
                editWhatsApp.value = window.generarLinkWhatsApp(telefonoActual, 'Hola desde Ecoplagas');
            }
            
            // Cargar sucursales del cliente
            if (telefonoActual) {
                const sucursalIndice = window.obtenerCampoCita(cita, 'sucursalIndice', null);
                await window.cargarSucursalesEnSelect('editSucursal', telefonoActual, sucursalIndice);
                
                // Si hay sucursal seleccionada, pre-llenar datos
                if (sucursalIndice) {
                    const sucursal = await window.obtenerSucursalPorIndice(telefonoActual, sucursalIndice);
                    if (sucursal) {
                        // Pre-llenar nombre de sucursal si existe
                        const editNombreSucursal = document.getElementById('editNombreSucursal');
                        if (editNombreSucursal) {
                            editNombreSucursal.value = sucursal.nombre;
                        }
                        // Pre-llenar coordenadas y ubicación
                        if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                            const coordsTexto = `${sucursal.coordenadas.lat}, ${sucursal.coordenadas.lng}`;
                            document.getElementById('editCoordenadas').value = coordsTexto;
                            if (window.procesarCoordenadasEdit) {
                                await window.procesarCoordenadasEdit(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
                            }
                        }
                        if (sucursal.provinciaId) document.getElementById('editProvincia').value = sucursal.provinciaId;
                        if (sucursal.cantonId) document.getElementById('editCanton').value = sucursal.cantonId;
                        if (sucursal.distritoId) document.getElementById('editDistrito').value = sucursal.distritoId;
                        if (sucursal.direccion) document.getElementById('editDireccion').value = sucursal.direccion;
                        if (sucursal.otras_senas || sucursal.otrasSenas) document.getElementById('editOtrasSenas').value = sucursal.otras_senas || sucursal.otrasSenas;
                    }
                }
            }
            if (window.actualizarVisibilidadBotonEditarSucursal) window.actualizarVisibilidadBotonEditarSucursal(true);
            
            const montoVenta = window.obtenerMonto(cita) || 0;
            const montoVentaFormateado = window.formatearMontoVenta(montoVenta);
            document.getElementById('editMontoVenta').value = montoVentaFormateado;
            
            // Método de Pago
            const metodoPago = window.obtenerCampoCita(cita, 'metodoPago', '') || '';
            const editMetodoPago = document.getElementById('editMetodoPago');
            if (editMetodoPago) {
                editMetodoPago.value = metodoPago;
            }
            
            // N° Factura
            const numeroFactura = window.obtenerCampoCita(cita, 'numeroFactura', '') || '';
            const editNumeroFactura = document.getElementById('editNumeroFactura');
            if (editNumeroFactura) {
                editNumeroFactura.value = numeroFactura;
            }
            
            // Ruta: incluir "Sin asignar" si aplica
            const rutaActual = window.obtenerRuta(cita);
            document.getElementById('editRuta').value = rutaActual || 'Sin asignar';
            
            // Confirmada 24-48h: cargar estado y habilitar slider solo si faltan < 48h
            const confirmada24_48 = window.obtenerConfirmada24_48 ? window.obtenerConfirmada24_48(cita) : { confirmada: false, timestamp: null };
            const editConfirmada = document.getElementById('editConfirmada24_48');
            const editConfirmadaMsg = document.getElementById('editConfirmada24_48Mensaje');
            const editConfirmadaTs = document.getElementById('editConfirmada24_48Timestamp');
            if (editConfirmada) {
                editConfirmada.checked = !!confirmada24_48.confirmada;
                const inicioCita = window.obtenerInicio ? window.obtenerInicio(cita) : null;
                const horas = window.horasHastaCita ? window.horasHastaCita(inicioCita) : Infinity;
                const dentro48h = horas > 0 && horas <= 48;
                editConfirmada.disabled = !dentro48h;
                if (editConfirmadaMsg) editConfirmadaMsg.textContent = dentro48h ? '' : 'Solo se puede activar cuando faltan menos de 48 horas para la cita.';
                if (editConfirmadaTs) {
                    if (confirmada24_48.timestamp) {
                        try {
                            const d = new Date(confirmada24_48.timestamp);
                            editConfirmadaTs.textContent = 'Confirmado el ' + (d.toLocaleDateString ? d.toLocaleDateString('es-CR') : d.toISOString().slice(0,10)) + ' a las ' + (d.toLocaleTimeString ? d.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' }) : d.toISOString().slice(11,16));
                            editConfirmadaTs.style.display = 'block';
                        } catch (e) { editConfirmadaTs.style.display = 'none'; }
                    } else { editConfirmadaTs.style.display = 'none'; }
                }
            }
            
            // Fecha y hora: convertir correctamente desde GMT-06
            const fechaInicio = window.formatearFecha(window.obtenerInicio(cita));
            if (fechaInicio) {
                // El timestamp ya está en GMT-06, solo necesitamos formatearlo para datetime-local
                const year = fechaInicio.getFullYear();
                const month = String(fechaInicio.getMonth() + 1).padStart(2, '0');
                const day = String(fechaInicio.getDate()).padStart(2, '0');
                const hours = String(fechaInicio.getHours()).padStart(2, '0');
                const minutes = String(fechaInicio.getMinutes()).padStart(2, '0');
                
                const fechaFormateada = `${year}-${month}-${day}T${hours}:${minutes}`;
                console.log('🔍 Fecha original (GMT-06):', window.obtenerInicio(cita));
                console.log('🔍 Fecha convertida (local):', fechaFormateada);
                document.getElementById('editStartTime').value = fechaFormateada;
            } else {
                // Si no hay fecha, usar la fecha actual
                const ahora = new Date();
                const year = ahora.getFullYear();
                const month = String(ahora.getMonth() + 1).padStart(2, '0');
                const day = String(ahora.getDate()).padStart(2, '0');
                const hours = String(ahora.getHours()).padStart(2, '0');
                const minutes = String(ahora.getMinutes()).padStart(2, '0');
                document.getElementById('editStartTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            // Duración: seleccionar la opción más cercana
            const duracionCita = window.obtenerDuracion(cita) || 60;
            const opcionesDuracion = [15, 30, 45, 60, 75, 90, 105, 120, 180, 240, 300, 360, 420, 480];
            let duracionSeleccionada = 60; // Valor por defecto
            // Encontrar la opción más cercana
            for (let i = 0; i < opcionesDuracion.length; i++) {
                if (duracionCita <= opcionesDuracion[i]) {
                    duracionSeleccionada = opcionesDuracion[i];
                    break;
                }
            }
            // Si es mayor a 480, usar 480
            if (duracionCita > 480) {
                duracionSeleccionada = 480;
            }
            document.getElementById('editDuration').value = duracionSeleccionada;
            
            // Calcular y mostrar hora de fin
            window.calcularHoraFin('edit');
            
            // Agregar event listeners para actualizar hora de fin automáticamente
            const editStartTimeInput = document.getElementById('editStartTime');
            const editDurationSelect = document.getElementById('editDuration');
            
            // Remover listeners anteriores si existen para evitar duplicados
            const newEditStartTimeHandler = () => {
                window.calcularHoraFin('edit');
                if (window.actualizarHabilitacionConfirmada24_48Edit) window.actualizarHabilitacionConfirmada24_48Edit();
            };
            const newEditDurationHandler = () => window.calcularHoraFin('edit');
            
            // Guardar referencias para poder removerlos después
            if (editStartTimeInput) {
                editStartTimeInput.removeEventListener('change', window._editStartTimeHandler);
                editStartTimeInput.removeEventListener('input', window._editStartTimeHandler);
                window._editStartTimeHandler = newEditStartTimeHandler;
                editStartTimeInput.addEventListener('change', window._editStartTimeHandler);
                editStartTimeInput.addEventListener('input', window._editStartTimeHandler);
            }
            
            if (editDurationSelect) {
                editDurationSelect.removeEventListener('change', window._editDurationHandler);
                window._editDurationHandler = newEditDurationHandler;
                editDurationSelect.addEventListener('change', window._editDurationHandler);
            }
            
            // Vendedores: cargar empleados y inicializar búsqueda
            if (!window.empleados || window.empleados.length === 0) {
                await window.cargarEmpleados();
            }
            const vendedores = window.obtenerVendedores(cita);
            window.vendedoresSeleccionadosEdit = Array.isArray(vendedores) ? [...vendedores] : [];
            // Renderizar badges de vendedores seleccionados
            const editVendedoresSelected = document.getElementById('editVendedoresSelected');
            if (editVendedoresSelected) {
                editVendedoresSelected.innerHTML = '';
                window.vendedoresSeleccionadosEdit.forEach(username => {
                    const empleado = window.empleados.find(e => (e.username || e.id) === username);
                    const nombre = empleado ? `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() : username;
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary me-1 mb-1';
                    badge.setAttribute('data-username', username);
                    badge.innerHTML = `${nombre} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
                    badge.querySelector('i').addEventListener('click', () => {
                        const index = window.vendedoresSeleccionadosEdit.indexOf(username);
                        if (index > -1) window.vendedoresSeleccionadosEdit.splice(index, 1);
                        badge.remove();
                    });
                    editVendedoresSelected.appendChild(badge);
                });
            }
            if (window.inicializarBusquedaVendedores) {
                window.inicializarBusquedaVendedores('edit');
            }
            
            // Servicios: cargar servicios y inicializar búsqueda
            if (!window.todosLosServicios || window.todosLosServicios.length === 0) {
                await window.cargarServicios();
            }
            let servicios = window.obtenerServicios(cita);
            // Fallback: si no hay servicios en metadata, intentar reconstruir desde detalle_cotizacion
            if ((!servicios || !Array.isArray(servicios) || servicios.length === 0) && window.todosLosServicios && window.todosLosServicios.length > 0) {
                const detalle = window.obtenerCampoCita(cita, 'detalle_cotizacion', null);
                if (detalle && detalle.servicios && Array.isArray(detalle.servicios)) {
                    servicios = detalle.servicios.map(s => {
                        const found = window.todosLosServicios.find(t => (t.nombre || '').trim() === (s.nombre || '').trim());
                        return found ? { id: found.id, cantidad: s.cantidad ?? 1, precio: s.precio ?? 0, comentarios: s.comentarios ?? '' } : null;
                    }).filter(Boolean);
                }
            }
            if (!Array.isArray(servicios)) servicios = [];
            // Convertir servicios a formato de objetos {id, precio, cantidad, comentarios}
            window.serviciosSeleccionadosEdit = servicios.map(serv => {
                if (typeof serv === 'string') {
                    // Es un ID simple, usar precio del servicio base
                    const servicio = window.todosLosServicios.find(s => s.id === serv);
                    return {
                        id: serv,
                        cantidad: 1,
                        precio: servicio?.precio || 0,
                        comentarios: ''
                    };
                } else if (typeof serv === 'object' && serv.id) {
                    // Ya es un objeto con id y posiblemente cantidad, precio y comentarios
                    const servicio = window.todosLosServicios.find(s => s.id === serv.id);
                    return {
                        id: serv.id,
                        cantidad: serv.cantidad !== undefined ? serv.cantidad : 1,
                        precio: serv.precio !== undefined ? serv.precio : (servicio?.precio || 0),
                        comentarios: serv.comentarios !== undefined ? serv.comentarios : ''
                    };
                }
                return null;
            }).filter(s => s !== null);
            
            // Renderizar tabla de servicios
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('edit');
            }
            // Precio total servicios: desde metadata para que el resumen cuadre al abrir
            const totalServiciosGuardado = window.obtenerCampoCita(cita, 'total_servicios', 0);
            const editPrecioTotalEl = document.getElementById('editPrecioTotalServicios');
            if (editPrecioTotalEl && (totalServiciosGuardado != null && totalServiciosGuardado !== undefined)) {
                editPrecioTotalEl.value = window.formatearMontoVenta ? window.formatearMontoVenta(totalServiciosGuardado) : String(totalServiciosGuardado);
            }
            if (window.inicializarBusquedaServicios) {
                window.inicializarBusquedaServicios('edit');
            }
            
            // Plagas: cargar plagas seleccionadas
            const plagas = window.obtenerCampoCita(cita, 'plagas', []) || [];
            // Convertir a formato de objetos {nombre, comentarios} si vienen como strings
            window.plagasSeleccionadasEdit = Array.isArray(plagas) ? plagas.map(p => {
                if (typeof p === 'string') {
                    return { nombre: p, comentarios: '' };
                }
                return { nombre: p.nombre || p, comentarios: p.comentarios || '' };
            }) : [];
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('edit');
            }
            
            // Productos: cargar productos y normalizar a { id, cantidad, precio }
            if (!window.todosLosProductos || window.todosLosProductos.length === 0) {
                await window.cargarProductos();
            }
            let productosRaw = window.obtenerProductos(cita);
            // Fallback: si no hay productos en metadata, intentar reconstruir desde detalle_cotizacion
            if ((!productosRaw || !Array.isArray(productosRaw) || productosRaw.length === 0) && window.todosLosProductos && window.todosLosProductos.length > 0) {
                const detalle = window.obtenerCampoCita(cita, 'detalle_cotizacion', null);
                if (detalle && detalle.productos && Array.isArray(detalle.productos)) {
                    productosRaw = detalle.productos.map(p => {
                        const found = window.todosLosProductos.find(t => (t.nombre || '').trim() === (p.nombre || '').trim());
                        return found ? { id: found.id, cantidad: p.cantidad ?? 1, precio: (p.costo_unitario ?? p.subtotal ?? 0) } : null;
                    }).filter(Boolean);
                }
            }
            if (!Array.isArray(productosRaw)) productosRaw = [];
            window.productosSeleccionadosEdit = productosRaw.map(item => {
                const id = typeof item === 'object' && item !== null ? item.id : item;
                const producto = window.todosLosProductos.find(p => p.id === id);
                const precioDefault = producto ? (producto.costo ?? producto.precio_venta ?? producto.precio ?? 0) : 0;
                return {
                    id,
                    cantidad: typeof item === 'object' && item !== null && item.cantidad !== undefined ? item.cantidad : 1,
                    precio: typeof item === 'object' && item !== null && item.precio !== undefined ? item.precio : precioDefault
                };
            });
            if (window.renderizarTablaProductos) {
                window.renderizarTablaProductos('edit');
            }
            if (window.inicializarBusquedaProductos) {
                window.inicializarBusquedaProductos('edit');
            }
            
            // Equipo: cargar equipo y inicializar búsqueda
            if (!window.todosLosEquipos || window.todosLosEquipos.length === 0) {
                await window.cargarEquipo();
            }
            const equipo = window.obtenerEquipo(cita);
            window.equipoSeleccionadoEdit = Array.isArray(equipo) ? [...equipo] : [];
            const editEquipoSelected = document.getElementById('editEquipoSelected');
            if (editEquipoSelected) {
                editEquipoSelected.innerHTML = '';
                window.equipoSeleccionadoEdit.forEach(equipoId => {
                    const equipoItem = window.todosLosEquipos.find(e => e.id === equipoId);
                    if (!equipoItem) return;
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-info me-1 mb-1';
                    badge.setAttribute('data-equipo-id', equipoId);
                    badge.innerHTML = `${equipoItem.nombre} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
                    badge.querySelector('i').addEventListener('click', () => {
                        const index = window.equipoSeleccionadoEdit.indexOf(equipoId);
                        if (index > -1) window.equipoSeleccionadoEdit.splice(index, 1);
                        badge.remove();
                    });
                    editEquipoSelected.appendChild(badge);
                });
            }
            if (window.inicializarBusquedaEquipo) {
                window.inicializarBusquedaEquipo('edit');
            }
            
            // Certificados: cargar texto de certificados
            const certificadosTexto = window.obtenerCampoCita(cita, 'certificados', '');
            const editCertificados = document.getElementById('editCertificados');
            if (editCertificados) {
                editCertificados.value = certificadosTexto;
            }
            
            // Ubicación: cargar ubicaciones si no están cargadas
            if (!window.ubicacionesCR) {
                await cargarUbicaciones();
            }
            
            // Cargar dirección (link de Waze/Google Maps)
            const direccionLink = window.obtenerCampoCita(cita, 'direccion', '') || '';
            document.getElementById('editDireccion').value = direccionLink || '';
            
            // Cargar coordenadas
            // Primero intentar obtener desde sucursal, luego fallback para citas antiguas
            let coordenadas = null;
            const sucursalIndice = window.obtenerCampoCita(cita, 'sucursalIndice', null);
            // Obtener teléfono desde la fuente de verdad (cita.telefono)
            const clienteTelefono = window.obtenerTelefono(cita);
            
            // Si hay sucursal, obtener coordenadas desde la sucursal (source of truth)
            if (window.esSucursalIndiceValido(sucursalIndice) && clienteTelefono) {
                try {
                    const sucursal = await window.obtenerSucursalPorIndice(clienteTelefono, sucursalIndice);
                    if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                        coordenadas = sucursal.coordenadas;
                    }
                } catch (error) {
                    console.warn('Error obteniendo coordenadas desde sucursal:', error);
                }
            }
            
            // Fallback para citas antiguas que aún tienen coordenadas en metadata (compatibilidad)
            if (!coordenadas) {
                const coords = window.obtenerCampoCita(cita, 'coordenadas', null);
                if (window.sonCoordenadasValidas(coords)) coordenadas = coords;
            }
            
            let lat = null;
            let lng = null;
            if (coordenadas && coordenadas.texto) {
                document.getElementById('editCoordenadas').value = coordenadas.texto;
                // Parsear coordenadas del texto
                const match = coordenadas.texto.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                if (match) {
                    lat = parseFloat(match[1]);
                    lng = parseFloat(match[2]);
                }
            } else if (window.sonCoordenadasValidas(coordenadas)) {
                lat = coordenadas.lat;
                lng = coordenadas.lng;
                document.getElementById('editCoordenadas').value = `${lat}, ${lng}`;
            } else {
                document.getElementById('editCoordenadas').value = '';
            }
            
            // Cargar otras señas (estándar otras_senas; legacy otras_señas en obtenerCampoCita)
            document.getElementById('editOtrasSenas').value = window.obtenerCampoCita(cita, 'otras_senas', '') || '';
            
            // Si la cita tiene datos de ubicación estructurados, cargarlos
            // Esto asume que la cita puede tener: provinciaId, cantonId, distritoId
            // o que la dirección contiene la información parseable
            const provinciaId = window.obtenerCampoCita(cita, 'provinciaId', null);
            const cantonId = window.obtenerCampoCita(cita, 'cantonId', null);
            const distritoId = window.obtenerCampoCita(cita, 'distritoId', null);
            
            // Si hay coordenadas, procesarlas para renderizar el mapa
            if (lat && lng) {
                // Función para procesar coordenadas después de que el modal esté visible y el mapa inicializado
                const procesarCoordenadasCuandoListo = () => {
                    const intentarProcesar = (intentos = 0) => {
                        if (intentos > 20) {
                            console.warn('⚠️ No se pudo procesar coordenadas después de varios intentos');
                            return;
                        }
                        
                        // Verificar que el mapa esté inicializado
                        if (!window.mapaUbicacionEdit || typeof window.mapaUbicacionEdit.setView !== 'function') {
                            setTimeout(() => intentarProcesar(intentos + 1), 300);
                            return;
                        }
                        
                        // Procesar coordenadas para renderizar mapa
                        if (window.procesarCoordenadasEdit && typeof window.procesarCoordenadasEdit === 'function') {
                            window.procesarCoordenadasEdit(lat, lng).then(() => {
                                console.log('✅ Coordenadas procesadas y mapa renderizado');
                            }).catch(error => {
                                console.error('❌ Error procesando coordenadas:', error);
                            });
                        } else {
                            console.warn('⚠️ Función procesarCoordenadasEdit no está disponible');
                        }
                    };
                    
                    // Esperar a que el modal esté completamente visible
                    const modal = document.getElementById('editCitaModal');
                    if (modal) {
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance && modalInstance._isShown) {
                            // El modal ya está visible, esperar un momento para que el mapa se inicialice
                            setTimeout(() => intentarProcesar(), 1000);
                        } else {
                            // Esperar a que el modal se muestre
                            modal.addEventListener('shown.bs.modal', function procesarCoordsOnShow() {
                                modal.removeEventListener('shown.bs.modal', procesarCoordsOnShow);
                                // Esperar más tiempo para que el mapa se inicialice completamente
                                setTimeout(() => intentarProcesar(), 1000);
                            }, { once: true });
                        }
                    }
                };
                
                procesarCoordenadasCuandoListo();
            }
            
       // Función para actualizar el mapa después de que el modal esté visible
       const actualizarMapaCuandoVisible = () => {
           // Función auxiliar para verificar y actualizar el mapa
           const intentarActualizarMapa = (intentos = 0) => {
               if (intentos > 20) {
                   console.warn('⚠️ No se pudo inicializar el mapa después de varios intentos');
                   return;
               }
               
               // Verificar que el mapa esté inicializado y sea válido (usar variable local)
               if (!mapaUbicacionEdit || typeof mapaUbicacionEdit.setView !== 'function' || typeof mapaUbicacionEdit.invalidateSize !== 'function') {
                   console.log(`⚠️ Mapa no listo (intento ${intentos + 1}/20), esperando...`, {
                       tieneMapa: !!mapaUbicacionEdit,
                       tipo: typeof mapaUbicacionEdit,
                       tieneSetView: mapaUbicacionEdit ? typeof mapaUbicacionEdit.setView : 'N/A'
                   });
                   setTimeout(() => intentarActualizarMapa(intentos + 1), 300);
                   return;
               }
               
               // El mapa está listo, mostrar polígonos según la selección
               console.log('✅ Mapa listo, mostrando polígonos...', { provinciaId, cantonId, distritoId });
               if (provinciaId && cantonId && distritoId) {
                   if (window.mostrarDistritoSeleccionado) {
                       window.mostrarDistritoSeleccionado(provinciaId, cantonId, distritoId);
                   }
               } else if (provinciaId && cantonId) {
                   if (window.mostrarDistritosCanton) {
                       window.mostrarDistritosCanton(provinciaId, cantonId);
                   }
               } else if (provinciaId) {
                   if (window.mostrarCantonesProvincia) {
                       window.mostrarCantonesProvincia(provinciaId);
                   }
               }
           };
           
           // Esperar a que el modal esté completamente visible
           const modal = document.getElementById('editCitaModal');
           if (modal) {
               const modalInstance = bootstrap.Modal.getInstance(modal);
               if (modalInstance && modalInstance._isShown) {
                   // El modal ya está visible, esperar más tiempo para que el mapa se inicialice
                   setTimeout(() => intentarActualizarMapa(), 800);
               } else {
                   // Esperar a que el modal se muestre
                   modal.addEventListener('shown.bs.modal', function actualizarMapaOnShow() {
                       modal.removeEventListener('shown.bs.modal', actualizarMapaOnShow);
                       // Esperar más tiempo para que el mapa se inicialice completamente
                       setTimeout(() => intentarActualizarMapa(), 800);
                   }, { once: true });
               }
           }
       };
            
            if (provinciaId && window.ubicacionesCR) {
                document.getElementById('editProvincia').value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                if (cantonId) {
                    // Esperar un momento para que se carguen los cantones
                    setTimeout(() => {
                        document.getElementById('editCanton').value = cantonId;
                        llenarDistritosEdit(provinciaId, cantonId);
                        
                        if (distritoId) {
                            setTimeout(() => {
                                document.getElementById('editDistrito').value = distritoId;
                                // Actualizar mapa después de cargar todos los valores
                                actualizarMapaCuandoVisible();
                            }, 150);
                        } else {
                            actualizarMapaCuandoVisible();
                        }
                    }, 150);
                } else {
                    actualizarMapaCuandoVisible();
                }
            } else if (provinciaId) {
                // Si hay provincia pero no hay ubicacionesCR cargadas, esperar
                console.log('⚠️ Ubicaciones CR no cargadas aún, esperando...');
                const checkUbicaciones = setInterval(() => {
                    if (window.ubicacionesCR) {
                        clearInterval(checkUbicaciones);
                        document.getElementById('editProvincia').value = provinciaId;
                        llenarCantonesEdit(provinciaId);
                        if (cantonId) {
                            setTimeout(() => {
                                document.getElementById('editCanton').value = cantonId;
                                llenarDistritosEdit(provinciaId, cantonId);
                                if (distritoId) {
                                    setTimeout(() => {
                                        document.getElementById('editDistrito').value = distritoId;
                                        actualizarMapaCuandoVisible();
                                    }, 150);
                                } else {
                                    actualizarMapaCuandoVisible();
                                }
                            }, 150);
                        } else {
                            actualizarMapaCuandoVisible();
                        }
                    }
                }, 100);
                // Timeout después de 5 segundos
                setTimeout(() => clearInterval(checkUbicaciones), 5000);
            }
            
            // Agregar event listeners para actualizar resumen financiero
            const serviciosContainer = document.getElementById('editServiciosContainer');
            if (serviciosContainer) {
                serviciosContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        window.actualizarResumenFinanciero();
                    }
                });
            }
            
            const montoVentaInput = document.getElementById('editMontoVenta');
            if (montoVentaInput) {
                // Detectar cuando el usuario empieza a editar manualmente
                montoVentaInput.addEventListener('focus', () => {
                    // No activar el flag todavía, solo cuando presione Enter
                });
                
                // Detectar cuando el usuario presiona Enter para confirmar valor manual
                montoVentaInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Activar modo manual y formatear el valor
                        const valorNumerico = window.extraerValorNumerico(montoVentaInput.value);
                        if (valorNumerico !== null && !isNaN(valorNumerico)) {
                            montoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                            window.editandoMontoVentaManual.edit = true;
                            // Actualizar resumen financiero con el valor manual
                            window.actualizarResumenFinanciero();
                        }
                        montoVentaInput.blur(); // Quitar el foco del campo
                    }
                });
                
                // Detectar cuando el usuario termina de editar (sin Enter)
                montoVentaInput.addEventListener('blur', () => {
                    // Si no se presionó Enter, volver a modo automático
                    if (!window.editandoMontoVentaManual.edit) {
                        // Formatear el valor al perder el foco
                        const valorNumerico = window.extraerValorNumerico(montoVentaInput.value);
                        if (valorNumerico !== '') {
                            montoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                        }
                        // Recalcular automáticamente
                        window.calcularMontoVenta('edit');
                        window.actualizarResumenFinanciero();
                    } else {
                        // Si se presionó Enter, solo formatear sin recalcular
                        const valorNumerico = window.extraerValorNumerico(montoVentaInput.value);
                        if (valorNumerico !== '') {
                            montoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                        }
                        window.actualizarResumenFinanciero();
                    }
                });
                
                // Formatear cuando se presiona Enter o se pierde el foco
                montoVentaInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const valorNumerico = window.extraerValorNumerico(montoVentaInput.value);
                        montoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                        montoVentaInput.blur();
                    }
                });
                // El blur ya está manejado arriba
                montoVentaInput.addEventListener('input', () => {
                    window.actualizarResumenFinanciero();
                });
            }
            
            // Actualizar resumen financiero inicial
            setTimeout(() => {
                window.actualizarResumenFinanciero();
            }, 100);
            
            // Obtener descripción/observaciones
            const descripcion = window.obtenerDescripcion(cita);
            console.log('🔍 Descripción obtenida:', descripcion);
            console.log('🔍 Cita completa:', cita);
            console.log('🔍 metadata:', cita.metadata);
            console.log('🔍 metadata.observaciones:', window.obtenerCampoCita(cita, 'observaciones', ''));
            document.getElementById('editDescription').value = descripcion || '';

            // Mostrar u ocultar botón "Ver resultado encuesta" según si la cita ya tiene encuesta respondida
            const btnVerResultadoEncuestaEdit = document.getElementById('btnVerResultadoEncuesta');
            if (btnVerResultadoEncuestaEdit) {
                const estadoEnc = typeof window.obtenerEstadoEncuesta === 'function' ? window.obtenerEstadoEncuesta(cita) : 0;
                btnVerResultadoEncuestaEdit.style.display = estadoEnc === 2 ? '' : 'none';
            }

            // Resetear botón antes de abrir modal
            const btnSave = document.getElementById('btnSaveCitaTop');
            if (btnSave) {
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fas fa-save me-1"></i>Guardar';
                console.log('🔧 Botón reseteado al abrir modal');
            }

            // Mostrar el modal
            console.log('🔍 ===== INTENTANDO ABRIR MODAL =====');
            console.log('🔍 Elemento modal existe:', !!document.getElementById('editCitaModal'));
            console.log('🔍 Bootstrap disponible:', typeof bootstrap !== 'undefined');
            
            const modalElement = document.getElementById('editCitaModal');
            console.log('🔍 Modal element:', modalElement);
            console.log('🔍 Modal classes:', modalElement ? modalElement.className : 'No encontrado');
            
            try {
                // Obtener o crear instancia del modal
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                }
                
                // Asegurar que el modal esté configurado correctamente
                modalElement.setAttribute('aria-hidden', 'false');
                modalElement.removeAttribute('aria-modal');
                
                // Mostrar el modal
                modal.show();
                console.log('✅ Modal.show() ejecutado');
                
                // Esperar a que el modal se muestre completamente
                modalElement.addEventListener('shown.bs.modal', function onModalShown() {
                    modalElement.removeEventListener('shown.bs.modal', onModalShown);
                    console.log('✅ Modal completamente visible');
                    // Asegurar que aria-hidden esté en false
                    modalElement.setAttribute('aria-hidden', 'false');
                }, { once: true });
                
                // Verificar si el modal se abrió
                setTimeout(() => {
                    console.log('🔍 Modal visible después de 100ms:', modalElement.classList.contains('show'));
                    console.log('🔍 Modal display style:', window.getComputedStyle(modalElement).display);
                    console.log('🔍 Modal aria-hidden:', modalElement.getAttribute('aria-hidden'));
                }, 100);
                
            } catch (error) {
                console.error('❌ Error al abrir modal:', error);
                // Fallback: mostrar el modal manualmente
                modalElement.classList.add('show');
                modalElement.style.display = 'block';
                modalElement.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            console.log('🔍 ===== FIN abrirModalEdicion =====');
        }

        // Función de prueba para verificar event listeners
        function testClick() {
            console.log('Click detectado!');
            alert('Click funcionando correctamente');
        }

        // Event delegation para manejar clicks en elementos dinámicos
        document.addEventListener('click', function(event) {
            // Solo loggear clicks en elementos de cita para no saturar la consola
            if (event.target.closest('.cita-item-dia') || event.target.closest('.cita-bloque') || event.target.closest('.cita-item')) {
                console.log('🔍 Click detectado en elemento de cita:', event.target);
                console.log('🔍 Clase del elemento:', event.target.className);
                
                const citaElement = event.target.closest('.cita-item-dia') || event.target.closest('.cita-bloque') || event.target.closest('.cita-item');
                console.log('🎯 Elemento cita:', citaElement);
                
                // Buscar el ID de la cita en el elemento
                const citaId = citaElement.getAttribute('data-cita-id');
                console.log('🎯 ID de cita encontrado:', citaId);
                
                if (citaId) {
                    console.log('🎯 Llamando abrirModalEdicion con ID:', citaId);
                    abrirModalEdicion(citaId);
                } else {
                    console.error('❌ No se encontró data-cita-id en el elemento');
                }
            }
        });
    </script>

    <!-- Sistema de Autenticación Seguro ya cargado en el head -->
    
    <!-- Firebase SDK -->
    <script>
        // Log inmediato fuera del módulo para verificar que el script se carga
        console.log('🔍 [CALENDARIO] Script HTML cargado - ANTES del módulo');
    </script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        console.log('🔍 [CALENDARIO] Script iniciando...');
        import { getFirestore, collection, getDocs, getDoc, query, orderBy, doc, updateDoc, deleteDoc, addDoc, setDoc, Timestamp, serverTimestamp, where, limit } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        console.log('🔍 [CALENDARIO] Imports cargados');
        import { getStorage, ref, getDownloadURL, getBytes } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
        
        // Hacer setDoc disponible globalmente
        window.setDoc = setDoc;
        
        // Hacer funciones disponibles globalmente
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.serverTimestamp = serverTimestamp;
        
        console.log('🔍 Iniciando carga de Firebase...');
        
        try {
            console.log('✅ Firebase modules cargados correctamente');

            // Configuración de Firebase
            const firebaseConfig = {
                projectId: "cursorwebapp-f376d",
                appId: "1:719990096116:web:07c1ff697e7655b2cd9ea1",
                databaseURL: "https://cursorwebapp-f376d-default-rtdb.firebaseio.com",
                storageBucket: "cursorwebapp-f376d.firebasestorage.app",
                apiKey: "AIzaSyC-IQj0yHR8cELr-mw-v2xlnw6LlJYFUyk",
                authDomain: "cursorwebapp-f376d.firebaseapp.com",
                messagingSenderId: "719990096116",
                measurementId: "G-DJXLKFR7CD"
            };

            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const storage = getStorage(app);
            
            // Asignar a variables globales
            window.db = db;
            window.storage = storage;
            window.todasLasCitas = window.todasLasCitas || [];
            window.citasFiltradas = window.citasFiltradas || [];
            window.currentDate = window.currentDate || new Date();
            window.diaSeleccionado = window.diaSeleccionado || new Date();
            window.vistaActual = window.vistaActual || 'cronograma';
            window.selectedCita = window.selectedCita || null;
            
            // Asegurar que formatearFecha esté disponible
            if (!window.formatearFecha) {
                window.formatearFecha = function(timestamp) {
                    if (!timestamp) return null;
                    const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return fecha;
                };
            }
            
            console.log('✅ Firebase inicializado correctamente');
            console.log('✅ Variables globales asignadas');

            // Elementos del DOM
        const calendarGrid = document.getElementById('calendarGrid');
        const datePicker = document.getElementById('datePicker');
        const vehicleFilter = document.getElementById('vehicleFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        // Elementos de navegación del calendario
        
        // Elementos de vista de día
        const vistaDia = document.getElementById('vistaDia');
        const vistaDiaTitulo = document.getElementById('vistaDiaTitulo');
        const vehiculosGrid = document.getElementById('vehiculosGrid');
        const btnPrevDay = document.getElementById('btnPrevDay');
        const btnNextDay = document.getElementById('btnNextDay');
        
        // Elementos de vista de cronograma
        const vistaCronograma = document.getElementById('vistaCronograma');
        const vistaCronogramaTitulo = document.getElementById('vistaCronogramaTitulo');
        const cronogramaContainer = document.getElementById('cronogramaContainer');
        const ejeHoras = document.getElementById('ejeHoras');
        const vehiculosCronograma = document.getElementById('vehiculosCronograma');
        // const btnVistaCronograma = document.getElementById('btnVistaCronograma'); // ELIMINADO
        const btnPrevDayCronograma = document.getElementById('btnPrevDayCronograma');
        const btnNextDayCronograma = document.getElementById('btnNextDayCronograma');
        
        // Función auxiliar para formatear fecha a YYYY-MM-DD en zona horaria local
        function formatearFechaParaInput(fecha) {
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const day = String(fecha.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Función para formatear montos grandes (220k, 300k, 1M, etc.)
        function formatearMontoGrande(monto) {
            if (!monto || monto === 0) {
                return '0';
            }
            if (monto >= 1000000) {
                const millones = (monto / 1000000).toFixed(1);
                return millones.endsWith('.0') ? millones.replace('.0', '') + 'M' : millones + 'M';
            } else if (monto >= 1000) {
                const miles = (monto / 1000).toFixed(0);
                return miles + 'k';
            }
            return monto.toString();
        }
        
        // Función para calcular ventas totales de un día
        // opts: { excluirRuta20: true } = no contar Ruta 20 (cancelaciones); { soloRuta20: true } = solo Ruta 20
        function calcularVentasDia(year, month, day, opts) {
            if (!window.todasLasCitas || window.todasLasCitas.length === 0) {
                return 0;
            }
            const excluirRuta20 = opts && opts.excluirRuta20;
            const soloRuta20 = opts && opts.soloRuta20;
            
            let totalVentas = 0;
            window.todasLasCitas.forEach(cita => {
                if (!window.obtenerInicio) return;
                const ruta = window.obtenerRuta ? window.obtenerRuta(cita) : '';
                if (excluirRuta20 && ruta === 'Ruta 20') return;
                if (soloRuta20 && ruta !== 'Ruta 20') return;
                
                const inicioCita = window.obtenerInicio(cita);
                if (!inicioCita) return;
                
                const fechaCita = window.formatearFecha(inicioCita);
                if (!fechaCita) return;
                
                if (fechaCita.getFullYear() === year &&
                    fechaCita.getMonth() === month &&
                    fechaCita.getDate() === day) {
                    const monto = window.obtenerMonto(cita) || 0;
                    totalVentas += monto;
                }
            });
            
            return totalVentas;
        }
        
        // Feriados de Costa Rica (año-mes-día) – misma fuente que solicitud de vacaciones
        const FERIADOS_CR = [
            '2025-01-01', '2025-04-11', '2025-04-17', '2025-04-18', '2025-05-01',
            '2025-07-25', '2025-08-02', '2025-08-15', '2025-08-31', '2025-09-15',
            '2025-12-01', '2025-12-25',
            '2026-01-01', '2026-04-02', '2026-04-03', '2026-04-11', '2026-05-01',
            '2026-07-25', '2026-08-02', '2026-08-15', '2026-08-31', '2026-09-15',
            '2026-12-01', '2026-12-25',
            '2027-01-01', '2027-04-01', '2027-04-02', '2027-04-11', '2027-05-01',
            '2027-07-25', '2027-08-02', '2027-08-15', '2027-08-31', '2027-09-15',
            '2027-12-01', '2027-12-25'
        ];
        function esFeriadoCR(fechaStr) { return FERIADOS_CR.includes(fechaStr); }
        const META_POR_DIA_DEFAULT_M = 1.7; // 1.7M por día hábil si no hay parámetro guardado
        window.metaMensual = null; // meta del mes en colones (parametros_globales/calendario). null = usar default 1.7M/día
        
        // Cargar parámetro meta mensual desde Firestore
        window.cargarMetaMensual = async function() {
            if (!window.db) return;
            try {
                const refDoc = doc(window.db, 'parametros_globales', 'calendario');
                const snap = await getDoc(refDoc);
                if (snap.exists() && snap.data().meta_mensual != null) {
                    const v = Number(snap.data().meta_mensual);
                    if (!isNaN(v) && v >= 0) window.metaMensual = v;
                } else {
                    window.metaMensual = null;
                }
            } catch (e) { console.warn('No se pudo cargar meta_mensual:', e); window.metaMensual = null; }
        };
        // Guardar parámetro meta mensual en Firestore
        window.guardarMetaMensual = async function(valorEnMillones) {
            const num = parseFloat(String(valorEnMillones).replace(',', '.'));
            if (isNaN(num) || num < 0) return false;
            const valor = Math.round(num * 1000000);
            if (!window.db) return false;
            try {
                const refDoc = doc(window.db, 'parametros_globales', 'calendario');
                await setDoc(refDoc, { meta_mensual: valor, fecha_actualizacion: serverTimestamp() }, { merge: true });
                window.metaMensual = valor;
                return true;
            } catch (e) {
                console.error('Error guardando meta_mensual:', e);
                return false;
            }
        };
        
        // Función para generar botones de días del mes
        async function generarBotonesDiasMes(fecha) {
            await window.cargarMetaMensual();
            const container = document.getElementById('datePickerContainer');
            const dayBarsRow = document.getElementById('dayBarsRow');
            const dayBarsAxis = document.getElementById('dayBarsAxis');
            const dayBarsResumen = document.getElementById('dayBarsResumen');
            const inputMetaMesM = document.getElementById('inputMetaMesM');
            if (!container) return;
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const diasSemana = ['DOM', 'LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB'];
            const meses = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            
            const year = fecha.getFullYear();
            const month = fecha.getMonth();
            const diasEnMes = new Date(year, month + 1, 0).getDate();
            let diasAMostrar = [];
            for (let dia = 1; dia <= diasEnMes; dia++) {
                diasAMostrar.push(new Date(year, month, dia));
            }
            
            // Días hábiles del mes (excluir domingos y feriados)
            const diasHabilesMes = diasAMostrar.filter(fd => fd.getDay() !== 0 && !esFeriadoCR(formatearFechaParaInput(fd))).length;
            const metaPorDiaHabil = window.metaMensual != null && diasHabilesMes > 0
                ? window.metaMensual / diasHabilesMes
                : META_POR_DIA_DEFAULT_M * 1000000;
            const totalMetaMes = window.metaMensual != null ? window.metaMensual : (META_POR_DIA_DEFAULT_M * 1000000 * diasHabilesMes);
            
            const ventasPorDia = diasAMostrar.map(fechaDia => {
                const y = fechaDia.getFullYear(), m = fechaDia.getMonth(), d = fechaDia.getDate();
                return calcularVentasDia(y, m, d, { excluirRuta20: true });
            });
            const metasPorDia = diasAMostrar.map(fechaDia => {
                const fechaStr = formatearFechaParaInput(fechaDia);
                const esDomingo = fechaDia.getDay() === 0;
                if (esDomingo || esFeriadoCR(fechaStr)) return 0;
                return metaPorDiaHabil;
            });
            const totalVentasMes = ventasPorDia.reduce((s, v) => s + (v || 0), 0);
            
            const maxVentasMes = ventasPorDia.length ? Math.max(...ventasPorDia) : 0;
            const escalaMax = Math.max(3000000, maxVentasMes);
            const labelEjeMax = escalaMax >= 1000000 ? (escalaMax / 1000000).toFixed(1).replace(/\.0$/, '') + 'M' : (escalaMax / 1000).toFixed(0) + 'k';
            const pctMetaEnEscala = escalaMax > 0 ? (metaPorDiaHabil / escalaMax) * 100 : 0;
            
            if (dayBarsAxis) {
                dayBarsAxis.innerHTML = '<span>0</span><span>' + labelEjeMax + '</span>';
            }
            if (dayBarsRow) {
                // Línea punteada de meta por día: SOLO días hábiles (meta 1.8M). Domingo (getDay()===0) y feriado = sin línea.
                const barsWrapStyle = 'position: relative; z-index: 1; flex: 1; min-width: 0; display: flex; flex-wrap: nowrap; gap: 3px; align-items: flex-end; height: 100%;';
                const barsHtml = ventasPorDia.map((ventasDia, i) => {
                    const fechaDia = diasAMostrar[i];
                    const fechaString = formatearFechaParaInput(fechaDia);
                    const esDomingo = fechaDia.getDay() === 0;
                    const esFeriado = esFeriadoCR(fechaString);
                    const esHabil = !esDomingo && !esFeriado;
                    const metaDia = metasPorDia[i];
                    const pctMeta = esHabil && escalaMax > 0 ? Math.min(100, (metaPorDiaHabil / escalaMax) * 100) : 0;
                    const pct = escalaMax > 0 ? Math.min(100, (ventasDia / escalaMax) * 100) : 0;
                    const ventasFormateadasBar = ((ventasDia || 0) / 1000000).toFixed(1) + 'M';
                    const titulo = '₡' + (ventasDia || 0).toLocaleString('es-CR');
                    const metaLineInCell = esHabil && pctMeta > 0 ? '<div class="day-bar-meta-line" style="position: absolute; left: 0; right: 0; bottom: 0; height: ' + pctMeta + '%; border-top: 2px dashed #000; pointer-events: none; z-index: 0;"></div>' : '';
                    return '<div class="day-bar-cell' + (esHabil ? '' : ' day-bar-cell-sin-meta') + '" title="' + titulo.replace(/"/g, '&quot;') + '" data-fecha="' + fechaString + '" style="position: relative; min-width: 44px; max-width: 52px; flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%;">' + metaLineInCell + '<span style="font-size: 0.5rem; font-weight: 600; color: #333; margin-bottom: 2px; line-height: 1; white-space: nowrap; position: relative; z-index: 1;">' + ventasFormateadasBar + '</span><div style="flex: 1; width: 100%; min-height: 0; display: flex; align-items: flex-end; justify-content: center; position: relative; z-index: 1;"><div style="width: 85%; height: ' + (pct || 4) + '%; min-height: 4px; border-radius: 3px; background: linear-gradient(to top, #2e7d32, #4CAF50); transition: height 0.2s;"></div></div></div>';
                }).join('');
                dayBarsRow.innerHTML = '<div style="' + barsWrapStyle + '">' + barsHtml + '</div>';
            }
            if (dayBarsResumen) {
                const fmtMiles = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                const ventasStr = fmtMiles(totalVentasMes);
                const metaStr = fmtMiles(totalMetaMes);
                const pctAvance = totalMetaMes > 0 ? Math.round((totalVentasMes / totalMetaMes) * 100) : 0;
                dayBarsResumen.textContent = 'Ventas: ' + ventasStr + '  Meta: ' + metaStr + '  % de avance: ' + pctAvance + '%';
            }
            window.ventasPorDiaMes = { dias: diasAMostrar, ventas: ventasPorDia };
            const btnCopiarVentasMes = document.getElementById('btnCopiarVentasMes');
            if (btnCopiarVentasMes && !btnCopiarVentasMes._copyListener) {
                btnCopiarVentasMes._copyListener = true;
                btnCopiarVentasMes.addEventListener('click', async function() {
                    const data = window.ventasPorDiaMes;
                    if (!data || !data.dias || !data.ventas) return;
                    // TSV (tabulaciones) para pegar directo en Excel: cada columna se separa correctamente
                    const lineas = ['fecha\tventas EO'];
                    data.dias.forEach((fechaDia, i) => {
                        const fechaStr = formatearFechaParaInput(fechaDia);
                        const ventasDia = Math.round(data.ventas[i] || 0);
                        lineas.push(fechaStr + '\t' + ventasDia);
                    });
                    const texto = lineas.join('\n');
                    try {
                        await navigator.clipboard.writeText(texto);
                        const orig = btnCopiarVentasMes.innerHTML;
                        btnCopiarVentasMes.innerHTML = '<i class="fas fa-check"></i> Copiado';
                        setTimeout(() => { btnCopiarVentasMes.innerHTML = orig; }, 1500);
                    } catch (e) {
                        console.warn('Clipboard:', e);
                        alert('No se pudo copiar. Comprueba los permisos del navegador.');
                    }
                });
            }
            const btnDescargarCSVMes = document.getElementById('btnDescargarCSVMes');
            if (btnDescargarCSVMes && !btnDescargarCSVMes._csvListener) {
                btnDescargarCSVMes._csvListener = true;
                btnDescargarCSVMes.addEventListener('click', function() {
                    if (typeof window.descargarCSVAgendaMesFirebase === 'function') {
                        window.descargarCSVAgendaMesFirebase(fecha);
                    }
                });
            }
            if (inputMetaMesM) {
                inputMetaMesM.value = (totalMetaMes / 1000000).toFixed(1);
                if (!inputMetaMesM._metaListener) {
                    inputMetaMesM._metaListener = true;
                    const aplicarMeta = async () => {
                        const ok = await window.guardarMetaMensual(inputMetaMesM.value);
                        if (ok && typeof generarBotonesDiasMes === 'function') await generarBotonesDiasMes(fecha);
                    };
                    inputMetaMesM.addEventListener('blur', aplicarMeta);
                    inputMetaMesM.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); inputMetaMesM.blur(); } });
                }
            }
            
            // Gráfico ventas por vendedor (mes): monto total cita / cantidad vendedores = atribuible por vendedor; sumar por vendedor
            const dayBarsVendedores = document.getElementById('dayBarsVendedores');
            if (dayBarsVendedores && window.todasLasCitas && window.todasLasCitas.length > 0) {
                const ventasPorVendedor = {};
                window.todasLasCitas.forEach(cita => {
                    if (window.obtenerRuta && window.obtenerRuta(cita) === 'Ruta 20') return;
                    const inicioCita = window.obtenerInicio && window.obtenerInicio(cita);
                    if (!inicioCita) return;
                    const fechaCita = window.formatearFecha && window.formatearFecha(inicioCita);
                    if (!fechaCita || fechaCita.getFullYear() !== year || fechaCita.getMonth() !== month) return;
                    const monto = (window.obtenerMonto && window.obtenerMonto(cita)) || 0;
                    let vendedores = (window.obtenerVendedores && window.obtenerVendedores(cita)) || [];
                    if (!Array.isArray(vendedores)) vendedores = [];
                    if (vendedores.length === 0) vendedores = ['Sin vendedor'];
                    const atribuible = monto / vendedores.length;
                    vendedores.forEach(v => {
                        const key = (v && String(v).trim()) || 'Sin vendedor';
                        ventasPorVendedor[key] = (ventasPorVendedor[key] || 0) + atribuible;
                    });
                });
                const entradas = Object.entries(ventasPorVendedor).sort((a, b) => b[1] - a[1]);
                const maxVendedor = entradas.length ? Math.max(...entradas.map(e => e[1]), 1) : 1;
                const fmtMilesV = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                const nombreStyle = 'width: 140px; min-width: 140px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
                const barraWrapStyle = 'flex: 1; min-width: 48px; height: 14px; background: #e0e0e0; border-radius: 3px; overflow: hidden;';
                const renderFilaVendedor = (nombre, total, barColor) => {
                    const pct = maxVendedor > 0 ? Math.min(100, (total / maxVendedor) * 100) : 0;
                    return '<div style="display: flex; align-items: center; gap: 6px; font-size: 0.6rem; min-width: 0; width: 100%;"><span style="' + nombreStyle + '" title="' + nombre.replace(/"/g, '&quot;') + '">' + nombre + '</span><div style="' + barraWrapStyle + '"><div style="height: 100%; width: ' + pct + '%; min-width: ' + (total > 0 ? 2 : 0) + 'px; border-radius: 3px; background: ' + barColor + ';"></div></div><span style="font-weight: 600; white-space: nowrap; flex-shrink: 0;">₡' + fmtMilesV(total) + '</span></div>';
                };
                if (entradas.length === 0) {
                    dayBarsVendedores.innerHTML = '<span style="font-size: 0.6rem; color: #888;">Sin datos</span>';
                } else {
                    const mitad = Math.ceil(entradas.length / 2);
                    const col1 = entradas.slice(0, mitad);
                    const col2 = entradas.slice(mitad);
                    const col1Html = col1.map(([nombre, total]) => renderFilaVendedor(nombre, total, 'linear-gradient(to right, #2e7d32, #4CAF50)')).join('');
                    const col2Html = col2.map(([nombre, total]) => renderFilaVendedor(nombre, total, 'linear-gradient(to right, #2e7d32, #4CAF50)')).join('');
                    dayBarsVendedores.innerHTML = '<div style="display: flex; flex-direction: column; gap: 4px; min-width: 0;">' + col1Html + '</div><div style="display: flex; flex-direction: column; gap: 4px; min-width: 0;">' + col2Html + '</div>';
                }
            } else if (dayBarsVendedores) {
                dayBarsVendedores.innerHTML = '<span style="font-size: 0.6rem; color: #888;">Sin datos</span>';
            }
            
            // Sección Cancelaciones (Ruta 20): barras por día y por vendedor solo Ruta 20
            const dayBarsResumenCancelaciones = document.getElementById('dayBarsResumenCancelaciones');
            const dayBarsAxisCancelaciones = document.getElementById('dayBarsAxisCancelaciones');
            const dayBarsRowCancelaciones = document.getElementById('dayBarsRowCancelaciones');
            const dayBarsVendedoresCancelaciones = document.getElementById('dayBarsVendedoresCancelaciones');
            const ventasPorDiaRuta20 = diasAMostrar.map(fechaDia => calcularVentasDia(fechaDia.getFullYear(), fechaDia.getMonth(), fechaDia.getDate(), { soloRuta20: true }));
            const totalVentasRuta20 = ventasPorDiaRuta20.reduce((s, v) => s + (v || 0), 0);
            const maxVentasRuta20 = ventasPorDiaRuta20.length ? Math.max(...ventasPorDiaRuta20, 1) : 1;
            const escalaMaxRuta20 = Math.max(500000, maxVentasRuta20);
            const labelEjeMaxRuta20 = escalaMaxRuta20 >= 1000000 ? (escalaMaxRuta20 / 1000000).toFixed(1).replace(/\.0$/, '') + 'M' : (escalaMaxRuta20 / 1000).toFixed(0) + 'k';
            const fmtMiles = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            if (dayBarsResumenCancelaciones) dayBarsResumenCancelaciones.textContent = 'Ventas perdidas (Ruta 20): ₡' + fmtMiles(totalVentasRuta20);
            if (dayBarsAxisCancelaciones) dayBarsAxisCancelaciones.innerHTML = '<span>0</span><span>' + labelEjeMaxRuta20 + '</span>';
            if (dayBarsRowCancelaciones) {
                const barsWrapStyle = 'position: relative; z-index: 1; flex: 1; min-width: 0; display: flex; flex-wrap: nowrap; gap: 3px; align-items: flex-end; height: 100%;';
                const barsHtmlRuta20 = ventasPorDiaRuta20.map((ventasDia, i) => {
                    const fechaDia = diasAMostrar[i];
                    const fechaString = formatearFechaParaInput(fechaDia);
                    const esDomingo = fechaDia.getDay() === 0;
                    const esFeriado = esFeriadoCR(fechaString);
                    const esHabil = !esDomingo && !esFeriado;
                    const pct = escalaMaxRuta20 > 0 ? Math.min(100, ((ventasDia || 0) / escalaMaxRuta20) * 100) : 0;
                    const ventasFormateadasBar = (ventasDia || 0) >= 1000000 ? ((ventasDia || 0) / 1000000).toFixed(1) + 'M' : (ventasDia || 0) >= 1000 ? ((ventasDia || 0) / 1000).toFixed(0) + 'k' : (ventasDia || 0).toString();
                    const titulo = '₡' + (ventasDia || 0).toLocaleString('es-CR');
                    return '<div class="day-bar-cell" title="' + titulo.replace(/"/g, '&quot;') + '" data-fecha="' + fechaString + '" style="position: relative; min-width: 44px; max-width: 52px; flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%;"><span style="font-size: 0.5rem; font-weight: 600; color: #333; margin-bottom: 2px; line-height: 1; white-space: nowrap; position: relative; z-index: 1;">' + ventasFormateadasBar + '</span><div style="flex: 1; width: 100%; min-height: 0; display: flex; align-items: flex-end; justify-content: center; position: relative; z-index: 1;"><div style="width: 85%; height: ' + (pct || 4) + '%; min-height: 4px; border-radius: 3px; background: linear-gradient(to top, #c62828, #e57373);"></div></div></div>';
                }).join('');
                dayBarsRowCancelaciones.innerHTML = '<div style="' + barsWrapStyle + '">' + barsHtmlRuta20 + '</div>';
            }
            if (dayBarsVendedoresCancelaciones && window.todasLasCitas) {
                const ventasPorVendedorR20 = {};
                window.todasLasCitas.forEach(cita => {
                    if (!window.obtenerRuta || window.obtenerRuta(cita) !== 'Ruta 20') return;
                    const inicioCita = window.obtenerInicio && window.obtenerInicio(cita);
                    if (!inicioCita) return;
                    const fechaCita = window.formatearFecha && window.formatearFecha(inicioCita);
                    if (!fechaCita || fechaCita.getFullYear() !== year || fechaCita.getMonth() !== month) return;
                    const monto = (window.obtenerMonto && window.obtenerMonto(cita)) || 0;
                    let vendedores = (window.obtenerVendedores && window.obtenerVendedores(cita)) || [];
                    if (!Array.isArray(vendedores)) vendedores = [];
                    if (vendedores.length === 0) vendedores = ['Sin vendedor'];
                    const atribuible = monto / vendedores.length;
                    vendedores.forEach(v => {
                        const key = (v && String(v).trim()) || 'Sin vendedor';
                        ventasPorVendedorR20[key] = (ventasPorVendedorR20[key] || 0) + atribuible;
                    });
                });
                const entradasR20 = Object.entries(ventasPorVendedorR20).sort((a, b) => b[1] - a[1]);
                const maxVendedorR20 = entradasR20.length ? Math.max(...entradasR20.map(e => e[1]), 1) : 1;
                const fmtMilesVR20 = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                const nombreStyleR20 = 'width: 140px; min-width: 140px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
                const barraWrapStyleR20 = 'flex: 1; min-width: 48px; height: 14px; background: #e0e0e0; border-radius: 3px; overflow: hidden;';
                const renderFilaR20 = (nombre, total) => {
                    const pct = maxVendedorR20 > 0 ? Math.min(100, (total / maxVendedorR20) * 100) : 0;
                    return '<div style="display: flex; align-items: center; gap: 6px; font-size: 0.6rem; min-width: 0; width: 100%;"><span style="' + nombreStyleR20 + '" title="' + nombre.replace(/"/g, '&quot;') + '">' + nombre + '</span><div style="' + barraWrapStyleR20 + '"><div style="height: 100%; width: ' + pct + '%; min-width: ' + (total > 0 ? 2 : 0) + 'px; border-radius: 3px; background: linear-gradient(to right, #c62828, #e57373);"></div></div><span style="font-weight: 600; white-space: nowrap; flex-shrink: 0;">₡' + fmtMilesVR20(total) + '</span></div>';
                };
                if (entradasR20.length === 0) {
                    dayBarsVendedoresCancelaciones.innerHTML = '<span style="font-size: 0.6rem; color: #888;">Sin datos</span>';
                } else {
                    const mitadR20 = Math.ceil(entradasR20.length / 2);
                    const col1R20 = entradasR20.slice(0, mitadR20);
                    const col2R20 = entradasR20.slice(mitadR20);
                    const col1HtmlR20 = col1R20.map(([nombre, total]) => renderFilaR20(nombre, total)).join('');
                    const col2HtmlR20 = col2R20.map(([nombre, total]) => renderFilaR20(nombre, total)).join('');
                    dayBarsVendedoresCancelaciones.innerHTML = '<div style="display: flex; flex-direction: column; gap: 4px; min-width: 0;">' + col1HtmlR20 + '</div><div style="display: flex; flex-direction: column; gap: 4px; min-width: 0;">' + col2HtmlR20 + '</div>';
                }
            }
            const btnToggleCancelaciones = document.getElementById('btnToggleCancelaciones');
            if (btnToggleCancelaciones && !btnToggleCancelaciones._toggleListener) {
                btnToggleCancelaciones._toggleListener = true;
                btnToggleCancelaciones.addEventListener('click', function() {
                    const wrap = document.getElementById('cancelacionesRuta20Wrap');
                    const icon = document.getElementById('iconToggleCancelaciones');
                    if (wrap && (wrap.style.display === 'none' || !wrap.style.display)) {
                        wrap.style.display = 'flex';
                        wrap.style.flexDirection = 'column';
                        if (icon) { icon.style.transform = 'rotate(90deg)'; icon.className = 'fas fa-chevron-down'; }
                    } else if (wrap) {
                        wrap.style.display = 'none';
                        if (icon) { icon.style.transform = ''; icon.className = 'fas fa-chevron-right'; }
                    }
                });
            }
            
            let html = '';
            diasAMostrar.forEach((fechaDia, i) => {
                const yearD = fechaDia.getFullYear();
                const monthD = fechaDia.getMonth();
                const day = fechaDia.getDate();
                const diaSemana = diasSemana[fechaDia.getDay()];
                const mesAbrev = meses[monthD];
                const fechaString = formatearFechaParaInput(fechaDia);
                
                const esHoy = fechaDia.getTime() === hoy.getTime();
                const esSeleccionado = diaSeleccionado && formatearFechaParaInput(diaSeleccionado) === fechaString;
                const esDomingo = fechaDia.getDay() === 0;
                
                const ventasDia = ventasPorDia[i];
                const ventasFormateadas = formatearMontoGrande(ventasDia);
                const ventasExactasTooltip = 'Ventas: ₡' + (ventasDia || 0).toLocaleString('es-CR');
                
                const estiloBoton = 'min-width: 44px; max-width: 52px; flex: 0 0 auto; padding: 4px;';
                
                html += `
                    <button class="btn-dia-mes ${esHoy ? 'today' : ''} ${esSeleccionado ? 'active' : ''} ${esDomingo ? 'domingo' : ''}" 
                            data-fecha="${fechaString}"
                            title="${ventasExactasTooltip.replace(/"/g, '&quot;')}"
                            style="${estiloBoton}"
                            onclick="if(window.seleccionarDia) { window.seleccionarDia('${fechaString}'); } else { console.error('seleccionarDia no disponible'); }">
                        <span class="linea-dia-semana" style="font-size: 0.6rem; font-weight: 700;">${diaSemana}</span>
                        <span class="linea-fecha" style="font-size: 0.55rem; font-weight: 600;">${day} ${mesAbrev}</span>
                    </button>
                `;
            });
            
            container.innerHTML = html;
            
            // Agregar event listeners a los botones después de renderizar
            // Usar setTimeout para asegurar que el DOM esté completamente actualizado
            setTimeout(() => {
                const allButtons = container.querySelectorAll('.btn-dia-mes');
                console.log('🔍 [CALENDARIO] Encontrados', allButtons.length, 'botones de días');
                
                allButtons.forEach(button => {
                    const fechaString = button.getAttribute('data-fecha');
                    if (!fechaString) {
                        console.warn('⚠️ [CALENDARIO] Botón sin data-fecha:', button);
                        return;
                    }
                    
                    // Remover listeners anteriores clonando el botón
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    // Agregar nuevo listener
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🖱️ [CALENDARIO] Click en botón de día:', fechaString);
                        if (window.seleccionarDia) {
                            window.seleccionarDia(fechaString);
                        } else {
                            console.error('❌ [CALENDARIO] window.seleccionarDia no está disponible');
                        }
                    });
                });
                console.log('✅ [CALENDARIO] Event listeners agregados a', allButtons.length, 'botones de días');
            }, 100);
        }
        
        // Función para seleccionar un día
        window.seleccionarDia = async function(fechaString) {
            try {
                console.log('📅 [CALENDARIO] Seleccionando día:', fechaString);
                const [year, month, day] = fechaString.split('-').map(Number);
                const nuevaFecha = new Date(year, month - 1, day, 12, 0, 0);
                currentDate = nuevaFecha;
                diaSeleccionado = nuevaFecha;
                
                console.log('📅 [CALENDARIO] diaSeleccionado actualizado a:', diaSeleccionado);
                
                // Actualizar input oculto
                const datePicker = document.getElementById('datePicker');
                if (datePicker) {
                    datePicker.value = fechaString;
                }
                
                // Actualizar botones activos
                document.querySelectorAll('.btn-dia-mes').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.fecha === fechaString) {
                        btn.classList.add('active');
                        console.log('✅ [CALENDARIO] Botón activado:', fechaString);
                    }
                });
                
                // Siempre generar cronograma cuando se selecciona un día (no solo si vistaActual === 'cronograma')
                console.log('🔄 [CALENDARIO] Generando cronograma para fecha:', fechaString);
                await generarCronograma();
                console.log('✅ [CALENDARIO] Cronograma generado');
            } catch (error) {
                console.error('❌ [CALENDARIO] Error seleccionando día:', error);
                console.error('Stack trace:', error.stack);
            }
        };
        
        // Sincronizar datePicker con diaSeleccionado cuando cambien los botones
        const btnPrevMonthCronograma = document.getElementById('btnPrevMonthCronograma');
        const btnNextMonthCronograma = document.getElementById('btnNextMonthCronograma');
        
        if (btnPrevMonthCronograma) {
            btnPrevMonthCronograma.addEventListener('click', async () => {
                const nuevaFecha = new Date(diaSeleccionado);
                nuevaFecha.setMonth(nuevaFecha.getMonth() - 1);
                diaSeleccionado = nuevaFecha;
                generarBotonesDiasMes(nuevaFecha);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }
        
        if (btnNextMonthCronograma) {
            btnNextMonthCronograma.addEventListener('click', async () => {
                const nuevaFecha = new Date(diaSeleccionado);
                nuevaFecha.setMonth(nuevaFecha.getMonth() + 1);
                diaSeleccionado = nuevaFecha;
                generarBotonesDiasMes(nuevaFecha);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }
        
        // Mantener compatibilidad con el código anterior (si los botones antiguos aún existen)
        // Nota: btnPrevDayCronograma y btnNextDayCronograma ya están declarados arriba
        if (btnPrevDayCronograma && datePicker) {
            btnPrevDayCronograma.addEventListener('click', async () => {
                diaSeleccionado.setDate(diaSeleccionado.getDate() - 1);
                datePicker.value = formatearFechaParaInput(diaSeleccionado);
                generarBotonesDiasMes(diaSeleccionado);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }
        
        if (btnNextDayCronograma && datePicker) {
            btnNextDayCronograma.addEventListener('click', async () => {
                diaSeleccionado.setDate(diaSeleccionado.getDate() + 1);
                datePicker.value = formatearFechaParaInput(diaSeleccionado);
                generarBotonesDiasMes(diaSeleccionado);
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
            // Agregar efecto visual al hacer clic
            btnNextDayCronograma.addEventListener('mousedown', function() {
                this.style.transform = 'scale(0.95)';
            });
            btnNextDayCronograma.addEventListener('mouseup', function() {
                this.style.transform = 'scale(1)';
            });
        }

        // Paleta de colores - Alta intensidad y contraste
        const coloresVehiculos = {
            'APV 01': '#00C853', // Verde fuerte
            'APV 02': '#7B1FA2', // Morado fuerte
            'APV 03': '#FFD600', // Amarillo fuerte
            'APV 04': '#FF6F00', // Naranja fuerte
            'APV 05': '#00B0FF', // Celeste fuerte
            'APV 06': '#E91E63', // Rosada fuerte
            'APV 07': '#424242', // Gris fuerte
            'APV 08': '#1976D2', // Azul fuerte
            'Yaris': '#D32F2F', // Rojo fuerte
            'Kangoo': '#D32F2F', // Rojo fuerte
            'Rojo': '#D32F2F' // Rojo fuerte
        };

        // Días de la semana
        const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        
        // Variable global para empleados
        window.empleados = window.empleados || [];
        let empleados = window.empleados; // Alias para uso dentro del módulo
        
        // Función para cargar empleados activos
        async function cargarEmpleados() {
            try {
                const empleadosQuery = query(collection(window.db, 'empleados'), orderBy('primerNombre'));
                const querySnapshot = await getDocs(empleadosQuery);
                
                window.empleados = [];
                empleados = window.empleados; // Actualizar alias
                querySnapshot.forEach(doc => {
                    const empleado = { id: doc.id, ...doc.data() };
                    // Filtrar solo empleados activos
                    const estado = empleado.estado || empleado.activo;
                    if (estado === 'Activo' || estado === 'activo' || estado === true) {
                        window.empleados.push(empleado);
                    }
                });
                
                console.log('✅ Empleados activos cargados:', window.empleados.length);
                return window.empleados;
            } catch (error) {
                console.error('❌ Error cargando empleados:', error);
                return [];
            }
        }
        
        // Función para renderizar checkboxes de vendedores (GLOBAL)
        window.renderizarVendedoresCheckboxes = function(vendedoresSeleccionados = []) {
            const container = document.getElementById('editVendedoresContainer');
            if (!container) return;
            
            const empleadosLista = window.empleados || [];
            if (empleadosLista.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-exclamation-triangle me-2"></i>No hay empleados disponibles</div>';
                return;
            }
            
            // Normalizar vendedores seleccionados (pueden ser array de usernames o strings)
            const vendedoresNormalizados = Array.isArray(vendedoresSeleccionados) 
                ? vendedoresSeleccionados.map(v => typeof v === 'string' ? v.trim() : v)
                : (typeof vendedoresSeleccionados === 'string' ? vendedoresSeleccionados.split(',').map(v => v.trim()) : []);
            
            container.innerHTML = empleadosLista.map(empleado => {
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                const username = empleado.username || empleado.id;
                const estaSeleccionado = vendedoresNormalizados.includes(username) || vendedoresNormalizados.includes(nombreCompleto);
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="vendedor_${username}" 
                               value="${username}" 
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="vendedor_${username}">
                            ${nombreCompleto || username}
                        </label>
                    </div>
                `;
            }).join('');
        };
        
        // Función para obtener vendedores seleccionados (GLOBAL) - Nueva versión con badges
        window.obtenerVendedoresSeleccionados = function(containerId = 'editVendedoresSelected') {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const badges = container.querySelectorAll('[data-username]');
            return Array.from(badges).map(badge => badge.getAttribute('data-username'));
        };
        
        // Variables globales para almacenar selecciones
        window.vendedoresSeleccionadosEdit = [];
        window.serviciosSeleccionadosEdit = []; // Array de objetos {id, precio}
        window.productosSeleccionadosEdit = [];
        window.plagasSeleccionadasEdit = [];
        window.vendedoresSeleccionadosNew = [];
        window.serviciosSeleccionadosNew = []; // Array de objetos {id, precio}
        window.productosSeleccionadosNew = [];
        window.plagasSeleccionadasNew = [];
        
        // Lista de plagas disponibles (ordenadas alfabéticamente)
        window.plagasDisponibles = [
            'Alacranes',
            'Arañas',
            'Ácaros',
            'Babosas',
            'Caracoles',
            'Chinches de cama',
            'Cucaracha americana',
            'Cucaracha germánica',
            'Garrapatas',
            'Hormigas',
            'Moscas',
            'Murciélagos',
            'Polillas',
            'Pulgas',
            'Ratas',
            'Ratones',
            'Termitas',
            'Zancudos',
            'cliente no especificó',
            'preventivo',
            'otra:'
        ];
        
        // Función para inicializar búsqueda de vendedores
        window.inicializarBusquedaVendedores = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}VendedorSearch`);
            const dropdownMenu = document.getElementById(`${prefix}VendedoresDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Vendedor`);
            const selectedDiv = document.getElementById(`${prefix}VendedoresSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Función para renderizar opciones
            function renderizarOpciones(query = '') {
                const empleados = window.empleados || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfabéticamente
                let empleadosFiltrados = empleados;
                if (queryLower) {
                    empleadosFiltrados = empleados.filter(emp => {
                        const nombre = `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim().toLowerCase();
                        const username = (emp.username || emp.id || '').toLowerCase();
                        return nombre.includes(queryLower) || username.includes(queryLower);
                    });
                }
                
                // Ordenar alfabéticamente por nombre completo
                empleadosFiltrados.sort((a, b) => {
                    const nombreA = `${a.primerNombre || ''} ${a.primerApellido || ''}`.trim().toLowerCase();
                    const nombreB = `${b.primerNombre || ''} ${b.primerApellido || ''}`.trim().toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener vendedores ya seleccionados
                const selected = prefix === 'edit' ? window.vendedoresSeleccionadosEdit : window.vendedoresSeleccionadosNew;
                
                if (empleadosFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = empleadosFiltrados.map(emp => {
                    const nombre = `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim();
                    const username = emp.username || emp.id;
                    const yaSeleccionado = selected.includes(username);
                    return `
                        <div class="dropdown-item" data-username="${username}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${nombre || username}</span>
                                ${username !== nombre ? `<small style="color: #6c757d; font-size: 0.8rem;">${username}</small>` : ''}
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const username = item.getAttribute('data-username');
                            agregarVendedor(username, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para búsqueda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarVendedor(username, prefix) {
                const selected = prefix === 'edit' ? window.vendedoresSeleccionadosEdit : window.vendedoresSeleccionadosNew;
                if (selected.includes(username)) return;
                
                const empleado = window.empleados.find(e => (e.username || e.id) === username);
                const nombre = empleado ? `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() : username;
                
                selected.push(username);
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.style.cssText = 'background: #c8e6c9; color: #000000; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;';
                badge.setAttribute('data-username', username);
                badge.innerHTML = `${nombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                badge.querySelector('i').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = selected.indexOf(username);
                    if (index > -1) selected.splice(index, 1);
                    badge.remove();
                });
                selectedDiv.appendChild(badge);
            }
        }
        
        // Función para inicializar búsqueda de servicios con dropdown
        window.inicializarBusquedaServicios = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}ServicioSearch`);
            const dropdownMenu = document.getElementById(`${prefix}ServiciosDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Servicio`);
            const selectedDiv = document.getElementById(`${prefix}ServiciosSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Función para renderizar opciones
            function renderizarOpciones(query = '') {
                const servicios = window.todosLosServicios || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfabéticamente
                let serviciosFiltrados = servicios;
                if (queryLower) {
                    serviciosFiltrados = servicios.filter(serv => {
                        const nombre = (serv.nombre || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfabéticamente por nombre
                serviciosFiltrados.sort((a, b) => {
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener servicios ya seleccionados
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                
                if (serviciosFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = serviciosFiltrados.map(serv => {
                    // Verificar si ya está seleccionado (comparar por ID)
                    const yaSeleccionado = selected.some(s => {
                        const id = typeof s === 'string' ? s : s.id;
                        return id === serv.id;
                    });
                    return `
                        <div class="dropdown-item" data-servicio-id="${serv.id}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${serv.nombre || 'Sin nombre'}</span>
                                <span style="color: #6c757d; font-size: 0.9rem;">₡${(serv.precio || 0).toLocaleString('es-CR')}</span>
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const servicioId = item.getAttribute('data-servicio-id');
                            agregarServicio(servicioId, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para búsqueda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
                
                // Cerrar dropdown de plagas si está abierto
                const plagaDropdown = document.getElementById(`${prefix}PlagasDropdownMenu`);
                if (plagaDropdown && plagaDropdown.style.display !== 'none') {
                    plagaDropdown.style.display = 'none';
                }
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarServicio(servicioId, prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                
                // Verificar si ya está seleccionado (comparar por ID)
                if (selected.some(s => (typeof s === 'string' && s === servicioId) || (typeof s === 'object' && s.id === servicioId))) {
                    return;
                }
                
                const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                if (!servicio) return;
                
                // Agregar como objeto con precio inicial del servicio, cantidad 1 y comentarios vacíos
                const servicioConPrecio = {
                    id: servicioId,
                    cantidad: 1,
                    precio: servicio.precio || 0,
                    comentarios: ''
                };
                selected.push(servicioConPrecio);
                
                // Renderizar tabla de servicios
                if (window.renderizarTablaServicios) {
                    window.renderizarTablaServicios(prefix);
                }
                
                // Actualizar precio total
                if (window.actualizarPrecioTotalServicios) {
                    window.actualizarPrecioTotalServicios(prefix);
                }
                
                    // Actualizar resumen financiero
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                        window.actualizarResumenFinanciero();
                    } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                        window.actualizarResumenFinancieroNew();
                    }
            }
            
            // Función para renderizar la tabla de servicios (disponible globalmente)
            window.renderizarTablaServicios = function(prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const tabla = document.getElementById(`${prefix}ServiciosTabla`);
                const tbody = document.getElementById(`${prefix}ServiciosTablaBody`);
                
                if (!tabla || !tbody) return;
                
                if (selected.length === 0) {
                    tabla.style.display = 'none';
                    return;
                }
                
                tabla.style.display = 'table';
                
                // Ordenar servicios alfabéticamente
                const serviciosOrdenados = selected.map(serv => {
                    const servicio = window.todosLosServicios.find(s => s.id === (typeof serv === 'string' ? serv : serv.id));
                    return {
                        id: typeof serv === 'string' ? serv : serv.id,
                        cantidad: typeof serv === 'object' && serv.cantidad !== undefined ? serv.cantidad : 1,
                        precio: typeof serv === 'object' && serv.precio !== undefined ? serv.precio : (servicio?.precio || 0),
                        comentarios: typeof serv === 'object' && serv.comentarios !== undefined ? serv.comentarios : '',
                        nombre: servicio?.nombre || 'Sin nombre'
                    };
                }).sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                tbody.innerHTML = serviciosOrdenados.map(serv => {
                    const precioUnitario = serv.precio || 0;
                    const cantidad = serv.cantidad || 1;
                    const precioTotal = precioUnitario * cantidad;
                    const precioUnitarioFormateado = precioUnitario.toLocaleString('es-CR');
                    const precioTotalFormateado = precioTotal.toLocaleString('es-CR');
                    const tieneComentarios = serv.comentarios && serv.comentarios.trim() !== '';
                    const comentariosEscapados = (serv.comentarios || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    return `
                        <tr data-servicio-id="${serv.id}">
                            <td style="font-size: 0.9rem; vertical-align: middle;">${serv.nombre}</td>
                            <td style="vertical-align: middle;">
                                <input 
                                    type="number" 
                                    class="form-control form-control-sm servicio-cantidad-input" 
                                    value="${cantidad}" 
                                    min="1" 
                                    step="1"
                                    data-servicio-id="${serv.id}"
                                    data-prefix="${prefix}"
                                    style="font-size: 0.9rem; text-align: center; width: 80px;"
                                    onchange="actualizarCantidadServicioCita('${serv.id}', this.value, '${prefix}')"
                                    onblur="actualizarCantidadServicioCita('${serv.id}', this.value, '${prefix}')"
                                >
                            </td>
                            <td style="vertical-align: middle;">
                                <input 
                                    type="number" 
                                    class="form-control form-control-sm servicio-precio-input" 
                                    value="${precioUnitario}" 
                                    min="0" 
                                    step="1"
                                    data-servicio-id="${serv.id}"
                                    data-prefix="${prefix}"
                                    style="font-size: 0.9rem; text-align: right;"
                                    onchange="actualizarPrecioServicioCita('${serv.id}', this.value, '${prefix}')"
                                    onblur="actualizarPrecioServicioCita('${serv.id}', this.value, '${prefix}')"
                                >
                            </td>
                            <td style="vertical-align: middle; text-align: right; font-size: 0.9rem; font-weight: 600; color: #28a745;">
                                ₡${precioTotalFormateado}
                            </td>
                            <td style="vertical-align: middle; text-align: center;">
                                <button 
                                    class="btn btn-sm btn-danger" 
                                    onclick="eliminarServicioCita('${serv.id}', '${prefix}')"
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                    title="Eliminar servicio"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        <tr data-servicio-comentarios-id="${serv.id}" style="background-color: #f8f9fa;">
                            <td colspan="5" style="padding: 0.75rem;">
                                <div style="border-left: 3px solid #007bff; padding-left: 0.75rem;">
                                    <label style="font-size: 0.85rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; display: block;">
                                        Comentarios <span style="color: #6c757d; font-size: 0.8rem;">(Opcional)</span>
                                    </label>
                                    <textarea 
                                        id="textareaComentarios-${prefix}-${serv.id}"
                                        class="form-control servicio-comentarios-textarea" 
                                        rows="3" 
                                        placeholder="Ingrese los comentarios para este servicio (opcional)"
                                        data-servicio-id="${serv.id}"
                                        data-prefix="${prefix}"
                                        style="font-size: 0.9rem; resize: vertical; border: 1px solid #ced4da;"
                                        onblur="guardarComentariosServicio('${serv.id}', '${prefix}')"
                                    >${comentariosEscapados}</textarea>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Actualizar precio total después de renderizar
                if (window.actualizarPrecioTotalServicios) {
                    window.actualizarPrecioTotalServicios(prefix);
                }
            }
            
            // Función para calcular y actualizar el precio total de servicios
            window.actualizarPrecioTotalServicios = function(prefix, valorManual = null) {
                const inputTotal = document.getElementById(`${prefix}PrecioTotalServicios`);
                const containerTotal = document.getElementById(`${prefix}PrecioTotalContainer`);
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                
                // Calcular automáticamente la suma de todos los servicios (siempre, para resumen y Monto de Venta)
                let sumaTotal = 0;
                (selected || []).forEach(serv => {
                    const precioUnitario = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : 0;
                    const cantidad = typeof serv === 'object' && serv.cantidad !== undefined ? serv.cantidad : 1;
                    sumaTotal += precioUnitario * cantidad;
                });
                
                if (inputTotal && containerTotal) {
                    if (valorManual !== null) {
                        const valorNumerico = valorManual.replace(/[^\d]/g, '');
                        const valorFinal = valorNumerico ? parseInt(valorNumerico) : 0;
                        inputTotal.value = valorFinal.toLocaleString('es-CR');
                        if (prefix === 'edit') window.precioTotalServiciosManualEdit = valorFinal;
                        else window.precioTotalServiciosManualNew = valorFinal;
                    } else {
                        const valorManualGuardado = prefix === 'edit' ? window.precioTotalServiciosManualEdit : window.precioTotalServiciosManualNew;
                        if (valorManualGuardado !== undefined && valorManualGuardado !== null && valorManualGuardado !== sumaTotal) {
                            inputTotal.value = valorManualGuardado.toLocaleString('es-CR');
                        } else {
                            inputTotal.value = sumaTotal.toLocaleString('es-CR');
                            if (prefix === 'edit') window.precioTotalServiciosManualEdit = undefined;
                            else window.precioTotalServiciosManualNew = undefined;
                        }
                    }
                    containerTotal.style.display = selected.length > 0 ? 'block' : 'none';
                }
                
                // Actualizar resumen financiero y Monto de Venta (usa suma de servicios cuando no hay input)
                if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                    window.actualizarResumenFinanciero();
                    window.calcularMontoVenta('edit');
                } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                    window.actualizarResumenFinancieroNew();
                    window.calcularMontoVenta('new');
                }
            };
            
            // Función para formatear el input mientras se escribe
            window.formatearPrecioTotalInput = function(input) {
                // Permitir solo números mientras se escribe
                let valor = input.value.replace(/[^\d]/g, '');
                if (valor) {
                    // Formatear con separadores de miles
                    input.value = parseInt(valor).toLocaleString('es-CR');
                } else {
                    input.value = '';
                }
            };
            
            // Función para actualizar la cantidad de un servicio en la cita
            window.actualizarCantidadServicioCita = function(servicioId, nuevaCantidad, prefix) {
                console.log('[SERVICIOS] Actualizando cantidad', { servicioId, nuevaCantidad, prefix });
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const servicio = selected.find(s => {
                    const id = typeof s === 'string' ? s : s.id;
                    return id === servicioId;
                });
                
                if (servicio) {
                    // Convertir a objeto si es string
                    if (typeof servicio === 'string') {
                        const index = selected.indexOf(servicio);
                        const servicioObj = window.todosLosServicios.find(s => s.id === servicioId);
                        selected[index] = {
                            id: servicioId,
                            cantidad: Math.max(1, parseInt(nuevaCantidad) || 1),
                            precio: servicioObj?.precio || 0,
                            comentarios: ''
                        };
                    } else {
                        servicio.cantidad = Math.max(1, parseInt(nuevaCantidad) || 1);
                    }
                    
                    const precioUnitario = servicio.precio || 0;
                    const cantidad = servicio.cantidad || 1;
                    const precioTotal = precioUnitario * cantidad;
                    console.log('[SERVICIOS] Cantidad actualizada', { servicio, precioUnitario, cantidad, total: precioTotal });
                    
                    // Re-renderizar la tabla para mostrar el nuevo total
                    if (window.renderizarTablaServicios) {
                        window.renderizarTablaServicios(prefix);
                    }
                    
                    // Actualizar precio total
                    if (window.actualizarPrecioTotalServicios) {
                        window.actualizarPrecioTotalServicios(prefix);
                    }
                
                // Actualizar resumen financiero
                if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                    window.actualizarResumenFinanciero();
                } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                    window.actualizarResumenFinancieroNew();
                }
                } else {
                    console.error('[SERVICIOS] No se encontró el servicio para actualizar cantidad', { servicioId, prefix });
                }
            };
            
            // Función para actualizar el precio unitario de un servicio en la cita
            window.actualizarPrecioServicioCita = function(servicioId, nuevoPrecio, prefix) {
                console.log('[SERVICIOS] Actualizando precio unitario', { servicioId, nuevoPrecio, prefix });
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const servicio = selected.find(s => {
                    const id = typeof s === 'string' ? s : s.id;
                    return id === servicioId;
                });
                
                if (servicio) {
                    const num = parseFloat(nuevoPrecio);
                    const precioValido = !isNaN(num) && num >= 0 ? num : (typeof servicio === 'object' && servicio !== null && servicio.precio !== undefined ? servicio.precio : 0);
                    // Convertir a objeto si es string
                    if (typeof servicio === 'string') {
                        const index = selected.indexOf(servicio);
                        const servicioObj = window.todosLosServicios.find(s => s.id === servicioId);
                        selected[index] = {
                            id: servicioId,
                            cantidad: 1,
                            precio: !isNaN(num) && num >= 0 ? num : (servicioObj?.precio ?? 0),
                            comentarios: ''
                        };
                    } else {
                        servicio.precio = precioValido;
                    }
                    const actualizado = selected.find(s => (typeof s === 'string' ? s : s.id) === servicioId);
                    const precioUnitario = precioValido;
                    const cantidad = (typeof actualizado === 'object' && actualizado && actualizado.cantidad !== undefined) ? actualizado.cantidad : 1;
                    const precioTotal = precioUnitario * cantidad;
                    console.log('[SERVICIOS] Precio unitario actualizado', { servicio, precioUnitario, cantidad, total: precioTotal });
                    
                    // Re-renderizar la tabla para mostrar el nuevo total
                    if (window.renderizarTablaServicios) {
                        window.renderizarTablaServicios(prefix);
                    }
                    
                    // Actualizar precio total
                    if (window.actualizarPrecioTotalServicios) {
                        window.actualizarPrecioTotalServicios(prefix);
                    }
                
                    // Actualizar resumen financiero
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                        window.actualizarResumenFinanciero();
                    } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                        window.actualizarResumenFinancieroNew();
                    }
                } else {
                    console.error('[SERVICIOS] No se encontró el servicio para actualizar precio', { servicioId, prefix });
                }
            };
            
            // Función para eliminar un servicio de la cita
            window.eliminarServicioCita = function(servicioId, prefix) {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const index = selected.findIndex(s => {
                    const id = typeof s === 'string' ? s : s.id;
                    return id === servicioId;
                });
                
                if (index > -1) {
                    selected.splice(index, 1);
                    if (window.renderizarTablaServicios) {
                        window.renderizarTablaServicios(prefix);
                    }
                    
                    // Actualizar precio total
                    if (window.actualizarPrecioTotalServicios) {
                        window.actualizarPrecioTotalServicios(prefix);
                    }
                    
                    // Actualizar resumen financiero
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                        window.actualizarResumenFinanciero();
                    } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                        window.actualizarResumenFinancieroNew();
                    }
                } else {
                    console.error('[SERVICIOS] No se encontró el servicio para eliminar', { servicioId, prefix });
                }
            };
            
            // ========== TABLA DE PRODUCTOS (misma estructura que servicios) ==========
            window.renderizarTablaProductos = function(prefix) {
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                const tabla = document.getElementById(`${prefix}ProductosTabla`);
                const tbody = document.getElementById(`${prefix}ProductosTablaBody`);
                if (!tabla || !tbody) return;
                if (!Array.isArray(selected) || selected.length === 0) {
                    tabla.style.display = 'none';
                    return;
                }
                tabla.style.display = 'table';
                const productosOrdenados = selected.map(item => {
                    const id = typeof item === 'object' ? item.id : item;
                    const producto = window.todosLosProductos && window.todosLosProductos.find(p => p.id === id);
                    return {
                        id,
                        cantidad: typeof item === 'object' && item.cantidad !== undefined ? item.cantidad : 1,
                        precio: typeof item === 'object' && item.precio !== undefined ? item.precio : (producto ? (producto.costo ?? producto.precio_venta ?? producto.precio ?? 0) : 0),
                        nombre: producto ? (producto.nombre || 'Sin nombre') : 'Sin nombre'
                    };
                }).sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                tbody.innerHTML = productosOrdenados.map(prod => {
                    const precioUnitario = Number(prod.precio) || 0;
                    const cantidad = Number(prod.cantidad) || 1;
                    const precioTotal = precioUnitario * cantidad;
                    return `
                        <tr data-producto-id="${prod.id}">
                            <td style="font-size: 0.9rem; vertical-align: middle;">${prod.nombre}</td>
                            <td style="vertical-align: middle;">
                                <input type="number" class="form-control form-control-sm" value="${cantidad}" min="1" step="1" data-producto-id="${prod.id}" data-prefix="${prefix}"
                                    style="font-size: 0.9rem; text-align: center; width: 80px;"
                                    onchange="actualizarCantidadProductoCita('${prod.id}', this.value, '${prefix}')"
                                    onblur="actualizarCantidadProductoCita('${prod.id}', this.value, '${prefix}')">
                            </td>
                            <td style="vertical-align: middle;">
                                <input type="number" class="form-control form-control-sm" value="${precioUnitario}" min="0" step="1" data-producto-id="${prod.id}" data-prefix="${prefix}"
                                    style="font-size: 0.9rem; text-align: right;"
                                    onchange="actualizarPrecioProductoCita('${prod.id}', this.value, '${prefix}')"
                                    onblur="actualizarPrecioProductoCita('${prod.id}', this.value, '${prefix}')">
                            </td>
                            <td style="vertical-align: middle; text-align: right; font-size: 0.9rem; font-weight: 600; color: #28a745;">₡${precioTotal.toLocaleString('es-CR')}</td>
                            <td style="vertical-align: middle; text-align: center;">
                                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarProductoCita('${prod.id}', '${prefix}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" title="Eliminar producto"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                if (prefix === 'edit' && window.actualizarResumenFinanciero) window.actualizarResumenFinanciero();
                else if (prefix === 'new' && window.actualizarResumenFinancieroNew) window.actualizarResumenFinancieroNew();
            };
            
            window.actualizarCantidadProductoCita = function(productoId, nuevaCantidad, prefix) {
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                const item = selected.find(p => (typeof p === 'object' ? p.id : p) === productoId);
                if (item && typeof item === 'object') {
                    item.cantidad = Math.max(1, parseInt(nuevaCantidad, 10) || 1);
                    if (window.renderizarTablaProductos) window.renderizarTablaProductos(prefix);
                }
            };
            
            window.actualizarPrecioProductoCita = function(productoId, nuevoPrecio, prefix) {
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                const item = selected.find(p => (typeof p === 'object' ? p.id : p) === productoId);
                if (item && typeof item === 'object') {
                    const num = parseFloat(String(nuevoPrecio).replace(/[^\d.-]/g, ''));
                    item.precio = (!isNaN(num) && num >= 0) ? num : 0;
                    if (window.renderizarTablaProductos) window.renderizarTablaProductos(prefix);
                }
            };
            
            window.eliminarProductoCita = function(productoId, prefix) {
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                const index = selected.findIndex(p => (typeof p === 'object' ? p.id : p) === productoId);
                if (index > -1) {
                    selected.splice(index, 1);
                    if (window.renderizarTablaProductos) window.renderizarTablaProductos(prefix);
                    if (prefix === 'edit' && window.actualizarResumenFinanciero) window.actualizarResumenFinanciero();
                    else if (prefix === 'new' && window.actualizarResumenFinancieroNew) window.actualizarResumenFinancieroNew();
                }
            };
            
            // Función para validar que todos los servicios tengan comentarios (obligatorio)
            // Función para validar comentarios de un servicio individual (en tiempo real)
            window.validarComentarioServicioIndividual = function(servicioId, prefix) {
                const textarea = document.getElementById(`textareaComentarios-${prefix}-${servicioId}`);
                
                if (!textarea) return;
                
                const comentarios = textarea.value.trim();
                
                // Actualizar comentarios en el array de servicios seleccionados
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const servicioIndex = selected.findIndex(serv => {
                    const id = typeof serv === 'string' ? serv : serv.id;
                    return id === servicioId;
                });
                
                if (servicioIndex !== -1) {
                    const serv = selected[servicioIndex];
                    if (typeof serv === 'object') {
                        serv.comentarios = comentarios;
                    } else {
                        // Convertir string a objeto
                        selected[servicioIndex] = {
                            id: serv,
                            comentarios: comentarios
                        };
                    }
                }
                
                // Los comentarios ahora son opcionales, no validamos como obligatorio
                textarea.classList.remove('is-invalid');
            };
            
            window.validarComentariosServicios = function(prefix) {
                // Los comentarios ahora son opcionales, siempre retornamos true
                return true;
            };
            
            // Función para guardar comentarios del servicio (opcional)
            window.guardarComentariosServicio = function(servicioId, prefix) {
                const textarea = document.getElementById(`textareaComentarios-${prefix}-${servicioId}`);
                
                if (!textarea) return;
                
                const comentarios = textarea.value.trim();
                
                // Remover clase de error si existe (los comentarios ahora son opcionales)
                textarea.classList.remove('is-invalid');
                
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                const servicio = selected.find(s => {
                    const id = typeof s === 'string' ? s : s.id;
                    return id === servicioId;
                });
                
                if (servicio) {
                    // Convertir a objeto si es string
                    if (typeof servicio === 'string') {
                        const index = selected.indexOf(servicio);
                        const servicioObj = window.todosLosServicios.find(s => s.id === servicioId);
                        selected[index] = {
                            id: servicioId,
                            cantidad: 1,
                            precio: servicioObj?.precio || 0,
                            comentarios: comentarios
                        };
                    } else {
                        servicio.comentarios = comentarios;
                    }
                    
                    console.log('[SERVICIOS] Comentarios guardados', { servicioId, comentarios });
                }
            };
        }
        
        // Función para inicializar búsqueda de plagas con dropdown
        window.inicializarBusquedaPlagas = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}PlagaSearch`);
            const dropdownMenu = document.getElementById(`${prefix}PlagasDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Plaga`);
            const selectedDiv = document.getElementById(`${prefix}PlagasSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Función para renderizar opciones
            function renderizarOpciones(query = '') {
                const plagas = window.plagasDisponibles || [];
                const queryLower = query.trim().toLowerCase();
                
                // Separar las opciones especiales que siempre van al final
                const opcionesEspeciales = ['cliente no especificó', 'preventivo', 'otra:'];
                const plagasNormales = plagas.filter(p => !opcionesEspeciales.includes(p));
                const plagasEspeciales = plagas.filter(p => opcionesEspeciales.includes(p));
                
                // Filtrar y ordenar alfabéticamente solo las plagas normales
                let plagasFiltradas = plagasNormales;
                if (queryLower) {
                    plagasFiltradas = plagasNormales.filter(plaga => {
                        const nombre = (plaga || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfabéticamente por nombre (solo las normales)
                plagasFiltradas.sort((a, b) => {
                    const nombreA = (a || '').toLowerCase();
                    const nombreB = (b || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Filtrar opciones especiales si hay búsqueda
                let plagasEspecialesFiltradas = plagasEspeciales;
                if (queryLower) {
                    plagasEspecialesFiltradas = plagasEspeciales.filter(plaga => {
                        const nombre = (plaga || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Combinar: primero las normales ordenadas, luego las especiales al final
                plagasFiltradas = [...plagasFiltradas, ...plagasEspecialesFiltradas];
                
                // Obtener plagas ya seleccionadas
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                
                if (plagasFiltradas.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = plagasFiltradas.map(plaga => {
                    // Función helper para obtener el nombre de una plaga (string u objeto)
                    const obtenerNombre = (p) => {
                        if (typeof p === 'string') return p;
                        return p.nombre || p;
                    };
                    
                    // Para "otra:", verificar si hay alguna entrada que empiece con "otra:"
                    let yaSeleccionada = false;
                    if (plaga === 'otra:') {
                        yaSeleccionada = selected.some(p => {
                            const nombre = obtenerNombre(p);
                            return nombre.startsWith('otra:');
                        });
                    } else {
                        yaSeleccionada = selected.some(p => obtenerNombre(p) === plaga);
                    }
                    
                    return `
                        <div class="dropdown-item" data-plaga="${plaga.replace(/"/g, '&quot;')}" style="cursor: pointer; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                            <input 
                                type="checkbox" 
                                ${yaSeleccionada ? 'checked' : ''}
                                style="width: 18px; height: 18px; cursor: pointer;"
                                onchange="togglePlaga('${plaga.replace(/'/g, "\\'")}', '${prefix}')"
                            >
                            <span style="font-weight: 500; color: #000000; flex: 1;">${plaga}</span>
                        </div>
                    `;
                }).join('');
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para búsqueda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            // Función para actualizar la visualización de plagas seleccionadas
            function actualizarPlagasSeleccionadas() {
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                selectedDiv.innerHTML = '';
                
                selected.forEach(plagaObj => {
                    // Normalizar: puede ser string (legacy) u objeto {nombre, comentarios}
                    const plagaNombre = typeof plagaObj === 'string' ? plagaObj : (plagaObj.nombre || plagaObj);
                    const plagaComentarios = typeof plagaObj === 'object' && plagaObj.comentarios !== undefined ? plagaObj.comentarios : '';
                    
                    // Verificar si es "otra:" con texto personalizado
                    if (plagaNombre.startsWith('otra:')) {
                        // Extraer el texto después de "otra:"
                        const textoOtra = plagaNombre.substring(5).trim();
                        
                        // Crear contenedor para "otra:" con input
                        const container = document.createElement('div');
                        container.style.cssText = 'width: 100%; margin-bottom: 0.5rem;';
                        container.className = 'otra-plaga-container';
                        container.setAttribute('data-prefix', prefix);
                        
                        const label = document.createElement('label');
                        label.style.cssText = 'font-size: 0.85rem; font-weight: 500; color: #2e7d32; margin-bottom: 0.25rem; display: block;';
                        label.textContent = 'Otra:';
                        
                        const inputGroup = document.createElement('div');
                        inputGroup.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'form-control form-control-sm';
                        input.value = textoOtra;
                        input.placeholder = 'Escriba la plaga...';
                        input.style.cssText = 'flex: 1; font-size: 0.85rem;';
                        input.setAttribute('data-prefix', prefix);
                        
                        // Guardar cuando se escribe
                        input.addEventListener('blur', () => {
                            const nuevoTexto = input.value.trim();
                            const index = selected.findIndex(p => {
                                const nombre = typeof p === 'string' ? p : (p.nombre || p);
                                return nombre.startsWith('otra:');
                            });
                            if (index > -1) {
                                if (nuevoTexto) {
                                    selected[index] = { nombre: 'otra: ' + nuevoTexto, comentarios: plagaComentarios };
                                } else {
                                    // Si está vacío, mantener "otra:" sin texto
                                    selected[index] = { nombre: 'otra:', comentarios: plagaComentarios };
                                }
                            }
                        });
                        
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                input.blur();
                            }
                        });
                        
                        const btnEliminar = document.createElement('button');
                        btnEliminar.className = 'btn btn-sm btn-danger';
                        btnEliminar.style.cssText = 'padding: 0.25rem 0.5rem; font-size: 0.8rem;';
                        btnEliminar.innerHTML = '<i class="fas fa-times"></i>';
                        btnEliminar.title = 'Eliminar';
                        btnEliminar.addEventListener('click', (e) => {
                            e.stopPropagation();
                            togglePlaga(plagaNombre, prefix);
                        });
                        
                        inputGroup.appendChild(input);
                        inputGroup.appendChild(btnEliminar);
                        
                        container.appendChild(label);
                        container.appendChild(inputGroup);
                        
                        selectedDiv.appendChild(container);
                    } else if (plagaNombre === 'cliente no especificó') {
                        // Plaga "cliente no especificó" - sin comentarios
                        const badge = document.createElement('span');
                        badge.className = 'badge';
                        badge.style.cssText = 'background: #e8f5e9; color: #2e7d32; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;';
                        badge.setAttribute('data-plaga', plagaNombre.replace(/"/g, '&quot;'));
                        badge.innerHTML = `${plagaNombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                        badge.querySelector('i').addEventListener('click', (e) => {
                            e.stopPropagation();
                            togglePlaga(plagaNombre, prefix);
                        });
                        selectedDiv.appendChild(badge);
                    } else {
                        // Plaga normal - con comentarios obligatorios
                        const container = document.createElement('div');
                        container.style.cssText = 'width: 100%; margin-bottom: 0.75rem;';
                        container.setAttribute('data-plaga-nombre', plagaNombre.replace(/"/g, '&quot;'));
                        
                        // Badge de la plaga
                        const badge = document.createElement('span');
                        badge.className = 'badge';
                        badge.style.cssText = 'background: #e8f5e9; color: #2e7d32; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;';
                        badge.setAttribute('data-plaga', plagaNombre.replace(/"/g, '&quot;'));
                        badge.innerHTML = `${plagaNombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                        badge.querySelector('i').addEventListener('click', (e) => {
                            e.stopPropagation();
                            togglePlaga(plagaNombre, prefix);
                        });
                        
                        // Sección de comentarios (obligatorio)
                        const comentariosContainer = document.createElement('div');
                        comentariosContainer.style.cssText = 'border-left: 3px solid #007bff; padding-left: 0.75rem; background-color: #f8f9fa; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem;';
                        
                        const labelComentarios = document.createElement('label');
                        labelComentarios.style.cssText = 'font-size: 0.85rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; display: block;';
                        labelComentarios.innerHTML = 'Comentarios <span style="color: #dc3545;">*</span>';
                        
                        const textareaComentarios = document.createElement('textarea');
                        textareaComentarios.className = 'form-control plaga-comentarios-textarea';
                        textareaComentarios.rows = 3;
                        textareaComentarios.placeholder = 'Ingrese los comentarios para esta plaga (obligatorio)';
                        textareaComentarios.required = true;
                        textareaComentarios.value = plagaComentarios;
                        textareaComentarios.style.cssText = 'font-size: 0.9rem; resize: vertical; border: 1px solid #ced4da;';
                        textareaComentarios.setAttribute('data-plaga-nombre', plagaNombre.replace(/"/g, '&quot;'));
                        textareaComentarios.setAttribute('data-prefix', prefix);
                        
                        const errorMsg = document.createElement('small');
                        errorMsg.id = `errorComentariosPlaga-${prefix}-${plagaNombre.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        errorMsg.style.cssText = 'color: #dc3545; display: none; font-size: 0.8rem; margin-top: 0.25rem;';
                        errorMsg.textContent = 'Este campo es obligatorio';
                        
                        // Validar en tiempo real
                        textareaComentarios.addEventListener('input', () => {
                            validarComentariosPlaga(plagaNombre, prefix);
                        });
                        
                        // Guardar comentarios al salir del campo
                        textareaComentarios.addEventListener('blur', () => {
                            guardarComentariosPlaga(plagaNombre, prefix);
                        });
                        
                        comentariosContainer.appendChild(labelComentarios);
                        comentariosContainer.appendChild(textareaComentarios);
                        comentariosContainer.appendChild(errorMsg);
                        
                        container.appendChild(badge);
                        container.appendChild(comentariosContainer);
                        
                        selectedDiv.appendChild(container);
                    }
                });
            }
            
            // Inicializar visualización
            actualizarPlagasSeleccionadas();
            
            // Función para agregar/quitar plaga
            window.togglePlaga = function(nombrePlaga, prefix) {
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                
                // Función helper para obtener el nombre de una plaga (string u objeto)
                const obtenerNombre = (p) => {
                    if (typeof p === 'string') return p;
                    return p.nombre || p;
                };
                
                // Si es "otra:", buscar cualquier entrada que empiece con "otra:"
                if (nombrePlaga === 'otra:') {
                    const indexOtra = selected.findIndex(p => {
                        const nombre = obtenerNombre(p);
                        return nombre.startsWith('otra:');
                    });
                    if (indexOtra === -1) {
                        // Agregar "otra:" sin texto inicial
                        selected.push({ nombre: 'otra:', comentarios: '' });
                    } else {
                        // Quitar "otra:"
                        selected.splice(indexOtra, 1);
                    }
                } else {
                    // Para otras plagas, buscar por nombre
                    const index = selected.findIndex(p => obtenerNombre(p) === nombrePlaga);
                    
                    if (index === -1) {
                        // Agregar plaga como objeto {nombre, comentarios}
                        selected.push({ nombre: nombrePlaga, comentarios: '' });
                    } else {
                        // Quitar plaga
                        selected.splice(index, 1);
                    }
                }
                
                // Actualizar visualización
                actualizarPlagasSeleccionadas();
                
                // Re-renderizar dropdown para actualizar checkboxes
                const searchInput = document.getElementById(`${prefix}PlagaSearch`);
                if (searchInput) {
                    renderizarOpciones(searchInput.value);
                }
            };
            
            // Función para validar comentarios de plaga (obligatorio)
            window.validarComentariosPlaga = function(nombrePlaga, prefix) {
                const textarea = document.querySelector(`textarea[data-plaga-nombre="${nombrePlaga.replace(/"/g, '&quot;')}"][data-prefix="${prefix}"]`);
                const errorMsg = document.getElementById(`errorComentariosPlaga-${prefix}-${nombrePlaga.replace(/[^a-zA-Z0-9]/g, '_')}`);
                
                if (!textarea || !errorMsg) return;
                
                const valor = textarea.value.trim();
                if (valor === '') {
                    textarea.classList.add('is-invalid');
                    errorMsg.style.display = 'block';
                } else {
                    textarea.classList.remove('is-invalid');
                    errorMsg.style.display = 'none';
                }
            };
            
            // Función para guardar comentarios de plaga (obligatorio)
            window.guardarComentariosPlaga = function(nombrePlaga, prefix) {
                const textarea = document.querySelector(`textarea[data-plaga-nombre="${nombrePlaga.replace(/"/g, '&quot;')}"][data-prefix="${prefix}"]`);
                const errorMsg = document.getElementById(`errorComentariosPlaga-${prefix}-${nombrePlaga.replace(/[^a-zA-Z0-9]/g, '_')}`);
                
                if (!textarea) return;
                
                const comentarios = textarea.value.trim();
                
                // Validar que no esté vacío (obligatorio)
                if (comentarios === '') {
                    textarea.classList.add('is-invalid');
                    if (errorMsg) {
                        errorMsg.style.display = 'block';
                    }
                    return;
                }
                
                // Remover error si tiene contenido
                textarea.classList.remove('is-invalid');
                if (errorMsg) {
                    errorMsg.style.display = 'none';
                }
                
                const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
                const plaga = selected.find(p => {
                    const nombre = typeof p === 'string' ? p : (p.nombre || p);
                    return nombre === nombrePlaga;
                });
                
                if (plaga) {
                    // Convertir a objeto si es string
                    if (typeof plaga === 'string') {
                        const index = selected.indexOf(plaga);
                        selected[index] = { nombre: nombrePlaga, comentarios: comentarios };
                    } else {
                        plaga.comentarios = comentarios;
                    }
                    
                    console.log('[PLAGAS] Comentarios guardados', { nombrePlaga, comentarios });
                }
            };
        }
        
        // Función para obtener plagas seleccionadas (retorna array de objetos {nombre, comentarios})
        window.obtenerPlagasSeleccionadas = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
            // Asegurar que todas las plagas estén en formato objeto
            return (selected || []).map(p => {
                if (typeof p === 'string') {
                    return { nombre: p, comentarios: '' };
                }
                return { nombre: p.nombre || p, comentarios: p.comentarios || '' };
            });
        };
        
        // Función para validar que todas las plagas tengan comentarios (obligatorio, excepto excepciones)
        window.validarComentariosPlagas = function(prefix) {
            const selected = prefix === 'edit' ? window.plagasSeleccionadasEdit : window.plagasSeleccionadasNew;
            const plagasSinComentarios = [];
            const excepciones = ['otra:', 'cliente no especificó'];
            
            selected.forEach(plagaObj => {
                const nombre = typeof plagaObj === 'string' ? plagaObj : (plagaObj.nombre || plagaObj);
                const comentarios = typeof plagaObj === 'object' && plagaObj.comentarios !== undefined ? plagaObj.comentarios : '';
                
                // Verificar si es excepción
                const esExcepcion = excepciones.some(exc => nombre.startsWith(exc));
                
                if (!esExcepcion && (!comentarios || comentarios.trim() === '')) {
                    plagasSinComentarios.push(nombre);
                    
                    // Marcar el textarea como inválido
                    const textarea = document.querySelector(`textarea[data-plaga-nombre="${nombre.replace(/"/g, '&quot;')}"][data-prefix="${prefix}"]`);
                    const errorMsg = document.getElementById(`errorComentariosPlaga-${prefix}-${nombre.replace(/[^a-zA-Z0-9]/g, '_')}`);
                    if (textarea) {
                        textarea.classList.add('is-invalid');
                        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    if (errorMsg) {
                        errorMsg.style.display = 'block';
                    }
                }
            });
            
            if (plagasSinComentarios.length > 0) {
                alert(`Por favor, complete los comentarios para las siguientes plagas:\n\n${plagasSinComentarios.join('\n')}\n\nLos comentarios son obligatorios para cada plaga (excepto "otra:" y "cliente no especificó").`);
                return false;
            }
            
            return true;
        };
        
        // Función para inicializar búsqueda de productos
        window.inicializarBusquedaProductos = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}ProductoSearch`);
            const dropdownMenu = document.getElementById(`${prefix}ProductosDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Producto`);
            const selectedDiv = document.getElementById(`${prefix}ProductosSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Función para renderizar opciones
            function renderizarOpciones(query = '') {
                const productos = window.todosLosProductos || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfabéticamente
                let productosFiltrados = productos;
                if (queryLower) {
                    productosFiltrados = productos.filter(prod => {
                        const nombre = (prod.nombre || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfabéticamente por nombre
                productosFiltrados.sort((a, b) => {
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener productos ya seleccionados
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                
                if (productosFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = productosFiltrados.map(prod => {
                    const yaSeleccionado = selected.some(p => (typeof p === 'object' ? p.id : p) === prod.id);
                    return `
                        <div class="dropdown-item" data-producto-id="${prod.id}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${prod.nombre || 'Sin nombre'}</span>
                                <span style="color: #6c757d; font-size: 0.9rem;">₡${(prod.precio_venta || 0).toLocaleString('es-CR')}</span>
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const productoId = item.getAttribute('data-producto-id');
                            agregarProducto(productoId, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para búsqueda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarProducto(productoId, prefix) {
                const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
                if (selected.some(p => (typeof p === 'object' ? p.id : p) === productoId)) return;
                
                const producto = window.todosLosProductos.find(p => p.id === productoId);
                if (!producto) return;
                
                const precioDefault = producto.costo ?? producto.precio_venta ?? producto.precio ?? 0;
                selected.push({ id: productoId, cantidad: 1, precio: Number(precioDefault) || 0 });
                
                if (window.renderizarTablaProductos) {
                    window.renderizarTablaProductos(prefix);
                }
                if (prefix === 'edit' && window.actualizarResumenFinanciero) {
                    window.actualizarResumenFinanciero();
                } else if (prefix === 'new' && window.actualizarResumenFinancieroNew) {
                    window.actualizarResumenFinancieroNew();
                }
            }
        }
        
        // Actualizar función obtenerServiciosSeleccionados
        // Devuelve array de objetos {id, precio} para mantener precios personalizados por cita
        window.obtenerServiciosSeleccionados = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
            // Asegurar que todos los servicios estén en formato objeto con cantidad, precio y comentarios
            return selected.map(serv => {
                if (typeof serv === 'string') {
                    // Convertir string a objeto con precio del servicio base
                    const servicio = window.todosLosServicios.find(s => s.id === serv);
                    return {
                        id: serv,
                        cantidad: 1,
                        precio: servicio?.precio || 0,
                        comentarios: ''
                    };
                }
                // Asegurar que tenga cantidad, precio y comentarios
                if (typeof serv === 'object') {
                    if (serv.cantidad === undefined) {
                        serv.cantidad = 1;
                    }
                    if (serv.comentarios === undefined) {
                        serv.comentarios = '';
                    }
                }
                return serv; // Ya es un objeto
            });
        };
        
        // Actualizar función obtenerProductosSeleccionados
        window.obtenerProductosSeleccionados = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.productosSeleccionadosEdit : window.productosSeleccionadosNew;
            return [...selected];
        };
        
        // Función para inicializar búsqueda de equipo
        window.inicializarBusquedaEquipo = function(prefix = 'edit') {
            const searchInput = document.getElementById(`${prefix}EquipoSearch`);
            const dropdownMenu = document.getElementById(`${prefix}EquipoDropdownMenu`);
            const noResults = document.getElementById(`noResults${prefix === 'edit' ? 'Edit' : 'New'}Equipo`);
            const selectedDiv = document.getElementById(`${prefix}EquipoSelected`);
            
            if (!searchInput || !dropdownMenu || !selectedDiv) return;
            
            // Inicializar arrays si no existen
            if (prefix === 'edit' && !window.equipoSeleccionadoEdit) {
                window.equipoSeleccionadoEdit = [];
            } else if (prefix === 'new' && !window.equipoSeleccionadoNew) {
                window.equipoSeleccionadoNew = [];
            }
            
            // Función para renderizar opciones
            function renderizarOpciones(query = '') {
                const equipos = window.todosLosEquipos || [];
                const queryLower = query.trim().toLowerCase();
                
                // Filtrar y ordenar alfabéticamente
                let equiposFiltrados = equipos;
                if (queryLower) {
                    equiposFiltrados = equipos.filter(equipo => {
                        const nombre = (equipo.nombre || '').toLowerCase();
                        return nombre.includes(queryLower);
                    });
                }
                
                // Ordenar alfabéticamente por nombre
                equiposFiltrados.sort((a, b) => {
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                // Obtener equipo ya seleccionado
                const selectedArray = prefix === 'edit' ? window.equipoSeleccionadoEdit : window.equipoSeleccionadoNew;
                
                if (equiposFiltrados.length === 0) {
                    dropdownMenu.style.display = 'block';
                    noResults.style.display = 'block';
                    dropdownMenu.innerHTML = '';
                    dropdownMenu.appendChild(noResults);
                    return;
                }
                
                noResults.style.display = 'none';
                dropdownMenu.innerHTML = equiposFiltrados.map(equipo => {
                    const yaSeleccionado = selectedArray.includes(equipo.id);
                    return `
                        <div class="dropdown-item" data-equipo-id="${equipo.id}" style="cursor: ${yaSeleccionado ? 'not-allowed' : 'pointer'}; padding: 0.75rem; ${yaSeleccionado ? 'opacity: 0.5; background-color: #f5f5f5;' : ''}" ${yaSeleccionado ? 'onclick="return false;"' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #000000;">${equipo.nombre || 'Sin nombre'}</span>
                            </div>
                            ${yaSeleccionado ? '<small style="color: #6c757d; font-size: 0.75rem;">Ya seleccionado</small>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Agregar event listeners a las opciones
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.style.cursor !== 'not-allowed') {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const equipoId = item.getAttribute('data-equipo-id');
                            agregarEquipo(equipoId, prefix);
                            searchInput.value = '';
                            dropdownMenu.style.display = 'none';
                        });
                    }
                });
                
                dropdownMenu.style.display = 'block';
            }
            
            // Event listener para búsqueda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                renderizarOpciones(query);
            });
            
            // Mostrar todas las opciones al hacer focus
            searchInput.addEventListener('focus', () => {
                renderizarOpciones(searchInput.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            function agregarEquipo(equipoId, prefix) {
                const selectedArray = prefix === 'edit' ? window.equipoSeleccionadoEdit : window.equipoSeleccionadoNew;
                if (selectedArray.includes(equipoId)) return;
                
                const equipo = window.todosLosEquipos.find(e => e.id === equipoId);
                if (!equipo) return;
                
                selectedArray.push(equipoId);
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.style.cssText = 'background: #c8e6c9; color: #000000; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;';
                badge.setAttribute('data-equipo-id', equipoId);
                badge.innerHTML = `${equipo.nombre} <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;"></i>`;
                badge.querySelector('i').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = selectedArray.indexOf(equipoId);
                    if (index > -1) selectedArray.splice(index, 1);
                    badge.remove();
                });
                selectedDiv.appendChild(badge);
            }
        };
        
        // Función para obtener equipo seleccionado
        window.obtenerEquipoSeleccionado = function(prefix = 'edit') {
            const selected = prefix === 'edit' ? window.equipoSeleccionadoEdit : window.equipoSeleccionadoNew;
            return selected ? [...selected] : [];
        };
        
        // Variables globales para almacenar selecciones de equipo
        window.equipoSeleccionadoEdit = [];
        window.equipoSeleccionadoNew = [];
        
        // Función para generar certificado de fumigación
        window.generarCertificadoFumigacion = function(textoCertificado, fechaInicio, duracion, prefix = 'edit') {
            if (!textoCertificado || !textoCertificado.trim()) {
                alert('Por favor ingrese el texto para el certificado');
                return;
            }
            
            // Verificar que jsPDF esté disponible
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('Error: La librería jsPDF no está disponible. Por favor recargue la página.');
                return;
            }
            
            // Obtener fecha y hora de la cita
            const fecha = fechaInicio ? new Date(fechaInicio) : new Date();
            const fechaFormateada = fecha.toLocaleDateString('es-CR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const horaFormateada = fecha.toLocaleTimeString('es-CR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Dividir el texto en líneas/párrafos para generar múltiples certificados
            const textosCertificados = textoCertificado.split('\n').filter(t => t.trim());
            if (textosCertificados.length === 0) {
                textosCertificados.push(textoCertificado.trim());
            }
            
            // Generar un certificado por cada texto
            textosCertificados.forEach((texto, index) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuración de márgenes
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const contentWidth = pageWidth - (margin * 2);
                
                let yPos = margin;
                
                // Título del certificado
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('CERTIFICADO DE FUMIGACIÓN', pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;
                
                // Línea divisoria
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
                
                // Información de la empresa
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Ecofumigadora Ecoplagas SRL', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('Cédula Jurídica: 3-102-850026-6', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('Autorizado por Ministerio de Salud de Costa Rica', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('Autorizado por Colegio de Químicos de Costa Rica', pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;
                
                // Línea divisoria
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
                
                // Cuerpo del certificado
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                const textoCertificadoCompleto = `Por medio del presente, certifico que el día ${fechaFormateada} a las ${horaFormateada}, se realizó un servicio de fumigación en:\n\n${texto.trim()}\n\nEl servicio fue realizado por personal técnico capacitado y autorizado, utilizando productos químicos registrados y aprobados por el Ministerio de Salud de Costa Rica.`;
                
                // Dividir el texto en líneas que quepan en el ancho de la página
                const lines = doc.splitTextToSize(textoCertificadoCompleto, contentWidth);
                
                lines.forEach(line => {
                    if (yPos > pageHeight - margin - 20) {
                        doc.addPage();
                        yPos = margin;
                    }
                    doc.text(line, margin, yPos);
                    yPos += 7;
                });
                
                yPos += 10;
                
                // Información adicional
                if (yPos > pageHeight - margin - 40) {
                    doc.addPage();
                    yPos = margin;
                }
                
                doc.setFontSize(10);
                doc.text('Este certificado tiene validez legal y está respaldado por:', margin, yPos);
                yPos += 7;
                doc.text('• Ministerio de Salud de Costa Rica - Registro No. MS-2024-001234', margin + 5, yPos);
                yPos += 7;
                doc.text('• Colegio de Químicos de Costa Rica - Licencia No. CQCR-2024-005678', margin + 5, yPos);
                yPos += 7;
                doc.text('• Certificado de Buenas Prácticas - No. BPM-2024-009012', margin + 5, yPos);
                yPos += 15;
                
                // Firma y sello
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Firma y Sello:', margin, yPos);
                yPos += 20;
                
                doc.setFont(undefined, 'normal');
                doc.text('_________________________', margin, yPos);
                yPos += 7;
                doc.text('Técnico Autorizado', margin, yPos);
                yPos += 7;
                doc.text('Ecofumigadora Ecoplagas SRL', margin, yPos);
                yPos += 7;
                doc.text(`Fecha de emisión: ${new Date().toLocaleDateString('es-CR')}`, margin, yPos);
                
                // Guardar el PDF
                const nombreArchivo = `Certificado_Fumigacion_${fecha.toISOString().split('T')[0]}_${index + 1}.pdf`;
                doc.save(nombreArchivo);
            });
            
            if (textosCertificados.length > 1) {
                alert(`Se generaron ${textosCertificados.length} certificados`);
            }
        };
        
        // Hacer cargarEmpleados global también
        window.cargarEmpleados = cargarEmpleados;
        
        // Alias para uso dentro del módulo
        const renderizarVendedoresCheckboxes = window.renderizarVendedoresCheckboxes;
        const obtenerVendedoresSeleccionados = window.obtenerVendedoresSeleccionados;

        // Estándar: solo inicio_gmt6 y duracion_minutos (igual que CSV y formularios)
        window.obtenerInicio = function(cita) {
            return cita.inicio_gmt6 ?? null;
        };
        
        window.obtenerDuracion = function(cita) {
            return cita.duracion_minutos ?? 60;
        };
        
        // Función para obtener el nombre del cliente desde el documento del cliente
        // Fuente de verdad: clientes/{telefono}.nombre
        window.obtenerClienteNombre = async function(cita) {
            // Obtener teléfono desde la fuente de verdad (cita.telefono)
            const telefono = window.obtenerTelefono(cita);
            if (telefono) {
                try {
                    const cliente = await window.buscarCliente(telefono);
                    if (cliente && cliente.nombre) {
                        return cliente.nombre;
                    }
                } catch (error) {
                    console.warn('Error obteniendo nombre del cliente:', error);
                }
            }
            
            // Estándar: solo metadata.cliente_nombre (igual que CSV)
            return window.obtenerCampoCita(cita, 'cliente_nombre', '') || 'Sin nombre';
        };
        
        // Versión síncrona: mismo campo que CSV (metadata.cliente_nombre)
        window.obtenerClienteNombreSync = function(cita) {
            if (!cita) return 'Sin nombre';
            const nombre = window.obtenerCampoCita(cita, 'cliente_nombre', '');
            return (typeof nombre === 'string' ? nombre : '') || 'Sin nombre';
        };
        
        // Obtener teléfono de la cita (solo cita.telefono).
        window.obtenerTelefono = function(cita) {
            return cita.telefono || '';
        };
        
        window.obtenerRuta = function(cita) {
            const ruta = window.obtenerCampoCita(cita, 'ruta', 'Sin asignar');
            // Normalizar ruta: convertir "9" a "Ruta 9", etc.
            if (ruta && ruta !== 'Sin asignar' && ruta !== null && ruta !== undefined) {
                // Si es un número o string numérico, convertirlo a "Ruta X"
                const rutaStr = String(ruta).trim();
                const numeroRuta = parseInt(rutaStr);
                if (!isNaN(numeroRuta) && numeroRuta >= 1 && numeroRuta <= 20) {
                    return `Ruta ${numeroRuta}`;
                }
                // Si ya está en formato "Ruta X", validarlo
                if (window.validarRuta) {
                    return window.validarRuta(rutaStr);
                }
                // Si contiene "Ruta", retornarlo tal cual
                if (rutaStr.toLowerCase().includes('ruta')) {
                    return rutaStr;
                }
            }
            return ruta || 'Sin asignar';
        };
        
        // Alias para compatibilidad: obtenerVehiculo es lo mismo que obtenerRuta
        // TODO: Verificar si obtenerVehiculo se usa en el código, si no, eliminar este alias
        window.obtenerVehiculo = window.obtenerRuta;
        
        // ============================================
        // FUNCIONES PARA CLIENTES Y SUCURSALES
        // ============================================
        
        // Función para normalizar teléfono (agregar 506 si no está)
        window.normalizarTelefono = function(telefono) {
            if (!telefono) return '';
            // Remover espacios, guiones, paréntesis
            let limpio = telefono.replace(/[\s\-\(\)]/g, '');
            // Si empieza con 506, removerlo para normalizar
            if (limpio.startsWith('506')) {
                limpio = limpio.substring(3);
            }
            // Validar que sean solo 8 dígitos
            if (!/^\d{8}$/.test(limpio)) {
                return null; // Teléfono inválido
            }
            // Retornar con 506
            return '506' + limpio;
        };
        
        // Función para formatear teléfono para mostrar
        window.formatearTelefono = function(telefono) {
            if (!telefono) return '';
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return telefono;
            const sin506 = normalizado.substring(3);
            return `506-${sin506.substring(0, 4)}-${sin506.substring(4)}`;
        };
        
        // Función para generar link de WhatsApp
        window.generarLinkWhatsApp = function(telefono, mensaje = '') {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return '';
            const mensajeEncoded = mensaje ? encodeURIComponent(mensaje) : '';
            return `https://wa.me/${normalizado}${mensajeEncoded ? '?text=' + mensajeEncoded : ''}`;
        };
        
        // Función para buscar cliente por teléfono
        window.buscarCliente = async function(telefono) {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return null;
            
            try {
                const clienteDoc = await getDoc(doc(window.db, 'clientes', normalizado));
                if (clienteDoc.exists()) {
                    return { id: clienteDoc.id, ...clienteDoc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error buscando cliente:', error);
                return null;
            }
        };
        
        // Función para cargar sucursales de un cliente
        window.cargarSucursalesCliente = async function(telefono) {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) return [];
            
            try {
                const cliente = await window.buscarCliente(telefono);
                if (!cliente || !cliente.sucursales || cliente.sucursales.length === 0) {
                    return [];
                }
                
                // Cargar todas las sucursales usando el formato: telefono_indice
                const sucursalesPromises = cliente.sucursales.map(indice => {
                    const indiceFormateado = String(indice).padStart(3, '0');
                    return getDoc(doc(window.db, 'sucursales', `${normalizado}_${indiceFormateado}`));
                });
                const sucursalesDocs = await Promise.all(sucursalesPromises);
                
                return sucursalesDocs
                    .filter(doc => doc.exists())
                    .map(doc => ({ indice: doc.data().indice, id: doc.id, ...doc.data() }))
                    .sort((a, b) => {
                        // Ordenar por índice (ascendente)
                        return a.indice - b.indice;
                    });
            } catch (error) {
                console.error('Error cargando sucursales:', error);
                return [];
            }
        };
        
        // Función para poblar select de sucursales
        window.cargarSucursalesEnSelect = async function(selectId, telefono, sucursalIndiceSeleccionada = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Cargando...</option>';
            
            const sucursales = await window.cargarSucursalesCliente(telefono);
            
            if (sucursales.length === 0) {
                select.innerHTML = '<option value="nueva">Crear nueva sucursal</option>';
                return;
            }
            
            select.innerHTML = '';
            sucursales.forEach(sucursal => {
                const option = document.createElement('option');
                option.value = sucursal.indice; // Usar índice en lugar de ID
                const indiceFormateado = String(sucursal.indice).padStart(3, '0');
                const fechaUltima = sucursal.fechaUltimaFumigacion ? 
                    sucursal.fechaUltimaFumigacion.toDate ? 
                        sucursal.fechaUltimaFumigacion.toDate().toLocaleDateString('es-CR') : 
                        new Date(sucursal.fechaUltimaFumigacion).toLocaleDateString('es-CR') : 
                    '';
                option.textContent = `${indiceFormateado} - ${sucursal.nombre}${fechaUltima ? ' (Última: ' + fechaUltima + ')' : ''}`;
                if (sucursal.indice === sucursalIndiceSeleccionada) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Agregar opción para nueva sucursal
            const optionNueva = document.createElement('option');
            optionNueva.value = 'nueva';
            optionNueva.textContent = '+ Crear nueva sucursal';
            select.appendChild(optionNueva);
        };
        
        // Función para crear cliente
        window.crearCliente = async function(telefono, nombreCliente = '') {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) throw new Error('Teléfono inválido');
            
            const sin506 = normalizado.substring(3);
            const telefonoFormateado = `${sin506.substring(0, 4)}-${sin506.substring(4)}`;
            
            const clienteData = {
                telefono: normalizado,
                telefonoFormateado: telefonoFormateado,
                nombre: nombreCliente || '',
                fechaCreacion: serverTimestamp(),
                fechaUltimaActualizacion: serverTimestamp(),
                totalCitas: 0,
                sucursales: [] // Array de índices: [0, 1, 2, 3, ...] (empiezan en 0)
            };
            
            await setDoc(doc(window.db, 'clientes', normalizado), clienteData);
            return { id: normalizado, ...clienteData };
        };
        
        // Función para actualizar el nombre del cliente
        window.actualizarNombreCliente = async function(telefono, nombre) {
            const normalizado = window.normalizarTelefono(telefono);
            if (!normalizado) {
                throw new Error('Teléfono inválido');
            }
            
            try {
                await updateDoc(doc(window.db, 'clientes', normalizado), {
                    nombre: nombre,
                    fechaUltimaActualizacion: serverTimestamp()
                });
                console.log('✅ Nombre del cliente actualizado:', nombre);
            } catch (error) {
                console.error('❌ Error actualizando nombre del cliente:', error);
                throw error;
            }
        };
        
        // Función para crear sucursal
        window.crearSucursal = async function(clienteTelefono, nombre, coordenadas, provinciaId, cantonId, distritoId, direccion, otrasSenas) {
            const normalizado = window.normalizarTelefono(clienteTelefono);
            if (!normalizado) throw new Error('Teléfono inválido');
            
            // Verificar que el cliente exista
            let cliente = await window.buscarCliente(clienteTelefono);
            if (!cliente) {
                cliente = await window.crearCliente(clienteTelefono);
            }
            
            // Calcular el siguiente índice (empezando de 0)
            const indicesExistentes = cliente.sucursales || [];
            const siguienteIndice = indicesExistentes.length > 0 ? Math.max(...indicesExistentes) + 1 : 0;
            const indiceFormateado = String(siguienteIndice).padStart(3, '0');
            
            // Validar que se proporcione un nombre (obligatorio)
            if (!nombre || nombre.trim() === '') {
                nombre = 'Hogar principal'; // Valor por defecto si está vacío
            }
            
            // Las coordenadas GPS son opcionales al crear
            
            // ID de la sucursal: telefono_indice (ej: "50612345678_001")
            const sucursalId = `${normalizado}_${indiceFormateado}`;
            
            const sucursalData = {
                clienteTelefono: normalizado,
                indice: siguienteIndice, // Índice numérico: 0, 1, 2, 3, ...
                nombre: nombre.trim() || 'Hogar principal',
                coordenadas: window.sonCoordenadasValidas(coordenadas) ? {
                    lat: coordenadas.lat,
                    lng: coordenadas.lng,
                    texto: `${coordenadas.lat}, ${coordenadas.lng}`
                } : null,
                provinciaId: provinciaId || '',
                cantonId: cantonId || '',
                distritoId: distritoId || '',
                direccion: direccion || '',
                otras_senas: otrasSenas || '',
                fechaCreacion: serverTimestamp(),
                fechaUltimaFumigacion: null,
                totalFumigaciones: 0
                // citas: [] removido - no se requiere guardar registro de citas en sucursal
            };
            
            await setDoc(doc(window.db, 'sucursales', sucursalId), sucursalData);
            
            // Actualizar cliente para agregar el índice de la sucursal
            const sucursalesActualizadas = [...(cliente.sucursales || []), siguienteIndice];
            await updateDoc(doc(window.db, 'clientes', normalizado), {
                sucursales: sucursalesActualizadas,
                fechaUltimaActualizacion: serverTimestamp()
            });
            
            return { id: sucursalId, indice: siguienteIndice, ...sucursalData };
        };
        
        // Función para actualizar sucursal
        window.actualizarSucursal = async function(clienteTelefono, indice, datos) {
            const normalizado = window.normalizarTelefono(clienteTelefono);
            if (!normalizado) throw new Error('Teléfono inválido');
            
            const indiceFormateado = String(indice).padStart(3, '0');
            const sucursalId = `${normalizado}_${indiceFormateado}`;
            
            const datosActualizacion = {
                ...datos,
                fechaUltimaActualizacion: serverTimestamp()
            };
            await updateDoc(doc(window.db, 'sucursales', sucursalId), datosActualizacion);
        };
        
        // Función para obtener sucursal por índice
        window.obtenerSucursalPorIndice = async function(clienteTelefono, indice) {
            const normalizado = window.normalizarTelefono(clienteTelefono);
            if (!normalizado) return null;
            
            const indiceFormateado = String(indice).padStart(3, '0');
            const sucursalId = `${normalizado}_${indiceFormateado}`;
            
            try {
                const sucursalDoc = await getDoc(doc(window.db, 'sucursales', sucursalId));
                if (sucursalDoc.exists()) {
                    return { indice: indice, id: sucursalDoc.id, ...sucursalDoc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error obteniendo sucursal:', error);
                return null;
            }
        };
        
        // ============================================
        // FUNCIONES HELPER GENÉRICAS
        // ============================================
        
        /**
         * Función genérica para obtener campos de cita con fallback
         * Prioridad: metadata.campo > campo_legacy > valorDefault
         * @param {Object} cita - Objeto cita
         * @param {string} campo - Nombre del campo en metadata
         * @param {*} valorDefault - Valor por defecto si no existe
         * @returns {*} Valor del campo o valor por defecto
         */
        window.obtenerCampoCita = function(cita, campo, valorDefault = null) {
            // Usar nullish coalescing (??) para distinguir entre undefined/null y valores falsy válidos (0, '', false)
            let v = cita.metadata?.[campo] ?? cita[campo] ?? valorDefault;
            // Legacy: nombre antiguo del campo (solo para otras_senas)
            if ((v === null || v === undefined) && campo === 'otras_senas') {
                v = cita.metadata?.otras_señas ?? cita.otras_señas ?? valorDefault;
            }
            return v;
        };
        
        /**
         * Verificar si un índice de sucursal es válido (no es null ni undefined)
         * @param {number|null|undefined} sucursalIndice - Índice de sucursal
         * @returns {boolean} true si el índice es válido
         */
        window.esSucursalIndiceValido = function(sucursalIndice) {
            return sucursalIndice !== null && sucursalIndice !== undefined;
        };
        
        /**
         * Verificar si un objeto coordenadas es válido (tiene lat y lng)
         * @param {Object|null|undefined} coordenadas - Objeto coordenadas
         * @returns {boolean} true si las coordenadas son válidas
         */
        window.sonCoordenadasValidas = function(coordenadas) {
            return !!(coordenadas?.lat && coordenadas?.lng);
        };
        
        // ============================================
        // FUNCIONES HELPER ESPECÍFICAS (usando genérica)
        // ============================================
        
        window.obtenerEstado = function(cita) {
            return window.obtenerCampoCita(cita, 'estado', 'agendada');
        };

        /** Confirmada dentro de 24-48h: { confirmada: boolean, timestamp: string|null } */
        window.obtenerConfirmada24_48 = function(cita) {
            const d = window.obtenerCampoCita(cita, 'confirmada24_48', null);
            if (!d || typeof d !== 'object') return { confirmada: false, timestamp: null };
            return { confirmada: !!d.confirmada, timestamp: d.timestamp || null };
        };

        /** Para indicadores: ventana de confirmación (48h antes o después) y si la cita ya pasó. */
        window.indicadoresVentanasCita = function(cita) {
            const inicio = window.obtenerInicio ? window.obtenerInicio(cita) : null;
            const inicioCitaMs = inicio && (typeof inicio.toMillis === 'function' ? inicio.toMillis() : (inicio.seconds != null ? inicio.seconds * 1000 : null));
            const nowMs = Date.now();
            const MS_48H = 48 * 60 * 60 * 1000;
            const dentroVentanaConfirmacion = inicioCitaMs != null && (nowMs >= inicioCitaMs - MS_48H);
            const citaYaPasada = inicioCitaMs != null && nowMs >= inicioCitaMs;
            return { inicioCitaMs, nowMs, dentroVentanaConfirmacion, citaYaPasada };
        };

        /** Horas hasta el inicio de la cita (puede ser negativo si ya pasó). Acepta Firestore Timestamp o Date. */
        window.horasHastaCita = function(inicioCita) {
            if (!inicioCita) return Infinity;
            let ms = null;
            if (typeof inicioCita.toMillis === 'function') ms = inicioCita.toMillis();
            else if (inicioCita.seconds != null) ms = inicioCita.seconds * 1000;
            else if (inicioCita instanceof Date) ms = inicioCita.getTime();
            else if (typeof inicioCita === 'number') ms = inicioCita;
            if (ms == null) return Infinity;
            return (ms - Date.now()) / (1000 * 60 * 60);
        };

        /** Para mostrar en UI: { texto: 'Agendada'|'Confirmada 24-48h', clase: 'agendada'|'confirmada-24-48' } */
        window.estadoDisplayCita = function(cita) {
            const c = window.obtenerConfirmada24_48 && window.obtenerConfirmada24_48(cita);
            return (c && c.confirmada) ? { texto: 'Confirmada 24-48h', clase: 'confirmada-24-48' } : { texto: 'Agendada', clase: 'agendada' };
        };

        /** Actualiza habilitación del switch "Confirmada 24-48h" en formulario Editar según fecha/hora actual del campo. */
        window.actualizarHabilitacionConfirmada24_48Edit = function() {
            const editStartTime = document.getElementById('editStartTime');
            const sw = document.getElementById('editConfirmada24_48');
            const msg = document.getElementById('editConfirmada24_48Mensaje');
            if (!editStartTime || !sw || !msg) return;
            const val = (editStartTime.value || '').trim();
            if (!val) {
                sw.disabled = true;
                msg.textContent = 'Indique fecha y hora de la cita.';
                return;
            }
            const d = new Date(val);
            if (isNaN(d.getTime())) {
                sw.disabled = true;
                msg.textContent = 'Fecha/hora no válida.';
                return;
            }
            const horas = (d.getTime() - Date.now()) / (1000 * 60 * 60);
            const dentro48h = horas > 0 && horas <= 48;
            sw.disabled = !dentro48h;
            msg.textContent = dentro48h ? '' : 'Solo se puede activar cuando faltan menos de 48 horas para la cita.';
        };

        /** Actualiza habilitación del switch "Confirmada 24-48h" en formulario Nueva cita según fecha/hora elegida. */
        window.actualizarHabilitacionConfirmada24_48New = function() {
            const newStartTime = document.getElementById('newStartTime');
            const sw = document.getElementById('newConfirmada24_48');
            const msg = document.getElementById('newConfirmada24_48Mensaje');
            if (!newStartTime || !sw || !msg) return;
            const val = (newStartTime.value || '').trim();
            if (!val) {
                sw.disabled = true;
                msg.textContent = 'Elija fecha y hora de la cita para activar esta opción.';
                return;
            }
            const d = new Date(val);
            if (isNaN(d.getTime())) {
                sw.disabled = true;
                msg.textContent = 'Fecha/hora no válida.';
                return;
            }
            const horas = (d.getTime() - Date.now()) / (1000 * 60 * 60);
            const dentro48h = horas > 0 && horas <= 48;
            sw.disabled = !dentro48h;
            msg.textContent = dentro48h ? '' : 'Solo se puede activar cuando faltan menos de 48 horas para la cita.';
        };
        
        window.obtenerMonto = function(cita) {
            return window.obtenerCampoCita(cita, 'monto', 0);
        };
        
        // Función para calcular la ganancia neta de una cita
        // Los servicios son ganancia (ingresos), no costos
        // Ganancia neta = Servicios + Productos + Costo del servicio
        window.obtenerGananciaNeta = function(cita) {
            if (!cita) {
                console.warn('⚠️ [obtenerGananciaNeta] Cita no proporcionada');
                return 0;
            }
            
            // Calcular total de servicios (suma de precios de servicios seleccionados - estos son ganancia)
            const servicios = window.obtenerServicios ? window.obtenerServicios(cita) : [];
            let totalServicios = 0;
            if (Array.isArray(servicios)) {
                servicios.forEach(serv => {
                    if (typeof serv === 'object') {
                        if (serv.precio !== undefined) {
                            // Servicio con precio personalizado
                            const cantidad = serv.cantidad || 1;
                            const precioServicio = (serv.precio || 0) * cantidad;
                            totalServicios += precioServicio;
                            console.log('🔍 [obtenerGananciaNeta] Servicio con precio:', { precio: serv.precio, cantidad, total: precioServicio });
                        } else if (serv.id) {
                            // Objeto con id pero sin precio, buscar precio en todosLosServicios
                            if (window.todosLosServicios) {
                                const servicio = window.todosLosServicios.find(s => s.id === serv.id);
                                if (servicio) {
                                    const cantidad = serv.cantidad || 1;
                                    const precioServicio = (servicio.precio || 0) * cantidad;
                                    totalServicios += precioServicio;
                                    console.log('🔍 [obtenerGananciaNeta] Servicio objeto con ID:', { id: serv.id, cantidad, precio: servicio.precio, total: precioServicio });
                                }
                            }
                        }
                    } else if (typeof serv === 'string') {
                        // ID de servicio, buscar precio en todosLosServicios
                        if (window.todosLosServicios) {
                            const servicio = window.todosLosServicios.find(s => s.id === serv);
                            if (servicio) {
                                const precioServicio = servicio.precio || 0;
                                totalServicios += precioServicio;
                                console.log('🔍 [obtenerGananciaNeta] Servicio por ID string:', { id: serv, precio: precioServicio });
                            }
                        }
                    }
                });
            }
            console.log('🔍 [obtenerGananciaNeta] Total servicios:', totalServicios);
            
            // Calcular total de productos (precio cobrado en la cita x cantidad)
            const productos = window.obtenerProductos ? window.obtenerProductos(cita) : [];
            let totalProductos = 0;
            if (Array.isArray(productos)) {
                productos.forEach(item => {
                    const productoId = typeof item === 'object' ? item.id : item;
                    const cantidad = typeof item === 'object' ? (item.cantidad || 1) : 1;
                    let precioUnitario = 0;
                    if (typeof item === 'object' && item.precio !== undefined) {
                        precioUnitario = item.precio;
                    } else if (window.todosLosProductos) {
                        const producto = window.todosLosProductos.find(p => p.id === productoId);
                        if (producto) precioUnitario = producto.costo ?? producto.precio_venta ?? producto.precio ?? 0;
                    }
                    const costoProducto = precioUnitario * cantidad;
                    totalProductos += costoProducto;
                });
            }
            console.log('🔍 [obtenerGananciaNeta] Total productos:', totalProductos);
            
            // Monto de venta = Servicios + Productos (MECE)
            const gananciaNeta = totalServicios + totalProductos;
            console.log('🔍 [obtenerGananciaNeta] Monto (Servicios + Productos):', gananciaNeta);
            return gananciaNeta;
        };
        
        // Función para formatear número con símbolo ₡ y puntos para miles
        window.formatearMontoVenta = function(valor) {
            // Convertir a número si es string
            let numero = typeof valor === 'string' ? parseFloat(valor.toString().replace(/[^\d.-]/g, '')) : valor;
            
            // Si no es un número válido, retornar cadena vacía
            if (isNaN(numero) || numero === null || numero === undefined) {
                return '';
            }
            
            // Si el número es 0, también retornar cadena vacía (no mostrar ₡0)
            if (numero === 0) {
                return '';
            }
            
            // Formatear con puntos para miles
            const numeroFormateado = Math.abs(numero).toLocaleString('es-CR');
            const signo = numero < 0 ? '-' : '';
            return `${signo}₡${numeroFormateado}`;
        };
        
        // Función para extraer el valor numérico sin formato
        window.extraerValorNumerico = function(valor) {
            if (!valor || valor === '') {
                return '0';
            }
            // Extraer solo números
            const numero = valor.toString().replace(/[^\d]/g, '');
            return numero || '0';
        };
        
        window.obtenerCostoServicio = function(cita) {
            return window.obtenerCampoCita(cita, 'costo_servicio', 0);
        };
        
        window.obtenerVendedores = function(cita) {
            return window.obtenerCampoCita(cita, 'vendedores', []);
        };

        /** Dado un username (ej. maria.gutierrez) devuelve el nombre para mostrar: primerNombre o nombre completo o el username */
        window.obtenerNombreDisplayVendedor = function(username) {
            if (!username || typeof username !== 'string') return 'Sin vendedor';
            const emp = window.empleados && window.empleados.find(e => (e.username || e.id) === username);
            if (!emp) return username;
            const nombreCompleto = `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim();
            return emp.primerNombre || nombreCompleto || username;
        };

        /** Devuelve HTML del badge negro con el nombre del vendedor (o varios separados por coma) */
        window.vendedorBadgeHtml = function(cita) {
            const vendedores = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
            const nombres = (Array.isArray(vendedores) ? vendedores : []).map(v => window.obtenerNombreDisplayVendedor(v && String(v).trim())).filter(Boolean);
            const texto = nombres.length > 0 ? nombres.join(', ') : 'Sin vendedor';
            return '<span class="vendedor-badge">' + texto.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
        };
        
        window.obtenerDireccion = function(cita) {
            return window.obtenerCampoCita(cita, 'direccion', '');
        };
        
        // Descargar CSV del mes (mismo formato que "Descargar agenda para ventas Ecoplagas Online") usando datos de Firebase
        window.descargarCSVAgendaMesFirebase = function(fechaMes) {
            const citas = window.todasLasCitas || [];
            const fecha = fechaMes || window.diaSeleccionado || new Date();
            const year = fecha.getFullYear();
            const month = fecha.getMonth();
            const obtenerInicio = window.obtenerInicio;
            const formatearFecha = window.formatearFecha;
            const citasDelMes = citas.filter(cita => {
                const inicio = obtenerInicio && obtenerInicio(cita);
                if (!inicio) return false;
                const d = formatearFecha && formatearFecha(inicio);
                if (!d) return false;
                return d.getFullYear() === year && d.getMonth() === month;
            });
            citasDelMes.sort((a, b) => {
                const msA = (a.inicio_gmt6 && (a.inicio_gmt6.toMillis ? a.inicio_gmt6.toMillis() : (a.inicio_gmt6.seconds * 1000))) || 0;
                const msB = (b.inicio_gmt6 && (b.inicio_gmt6.toMillis ? b.inicio_gmt6.toMillis() : (b.inicio_gmt6.seconds * 1000))) || 0;
                return msA - msB;
            });
            function formatoInicioGMT6(cita) {
                const ts = cita.inicio_gmt6;
                const ms = ts && (ts.toMillis ? ts.toMillis() : (ts.seconds * 1000)) || 0;
                const d = new Date(ms - 6 * 60 * 60 * 1000);
                const pad = n => String(n).padStart(2, '0');
                return d.getUTCFullYear() + '-' + pad(d.getUTCMonth() + 1) + '-' + pad(d.getUTCDate()) + 'T' + pad(d.getUTCHours()) + ':' + pad(d.getUTCMinutes()) + ':' + pad(d.getUTCSeconds()) + '-06:00';
            }
            function escaparCSV(val) {
                const s = val == null ? '' : String(val);
                if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            }
            const header = 'telefono,inicio_gmt6,duracion_minutos,vehiculo,cliente_nombre,estado,monto,ruta,iniciales,vendedores,observaciones,Dia';
            const lineas = [header];
            citasDelMes.forEach(cita => {
                const telefono = (cita.telefono || '').toString().trim();
                const inicio_gmt6 = formatoInicioGMT6(cita);
                const duracion_minutos = cita.duracion_minutos ?? 60;
                const vehiculo = window.obtenerCampoCita(cita, 'vehiculo', '') || '';
                const cliente_nombre = window.obtenerCampoCita(cita, 'cliente_nombre', '') || '';
                const estado = window.obtenerCampoCita(cita, 'estado', 'agendada') || 'agendada';
                const monto = window.obtenerMonto ? window.obtenerMonto(cita) : (window.obtenerCampoCita(cita, 'monto', 0) || 0);
                let ruta = window.obtenerRuta ? window.obtenerRuta(cita) : (window.obtenerCampoCita(cita, 'ruta', '') || '');
                if (typeof ruta === 'string' && /^\d+$/.test(ruta)) { /* ya es número */ } else if (typeof ruta === 'string') ruta = ruta.replace(/\D/g, '') || ruta; else ruta = ruta != null ? String(ruta) : '';
                const iniciales = window.obtenerCampoCita(cita, 'iniciales', '') || '';
                let vendedores = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                if (!Array.isArray(vendedores)) vendedores = vendedores ? [vendedores] : [];
                const vendedoresStr = vendedores.map(v => (v && String(v).trim()) || '').filter(Boolean).join(', ');
                const observaciones = window.obtenerCampoCita(cita, 'observaciones', '') || '';
                const diaStr = inicio_gmt6.slice(0, 10);
                lineas.push([telefono, inicio_gmt6, duracion_minutos, escaparCSV(vehiculo), escaparCSV(cliente_nombre), estado, monto, ruta, escaparCSV(iniciales), escaparCSV(vendedoresStr), escaparCSV(observaciones), diaStr].join(','));
            });
            const csv = lineas.join('\r\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'agenda_ventas_firebase_' + year + '-' + String(month + 1).padStart(2, '0') + '.csv';
            link.click();
            URL.revokeObjectURL(link.href);
        };
        
        // Función helper para obtener coordenadas de una cita
        // Fuente de verdad: sucursales/{telefono}_{indice}.coordenadas
        // Sigue el flujo correcto: primero desde sucursal, luego fallback para citas antiguas
        window.obtenerCoordenadasCita = async function(cita) {
            const sucursalIndice = window.obtenerCampoCita(cita, 'sucursalIndice', null);
            const clienteTelefono = window.obtenerTelefono(cita);
            
            // Si hay sucursal, obtener coordenadas desde la sucursal (source of truth)
            if (window.esSucursalIndiceValido(sucursalIndice) && clienteTelefono) {
                try {
                    const sucursal = await window.obtenerSucursalPorIndice(clienteTelefono, sucursalIndice);
                    if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                        return sucursal.coordenadas;
                    }
                } catch (error) {
                    console.warn('Error obteniendo coordenadas desde sucursal:', error);
                }
            }
            
            // Fallback para citas antiguas que aún tienen coordenadas en metadata (compatibilidad)
            const coords = window.obtenerCampoCita(cita, 'coordenadas', null);
            if (window.sonCoordenadasValidas(coords)) return coords;

            return null;
        };

        // Función para verificar si una cita tiene coordenadas GPS (desde sucursal)
        window.tieneCoordenadasGPS = async function(cita) {
            const coordenadas = await window.obtenerCoordenadasCita(cita);
            return window.sonCoordenadasValidas(coordenadas);
        };
        
        // Función síncrona para verificar si una cita tiene coordenadas (usa fallback para uso inmediato)
        // IMPORTANTE: Esta función solo verifica el fallback de citas antiguas (síncrono)
        // Para citas nuevas con sucursal, usar tieneCoordenadasGPS() (async) que consulta desde sucursal
        window.tieneCoordenadasGPSSync = function(cita) {
            // Solo verificar fallback para citas antiguas que tienen coordenadas en metadata
            // Las citas nuevas con sucursal deben usar tieneCoordenadasGPS() (async)
            return window.sonCoordenadasValidas(window.obtenerCampoCita(cita, 'coordenadas', null));
        };
        
        // Función para obtener el indicador visual de GPS (async)
        window.obtenerIndicadorGPS = async function(cita) {
            const tieneGPS = await window.tieneCoordenadasGPS(cita);
            if (tieneGPS) {
                return '<i class="fas fa-check-circle indicador-gps" style="color: #28a745; font-size: 0.9rem;" title="Tiene coordenadas GPS"></i>';
            } else {
                return '<i class="fas fa-times-circle indicador-gps" style="color: #dc3545; font-size: 0.9rem;" title="Sin coordenadas GPS"></i>';
            }
        };
        
        // Versión síncrona para renderizado rápido (usa fallback de citas antiguas)
        window.obtenerIndicadorGPSSync = function(cita) {
            const coordenadas = window.obtenerCampoCita(cita, 'coordenadas', null);
            if (window.sonCoordenadasValidas(coordenadas)) {
                return '<i class="fas fa-check-circle indicador-gps" style="color: #28a745; font-size: 0.9rem;" title="Tiene coordenadas GPS"></i>';
            }
            const sucursalIndice = window.obtenerCampoCita(cita, 'sucursalIndice', null);
            const tieneSucursal = window.esSucursalIndiceValido(sucursalIndice);
            if (tieneSucursal) {
                // No mostrar nada por ahora, se actualizará después con async si es necesario
                return '';
            }
            
            // Si no tiene coordenadas ni sucursal, mostrar X roja
            return '<i class="fas fa-times-circle indicador-gps" style="color: #dc3545; font-size: 0.9rem;" title="Sin coordenadas GPS"></i>';
        };
        
        window.obtenerDescripcion = function(cita) {
            // Usar siempre obtenerCampoCita para leer (raíz o metadata)
            const campos = [
                window.obtenerCampoCita(cita, 'observaciones', ''),
                window.obtenerCampoCita(cita, 'descripcion_servicio', ''),
                window.obtenerCampoCita(cita, 'descripcion', '')
            ];
            return campos.find(campo => campo && String(campo).trim()) || '';
        };
        
        window.obtenerTurno = function(cita) {
            return window.obtenerCampoCita(cita, 'turno', 'Turno 1');
        };
        
        window.obtenerTurnoEmoji = function(cita) {
            const emoji = window.obtenerCampoCita(cita, 'turno_emoji', null);
            if (emoji) return emoji;
            // Fallback: generar emoji basado en turno
            return window.obtenerTurno(cita) === 'Turno 2' ? '🌙' : '☀️';
        };
        
        window.obtenerServicios = function(cita) {
            return window.obtenerCampoCita(cita, 'servicios', []);
        };
        
        window.obtenerProductos = function(cita) {
            return window.obtenerCampoCita(cita, 'productos', []);
        };
        
        window.obtenerEquipo = function(cita) {
            return window.obtenerCampoCita(cita, 'equipo', []);
        };
        
        // También crear alias sin window para uso dentro del módulo
        const obtenerInicio = window.obtenerInicio;
        const obtenerDuracion = window.obtenerDuracion;
        
        // ========== GESTIÓN DE SERVICIOS ==========
        
        // Variable global para almacenar servicios
        window.todosLosServicios = [];
        
        // Función para cargar servicios desde Firestore
        window.cargarServicios = async function() {
            try {
                const q = query(collection(window.db, 'servicios'), orderBy('nombre', 'asc'));
                const querySnapshot = await getDocs(q);
                window.todosLosServicios = [];
                querySnapshot.forEach(doc => {
                    window.todosLosServicios.push({ id: doc.id, ...doc.data() });
                });
                console.log('✅ Servicios cargados:', window.todosLosServicios.length);
                return window.todosLosServicios;
            } catch (error) {
                console.error('❌ Error cargando servicios:', error);
                return [];
            }
        };
        
        // Función para renderizar tabla del catálogo de servicios (admin). No confundir con renderizarTablaServicios(prefix) que muestra servicios cotizados en edit/new.
        window.renderizarTablaServiciosCatalogo = function() {
            const tbody = document.getElementById('tablaServicios');
            if (!tbody) return;
            
            if (window.todosLosServicios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-inbox me-2"></i>No hay servicios disponibles. Agrega uno nuevo.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = window.todosLosServicios.map(servicio => `
                <tr data-servicio-id="${servicio.id}">
                    <td class="align-middle">
                        <small class="text-muted">${servicio.id.substring(0, 8)}...</small>
                    </td>
                    <td class="align-middle">
                        <input type="text" 
                               class="form-control form-control-sm servicio-nombre" 
                               value="${servicio.nombre || ''}" 
                               data-servicio-id="${servicio.id}">
                    </td>
                    <td class="align-middle">
                        <input type="number" 
                               class="form-control form-control-sm servicio-precio" 
                               value="${servicio.precio || 0}" 
                               min="0" 
                               step="1"
                               data-servicio-id="${servicio.id}">
                    </td>
                    <td class="align-middle">
                        <button class="btn btn-sm btn-success me-1 btn-guardar-servicio" 
                                data-servicio-id="${servicio.id}" 
                                title="Guardar cambios">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-servicio" 
                                data-servicio-id="${servicio.id}" 
                                title="Eliminar servicio">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Agregar event listeners para guardar cambios
            tbody.querySelectorAll('.btn-guardar-servicio').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const servicioId = e.target.closest('button').getAttribute('data-servicio-id');
                    const fila = e.target.closest('tr');
                    const nombreInput = fila.querySelector('.servicio-nombre');
                    const precioInput = fila.querySelector('.servicio-precio');
                    
                    const nombre = nombreInput.value.trim();
                    const precio = parseInt(precioInput.value) || 0;
                    
                    if (!nombre) {
                        alert('El nombre del servicio es requerido');
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await updateDoc(doc(window.db, 'servicios', servicioId), {
                            nombre: nombre,
                            precio: precio,
                            fecha_actualizacion: serverTimestamp()
                        });
                        
                        // Actualizar en memoria
                        const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                        if (servicio) {
                            servicio.nombre = nombre;
                            servicio.precio = precio;
                        }
                        
                        btn.innerHTML = '<i class="fas fa-check text-success"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-save"></i>';
                            btn.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error guardando servicio:', error);
                        alert('Error guardando servicio: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                    }
                });
            });
            
            // Agregar event listeners para eliminar
            tbody.querySelectorAll('.btn-eliminar-servicio').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const servicioId = e.target.closest('button').getAttribute('data-servicio-id');
                    const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                    
                    if (!confirm(`¿Estás seguro de eliminar el servicio "${servicio?.nombre || servicioId}"?`)) {
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await deleteDoc(doc(window.db, 'servicios', servicioId));
                        
                        // Remover de memoria
                        window.todosLosServicios = window.todosLosServicios.filter(s => s.id !== servicioId);
                        
                        // Re-renderizar tabla del catálogo
                        window.renderizarTablaServiciosCatalogo();
                    } catch (error) {
                        console.error('Error eliminando servicio:', error);
                        alert('Error eliminando servicio: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-trash"></i>';
                    }
                });
            });
        };
        
        // Función para renderizar checkboxes de servicios en el formulario de citas
        window.renderizarServiciosCheckboxes = function(serviciosSeleccionados = []) {
            const container = document.getElementById('editServiciosContainer');
            if (!container) return;
            
            if (window.todosLosServicios.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>No hay servicios disponibles. 
                        <a href="#" onclick="document.getElementById('btnGestionarServicios').click(); return false;">Gestionar servicios</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.todosLosServicios.map(servicio => {
                const estaSeleccionado = serviciosSeleccionados.some(s => 
                    (typeof s === 'string' && s === servicio.id) || 
                    (typeof s === 'object' && s.id === servicio.id)
                );
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" 
                               type="checkbox" 
                               value="${servicio.id}" 
                               id="servicio_${servicio.id}"
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="servicio_${servicio.id}">
                            ${servicio.nombre || 'Sin nombre'} - ₡${(servicio.precio || 0).toLocaleString('es-CR')}
                        </label>
                    </div>
                `;
            }).join('');
        };
        
        // Función para obtener servicios seleccionados desde checkboxes (solo si se usa esa UI). La fuente de verdad para edit/new es obtenerServiciosSeleccionados(prefix) que usa serviciosSeleccionadosEdit/New.
        window.obtenerServiciosSeleccionadosDesdeCheckboxes = function() {
            const checkboxes = document.querySelectorAll('#editServiciosContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value); // Retorna array de IDs
        };
        
        // ========== GESTIÓN DE EQUIPO Y HERRAMIENTAS ==========
        
        // Variable global para almacenar equipo
        window.todosLosEquipos = [];
        
        // Función para cargar herramientas desde Firestore (solo herramientas, no productos)
        window.cargarEquipo = async function() {
            try {
                // Cargar solo herramientas desde la colección 'herramientas'
                const q = query(collection(window.db, 'herramientas'), orderBy('nombre', 'asc'));
                const querySnapshot = await getDocs(q);
                window.todosLosEquipos = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // Solo agregar herramientas activas (si tienen campo activo)
                    if (data.activo !== false) {
                        window.todosLosEquipos.push({ id: doc.id, ...data });
                    }
                });
                console.log('✅ Herramientas cargadas:', window.todosLosEquipos.length);
                return window.todosLosEquipos;
            } catch (error) {
                console.error('❌ Error cargando herramientas:', error);
                return [];
            }
        };
        
        // Función para renderizar tabla de equipo
        window.renderizarTablaEquipo = function() {
            const tbody = document.getElementById('tablaEquipo');
            if (!tbody) return;
            
            if (window.todosLosEquipos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            <i class="fas fa-inbox me-2"></i>No hay equipo disponible. Agrega uno nuevo.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = window.todosLosEquipos.map(equipo => `
                <tr data-equipo-id="${equipo.id}">
                    <td class="align-middle">
                        <small class="text-muted">${equipo.id.substring(0, 8)}...</small>
                    </td>
                    <td class="align-middle">
                        <input type="text" 
                               class="form-control form-control-sm equipo-nombre" 
                               value="${equipo.nombre || ''}" 
                               data-equipo-id="${equipo.id}">
                    </td>
                    <td class="align-middle">
                        <button class="btn btn-sm btn-success me-1 btn-guardar-equipo" 
                                data-equipo-id="${equipo.id}" 
                                title="Guardar cambios">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-eliminar-equipo" 
                                data-equipo-id="${equipo.id}" 
                                title="Eliminar equipo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Agregar event listeners para guardar cambios
            tbody.querySelectorAll('.btn-guardar-equipo').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const equipoId = e.target.closest('button').getAttribute('data-equipo-id');
                    const fila = e.target.closest('tr');
                    const nombreInput = fila.querySelector('.equipo-nombre');
                    
                    const nombre = nombreInput.value.trim();
                    
                    if (!nombre) {
                        alert('El nombre del equipo es requerido');
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await updateDoc(doc(window.db, 'equipo', equipoId), {
                            nombre: nombre,
                            fecha_actualizacion: serverTimestamp()
                        });
                        
                        // Actualizar en memoria
                        const equipoIndex = window.todosLosEquipos.findIndex(e => e.id === equipoId);
                        if (equipoIndex !== -1) {
                            window.todosLosEquipos[equipoIndex].nombre = nombre;
                        }
                        
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-save"></i>';
                            btn.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error guardando equipo:', error);
                        alert('Error guardando equipo: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                    }
                });
            });
            
            // Agregar event listeners para eliminar
            tbody.querySelectorAll('.btn-eliminar-equipo').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const equipoId = e.target.closest('button').getAttribute('data-equipo-id');
                    const equipo = window.todosLosEquipos.find(e => e.id === equipoId);
                    
                    if (!confirm(`¿Estás seguro de eliminar el equipo "${equipo?.nombre || equipoId}"?`)) {
                        return;
                    }
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        await deleteDoc(doc(window.db, 'equipo', equipoId));
                        
                        // Remover de memoria
                        window.todosLosEquipos = window.todosLosEquipos.filter(e => e.id !== equipoId);
                        
                        // Re-renderizar tabla
                        window.renderizarTablaEquipo();
                    } catch (error) {
                        console.error('Error eliminando equipo:', error);
                        alert('Error eliminando equipo: ' + error.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-trash"></i>';
                    }
                });
            });
        };
        
        // ========== GESTIÓN DE UBICACIONES (PROVINCIA, CANTÓN, DISTRITO) ==========
        window.ubicacionesCR = null;
        let ubicacionesCR = window.ubicacionesCR; // Alias local
        
        // Función para parsear coordenadas desde texto
        function parsearCoordenadas(texto) {
            if (!texto || typeof texto !== 'string') return null;
            
            // Limpiar espacios y normalizar
            texto = texto.trim().replace(/\s+/g, ' ');
            
            // Intentar diferentes formatos
            // Formato: "lat, lng" o "lat,lng"
            const match = texto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
            if (match) {
                const lat = parseFloat(match[1]);
                const lng = parseFloat(match[2]);
                
                // Validar rangos (Costa Rica está aproximadamente entre 8-11°N y 82-86°W)
                if (!isNaN(lat) && !isNaN(lng) && lat >= 8 && lat <= 11 && lng >= -86 && lng <= -82) {
                    return {
                        lat: lat,
                        lng: lng
                    };
                }
            }
            
            return null;
        }
        
        // Función para limpiar y extraer coordenadas de texto pegado (puede contener texto adicional)
        function limpiarYExtraerCoordenadas(texto) {
            if (!texto || typeof texto !== 'string') return null;
            
            // Limpiar el texto: remover caracteres especiales y normalizar espacios
            let textoLimpio = texto.trim();
            
            // Buscar patrones de coordenadas en el texto
            // Patrón 1: "lat, lng" o "lat,lng" (puede estar en cualquier parte del texto)
            const patrones = [
                // Formato estándar: número, número (con o sin espacios alrededor de la coma)
                /(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/g,
                // Formato con paréntesis: (lat, lng)
                /\((-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\)/g,
                // Formato con corchetes: [lat, lng]
                /\[(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\]/g
            ];
            
            for (const patron of patrones) {
                // Usar textoLimpio en lugar de texto
                const matches = [...textoLimpio.matchAll(patron)];
                if (matches.length > 0) {
                    // Tomar el último match (generalmente las coordenadas están al final)
                    const match = matches[matches.length - 1];
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Retornar las coordenadas sin validar primero (la validación se hace después)
                        return {
                            lat: lat,
                            lng: lng,
                            textoLimpio: `${lat}, ${lng}`
                        };
                    }
                }
            }
            
            return null;
        }
        
        // Función para validar que las coordenadas estén dentro de los límites de Costa Rica
        function validarCoordenadasCostaRica(lat, lng) {
            if (typeof lat !== 'number' || typeof lng !== 'number') return false;
            if (isNaN(lat) || isNaN(lng)) return false;
            
            // Límites aproximados de Costa Rica
            // Latitud: aproximadamente 8.0°N a 11.2°N
            // Longitud: aproximadamente -85.9°W a -82.5°W (valores negativos)
            const latMin = 8.0;
            const latMax = 11.2;
            const lngMin = -85.9;
            const lngMax = -82.5;
            
            return lat >= latMin && lat <= latMax && lng >= lngMin && lng <= lngMax;
        }
        
        // Función para verificar si un punto está dentro de un polígono (Point in Polygon - Ray Casting Algorithm mejorado)
        function puntoEnPoligono(punto, poligono) {
            if (!poligono || poligono.length < 3) return false;
            
            const [lat, lng] = punto;
            let dentro = false;
            
            // Algoritmo Ray Casting mejorado
            for (let i = 0, j = poligono.length - 1; i < poligono.length; j = i++) {
                const [xi, yi] = poligono[i];
                const [xj, yj] = poligono[j];
                
                // Verificar si el rayo cruza la arista
                const intersecta = ((yi > lng) !== (yj > lng)) && 
                                   (lat < ((xj - xi) * (lng - yi) / (yj - yi) + xi));
                if (intersecta) dentro = !dentro;
            }
            
            return dentro;
        }
        
        // Función para verificar si un punto está dentro de cualquier polígono de un distrito
        function puntoEnDistrito(punto, distritoKML) {
            if (!distritoKML || !distritoKML.coordenadas) return false;
            
            // Verificar cada polígono del distrito (puede tener múltiples polígonos)
            for (const poligono of distritoKML.coordenadas) {
                if (poligono && poligono.length >= 3) {
                    // Verificar polígono exterior
                    if (puntoEnPoligono(punto, poligono)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // Función para calcular la distancia mínima de un punto a un polígono
        function distanciaPuntoAPoligono(punto, poligono) {
            if (!poligono || poligono.length < 2) return Infinity;
            
            const [lat, lng] = punto;
            let distanciaMinima = Infinity;
            
            // Calcular distancia a cada arista del polígono
            for (let i = 0; i < poligono.length; i++) {
                const j = (i + 1) % poligono.length;
                const [x1, y1] = poligono[i];
                const [x2, y2] = poligono[j];
                
                // Distancia del punto a la línea segmento
                const A = lat - x1;
                const B = lng - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                let param = -1;
                
                if (lenSq !== 0) {
                    param = dot / lenSq;
                }
                
                let xx, yy;
                
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }
                
                const dx = lat - xx;
                const dy = lng - yy;
                const distancia = Math.sqrt(dx * dx + dy * dy);
                
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                }
            }
            
            return distanciaMinima;
        }
        
        // Función para encontrar el distrito más cercano a unas coordenadas (versión mejorada y precisa)
        async function encontrarDistritoPorCoordenadas(lat, lng) {
            if (!window.datosKML || !window.ubicacionesCR) {
                console.warn('⚠️ Datos KML o ubicaciones no cargados');
                return null;
            }
            
            const punto = [lat, lng];
            let distritoEncontrado = null;
            let distanciaMinima = Infinity;
            let distritosCandidatos = [];
            
            // PRIMERA PASADA: Buscar distritos donde el punto está DENTRO del polígono
            for (const clave in window.datosKML) {
                const distritoKML = window.datosKML[clave];
                if (distritoKML && distritoKML.coordenadas) {
                    if (puntoEnDistrito(punto, distritoKML)) {
                        // Punto está dentro del polígono - este es el más preciso
                        distritoEncontrado = {
                            provinciaId: distritoKML.COD_PROV,
                            cantonId: distritoKML.COD_CANT,
                            distritoId: distritoKML.COD_DIST,
                            nombreProvincia: distritoKML.NOM_PROV,
                            nombreCanton: distritoKML.NOM_CANT,
                            nombreDistrito: distritoKML.NOM_DIST,
                            precision: 'exacta',
                            distancia: 0
                        };
                        console.log('✅ Punto encontrado DENTRO del distrito:', distritoEncontrado.nombreDistrito);
                        return distritoEncontrado;
                    }
                }
            }
            
            // SEGUNDA PASADA: Si no está dentro, calcular distancia real a cada polígono
            for (const clave in window.datosKML) {
                const distritoKML = window.datosKML[clave];
                if (distritoKML && distritoKML.coordenadas) {
                    let distanciaDistrito = Infinity;
                    
                    // Calcular la distancia mínima a cualquier polígono de este distrito
                    for (const poligono of distritoKML.coordenadas) {
                        if (poligono && poligono.length >= 3) {
                            const distancia = distanciaPuntoAPoligono(punto, poligono);
                            if (distancia < distanciaDistrito) {
                                distanciaDistrito = distancia;
                            }
                        }
                    }
                    
                    if (distanciaDistrito < Infinity) {
                        distritosCandidatos.push({
                            provinciaId: distritoKML.COD_PROV,
                            cantonId: distritoKML.COD_CANT,
                            distritoId: distritoKML.COD_DIST,
                            nombreProvincia: distritoKML.NOM_PROV,
                            nombreCanton: distritoKML.NOM_CANT,
                            nombreDistrito: distritoKML.NOM_DIST,
                            precision: 'cercano',
                            distancia: distanciaDistrito
                        });
                    }
                }
            }
            
            // Ordenar por distancia y tomar el más cercano
            if (distritosCandidatos.length > 0) {
                distritosCandidatos.sort((a, b) => a.distancia - b.distancia);
                distritoEncontrado = distritosCandidatos[0];
                console.log(`✅ Distrito más cercano encontrado: ${distritoEncontrado.nombreDistrito} (distancia: ${distritoEncontrado.distancia.toFixed(6)} grados)`);
            }
            
            return distritoEncontrado;
        }
        
        // Función para procesar coordenadas y llenar automáticamente provincia, cantón y distrito (Nueva Cita)
        async function procesarCoordenadasNew(lat, lng) {
            try {
                // Validar que las coordenadas estén dentro de Costa Rica
                if (!validarCoordenadasCostaRica(lat, lng)) {
                    const inputCoords = document.getElementById('newCoordenadas');
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#dc3545';
                        alert(`Las coordenadas (${lat}, ${lng}) están fuera de los límites de Costa Rica. Por favor, ingrese coordenadas válidas.`);
                        return false;
                    }
                }
                
                // Mostrar indicador de carga
                const inputCoords = document.getElementById('newCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#ffc107';
                }
                
                // Buscar distrito en KML
                const distrito = await encontrarDistritoPorCoordenadas(lat, lng);
                
                if (distrito) {
                    const selectProvincia = document.getElementById('newProvincia');
                    const selectCanton = document.getElementById('newCanton');
                    const selectDistrito = document.getElementById('newDistrito');
                    
                    if (selectProvincia) {
                        // Cargar provincias si no están cargadas
                        if (!window.ubicacionesCR) {
                            await cargarUbicaciones();
                        }
                        
                        // Llenar provincias
                        if (window.ubicacionesCR) {
                            selectProvincia.innerHTML = '<option value="">Seleccionar provincia...</option>';
                            Object.keys(window.ubicacionesCR).forEach(provId => {
                                const option = document.createElement('option');
                                option.value = provId;
                                option.textContent = window.ubicacionesCR[provId].nombre;
                                selectProvincia.appendChild(option);
                            });
                            selectProvincia.value = distrito.provinciaId;
                        }
                        
                        // Llenar cantones
                        if (window.ubicacionesCR && window.ubicacionesCR[distrito.provinciaId]) {
                            const cantones = window.ubicacionesCR[distrito.provinciaId].cantones || {};
                            selectCanton.innerHTML = '<option value="">Seleccionar cantón...</option>';
                            Object.keys(cantones).forEach(cantId => {
                                const option = document.createElement('option');
                                option.value = cantId;
                                option.textContent = cantones[cantId].nombre;
                                selectCanton.appendChild(option);
                            });
                            selectCanton.value = distrito.cantonId;
                            selectCanton.disabled = false;
                        }
                        
                        // Llenar distritos
                        if (window.ubicacionesCR && 
                            window.ubicacionesCR[distrito.provinciaId] && 
                            window.ubicacionesCR[distrito.provinciaId].cantones &&
                            window.ubicacionesCR[distrito.provinciaId].cantones[distrito.cantonId]) {
                            const distritos = window.ubicacionesCR[distrito.provinciaId].cantones[distrito.cantonId].distritos || {};
                            selectDistrito.innerHTML = '<option value="">Seleccionar distrito...</option>';
                            Object.keys(distritos).forEach(distId => {
                                const option = document.createElement('option');
                                option.value = distId;
                                option.textContent = distritos[distId].nombre;
                                selectDistrito.appendChild(option);
                            });
                            selectDistrito.value = distrito.distritoId;
                            selectDistrito.disabled = false;
                        }
                        
                        // Actualizar encabezado automático
                        setTimeout(() => {
                            // actualizarEncabezadoAutoNuevaCita(); // Función eliminada - encabezado removido
                        }, 100);
                        
                        // Generar links de Google Maps y Waze automáticamente
                        const linkGoogleMaps = `https://maps.google.com/?q=${lat},${lng}`;
                        const linkWaze = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
                        const linksCombinados = `Google Maps: ${linkGoogleMaps}\nWaze: ${linkWaze}`;
                        
                        // Llenar campo de dirección con los links
                        const inputDireccion = document.getElementById('newDireccion');
                        if (inputDireccion) {
                            inputDireccion.value = linksCombinados;
                        }
                        
                        // Inicializar o actualizar mapa con las coordenadas
                        const contenedorMapa = document.getElementById('mapaUbicacionNew');
                        if (contenedorMapa) {
                            // Si el mapa ya existe, actualizarlo
                            if (window.mapaUbicacionNew && typeof window.mapaUbicacionNew.setView === 'function') {
                                window.mapaUbicacionNew.setView([lat, lng], 15);
                                window.mapaUbicacionNew.invalidateSize();
                                
                                // Remover marcador anterior si existe
                                if (window.marcadorUbicacionNew) {
                                    window.mapaUbicacionNew.removeLayer(window.marcadorUbicacionNew);
                                }
                                
                                // Agregar nuevo marcador
                                window.marcadorUbicacionNew = L.marker([lat, lng]).addTo(window.mapaUbicacionNew);
                                const popupContent = `
                                    <b>${distrito.nombreDistrito}</b><br>
                                    ${distrito.nombreCanton}, ${distrito.nombreProvincia}<br>
                                    <a href="${linkGoogleMaps}" target="_blank" rel="noopener noreferrer" style="color: #4285f4; text-decoration: none;">
                                        <i class="fas fa-map-marker-alt"></i> Google Maps
                                    </a> | 
                                    <a href="${linkWaze}" target="_blank" rel="noopener noreferrer" style="color: #33ccff; text-decoration: none;">
                                        <i class="fas fa-route"></i> Waze
                                    </a>
                                `;
                                window.marcadorUbicacionNew.bindPopup(popupContent).openPopup();
                                
                                // Mostrar distrito y cantón en el mapa
                                setTimeout(() => {
                                    mostrarDistritoYCantonNew(distrito.provinciaId, distrito.cantonId, distrito.distritoId);
                                }, 200);
                                
                                // Actualizar encabezado automático
                                // actualizarEncabezadoAutoNuevaCita(); // Función eliminada - encabezado removido
                            } else {
                                // Si el mapa no existe, inicializarlo
                                setTimeout(() => {
                                    try {
                                        // Limpiar contenedor si tiene un mapa anterior
                                        if (contenedorMapa._leaflet_id) {
                                            try {
                                                const mapaExistente = window.L && window.L.DomUtil && window.L.DomUtil.get(contenedorMapa);
                                                if (mapaExistente && mapaExistente.remove) {
                                                    mapaExistente.remove();
                                                }
                                            } catch (e) {
                                                contenedorMapa.innerHTML = '';
                                            }
                                        }
                                        
                                        // Crear nuevo mapa centrado en las coordenadas
                                        const nuevoMapa = L.map('mapaUbicacionNew').setView([lat, lng], 15);
                                        window.mapaUbicacionNew = nuevoMapa;
                                        
                                        // Agregar capa de tiles
                                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                                            attribution: '© Esri',
                                            maxZoom: 19
                                        }).addTo(nuevoMapa);
                                        
                                        // Agregar marcador
                                        window.marcadorUbicacionNew = L.marker([lat, lng]).addTo(nuevoMapa);
                                        const popupContent = `
                                            <b>${distrito.nombreDistrito}</b><br>
                                            ${distrito.nombreCanton}, ${distrito.nombreProvincia}<br>
                                            <a href="${linkGoogleMaps}" target="_blank" style="color: #4285f4; text-decoration: none;">
                                                <i class="fas fa-map-marker-alt"></i> Google Maps
                                            </a> | 
                                            <a href="${linkWaze}" target="_blank" style="color: #33ccff; text-decoration: none;">
                                                <i class="fas fa-route"></i> Waze
                                            </a>
                                        `;
                                        window.marcadorUbicacionNew.bindPopup(popupContent).openPopup();
                                        
                                        // Invalidar tamaño para asegurar renderizado correcto
                                        setTimeout(() => {
                                            if (window.mapaUbicacionNew && typeof window.mapaUbicacionNew.invalidateSize === 'function') {
                                                window.mapaUbicacionNew.invalidateSize();
                                                
                                                // Mostrar distrito y cantón en el mapa
                                                if (window.mostrarDistritoYCantonNew) {
                                                    window.mostrarDistritoYCantonNew(distrito.provinciaId, distrito.cantonId, distrito.distritoId);
                                                }
                                            }
                                        }, 200);
                                        
                                        // Actualizar encabezado automático
                                        // actualizarEncabezadoAutoNuevaCita(); // Función eliminada - encabezado removido
                                    } catch (error) {
                                        console.error('❌ Error inicializando mapa:', error);
                                    }
                                }, 300);
                            }
                            
                            // Actualizar encabezado automático
                            // actualizarEncabezadoAutoNuevaCita(); // Función eliminada - encabezado removido
                        }
                        
                        // Mostrar éxito
                        if (inputCoords) {
                            inputCoords.style.borderColor = '#28a745';
                        }
                    }
                } else {
                    // No se encontró distrito
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#dc3545';
                    }
                    console.warn('⚠️ No se pudo encontrar el distrito para las coordenadas:', lat, lng);
                }
            } catch (error) {
                console.error('❌ Error procesando coordenadas:', error);
                const inputCoords = document.getElementById('newCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#dc3545';
                }
            }
        }
        
        // Función para procesar coordenadas y llenar automáticamente provincia, cantón y distrito
        window.procesarCoordenadasEdit = async function(lat, lng) {
            try {
                // Mostrar indicador de carga
                const inputCoords = document.getElementById('editCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#ffc107';
                }
                
                // Buscar distrito en KML
                const distrito = await encontrarDistritoPorCoordenadas(lat, lng);
                
                if (distrito) {
                    const selectProvincia = document.getElementById('editProvincia');
                    const selectCanton = document.getElementById('editCanton');
                    const selectDistrito = document.getElementById('editDistrito');
                    
                    if (selectProvincia) {
                        selectProvincia.value = distrito.provinciaId;
                        llenarCantonesEdit(distrito.provinciaId);
                        
                        setTimeout(() => {
                            if (selectCanton) {
                                selectCanton.value = distrito.cantonId;
                                llenarDistritosEdit(distrito.provinciaId, distrito.cantonId);
                                
                                setTimeout(() => {
                                    if (selectDistrito) {
                                        selectDistrito.value = distrito.distritoId;
                                        
                                        // Disparar eventos change
                                        const changeEvent = new Event('change', { bubbles: true });
                                        selectDistrito.dispatchEvent(changeEvent);
                                        
                                        // Mostrar distrito en el mapa
                                        if (window.mostrarDistritoSeleccionado) {
                                            window.mostrarDistritoSeleccionado(distrito.provinciaId, distrito.cantonId, distrito.distritoId);
                                        }
                                    }
                                }, 150);
                            }
                        }, 150);
                    }
                    
                    // Generar links de Google Maps y Waze automáticamente
                    const linkGoogleMaps = `https://maps.google.com/?q=${lat},${lng}`;
                    const linkWaze = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
                    const linksCombinados = `Google Maps: ${linkGoogleMaps}\nWaze: ${linkWaze}`;
                    
                    // Llenar campo de dirección con los links
                    const inputDireccion = document.getElementById('editDireccion');
                    if (inputDireccion) {
                        inputDireccion.value = linksCombinados;
                    }
                    
                    // Actualizar mapa con marcador
                    if (window.mapaUbicacionEdit) {
                        window.mapaUbicacionEdit.setView([lat, lng], 15);
                        window.mapaUbicacionEdit.invalidateSize();
                        
                        // Remover marcador anterior
                        if (window.marcadorUbicacionEdit) {
                            window.mapaUbicacionEdit.removeLayer(window.marcadorUbicacionEdit);
                        }
                        
                        // Agregar nuevo marcador con popup que incluye los links
                        window.marcadorUbicacionEdit = L.marker([lat, lng]).addTo(window.mapaUbicacionEdit);
                        const popupContent = `
                            <b>${distrito.nombreDistrito}</b><br>
                            ${distrito.nombreCanton}, ${distrito.nombreProvincia}<br>
                            <a href="${linkGoogleMaps}" target="_blank" rel="noopener noreferrer" style="color: #4285f4; text-decoration: none;">
                                <i class="fas fa-map-marker-alt"></i> Google Maps
                            </a> | 
                            <a href="${linkWaze}" target="_blank" rel="noopener noreferrer" style="color: #33ccff; text-decoration: none;">
                                <i class="fas fa-route"></i> Waze
                            </a>
                        `;
                        window.marcadorUbicacionEdit.bindPopup(popupContent).openPopup();
                    }
                    
                    // Restaurar borde del input
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#ced4da';
                    }
                    
                    console.log('✅ Distrito encontrado:', distrito);
                    console.log('✅ Links generados:', { googleMaps: linkGoogleMaps, waze: linkWaze });
                    return true;
                } else {
                    console.warn('⚠️ No se encontró distrito para las coordenadas:', lat, lng);
                    if (inputCoords) {
                        inputCoords.style.borderColor = '#dc3545';
                    }
                    return false;
                }
            } catch (error) {
                console.error('❌ Error procesando coordenadas:', error);
                const inputCoords = document.getElementById('editCoordenadas');
                if (inputCoords) {
                    inputCoords.style.borderColor = '#dc3545';
                }
                return false;
            }
        }
        
        // Variables para el mapa de edición (GLOBALES para asegurar acceso desde cualquier función)
        // Usamos window para que sean accesibles desde cualquier scope
        window.mapaUbicacionEdit = null;
        window.marcadorUbicacionEdit = null;
        window.datosKML = null; // Datos del KML
        window.poligonosEdit = null; // Grupo de polígonos en el mapa
        // Alias locales para compatibilidad
        let mapaUbicacionEdit = window.mapaUbicacionEdit;
        let marcadorUbicacionEdit = window.marcadorUbicacionEdit;
        
        // Cargar ubicaciones de Costa Rica (sin inicializar mapa)
        async function cargarUbicacionesSolo() {
            try {
                const response = await fetch('ubicaciones-cr.json');
                window.ubicacionesCR = await response.json();
                ubicacionesCR = window.ubicacionesCR; // Sincronizar alias local
                console.log('✅ Ubicaciones de Costa Rica cargadas');
                return true;
            } catch (error) {
                console.error('❌ Error cargando ubicaciones:', error);
                return false;
            }
        }
        
        // Cargar ubicaciones de Costa Rica e inicializar mapa de edición
        async function cargarUbicaciones() {
            const cargado = await cargarUbicacionesSolo();
            if (cargado) {
                llenarProvinciasEdit();
                await cargarKML();
                inicializarMapaEdit();
            }
        }
        
        // Cargar y parsear KML
        // NOTA: El archivo debe estar en public/ para evitar problemas de CORS con Firebase Storage
        async function cargarKML() {
            try {
                // Cargar desde public/ (mismo dominio, sin problemas de CORS)
                const response = await fetch('Distritos_de_Costa_Rica.kml');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const textoKML = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(textoKML, 'text/xml');
                
                const placemarks = xmlDoc.querySelectorAll('Placemark');
                window.datosKML = {};
                
                placemarks.forEach(placemark => {
                    const extendedData = placemark.querySelector('ExtendedData');
                    if (!extendedData) return;
                    
                    const datos = {};
                    const simpleData = extendedData.querySelectorAll('SimpleData');
                    simpleData.forEach(data => {
                        const name = data.getAttribute('name');
                        const value = data.textContent;
                        datos[name] = value;
                    });
                    
                    const polygon = placemark.querySelector('Polygon');
                    if (polygon) {
                        const allCoords = [];
                        
                        const outerBoundary = polygon.querySelector('outerBoundaryIs coordinates');
                        if (outerBoundary) {
                            const coordsText = outerBoundary.textContent.trim();
                            const coordsArray = coordsText.split(/\s+/).map(coord => {
                                const parts = coord.split(',');
                                if (parts.length >= 2) {
                                    const lon = parseFloat(parts[0]);
                                    const lat = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lon)) {
                                        return [lat, lon];
                                    }
                                }
                                return null;
                            }).filter(coord => coord !== null);
                            
                            if (coordsArray.length > 0) {
                                allCoords.push(coordsArray);
                            }
                        }
                        
                        const innerBoundaries = polygon.querySelectorAll('innerBoundaryIs coordinates');
                        innerBoundaries.forEach(innerBoundary => {
                            const coordsText = innerBoundary.textContent.trim();
                            const coordsArray = coordsText.split(/\s+/).map(coord => {
                                const parts = coord.split(',');
                                if (parts.length >= 2) {
                                    const lon = parseFloat(parts[0]);
                                    const lat = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lon)) {
                                        return [lat, lon];
                                    }
                                }
                                return null;
                            }).filter(coord => coord !== null);
                            
                            if (coordsArray.length > 0) {
                                allCoords.push(coordsArray);
                            }
                        });
                        
                        if (allCoords.length > 0) {
                            const clave = `${datos.COD_PROV}-${datos.COD_CANT}-${datos.COD_DIST}`;
                            
                            if (!window.datosKML[clave]) {
                                window.datosKML[clave] = {
                                    COD_PROV: datos.COD_PROV,
                                    COD_CANT: datos.COD_CANT,
                                    COD_DIST: datos.COD_DIST,
                                    CODIGO: datos.CODIGO,
                                    NOM_PROV: datos.NOM_PROV,
                                    NOM_CANT: datos.NOM_CANT,
                                    NOM_DIST: datos.NOM_DIST,
                                    coordenadas: allCoords
                                };
                            } else {
                                window.datosKML[clave].coordenadas.push(...allCoords);
                            }
                        }
                    }
                });
                
                console.log(`✅ KML cargado: ${Object.keys(window.datosKML).length} distritos únicos`);
                return true;
            } catch (error) {
                console.error('❌ Error cargando KML:', error);
                return false;
            }
        }
        
        // Limpiar polígonos del mapa
        window.limpiarPoligonosEdit = function() {
            if (window.poligonosEdit && window.mapaUbicacionEdit) {
                window.mapaUbicacionEdit.removeLayer(window.poligonosEdit);
                window.poligonosEdit = null;
            }
        }
        
        // Mostrar todas las provincias del país
        function mostrarProvinciasPais() {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            // Agrupar distritos por provincia
            const provinciasMap = {};
            
            Object.keys(window.datosKML).forEach(clave => {
                const distrito = window.datosKML[clave];
                const provinciaId = distrito.COD_PROV;
                
                if (!provinciasMap[provinciaId]) {
                    provinciasMap[provinciaId] = {
                        id: provinciaId,
                        nombre: distrito.NOM_PROV,
                        coordenadas: []
                    };
                }
                
                // Agregar todas las coordenadas de los distritos de esta provincia
                if (distrito.coordenadas) {
                    distrito.coordenadas.forEach(coords => {
                        if (coords && coords.length > 0) {
                            provinciasMap[provinciaId].coordenadas.push(coords);
                        }
                    });
                }
            });
            
            const provincias = Object.values(provinciasMap);
            const colores = generarColores(provincias.length);
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            provincias.forEach((provincia, index) => {
                const color = colores[index];
                
                // Crear un polígono por cada conjunto de coordenadas de la provincia
                provincia.coordenadas.forEach(coords => {
                    if (coords && coords.length > 0) {
                        const polygon = L.polygon(coords, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.25,
                            weight: 2
                        });
                        
                        const info = `<b>${provincia.nombre}</b><br>Provincia de Costa Rica`;
                        polygon.bindPopup(info);
                        
                        // Click para seleccionar provincia
                        polygon.on('click', function() {
                            seleccionarProvinciaDesdeMapa(provincia.id);
                        });
                        
                        polygon.on('mouseover', function() {
                            this.setStyle({ weight: 3, fillOpacity: 0.4 });
                        });
                        
                        polygon.on('mouseout', function() {
                            this.setStyle({ weight: 2, fillOpacity: 0.25 });
                        });
                        
                        // Guardar información de la provincia
                        polygon._provinciaId = provincia.id;
                        polygon._provinciaNombre = provincia.nombre;
                        
                        window.poligonosEdit.addLayer(polygon);
                        bounds.push(polygon.getBounds());
                    }
                });
            });
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds);
            }
        }
        
        // Seleccionar provincia desde el mapa
        function seleccionarProvinciaDesdeMapa(provinciaId) {
            const selectProvincia = document.getElementById('editProvincia');
            
            if (selectProvincia) {
                selectProvincia.value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                // Disparar evento change para que se ejecuten los listeners
                const changeEvent = new Event('change', { bubbles: true });
                selectProvincia.dispatchEvent(changeEvent);
                
                // Mostrar cantones en el mapa
                setTimeout(() => {
                    mostrarCantonesProvincia(provinciaId);
                }, 100);
            }
        }
        
        // Mostrar cantones de una provincia
        window.mostrarCantonesProvincia = function(provinciaId) {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones) return;
            
            const cantones = Object.values(provincia.cantones);
            const colores = generarColores(cantones.length);
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            cantones.forEach((canton, index) => {
                const color = colores[index];
                let tienePoligonos = false;
                
                // Buscar todos los distritos de este cantón
                if (canton.distritos) {
                    Object.values(canton.distritos).forEach(distrito => {
                        const clave = `${provinciaId}-${canton.id}-${distrito.id}`;
                        const distritoKML = window.datosKML[clave];
                        
                        if (distritoKML && distritoKML.coordenadas) {
                            distritoKML.coordenadas.forEach(coords => {
                                if (coords && coords.length > 0) {
                                    tienePoligonos = true;
                                    const polygon = L.polygon(coords, {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: 0.3,
                                        weight: 2
                                    });
                                    
                                    const info = `<b>${distritoKML.NOM_CANT}</b><br>Distrito: ${distritoKML.NOM_DIST}`;
                                    polygon.bindPopup(info);
                                    
                                    // Click para seleccionar cantón
                                    polygon.on('click', function() {
                                        seleccionarCantonDesdeMapa(provinciaId, canton.id);
                                    });
                                    
                                    polygon.on('mouseover', function() {
                                        this.setStyle({ weight: 3, fillOpacity: 0.5 });
                                    });
                                    
                                    polygon.on('mouseout', function() {
                                        this.setStyle({ weight: 2, fillOpacity: 0.3 });
                                    });
                                    
                                    // Guardar información del cantón
                                    polygon._provinciaId = provinciaId;
                                    polygon._cantonId = canton.id;
                                    polygon._cantonNombre = canton.nombre;
                                    
                                    window.poligonosEdit.addLayer(polygon);
                                    bounds.push(polygon.getBounds());
                                }
                            });
                        }
                    });
                }
            });
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds);
            }
        }
        
        // Mostrar distritos de un cantón
        window.mostrarDistritosCanton = function(provinciaId, cantonId) {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            const provincia = window.ubicacionesCR[provinciaId];
            if (!provincia || !provincia.cantones || !provincia.cantones[cantonId]) return;
            
            const canton = provincia.cantones[cantonId];
            if (!canton || !canton.distritos) return;
            
            const distritos = Object.values(canton.distritos);
            const colores = generarColores(distritos.length);
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            distritos.forEach((distrito, index) => {
                const color = colores[index];
                const clave = `${provinciaId}-${cantonId}-${distrito.id}`;
                const distritoKML = window.datosKML[clave];
                
                if (distritoKML && distritoKML.coordenadas) {
                    distritoKML.coordenadas.forEach(coords => {
                        if (coords && coords.length > 0) {
                            const polygon = L.polygon(coords, {
                                color: color,
                                fillColor: color,
                                fillOpacity: 0.4,
                                weight: 2
                            });
                            
                            const info = `<b>${distritoKML.NOM_DIST}</b><br>Cantón: ${distritoKML.NOM_CANT}`;
                            polygon.bindPopup(info);
                            
                            // Click para seleccionar distrito
                            polygon.on('click', function() {
                                seleccionarDistritoDesdeMapa(provinciaId, cantonId, distrito.id);
                            });
                            
                            polygon.on('mouseover', function() {
                                this.setStyle({ weight: 4, fillOpacity: 0.6 });
                            });
                            
                            polygon.on('mouseout', function() {
                                this.setStyle({ weight: 2, fillOpacity: 0.4 });
                            });
                            
                            // Guardar información del distrito
                            polygon._provinciaId = provinciaId;
                            polygon._cantonId = cantonId;
                            polygon._distritoId = distrito.id;
                            polygon._distritoNombre = distrito.nombre;
                            
                            window.poligonosEdit.addLayer(polygon);
                            bounds.push(polygon.getBounds());
                        }
                    });
                }
            });
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds);
            }
        }
        
        // Mostrar distrito seleccionado (para mapa de edición)
        window.mostrarDistritoSeleccionado = function(provinciaId, cantonId, distritoId) {
            if (!window.mapaUbicacionEdit || !window.datosKML || !window.ubicacionesCR) return;
            
            limpiarPoligonosEdit();
            
            window.poligonosEdit = L.layerGroup();
            const bounds = [];
            
            // Mostrar todos los distritos del cantón (en color más claro) y resaltar el seleccionado
            const provincia = window.ubicacionesCR[provinciaId];
            if (provincia && provincia.cantones && provincia.cantones[cantonId]) {
                const canton = provincia.cantones[cantonId];
                if (canton && canton.distritos) {
                    const distritos = Object.values(canton.distritos);
                    distritos.forEach((distrito) => {
                        const claveCanton = `${provinciaId}-${cantonId}-${distrito.id}`;
                        const distritoKML = window.datosKML[claveCanton];
                        
                        if (distritoKML && distritoKML.coordenadas) {
            distritoKML.coordenadas.forEach(coords => {
                if (coords && coords.length > 0) {
                                    // Color rojo para el distrito seleccionado, azul claro para los demás
                                    const color = distrito.id === distritoId ? '#ff0000' : '#0066ff';
                                    const opacity = distrito.id === distritoId ? 0.5 : 0.2;
                                    const weight = distrito.id === distritoId ? 3 : 2;
                                    
                    const polygon = L.polygon(coords, {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: opacity,
                                        weight: weight
                    });
                    
                    const info = `<b>${distritoKML.NOM_DIST}</b><br>Cantón: ${distritoKML.NOM_CANT}<br>Provincia: ${distritoKML.NOM_PROV}`;
                                    polygon.bindPopup(info);
                                    
                                    // Abrir popup solo para el distrito seleccionado
                                    if (distrito.id === distritoId) {
                                        polygon.openPopup();
                                    }
                    
                    window.poligonosEdit.addLayer(polygon);
                    bounds.push(polygon.getBounds());
                }
            });
                        }
                    });
                }
            }
            
            if (bounds.length > 0) {
                window.poligonosEdit.addTo(window.mapaUbicacionEdit);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionEdit.fitBounds(groupBounds, { padding: [20, 20] });
            }
        }
        
        // Mostrar distrito y cantón en el mapa de nueva cita
        window.mostrarDistritoYCantonNew = function(provinciaId, cantonId, distritoId) {
            if (!window.mapaUbicacionNew || !window.datosKML || !window.ubicacionesCR) return;
            
            // Limpiar polígonos anteriores
            if (window.poligonosNew) {
                window.mapaUbicacionNew.removeLayer(window.poligonosNew);
            }
            
            window.poligonosNew = L.layerGroup();
            const bounds = [];
            
            // Primero mostrar todos los distritos del cantón (en color más claro)
            const provincia = window.ubicacionesCR[provinciaId];
            if (provincia && provincia.cantones && provincia.cantones[cantonId]) {
                const canton = provincia.cantones[cantonId];
                if (canton && canton.distritos) {
                    const distritos = Object.values(canton.distritos);
                    distritos.forEach((distrito) => {
                        const claveCanton = `${provinciaId}-${cantonId}-${distrito.id}`;
                        const distritoKML = window.datosKML[claveCanton];
                        
                        if (distritoKML && distritoKML.coordenadas) {
                            distritoKML.coordenadas.forEach(coords => {
                                if (coords && coords.length > 0) {
                                    // Color más claro para todos los distritos del cantón
                                    const color = distrito.id === distritoId ? '#ff0000' : '#0066ff';
                                    const opacity = distrito.id === distritoId ? 0.5 : 0.2;
                                    const weight = distrito.id === distritoId ? 3 : 2;
                                    
                                    const polygon = L.polygon(coords, {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: opacity,
                                        weight: weight
                                    });
                                    
                                    const info = `<b>${distritoKML.NOM_DIST}</b><br>Cantón: ${distritoKML.NOM_CANT}<br>Provincia: ${distritoKML.NOM_PROV}`;
                                    polygon.bindPopup(info);
                                    
                                    window.poligonosNew.addLayer(polygon);
                                    bounds.push(polygon.getBounds());
                                }
                            });
                        }
                    });
                }
            }
            
            // Agregar polígonos al mapa
            if (bounds.length > 0) {
                window.poligonosNew.addTo(window.mapaUbicacionNew);
                const groupBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                window.mapaUbicacionNew.fitBounds(groupBounds, { padding: [20, 20] });
            }
        }
        
        // Función para actualizar encabezado automático de Nueva Cita - ELIMINADA (encabezado removido)
        
        // Generar colores para polígonos
        function generarColores(cantidad) {
            const colores = [];
            for (let i = 0; i < cantidad; i++) {
                const hue = (i * 137.508) % 360;
                const saturation = 60 + (i % 3) * 10;
                const lightness = 45 + (i % 2) * 10;
                colores.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
            }
            return colores;
        }
        
        // Seleccionar cantón desde el mapa
        function seleccionarCantonDesdeMapa(provinciaId, cantonId) {
            const selectProvincia = document.getElementById('editProvincia');
            const selectCanton = document.getElementById('editCanton');
            
            if (selectProvincia && selectCanton) {
                // Establecer provincia y disparar evento change
                selectProvincia.value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                // Disparar evento change para que se ejecuten los listeners
                const changeEvent = new Event('change', { bubbles: true });
                selectProvincia.dispatchEvent(changeEvent);
                
                // Esperar a que se llenen los cantones
                setTimeout(() => {
                    if (selectCanton.options.length > 1) {
                        selectCanton.disabled = false;
                        selectCanton.value = cantonId;
                        
                        // Disparar evento change del cantón
                        const cantonChangeEvent = new Event('change', { bubbles: true });
                        selectCanton.dispatchEvent(cantonChangeEvent);
                        
                        // Mostrar distritos en el mapa
                        setTimeout(() => {
                            if (window.mostrarDistritosCanton) {
                                window.mostrarDistritosCanton(provinciaId, cantonId);
                            }
                        }, 50);
                    }
                }, 150);
            }
        }
        
        // Seleccionar distrito desde el mapa
        function seleccionarDistritoDesdeMapa(provinciaId, cantonId, distritoId) {
            const selectProvincia = document.getElementById('editProvincia');
            const selectCanton = document.getElementById('editCanton');
            const selectDistrito = document.getElementById('editDistrito');
            
            if (selectProvincia && selectCanton && selectDistrito) {
                // Establecer provincia y disparar evento change
                selectProvincia.value = provinciaId;
                llenarCantonesEdit(provinciaId);
                
                // Disparar evento change para que se ejecuten los listeners
                const provinciaChangeEvent = new Event('change', { bubbles: true });
                selectProvincia.dispatchEvent(provinciaChangeEvent);
                
                // Esperar a que se llenen los cantones
                setTimeout(() => {
                    if (selectCanton.options.length > 1) {
                        selectCanton.disabled = false;
                        selectCanton.value = cantonId;
                        llenarDistritosEdit(provinciaId, cantonId);
                        
                        // Disparar evento change del cantón
                        const cantonChangeEvent = new Event('change', { bubbles: true });
                        selectCanton.dispatchEvent(cantonChangeEvent);
                        
                        // Esperar a que se llenen los distritos
                        setTimeout(() => {
                            if (selectDistrito.options.length > 1) {
                                selectDistrito.disabled = false;
                                selectDistrito.value = distritoId;
                                
                                // Disparar evento change del distrito
                                const distritoChangeEvent = new Event('change', { bubbles: true });
                                selectDistrito.dispatchEvent(distritoChangeEvent);
                                
                                // Mostrar distrito en el mapa
                                setTimeout(() => {
                                    if (window.mostrarDistritoSeleccionado) {
                                        window.mostrarDistritoSeleccionado(provinciaId, cantonId, distritoId);
                                    }
                                }, 50);
                            }
                        }, 150);
                    }
                }, 150);
            }
        }
        
        // Función para generar y descargar CSV de ubicaciones
        function descargarUbicacionesCSV() {
            if (!window.ubicacionesCR) {
                alert('⚠️ Las ubicaciones no están cargadas. Por favor, espera un momento e intenta de nuevo.');
                return;
            }
            
            // Crear array para almacenar todas las combinaciones
            const combinaciones = [];
            
            // Encabezados del CSV
            combinaciones.push(['Provincia ID', 'Provincia Nombre', 'Cantón ID', 'Cantón Nombre', 'Distrito ID', 'Distrito Nombre']);
            
            // Recorrer todas las provincias
            Object.values(window.ubicacionesCR).forEach(provincia => {
                const provinciaId = provincia.id || '';
                const provinciaNombre = provincia.nombre || '';
                
                // Si la provincia no tiene cantones, agregar solo la provincia
                if (!provincia.cantones || Object.keys(provincia.cantones).length === 0) {
                    combinaciones.push([provinciaId, provinciaNombre, '', '', '', '']);
                } else {
                    // Recorrer todos los cantones de la provincia
                    Object.values(provincia.cantones).forEach(canton => {
                        const cantonId = canton.id || '';
                        const cantonNombre = canton.nombre || '';
                        
                        // Si el cantón no tiene distritos, agregar solo provincia y cantón
                        if (!canton.distritos || Object.keys(canton.distritos).length === 0) {
                            combinaciones.push([provinciaId, provinciaNombre, cantonId, cantonNombre, '', '']);
                        } else {
                            // Recorrer todos los distritos del cantón
                            Object.values(canton.distritos).forEach(distrito => {
                                const distritoId = distrito.id || '';
                                const distritoNombre = distrito.nombre || '';
                                
                                // Agregar la combinación completa
                                combinaciones.push([provinciaId, provinciaNombre, cantonId, cantonNombre, distritoId, distritoNombre]);
                            });
                        }
                    });
                }
            });
            
            // Convertir array a CSV
            const csvContent = combinaciones.map(row => {
                // Escapar comillas y envolver en comillas si contiene comas o comillas
                return row.map(cell => {
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',');
            }).join('\n');
            
            // Crear blob y descargar
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para Excel
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ubicaciones-costa-rica-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`✅ CSV descargado con ${combinaciones.length - 1} combinaciones de ubicaciones`);
        }
        
        // Variable para evitar múltiples event listeners
        let mapaEditListenerAgregado = false;
        
        // Inicializar mapa en modal de edición (COPIADO EXACTAMENTE de citas_registradas.html)
        function inicializarMapaEdit() {
            const mapaContainer = document.getElementById('mapaUbicacionEdit');
            if (!mapaContainer || mapaUbicacionEdit) return;
            
            // Esperar a que el modal esté visible antes de inicializar
            const modal = document.getElementById('editCitaModal');
            if (modal) {
                // Solo agregar el event listener una vez
                if (!mapaEditListenerAgregado) {
                    mapaEditListenerAgregado = true;
                    
                    // Escuchar cuando el modal se muestre
                    modal.addEventListener('shown.bs.modal', function() {
                        if (!mapaUbicacionEdit) {
                            // Pequeño delay para asegurar que el contenedor esté visible
                            setTimeout(() => {
                                try {
                                    const contenedor = document.getElementById('mapaUbicacionEdit');
                                    if (!contenedor) {
                                        console.warn('⚠️ Contenedor mapaUbicacionEdit no encontrado');
                                        return;
                                    }
                                    
                                    // Verificar si ya hay un mapa en el contenedor
                                    if (contenedor._leaflet_id) {
                                        console.log('⚠️ Ya hay un mapa en el contenedor, limpiando...');
                                        // Intentar obtener el mapa existente y removerlo
                                        try {
                                            const mapaExistente = contenedor._leaflet_id ? window.L && window.L.DomUtil && window.L.DomUtil.get(contenedor) : null;
                                            if (mapaExistente && mapaExistente.remove) {
                                                mapaExistente.remove();
                                            }
                                        } catch (e) {
                                            // Si no se puede remover, limpiar el contenedor
                                            contenedor.innerHTML = '';
                                        }
                                    }
                                    
                                    // Centro de Costa Rica
                                    const nuevoMapa = L.map('mapaUbicacionEdit').setView([9.7489, -83.7534], 8);
                                    
                                    // IMPORTANTE: Asignar a la variable global ANTES de agregar capas
                                    window.mapaUbicacionEdit = nuevoMapa;
                                    mapaUbicacionEdit = nuevoMapa; // Sincronizar alias local
                                    
                                    // Agregar capa de Esri World Street Map (similar a Google Maps)
                                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                                        attribution: '© Esri',
                                        maxZoom: 19
                                    }).addTo(mapaUbicacionEdit);
                                    
                                    // Verificar que la asignación fue correcta
                                    if (window.mapaUbicacionEdit && typeof window.mapaUbicacionEdit.setView === 'function') {
                                        console.log('✅ Mapa de edición inicializado correctamente', {
                                            tipo: typeof window.mapaUbicacionEdit,
                                            tieneSetView: typeof window.mapaUbicacionEdit.setView,
                                            tieneInvalidateSize: typeof window.mapaUbicacionEdit.invalidateSize
                                        });
                                        
                                        // Invalidar tamaño para asegurar que se renderice correctamente
                                        setTimeout(() => {
                                            if (window.mapaUbicacionEdit && typeof window.mapaUbicacionEdit.invalidateSize === 'function') {
                                                window.mapaUbicacionEdit.invalidateSize();
                                                
                                                // Mostrar provincias del país al inicio si no hay selección
                                                if (window.datosKML && window.ubicacionesCR) {
                                                    const selectProvincia = document.getElementById('editProvincia');
                                                    if (selectProvincia && !selectProvincia.value) {
                                                        mostrarProvinciasPais();
                                                    }
                                                }
                                            }
                                        }, 100);
                                    } else {
                                        console.error('❌ Error: mapaUbicacionEdit no es válido después de la asignación');
                                        window.mapaUbicacionEdit = null;
                                        mapaUbicacionEdit = null;
                                    }
                                } catch (error) {
                                    console.error('❌ Error al inicializar mapa:', error);
                                    window.mapaUbicacionEdit = null;
                                    mapaUbicacionEdit = null;
                                }
                            }, 300);
                        } else {
                            // Si ya existe, solo invalidar tamaño y mostrar provincias si no hay selección
                            setTimeout(() => {
                                if (window.mapaUbicacionEdit && typeof window.mapaUbicacionEdit.invalidateSize === 'function') {
                                    window.mapaUbicacionEdit.invalidateSize();
                                    
                                    // Mostrar provincias del país si no hay selección
                                    if (window.datosKML && window.ubicacionesCR) {
                                        const selectProvincia = document.getElementById('editProvincia');
                                        if (selectProvincia && !selectProvincia.value) {
                                            mostrarProvinciasPais();
                                        }
                                    }
                                }
                            }, 100);
                        }
                    });
                }
            } else {
                // Si no hay modal, inicializar directamente
                try {
                    window.mapaUbicacionEdit = L.map('mapaUbicacionEdit').setView([9.7489, -83.7534], 8);
                    mapaUbicacionEdit = window.mapaUbicacionEdit;
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri',
                        maxZoom: 19
                    }).addTo(mapaUbicacionEdit);
                } catch (error) {
                    console.error('❌ Error al inicializar mapa:', error);
                    window.mapaUbicacionEdit = null;
                    mapaUbicacionEdit = null;
                }
            }
        }
        
        // Función para mostrar ruta en mapa
        window.mostrarRutaVehiculo = async function(rutaNombre, rutaId) {
            try {
                // Obtener citas desde la variable global
                if (!window.citasPorRutaRuta || !window.citasPorRutaRuta[rutaId]) {
                    alert('No se encontraron citas para esta ruta.');
                    return;
                }
                const citas = window.citasPorRutaRuta[rutaId];
                
                // Filtrar citas con coordenadas GPS (desde sucursales)
                const citasConUbicacion = [];
                for (const cita of citas) {
                    const sucursalIndice = window.obtenerCampoCita(cita, 'sucursalIndice', null);
                    // Obtener teléfono desde la fuente de verdad (cita.telefono)
                    const clienteTelefono = window.obtenerTelefono(cita);
                    
                    if (window.esSucursalIndiceValido(sucursalIndice) && clienteTelefono) {
                        try {
                            const sucursal = await window.obtenerSucursalPorIndice(clienteTelefono, sucursalIndice);
                            if (window.sonCoordenadasValidas(sucursal?.coordenadas)) {
                                citasConUbicacion.push({ cita, coordenadas: sucursal.coordenadas });
                            }
                        } catch (error) {
                            console.warn('Error obteniendo coordenadas de sucursal:', error);
                        }
                    }
                    // Fallback para citas antiguas que aún tienen coordenadas en metadata
                    else {
                        const coords = window.obtenerCampoCita(cita, 'coordenadas', null);
                        if (window.sonCoordenadasValidas(coords)) citasConUbicacion.push({ cita, coordenadas: coords });
                    }
                }
                
                if (citasConUbicacion.length === 0) {
                    alert('No hay citas con coordenadas GPS para esta ruta.');
                    return;
                }
                
                // Ordenar citas por hora
                citasConUbicacion.sort((a, b) => {
                    const fechaA = window.formatearFecha(window.obtenerInicio(a.cita));
                    const fechaB = window.formatearFecha(window.obtenerInicio(b.cita));
                    if (!fechaA || !fechaB) return 0;
                    return fechaA.getTime() - fechaB.getTime();
                });
                
                // Obtener coordenadas GPS desde sucursales
                const puntosRuta = [];
                for (let i = 0; i < citasConUbicacion.length; i++) {
                    const { cita, coordenadas } = citasConUbicacion[i];
                    
                    if (coordenadas && coordenadas.lat && coordenadas.lng) {
                        const fechaInicio = window.formatearFecha(window.obtenerInicio(cita));
                        const horaInicio = fechaInicio ? fechaInicio.toLocaleTimeString('es-CR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }) : 'N/A';
                        
                        // Obtener información adicional de la cita
                        // Usar versión síncrona para evitar Promises
                        const cliente = (window.obtenerClienteNombreSync && window.obtenerClienteNombreSync(cita)) || 'Sin nombre';
                        const descripcion = window.obtenerDescripcion(cita);
                        const otrasSenas = window.obtenerCampoCita(cita, 'otras_senas', '');
                        
                        // Construir ubicación usando coordenadas y otras señas si están disponibles
                        let ubicacionTexto = `Lat: ${coordenadas.lat.toFixed(6)}, Lng: ${coordenadas.lng.toFixed(6)}`;
                        if (otrasSenas) {
                            ubicacionTexto += ` - ${otrasSenas}`;
                        }
                        
                        puntosRuta.push({
                            numero: i + 1,
                            lat: coordenadas.lat,
                            lon: coordenadas.lng,
                            cliente: cliente,
                            hora: horaInicio,
                            descripcion: descripcion,
                            ubicacion: ubicacionTexto,
                            otrasSenas: otrasSenas
                        });
                    }
                }
                
                if (puntosRuta.length === 0) {
                    alert('No se pudieron obtener coordenadas para las citas.');
                    return;
                }
                
                // Actualizar nombre de la ruta en el modal
                document.getElementById('rutaVehiculoNombre').textContent = rutaNombre;
                
                // Información de la ruta (calcular antes de mostrar el modal) - Formato visual mejorado y compacto
                let infoHtml = `
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem; border: 2px solid #1976D2;">
                        <h6 style="color: #1976D2; font-weight: 700; margin-bottom: 0.4rem; text-align: center; font-size: 0.95rem;">
                            <i class="fas fa-route me-2"></i>Ruta con ${puntosRuta.length} paradas
                        </h6>
                        <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                `;
                
                puntosRuta.forEach((punto, index) => {
                    const cita = citasConUbicacion[index];
                    
                    // Calcular duración de la cita
                    let duracionCita = '';
                    if (cita) {
                        const duracionMinutos = window.obtenerDuracion(cita);
                        const horas = Math.floor(duracionMinutos / 60);
                        const minutos = duracionMinutos % 60;
                        if (horas > 0) {
                            duracionCita = `${horas}h ${minutos}m`;
                        } else {
                            duracionCita = `${minutos}m`;
                        }
                    }
                    
                    // Calcular tiempo de traslado al siguiente punto
                    let tiempoTraslado = '';
                    let distanciaKm = '';
                    if (index < puntosRuta.length - 1 && cita) {
                        const fechaInicio = window.formatearFecha(window.obtenerInicio(cita));
                        const duracionMinutos = window.obtenerDuracion(cita);
                        const fechaFinCita = new Date(fechaInicio.getTime() + (duracionMinutos * 60000));
                        
                        const siguienteCita = citasConUbicacion[index + 1];
                        if (siguienteCita) {
                            const fechaInicioSiguiente = window.formatearFecha(window.obtenerInicio(siguienteCita));
                            const tiempoTrasladoMs = fechaInicioSiguiente.getTime() - fechaFinCita.getTime();
                            const tiempoTrasladoMinutos = Math.floor(tiempoTrasladoMs / 60000);
                            
                            if (tiempoTrasladoMinutos > 0) {
                                const horasTraslado = Math.floor(tiempoTrasladoMinutos / 60);
                                const minutosTraslado = tiempoTrasladoMinutos % 60;
                                if (horasTraslado > 0) {
                                    tiempoTraslado = `${horasTraslado}h ${minutosTraslado}m`;
                                } else {
                                    tiempoTraslado = `${minutosTraslado}m`;
                                }
                            }
                            
                            // Calcular distancia
                            const lat1 = punto.lat;
                            const lon1 = punto.lon;
                            const lat2 = puntosRuta[index + 1].lat;
                            const lon2 = puntosRuta[index + 1].lon;
                            const R = 6371; // Radio de la Tierra en km
                            const dLat = (lat2 - lat1) * Math.PI / 180;
                            const dLon = (lon2 - lon1) * Math.PI / 180;
                            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                      Math.sin(dLon/2) * Math.sin(dLon/2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            distanciaKm = (R * c).toFixed(1);
                        }
                    }
                    
                    infoHtml += `
                        <div style="display: flex; align-items: center; gap: 0.4rem; background: white; border-radius: 5px; padding: 0.4rem; box-shadow: 0 1px 2px rgba(25, 118, 210, 0.15); border-left: 3px solid #1976D2;">
                            <div style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem; flex-shrink: 0; box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);">
                                ${punto.numero}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #212529; font-size: 0.85rem; margin-bottom: 0.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${punto.cliente}
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #6c757d; flex-wrap: wrap;">
                                    <span style="display: flex; align-items: center; gap: 0.2rem;">
                                        <i class="fas fa-clock" style="color: #1976D2; font-size: 0.7rem;"></i>
                                        <span style="font-weight: 600; color: #495057;">${punto.hora}</span>
                                    </span>
                                    ${duracionCita ? `
                                        <span style="background: #e8f5e9; color: #2e7d32; padding: 0.1rem 0.35rem; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">
                                            <i class="fas fa-hourglass-half" style="font-size: 0.65rem;"></i> ${duracionCita}
                                        </span>
                                    ` : ''}
                                    ${distanciaKm ? `
                                        <span style="background: #e3f2fd; color: #1976D2; padding: 0.1rem 0.35rem; border-radius: 3px; font-weight: 600; font-size: 0.7rem; border: 1px solid #90caf9;">
                                            <i class="fas fa-route" style="font-size: 0.65rem;"></i> ${distanciaKm} km
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Agregar información de traslado entre paradas
                    if (index < puntosRuta.length - 1 && tiempoTraslado) {
                        infoHtml += `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.2rem 0.4rem; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 4px; margin: 0 0.3rem; border: 1px solid #ffb74d;">
                                <i class="fas fa-arrow-down" style="color: #f57c00; font-size: 0.8rem;"></i>
                                <span style="font-size: 0.7rem; color: #e65100; font-weight: 600;">
                                    <i class="fas fa-car" style="font-size: 0.65rem;"></i> Traslado: ${tiempoTraslado}
                                </span>
                                <i class="fas fa-arrow-down" style="color: #f57c00; font-size: 0.8rem;"></i>
                            </div>
                        `;
                    }
                });
                
                infoHtml += `
                        </div>
                    </div>
                `;
                
                document.getElementById('rutaInfo').innerHTML = infoHtml;
                
                // Obtener referencia al modal
                const modalElement = document.getElementById('modalRutaVehiculo');
                if (!modalElement) {
                    console.error('❌ Modal modalRutaVehiculo no encontrado en el DOM');
                    alert('Error: El modal de ruta no se encuentra. Por favor recarga la página.');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement);
                
                // Limpiar mapa anterior si existe
                if (window.mapaRutaVehiculo) {
                    window.mapaRutaVehiculo.remove();
                    window.mapaRutaVehiculo = null;
                }
                
                // Verificar que el contenedor del mapa exista antes de mostrar el modal
                // Buscar de múltiples formas para asegurar que se encuentre
                console.log('🔍 Buscando contenedor del mapa...');
                console.log('Modal element:', modalElement);
                console.log('Modal innerHTML length:', modalElement.innerHTML.length);
                
                let mapaContainerCheck = null;
                
                // Intentar buscar por ID directamente primero (más confiable)
                mapaContainerCheck = document.getElementById('mapaRutaVehiculo');
                if (mapaContainerCheck) {
                    console.log('✅ Contenedor encontrado por getElementById');
                } else {
                    // Buscar dentro del modal
                    mapaContainerCheck = modalElement.querySelector('#mapaRutaVehiculo');
                    if (mapaContainerCheck) {
                        console.log('✅ Contenedor encontrado dentro del modal');
                    } else {
                        // Buscar cualquier div dentro del modal-body
                        const modalBody = modalElement.querySelector('.modal-body');
                        if (modalBody) {
                            console.log('Modal body encontrado, buscando divs...');
                            const divs = modalBody.querySelectorAll('div');
                            console.log('Divs encontrados:', divs.length);
                            for (let div of divs) {
                                if (div.id && div.id.includes('mapa')) {
                                    mapaContainerCheck = div;
                                    console.log('✅ Contenedor encontrado por búsqueda de divs:', div.id);
                                    break;
                                }
                            }
                        }
                    }
                }
                
                if (!mapaContainerCheck) {
                    console.error('❌ Contenedor mapaRutaVehiculo no encontrado dentro del modal');
                    console.log('Modal HTML (primeros 1000 caracteres):', modalElement.innerHTML.substring(0, 1000));
                    // Intentar crear el contenedor si no existe
                    const modalBody = modalElement.querySelector('.modal-body');
                    if (modalBody) {
                        console.log('⚠️ Creando contenedor del mapa dinámicamente...');
                        const nuevoContenedor = document.createElement('div');
                        nuevoContenedor.id = 'mapaRutaVehiculo';
                        nuevoContenedor.style.cssText = 'height: 600px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6;';
                        modalBody.insertBefore(nuevoContenedor, modalBody.firstChild);
                        mapaContainerCheck = nuevoContenedor;
                        console.log('✅ Contenedor del mapa creado dinámicamente');
                    } else {
                        alert('Error: El modal no tiene un cuerpo válido. Por favor recarga la página.');
                        return;
                    }
                } else {
                    console.log('✅ Contenedor del mapa encontrado antes de mostrar modal');
                }
                
                // Esperar a que el modal esté completamente visible antes de inicializar el mapa
                modalElement.addEventListener('shown.bs.modal', function inicializarMapaRuta() {
                    // Remover el listener para evitar múltiples inicializaciones
                    modalElement.removeEventListener('shown.bs.modal', inicializarMapaRuta);
                    
                    // Contador de reintentos
                    let intentos = 0;
                    const maxIntentos = 20; // Máximo 20 intentos (1 segundo)
                    
                    // Función para intentar inicializar el mapa
                    const intentarInicializarMapa = () => {
                        intentos++;
                        
                        // Verificar si se excedió el límite de intentos
                        if (intentos > maxIntentos) {
                            console.error('❌ No se pudo encontrar el contenedor del mapa después de', maxIntentos, 'intentos');
                            alert('Error: No se pudo inicializar el mapa. Por favor, cierra y vuelve a abrir el modal.');
                            return;
                        }
                        
                        // Buscar el contenedor dentro del modal
                        const mapaContainer = modalElement.querySelector('#mapaRutaVehiculo') || document.getElementById('mapaRutaVehiculo');
                        
                        if (!mapaContainer) {
                            console.warn(`⚠️ Contenedor del mapa aún no disponible (intento ${intentos}/${maxIntentos}), reintentando...`);
                            setTimeout(intentarInicializarMapa, 50);
                            return;
                        }
                        
                        // Verificar que el contenedor tenga dimensiones
                        if (mapaContainer.offsetWidth === 0 || mapaContainer.offsetHeight === 0) {
                            console.warn(`⚠️ Contenedor del mapa sin dimensiones (intento ${intentos}/${maxIntentos}), reintentando...`);
                            setTimeout(intentarInicializarMapa, 50);
                            return;
                        }
                        
                        console.log('✅ Contenedor del mapa encontrado, inicializando...');
                        
                        // Verificar que el contenedor esté en el DOM
                        if (!mapaContainer.isConnected || !mapaContainer.parentNode) {
                            console.warn('⚠️ Contenedor no está conectado al DOM, reintentando...');
                            setTimeout(intentarInicializarMapa, 50);
                            return;
                        }
                        
                        // Crear mapa usando el elemento DOM directamente, no el ID
                        window.mapaRutaVehiculo = L.map(mapaContainer).setView([puntosRuta[0].lat, puntosRuta[0].lon], 11);
                        
                        // Agregar capa CartoDB Voyager (muestra mejor carreteras y divisiones administrativas)
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                            attribution: '© OpenStreetMap contributors © CARTO',
                            subdomains: 'abcd',
                            maxZoom: 19
                        }).addTo(window.mapaRutaVehiculo);
                        
                        // Agregar marcadores numerados y líneas
                        const coordenadasRuta = [];
                        puntosRuta.forEach((punto, index) => {
                            coordenadasRuta.push([punto.lat, punto.lon]);
                            
                            // Crear icono personalizado con número
                            const icono = L.divIcon({
                                className: 'marcador-ruta',
                                html: `<div style="background: #1976D2; color: white; border-radius: 50%; width: 30px; height: 30px; 
                                              display: flex; align-items: center; justify-content: center; font-weight: bold; 
                                              font-size: 14px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                        ${punto.numero}
                                      </div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            });
                            
                            // Agregar marcador
                            const marcador = L.marker([punto.lat, punto.lon], { icon: icono }).addTo(window.mapaRutaVehiculo);
                            
                            // Popup con información
                            const popupContent = `
                                <div style="font-size: 0.9rem;">
                                    <strong>📍 Parada ${punto.numero}</strong><br>
                                    <strong>Cliente:</strong> ${punto.cliente}<br>
                                    <strong>Hora:</strong> ${punto.hora}<br>
                                    ${punto.descripcion ? `<strong>Descripción:</strong> ${punto.descripcion}<br>` : ''}
                                    <strong>Coordenadas:</strong> ${punto.lat.toFixed(6)}, ${punto.lon.toFixed(6)}<br>
                                    ${punto.otrasSenas ? `<strong>Otras Señas:</strong> ${punto.otrasSenas}<br>` : ''}
                                    <a href="https://www.google.com/maps?q=${punto.lat},${punto.lon}" target="_blank" rel="noopener noreferrer" style="color: #1976D2; text-decoration: none;">
                                        <i class="fas fa-map-marker-alt"></i> Ver en Google Maps
                                    </a> | 
                                    <a href="https://waze.com/ul?ll=${punto.lat},${punto.lon}&navigate=yes" target="_blank" rel="noopener noreferrer" style="color: #1976D2; text-decoration: none;">
                                        <i class="fas fa-route"></i> Ver en Waze
                                    </a>
                                </div>
                            `;
                            marcador.bindPopup(popupContent);
                            
                            // Línea desde el punto anterior (si existe)
                            if (index > 0) {
                                const puntoAnterior = puntosRuta[index - 1];
                                const distancia = window.mapaRutaVehiculo.distance([puntoAnterior.lat, puntoAnterior.lon], [punto.lat, punto.lon]);
                                const distanciaKm = (distancia / 1000).toFixed(1);
                                
                                // Línea con flecha
                                const polyline = L.polyline(
                                    [[puntoAnterior.lat, puntoAnterior.lon], [punto.lat, punto.lon]],
                                    {
                                        color: '#1976D2',
                                        weight: 3,
                                        opacity: 0.7
                                    }
                                ).addTo(window.mapaRutaVehiculo);
                                
                                // Agregar popup a la línea con distancia
                                polyline.bindPopup(`<strong>Distancia:</strong> ${distanciaKm} km`);
                            }
                        });
                        
                        // Ajustar vista para mostrar todos los puntos
                        if (coordenadasRuta.length > 0) {
                            const bounds = L.latLngBounds(coordenadasRuta);
                            window.mapaRutaVehiculo.fitBounds(bounds, { padding: [50, 50] });
                        }
                        
                        // Invalidar tamaño del mapa para asegurar renderizado correcto
                        setTimeout(() => {
                            if (window.mapaRutaVehiculo) {
                                window.mapaRutaVehiculo.invalidateSize();
                            }
                        }, 100);
                    };
                    
                    // Intentar inicializar después de un pequeño delay
                    setTimeout(intentarInicializarMapa, 100);
                }, { once: true });
                
                // Mostrar modal
                modal.show();
                
            } catch (error) {
                console.error('Error mostrando ruta:', error);
                alert('Error al mostrar la ruta: ' + error.message);
            }
        };
        
        // ========== GESTIÓN DE PRODUCTOS ==========
        
        // ========== GESTIÓN DE RUTEADOR ==========
        
        // Variables globales para ruteador
        window.ruteadorActual = {
            fecha: null,
            ruta: null,
            tecnicos: [],
            vehiculos: [],
            horaConvocatoria: null
        };
        
        // Lista de vehículos disponibles
        const vehiculosDisponibles = [
            'APV 01', 'APV 02', 'APV 03', 'APV 04', 'APV 05', 
            'APV 06', 'APV 07', 'APV 08', 'Kangoo', 'Yaris', 'Prado', 'Rojo'
        ];
        
        // Función para generar ID único de ruteador (fecha_ruta)
        function generarIdRuteador(fecha, ruta) {
            // fecha en formato YYYY-MM-DD, ruta como "Ruta 1" -> "Ruta-1"
            const fechaFormateada = fecha;
            const rutaFormateada = ruta.replace(' ', '-');
            return `${fechaFormateada}_${rutaFormateada}`;
        }
        
        // Función para cargar datos de ruteador desde Firestore
        async function cargarRuteador(fecha, ruta) {
            try {
                const ruteadorId = generarIdRuteador(fecha, ruta);
                const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                const ruteadorDoc = await getDoc(ruteadorRef);
                
                if (ruteadorDoc.exists()) {
                    const data = ruteadorDoc.data();
                    // Normalizar técnicos: convertir IDs a usernames si es necesario
                    const tecnicosNormalizados = (data.tecnicos || []).map(tecnicoId => {
                        if (!tecnicoId || String(tecnicoId).trim() === '') return null;
                        // Buscar empleado por ID o username
                        const empleado = window.empleados?.find(e => 
                            e.id === tecnicoId || 
                            e.username === tecnicoId ||
                            (e.username && e.id === tecnicoId) ||
                            (e.id && e.username === tecnicoId)
                        );
                        // Usar username si existe, sino usar el ID guardado
                        return empleado ? (empleado.username || empleado.id) : tecnicoId;
                    }).filter(t => t !== null);
                    
                    // Normalizar vehículos: trim y filtrar vacíos
                    const vehiculosNormalizados = (data.vehiculos || [])
                        .map(v => v ? String(v).trim() : '')
                        .filter(v => v !== '');
                    
                    // Log para depuración
                    if (vehiculosNormalizados.length > 0) {
                        console.log('[CARGAR_RUTEADOR] 📋 Vehículos cargados desde Firebase', {
                            ruta: ruta,
                            fecha: fecha,
                            vehiculosOriginales: data.vehiculos || [],
                            vehiculosNormalizados: vehiculosNormalizados,
                            vehiculosDetalle: vehiculosNormalizados.map(v => ({
                                valor: v,
                                longitud: v.length,
                                tieneEspacios: v !== v.trim(),
                                caracteres: Array.from(v).map(c => c.charCodeAt(0))
                            }))
                        });
                    }
                    
                    const horaConvocatoria = data.horaConvocatoria != null ? data.horaConvocatoria : (data.hora_convocatoria != null ? data.hora_convocatoria : null);
                    return {
                        fecha: data.fecha || fecha,
                        ruta: data.ruta || ruta,
                        tecnicos: tecnicosNormalizados,
                        vehiculos: vehiculosNormalizados,
                        horaConvocatoria: horaConvocatoria
                    };
                } else {
                    return {
                        fecha: fecha,
                        ruta: ruta,
                        tecnicos: [],
                        vehiculos: [],
                        horaConvocatoria: null
                    };
                }
            } catch (error) {
                console.error('Error cargando ruteador:', error);
                return {
                    fecha: fecha,
                    ruta: ruta,
                    tecnicos: [],
                    vehiculos: [],
                    horaConvocatoria: null
                };
            }
        }
        
        // Función para validar que no haya duplicados en otras rutas del mismo día
        async function validarDuplicadosRuteador(fecha, ruta, tecnicos, vehiculos) {
            const errores = [];
            
            try {
                // Filtrar valores vacíos o nulos
                const tecnicosValidos = (tecnicos || []).filter(t => t && t.trim() !== '');
                const vehiculosValidos = (vehiculos || []).filter(v => v && v.trim() !== '');
                
                // Si no hay recursos válidos, no hay nada que validar
                if (tecnicosValidos.length === 0 && vehiculosValidos.length === 0) {
                    return [];
                }
                
                // Cargar todos los ruteadores del mismo día
                const ruteadoresQuery = query(
                    collection(window.db, 'ruteador'),
                    where('fecha', '==', fecha)
                );
                const querySnapshot = await getDocs(ruteadoresQuery);
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const ruteadorId = generarIdRuteador(fecha, ruta);
                    
                    // Ignorar el ruteador actual que estamos editando
                    if (doc.id === ruteadorId) return;
                    
                    // Verificar duplicados de técnicos (solo valores válidos)
                    const tecnicosDuplicados = tecnicosValidos.filter(t => {
                        const tecnicosRuta = (data.tecnicos || []).filter(tr => tr && tr.trim() !== '');
                        return tecnicosRuta.includes(t);
                    });
                    if (tecnicosDuplicados.length > 0) {
                        const empleado = window.empleados?.find(e => e.username === tecnicosDuplicados[0] || e.id === tecnicosDuplicados[0]);
                        const nombreEmpleado = empleado ? `${empleado.primerNombre} ${empleado.primerApellido}` : tecnicosDuplicados[0];
                        errores.push(`El técnico "${nombreEmpleado}" ya está asignado a ${data.ruta}`);
                    }
                    
                    // Verificar duplicados de vehículos (solo valores válidos)
                    const vehiculosDuplicados = vehiculosValidos.filter(v => {
                        const vehiculosRuta = (data.vehiculos || []).filter(vr => vr && vr.trim() !== '');
                        return vehiculosRuta.includes(v);
                    });
                    if (vehiculosDuplicados.length > 0) {
                        errores.push(`El vehículo "${vehiculosDuplicados[0]}" ya está asignado a ${data.ruta}`);
                    }
                });
                
                return errores;
            } catch (error) {
                console.error('Error validando duplicados:', error);
                return [];
            }
        }
        
        // Asegurar que el bloque "Hora de convocatoria" exista en el modal (por si el HTML viene de caché sin él)
        function asegurarBloqueHoraConvocatoriaEnModal() {
            let wrap = document.getElementById('wrapRuteadorHoraConvocatoria');
            if (wrap) return;
            const tecnicosContainer = document.getElementById('ruteadorTecnicosContainer');
            const modalBody = document.querySelector('#modalRuteador .modal-body');
            if (!modalBody || !tecnicosContainer) return;
            wrap = document.createElement('div');
            wrap.id = 'wrapRuteadorHoraConvocatoria';
            wrap.className = 'mb-4 p-3 rounded border border-primary border-2';
            wrap.style.backgroundColor = '#e8f4fd';
            wrap.innerHTML = '<label class="form-label fw-bold mb-2 text-primary"><i class="fas fa-clock me-2"></i>Hora de convocatoria</label>' +
                '<input type="time" id="ruteadorHoraConvocatoria" class="form-control form-control-lg" style="min-height: 48px; font-size: 1.25rem; max-width: 180px;">' +
                '<small class="text-muted d-block mt-1">Hora a la que deben presentarse los técnicos ese día para esta ruta</small>';
            modalBody.insertBefore(wrap, tecnicosContainer.parentElement);
        }
        
        // Función para editar ruteador
        window.editarRuteador = async function(ruta, fecha) {
            try {
                // Cargar empleados si no están cargados
                if (!window.empleados || window.empleados.length === 0) {
                    await window.cargarEmpleados();
                }
                
                // Guardar datos actuales
                window.ruteadorActual.fecha = fecha;
                window.ruteadorActual.ruta = ruta;
                
                // Cargar datos existentes
                const datosRuteador = await cargarRuteador(fecha, ruta);
                window.ruteadorActual.tecnicos = datosRuteador.tecnicos || [];
                window.ruteadorActual.vehiculos = datosRuteador.vehiculos || [];
                window.ruteadorActual.horaConvocatoria = datosRuteador.horaConvocatoria != null ? datosRuteador.horaConvocatoria : null;
                
                // Asegurar que el bloque Hora de convocatoria exista (incluso con HTML en caché)
                asegurarBloqueHoraConvocatoriaEnModal();
                
                // Actualizar modal
                document.getElementById('ruteadorRutaNombre').textContent = ruta;
                const inputHora = document.getElementById('ruteadorHoraConvocatoria');
                if (inputHora) inputHora.value = window.ruteadorActual.horaConvocatoria || '';
                document.getElementById('ruteadorFechaNombre').textContent = new Date(fecha).toLocaleDateString('es-CR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Renderizar técnicos
                renderizarTecnicosRuteador();
                
                // Renderizar vehículos
                renderizarVehiculosRuteador();
                
                // Ocultar errores
                document.getElementById('ruteadorErrores').style.display = 'none';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalRuteador'));
                modal.show();
            } catch (error) {
                console.error('Error editando ruteador:', error);
                alert('Error al cargar datos del ruteador: ' + error.message);
            }
        };
        
        // Función para renderizar checkboxes de técnicos
        function renderizarTecnicosRuteador() {
            const container = document.getElementById('ruteadorTecnicosContainer');
            if (!container) return;
            
            const empleadosLista = window.empleados || [];
            if (empleadosLista.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-exclamation-triangle me-2"></i>No hay empleados disponibles</div>';
                return;
            }
            
            container.innerHTML = empleadosLista.map(empleado => {
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                // Usar username como identificador principal, id como fallback
                const username = empleado.username || empleado.id;
                // Verificar si está seleccionado comparando con username o id
                const estaSeleccionado = window.ruteadorActual.tecnicos.some(t => 
                    t === username || 
                    t === empleado.username || 
                    t === empleado.id ||
                    (empleado.username && t === empleado.username) ||
                    (empleado.id && t === empleado.id)
                );
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="tecnico_ruteador_${username}" 
                               value="${username}" 
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="tecnico_ruteador_${username}">
                            ${nombreCompleto || username}
                        </label>
                    </div>
                `;
            }).join('');
        }
        
        // Función para renderizar checkboxes de vehículos
        function renderizarVehiculosRuteador() {
            const container = document.getElementById('ruteadorVehiculosContainer');
            if (!container) return;
            
            container.innerHTML = vehiculosDisponibles.map(vehiculo => {
                const estaSeleccionado = window.ruteadorActual.vehiculos.includes(vehiculo);
                const vehiculoId = vehiculo.replace(' ', '-');
                
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="vehiculo_ruteador_${vehiculoId}" 
                               value="${vehiculo}" 
                               ${estaSeleccionado ? 'checked' : ''}>
                        <label class="form-check-label" for="vehiculo_ruteador_${vehiculoId}">
                            ${vehiculo}
                        </label>
                    </div>
                `;
            }).join('');
        }
        
        // Función para actualizar técnicos (mover todos los asignados a sin asignar)
        window.actualizarTecnicosSinAsignar = async function() {
            try {
                if (!confirm('¿Está seguro de que desea mover todos los técnicos asignados de vuelta a "Sin asignar"? Esta acción afectará todas las rutas del día seleccionado.')) {
                    return;
                }
                
                // Obtener fecha del día seleccionado
                if (!diaSeleccionado) {
                    alert('No hay día seleccionado');
                    return;
                }
                
                const year = diaSeleccionado.getFullYear();
                const month = diaSeleccionado.getMonth();
                const day = diaSeleccionado.getDate();
                const fechaFormateada = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                console.log('🔄 [CALENDARIO] Actualizando técnicos sin asignar para fecha:', fechaFormateada);
                
                // Obtener todas las rutas (diurnas y nocturnas)
                const rutasDiurnas = ['Ruta 1', 'Ruta 2', 'Ruta 3', 'Ruta 4', 'Ruta 5', 'Ruta 6', 'Ruta 7', 'Ruta 8', 'Ruta 9', 'Ruta 10'];
                const rutasNocturnas = ['Ruta 11', 'Ruta 12', 'Ruta 13', 'Ruta 14', 'Ruta 15', 'Ruta 16', 'Ruta 17', 'Ruta 18', 'Ruta 19', 'Ruta 20'];
                const todasLasRutas = [...rutasDiurnas, ...rutasNocturnas];
                
                // Para cada ruta, remover todos los técnicos pero mantener los vehículos
                const promesas = todasLasRutas.map(async (ruta) => {
                    try {
                        // Cargar datos actuales del ruteador
                        const datosActuales = await cargarRuteador(fechaFormateada, ruta);
                        const vehiculosActuales = datosActuales.vehiculos || [];
                        
                        // Guardar ruteador con técnicos vacíos pero manteniendo vehículos
                        const ruteadorId = generarIdRuteador(fechaFormateada, ruta);
                        const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                        
                        await setDoc(ruteadorRef, {
                            fecha: fechaFormateada,
                            ruta: ruta,
                            tecnicos: [], // Remover todos los técnicos
                            vehiculos: vehiculosActuales, // Mantener vehículos
                            fechaActualizacion: serverTimestamp()
                        });
                        
                        console.log(`✅ [CALENDARIO] Técnicos removidos de ${ruta}`);
                    } catch (error) {
                        console.error(`❌ [CALENDARIO] Error actualizando ${ruta}:`, error);
                    }
                });
                
                await Promise.all(promesas);
                
                console.log('✅ [CALENDARIO] Todos los técnicos han sido movidos a sin asignar');
                alert('Todos los técnicos han sido movidos a "Sin asignar"');
                
                // Recargar cronograma para reflejar los cambios
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            } catch (error) {
                console.error('❌ [CALENDARIO] Error actualizando técnicos:', error);
                alert('Error al actualizar técnicos: ' + error.message);
            }
        };
        
        // Función para actualizar vehículos (mover todos los asignados a sin asignar)
        window.actualizarVehiculosSinAsignar = async function() {
            try {
                if (!confirm('¿Está seguro de que desea mover todos los vehículos asignados de vuelta a "Sin asignar"? Esta acción afectará todas las rutas del día seleccionado.')) {
                    return;
                }
                
                // Obtener fecha del día seleccionado
                if (!diaSeleccionado) {
                    alert('No hay día seleccionado');
                    return;
                }
                
                const year = diaSeleccionado.getFullYear();
                const month = diaSeleccionado.getMonth();
                const day = diaSeleccionado.getDate();
                const fechaFormateada = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                console.log('🔄 [CALENDARIO] Actualizando vehículos sin asignar para fecha:', fechaFormateada);
                
                // Obtener todas las rutas (diurnas y nocturnas)
                const rutasDiurnas = ['Ruta 1', 'Ruta 2', 'Ruta 3', 'Ruta 4', 'Ruta 5', 'Ruta 6', 'Ruta 7', 'Ruta 8', 'Ruta 9', 'Ruta 10'];
                const rutasNocturnas = ['Ruta 11', 'Ruta 12', 'Ruta 13', 'Ruta 14', 'Ruta 15', 'Ruta 16', 'Ruta 17', 'Ruta 18', 'Ruta 19', 'Ruta 20'];
                const todasLasRutas = [...rutasDiurnas, ...rutasNocturnas];
                
                // Para cada ruta, remover todos los vehículos pero mantener los técnicos
                const promesas = todasLasRutas.map(async (ruta) => {
                    try {
                        // Cargar datos actuales del ruteador
                        const datosActuales = await cargarRuteador(fechaFormateada, ruta);
                        const tecnicosActuales = datosActuales.tecnicos || [];
                        
                        // Guardar ruteador con vehículos vacíos pero manteniendo técnicos
                        const ruteadorId = generarIdRuteador(fechaFormateada, ruta);
                        const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                        
                        await setDoc(ruteadorRef, {
                            fecha: fechaFormateada,
                            ruta: ruta,
                            tecnicos: tecnicosActuales, // Mantener técnicos
                            vehiculos: [], // Remover todos los vehículos
                            fechaActualizacion: serverTimestamp()
                        });
                        
                        console.log(`✅ [CALENDARIO] Vehículos removidos de ${ruta}`);
                    } catch (error) {
                        console.error(`❌ [CALENDARIO] Error actualizando ${ruta}:`, error);
                    }
                });
                
                await Promise.all(promesas);
                
                console.log('✅ [CALENDARIO] Todos los vehículos han sido movidos a sin asignar');
                alert('Todos los vehículos han sido movidos a "Sin asignar"');
                
                // Recargar cronograma para reflejar los cambios
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            } catch (error) {
                console.error('❌ [CALENDARIO] Error actualizando vehículos:', error);
                alert('Error al actualizar vehículos: ' + error.message);
            }
        };
        
        // Función para guardar ruteador
        window.guardarRuteador = async function() {
            try {
                // Obtener técnicos seleccionados
                const tecnicosCheckboxes = document.querySelectorAll('#ruteadorTecnicosContainer input[type="checkbox"]:checked');
                // Normalizar: convertir IDs a usernames si es necesario
                const tecnicosSeleccionados = Array.from(tecnicosCheckboxes).map(cb => {
                    const valor = cb.value;
                    // Si el valor es un ID, buscar el empleado y usar su username
                    const empleado = window.empleados?.find(e => e.id === valor || e.username === valor);
                    return empleado ? (empleado.username || empleado.id) : valor;
                }).filter(v => v && v.trim() !== '');
                
                // Obtener vehículos seleccionados
                const vehiculosCheckboxes = document.querySelectorAll('#ruteadorVehiculosContainer input[type="checkbox"]:checked');
                const vehiculosSeleccionados = Array.from(vehiculosCheckboxes).map(cb => cb.value);
                
                const inputHoraConvocatoria = document.getElementById('ruteadorHoraConvocatoria');
                const horaConvocatoria = (inputHoraConvocatoria && inputHoraConvocatoria.value && inputHoraConvocatoria.value.trim()) ? inputHoraConvocatoria.value.trim() : null;
                
                // Validar duplicados
                const errores = await validarDuplicadosRuteador(
                    window.ruteadorActual.fecha,
                    window.ruteadorActual.ruta,
                    tecnicosSeleccionados,
                    vehiculosSeleccionados
                );
                
                if (errores.length > 0) {
                    const erroresContainer = document.getElementById('ruteadorErrores');
                    erroresContainer.innerHTML = '<strong>⚠️ Conflictos detectados:</strong><ul class="mb-0 mt-2">' +
                        errores.map(e => `<li>${e}</li>`).join('') + '</ul>';
                    erroresContainer.style.display = 'block';
                    return;
                }
                
                // Ocultar errores si no hay
                document.getElementById('ruteadorErrores').style.display = 'none';
                
                // Guardar en Firestore
                const ruteadorId = generarIdRuteador(window.ruteadorActual.fecha, window.ruteadorActual.ruta);
                const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                
                const payload = {
                    fecha: window.ruteadorActual.fecha,
                    ruta: window.ruteadorActual.ruta,
                    tecnicos: tecnicosSeleccionados,
                    vehiculos: vehiculosSeleccionados,
                    horaConvocatoria: horaConvocatoria,
                    fecha_actualizacion: serverTimestamp()
                };
                await setDoc(ruteadorRef, payload, { merge: true });
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalRuteador'));
                modal.hide();
                
                // Mostrar notificación
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Ruteador guardado exitosamente';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
                
                // Recargar cronograma para mostrar cambios
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            } catch (error) {
                console.error('Error guardando ruteador:', error);
                alert('Error al guardar: ' + error.message);
            }
        };
        
        // Actualizar solo la hora de convocatoria (desde arrastre de la línea en el timeline)
        window.actualizarHoraConvocatoriaSolo = async function(ruta, fecha, horaStr) {
            if (!ruta || !fecha) return;
            try {
                const ruteadorId = generarIdRuteador(fecha, ruta);
                const ruteadorRef = doc(window.db, 'ruteador', ruteadorId);
                await setDoc(ruteadorRef, {
                    fecha: fecha,
                    ruta: ruta,
                    horaConvocatoria: horaStr || null,
                    fecha_actualizacion: serverTimestamp()
                }, { merge: true });
                if (typeof generarCronograma === 'function') await generarCronograma();
            } catch (err) {
                console.error('Error actualizando hora convocatoria:', err);
            }
        };
        
        // Función para renderizar recursos sin asignar
        function renderizarRecursosSinAsignar(tecnicos, vehiculos, fecha) {
            console.log('[RENDER] 🎨 Iniciando renderizado de recursos sin asignar', {
                fecha: fecha,
                totalTecnicos: tecnicos.length,
                totalVehiculos: vehiculos.length,
                tecnicos: tecnicos.map(t => ({
                    username: t.username || t.id || 'VACÍO',
                    nombre: t.nombre || 'VACÍO',
                    id: t.id || 'VACÍO'
                }))
            });
            
            const tecnicosContainer = document.getElementById('tecnicosSinAsignarContainer');
            const vehiculosContainer = document.getElementById('vehiculosSinAsignarContainer');
            
            if (!tecnicosContainer || !vehiculosContainer) {
                console.error('[RENDER] ❌ Contenedores no encontrados', {
                    tecnicosContainer: !!tecnicosContainer,
                    vehiculosContainer: !!vehiculosContainer
                });
                return;
            }
            
            // Renderizar técnicos
            const tecnicosFiltrados = tecnicos.filter(t => {
                const username = t.username || t.id;
                const tieneUsername = username && String(username).trim() !== '';
                if (!tieneUsername) {
                    console.warn('[RENDER] ⚠️ Técnico sin username válido, omitiendo', {
                        tecnico: { id: t.id, nombre: t.nombre, username: t.username }
                    });
                }
                return tieneUsername;
            });
            
            console.log('[RENDER] 📋 Técnicos filtrados', {
                totalAntes: tecnicos.length,
                totalDespues: tecnicosFiltrados.length,
                filtrados: tecnicosFiltrados.map(t => ({
                    username: t.username || t.id,
                    nombre: t.nombre
                }))
            });
            
            tecnicosContainer.innerHTML = tecnicosFiltrados.length > 0
                ? tecnicos.filter(t => {
                    // Asegurar que tenemos un username válido
                    const username = t.username || t.id;
                    if (!username || String(username).trim() === '') {
                        return false;
                    }
                    return true;
                }).map(t => {
                    // IMPORTANTE: Usar username como identificador principal, id como fallback
                    // NO usar t.nombre para el username
                    const username = t.username || t.id || '';
                    const nombre = t.nombre || username;
                    
                    // Escapar comillas y caracteres especiales para HTML
                    const usernameEscapado = String(username).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const nombreEscapado = String(nombre).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    // Validar que username no esté vacío (solo log si es crítico)
                    if (!usernameEscapado || usernameEscapado.trim() === '') {
                        console.error('[RENDER] ❌ Técnico sin username al renderizar recurso', {
                            empleado: { id: t.id, nombre: nombre },
                            problema: 'No se puede crear badge sin username válido'
                        });
                    }
                    
                    // Determinar si es fumigación para aplicar color
                    const departamento = (t.departamento || '').trim().toLowerCase();
                    const esFumigacion = departamento === 'fumigación' || departamento === 'fumigacion';
                    
                    // Si es fumigación, usar clase naranja (recurso-tecnico), si no, usar estilo gris
                    const estiloColor = esFumigacion 
                        ? '' 
                        : 'background: #9E9E9E !important; color: white !important;';
                    
                    const htmlGenerado = `
                    <div class="recurso-item recurso-tecnico" 
                         draggable="true" 
                         data-tipo="tecnico" 
                         data-username="${usernameEscapado}"
                         data-nombre="${nombreEscapado}"
                         ${estiloColor ? `style="${estiloColor}"` : ''}>
                        ${nombre}
                    </div>
                `;
                    
                    console.log('[RENDER] ✅ HTML generado para técnico', {
                        username: usernameEscapado,
                        nombre: nombreEscapado,
                        html: htmlGenerado.substring(0, 200) + '...'
                    });
                    
                    return htmlGenerado;
                }).join('')
                : '<div class="text-muted" style="font-size: 0.8rem; padding: 10px;">Todos los técnicos están asignados</div>';
            
            console.log('[RENDER] 📝 HTML final de técnicos', {
                longitud: tecnicosContainer.innerHTML.length,
                preview: tecnicosContainer.innerHTML.substring(0, 500) + '...'
            });
            
            // Renderizar vehículos (normalizar antes de renderizar)
            console.log('[RENDER] 🚗 Renderizando vehículos sin asignar', {
                totalVehiculos: vehiculos.length,
                vehiculos: vehiculos.map(v => ({
                    original: v,
                    tipo: typeof v,
                    normalizado: v ? String(v).trim() : '',
                    longitud: v ? String(v).trim().length : 0
                }))
            });
            
            vehiculosContainer.innerHTML = vehiculos.length > 0
                ? vehiculos.map(v => {
                    // Normalizar el vehículo (trim y asegurar que sea string)
                    const vNormalizado = v ? String(v).trim() : '';
                    if (!vNormalizado) {
                        console.warn('[RENDER] ⚠️ Vehículo vacío o inválido, omitiendo', { vehiculo: v });
                        return null;
                    }
                    
                    // Escapar comillas y caracteres especiales para HTML
                    const vEscapado = vNormalizado.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    console.log('[RENDER] ✅ HTML generado para vehículo', {
                        original: v,
                        normalizado: vNormalizado,
                        escapado: vEscapado,
                        dataVehiculo: vEscapado
                    });
                    
                    return `
                    <div class="recurso-item recurso-vehiculo" 
                         draggable="true" 
                         data-tipo="vehiculo" 
                         data-vehiculo="${vEscapado}">
                        ${vEscapado}
                    </div>
                `;
                }).filter(html => html !== null).join('')
                : '<div class="text-muted" style="font-size: 0.8rem; padding: 10px;">Todos los vehículos están asignados</div>';
            
            // Verificar que los elementos se crearon correctamente en el DOM
            setTimeout(() => {
                const elementosCreados = document.querySelectorAll('.recurso-item[draggable="true"]');
                console.log('[RENDER] ✅ Verificación post-renderizado', {
                    totalElementosEnDOM: elementosCreados.length,
                    elementosDetalle: Array.from(elementosCreados).map(el => ({
                        className: el.className,
                        draggable: el.getAttribute('draggable'),
                        dataTipo: el.getAttribute('data-tipo'),
                        dataUsername: el.getAttribute('data-username'),
                        dataNombre: el.getAttribute('data-nombre'),
                        dataVehiculo: el.getAttribute('data-vehiculo'),
                        textContent: el.textContent?.trim(),
                        tieneListener: el.onclick !== null || el.getAttribute('onclick') !== null
                    }))
                });
            }, 50);
        }
        
        // Función para renderizar técnicos y vehículos en la sección de rutas nocturnas
        function renderizarRecursosNocturnas(tecnicos, vehiculos) {
            console.log('[RENDER] 🌙 Iniciando renderizado de recursos para rutas nocturnas', {
                totalTecnicos: tecnicos.length,
                totalVehiculos: vehiculos.length
            });
            
            const tecnicosContainer = document.getElementById('tecnicosNocturnasContainer');
            const vehiculosContainer = document.getElementById('vehiculosNocturnasContainer');
            
            if (!tecnicosContainer || !vehiculosContainer) {
                console.error('[RENDER] ❌ Contenedores nocturnas no encontrados', {
                    tecnicosContainer: !!tecnicosContainer,
                    vehiculosContainer: !!vehiculosContainer
                });
                return;
            }
            
            // Renderizar técnicos (misma lógica que la función principal)
            const tecnicosFiltrados = tecnicos.filter(t => {
                const username = t.username || t.id;
                return username && String(username).trim() !== '';
            });
            
            tecnicosContainer.innerHTML = tecnicosFiltrados.length > 0
                ? tecnicosFiltrados.map(t => {
                    const username = t.username || t.id || '';
                    const nombre = t.nombre || username;
                    const usernameEscapado = String(username).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const nombreEscapado = String(nombre).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    const departamento = (t.departamento || '').trim().toLowerCase();
                    const esFumigacion = departamento === 'fumigación' || departamento === 'fumigacion';
                    const estiloColor = esFumigacion 
                        ? '' 
                        : 'background: #9E9E9E !important; color: white !important;';
                    
                    return `
                    <div class="recurso-item recurso-tecnico" 
                         draggable="true" 
                         data-tipo="tecnico" 
                         data-username="${usernameEscapado}"
                         data-nombre="${nombreEscapado}"
                         ${estiloColor ? `style="${estiloColor}"` : ''}>
                        ${nombreEscapado}
                    </div>
                `;
                }).join('')
                : '<div class="text-muted" style="font-size: 0.8rem; padding: 10px;">Todos los técnicos están asignados</div>';
            
            // Renderizar vehículos (misma lógica que la función principal)
            vehiculosContainer.innerHTML = vehiculos.length > 0
                ? vehiculos.map(v => {
                    const vNormalizado = v ? String(v).trim() : '';
                    if (!vNormalizado) return null;
                    
                    const vEscapado = vNormalizado.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    return `
                    <div class="recurso-item recurso-vehiculo" 
                         draggable="true" 
                         data-tipo="vehiculo" 
                         data-vehiculo="${vEscapado}">
                        ${vEscapado}
                    </div>
                `;
                }).filter(html => html !== null).join('')
                : '<div class="text-muted" style="font-size: 0.8rem; padding: 10px;">Todos los vehículos están asignados</div>';
        }
        
        // Variable global para almacenar el tipo de recurso que se está arrastrando
        let tipoRecursoArrastrando = null;
        
        // Variables globales para almacenar los datos del recurso que se está arrastrando
        let datosRecursoArrastrando = {
            tipo: null,
            username: null,
            nombre: null,
            vehiculo: null,
            rutaOrigen: null
        };
        
        // Variable para rastrear si ya se configuraron los listeners de citas
        let dragAndDropCitasConfigurado = false;
        
        // Función para inicializar drag and drop de recursos
        function inicializarDragAndDropRecursos(fecha) {
            console.log('[DRAG&DROP] 🔧 Inicializando drag and drop de recursos...', { fecha });
            
            // Obtener todos los recursos actuales
            const recursos = document.querySelectorAll('.recurso-item[draggable="true"], .ruta-badge-item[draggable="true"]');
            const rutasInfoRows = document.querySelectorAll('.ruta-info-row');
            
            console.log('[DRAG&DROP] 📊 Elementos encontrados', {
                totalRecursos: recursos.length,
                totalRutasInfoRows: rutasInfoRows.length,
                recursosDetalle: Array.from(recursos).map(r => ({
                    className: r.className,
                    tipo: r.dataset.tipo || r.getAttribute('data-tipo') || 'NO DEFINIDO',
                    username: r.dataset.username || r.getAttribute('data-username') || 'NO DEFINIDO',
                    textContent: r.textContent?.trim()
                }))
            });
            
            // Agregar listeners a todos los recursos (sin asignar y ya asignados)
            let listenersAgregados = 0;
            let listenersOmitidos = 0;
            
            document.querySelectorAll('.recurso-item[draggable="true"], .ruta-badge-item[draggable="true"]').forEach(recurso => {
                // Verificar que el elemento tiene data-tipo antes de agregar listener
                const tipoInicial = recurso.dataset.tipo || recurso.getAttribute('data-tipo');
                if (!tipoInicial) {
                    console.error('[DRAG&DROP] ❌ No se puede agregar listener - elemento sin data-tipo', {
                        elemento: {
                            className: recurso.className,
                            textContent: recurso.textContent?.trim(),
                            attributes: Array.from(recurso.attributes).map(a => `${a.name}="${a.value}"`),
                            draggable: recurso.getAttribute('draggable'),
                            dataset: recurso.dataset
                        }
                    });
                    listenersOmitidos++;
                    return; // Saltar este elemento
                }
                
                listenersAgregados++;
                
                // Guardar referencia al elemento para logging
                const elementoRef = recurso;
                const tipoRef = tipoInicial;
                
                recurso.addEventListener('dragstart', function dragstartHandler(e) {
                    console.log('[DRAG&DROP] 🚀 ========== DRAGSTART INICIADO ==========');
                    console.log('[DRAG&DROP] 📍 Paso 1: Evento capturado', {
                        timestamp: new Date().toISOString(),
                        eventType: e.type,
                        target: {
                            tagName: e.target.tagName,
                            className: e.target.className,
                            id: e.target.id,
                            textContent: e.target.textContent?.trim()
                        },
                        currentTarget: {
                            tagName: e.currentTarget.tagName,
                            className: e.currentTarget.className,
                            textContent: e.currentTarget.textContent?.trim()
                        },
                        elementoOriginal: {
                            tipo: tipoRef,
                            textContent: elementoRef.textContent?.trim(),
                            className: elementoRef.className,
                            id: elementoRef.id,
                            dataset: {
                                tipo: elementoRef.dataset.tipo,
                                username: elementoRef.dataset.username,
                                nombre: elementoRef.dataset.nombre,
                                vehiculo: elementoRef.dataset.vehiculo,
                                ruta: elementoRef.dataset.ruta
                            },
                            attributes: Array.from(elementoRef.attributes).map(a => ({
                                name: a.name,
                                value: a.value
                            })),
                            draggable: elementoRef.getAttribute('draggable'),
                            tieneListener: elementoRef.onclick !== null
                        }
                    });
                    
                    console.log('[DRAG&DROP] 📍 Paso 2: Configurando dataTransfer', {
                        effectAllowedAntes: e.dataTransfer.effectAllowed,
                        typesAntes: Array.from(e.dataTransfer.types || []),
                        dropEffectAntes: e.dataTransfer.dropEffect
                    });
                    
                    e.dataTransfer.effectAllowed = 'move';
                    
                    console.log('[DRAG&DROP] 📍 Paso 3: effectAllowed configurado', {
                        effectAllowedDespues: e.dataTransfer.effectAllowed
                    });
                    
                    // Obtener tipo de múltiples formas para asegurar que se capture
                    const tipo = recurso.dataset.tipo || 
                                 recurso.getAttribute('data-tipo') || 
                                 (recurso.classList.contains('recurso-tecnico') || recurso.classList.contains('ruta-badge-tecnico') ? 'tecnico' : '') ||
                                 (recurso.classList.contains('recurso-vehiculo') || recurso.classList.contains('ruta-badge-vehiculo') ? 'vehiculo' : '') ||
                                 '';
                    
                    // Si el tipo sigue vacío, es un error crítico
                    if (!tipo || tipo.trim() === '') {
                        console.error('[DRAG&DROP] ❌ Error crítico - no se puede determinar el tipo del elemento', {
                            elemento: {
                                className: recurso.className,
                                dataset: recurso.dataset,
                                attributes: Array.from(recurso.attributes).map(a => `${a.name}="${a.value}"`),
                                textContent: recurso.textContent?.trim()
                            },
                            sugerencia: 'El elemento no tiene data-tipo y no se puede inferir de las clases CSS'
                        });
                        e.preventDefault();
                        return;
                    }
                    
                    tipoRecursoArrastrando = tipo;
                    
                    // Guardar datos en variable global también
                    datosRecursoArrastrando.tipo = tipo;
                    datosRecursoArrastrando.username = null;
                    datosRecursoArrastrando.nombre = null;
                    datosRecursoArrastrando.vehiculo = null;
                    datosRecursoArrastrando.rutaOrigen = null;
                    
                    console.log('[DRAG&DROP] 📍 Paso 4: Guardando datos en dataTransfer', {
                        tipoAGuardar: tipo,
                        tiposDisponiblesAntes: Array.from(e.dataTransfer.types || [])
                    });
                    
                    // Guardar en múltiples formatos para compatibilidad con diferentes navegadores
                    try {
                    e.dataTransfer.setData('tipo', tipo);
                        console.log('[DRAG&DROP] ✅ Tipo guardado en formato "tipo"');
                    } catch (err) {
                        console.error('[DRAG&DROP] ❌ Error al guardar tipo en formato "tipo"', { error: err.message });
                    }
                    
                    try {
                        e.dataTransfer.setData('text/plain', tipo);
                        console.log('[DRAG&DROP] ✅ Tipo guardado en formato "text/plain"');
                    } catch (err) {
                        console.error('[DRAG&DROP] ❌ Error al guardar tipo en formato "text/plain"', { error: err.message });
                    }
                    
                    // Verificar que se guardó correctamente
                    const tipoVerificado1 = e.dataTransfer.getData('tipo');
                    const tipoVerificado2 = e.dataTransfer.getData('text/plain');
                    const tiposDisponibles = Array.from(e.dataTransfer.types || []);
                    
                    console.log('[DRAG&DROP] 📍 Paso 5: Verificación de datos guardados', {
                        tipoOriginal: tipo,
                        tipoVerificadoFormato1: tipoVerificado1,
                        tipoVerificadoFormato2: tipoVerificado2,
                        tiposDisponibles: tiposDisponibles,
                        coincideFormato1: tipoVerificado1 === tipo,
                        coincideFormato2: tipoVerificado2 === tipo,
                        dataTransferCompleto: {
                            effectAllowed: e.dataTransfer.effectAllowed,
                            dropEffect: e.dataTransfer.dropEffect,
                            types: tiposDisponibles
                        }
                    });
                    
                    if (tipoVerificado1 !== tipo && tipoVerificado2 !== tipo) {
                        console.error('[DRAG&DROP] ❌ ERROR CRÍTICO - Tipo no se guardó correctamente', {
                            tipoOriginal: tipo,
                            tipoVerificadoFormato1: tipoVerificado1,
                            tipoVerificadoFormato2: tipoVerificado2,
                            tiposDisponibles: tiposDisponibles,
                            dataTransfer: {
                                effectAllowed: e.dataTransfer.effectAllowed,
                                dropEffect: e.dataTransfer.dropEffect
                            }
                        });
                    }
                    
                    if (tipo === 'tecnico') {
                        console.log('[DRAG&DROP] 📍 Paso 6: Procesando técnico', {
                            elementoDataset: {
                                username: elementoRef.dataset.username,
                                nombre: elementoRef.dataset.nombre
                            },
                            elementoAttributes: {
                                dataUsername: elementoRef.getAttribute('data-username'),
                                dataNombre: elementoRef.getAttribute('data-nombre')
                            }
                        });
                        
                        // Intentar obtener username de múltiples formas
                        let username = elementoRef.dataset.username || 
                                      elementoRef.getAttribute('data-username') ||
                                      '';
                        
                        console.log('[DRAG&DROP] 📍 Paso 6.1: Username obtenido (intento 1)', {
                            username: username,
                            fuente: elementoRef.dataset.username ? 'dataset' : elementoRef.getAttribute('data-username') ? 'attribute' : 'VACÍO'
                        });
                        
                        // Si aún está vacío, intentar obtener del texto o del elemento
                        if (!username || username.trim() === '') {
                            const parent = elementoRef.closest('[data-username]');
                            if (parent) {
                                username = parent.dataset.username || parent.getAttribute('data-username') || '';
                                console.log('[DRAG&DROP] 📍 Paso 6.2: Username obtenido del padre', { username });
                            }
                        }
                        
                        // Si aún está vacío, intentar obtener del innerHTML o textContent
                        if (!username || username.trim() === '') {
                            const nombreMostrado = (elementoRef.textContent?.trim() || elementoRef.innerHTML?.trim() || '').replace(/\s+/g, ' ').trim();
                            console.log('[DRAG&DROP] 📍 Paso 6.3: Buscando por nombre mostrado', {
                                nombreMostrado: nombreMostrado,
                                totalEmpleados: window.empleados?.length || 0
                            });
                            
                            if (nombreMostrado && window.empleados) {
                                const empleadoEncontrado = window.empleados.find(emp => {
                                    const primerNombre = (emp.primerNombre || '').trim();
                                    const primerApellido = (emp.primerApellido || '').trim();
                                    const inicialApellido = primerApellido ? primerApellido.charAt(0).toUpperCase() + '.' : '';
                                    const nombreFormateado = `${primerNombre} ${inicialApellido}`.trim();
                                    const nombreCompleto = `${primerNombre} ${primerApellido}`.trim();
                                    return nombreFormateado === nombreMostrado || 
                                           nombreCompleto === nombreMostrado ||
                                           (emp.username && emp.username === nombreMostrado) ||
                                           (emp.id && emp.id === nombreMostrado);
                                });
                                
                                if (empleadoEncontrado) {
                                    username = empleadoEncontrado.username || empleadoEncontrado.id || '';
                                    console.log('[DRAG&DROP] 📍 Paso 6.4: Empleado encontrado por nombre', {
                                        username: username,
                                        empleado: {
                                            id: empleadoEncontrado.id,
                                            username: empleadoEncontrado.username,
                                            nombre: `${empleadoEncontrado.primerNombre} ${empleadoEncontrado.primerApellido}`
                                        }
                                    });
                                } else {
                                    console.warn('[DRAG&DROP] ⚠️ No se encontró empleado por nombre', { nombreMostrado });
                                }
                            }
                        }
                        
                        const nombre = elementoRef.dataset.nombre || elementoRef.getAttribute('data-nombre') || '';
                        
                        console.log('[DRAG&DROP] 📍 Paso 7: Validación final de username', {
                            username: username,
                            nombre: nombre,
                            usernameValido: username && username.trim() !== '',
                            nombreValido: nombre && nombre.trim() !== ''
                        });
                        
                        if (!username || username.trim() === '') {
                            const nombreMostrado = elementoRef.textContent?.trim() || 'desconocido';
                            console.error('[DRAG&DROP] ❌ ERROR CRÍTICO - No se puede arrastrar técnico - username vacío', {
                                nombreMostrado: nombreMostrado,
                                elemento: {
                                tipo: tipo,
                                    dataUsername: elementoRef.dataset.username || 'no definido',
                                    dataNombre: elementoRef.dataset.nombre || 'no definido',
                                    textContent: elementoRef.textContent?.trim() || 'vacío',
                                    attributes: Array.from(elementoRef.attributes).map(a => `${a.name}="${a.value}"`)
                                },
                                contexto: {
                                    totalEmpleados: window.empleados?.length || 0,
                                    sugerencia: 'Verifique que el badge tenga el atributo data-username correctamente configurado'
                                }
                            });
                            e.preventDefault();
                            return;
                        }
                        
                        // Asegurar que el username se guarde correctamente
                        const usernameFinal = String(username).trim();
                        const nombreFinal = (nombre || usernameFinal).trim();
                        
                        // Guardar en variable global también
                        datosRecursoArrastrando.username = usernameFinal;
                        datosRecursoArrastrando.nombre = nombreFinal;
                        
                        console.log('[DRAG&DROP] 📍 Paso 8: Guardando username y nombre', {
                            usernameFinal: usernameFinal,
                            nombreFinal: nombreFinal,
                            tiposAntes: Array.from(e.dataTransfer.types || [])
                        });
                        
                        // Guardar en múltiples formatos para compatibilidad
                        try {
                        e.dataTransfer.setData('username', usernameFinal);
                            console.log('[DRAG&DROP] ✅ Username guardado en formato "username"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ❌ Error al guardar username', { error: err.message });
                        }
                        
                        try {
                        e.dataTransfer.setData('nombre', nombreFinal);
                            console.log('[DRAG&DROP] ✅ Nombre guardado en formato "nombre"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ❌ Error al guardar nombre', { error: err.message });
                        }
                        
                        try {
                            e.dataTransfer.setData('text/username', usernameFinal);
                            console.log('[DRAG&DROP] ✅ Username guardado en formato "text/username"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ❌ Error al guardar username (respaldo)', { error: err.message });
                        }
                        
                        try {
                            e.dataTransfer.setData('text/nombre', nombreFinal);
                            console.log('[DRAG&DROP] ✅ Nombre guardado en formato "text/nombre"');
                        } catch (err) {
                            console.error('[DRAG&DROP] ❌ Error al guardar nombre (respaldo)', { error: err.message });
                        }
                        
                        // Verificar que se guardaron correctamente
                        const usernameVerificado1 = e.dataTransfer.getData('username');
                        const usernameVerificado2 = e.dataTransfer.getData('text/username');
                        const nombreVerificado1 = e.dataTransfer.getData('nombre');
                        const nombreVerificado2 = e.dataTransfer.getData('text/nombre');
                        const tiposDisponibles = Array.from(e.dataTransfer.types || []);
                        
                        console.log('[DRAG&DROP] 📍 Paso 9: Verificación final de datos guardados', {
                                usernameOriginal: usernameFinal,
                            usernameVerificadoFormato1: usernameVerificado1,
                            usernameVerificadoFormato2: usernameVerificado2,
                            nombreOriginal: nombreFinal,
                            nombreVerificadoFormato1: nombreVerificado1,
                            nombreVerificadoFormato2: nombreVerificado2,
                            tiposDisponibles: tiposDisponibles,
                            usernameCoincide1: usernameVerificado1 === usernameFinal,
                            usernameCoincide2: usernameVerificado2 === usernameFinal,
                            nombreCoincide1: nombreVerificado1 === nombreFinal,
                            nombreCoincide2: nombreVerificado2 === nombreFinal
                        });
                        
                        if (usernameVerificado1 !== usernameFinal && usernameVerificado2 !== usernameFinal) {
                            console.error('[DRAG&DROP] ❌ ERROR CRÍTICO - Username no se guardó correctamente', {
                                usernameOriginal: usernameFinal,
                                usernameVerificadoFormato1: usernameVerificado1,
                                usernameVerificadoFormato2: usernameVerificado2,
                                tiposDisponibles: tiposDisponibles
                            });
                        }
                        
                        if (nombreVerificado1 !== nombreFinal && nombreVerificado2 !== nombreFinal) {
                            console.error('[DRAG&DROP] ❌ ERROR CRÍTICO - Nombre no se guardó correctamente', {
                                nombreOriginal: nombreFinal,
                                nombreVerificadoFormato1: nombreVerificado1,
                                nombreVerificadoFormato2: nombreVerificado2,
                                tiposDisponibles: tiposDisponibles
                            });
                        }
                    } else {
                        // Intentar obtener vehículo de múltiples formas
                        let vehiculo = recurso.dataset.vehiculo || 
                                      recurso.getAttribute('data-vehiculo') ||
                                      '';
                        
                        // Si aún está vacío, intentar obtener del texto o del elemento
                        if (!vehiculo || vehiculo.trim() === '') {
                            // Buscar en el elemento padre o en los atributos
                            const parent = recurso.closest('[data-vehiculo]');
                            if (parent) {
                                vehiculo = parent.dataset.vehiculo || parent.getAttribute('data-vehiculo') || '';
                            }
                        }
                        
                        if (!vehiculo || vehiculo.trim() === '') {
                            const nombreMostrado = recurso.textContent?.trim() || 'desconocido';
                            console.error('[DRAG&DROP] ❌ No se puede arrastrar vehículo - nombre vacío', {
                                nombreMostrado: nombreMostrado,
                                elemento: {
                                    tipo: tipo,
                                    dataVehiculo: recurso.dataset.vehiculo || 'no definido',
                                    textContent: recurso.textContent?.trim() || 'vacío'
                                },
                                sugerencia: 'Verifique que el badge tenga el atributo data-vehiculo correctamente configurado'
                            });
                            e.preventDefault();
                            return;
                        }
                        const vehiculoFinal = String(vehiculo).trim();
                        e.dataTransfer.setData('vehiculo', vehiculoFinal);
                        e.dataTransfer.setData('text/vehiculo', vehiculoFinal); // Respaldo
                        
                        // Guardar en variable global también
                        datosRecursoArrastrando.vehiculo = vehiculoFinal;
                        
                        console.log('[DRAG&DROP] 📍 Paso 6.5: Vehículo guardado en variable global', {
                            vehiculoFinal: vehiculoFinal,
                            datosRecursoArrastrando: {
                                tipo: datosRecursoArrastrando.tipo,
                                vehiculo: datosRecursoArrastrando.vehiculo,
                                rutaOrigen: datosRecursoArrastrando.rutaOrigen
                            }
                        });
                        
                        // Verificar que se guardó correctamente
                        const vehiculoVerificado = e.dataTransfer.getData('vehiculo');
                        if (vehiculoVerificado !== vehiculoFinal) {
                            console.error('[DRAG&DROP] ❌ Error al guardar vehículo en dataTransfer', {
                                vehiculoOriginal: vehiculoFinal,
                                vehiculoVerificado: vehiculoVerificado
                            });
                        } else {
                            console.log('[DRAG&DROP] ✅ Vehículo guardado correctamente en dataTransfer', {
                                vehiculo: vehiculoFinal
                            });
                        }
                    }
                    // Guardar la ruta de origen si existe (puede ser null si viene de "Sin asignar")
                    const rutaOrigen = elementoRef.dataset.ruta || elementoRef.getAttribute('data-ruta') || '';
                    const rutaOrigenFinal = rutaOrigen || ''; // Siempre guardar, incluso si está vacío
                    
                    // Guardar en variable global también
                    datosRecursoArrastrando.rutaOrigen = rutaOrigenFinal;
                    
                    console.log('[DRAG&DROP] 📍 Paso 10: Guardando ruta de origen', {
                        rutaOrigen: rutaOrigenFinal,
                        tiposAntes: Array.from(e.dataTransfer.types || [])
                    });
                    
                    try {
                        e.dataTransfer.setData('rutaOrigen', rutaOrigenFinal);
                        e.dataTransfer.setData('text/rutaOrigen', rutaOrigenFinal);
                        console.log('[DRAG&DROP] ✅ Ruta de origen guardada');
                    } catch (err) {
                        console.error('[DRAG&DROP] ❌ Error al guardar ruta de origen', { error: err.message });
                    }
                    
                    // Verificar que todos los datos se guardaron correctamente
                    console.log('[DRAG&DROP] 📍 Paso 11: Verificación final completa', {
                        tiposDisponibles: Array.from(e.dataTransfer.types || []),
                        dataTransferCompleto: {
                            effectAllowed: e.dataTransfer.effectAllowed,
                            dropEffect: e.dataTransfer.dropEffect,
                            types: Array.from(e.dataTransfer.types || [])
                        }
                    });
                    
                    const tipoVerificadoFinal = e.dataTransfer.getData('tipo');
                    const tipoVerificadoFinal2 = e.dataTransfer.getData('text/plain');
                    const datosVerificados = {
                        tipo: tipoVerificadoFinal || tipoVerificadoFinal2 || 'VACÍO',
                        rutaOrigen: e.dataTransfer.getData('rutaOrigen') || e.dataTransfer.getData('text/rutaOrigen') || 'VACÍO'
                    };
                    
                    if (tipo === 'tecnico') {
                        datosVerificados.username = e.dataTransfer.getData('username') || e.dataTransfer.getData('text/username') || 'VACÍO';
                        datosVerificados.nombre = e.dataTransfer.getData('nombre') || e.dataTransfer.getData('text/nombre') || 'VACÍO';
                    } else if (tipo === 'vehiculo') {
                        datosVerificados.vehiculo = e.dataTransfer.getData('vehiculo') || e.dataTransfer.getData('text/vehiculo') || datosRecursoArrastrando.vehiculo || 'VACÍO';
                    }
                    
                    console.log('[DRAG&DROP] 📍 Paso 12: Resumen final de datos guardados', {
                        tipoEsperado: tipo,
                        datosVerificados: datosVerificados,
                        todosLosTipos: Array.from(e.dataTransfer.types || []),
                        todosLosDatos: {
                            tipo: e.dataTransfer.getData('tipo'),
                            tipoTextPlain: e.dataTransfer.getData('text/plain'),
                            username: e.dataTransfer.getData('username'),
                            usernameText: e.dataTransfer.getData('text/username'),
                            nombre: e.dataTransfer.getData('nombre'),
                            nombreText: e.dataTransfer.getData('text/nombre'),
                            vehiculo: e.dataTransfer.getData('vehiculo'),
                            vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                            rutaOrigen: e.dataTransfer.getData('rutaOrigen'),
                            rutaOrigenText: e.dataTransfer.getData('text/rutaOrigen')
                        }
                    });
                    
                    // Log de éxito solo si todo está correcto
                    if (tipoVerificadoFinal === tipo || tipoVerificadoFinal2 === tipo) {
                        console.log('[DRAG&DROP] ✅ ========== DRAGSTART EXITOSO ==========', {
                            tipo: tipo,
                            datos: datosVerificados,
                            elemento: {
                                textContent: elementoRef.textContent?.trim(),
                                className: elementoRef.className
                            },
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        console.error('[DRAG&DROP] ❌ ========== ERROR DE VERIFICACIÓN EN DRAGSTART ==========', {
                            tipoEsperado: tipo,
                            tipoVerificadoFormato1: tipoVerificadoFinal,
                            tipoVerificadoFormato2: tipoVerificadoFinal2,
                            datos: datosVerificados,
                            tiposDisponibles: Array.from(e.dataTransfer.types || []),
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    elementoRef.classList.add('dragging');
                    console.log('[DRAG&DROP] 📍 Paso 13: Clase "dragging" agregada al elemento');
                });
                
                recurso.addEventListener('dragend', (e) => {
                    recurso.classList.remove('dragging');
                    rutasInfoRows.forEach(row => {
                        row.classList.remove('drop-zone', 'drop-zone-active');
                    });
                    
                    // NO limpiar las variables globales inmediatamente
                    // Esperar un poco para que el drop pueda leerlas si es necesario
                    // El drop debería leer primero del dataTransfer, pero las variables globales
                    // son un respaldo importante
                    setTimeout(() => {
                        tipoRecursoArrastrando = null;
                        datosRecursoArrastrando = {
                            tipo: null,
                            username: null,
                            nombre: null,
                            vehiculo: null,
                            rutaOrigen: null
                        };
                        console.log('[DRAG&DROP] 🧹 Variables globales limpiadas después del drop');
                    }, 500); // Esperar 500ms para que el drop termine
                });
            });
            
            console.log('[DRAG&DROP] ✅ Listeners agregados', {
                totalAgregados: listenersAgregados,
                totalOmitidos: listenersOmitidos,
                totalEncontrados: recursos.length
            });
            
            rutasInfoRows.forEach((row) => {
                // Usar data-tipo-fila para determinar el tipo de fila
                const tipoFila = row.dataset.tipoFila;
                
                if (!tipoFila) {
                    console.warn('Fila sin data-tipo-fila:', row);
                    return;
                }
                
                row.addEventListener('dragover', (e) => {
                    // Usar la variable global en lugar de getData (que no funciona en dragover)
                    if (!tipoRecursoArrastrando) {
                        e.dataTransfer.dropEffect = 'none';
                        return;
                    }
                    
                    // Validar que el tipo de recurso coincida con el tipo de fila
                    const esVehiculo = tipoFila === 'vehiculo' && tipoRecursoArrastrando === 'vehiculo';
                    const esTecnico = tipoFila === 'tecnico' && tipoRecursoArrastrando === 'tecnico';
                    
                    if (esVehiculo || esTecnico) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.dataTransfer.dropEffect = 'move';
                        row.classList.add('drop-zone-active');
                    } else {
                        // No permitir drop si no coincide el tipo
                        e.dataTransfer.dropEffect = 'none';
                    }
                });
                
                row.addEventListener('dragleave', (e) => {
                    // Solo remover si realmente salimos de la fila
                    if (!row.contains(e.relatedTarget)) {
                        row.classList.remove('drop-zone-active');
                    }
                });
                
                // Variable para prevenir ejecución múltiple
                let dropProcesando = false;
                
                row.addEventListener('drop', async (e) => {
                    // Prevenir ejecución múltiple
                    if (dropProcesando) {
                        console.log('[DRAG&DROP] ⚠️ Drop ya en proceso, ignorando ejecución duplicada');
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    
                    // Marcar como procesando inmediatamente
                    dropProcesando = true;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('[DRAG&DROP] 📥 ========== DROP INICIADO ==========');
                    console.log('[DRAG&DROP] 📍 Drop Paso 1: Evento capturado', {
                        timestamp: new Date().toISOString(),
                        eventType: e.type,
                        target: {
                            tagName: e.target.tagName,
                            className: e.target.className
                        },
                        currentTarget: {
                            tagName: e.currentTarget.tagName,
                            className: e.currentTarget.className,
                            dataset: e.currentTarget.dataset
                        },
                        row: {
                            dataset: row.dataset,
                            tipoFila: row.dataset.tipoFila,
                            ruta: row.dataset.ruta,
                            attributes: Array.from(row.attributes).map(a => `${a.name}="${a.value}"`)
                        }
                    });
                    row.classList.remove('drop-zone', 'drop-zone-active');
                    
                    console.log('[DRAG&DROP] 📍 Drop Paso 2: Estado del dataTransfer', {
                        effectAllowed: e.dataTransfer.effectAllowed,
                        dropEffect: e.dataTransfer.dropEffect,
                        types: Array.from(e.dataTransfer.types || []),
                        files: e.dataTransfer.files?.length || 0,
                        items: e.dataTransfer.items?.length || 0
                    });
                    
                    // Obtener todos los datos del dataTransfer para debugging
                    // Intentar leer de múltiples formatos para compatibilidad
                    console.log('[DRAG&DROP] 📍 Drop Paso 3: Leyendo datos del dataTransfer', {
                        intentandoLeer: ['tipo', 'text/plain', 'username', 'text/username', 'nombre', 'text/nombre', 'vehiculo', 'text/vehiculo', 'rutaOrigen', 'text/rutaOrigen']
                    });
                    
                    let tipo = e.dataTransfer.getData('tipo');
                    const tipoTextPlain = e.dataTransfer.getData('text/plain');
                    if (!tipo) tipo = tipoTextPlain;
                    
                    const tipoFila = row.dataset.tipoFila;
                    
                    let rutaOrigen = e.dataTransfer.getData('rutaOrigen');
                    const rutaOrigenText = e.dataTransfer.getData('text/rutaOrigen');
                    if (!rutaOrigen) rutaOrigen = rutaOrigenText;
                    
                    const rutaDestino = row.dataset.ruta;
                    
                    // Obtener fecha de la fila (vista compacta) o del día seleccionado (vista total)
                    let fecha;
                    if (row.dataset.fechaRuta) {
                        fecha = row.dataset.fechaRuta;
                    } else {
                        // Vista total: usar el día seleccionado
                        fecha = formatearFechaParaInput(diaSeleccionado);
                    }
                    
                    // Obtener datos específicos según el tipo (guardar valores reales, no 'VACÍO')
                    let username = e.dataTransfer.getData('username');
                    const usernameText = e.dataTransfer.getData('text/username');
                    if (!username) username = usernameText;
                    
                    let nombre = e.dataTransfer.getData('nombre');
                    const nombreText = e.dataTransfer.getData('text/nombre');
                    if (!nombre) nombre = nombreText;
                    
                    let vehiculo = e.dataTransfer.getData('vehiculo');
                    const vehiculoText = e.dataTransfer.getData('text/vehiculo');
                    if (!vehiculo) vehiculo = vehiculoText;
                    
                    // Log completo de lo recibido en el drop (solo para logging)
                    const datosRecibidos = {
                        tipo: tipo || 'VACÍO',
                        tipoTextPlain: tipoTextPlain || 'VACÍO',
                        rutaOrigen: rutaOrigen || 'VACÍO',
                        rutaOrigenText: rutaOrigenText || 'VACÍO',
                        username: username || 'VACÍO',
                        usernameText: usernameText || 'VACÍO',
                        nombre: nombre || 'VACÍO',
                        nombreText: nombreText || 'VACÍO',
                        vehiculo: vehiculo || 'VACÍO',
                        vehiculoText: vehiculoText || 'VACÍO',
                        tiposDisponibles: Array.from(e.dataTransfer.types || [])
                    };
                    
                    console.log('[DRAG&DROP] 📍 Drop Paso 4: Datos leídos del dataTransfer', {
                        datosRecibidos: datosRecibidos,
                        destino: {
                            ruta: rutaDestino,
                            tipoFila: tipoFila
                        },
                        todosLosDatosRaw: {
                            tipo: e.dataTransfer.getData('tipo'),
                            tipoTextPlain: e.dataTransfer.getData('text/plain'),
                            username: e.dataTransfer.getData('username'),
                            usernameText: e.dataTransfer.getData('text/username'),
                            nombre: e.dataTransfer.getData('nombre'),
                            nombreText: e.dataTransfer.getData('text/nombre'),
                            vehiculo: e.dataTransfer.getData('vehiculo'),
                            vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                            rutaOrigen: e.dataTransfer.getData('rutaOrigen'),
                            rutaOrigenText: e.dataTransfer.getData('text/rutaOrigen')
                        }
                    });
                    
                    // Si rutaOrigen está vacío, significa que viene de "Sin asignar"
                    if (!rutaOrigen || rutaOrigen.trim() === '') {
                        rutaOrigen = null;
                    }
                    
                    // Validar que el tipo de recurso coincida con el tipo de fila
                    if ((tipoFila === 'vehiculo' && tipo !== 'vehiculo') || 
                        (tipoFila === 'tecnico' && tipo !== 'tecnico')) {
                        console.warn('[DRAG&DROP] ⚠️ Tipo de recurso no coincide con el tipo de fila', {
                            tipoRecurso: tipo,
                            tipoFila: tipoFila,
                            datosRecibidos: datosRecibidos
                        });
                        return;
                    }
                    
                    // Validar que el tipo no esté vacío
                    if (!tipo || tipo.trim() === '') {
                        console.error('[DRAG&DROP] ❌ Error crítico - tipo vacío en drop', {
                            datosRecibidos: datosRecibidos,
                            destino: {
                                ruta: rutaDestino,
                            tipoFila: tipoFila
                            },
                            problema: 'El dataTransfer no contiene el tipo del recurso. El dragstart puede no haberse ejecutado correctamente.',
                            sugerencia: 'Verifique que el elemento tenga el atributo data-tipo y que el dragstart se ejecute correctamente'
                        });
                        alert('Error: No se pudo determinar el tipo de recurso. Por favor, intente nuevamente.');
                        return;
                    }
                    
                    if (!rutaDestino) {
                        console.error('[DRAG&DROP] ❌ No se pudo determinar la ruta destino', {
                            datosRecibidos: datosRecibidos,
                            row: {
                                dataset: row.dataset,
                                attributes: Array.from(row.attributes).map(a => `${a.name}="${a.value}"`)
                            }
                        });
                        return;
                    }
                    
                    // Si es "Sin asignar", no permitir asignar recursos
                    if (rutaDestino === 'Sin asignar') {
                        return;
                    }
                    
                    try {
                        // Cargar datos actuales del ruteador destino
                        const datosActuales = await cargarRuteador(fecha, rutaDestino);
                        const tecnicosActuales = datosActuales.tecnicos || [];
                        const vehiculosActuales = datosActuales.vehiculos || [];
                        
                        let nuevosTecnicos = [...tecnicosActuales];
                        let nuevosVehiculos = [...vehiculosActuales];
                        
                        if (tipo === 'tecnico') {
                            // Usar las variables ya leídas en el Paso 4 (username y usernameText están disponibles en este scope)
                            // username ya tiene el valor de usernameText si estaba vacío (línea 8173)
                            
                            // Fallback a variable global si dataTransfer está vacío (como en el formulario)
                            if (!username || username.trim() === '') {
                                if (datosRecursoArrastrando.username) {
                                    username = datosRecursoArrastrando.username;
                                    console.log('[DRAG&DROP] 📍 Username obtenido de variable global (fallback)');
                                }
                            }
                            
                            if (!username || username.trim() === '') {
                                console.error('[DRAG&DROP] ❌ Username vacío en drop de ruta', {
                                    dataTransfer: {
                                        username: username,
                                        usernameText: usernameText
                                    },
                                    variableGlobal: datosRecursoArrastrando.username
                                });
                                alert('No se puede asignar el técnico porque no tiene un username válido.');
                                return;
                            }
                            
                            // Normalizar username
                            const empleado = window.empleados?.find(e => e.id === username || e.username === username);
                            if (empleado) {
                                username = empleado.username || empleado.id;
                            }
                            username = String(username).trim();
                            
                            console.log('[DRAG&DROP] ✅ Asignando técnico', {
                                username: username,
                                origen: rutaOrigen || 'sin asignar',
                                destino: rutaDestino
                            });
                            // Si viene de otra ruta, removerlo de ahí primero
                            if (rutaOrigen && rutaOrigen !== rutaDestino) {
                                const datosOrigen = await cargarRuteador(fecha, rutaOrigen);
                                // Filtrar el técnico removido (igual que en guardarRuteador)
                                const tecnicosOrigen = (datosOrigen.tecnicos || []).filter(t => {
                                    const tNormalizado = String(t).trim();
                                    const usernameNormalizado = String(username).trim();
                                    return tNormalizado !== '' && tNormalizado !== usernameNormalizado;
                                });
                                const vehiculosOrigen = (datosOrigen.vehiculos || []).filter(v => v && String(v).trim() !== '');
                                const idRuteadorOrigen = generarIdRuteador(fecha, rutaOrigen);
                                const ruteadorRefOrigen = doc(window.db, 'ruteador', idRuteadorOrigen);
                                await setDoc(ruteadorRefOrigen, {
                                    fecha: fecha,
                                    ruta: rutaOrigen,
                                    tecnicos: tecnicosOrigen,
                                    vehiculos: vehiculosOrigen,
                                    fecha_actualizacion: serverTimestamp()
                                }, { merge: true });
                            }
                            // Agregar a la nueva ruta si no está ya
                            if (!nuevosTecnicos.includes(username)) {
                                nuevosTecnicos.push(username);
                            }
                        } else if (tipo === 'vehiculo') {
                            // Intentar leer el vehículo de múltiples fuentes (como en drop de cita)
                            let vehiculo = null;
                            
                            // Primero intentar desde la variable global (más confiable, evita problemas de Tracking Prevention)
                            if (datosRecursoArrastrando.vehiculo) {
                                vehiculo = datosRecursoArrastrando.vehiculo;
                                console.log('[DRAG&DROP] 📍 Vehículo obtenido de variable global (drop ruta)', { vehiculo });
                            }
                            
                            // Si no está en la variable global, intentar desde dataTransfer
                            if (!vehiculo || vehiculo.trim() === '') {
                                vehiculo = e.dataTransfer.getData('vehiculo');
                            if (!vehiculo) vehiculo = e.dataTransfer.getData('text/vehiculo');
                            if (!vehiculo) vehiculo = e.dataTransfer.getData('text/plain');
                                if (vehiculo) {
                                    console.log('[DRAG&DROP] 📍 Vehículo obtenido de dataTransfer (drop ruta)', { vehiculo });
                                }
                            }
                            
                            // Si aún no se encuentra, intentar obtener del elemento que se arrastró
                            if (!vehiculo || vehiculo.trim() === '') {
                                const elementoArrastrado = document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging');
                                if (elementoArrastrado) {
                                    vehiculo = elementoArrastrado.dataset.vehiculo || 
                                              elementoArrastrado.getAttribute('data-vehiculo') ||
                                              elementoArrastrado.textContent?.trim() || '';
                                    console.log('[DRAG&DROP] 📍 Vehículo obtenido del elemento (drop ruta)', { vehiculo });
                                }
                            }
                            
                            if (!vehiculo || vehiculo.trim() === '') {
                                console.error('[DRAG&DROP] ❌ Vehículo vacío en drop de ruta', {
                                    datosGlobales: datosRecursoArrastrando,
                                    dataTransfer: {
                                        types: Array.from(e.dataTransfer.types || []),
                                        vehiculo: e.dataTransfer.getData('vehiculo'),
                                        vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                                        textPlain: e.dataTransfer.getData('text/plain')
                                    },
                                    elementoArrastrado: document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging')?.textContent
                                });
                                alert('No se puede asignar el vehículo porque no tiene un nombre válido.');
                                return;
                            }
                            
                            vehiculo = String(vehiculo).trim();
                            
                            console.log('[DRAG&DROP] ✅ Asignando vehículo', {
                                vehiculo: vehiculo,
                                origen: rutaOrigen || 'sin asignar',
                                destino: rutaDestino
                            });
                            // Si viene de otra ruta, removerlo de ahí primero
                            if (rutaOrigen && rutaOrigen !== rutaDestino) {
                                const datosOrigen = await cargarRuteador(fecha, rutaOrigen);
                                // Filtrar el vehículo removido (igual que en guardarRuteador)
                                const vehiculosOrigen = (datosOrigen.vehiculos || []).filter(v => {
                                    const vNormalizado = String(v).trim();
                                    const vehiculoNormalizado = String(vehiculo).trim();
                                    return vNormalizado !== '' && vNormalizado !== vehiculoNormalizado;
                                });
                                const tecnicosOrigen = (datosOrigen.tecnicos || []).filter(t => t && String(t).trim() !== '');
                                const idRuteadorOrigen = generarIdRuteador(fecha, rutaOrigen);
                                const ruteadorRefOrigen = doc(window.db, 'ruteador', idRuteadorOrigen);
                                await setDoc(ruteadorRefOrigen, {
                                    fecha: fecha,
                                    ruta: rutaOrigen,
                                    tecnicos: tecnicosOrigen,
                                    vehiculos: vehiculosOrigen,
                                    fecha_actualizacion: serverTimestamp()
                                }, { merge: true });
                            }
                            // Agregar a la nueva ruta si no está ya
                            if (!nuevosVehiculos.includes(vehiculo)) {
                                nuevosVehiculos.push(vehiculo);
                            }
                        }
                        
                        // Filtrar valores vacíos antes de guardar
                        nuevosTecnicos = nuevosTecnicos.filter(t => t && t.trim() !== '');
                        nuevosVehiculos = nuevosVehiculos.filter(v => v && v.trim() !== '');
                        
                        // Validar duplicados (solo si viene de sin asignar)
                        if (!rutaOrigen || rutaOrigen === rutaDestino) {
                            const duplicados = await validarDuplicadosRuteador(fecha, rutaDestino, nuevosTecnicos, nuevosVehiculos);
                            if (duplicados.length > 0) {
                                alert('No se puede asignar: ' + duplicados.join(', ') + ' ya está asignado a otra ruta en este día.');
                                return;
                            }
                        }
                        
                        // Filtrar valores vacíos antes de guardar (igual que en guardarRuteador)
                        const tecnicosFiltrados = nuevosTecnicos.filter(t => t && String(t).trim() !== '');
                        const vehiculosFiltrados = nuevosVehiculos.filter(v => v && String(v).trim() !== '');
                        
                        // Guardar en Firestore (usando la misma lógica que guardarRuteador)
                        const idRuteador = generarIdRuteador(fecha, rutaDestino);
                        const ruteadorRef = doc(window.db, 'ruteador', idRuteador);
                        
                        try {
                        await setDoc(ruteadorRef, {
                            fecha: fecha,
                            ruta: rutaDestino,
                            tecnicos: tecnicosFiltrados,
                            vehiculos: vehiculosFiltrados,
                            fecha_actualizacion: serverTimestamp()
                        }, { merge: true });
                            
                            console.log('[DRAG&DROP] ✅ Asignación completada exitosamente', {
                                ruta: rutaDestino,
                                fecha: fecha,
                                tecnicos: tecnicosFiltrados.length,
                                vehiculos: vehiculosFiltrados.length
                            });
                        
                        // Recargar cronograma (esto también actualizará las cajas de recursos sin asignar)
                        await generarCronograma();
                        } catch (error) {
                            console.error('[DRAG&DROP] ❌ Error al guardar asignación', {
                                ruta: rutaDestino,
                                fecha: fecha,
                                error: error.message,
                                stack: error.stack
                            });
                            alert('Error al guardar la asignación. Por favor, intente nuevamente.');
                            return;
                        }
                        
                        // Mostrar notificación
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Recurso asignado exitosamente';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 2000);
                    } catch (error) {
                        console.error('Error asignando recurso:', error);
                        const errorMessage = error.message || error.toString() || 'Error desconocido';
                        alert('Error al asignar recurso: ' + errorMessage);
                    } finally {
                        // Liberar el flag después de un breve delay para permitir que termine completamente
                        setTimeout(() => {
                            dropProcesando = false;
                        }, 100);
                    }
                });
            });
            
            // Agregar soporte para arrastrar a las citas individuales
            // Buscar citas en todas las vistas (calendario mensual, vista diaria, cronograma)
            const citas = document.querySelectorAll('.cita-item[data-cita-id], .cita-bloque[data-cita-id]');
            console.log('[DRAG&DROP] 📊 Citas encontradas para configurar drop', {
                totalCitas: citas.length,
                citasItem: document.querySelectorAll('.cita-item[data-cita-id]').length,
                citasBloque: document.querySelectorAll('.cita-bloque[data-cita-id]').length
            });
            
            citas.forEach(cita => {
                const citaId = cita.getAttribute('data-cita-id');
                
                cita.addEventListener('dragover', (e) => {
                    // Usar la variable global en lugar de getData (que no funciona en dragover)
                    if (!tipoRecursoArrastrando) {
                        e.dataTransfer.dropEffect = 'none';
                        return;
                    }
                    
                    // Permitir drop de técnicos y vehículos en cualquier cita
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'move';
                    cita.classList.add('drop-zone-active');
                });
                
                cita.addEventListener('dragleave', (e) => {
                    // Solo remover si realmente salimos de la cita
                    if (!cita.contains(e.relatedTarget)) {
                        cita.classList.remove('drop-zone-active');
                    }
                });
                
                cita.addEventListener('drop', async (e) => {
                    console.log('[DRAG&DROP] 📥 ========== DROP EN CITA INICIADO ==========');
                    console.log('[DRAG&DROP] 📍 Drop en Cita Paso 1: Evento capturado', {
                        timestamp: new Date().toISOString(),
                        citaId: citaId,
                        eventType: e.type
                    });
                    
                    e.preventDefault();
                    e.stopPropagation();
                    cita.classList.remove('drop-zone-active');
                    
                    // Obtener datos del dataTransfer
                    console.log('[DRAG&DROP] 📍 Drop en Cita - Estado del dataTransfer', {
                        types: Array.from(e.dataTransfer.types || []),
                        effectAllowed: e.dataTransfer.effectAllowed,
                        dropEffect: e.dataTransfer.dropEffect,
                        todosLosDatos: {
                            tipo: e.dataTransfer.getData('tipo'),
                            tipoTextPlain: e.dataTransfer.getData('text/plain'),
                            vehiculo: e.dataTransfer.getData('vehiculo'),
                            vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                            username: e.dataTransfer.getData('username'),
                            usernameText: e.dataTransfer.getData('text/username')
                        }
                    });
                    
                    let tipo = e.dataTransfer.getData('tipo');
                    const tipoTextPlain = e.dataTransfer.getData('text/plain');
                    if (!tipo) tipo = tipoTextPlain;
                    
                    if (!tipo || tipo.trim() === '') {
                        console.error('[DRAG&DROP] ❌ Error - tipo vacío en drop de cita', {
                            types: Array.from(e.dataTransfer.types || []),
                            todosLosDatos: {
                                tipo: e.dataTransfer.getData('tipo'),
                                tipoTextPlain: e.dataTransfer.getData('text/plain')
                            }
                        });
                        return;
                    }
                    
                    // Obtener la cita desde Firestore para conocer su ruta
                    try {
                        const citaRef = doc(window.db, 'citas', citaId);
                        const citaDoc = await getDoc(citaRef);
                        
                        if (!citaDoc.exists()) {
                            console.error('[DRAG&DROP] ❌ Cita no encontrada', { citaId });
                            alert('No se pudo encontrar la cita. Por favor, intente nuevamente.');
                            return;
                        }
                        
                        const citaData = citaDoc.data();
                        const rutaCita = window.obtenerRuta(citaData);
                        
                        if (rutaCita === 'Sin asignar') {
                            alert('No se puede asignar un recurso a una cita sin ruta. Por favor, asigne primero una ruta a la cita.');
                            return;
                        }
                        
                        console.log('[DRAG&DROP] 📍 Drop en Cita Paso 2: Datos de la cita', {
                            citaId: citaId,
                            ruta: rutaCita,
                            tipo: tipo
                        });
                        
                        // Obtener la fecha de la cita (estándar: inicio_gmt6)
                        const inicioVal = window.obtenerInicio(citaData);
                        const inicioCita = inicioVal?.toDate ? inicioVal.toDate() : (inicioVal ? new Date(inicioVal) : null);
                        if (!inicioCita || isNaN(inicioCita.getTime())) {
                            console.error('[DRAG&DROP] Cita sin fecha válida (inicio_gmt6)');
                            return;
                        }
                        const fechaCita = `${inicioCita.getFullYear()}-${String(inicioCita.getMonth() + 1).padStart(2, '0')}-${String(inicioCita.getDate()).padStart(2, '0')}`;
                        
                        // Cargar datos actuales del ruteador
                        const datosActuales = await cargarRuteador(fechaCita, rutaCita);
                        const tecnicosActuales = datosActuales.tecnicos || [];
                        const vehiculosActuales = datosActuales.vehiculos || [];
                        
                        let nuevosTecnicos = [...tecnicosActuales];
                        let nuevosVehiculos = [...vehiculosActuales];
                        
                        if (tipo === 'tecnico') {
                            let username = e.dataTransfer.getData('username');
                            const usernameText = e.dataTransfer.getData('text/username');
                            if (!username) username = usernameText;
                            
                            if (!username || username.trim() === '') {
                                console.error('[DRAG&DROP] ❌ Username vacío en drop de cita');
                                alert('No se puede asignar el técnico porque no tiene un username válido.');
                                return;
                            }
                            
                            // Normalizar username
                            const empleado = window.empleados?.find(e => e.id === username || e.username === username);
                            if (empleado) {
                                username = empleado.username || empleado.id;
                            }
                            username = String(username).trim();
                            
                            // Agregar si no está ya
                            if (!nuevosTecnicos.includes(username)) {
                                nuevosTecnicos.push(username);
                            }
                        } else if (tipo === 'vehiculo') {
                            // Intentar leer el vehículo de múltiples fuentes
                            let vehiculo = null;
                            
                            // Primero intentar desde la variable global (más confiable)
                            if (datosRecursoArrastrando.vehiculo) {
                                vehiculo = datosRecursoArrastrando.vehiculo;
                                console.log('[DRAG&DROP] 📍 Vehículo obtenido de variable global', { vehiculo });
                            }
                            
                            // Si no está en la variable global, intentar desde dataTransfer
                            if (!vehiculo || vehiculo.trim() === '') {
                                vehiculo = e.dataTransfer.getData('vehiculo');
                                if (!vehiculo) vehiculo = e.dataTransfer.getData('text/vehiculo');
                                if (!vehiculo) vehiculo = e.dataTransfer.getData('text/plain');
                                if (vehiculo) {
                                    console.log('[DRAG&DROP] 📍 Vehículo obtenido de dataTransfer', { vehiculo });
                                }
                            }
                            
                            // Si aún no se encuentra, intentar obtener del elemento que se arrastró
                            if (!vehiculo || vehiculo.trim() === '') {
                                console.warn('[DRAG&DROP] ⚠️ Vehículo no encontrado en dataTransfer ni variable global, intentando obtener del elemento...', {
                                    datosGlobales: datosRecursoArrastrando,
                                    tiposDisponibles: Array.from(e.dataTransfer.types || []),
                                    todosLosDatos: {
                                        vehiculo: e.dataTransfer.getData('vehiculo'),
                                        vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                                        textPlain: e.dataTransfer.getData('text/plain'),
                                        tipo: e.dataTransfer.getData('tipo')
                                    }
                                });
                                
                                // Intentar obtener del elemento original usando la variable global
                                const elementoArrastrado = document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging');
                                if (elementoArrastrado) {
                                    vehiculo = elementoArrastrado.dataset.vehiculo || 
                                              elementoArrastrado.getAttribute('data-vehiculo') ||
                                              elementoArrastrado.textContent?.trim() || '';
                                    console.log('[DRAG&DROP] 📍 Vehículo obtenido del elemento', { vehiculo });
                                }
                            }
                            
                            if (!vehiculo || vehiculo.trim() === '') {
                                console.error('[DRAG&DROP] ❌ Vehículo vacío en drop de cita', {
                                    datosGlobales: datosRecursoArrastrando,
                                    dataTransfer: {
                                        types: Array.from(e.dataTransfer.types || []),
                                        vehiculo: e.dataTransfer.getData('vehiculo'),
                                        vehiculoText: e.dataTransfer.getData('text/vehiculo'),
                                        textPlain: e.dataTransfer.getData('text/plain')
                                    },
                                    elementoArrastrado: document.querySelector('.recurso-item.dragging, .ruta-badge-item.dragging')?.textContent
                                });
                                alert('No se puede asignar el vehículo porque no tiene un nombre válido.');
                                return;
                            }
                            
                            vehiculo = String(vehiculo).trim();
                            
                            console.log('[DRAG&DROP] ✅ Vehículo obtenido correctamente', { vehiculo });
                            
                            // Agregar si no está ya
                            if (!nuevosVehiculos.includes(vehiculo)) {
                                nuevosVehiculos.push(vehiculo);
                            }
                        }
                        
                        // Filtrar valores vacíos
                        nuevosTecnicos = nuevosTecnicos.filter(t => t && String(t).trim() !== '');
                        nuevosVehiculos = nuevosVehiculos.filter(v => v && String(v).trim() !== '');
                        
                        // Guardar en Firestore
                        const idRuteador = generarIdRuteador(fechaCita, rutaCita);
                        const ruteadorRef = doc(window.db, 'ruteador', idRuteador);
                        
                        await setDoc(ruteadorRef, {
                            fecha: fechaCita,
                            ruta: rutaCita,
                            tecnicos: nuevosTecnicos,
                            vehiculos: nuevosVehiculos,
                            fecha_actualizacion: serverTimestamp()
                        }, { merge: true });
                        
                        console.log('[DRAG&DROP] ✅ Recurso asignado a la ruta de la cita exitosamente', {
                            citaId: citaId,
                            ruta: rutaCita,
                            fecha: fechaCita,
                            tipo: tipo
                        });
                        
                        // Recargar cronograma
                        await generarCronograma();
                        
                        // Mostrar notificación
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Recurso asignado exitosamente a la ruta de la cita';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 2000);
                    } catch (error) {
                        console.error('[DRAG&DROP] ❌ Error al asignar recurso a la cita', {
                            citaId: citaId,
                            error: error.message,
                            stack: error.stack
                        });
                        alert('Error al asignar recurso: ' + error.message);
                    }
                });
            });
            
            console.log('[DRAG&DROP] ✅ Listeners de drop agregados a citas', {
                totalCitas: citas.length
            });
            
            dragAndDropCitasConfigurado = true;
            
            // También configurar listeners para citas que se agreguen dinámicamente después
            // usando un MutationObserver o reconfigurando después de un pequeño delay
            setTimeout(() => {
                const citasTardias = document.querySelectorAll('.cita-item[data-cita-id]:not([data-drag-configured]), .cita-bloque[data-cita-id]:not([data-drag-configured])');
                if (citasTardias.length > 0) {
                    console.log('[DRAG&DROP] 📊 Configurando drop para citas agregadas tardíamente', {
                        totalCitasTardias: citasTardias.length
                    });
                    // Reconfigurar para estas citas también (la función ya maneja esto, pero marcamos para evitar duplicados)
                    citasTardias.forEach(cita => {
                        cita.setAttribute('data-drag-configured', 'true');
                    });
                }
            }, 500);
        }
        
        // Configurar listeners automáticamente cuando se detecten citas en el DOM
        // Esto asegura que funcione incluso si las citas se generan después de que se llame inicializarDragAndDropRecursos
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver((mutations) => {
                const citasNuevas = document.querySelectorAll('.cita-item[data-cita-id]:not([data-drag-configured]), .cita-bloque[data-cita-id]:not([data-drag-configured])');
                if (citasNuevas.length > 0 && dragAndDropCitasConfigurado) {
                    // Si ya se configuró antes, solo agregar listeners a las citas nuevas
                    console.log('[DRAG&DROP] 📊 Detectadas citas nuevas, configurando drop...', {
                        totalCitasNuevas: citasNuevas.length
                    });
                    // Obtener la fecha actual del día seleccionado o usar la fecha actual
                    const fechaActual = window.diaSeleccionado ? 
                        `${window.diaSeleccionado.getFullYear()}-${String(window.diaSeleccionado.getMonth() + 1).padStart(2, '0')}-${String(window.diaSeleccionado.getDate()).padStart(2, '0')}` :
                        new Date().toISOString().split('T')[0];
                    inicializarDragAndDropRecursos(fechaActual);
                }
            });
            
            // Observar cambios en el DOM
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        // Variable global para almacenar productos
        window.todosLosProductos = [];
        
        // Función para cargar productos desde Firestore
        window.cargarProductos = async function() {
            try {
                const q = query(collection(window.db, 'productos'), where('activo', '==', true), orderBy('nombre', 'asc'));
                const querySnapshot = await getDocs(q);
                window.todosLosProductos = [];
                querySnapshot.forEach(doc => {
                    window.todosLosProductos.push({ id: doc.id, ...doc.data() });
                });
                console.log('✅ Productos cargados:', window.todosLosProductos.length);
                return window.todosLosProductos;
            } catch (error) {
                // Si el error es por índice en construcción o no disponible, usar fallback
                if (error.code === 'failed-precondition' || error.message.includes('index') || error.message.includes('building')) {
                    console.log('ℹ️ Índice en construcción, usando fallback sin filtro activo...');
                } else {
                console.error('❌ Error cargando productos:', error);
                }
                // Si falla por falta de índice, intentar sin el filtro activo
                try {
                    const q2 = query(collection(window.db, 'productos'), orderBy('nombre', 'asc'));
                    const querySnapshot2 = await getDocs(q2);
                    window.todosLosProductos = [];
                    querySnapshot2.forEach(doc => {
                        const data = doc.data();
                        if (data.activo !== false) { // Incluir si activo no es false explícitamente
                            window.todosLosProductos.push({ id: doc.id, ...data });
                        }
                    });
                    console.log('✅ Productos cargados (sin filtro activo):', window.todosLosProductos.length);
                    return window.todosLosProductos;
                } catch (error2) {
                    console.error('❌ Error cargando productos (intento 2):', error2);
                    return [];
                }
            }
        };
        
        // Función para renderizar productos con cantidad en el formulario de citas
        window.renderizarProductosCheckboxes = function(productosSeleccionados = []) {
            const container = document.getElementById('editProductosContainer');
            if (!container) return;
            
            if (window.todosLosProductos.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>No hay productos disponibles.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.todosLosProductos.map(producto => {
                // Buscar si el producto está seleccionado y obtener su cantidad
                const productoSeleccionado = productosSeleccionados.find(p => 
                    (typeof p === 'string' && p === producto.id) || 
                    (typeof p === 'object' && p.id === producto.id)
                );
                
                const cantidad = productoSeleccionado 
                    ? (typeof productoSeleccionado === 'object' ? productoSeleccionado.cantidad : 1)
                    : 0;
                
                const estaSeleccionado = cantidad > 0;
                const costo = producto.precioUnitario || producto.precio || 0;
                
                return `
                    <div class="d-flex align-items-center mb-3 p-2 border rounded" style="background-color: ${estaSeleccionado ? '#e7f3ff' : '#f8f9fa'};">
                        <div class="form-check me-3">
                            <input class="form-check-input producto-checkbox" 
                                   type="checkbox" 
                                   value="${producto.id}" 
                                   id="producto_${producto.id}"
                                   data-costo="${costo}"
                                   ${estaSeleccionado ? 'checked' : ''}>
                        </div>
                        <label class="form-check-label flex-grow-1" for="producto_${producto.id}" style="cursor: pointer;">
                            <strong>${producto.nombre || 'Sin nombre'}</strong>
                            <br>
                            <small class="text-muted">Costo unitario: ₡${costo.toLocaleString('es-CR')}</small>
                        </label>
                        <div class="ms-3" style="min-width: 120px;">
                            <label class="form-label small mb-0">Cantidad:</label>
                            <input type="number" 
                                   class="form-control form-control-sm producto-cantidad" 
                                   id="cantidad_${producto.id}"
                                   value="${cantidad}"
                                   min="0"
                                   step="1"
                                   data-producto-id="${producto.id}"
                                   data-costo="${costo}"
                                   ${!estaSeleccionado ? 'disabled' : ''}
                                   style="width: 80px;">
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners para checkboxes
            container.querySelectorAll('.producto-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const productoId = e.target.value;
                    const cantidadInput = document.getElementById(`cantidad_${productoId}`);
                    
                    if (e.target.checked) {
                        cantidadInput.disabled = false;
                        if (parseInt(cantidadInput.value) <= 0) {
                            cantidadInput.value = 1;
                        }
                    } else {
                        cantidadInput.disabled = true;
                        cantidadInput.value = 0;
                    }
                    
                    // Actualizar estilo del contenedor
                    const contenedor = e.target.closest('.border.rounded');
                    if (e.target.checked) {
                        contenedor.style.backgroundColor = '#e7f3ff';
                    } else {
                        contenedor.style.backgroundColor = '#f8f9fa';
                    }
                    
                    window.actualizarResumenFinanciero();
                });
            });
            
            // Agregar event listeners para inputs de cantidad
            container.querySelectorAll('.producto-cantidad').forEach(input => {
                input.addEventListener('input', () => {
                    window.actualizarResumenFinanciero();
                });
                
                input.addEventListener('change', (e) => {
                    const cantidad = parseInt(e.target.value) || 0;
                    const checkbox = document.getElementById(`producto_${e.target.getAttribute('data-producto-id')}`);
                    
                    if (cantidad <= 0) {
                        checkbox.checked = false;
                        e.target.disabled = true;
                        e.target.value = 0;
                        const contenedor = checkbox.closest('.border.rounded');
                        contenedor.style.backgroundColor = '#f8f9fa';
                    } else {
                        checkbox.checked = true;
                        e.target.disabled = false;
                        const contenedor = checkbox.closest('.border.rounded');
                        contenedor.style.backgroundColor = '#e7f3ff';
                    }
                    
                    window.actualizarResumenFinanciero();
                });
            });
        };
        
        // Función para obtener productos seleccionados desde checkboxes (solo si se usa esa UI). La fuente de verdad para edit/new es obtenerProductosSeleccionados(prefix) que usa productosSeleccionadosEdit/New.
        window.obtenerProductosSeleccionadosDesdeCheckboxes = function() {
            const checkboxes = document.querySelectorAll('#editProductosContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => {
                const productoId = cb.value;
                const cantidadInput = document.getElementById(`cantidad_${productoId}`);
                const cantidad = parseInt(cantidadInput ? cantidadInput.value : 1) || 1;
                return { id: productoId, cantidad: cantidad };
            });
        };
        
        // Variable para rastrear si el usuario está editando manualmente el monto de venta
        window.editandoMontoVentaManual = { edit: false, new: false };
        
        /**
         * Construye detalle_cotizacion, total_servicios y total_productos desde el formulario (edit o new).
         * Para guardar en metadata y tener el detalle de lo cotizado al cliente.
         */
        window.obtenerDetalleCotizacionParaGuardar = function(prefix) {
            const serviciosSeleccionados = window.obtenerServiciosSeleccionados ? window.obtenerServiciosSeleccionados(prefix) : [];
            const productosSeleccionados = window.obtenerProductosSeleccionados ? window.obtenerProductosSeleccionados(prefix) : (prefix === 'edit' ? (window.productosSeleccionadosEdit || []) : (window.productosSeleccionadosNew || []));
            let totalServicios = 0;
            const serviciosDetalle = (serviciosSeleccionados || []).map(serv => {
                const servicioId = typeof serv === 'string' ? serv : (serv && serv.id);
                const servicio = window.todosLosServicios && window.todosLosServicios.find(s => s.id === servicioId);
                const precio = typeof serv === 'object' && serv !== null && serv.precio !== undefined ? serv.precio : (servicio ? (servicio.precio || 0) : 0);
                const cantidad = typeof serv === 'object' && serv !== null && (serv.cantidad !== undefined) ? serv.cantidad : 1;
                const subtotal = precio * cantidad;
                totalServicios += subtotal;
                return { id: servicioId, nombre: servicio ? (servicio.nombre || '') : '', cantidad, precio_unitario: precio, subtotal };
            });
            let totalProductos = 0;
            const productosDetalle = (productosSeleccionados || []).map(item => {
                const productoId = typeof item === 'object' ? item.id : item;
                const producto = window.todosLosProductos && window.todosLosProductos.find(p => p.id === productoId);
                const precioCobrado = typeof item === 'object' && item !== null && item.precio !== undefined ? item.precio : (producto ? (producto.costo ?? producto.precio_venta ?? producto.precio ?? 0) : 0);
                const cantidad = typeof item === 'object' && item !== null ? (item.cantidad || 1) : 1;
                const subtotal = precioCobrado * cantidad;
                totalProductos += subtotal;
                return { id: productoId, nombre: producto ? (producto.nombre || '') : '', cantidad, costo_unitario: precioCobrado, subtotal };
            });
            return {
                total_servicios: totalServicios,
                total_productos: totalProductos,
                detalle_cotizacion: { servicios: serviciosDetalle, productos: productosDetalle }
            };
        };
        
        // Función para calcular el monto de venta automáticamente
        window.calcularMontoVenta = function(prefix = 'edit') {
            // Si el usuario está editando manualmente, no sobrescribir
            if (window.editandoMontoVentaManual[prefix]) {
                return;
            }
            
            // Obtener el precio total de servicios: del campo si existe, si no desde la suma de servicios seleccionados
            const precioTotalServiciosInput = document.getElementById(prefix === 'edit' ? 'editPrecioTotalServicios' : 'newPrecioTotalServicios');
            let totalServicios = 0;
            if (precioTotalServiciosInput) {
                totalServicios = parseFloat(window.extraerValorNumerico(precioTotalServiciosInput.value) || '0') || 0;
            } else {
                const selected = prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew;
                (selected || []).forEach(serv => {
                    const precioUnitario = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : 0;
                    const cantidad = typeof serv === 'object' && serv.cantidad !== undefined ? serv.cantidad : 1;
                    totalServicios += precioUnitario * cantidad;
                });
            }
            
            // Calcular total de productos (precio cobrado x cantidad)
            const productosSeleccionados = window.obtenerProductosSeleccionados(prefix);
            let totalProductos = 0;
            productosSeleccionados.forEach(item => {
                const id = typeof item === 'object' ? item.id : item;
                const cantidad = typeof item === 'object' ? (item.cantidad || 1) : 1;
                const precio = typeof item === 'object' && item.precio !== undefined ? item.precio : (window.todosLosProductos && (() => { const p = window.todosLosProductos.find(x => x.id === id); return p ? (p.costo ?? p.precio_venta ?? p.precio ?? 0) : 0; })());
                totalProductos += precio * cantidad;
            });
            
            // Calcular monto de venta: Servicios + Productos (MECE)
            const montoVentaCalculado = totalServicios + totalProductos;
            const countServicios = ((prefix === 'edit' ? window.serviciosSeleccionadosEdit : window.serviciosSeleccionadosNew) || []).length;
            const countProductos = (productosSeleccionados || []).length;
            
            // Actualizar el campo de monto de venta
            const montoVentaInput = document.getElementById(prefix === 'edit' ? 'editMontoVenta' : 'newMontoVenta');
            if (montoVentaInput) {
                // Solo no actualizar cuando no hay ningún servicio ni producto (count 0) y ya hay un monto > 0 (citas CSV/sin desglose)
                // Si hay al menos un servicio o producto, siempre actualizar (incluso si la suma es 0)
                const valorActual = parseFloat(window.extraerValorNumerico(montoVentaInput.value) || '0') || 0;
                if (countServicios === 0 && countProductos === 0 && montoVentaCalculado === 0 && valorActual > 0) {
                    return;
                }
                const montoFormateado = window.formatearMontoVenta(montoVentaCalculado);
                montoVentaInput.value = montoFormateado;
            }
        };
        
        // Función para calcular y actualizar resumen financiero
        window.actualizarResumenFinanciero = function() {
            // Obtener el precio total de servicios: del campo si existe, si no desde la suma de servicios
            const precioTotalServiciosInput = document.getElementById('editPrecioTotalServicios');
            let totalServicios = 0;
            if (precioTotalServiciosInput) {
                totalServicios = parseFloat(window.extraerValorNumerico(precioTotalServiciosInput.value) || '0') || 0;
            } else {
                (window.serviciosSeleccionadosEdit || []).forEach(serv => {
                    const precioUnitario = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : 0;
                    const cantidad = typeof serv === 'object' && serv.cantidad !== undefined ? serv.cantidad : 1;
                    totalServicios += precioUnitario * cantidad;
                });
            }
            
            // Calcular total de productos (precio cobrado x cantidad)
            const productosSeleccionados = window.obtenerProductosSeleccionados('edit');
            let totalProductos = 0;
            productosSeleccionados.forEach(item => {
                const id = typeof item === 'object' ? item.id : item;
                const cantidad = typeof item === 'object' ? (item.cantidad || 1) : 1;
                const precio = typeof item === 'object' && item.precio !== undefined ? item.precio : (window.todosLosProductos && (() => { const p = window.todosLosProductos.find(x => x.id === id); return p ? (p.costo ?? p.precio_venta ?? p.precio ?? 0) : 0; })());
                totalProductos += precio * cantidad;
            });
            
            // Calcular monto de venta automáticamente si no está siendo editado manualmente
            window.calcularMontoVenta('edit');
            
            // Obtener monto de venta (extraer valor numérico sin formato)
            const montoVentaInput = document.getElementById('editMontoVenta');
            const montoVenta = parseFloat(montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0') || 0;
            
            // Actualizar UI: Servicios + Productos = Monto de Venta
            document.getElementById('totalServicios').textContent = `₡${totalServicios.toLocaleString('es-CR')}`;
            document.getElementById('totalProductos').textContent = `₡${totalProductos.toLocaleString('es-CR')}`;
            document.getElementById('montoVentaDisplay').textContent = `₡${montoVenta.toLocaleString('es-CR')}`;
        };
        
        // Función para calcular y actualizar resumen financiero del modal de nueva cita
        window.actualizarResumenFinancieroNew = function() {
            // Obtener el precio total de servicios: del campo si existe, si no desde la suma de servicios
            const precioTotalServiciosInput = document.getElementById('newPrecioTotalServicios');
            let totalServicios = 0;
            if (precioTotalServiciosInput) {
                totalServicios = parseFloat(window.extraerValorNumerico(precioTotalServiciosInput.value) || '0') || 0;
            } else {
                (window.serviciosSeleccionadosNew || []).forEach(serv => {
                    const precioUnitario = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : 0;
                    const cantidad = typeof serv === 'object' && serv.cantidad !== undefined ? serv.cantidad : 1;
                    totalServicios += precioUnitario * cantidad;
                });
            }
            
            // Calcular total de productos (precio cobrado x cantidad)
            const productosSeleccionados = window.obtenerProductosSeleccionados ? window.obtenerProductosSeleccionados('new') : (window.productosSeleccionadosNew || []);
            let totalProductos = 0;
            productosSeleccionados.forEach(item => {
                const id = typeof item === 'object' ? item.id : item;
                const cantidad = typeof item === 'object' ? (item.cantidad || 1) : 1;
                const precio = typeof item === 'object' && item.precio !== undefined ? item.precio : (window.todosLosProductos && (() => { const p = window.todosLosProductos.find(x => x.id === id); return p ? (p.costo ?? p.precio_venta ?? p.precio ?? 0) : 0; })());
                totalProductos += precio * cantidad;
            });

            // Calcular monto de venta automáticamente si no está siendo editado manualmente (Servicios + Productos)
            window.calcularMontoVenta('new');
            
            const montoVentaInput = document.getElementById('newMontoVenta');
            const montoVenta = parseFloat(montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0') || 0;
            
            // Actualizar UI: Servicios + Productos = Monto de Venta
            const totalServiciosEl = document.getElementById('newTotalServicios');
            const totalProductosEl = document.getElementById('newTotalProductos');
            const montoVentaEl = document.getElementById('newMontoVentaDisplay');
            if (totalServiciosEl) totalServiciosEl.textContent = `₡${totalServicios.toLocaleString('es-CR')}`;
            if (totalProductosEl) totalProductosEl.textContent = `₡${totalProductos.toLocaleString('es-CR')}`;
            if (montoVentaEl) montoVentaEl.textContent = `₡${montoVenta.toLocaleString('es-CR')}`;
        };
        
        // Nota: obtenerProductos puede retornar array de IDs o array de objetos {id, cantidad}
        // Esta versión simplificada retorna el array tal cual está en metadata
        // Si se necesita normalizar a objetos, hacerlo en el código que lo usa
        // window.obtenerProductos ya está definido arriba usando obtenerCampoCita
        
        // Función para generar y descargar proforma PNG
        window.generarProformaPNG = async function() {
            if (!selectedCita) {
                alert('No hay cita seleccionada');
                return;
            }
            
            try {
                // Obtener todos los datos de la cita (nombre en síncrono para proforma)
                let clienteNombre = (window.obtenerClienteNombreSync && window.obtenerClienteNombreSync(selectedCita)) || window.obtenerCampoCita(selectedCita, 'cliente_nombre', '') || '';
                if (clienteNombre == null || typeof clienteNombre !== 'string') clienteNombre = String(clienteNombre || 'Sin nombre').trim() || 'Sin nombre';
                else clienteNombre = String(clienteNombre).trim() || 'Sin nombre';
                const nombreArchivoSeguro = (String(clienteNombre).replace(/\s+/g, '_').replace(/[^\w\-]/g, '') || 'Sin_nombre').slice(0, 80);
                const telefonoRaw = window.obtenerTelefono(selectedCita);
                
                // Formatear teléfono: remover 506 y formatear como XXXX-XXXX
                let telefonoFormateado = telefonoRaw || '';
                if (telefonoFormateado.startsWith('506')) {
                    telefonoFormateado = telefonoFormateado.substring(3); // Remover "506"
                }
                // Remover cualquier carácter no numérico y tomar últimos 8 dígitos
                const soloNumeros = telefonoFormateado.replace(/\D/g, '');
                if (soloNumeros.length >= 8) {
                    const ultimos8 = soloNumeros.slice(-8);
                    telefonoFormateado = `${ultimos8.slice(0, 4)}-${ultimos8.slice(4)}`;
                } else if (soloNumeros.length > 0) {
                    // Si tiene menos de 8 dígitos, mostrar como está pero con guion si es posible
                    telefonoFormateado = soloNumeros;
                }
                
                const direccion = window.obtenerDireccion(selectedCita) || 'No especificada';
                const fechaInicio = window.formatearFecha(window.obtenerInicio(selectedCita));
                const duracion = window.obtenerDuracion(selectedCita);
                const montoVenta = window.obtenerMonto(selectedCita) || 0;
                
                // Obtener datos de ubicación (provincia, cantón, distrito)
                const provinciaId = window.obtenerCampoCita(selectedCita, 'provinciaId', null);
                const cantonId = window.obtenerCampoCita(selectedCita, 'cantonId', null);
                const distritoId = window.obtenerCampoCita(selectedCita, 'distritoId', null);
                
                let provinciaNombre = '';
                let cantonNombre = '';
                let distritoNombre = '';
                let coordenadasMapa = null;
                
                // Cargar ubicaciones si no están cargadas
                if (!window.ubicacionesCR) {
                    await cargarUbicaciones();
                }
                
                if (provinciaId && window.ubicacionesCR && window.ubicacionesCR[provinciaId]) {
                    provinciaNombre = window.ubicacionesCR[provinciaId].nombre || '';
                    
                    if (cantonId && window.ubicacionesCR[provinciaId].cantones && window.ubicacionesCR[provinciaId].cantones[cantonId]) {
                        cantonNombre = window.ubicacionesCR[provinciaId].cantones[cantonId].nombre || '';
                        
                        if (distritoId && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                            distritoNombre = window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre || '';
                        }
                    }
                    
                    // Intentar obtener coordenadas para el mapa (máxima jerarquía al distrito)
                    try {
                        let data = null;
                        
                        // Intentar búsquedas progresivas, priorizando distrito
                        const queries = [];
                        
                        // 1. Solo distrito + cantón (máxima jerarquía al distrito)
                        if (distritoNombre && cantonNombre) {
                            queries.push(`${distritoNombre}, ${cantonNombre}, Costa Rica`);
                        }
                        
                        // 2. Solo distrito (máxima especificidad)
                        if (distritoNombre) {
                            queries.push(`${distritoNombre}, Costa Rica`);
                        }
                        
                        // 3. Distrito + cantón + provincia (fallback)
                        if (distritoNombre && cantonNombre && provinciaNombre) {
                            queries.push(`${distritoNombre}, ${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                        }
                        
                        // 4. Cantón + provincia (si no hay distrito)
                        if (!distritoNombre && cantonNombre && provinciaNombre) {
                            queries.push(`${cantonNombre}, ${provinciaNombre}, Costa Rica`);
                        }
                        
                        // 5. Solo provincia (último recurso)
                        if (!distritoNombre && !cantonNombre && provinciaNombre) {
                            queries.push(`${provinciaNombre}, Costa Rica`);
                        }
                        
                        // Intentar cada query hasta encontrar resultados
                        for (const query of queries) {
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                            const result = await response.json();
                            
                            if (result && result.length > 0) {
                                data = result;
                                break;
                            }
                        }
                        
                        if (data && data.length > 0) {
                            coordenadasMapa = {
                                lat: parseFloat(data[0].lat),
                                lon: parseFloat(data[0].lon)
                            };
                        }
                    } catch (error) {
                        console.warn('No se pudieron obtener coordenadas para el mapa:', error);
                    }
                }
                
                // Formatear fecha y hora (compacto pero con día de la semana)
                let fechaFormateada = 'No especificada';
                let horaFormateada = 'No especificada';
                
                if (fechaInicio) {
                    const diasSemana = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
                    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    
                    const diaSemana = diasSemana[fechaInicio.getDay()];
                    const dia = fechaInicio.getDate();
                    const mes = meses[fechaInicio.getMonth()];
                    const año = fechaInicio.getFullYear();
                    
                    fechaFormateada = `${diaSemana}, ${dia} de ${mes} de ${año}`;
                    
                    horaFormateada = fechaInicio.toLocaleTimeString('es-CR', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true
                    });
                }
                
                // Obtener servicios (con precios personalizados)
                const serviciosSeleccionados = window.obtenerServiciosSeleccionados('edit');
                let totalServicios = 0;
                const serviciosDetalle = serviciosSeleccionados.map(serv => {
                    // serv puede ser string (ID) u objeto {id, cantidad, precio}
                    const servicioId = typeof serv === 'string' ? serv : serv.id;
                    const servicio = window.todosLosServicios.find(s => s.id === servicioId);
                    if (servicio) {
                        // Usar precio personalizado si existe, sino usar precio del servicio base
                        const precio = typeof serv === 'object' && serv.precio !== undefined ? serv.precio : (servicio.precio || 0);
                        const cantidad = typeof serv === 'object' && serv.cantidad !== undefined ? serv.cantidad : 1;
                        const subtotal = precio * cantidad;
                        totalServicios += subtotal;
                        return {
                            nombre: servicio.nombre || 'Sin nombre',
                            cantidad: cantidad,
                            precio: precio,
                            subtotal: subtotal
                        };
                    }
                    return null;
                }).filter(s => s !== null);
                
                // Obtener productos (precio cobrado por cita)
                const productosSeleccionados = window.obtenerProductosSeleccionados('edit');
                let totalProductos = 0;
                const productosDetalle = productosSeleccionados.map(item => {
                    const id = typeof item === 'object' ? item.id : item;
                    const producto = window.todosLosProductos.find(p => p.id === id);
                    const precioCobrado = typeof item === 'object' && item.precio !== undefined ? item.precio : (producto ? (producto.costo ?? producto.precio_venta ?? producto.precio ?? 0) : 0);
                    const cantidad = typeof item === 'object' ? (item.cantidad || 1) : 1;
                    const subtotal = precioCobrado * cantidad;
                    totalProductos += subtotal;
                    return {
                        nombre: producto ? (producto.nombre || 'Sin nombre') : 'Sin nombre',
                        cantidad: cantidad,
                        costoUnitario: precioCobrado,
                        subtotal: subtotal
                    };
                }).filter(p => p !== null);
                
                // Total = Servicios + Productos (MECE)
                const totalCostos = totalServicios + totalProductos;
                const descuento = totalCostos > montoVenta ? totalCostos - montoVenta : 0;
                const neto = montoVenta - totalCostos;
                
                // Crear elemento HTML para la proforma
                const proformaDiv = document.createElement('div');
                proformaDiv.id = 'proforma-container';
                proformaDiv.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    width: 600px;
                    max-width: 100vw;
                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 5%, #ffffff 95%, #f8f9fa 100%);
                    padding: 0;
                    font-family: 'Arial', sans-serif;
                    color: #333;
                    box-shadow: 0 0 0 6px #4CAF50, 0 0 0 10px #e8f5e9, 0 0 0 14px #4CAF50, 0 10px 40px rgba(0,0,0,0.15);
                    border-radius: 4px;
                    overflow: hidden;
                `;
                
                proformaDiv.innerHTML = `
                    <!-- Marco decorativo superior -->
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); height: 8px; width: 100%;"></div>
                    
                    <!-- Contenido principal con padding -->
                    <div style="padding: 15px; background: white;">
                    <div style="text-align: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #4CAF50; position: relative;">
                        <!-- Decoración de esquinas -->
                        <div style="position: absolute; top: -2px; left: 0; width: 15px; height: 15px; border-top: 2px solid #4CAF50; border-left: 2px solid #4CAF50;"></div>
                        <div style="position: absolute; top: -2px; right: 0; width: 15px; height: 15px; border-top: 2px solid #4CAF50; border-right: 2px solid #4CAF50;"></div>
                        
                        <h1 style="color: #4CAF50; margin: 2px 0; font-size: 24px; font-weight: bold; letter-spacing: 2px;">PROFORMA</h1>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 8px 10px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">👤</span><strong style="color: #4CAF50;">${clienteNombre}</strong></p>
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">📱</span>${telefonoFormateado}</p>
                        ${provinciaNombre ? `
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">🗺️</span><strong>Provincia:</strong> ${provinciaNombre}${cantonNombre ? ` | <strong>Cantón:</strong> ${cantonNombre}${distritoNombre ? ` | <strong>Distrito:</strong> ${distritoNombre}` : ''}` : ''}</p>
                        ` : ''}
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">📍</span>${direccion}</p>
                        <p style="margin: 4px 0; font-size: 18px; color: #333;"><span style="color: #4CAF50; font-size: 20px; margin-right: 6px;">📅</span>${fechaFormateada} <span style="color: #666; font-size: 16px;">🕐 ${horaFormateada} (máximo ${duracion} min)</span></p>
                    </div>
                    
                    ${coordenadasMapa ? `
                    <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <h4 style="color: #4CAF50; font-size: 18px; margin-bottom: 6px; font-weight: bold;">🗺️ Ubicación en el Mapa</h4>
                        <div id="mapaProforma" style="height: 200px; width: 100%; border-radius: 6px; border: 1px solid #dee2e6; background: #e9ecef;"></div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 10px;">
                        <h3 style="color: #4CAF50; font-size: 20px; margin-bottom: 5px; padding-bottom: 3px; border-bottom: 2px solid #4CAF50; font-weight: bold;">✓ Servicios</h3>
                        ${serviciosDetalle.length > 0 ? `
                        <div style="background: #f8f9fa; padding: 6px; border-radius: 6px; border-left: 3px solid #4CAF50;">
                            ${serviciosDetalle.map(s => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e0e0e0; font-size: 19px;">
                                    <span style="color: #333; font-weight: 500;">${s.nombre}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : '<p style="font-size: 18px; color: #666; margin: 3px 0; padding: 6px; background: #f8f9fa; border-radius: 6px;">Sin servicios</p>'}
                    </div>
                    
                    ${productosDetalle.length > 0 ? `
                    <div style="margin-bottom: 10px;">
                        <h3 style="color: #4CAF50; font-size: 20px; margin-bottom: 5px; padding-bottom: 3px; border-bottom: 2px solid #4CAF50; font-weight: bold;">📦 Productos</h3>
                        <div style="background: #f8f9fa; padding: 6px; border-radius: 6px; border-left: 3px solid #4CAF50;">
                            ${productosDetalle.map(p => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e0e0e0; font-size: 19px;">
                                    <span style="color: #333; font-weight: 500;">${p.nombre}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 10px; padding: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                        <table style="width: 100%; border-collapse: collapse; color: white;">
                            ${serviciosDetalle.length > 0 ? `
                            <tr>
                                <td style="padding: 5px 0; font-size: 17px;">✓ Servicios:</td>
                                <td style="padding: 5px 0; text-align: right; font-size: 17px; font-weight: bold;">₡${totalServicios.toLocaleString('es-CR')}</td>
                            </tr>
                            ` : ''}
                            ${productosDetalle.length > 0 ? `
                            <tr>
                                <td style="padding: 5px 0; font-size: 17px;">📦 Productos:</td>
                                <td style="padding: 5px 0; text-align: right; font-size: 17px; font-weight: bold;">₡${totalProductos.toLocaleString('es-CR')}</td>
                            </tr>
                            ` : ''}
                            <tr style="border-top: 1px solid rgba(255,255,255,0.3);">
                                <td style="padding: 6px 0; font-size: 18px; font-weight: bold;">Total (Servicios + Productos):</td>
                                <td style="padding: 6px 0; text-align: right; font-size: 18px; font-weight: bold;">₡${totalCostos.toLocaleString('es-CR')}</td>
                            </tr>
                            ${descuento > 0 ? `
                            <tr style="background-color: rgba(255, 87, 34, 0.9); border-radius: 4px;">
                                <td style="padding: 8px 6px; font-size: 19px; font-weight: bold; color: white;">🎉 Descuento:</td>
                                <td style="padding: 8px 6px; text-align: right; font-size: 19px; font-weight: bold; color: white;">-₡${descuento.toLocaleString('es-CR')}</td>
                            </tr>
                            ` : ''}
                            <tr style="border-top: 3px solid rgba(255,255,255,0.8); background-color: rgba(0,0,0,0.2); border-radius: 0 0 8px 8px;">
                                <td style="padding: 12px 0 8px 0; font-size: 28px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">💰 Total a Pagar:</td>
                                <td style="padding: 12px 0 8px 0; text-align: right; font-size: 32px; font-weight: bold; text-shadow: 0 2px 6px rgba(0,0,0,0.4);">₡${montoVenta.toLocaleString('es-CR')}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 8px; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); border-left: 4px solid #2196F3; border-radius: 6px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 19px; color: #1976D2; font-weight: bold;">💳 Pago</h4>
                        <div style="background: white; padding: 6px; border-radius: 4px; border: 1px solid #e0e0e0;">
                            <p style="margin: 5px 0; font-size: 17px; color: #333;"><strong style="color: #1976D2;">🏦 IBAN:</strong> CR41010200009514046807</p>
                            <p style="margin: 5px 0; font-size: 17px; color: #333;"><strong style="color: #1976D2;">📱 Sinpe Móvil:</strong> 62217000</p>
                            <p style="margin: 5px 0; font-size: 17px; color: #333;"><strong style="color: #1976D2;">🏦 Cuenta BAC:</strong> 951404680</p>
                            <p style="margin: 6px 0 0 0; font-size: 16px; color: #666; padding-top: 6px; border-top: 1px solid #e0e0e0;"><strong>A nombre de:</strong> <span style="color: #4CAF50; font-weight: bold;">Ecofumigadora Hermanos Paniagua SRL</span></p>
                            <p style="margin: 3px 0 0 0; font-size: 14px; color: #666;">Cédula Jurídica: 3102850026</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding-top: 8px; border-top: 2px solid #e0e0e0; color: #666; font-size: 16px; position: relative;">
                        <!-- Decoración de esquinas inferiores -->
                        <div style="position: absolute; bottom: -2px; left: 0; width: 15px; height: 15px; border-bottom: 2px solid #e0e0e0; border-left: 2px solid #e0e0e0;"></div>
                        <div style="position: absolute; bottom: -2px; right: 0; width: 15px; height: 15px; border-bottom: 2px solid #e0e0e0; border-right: 2px solid #e0e0e0;"></div>
                        
                        <p style="margin: 3px 0; color: #4CAF50; font-weight: 500; font-size: 18px;">📞 6221 7000 | ✉️ gerencia@ecoplagascr.com</p>
                        <p style="margin: 3px 0; font-style: italic; color: #999; font-size: 14px;">Proforma sin validez fiscal</p>
                    </div>
                    </div>
                    
                    <!-- Marco decorativo inferior -->
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); height: 8px; width: 100%;"></div>
                `;
                
                document.body.appendChild(proformaDiv);
                
                // Inicializar mapa en la proforma si hay coordenadas
                if (coordenadasMapa) {
                    const mapaProformaDiv = proformaDiv.querySelector('#mapaProforma');
                    if (mapaProformaDiv) {
                        // Crear mapa Leaflet
                        const mapaProforma = L.map('mapaProforma', {
                            zoomControl: false,
                            attributionControl: false
                        }).setView([coordenadasMapa.lat, coordenadasMapa.lon], 13);
                        
                        // Agregar capa de Esri World Street Map (similar a Google Maps)
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                            attribution: '',
                            maxZoom: 19
                        }).addTo(mapaProforma);
                        
                        // Agregar marcador
                        L.marker([coordenadasMapa.lat, coordenadasMapa.lon]).addTo(mapaProforma);
                        
                        // Esperar a que el mapa se renderice
                        await new Promise((resolve) => {
                            setTimeout(() => {
                                mapaProforma.invalidateSize();
                                setTimeout(resolve, 1000); // Esperar 1 segundo para que se carguen los tiles
                            }, 100);
                        });
                    }
                }
                
                // Esperar a que la imagen del logo se cargue
                await new Promise((resolve) => {
                    const img = proformaDiv.querySelector('img');
                    if (img && img.complete) {
                        resolve();
                    } else if (img) {
                        img.onload = resolve;
                        img.onerror = resolve; // Continuar aunque falle la imagen
                        setTimeout(resolve, 2000); // Timeout de 2 segundos
                    } else {
                        resolve();
                    }
                });
                
                // Generar PNG con html2canvas - optimizado para móviles
                const canvas = await html2canvas(proformaDiv, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: 600,
                    height: proformaDiv.scrollHeight,
                    windowWidth: 600
                });
                
                // Convertir a blob y descargar (usar nombreArchivoSeguro ya calculado para evitar .replace en callback)
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const fechaStr = fechaInicio ? fechaInicio.toISOString().slice(0, 10) : 'proforma';
                    link.download = `Proforma_${nombreArchivoSeguro}_${fechaStr}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    // Limpiar
                    document.body.removeChild(proformaDiv);
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Error generando proforma:', error);
                alert('Error al generar la proforma: ' + error.message);
            }
        };
        // Wrapper seguro para obtenerClienteNombreSync que siempre retorna string
        const obtenerClienteNombre = function(cita) {
            if (!window.obtenerClienteNombreSync) {
                console.error('❌ [GLOBAL] obtenerClienteNombreSync no está disponible');
                return window.obtenerCampoCita(cita, 'cliente_nombre', '') || 'Sin nombre';
            }
            
            try {
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('❌ [GLOBAL] obtenerClienteNombreSync retornó una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                // Asegurar que sea string
                if (typeof resultado !== 'string') {
                    console.error('❌ [GLOBAL] obtenerClienteNombreSync no retornó string', {
                        citaId: cita.id,
                        tipo: typeof resultado,
                        valor: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado;
            } catch (error) {
                console.error('❌ [GLOBAL] Error en obtenerClienteNombreSync', {
                    citaId: cita.id,
                    error: error.message
                });
                return 'Sin nombre';
            }
        };
        
        const obtenerTelefono = window.obtenerTelefono;
        const obtenerVehiculo = window.obtenerVehiculo;
        const obtenerEstado = window.obtenerEstado;
        const obtenerMonto = window.obtenerMonto;
        const obtenerVendedores = window.obtenerVendedores;
        const obtenerDireccion = window.obtenerDireccion;
        const obtenerDescripcion = window.obtenerDescripcion;
        const obtenerTurno = window.obtenerTurno;
        const obtenerTurnoEmoji = window.obtenerTurnoEmoji;
        
        // Función para cargar nombres de clientes de forma asíncrona y actualizar metadata
        async function cargarNombresClientesParaCitas() {
            if (!window.todasLasCitas || window.todasLasCitas.length === 0) return;
            
            // Identificar citas que no tienen cliente_nombre en metadata
            const citasSinNombre = window.todasLasCitas.filter(cita => {
                const tieneNombre = window.obtenerCampoCita(cita, 'cliente_nombre', '');
                return !tieneNombre && window.obtenerTelefono(cita);
            });
            
            if (citasSinNombre.length === 0) {
                console.log('✅ Todas las citas ya tienen nombre en metadata');
                return;
            }
            
            console.log(`🔍 Cargando nombres para ${citasSinNombre.length} citas sin nombre...`);
            
            // Obtener teléfonos únicos
            const telefonosUnicos = [...new Set(citasSinNombre.map(c => window.obtenerTelefono(c)))];
            
            // Cargar clientes en paralelo
            const clientesPromesas = telefonosUnicos.map(telefono => 
                window.buscarCliente(telefono).then(cliente => ({ telefono, cliente }))
            );
            
            const resultados = await Promise.all(clientesPromesas);
            const clientesMap = new Map();
            resultados.forEach(({ telefono, cliente }) => {
                if (cliente && cliente.nombre) {
                    clientesMap.set(telefono, cliente.nombre);
                }
            });
            
            // Actualizar citas en memoria con nombres encontrados
            let actualizadas = 0;
            citasSinNombre.forEach(cita => {
                const nombreCliente = clientesMap.get(window.obtenerTelefono(cita));
                if (nombreCliente) {
                    // Actualizar en memoria (no en Firestore todavía)
                    if (!cita.metadata) {
                        cita.metadata = {};
                    }
                    cita.metadata.cliente_nombre = nombreCliente;
                    actualizadas++;
                }
            });
            
            console.log(`✅ Actualizados ${actualizadas} nombres de clientes en memoria`);
            
            // Opcional: Actualizar en Firestore (en batch para no hacer muchas escrituras)
            // Por ahora solo actualizamos en memoria para que se muestre inmediatamente
            // Las próximas veces que se guarde la cita, se guardará el nombre en metadata
            
            return actualizadas; // Retornar cantidad de nombres cargados
        }

        // Función para cargar encuestas y crear mapas
        async function cargarMapaEncuestas() {
            try {
                mapEncuestasCitas.clear();
                mapaLinksEncuestas.clear();
                mapaRespuestasEncuestas.clear();
                mapaJustificacionesSinEncuesta.clear();
                
                // Cargar encuestas por cita (lógica primaria: doc id = cita_id)
                const encuestasCitasQuery = query(collection(window.db, 'encuestas_citas'), limit(5000));
                const encuestasCitasSnapshot = await getDocs(encuestasCitasQuery);
                encuestasCitasSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const citaId = docSnap.id;
                    const estado = data.estado === 'respondida' ? 'respondida' : 'pendiente';
                    mapEncuestasCitas.set(citaId, { estado });
                });
                
                // Cargar links generados (encuestas_id) - legacy
                // ⚠️ SEGURIDAD: Limitar a 5000 para prevenir dumpeado masivo
                const encuestasIdQuery = query(collection(window.db, 'encuestas_id'), limit(5000));
                const encuestasIdSnapshot = await getDocs(encuestasIdQuery);
                encuestasIdSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const telefono = data.telefono || '';
                    const fechaServicio = data.fecha_servicio;
                    const idEncuesta = data.id_encuesta || doc.id;
                    
                    if (telefono && fechaServicio) {
                        // Normalizar teléfono (quitar 506 si existe)
                        let telefonoNormalizado = telefono.replace(/\D/g, '');
                        if (telefonoNormalizado.startsWith('506')) {
                            telefonoNormalizado = telefonoNormalizado.substring(3);
                        }
                        
                        // Crear clave única: telefono_fechaServicio (timestamp)
                        const fechaTimestamp = fechaServicio.toMillis ? fechaServicio.toMillis() : (fechaServicio.seconds * 1000);
                        const clave = `${telefonoNormalizado}_${fechaTimestamp}`;
                        mapaLinksEncuestas.set(clave, idEncuesta); // Guardar el id_encuesta para verificar respuesta
                    }
                });
                
                // Cargar respuestas recibidas (encuestas)
                // ⚠️ SEGURIDAD: Limitar a 5000 para prevenir dumpeado masivo
                const encuestasQuery = query(collection(window.db, 'encuestas'), limit(5000));
                const encuestasSnapshot = await getDocs(encuestasQuery);
                encuestasSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const idEncuesta = data.id_encuesta || doc.id;
                    if (idEncuesta) {
                        mapaRespuestasEncuestas.set(idEncuesta, true);
                    }
                });
                
                // Cargar justificaciones de citas sin encuesta
                // El ID del documento ES el cita_id (se guarda con doc(window.db, 'justificaciones_sin_encuesta', citaId))
                // ⚠️ SEGURIDAD: Limitar a 1000 para prevenir dumpeado masivo
                const justificacionesQuery = query(collection(window.db, 'justificaciones_sin_encuesta'), limit(1000));
                const justificacionesSnapshot = await getDocs(justificacionesQuery);
                console.log(`📋 Cargando justificaciones: ${justificacionesSnapshot.size} documentos encontrados`);
                justificacionesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const citaId = doc.id; // El ID del documento es el cita_id
                    if (citaId && data.justificacion) {
                        mapaJustificacionesSinEncuesta.set(citaId, data.justificacion);
                        console.log(`✅ Justificación cargada para cita ${citaId}`);
                    } else {
                        console.warn(`⚠️ Justificación incompleta - Doc ID: ${citaId}, tiene justificacion: ${!!data.justificacion}`);
                    }
                });
                console.log(`✅ Total justificaciones cargadas en mapa: ${mapaJustificacionesSinEncuesta.size}`);
                
                console.log(`✅ Mapas de encuestas cargados: ${mapEncuestasCitas.size} encuestas_citas (primaria), ${mapaLinksEncuestas.size} links legacy, ${mapaRespuestasEncuestas.size} respuestas legacy, ${mapaJustificacionesSinEncuesta.size} justificaciones`);
            } catch (error) {
                console.error('❌ Error cargando mapas de encuestas:', error);
            }
        }

        // Función para obtener el estado de la encuesta de una cita
        // Retorna: 0 = sin link, 1 = link generado sin respuesta, 2 = cliente respondió, 3 = justificada sin encuesta
        function obtenerEstadoEncuesta(cita) {
            if (!cita || !cita.id) return 0;
            
            // Primero verificar si tiene justificación
            if (mapaJustificacionesSinEncuesta.has(cita.id)) {
                return 3; // Justificada sin encuesta
            }
            
            // Lógica primaria: encuestas_citas (doc id = cita_id)
            const primaria = mapEncuestasCitas.get(cita.id);
            if (primaria) {
                return primaria.estado === 'respondida' ? 2 : 1;
            }
            
            // Legacy: telefono_fechaServicio → encuestas_id → encuestas
            if (!window.obtenerTelefono(cita) || !window.obtenerInicio(cita)) return 0;
            let telefonoNormalizado = window.obtenerTelefono(cita).replace(/\D/g, '');
            if (telefonoNormalizado.startsWith('506')) telefonoNormalizado = telefonoNormalizado.substring(3);
            const inicio = window.obtenerInicio(cita);
            const fechaTimestamp = inicio && (inicio.toMillis ? inicio.toMillis() : (inicio.seconds * 1000));
            const clave = `${telefonoNormalizado}_${fechaTimestamp}`;
            const idEncuesta = mapaLinksEncuestas.get(clave);
            if (!idEncuesta) return 0;
            if (mapaRespuestasEncuestas.has(idEncuesta)) return 2;
            return 1;
        }
        window.obtenerEstadoEncuesta = obtenerEstadoEncuesta;

        // Función para obtener la justificación de una cita
        function obtenerJustificacion(cita) {
            if (!cita || !cita.id) return null;
            return mapaJustificacionesSinEncuesta.get(cita.id) || null;
        }

        // Obtener identificador de encuesta respondida para una cita (primaria o legacy). Retorna { tipo: 'primaria'|'legacy', id } o null.
        function obtenerIdentificadorEncuestaRespuesta(cita) {
            if (!cita || !cita.id) return null;
            if (obtenerEstadoEncuesta(cita) !== 2) return null;
            const primaria = mapEncuestasCitas.get(cita.id);
            if (primaria && primaria.estado === 'respondida') return { tipo: 'primaria', id: cita.id };
            if (!window.obtenerTelefono(cita) || !window.obtenerInicio(cita)) return null;
            let telefonoNormalizado = String(window.obtenerTelefono(cita)).replace(/\D/g, '');
            if (telefonoNormalizado.startsWith('506')) telefonoNormalizado = telefonoNormalizado.substring(3);
            const inicio = window.obtenerInicio(cita);
            const fechaTimestamp = inicio && (inicio.toMillis ? inicio.toMillis() : (inicio.seconds != null ? inicio.seconds * 1000 : null));
            if (fechaTimestamp == null) return null;
            const clave = `${telefonoNormalizado}_${fechaTimestamp}`;
            const idEncuesta = mapaLinksEncuestas.get(clave);
            if (!idEncuesta || !mapaRespuestasEncuestas.has(idEncuesta)) return null;
            return { tipo: 'legacy', id: idEncuesta };
        }

        // Función para cargar datos
        window.cargarDatos = async function cargarDatos() {
            console.log('🔄 ===== INICIANDO cargarDatos =====');
            try {
                console.log('🔄 Cargando datos del calendario...');
                
                // Vista extendida siempre activa (botón de vista compacta eliminado)
                if (!window.semanaActual) {
                    function obtenerLunesSemanaInit(fecha) {
                        const d = new Date(fecha);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        return new Date(d.setDate(diff));
                    }
                    window.semanaActual = obtenerLunesSemanaInit(new Date());
                }
                
                // Cargar mapa de encuestas en paralelo
                await cargarMapaEncuestas();

                // Cargar servicios y productos ANTES de generar el calendario
                // (necesarios para calcular la ganancia neta en la vista de citas)
                if (!window.todosLosServicios || window.todosLosServicios.length === 0) {
                    console.log('🔍 Cargando servicios para cálculo de ganancia neta...');
                    await window.cargarServicios();
                }
                if (!window.todosLosProductos || window.todosLosProductos.length === 0) {
                    console.log('🔍 Cargando productos para cálculo de ganancia neta...');
                    await window.cargarProductos();
                }

                console.log('🔍 Creando query para Firebase...');
                // NOTA: Esta consulta es para VISUALIZACIÓN (mostrar calendario)
                // El calendario necesita todas las citas para filtrar y mostrar correctamente
                // ⚠️ SEGURIDAD: Limitar a 5000 citas para prevenir dumpeado masivo en visualización
                // Si necesitas más, implementar paginación o filtrar por rango de fechas
                const q = query(collection(window.db, 'citas'), orderBy('inicio_gmt6', 'desc'), limit(5000));
                console.log('🔍 Ejecutando query...');
                const querySnapshot = await getDocs(q);
                console.log('✅ Query ejecutado, documentos encontrados:', querySnapshot.size);
                
                todasLasCitas = [];
                querySnapshot.forEach((doc) => {
                    todasLasCitas.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                window.todasLasCitas = todasLasCitas;
                console.log('✅ Citas cargadas en window.todasLasCitas:', todasLasCitas.length);
                
                // Cargar nombres de clientes de forma asíncrona para citas que no tienen cliente_nombre en metadata
                console.log('🔍 Cargando nombres de clientes para citas sin nombre...');
                await cargarNombresClientesParaCitas();
                console.log('✅ Nombres de clientes cargados');

                console.log('🔍 Aplicando filtros...');
                aplicarFiltros();
                console.log('✅ Filtros aplicados, citas filtradas:', citasFiltradas.length);
                
                // Actualizar botones de días después de cargar datos
                if (diaSeleccionado) {
                    generarBotonesDiasMes(diaSeleccionado);
                }
                
                console.log('🔍 Vista actual:', vistaActual);
                
                // Generar vista inicial
                if (vistaActual === 'mes') {
                    console.log('🔍 Generando vista mes...');
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    console.log('🔍 Generando vista día...');
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    console.log('🔍 Generando cronograma...');
                    await generarCronograma();
                }
                
                // Si se cargaron nombres de clientes, regenerar la vista para mostrarlos
                // (solo si se actualizaron nombres)
                const nombresCargados = await cargarNombresClientesParaCitas();
                if (nombresCargados > 0) {
                    console.log(`🔄 Regenerando vista con ${nombresCargados} nombres de clientes actualizados...`);
                    if (vistaActual === 'cronograma') {
                        await generarCronograma();
                    } else if (vistaActual === 'mes') {
                        generarCalendario();
                    } else if (vistaActual === 'dia') {
                        generarVistaDia();
                    }
                }
                
                console.log('✅ ===== FIN cargarDatos =====');
                
                // Inicializar buscador de citas después de cargar los datos
                if (window.inicializarBuscadorCitas) {
                    window.inicializarBuscadorCitas();
                }

            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error cargando datos: ' + error.message);
            } finally {
                console.log('✅ Carga de datos completada');
            }
        }

        // Función para aplicar filtros
        function aplicarFiltros() {
            citasFiltradas = todasLasCitas.filter(cita => {
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const vehicleFilterValue = vehicleFilter ? vehicleFilter.value : '';
                const statusFilterValue = statusFilter ? statusFilter.value : '';

                if (searchTerm && !obtenerClienteNombre(cita)?.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (vehicleFilterValue && obtenerRuta(cita) !== vehicleFilterValue) {
                    return false;
                }
                if (statusFilterValue) {
                    const estadoClase = (window.estadoDisplayCita && window.estadoDisplayCita(cita)) ? window.estadoDisplayCita(cita).clase : 'agendada';
                    if (estadoClase !== statusFilterValue) return false;
                }

                return true;
            });
            window.citasFiltradas = citasFiltradas;
        }

        // Función para cambiar vista
        async function cambiarVista(vista) {
            vistaActual = vista;
            window.vistaActual = vistaActual;
            
            // Vista extendida siempre activa (botón de vista compacta eliminado)
            
            // Ocultar todas las vistas
            calendarGrid.style.display = 'none';
            vistaDia.style.display = 'none';
            vistaCronograma.style.display = 'none';
            
            // Remover clases activas (botón de cronograma ya no existe en el menú)
            const btnVistaCronograma = document.getElementById('btnVistaCronograma');
            if (btnVistaCronograma) {
                btnVistaCronograma.classList.remove('active');
            }
            
            if (vista === 'cronograma') {
                // Vista de cronograma (botón removido del menú, pero la funcionalidad sigue disponible)
                vistaCronograma.style.display = 'block';
                if (btnVistaCronograma) {
                    btnVistaCronograma.classList.add('active');
                }
                await generarCronograma();
            } else if (vista === 'mes' || vista === 'dia') {
                // Mostrar calendario mensual o vista de día
                if (vista === 'mes') {
                    calendarGrid.style.display = 'grid';
                    generarCalendario();
                } else if (vista === 'dia') {
                    vistaDia.style.display = 'block';
                    generarVistaDia();
                }
            }
        }

        // Función para generar vista de día
        function generarVistaDia() {
            // Usar versión síncrona para renderizado rápido
            const obtenerClienteNombre = function(cita) {
                if (!window.obtenerClienteNombreSync) {
                    console.error('❌ [generarVistaDia] obtenerClienteNombreSync no está disponible');
                    return window.obtenerCampoCita(cita, 'cliente_nombre', '') || 'Sin nombre';
                }
                
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('❌ [generarVistaDia] obtenerClienteNombreSync retornó una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado || 'Sin nombre';
            };
            
            const year = diaSeleccionado.getFullYear();
            const month = diaSeleccionado.getMonth();
            const day = diaSeleccionado.getDate();
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const dayNames = [
                'Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'
            ];
            
            vistaDiaTitulo.innerHTML = `
                <i class="fas fa-calendar-day me-2"></i>
                ${dayNames[diaSeleccionado.getDay()]}, ${day} de ${monthNames[month]} de ${year}
            `;

            // Obtener citas del día
            const citasDelDia = citasFiltradas.filter(cita => {
                const fechaCita = window.formatearFecha(obtenerInicio(cita));
                if (!fechaCita) return false;
                return fechaCita.getDate() === day && 
                       fechaCita.getMonth() === month && 
                       fechaCita.getFullYear() === year;
            });
            
            // Calcular facturación total del día
            const facturacionTotalDia = citasDelDia.reduce((sum, cita) => {
                const monto = obtenerMonto(cita);
                return sum + (monto || 0);
            }, 0);
            
            // Mostrar facturación total del día
            const facturacionTotalDiaElement = document.getElementById('facturacionTotalDia');
            const montoTotalDiaElement = document.getElementById('montoTotalDia');
            if (facturacionTotalDiaElement && montoTotalDiaElement) {
                montoTotalDiaElement.textContent = `₡${facturacionTotalDia.toLocaleString('es-CR')}`;
                facturacionTotalDiaElement.style.display = 'block';
            }

            // Agrupar citas por ruta
            const citasPorRuta = {};
            citasDelDia.forEach(cita => {
                const ruta = obtenerRuta(cita);
                if (!citasPorRuta[ruta]) {
                    citasPorRuta[ruta] = [];
                }
                citasPorRuta[ruta].push(cita);
            });

            // Ordenar citas por hora
            Object.keys(citasPorRuta).forEach(ruta => {
                citasPorRuta[ruta].sort((a, b) => {
                    const fechaA = window.formatearFecha(obtenerInicio(a));
                    const fechaB = window.formatearFecha(obtenerInicio(b));
                    if (!fechaA || !fechaB) return 0;
                    return fechaA.getTime() - fechaB.getTime();
                });
            });

            // Generar columnas de rutas
            const rutasOrdenadas = Object.keys(citasPorRuta).sort((a, b) => {
                // Ordenar "Sin asignar" primero, luego rutas numéricamente
                if (a === 'Sin asignar') return -1;
                if (b === 'Sin asignar') return 1;
                const numA = parseInt(a.replace('Ruta ', '')) || 0;
                const numB = parseInt(b.replace('Ruta ', '')) || 0;
                return numA - numB;
            });

            vehiculosGrid.innerHTML = rutasOrdenadas.map(ruta => {
                const citas = citasPorRuta[ruta];
                const totalCitas = citas.length;
                const totalDuracion = citas.reduce((sum, cita) => sum + obtenerDuracion(cita), 0);
                const totalVentas = citas.reduce((sum, cita) => sum + obtenerMonto(cita), 0);
                
                // Filtrar citas con ubicación completa
                const citasConUbicacion = citas.filter(cita => {
                    const provinciaId = window.obtenerCampoCita(cita, 'provinciaId', null);
                    const cantonId = window.obtenerCampoCita(cita, 'cantonId', null);
                    const distritoId = window.obtenerCampoCita(cita, 'distritoId', null);
                    return provinciaId && cantonId && distritoId;
                });
                
                // Almacenar citas en variable global para acceso desde el botón
                const rutaId = ruta.replace(/[^a-zA-Z0-9]/g, '-');
                if (!window.citasPorRutaRuta) {
                    window.citasPorRutaRuta = {};
                }
                window.citasPorRutaRuta[rutaId] = citas;

                return `
                    <div class="vehiculo-columna">
                        <div class="vehiculo-header ${ruta.replace(' ', '-')}">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1; flex-wrap: wrap;">
                                    <span style="font-weight: 600;"><i class="fas fa-route me-2"></i>${ruta}</span>
                                    <span style="font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 4px; white-space: nowrap;">
                                        <i class="fas fa-calendar-check me-1"></i><strong>${totalCitas}</strong> ${totalCitas === 1 ? 'cita' : 'citas'}
                                    </span>
                                    <span style="font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 4px; white-space: nowrap;">
                                        <i class="fas fa-money-bill-wave me-1"></i><strong>₡${totalVentas.toLocaleString('es-CR')}</strong>
                                    </span>
                                </div>
                                ${citasConUbicacion.length > 0 ? `
                                <button onclick="window.mostrarRutaVehiculo('${ruta.replace(/'/g, "\\'")}', '${rutaId}')" 
                                        style="background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.4); 
                                               color: white; padding: 5px 12px; border-radius: 4px; font-size: 0.75rem; 
                                               cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                                        onmouseover="this.style.background='rgba(255,255,255,0.35)'; this.style.transform='scale(1.02)'"
                                        onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1)'">
                                    <i class="fas fa-route me-1"></i>Ver Ruta (${citasConUbicacion.length})
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="vehiculo-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <strong>${totalCitas}</strong><br>
                                    <small>Citas</small>
                                </div>
                                <div class="col-4">
                                    <strong>${totalDuracion}min</strong><br>
                                    <small>Duración</small>
                                </div>
                                <div class="col-4">
                                    <strong>₡${totalVentas.toLocaleString()}</strong><br>
                                    <small>Ventas</small>
                                </div>
                            </div>
                        </div>
                        <div class="citas-container">
                            ${citas.length > 0 ? (() => {
                                // Agrupar citas por hora (redondeando a la misma franja horaria)
                                const citasPorHora = {};
                                
                                citas.forEach(cita => {
                                    const fechaInicio = window.formatearFecha(obtenerInicio(cita));
                                    if (!fechaInicio) return;
                                    
                                    // Redondear a la misma franja horaria (mismo hora y minuto)
                                    const hora = fechaInicio.getHours();
                                    const minuto = fechaInicio.getMinutes();
                                    const claveHora = `${hora}:${String(minuto).padStart(2, '0')}`;
                                    
                                    if (!citasPorHora[claveHora]) {
                                        citasPorHora[claveHora] = [];
                                    }
                                    citasPorHora[claveHora].push(cita);
                                });
                                
                                // Ordenar las horas
                                const horasOrdenadas = Object.keys(citasPorHora).sort((a, b) => {
                                    const [horaA, minA] = a.split(':').map(Number);
                                    const [horaB, minB] = b.split(':').map(Number);
                                    return (horaA * 60 + minA) - (horaB * 60 + minB);
                                });
                                
                                // Renderizar citas agrupadas por hora
                                return horasOrdenadas.map(claveHora => {
                                    const citasEnHora = citasPorHora[claveHora];
                                    const tieneMultiples = citasEnHora.length > 1;
                                    
                                    // Si hay múltiples citas en la misma hora, usar contenedor flex
                                    const contenedorClase = tieneMultiples ? 'citas-misma-hora' : '';
                                    
                                    const citasHTML = citasEnHora.map(cita => {
                                        const fechaInicio = window.formatearFecha(obtenerInicio(cita));
                                        const horaInicio = fechaInicio ? fechaInicio.toLocaleTimeString('es-CR', { 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        }) : 'N/A';
                                        
                                        // Determinar emoji de turno
                                        const emojiTurno = obtenerTurnoEmoji(cita);
                                        
                                        const citaElement = document.createElement('div');
                                        const montoCitaDiaVal = window.obtenerMonto ? window.obtenerMonto(cita) : undefined;
                                        const esMontoCeroDia = (Number(montoCitaDiaVal) || 0) === 0;
                                        citaElement.className = 'cita-item-dia' + (esMontoCeroDia ? ' monto-cero' : '');
                                        citaElement.setAttribute('data-cita-id', cita.id);
                                        citaElement.style.cursor = 'pointer';
                                        
                                        // Obtener nombre del cliente con validación
                                        let clienteNombre = obtenerClienteNombre(cita);
                                        
                                        // Asegurar que sea string
                                        if (clienteNombre && typeof clienteNombre.then === 'function') {
                                            console.error('❌ [generarVistaDia] clienteNombre es una Promise!', cita.id);
                                            clienteNombre = 'Sin nombre';
                                        }
                                        clienteNombre = clienteNombre || 'Sin nombre';
                                        
                                        // Usar versión síncrona del indicador GPS para evitar [object Promise]
                                        const indicadorGPS = window.obtenerIndicadorGPSSync ? window.obtenerIndicadorGPSSync(cita) : '';
                                        
                                        // Obtener estado de la encuesta
                                        const estadoEncuesta = obtenerEstadoEncuesta(cita);
                                        let indicadorEncuesta = '';
                                        let colorPuntoEncuesta = '';
                                        if (estadoEncuesta === 0) {
                                            // Sin link generado - rojo
                                            indicadorEncuesta = '<i class="fas fa-heart" style="color: #f44336; font-size: 14px; margin-left: 4px;" title="Encuesta no enviada"></i>';
                                            colorPuntoEncuesta = 'rojo';
                                        } else if (estadoEncuesta === 1) {
                                            // Link generado sin respuesta - amarillo
                                            indicadorEncuesta = '<i class="fas fa-heart" style="color: #ffc107; font-size: 14px; margin-left: 4px;" title="Encuesta enviada, esperando respuesta"></i>';
                                            colorPuntoEncuesta = 'amarillo';
                                        } else if (estadoEncuesta === 2) {
                                            // Cliente respondió - verde
                                            indicadorEncuesta = '<i class="fas fa-heart" style="color: #4caf50; font-size: 14px; margin-left: 4px;" title="Cliente respondió la encuesta"></i>';
                                            colorPuntoEncuesta = 'verde';
                                        } else if (estadoEncuesta === 3) {
                                            // No requiere encuesta - azul
                                            const justificacion = obtenerJustificacion(cita);
                                            const tituloJustificacion = justificacion ? `Justificada: ${justificacion.substring(0, 50)}${justificacion.length > 50 ? '...' : ''}` : 'No requiere encuesta';
                                            indicadorEncuesta = `<i class="fas fa-heart" style="color: #2196f3; font-size: 14px; margin-left: 4px;" title="${tituloJustificacion}"></i>`;
                                            colorPuntoEncuesta = 'azul';
                                        }
                                        
                                        // Obtener datos para mostrar en las citas (una sola forma de leer: obtenerCampoCita)
                                        // Obtener vendedor
                                        const vendedores = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                                        const vendedorMostrar = vendedores && vendedores.length > 0 ? vendedores[0] : '';
                                        const vendedorTexto = vendedorMostrar || 'Sin vendedor';
                                        
                                        // Obtener hora
                                        const horaMostrar = horaInicio;
                                        
                                        // Obtener precio: si 0 o nulo, recuadro rojo "Precio 0"; si no, recuadro verde
                                        const montoValDia = window.obtenerMonto ? window.obtenerMonto(cita) : null;
                                        const esPrecioCeroDia = montoValDia == null || montoValDia === '' || Number(montoValDia) === 0;
                                        const precioMostrar = esPrecioCeroDia ? '' : (window.formatearMontoVenta ? window.formatearMontoVenta(montoValDia) : String(montoValDia));
                                        
                                        // Obtener ubicación (Provincia, Cantón, Distrito en ese orden)
                                        const ubicacionPartes = [];
                                        const provinciaId = window.obtenerCampoCita(cita, 'provinciaId', null);
                                        const cantonId = window.obtenerCampoCita(cita, 'cantonId', null);
                                        const distritoId = window.obtenerCampoCita(cita, 'distritoId', null);
                                        
                                        // Convertir IDs a nombres usando ubicacionesCR - Orden: Provincia, Cantón, Distrito
                                        if (window.ubicacionesCR && provinciaId && window.ubicacionesCR[provinciaId]) {
                                            ubicacionPartes.push(window.ubicacionesCR[provinciaId].nombre || '');
                                            
                                            if (cantonId && window.ubicacionesCR[provinciaId].cantones && window.ubicacionesCR[provinciaId].cantones[cantonId]) {
                                                ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].nombre || '');
                                                
                                                if (distritoId && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                                                    ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre || '');
                                                }
                                            }
                                        }
                                        const ubicacionTexto = ubicacionPartes.length > 0 ? ubicacionPartes.join(', ') : '';
                                        
                                        // Construir línea principal: Vendedor (badge) + Hora (gris) + Precio (verde o rojo "Precio 0")
                                        const infoPrincipal = [];
                                        infoPrincipal.push(window.vendedorBadgeHtml ? window.vendedorBadgeHtml(cita) : vendedorTexto);
                                        if (horaMostrar) infoPrincipal.push('<span class="cita-hora-texto">' + String(horaMostrar).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');
                                        if (esPrecioCeroDia) infoPrincipal.push('<span class="cita-monto-cero">Precio 0</span>');
                                        else if (precioMostrar) infoPrincipal.push('<span class="cita-monto-texto">' + String(precioMostrar).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');
                                        const textoPrincipal = infoPrincipal.join('');
                                        
                                        // Línea 2: cliente en recuadro | Línea 3: Provincia, Cantón, Distrito o "Dirección pendiente" en rojo
                                        const clienteEscapado = (clienteNombre && clienteNombre !== 'Sin nombre') ? String(clienteNombre).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                                        const ubicacionEscapada = ubicacionTexto ? String(ubicacionTexto).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                                        const lineaUbicacion = ubicacionEscapada
                                            ? `<div class="cita-linea-recursos"><span class="cita-ubicacion-texto">${ubicacionEscapada}</span></div>`
                                            : `<div class="cita-linea-recursos"><span class="cita-ubicacion-pendiente">Dirección pendiente</span></div>`;
                                        
                                        const metodoPagoVal = (window.obtenerCampoCita(cita, 'metodoPago', '') || '').trim();
                                        const pagoIndicado = metodoPagoVal !== '' && metodoPagoVal.toLowerCase() !== 'seleccionar método de pago';
                                        const ventanasDia = window.indicadoresVentanasCita ? window.indicadoresVentanasCita(cita) : { dentroVentanaConfirmacion: true, citaYaPasada: true };
                                        const confirmada24_48Dia = window.obtenerConfirmada24_48 ? window.obtenerConfirmada24_48(cita) : { confirmada: false };
                                        const confirmadaCitaDia = !!confirmada24_48Dia.confirmada;
                                        const claseConfirmadaDia = !ventanasDia.dentroVentanaConfirmacion ? 'gris' : (confirmadaCitaDia ? 'confirmada' : 'no-confirmada');
                                        const tituloConfirmadaDia = !ventanasDia.dentroVentanaConfirmacion ? 'Fuera de ventana de confirmación' : (confirmadaCitaDia ? 'Cita confirmada' : 'Cita no confirmada');
                                        const colorPuntoEncuestaDia = !ventanasDia.citaYaPasada ? 'gris' : colorPuntoEncuesta;
                                        const tituloEncuestaDia = !ventanasDia.citaYaPasada ? 'Encuesta después del servicio' : (estadoEncuesta === 0 ? 'Encuesta no enviada' : estadoEncuesta === 1 ? 'Encuesta enviada, esperando respuesta' : estadoEncuesta === 3 ? 'No requiere encuesta' : 'Cliente respondió la encuesta');
                                        const clasePagoDia = !ventanasDia.citaYaPasada ? 'pago-gris' : (pagoIndicado ? 'pago-indicado' : 'pago-pendiente');
                                        const tituloPagoDia = !ventanasDia.citaYaPasada ? 'Arqueo después del servicio' : (pagoIndicado ? 'Método de pago indicado' : 'Seleccionar método de pago');
                                        
                                        citaElement.innerHTML = `
                                            <div class="cita-indicadores-derecha">
                                                <div class="indicador-confirmada-punto ${claseConfirmadaDia}" title="${tituloConfirmadaDia}"><i class="fas fa-check indicador-icono"></i></div>
                                                <div class="indicador-encuesta-punto ${colorPuntoEncuestaDia}" title="${tituloEncuestaDia}"><i class="fas fa-heart indicador-icono"></i></div>
                                                <div class="indicador-pago-punto ${clasePagoDia}" title="${tituloPagoDia}"><i class="fas fa-dollar-sign indicador-icono"></i></div>
                                            </div>
                                            <div class="cita-duracion">${obtenerDuracion(cita)}min</div>
                                            <div class="cita-tres-lineas">
                                                <div class="cita-hora cita-linea-badges">${textoPrincipal}</div>
                                                ${clienteEscapado ? `<div class="cita-linea-recursos"><span class="cita-cliente-texto">${clienteEscapado}</span></div>` : ''}
                                                ${lineaUbicacion}
                                            </div>
                                            <div class="cita-descripcion">${obtenerDescripcion(cita)}</div>
                                            <div class="mt-2">
                                                <span class="cita-estado ${(window.estadoDisplayCita && window.estadoDisplayCita(cita)) ? window.estadoDisplayCita(cita).clase : 'agendada'}">${(window.estadoDisplayCita && window.estadoDisplayCita(cita)) ? window.estadoDisplayCita(cita).texto : 'Agendada'}</span>
                                            </div>
                                        `;
                                        
                                        return citaElement.outerHTML;
                                    }).join('');
                                    
                                    // Si hay múltiples citas, envolver en contenedor flex
                                    return tieneMultiples 
                                        ? `<div class="${contenedorClase}">${citasHTML}</div>` 
                                        : citasHTML;
                                }).join('');
                            })() : `
                                <div class="sin-citas">
                                    <i class="fas fa-calendar-times"></i>
                                    <p>No hay citas programadas</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            // Si no hay citas para ninguna ruta, mostrar mensaje
            if (rutasOrdenadas.length === 0) {
                vehiculosGrid.innerHTML = `
                    <div class="col-12">
                        <div class="sin-citas">
                            <i class="fas fa-calendar-times"></i>
                            <h5>No hay citas programadas para este día</h5>
                            <p>Selecciona otro día o crea una nueva cita</p>
                        </div>
                    </div>
                `;
            }
        }

        // Variable para rastrear si los listeners ya están agregados
        let dragAndDropInicializado = false;
        
        // Función para inicializar drag and drop de citas
        function inicializarDragAndDrop() {
            // Si ya está inicializado, no hacer nada
            if (dragAndDropInicializado) {
                return;
            }
            
            // Usar event delegation para evitar problemas con listeners duplicados
            const cronogramaContainerDiurnas = document.getElementById('vehiculosCronogramaDiurnas');
            const cronogramaContainerNocturnas = document.getElementById('vehiculosCronogramaNocturnas');
            const cronogramaContainers = [cronogramaContainerDiurnas, cronogramaContainerNocturnas].filter(c => c);
            if (cronogramaContainers.length === 0) return;
            
            // Aplicar listeners a todos los contenedores
            cronogramaContainers.forEach(cronogramaContainer => {
            // Event delegation para dragstart en bloques de citas
            // Variable global para almacenar datos del arrastre (offset, mouse inicial, etc.)
            window.datosArrastreCita = null;
            
            cronogramaContainer.addEventListener('dragstart', (e) => {
                const citaBloque = e.target.closest('.cita-bloque[draggable="true"]');
                if (!citaBloque) return;
                
                // Guardar la posición actual del borde superior de la cita relativa al timeline
                const timeline = citaBloque.closest('.citas-timeline');
                if (timeline) {
                    const timelineRect = timeline.getBoundingClientRect();
                    const citaRect = citaBloque.getBoundingClientRect();
                    const topRelativoAlTimeline = citaRect.top - timelineRect.top;
                    e.dataTransfer.setData('topInicial', topRelativoAlTimeline.toString());
                }
                
                // Guardar también el offset del mouse para referencia
                const rect = citaBloque.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', citaBloque.getAttribute('data-cita-id'));
                e.dataTransfer.setData('offsetY', offsetY.toString());
                
                // Guardar datos globales del arrastre para acceder en dragover (algunos navegadores no permiten getData)
                window.datosArrastreCita = {
                    offsetY,
                    mouseInicioY: e.clientY,
                    citaId: citaBloque.getAttribute('data-cita-id')
                };
                citaBloque.classList.add('dragging');
            }, true);
            
            // Event delegation para dragend
            cronogramaContainer.addEventListener('dragend', (e) => {
                const citaBloque = e.target.closest('.cita-bloque');
                if (citaBloque) {
                    citaBloque.classList.remove('dragging');
                }
                // Remover clases de drag-over de todos los timelines
                document.querySelectorAll('.citas-timeline').forEach(timeline => {
                    timeline.classList.remove('drag-over');
                });
                // Ocultar tooltip al terminar el arrastre
                if (tooltipHora) {
                    tooltipHora.style.display = 'none';
                }
                // Limpiar datos globales del arrastre
                window.datosArrastreCita = null;
            }, true);
            
            // Crear tooltip flotante para mostrar la hora
            let tooltipHora = null;
            
            // Event delegation para dragover en timelines
            cronogramaContainer.addEventListener('dragover', (e) => {
                const timeline = e.target.closest('.citas-timeline');
                if (!timeline) {
                    // Si salimos del timeline, ocultar tooltip
                    if (tooltipHora) {
                        tooltipHora.style.display = 'none';
                    }
                    return;
                }
                
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                timeline.classList.add('drag-over');
                
                // Calcular la hora basada en la posición del borde superior de la cita (no del mouse)
                // USAR EXACTAMENTE LA MISMA LÓGICA QUE EN EL EVENTO DROP
                const rect = timeline.getBoundingClientRect();
                const yMouse = e.clientY - rect.top;
                const offsetY = (window.datosArrastreCita && typeof window.datosArrastreCita.offsetY === 'number')
                    ? window.datosArrastreCita.offsetY
                    : (parseFloat(e.dataTransfer.getData('offsetY')) || 0);
                
                // Calcular dónde quedaría el borde superior de la cita
                // Restamos el offset para obtener la posición del inicio de la cita
                const yInicioCita = Math.max(0, yMouse - offsetY);
                
                // Siempre usar vista extendida (no compacta)
                const estaCompacta = false;
                
                // Determinar a qué sección pertenece este timeline (diurnas o nocturnas) - IGUAL QUE EN DROP
                const contenedorPadre = timeline.closest('#vehiculosCronogramaDiurnas, #vehiculosCronogramaNocturnas');
                const esDiurnas = contenedorPadre && contenedorPadre.id === 'vehiculosCronogramaDiurnas';
                
                // Obtener el offset de inicio del timeline visible - IGUAL QUE EN DROP
                let offsetInicioTimeline = 0; // En vista total, empieza en 5 AM (0 minutos desde 5 AM)
                
                if (estaCompacta && window.rangosHoras) {
                    // En vista compacta, el timeline visible puede empezar en una hora diferente
                    const rango = esDiurnas ? window.rangosHoras.diurnas : window.rangosHoras.nocturnas;
                    if (rango && rango.inicio !== null) {
                        // El offset es cuántos minutos desde las 5 AM empieza el timeline visible
                        offsetInicioTimeline = rango.inicio;
                    }
                }
                
                // Calcular minutos desde el inicio del timeline visible - IGUAL QUE EN DROP
                // En vista total: yInicioCita = 0px corresponde a 5 AM (0 minutos desde 5 AM)
                // En vista compacta: yInicioCita = 0px corresponde a minutosInicioConMargen
                const minutosDesdeInicioTimeline = (yInicioCita / 40) * 60; // 40px por hora = 1cm
                
                // Convertir a minutos desde las 5 AM (sumando el offset del inicio del timeline) - IGUAL QUE EN DROP
                const minutosDesde5AM = Math.max(0, Math.min(1439, minutosDesdeInicioTimeline + offsetInicioTimeline));
                
                // Redondear al intervalo de 15 minutos más cercano - IGUAL QUE EN DROP
                // Esto asegura que la hora de inicio sea exactamente 00, 15, 30, o 45 minutos
                const minutosRedondeadosDesde5AM = Math.round(minutosDesde5AM / 15) * 15;
                
                // Convertir minutos desde 5 AM a minutos desde medianoche reales - IGUAL QUE EN DROP
                // Si minutosDesde5AM < 1140 (19 horas), es del día actual (5 AM - 11:59 PM)
                // Si minutosDesde5AM >= 1140, es del día siguiente (12 AM - 4:59 AM)
                let minutosDesdeMedianoche;
                if (minutosRedondeadosDesde5AM < 1140) {
                    // Hora entre 5:00 AM y 11:59 PM del día actual
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM + (5 * 60); // Sumar 5 horas
                } else {
                    // Hora entre 12:00 AM y 4:59 AM del día siguiente
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM - 1140; // Restar 19 horas (0-300 minutos)
                }
                
                // Calcular hora y minuto (ya redondeados a intervalos de 15 minutos) - IGUAL QUE EN DROP
                const nuevaHora = Math.floor(minutosDesdeMedianoche / 60);
                const nuevoMinuto = minutosDesdeMedianoche % 60;
                
                // Asegurar que el minuto esté en intervalos de 15 (0, 15, 30, 45) - IGUAL QUE EN DROP
                const minutoRedondeado = Math.round(nuevoMinuto / 15) * 15;
                
                // Formatear hora para mostrar - IGUAL QUE EN DROP
                const hora12 = nuevaHora === 0 ? 12 : nuevaHora > 12 ? nuevaHora - 12 : nuevaHora;
                const ampm = nuevaHora < 12 ? 'AM' : 'PM';
                const horaFormateada = `${hora12}:${minutoRedondeado.toString().padStart(2, '0')} ${ampm}`;
                
                // Crear o actualizar tooltip
                if (!tooltipHora) {
                    tooltipHora = document.createElement('div');
                    tooltipHora.id = 'tooltip-hora-cita';
                    document.body.appendChild(tooltipHora);
                }
                
                // Aplicar estilos con !important para asegurar que esté al frente
                tooltipHora.style.cssText = 'position: fixed !important; background: rgba(0, 0, 0, 0.95) !important; color: white !important; padding: 6px 10px !important; border-radius: 6px !important; font-size: 0.75rem !important; font-weight: 600 !important; pointer-events: none !important; z-index: 9999999 !important; box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important; white-space: nowrap !important;';
                
                tooltipHora.textContent = horaFormateada;
                tooltipHora.style.display = 'block';
                
                // Posicionar el tooltip cerca del borde superior de la cita, no del mouse
                const yInicioCitaAbsoluto = rect.top + yInicioCita;
                tooltipHora.style.left = (rect.left + 10) + 'px';
                tooltipHora.style.top = (yInicioCitaAbsoluto - 35) + 'px';
            }, true);
            
            // Event delegation para dragleave
            cronogramaContainer.addEventListener('dragleave', (e) => {
                const timeline = e.target.closest('.citas-timeline');
                if (timeline) {
                    timeline.classList.remove('drag-over');
                }
                // Ocultar tooltip al salir del timeline
                if (tooltipHora) {
                    tooltipHora.style.display = 'none';
                }
            }, true);
            
            // Event delegation para drop
            cronogramaContainer.addEventListener('drop', async (e) => {
                const timeline = e.target.closest('.citas-timeline');
                if (!timeline) return;
                
                e.preventDefault();
                timeline.classList.remove('drag-over');
                
                // Ocultar tooltip al soltar
                if (tooltipHora) {
                    tooltipHora.style.display = 'none';
                }
                
                const citaId = e.dataTransfer.getData('text/plain');
                if (!citaId) return;
                
                // Obtener la posición Y relativa al timeline
                const rect = timeline.getBoundingClientRect();
                const yMouse = e.clientY - rect.top;
                
                // Obtener el offset del mouse dentro de la cita (desde dragstart)
                const offsetY = parseFloat(e.dataTransfer.getData('offsetY')) || 0;
                
                // Calcular dónde quedaría el borde superior de la cita
                // Restamos el offset para obtener la posición del inicio de la cita
                const yInicioCita = Math.max(0, yMouse - offsetY);
                
                // Siempre usar vista extendida (no compacta)
                const estaCompacta = false;
                
                // Determinar a qué sección pertenece este timeline (diurnas o nocturnas)
                const contenedorPadre = timeline.closest('#vehiculosCronogramaDiurnas, #vehiculosCronogramaNocturnas');
                const esDiurnas = contenedorPadre && contenedorPadre.id === 'vehiculosCronogramaDiurnas';
                
                // Obtener el offset de inicio del timeline visible
                let offsetInicioTimeline = 0; // En vista total, empieza en 5 AM (0 minutos desde 5 AM)
                
                if (estaCompacta && window.rangosHoras) {
                    // En vista compacta, el timeline visible puede empezar en una hora diferente
                    const rango = esDiurnas ? window.rangosHoras.diurnas : window.rangosHoras.nocturnas;
                    if (rango && rango.inicio !== null) {
                        // El offset es cuántos minutos desde las 5 AM empieza el timeline visible
                        offsetInicioTimeline = rango.inicio;
                    }
                }
                
                // Calcular minutos desde el inicio del timeline visible
                // En vista total: yInicioCita = 0px corresponde a 5 AM (0 minutos desde 5 AM)
                // En vista compacta: yInicioCita = 0px corresponde a minutosInicioConMargen
                const minutosDesdeInicioTimeline = (yInicioCita / 40) * 60; // 40px por hora = 1cm
                
                // Convertir a minutos desde las 5 AM (sumando el offset del inicio del timeline)
                const minutosDesde5AM = Math.max(0, Math.min(1439, minutosDesdeInicioTimeline + offsetInicioTimeline));
                
                // Redondear al intervalo de 15 minutos más cercano
                // Esto asegura que la hora de inicio sea exactamente 00, 15, 30, o 45 minutos
                const minutosRedondeadosDesde5AM = Math.round(minutosDesde5AM / 15) * 15;
                
                // Convertir minutos desde 5 AM a minutos desde medianoche reales
                // Si minutosDesde5AM < 1140 (19 horas), es del día actual (5 AM - 11:59 PM)
                // Si minutosDesde5AM >= 1140, es del día siguiente (12 AM - 4:59 AM)
                let minutosDesdeMedianoche;
                let diaOffset = 0; // Días a agregar (0 = mismo día, 1 = día siguiente)
                
                if (minutosRedondeadosDesde5AM < 1140) {
                    // Hora entre 5:00 AM y 11:59 PM del día actual
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM + (5 * 60); // Sumar 5 horas
                    diaOffset = 0;
                } else {
                    // Hora entre 12:00 AM y 4:59 AM del día siguiente
                    minutosDesdeMedianoche = minutosRedondeadosDesde5AM - 1140; // Restar 19 horas (0-300 minutos)
                    diaOffset = 1;
                }
                
                // Calcular hora y minuto (ya redondeados a intervalos de 15 minutos)
                const nuevaHora = Math.floor(minutosDesdeMedianoche / 60);
                const nuevoMinuto = minutosDesdeMedianoche % 60;
                
                // Asegurar que el minuto esté en intervalos de 15 (0, 15, 30, 45)
                const minutoRedondeado = Math.round(nuevoMinuto / 15) * 15;
                
                // Obtener la ruta destino
                const rutaDestino = timeline.getAttribute('data-ruta');
                
                // Obtener la cita original
                const citaOriginal = window.citasFiltradas.find(c => c.id === citaId);
                if (!citaOriginal) return;
                
                // Obtener la fecha del día seleccionado (no la fecha original de la cita)
                // Esto asegura que las citas que se mueven al día siguiente sigan apareciendo
                // en el cronograma del día laborable actual
                const year = diaSeleccionado.getFullYear();
                const month = diaSeleccionado.getMonth();
                const day = diaSeleccionado.getDate();
                
                // Crear nueva fecha basada en el día seleccionado, no en la fecha original de la cita
                // Si diaOffset = 1, es del día siguiente (pero sigue siendo parte del día laborable del día seleccionado)
                const nuevaFecha = new Date(year, month, day + diaOffset, nuevaHora, minutoRedondeado, 0, 0);
                
                console.log('🔍 Moviendo cita:', {
                    diaSeleccionado: `${year}-${month + 1}-${day}`,
                    diaOffset,
                    nuevaHora,
                    minutoRedondeado,
                    nuevaFecha: nuevaFecha.toISOString(),
                    nuevaFechaLocal: nuevaFecha.toString()
                });
                
                // Convertir a Timestamp (Firestore almacena en UTC)
                // Timestamp.fromDate() convierte la fecha local a UTC automáticamente
                const timestampGMT6 = Timestamp.fromDate(nuevaFecha);
                
                try {
                    // Actualizar la cita en Firestore
                    const citaRef = doc(window.db, 'citas', citaId);
                    const citaActual = window.citasFiltradas.find(c => c.id === citaId);
                    
                    // Obtener metadata actual o crear nueva
                    const metadataActual = citaActual?.metadata || {};
                        const nuevaMetadata = {
                            ...metadataActual,
                            ruta: rutaDestino
                        };
                    
                    // Obtener duración actual de la cita y redondearla a 15 minutos
                    const duracionActual = obtenerDuracion(citaActual);
                    const duracionRedondeada = Math.max(15, Math.round(duracionActual / 15) * 15); // Mínimo 15 minutos, redondeado a 15
                    
                    await updateDoc(citaRef, {
                        inicio_gmt6: timestampGMT6,
                        duracion_minutos: duracionRedondeada,
                        metadata: nuevaMetadata
                    });
                    
                    console.log('✅ Cita actualizada, recargando cronograma...');
                    
                    // Recargar datos y regenerar cronograma
                    await cargarDatos();
                    if (vistaActual === 'cronograma') {
                        await generarCronograma();
                    }
                } catch (error) {
                    console.error('Error actualizando cita:', error);
                    alert('Error al mover la cita: ' + error.message);
                }
            }, true);
            }); // Cerrar forEach de contenedores
            
            dragAndDropInicializado = true;
        }

        // Función para inicializar arrastre para crear citas en el cronograma
        function inicializarArrastreCrearCitas(fecha) {
            console.log('🎯 Inicializando arrastre para crear citas en cronograma', { fecha });
            
            // Obtener todos los timelines del cronograma
            const timelines = document.querySelectorAll('.citas-timeline');
            
            timelines.forEach(timeline => {
                const ruta = timeline.getAttribute('data-ruta');
                if (!ruta) return;
                
                // Variables para el arrastre
                let isDragging = false;
                let dragStartY = 0;
                let dragEndY = 0;
                let dragPreview = null;
                
                // Handlers globales
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    
                    const rect = timeline.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    dragEndY = Math.max(0, Math.min(y, timeline.offsetHeight));
                    
                    actualizarDragPreview();
                    e.preventDefault();
                };
                
                const handleMouseUp = (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    // Remover listeners globales
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    
                    const alturaTimeline = timeline.offsetHeight;
                    const alturaMinima = 20;
                    const alturaArrastrada = Math.abs(dragEndY - dragStartY);
                    
                    if (alturaArrastrada < alturaMinima) {
                        if (dragPreview) {
                            dragPreview.remove();
                            dragPreview = null;
                        }
                        return;
                    }
                    
                    // Calcular hora basada en posición Y (usando la misma lógica que en drag-and-drop de citas existentes)
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    
                    // Siempre usar vista extendida (no compacta)
                    const estaCompacta = false;
                    
                    // Determinar a qué sección pertenece este timeline (diurnas o nocturnas)
                    const contenedorPadre = timeline.closest('#vehiculosCronogramaDiurnas, #vehiculosCronogramaNocturnas');
                    const esDiurnas = contenedorPadre && contenedorPadre.id === 'vehiculosCronogramaDiurnas';
                    
                    // Obtener el offset de inicio del timeline visible
                    let offsetInicioTimeline = 0; // En vista total, empieza en 5 AM (0 minutos desde 5 AM)
                    
                    if (estaCompacta && window.rangosHoras) {
                        // En vista compacta, el timeline visible puede empezar en una hora diferente
                        const rango = esDiurnas ? window.rangosHoras.diurnas : window.rangosHoras.nocturnas;
                        if (rango && rango.inicio !== null) {
                            // El offset es cuántos minutos desde las 5 AM empieza el timeline visible
                            offsetInicioTimeline = rango.inicio;
                        }
                    }
                    
                    // Calcular minutos desde el inicio del timeline visible
                    // En vista total: inicioY = 0px corresponde a 5 AM (0 minutos desde 5 AM)
                    // En vista compacta: inicioY = 0px corresponde a minutosInicioConMargen
                    const minutosDesdeInicioTimeline = (inicioY / 40) * 60; // 40px por hora = 1cm
                    
                    // Convertir a minutos desde las 5 AM (sumando el offset del inicio del timeline)
                    const minutosDesde5AM = Math.max(0, Math.min(1439, minutosDesdeInicioTimeline + offsetInicioTimeline));
                    
                    // Redondear al intervalo de 15 minutos más cercano
                    const minutosRedondeadosDesde5AM = Math.round(minutosDesde5AM / 15) * 15;
                    
                    // Convertir minutos desde 5 AM a minutos desde medianoche reales
                    // Si minutosDesde5AM < 1140 (19 horas), es del día actual (5 AM - 11:59 PM)
                    // Si minutosDesde5AM >= 1140, es del día siguiente (12 AM - 4:59 AM)
                    let minutosDesdeMedianoche;
                    let diaOffset = 0; // Días a agregar (0 = mismo día, 1 = día siguiente)
                    
                    if (minutosRedondeadosDesde5AM < 1140) {
                        // Hora entre 5:00 AM y 11:59 PM del día actual
                        minutosDesdeMedianoche = minutosRedondeadosDesde5AM + (5 * 60); // Sumar 5 horas
                        diaOffset = 0;
                    } else {
                        // Hora entre 12:00 AM y 4:59 AM del día siguiente
                        minutosDesdeMedianoche = minutosRedondeadosDesde5AM - 1140; // Restar 19 horas (0-300 minutos)
                        diaOffset = 1;
                    }
                    
                    // Calcular hora y minuto (ya redondeados a intervalos de 15 minutos)
                    const horaRealInicio = Math.floor(minutosDesdeMedianoche / 60);
                    const minutosInicio = minutosDesdeMedianoche % 60;
                    const minutosRedondeadosInicio = Math.round(minutosInicio / 15) * 15;
                    
                    // Calcular duración basada en finY
                    const minutosDesdeInicioTimelineFin = (finY / 40) * 60; // 40px por hora = 1cm
                    const minutosDesde5AMFin = Math.max(0, Math.min(1439, minutosDesdeInicioTimelineFin + offsetInicioTimeline));
                    const minutosRedondeadosDesde5AMFin = Math.round(minutosDesde5AMFin / 15) * 15;
                    const duracionMinutos = Math.max(15, minutosRedondeadosDesde5AMFin - minutosRedondeadosDesde5AM);
                    const duracionRedondeada = Math.max(15, Math.round(duracionMinutos / 15) * 15);
                    
                    // Obtener fecha del día seleccionado
                    const year = diaSeleccionado.getFullYear();
                    const month = diaSeleccionado.getMonth();
                    const day = diaSeleccionado.getDate();
                    
                    // Crear fecha con la hora calculada (en hora local)
                    const fechaInicio = new Date(year, month, day + diaOffset, horaRealInicio, minutosRedondeadosInicio, 0, 0);
                    
                    // Formatear para datetime-local en hora local (no UTC)
                    const yearFormatted = fechaInicio.getFullYear();
                    const monthFormatted = String(fechaInicio.getMonth() + 1).padStart(2, '0');
                    const dayFormatted = String(fechaInicio.getDate()).padStart(2, '0');
                    const hoursFormatted = String(fechaInicio.getHours()).padStart(2, '0');
                    const minutesFormatted = String(fechaInicio.getMinutes()).padStart(2, '0');
                    const fechaFormateada = `${yearFormatted}-${monthFormatted}-${dayFormatted}T${hoursFormatted}:${minutesFormatted}`;
                    
                    console.log('✅ Abriendo modal desde cronograma', {
                        fechaFormateada,
                        duracionRedondeada,
                        ruta,
                        hora: `${horaRealInicio}:${minutosRedondeadosInicio.toString().padStart(2, '0')}`
                    });
                    
                    // Limpiar preview
                    if (dragPreview) {
                        dragPreview.remove();
                        dragPreview = null;
                    }
                    
                    // Abrir modal con ruta prellenada
                    abrirModalNuevaCitaDesdeArrastreCronograma(fechaFormateada, duracionRedondeada, ruta);
                    
                    e.preventDefault();
                };
                
                // Event listener para mousedown
                timeline.addEventListener('mousedown', (e) => {
                    // No iniciar si se hace click en la línea de convocatoria (solo mover hora de convocatoria)
                    if (e.target.closest('.linea-convocatoria')) {
                        return;
                    }
                    // Solo iniciar si no se hace click en una cita existente
                    if (e.target.closest('.cita-bloque')) {
                        return;
                    }
                    
                    console.log('🖱️ [CRONOGRAMA] Iniciando arrastre en timeline', { ruta, offsetY: e.offsetY });
                    
                    isDragging = true;
                    dragStartY = e.offsetY;
                    dragEndY = e.offsetY;
                    
                    // Crear preview
                    dragPreview = document.createElement('div');
                    dragPreview.className = 'drag-preview';
                    dragPreview.style.position = 'absolute';
                    dragPreview.style.left = '0';
                    dragPreview.style.right = '0';
                    dragPreview.style.backgroundColor = 'rgba(102, 126, 234, 0.3)';
                    dragPreview.style.border = '2px dashed #667eea';
                    dragPreview.style.borderRadius = '4px';
                    dragPreview.style.pointerEvents = 'none';
                    dragPreview.style.zIndex = '1000';
                    timeline.appendChild(dragPreview);
                    
                    actualizarDragPreview();
                    
                    // Agregar listeners globales
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    
                    e.stopPropagation();
                    e.preventDefault();
                }, true);
                
                function actualizarDragPreview() {
                    if (!dragPreview) return;
                    
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    const altura = finY - inicioY;
                    
                    dragPreview.style.top = `${inicioY}px`;
                    dragPreview.style.height = `${Math.max(altura, 20)}px`;
                }
            });
            
            console.log('✅ Arrastre para crear citas inicializado en', timelines.length, 'timelines');
        }

        // Función para obtener el lunes de la semana de una fecha
        function obtenerLunesSemana(fecha) {
            const fechaCopia = new Date(fecha);
            const dia = fechaCopia.getDay();
            const diff = fechaCopia.getDate() - dia + (dia === 0 ? -6 : 1); // Ajustar para que lunes sea 0
            return new Date(fechaCopia.setDate(diff));
        }
        
        // Función para obtener los días de la semana (lunes a domingo)
        function obtenerDiasSemana(fecha) {
            const lunes = obtenerLunesSemana(fecha);
            const dias = [];
            for (let i = 0; i < 7; i++) {
                const dia = new Date(lunes);
                dia.setDate(lunes.getDate() + i);
                dias.push(dia);
            }
            return dias;
        }
        
        // Función para generar cronograma
        async function generarCronograma() {
            // SIEMPRE usar vista extendida (no compacta)
            const estaEnVistaCompacta = false;
            
            // SIEMPRE mostrar solo un día operacional (5am a 5am del siguiente día)
            let diasAMostrar = [diaSeleccionado];
            
            // Ocultar navegación de semana (ya que solo mostramos un día)
            const navegacionSemana = document.getElementById('navegacionSemana');
            if (navegacionSemana) {
                navegacionSemana.style.display = 'none';
            }
            
            const year = diaSeleccionado.getFullYear();
            const month = diaSeleccionado.getMonth();
            const day = diaSeleccionado.getDate();
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const dayNames = [
                'Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'
            ];
            
            // Título del cronograma eliminado (ya no se muestra)

            // Generar ejes de horas para cada sección por separado
            const ejeHorasDiurnas = document.getElementById('ejeHorasDiurnas');
            const ejeHorasNocturnas = document.getElementById('ejeHorasNocturnas');
            
            // Función para generar marcadores de hora en el eje
            const generarMarcadoresHora = () => {
                let html = '';
                for (let hora = 0; hora < 24; hora++) {
                    const top = hora * 40; // Posición desde el inicio (40px por hora = 1cm)
                    const horaFormateada = hora === 0 ? '12:00 AM' : 
                                         hora < 12 ? `${hora}:00 AM` : 
                                         hora === 12 ? '12:00 PM' : 
                                         `${hora - 12}:00 PM`;
                    html += `
                        <div class="marcador-hora-timeline" style="top: ${top}px; position: absolute; left: 0; width: 100%; height: 40px;">
                            <span class="marcador-hora-timeline-label" style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: #000000; font-weight: 700;">${horaFormateada}</span>
                        </div>
                    `;
                }
                return html;
            };
            
            // Ocultar ejes externos, usar marcadores internos en "Sin asignar"
            if (ejeHorasDiurnas) {
                ejeHorasDiurnas.style.display = 'none';
            }
            if (ejeHorasNocturnas) {
                ejeHorasNocturnas.style.display = 'none';
            }

            // Obtener citas para todos los días a mostrar
            const citasPorDia = {};
            
            diasAMostrar.forEach(fechaDia => {
                const yearDia = fechaDia.getFullYear();
                const monthDia = fechaDia.getMonth();
                const dayDia = fechaDia.getDate();
                
                // Obtener citas del día laborable (5 AM del día hasta 4:59 AM del día siguiente)
                const fechaInicioDiaLaborable = new Date(yearDia, monthDia, dayDia, 5, 0, 0);
                const fechaFinDiaLaborable = new Date(yearDia, monthDia, dayDia + 1, 4, 59, 59);
                
                const citasDelDia = citasFiltradas.filter(cita => {
                    const fechaCita = window.formatearFecha(obtenerInicio(cita));
                    if (!fechaCita) return false;
                    
                    // Incluir citas que empiecen o terminen en el rango del día laborable
                    const duracion = obtenerDuracion(cita);
                    const fechaFinCita = new Date(fechaCita.getTime() + duracion * 60000);
                    
                    // Verificar si la cita se superpone con el rango del día laborable
                    const estaEnRango = (fechaCita >= fechaInicioDiaLaborable && fechaCita <= fechaFinDiaLaborable) ||
                                       (fechaFinCita >= fechaInicioDiaLaborable && fechaFinCita <= fechaFinDiaLaborable) ||
                                       (fechaCita <= fechaInicioDiaLaborable && fechaFinCita >= fechaFinDiaLaborable);
                    
                    return estaEnRango;
                });
                
                citasPorDia[`${yearDia}-${monthDia + 1}-${dayDia}`] = citasDelDia;
            });
            
            console.log('🔍 Filtro de citas:', {
                diasAMostrar: diasAMostrar.length,
                citasPorDia: Object.keys(citasPorDia).map(key => ({ dia: key, cantidad: citasPorDia[key].length })),
                totalCitasFiltradas: citasFiltradas.length
            });

            // Lista completa de rutas disponibles + "Sin asignar"
            const rutasDisponibles = [
                'Sin asignar',
                'Ruta 1', 'Ruta 2', 'Ruta 3', 'Ruta 4', 'Ruta 5', 
                'Ruta 6', 'Ruta 7', 'Ruta 8', 'Ruta 9', 'Ruta 10',
                'Ruta 11', 'Ruta 12', 'Ruta 13', 'Ruta 14', 'Ruta 15',
                'Ruta 16', 'Ruta 17', 'Ruta 18', 'Ruta 19', 'Ruta 20'
            ];

            // Agrupar citas por día y por ruta
            const citasPorDiaYRuta = {};
            
            diasAMostrar.forEach(fechaDia => {
                const yearDia = fechaDia.getFullYear();
                const monthDia = fechaDia.getMonth();
                const dayDia = fechaDia.getDate();
                const keyDia = `${yearDia}-${monthDia + 1}-${dayDia}`;
                const citasDelDia = citasPorDia[keyDia] || [];
                
                citasPorDiaYRuta[keyDia] = {};
                rutasDisponibles.forEach(ruta => {
                    citasPorDiaYRuta[keyDia][ruta] = [];
                });
                
                citasDelDia.forEach(cita => {
                    const ruta = obtenerRuta(cita);
                    if (citasPorDiaYRuta[keyDia][ruta]) {
                        citasPorDiaYRuta[keyDia][ruta].push(cita);
                    } else {
                        citasPorDiaYRuta[keyDia]['Sin asignar'].push(cita);
                    }
                });
            });

            // Ordenar rutas: "Sin asignar" primero, luego rutas numéricamente
            const rutasOrdenadas = rutasDisponibles.sort((a, b) => {
                if (a === 'Sin asignar') return -1;
                if (b === 'Sin asignar') return 1;
                // Extraer números de "Ruta X" y comparar
                const numA = parseInt(a.replace('Ruta ', '')) || 0;
                const numB = parseInt(b.replace('Ruta ', '')) || 0;
                return numA - numB;
            });

            // Cargar datos de ruteador para todas las rutas del día operacional seleccionado
            const datosRuteadorMap = {};
            
            // SIEMPRE cargar datos solo para el día seleccionado (un solo día operacional)
            if (!diaSeleccionado) {
                console.warn('⚠️ [CALENDARIO] diaSeleccionado no está definido al cargar ruteador, usando fecha actual');
                diaSeleccionado = new Date();
            }
            const yearDia = diaSeleccionado.getFullYear();
            const monthDia = diaSeleccionado.getMonth();
            const dayDia = diaSeleccionado.getDate();
            const fechaFormateada = `${yearDia}-${String(monthDia + 1).padStart(2, '0')}-${String(dayDia).padStart(2, '0')}`;
            console.log('📅 [CALENDARIO] Cargando datos de ruteador para fecha (día operacional):', fechaFormateada);
            
            const datosRuteadorPromesas = rutasOrdenadas.map(async ruta => {
                const datos = await cargarRuteador(fechaFormateada, ruta);
                return { fecha: fechaFormateada, ruta, datos };
            });
            
            const datosRuteadorArray = await Promise.all(datosRuteadorPromesas);
            datosRuteadorArray.forEach(({ fecha, ruta, datos }) => {
                const key = `${fecha}_${ruta}`;
                datosRuteadorMap[key] = datos;
                if (datos.tecnicos && datos.tecnicos.length > 0) {
                    console.log(`📋 [CALENDARIO] Datos de ruteador cargados para ${key}:`, datos);
                }
            });
            
            // Crear citasPorRuta para el día operacional seleccionado
            const citasPorRuta = {};
            const keyDia = `${year}-${month + 1}-${day}`;
            rutasDisponibles.forEach(ruta => {
                citasPorRuta[ruta] = citasPorDiaYRuta[keyDia]?.[ruta] || [];
            });
            
            // Recolectar todos los vehículos y técnicos disponibles para saber cuáles no están asignados
            const todosLosVehiculos = ['APV 01', 'APV 02', 'APV 03', 'APV 04', 'APV 05', 
                                       'APV 06', 'APV 07', 'APV 08', 'Kangoo', 'Yaris', 'Prado', 'Rojo'];
            
            // Separar rutas en diurnas (1-10) y nocturnas/especiales (11-20)
            const rutasDiurnas = ['Sin asignar', ...rutasOrdenadas.filter(r => {
                if (r === 'Sin asignar') return false;
                const num = parseInt(r.replace('Ruta ', '')) || 0;
                return num >= 1 && num <= 10;
            })];
            
            const rutasNocturnas = ['Sin asignar', ...rutasOrdenadas.filter(r => {
                if (r === 'Sin asignar') return false;
                const num = parseInt(r.replace('Ruta ', '')) || 0;
                return num >= 11 && num <= 20;
            })];
            
            // Obtener vehículos y técnicos asignados en todas las rutas (excepto "Sin asignar")
            // SIEMPRE para el día operacional seleccionado (un solo día)
            // Reutilizar las variables ya declaradas arriba (yearDia, monthDia, dayDia, fechaFormateada)
            const vehiculosAsignados = new Set();
            const tecnicosAsignados = new Set();
            
            console.log('🔍 [CALENDARIO] Calculando técnicos asignados para día operacional:', fechaFormateada);
            
            [...rutasDiurnas, ...rutasNocturnas].forEach(r => {
                if (r !== 'Sin asignar') {
                    // Buscar con formato ${fecha}_${ruta} para el día seleccionado
                    const key = `${fechaFormateada}_${r}`;
                    const datos = datosRuteadorMap[key] || { tecnicos: [], vehiculos: [] };
                    if (datos.tecnicos && datos.tecnicos.length > 0) {
                        console.log(`📋 [CALENDARIO] Técnicos asignados en ${r} (${fechaFormateada}):`, datos.tecnicos);
                    }
                    // Normalizar vehículos antes de agregarlos al Set (trim y convertir a string)
                    datos.vehiculos.forEach(v => {
                        const vNormalizado = v ? String(v).trim() : '';
                        if (vNormalizado) {
                            vehiculosAsignados.add(vNormalizado);
                        }
                    });
                    datos.tecnicos.forEach(t => tecnicosAsignados.add(t));
                }
            });
            
            console.log('✅ [CALENDARIO] Total técnicos asignados para el día operacional:', Array.from(tecnicosAsignados));
            
            // Calcular vehículos y técnicos sin asignar
            // Normalizar también los vehículos de la lista hardcodeada para comparar correctamente
            const vehiculosSinAsignar = todosLosVehiculos.filter(v => {
                const vNormalizado = String(v).trim();
                return !vehiculosAsignados.has(vNormalizado);
            });
            console.log('🔍 [CALENDARIO] Calculando técnicos sin asignar. Técnicos asignados:', Array.from(tecnicosAsignados), 'Total:', tecnicosAsignados.size);
            const tecnicosSinAsignar = (window.empleados || [])
                .filter(e => {
                    // IMPORTANTE: Usar username como identificador principal, id como fallback
                    const username = e.username || e.id;
                    if (!username || String(username).trim() === '') {
                        return false;
                    }
                    const estaAsignado = tecnicosAsignados.has(username);
                    if (estaAsignado) {
                        console.log(`🔒 [CALENDARIO] Técnico ${username} está asignado, no aparece en sin asignar`);
                    }
                    return !estaAsignado;
                })
                .map(e => {
                    // IMPORTANTE: Usar username como identificador principal, id como fallback
                    // NO usar el nombre como username
                    const username = e.username || e.id;
                    if (!username || String(username).trim() === '') {
                        return null;
                    }
                    
                    // Generar el nombre formateado para mostrar (solo para visualización)
                    const primerNombre = (e.primerNombre || '').trim();
                    const primerApellido = (e.primerApellido || '').trim();
                    const inicialApellido = primerApellido ? primerApellido.charAt(0).toUpperCase() + '.' : '';
                    const nombreFormateado = `${primerNombre} ${inicialApellido}`.trim() || username;
                    
                    return {
                        username: username, // SIEMPRE usar el username real del empleado, NO el nombre
                        id: e.id,
                        nombre: nombreFormateado, // El nombre es solo para mostrar en la UI
                        departamento: e.departamento || '' // Departamento del empleado para ordenamiento
                    };
                })
                .filter(t => t !== null && t.username && String(t.username).trim() !== '') // Filtrar nulos y sin username
                .sort((a, b) => {
                    // Ordenar: empleados de Fumigación primero, luego el resto
                    const depA = (a.departamento || '').trim().toLowerCase();
                    const depB = (b.departamento || '').trim().toLowerCase();
                    const esFumigacionA = depA === 'fumigación' || depA === 'fumigacion';
                    const esFumigacionB = depB === 'fumigación' || depB === 'fumigacion';
                    
                    if (esFumigacionA && !esFumigacionB) return -1;
                    if (!esFumigacionA && esFumigacionB) return 1;
                    return 0; // Mantener el orden original para el resto
                });

            // Renderizar cajas de recursos sin asignar
            console.log('🎨 [CALENDARIO] Renderizando recursos sin asignar:', {
                fecha: fechaFormateada,
                tecnicosSinAsignar: tecnicosSinAsignar.length,
                vehiculosSinAsignar: vehiculosSinAsignar.length,
                tecnicosAsignados: Array.from(tecnicosAsignados),
                diaSeleccionado: diaSeleccionado ? `${diaSeleccionado.getFullYear()}-${diaSeleccionado.getMonth() + 1}-${diaSeleccionado.getDate()}` : 'NO DEFINIDO'
            });
            renderizarRecursosSinAsignar(tecnicosSinAsignar, vehiculosSinAsignar, fechaFormateada);
            
            // Renderizar técnicos y vehículos para rutas nocturnas (arriba de rutas nocturnas)
            renderizarRecursosNocturnas(tecnicosSinAsignar, vehiculosSinAsignar);
            
            // Usar alturas fijas para mantener consistencia visual
            // Vehículos: 28px fijo (delgado)
            // Técnicos: altura automática para permitir múltiples técnicos
            const alturaFijaVehiculos = 28;
            const alturaMinimaTecnicos = 50; // Altura mínima para permitir múltiples técnicos
            
            // Aplicar altura uniforme fija a todas las filas usando estilos dinámicos
            let styleElement = document.getElementById('estilos-filas-rutas');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'estilos-filas-rutas';
                document.head.appendChild(styleElement);
            }
            /* Alturas ya fijas por grid; este bloque se mantiene por si se necesita override */
            styleElement.textContent = `
                .vehiculo-header-cronograma { grid-template-rows: 35px 22px 22px 48px ${alturaFijaVehiculos}px 78px 22px; }
            `;

            // Función auxiliar para generar HTML de una columna de ruta
            const generarColumnaRuta = (ruta, citasParam = null, fechaParam = null) => {
                // Si se pasan citas y fecha como parámetros, usarlas; si no, usar las globales
                const citas = citasParam || citasPorRuta[ruta];
                const fechaFormateadaParaRuta = fechaParam || (estaEnVistaCompacta ? null : `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                
                // Obtener datos del ruteador para el día operacional seleccionado
                let datosRuteador = { tecnicos: [], vehiculos: [] };
                // Siempre usar el formato ${fecha}_${ruta} para el día seleccionado
                const key = `${fechaFormateada}_${ruta}`;
                datosRuteador = datosRuteadorMap[key] || { tecnicos: [], vehiculos: [] };
                
                // Calcular total de citas
                const totalCitas = citas ? citas.length : 0;
                
                // Calcular monto total y cantidad de citas con precio > 0
                const citasConPrecio = citas.filter(cita => {
                    const monto = obtenerMonto(cita);
                    return monto && monto > 0;
                });
                const montoTotal = citasConPrecio.reduce((sum, cita) => sum + obtenerMonto(cita), 0);
                const cantidadCitasConPrecio = citasConPrecio.length;
                
                // Formatear monto en miles (ej: 195000 -> ₡195m)
                let montoFormateado = '₡0m';
                if (montoTotal > 0) {
                    const montoEnMiles = Math.round(montoTotal / 1000);
                    montoFormateado = `₡${montoEnMiles}m`;
                }
                
                // Determinar icono del badge de facturación según el monto
                let iconoBadge = '';
                if (citas.length > 0 && montoTotal > 0) {
                    if (montoTotal > 200000) {
                        iconoBadge = '<i class="fas fa-check-circle" style="color: #4caf50; font-size: 0.9rem;"></i>';
                    } else if (montoTotal >= 100000) {
                        iconoBadge = '<i class="fas fa-exclamation-triangle" style="color: #ffc107; font-size: 0.9rem;"></i>';
                    } else {
                        iconoBadge = '<i class="fas fa-times-circle" style="color: #f44336; font-size: 0.9rem;"></i>';
                    }
                }
                // Si es 0 o no hay citas, no mostrar icono
                
                // Fondo: siempre blanco para que los colores de ruta (cabecera) se mantengan incluso sin citas
                const colorFondo = '#ffffff';
                
                // Filtrar citas con coordenadas GPS
                // Usar función síncrona que verifica fallback y asume que citas con sucursal pueden tener coordenadas
                // Las coordenadas se obtendrán correctamente desde sucursal cuando se necesiten (en mostrarRutaVehiculo)
                const citasConUbicacion = citas.filter(cita => {
                    const sucursalIndice = window.obtenerCampoCita(cita, 'sucursalIndice', null);
                    const tieneSucursal = window.esSucursalIndiceValido(sucursalIndice);
                    if (tieneSucursal) return true;
                    const coordenadas = window.obtenerCampoCita(cita, 'coordenadas', null);
                    return coordenadas && coordenadas.lat && coordenadas.lng;
                });
                
                // Formatear técnicos asignados
                const tecnicosNombres = datosRuteador.tecnicos.map(username => {
                    const empleado = window.empleados?.find(e => e.username === username || e.id === username);
                    return empleado ? `${empleado.primerNombre} ${empleado.primerApellido}`.trim() : username;
                }).join(', ') || 'Sin asignar';
                
                // Formatear vehículos asignados
                const vehiculosTexto = datosRuteador.vehiculos.join(', ') || 'Sin asignar';
                
                // Almacenar citas en variable global para acceso desde el botón
                const rutaId = ruta.replace(/[^a-zA-Z0-9]/g, '-');
                const fechaKey = fechaFormateadaParaRuta ? fechaFormateadaParaRuta.replace(/-/g, '') : '';
                const claveCompleta = fechaKey ? `${fechaKey}_${rutaId}` : rutaId;
                if (!window.citasPorRutaRuta) {
                    window.citasPorRutaRuta = {};
                }
                window.citasPorRutaRuta[claveCompleta] = citas;
                
                const tieneCitas = citas && citas.length > 0;
                // Mantener siempre el color de la ruta (clase CSS); no poner gris cuando no hay citas
                const colorHeader = '';
                const colorContenido = '';
                const colorInfoRow = '';
                
                // Estilos para ruta sin citas (deshabilitada/dormida)
                const estiloCirculoDeshabilitado = tieneCitas ? '' : 'opacity: 0.5; background: #bdbdbd !important; border: 2.5px solid #9e9e9e !important; position: relative;';
                const simboloDormida = tieneCitas ? '' : '<i class="fas fa-moon" style="position: absolute; top: 2px; right: 2px; font-size: 0.45rem; color: #757575; background: white; border-radius: 50%; padding: 1px; border: 1px solid #9e9e9e;"></i>';
                
                // Determinar el texto a mostrar en el círculo
                let textoCirculo = ruta.replace('Ruta ', '');
                let tamanoCirculo = '32px';
                let tamanoFuente = '1rem';
                if (ruta === 'Ruta 19') {
                    textoCirculo = 'Rural';
                    tamanoCirculo = 'auto';
                    tamanoFuente = '0.8rem';
                } else if (ruta === 'Ruta 20') {
                    textoCirculo = 'Cancelaciones';
                    tamanoCirculo = 'auto';
                    tamanoFuente = '0.7rem';
                }
                
                // Formatear hora de convocatoria para mostrar en la columna (ej: "06:30" -> "6:30 AM")
                const horaConvRaw = datosRuteador.horaConvocatoria != null && String(datosRuteador.horaConvocatoria).trim() !== '' ? String(datosRuteador.horaConvocatoria).trim() : null;
                let horaConvocatoriaTexto = '';
                if (horaConvRaw) {
                    const partes = horaConvRaw.split(':');
                    const hr = parseInt(partes[0], 10);
                    const min = partes[1] ? parseInt(partes[1], 10) : 0;
                    if (hr >= 12) {
                        horaConvocatoriaTexto = (hr === 12 ? 12 : hr - 12) + ':' + String(min).padStart(2, '0') + ' PM';
                    } else {
                        horaConvocatoriaTexto = (hr === 0 ? 12 : hr) + ':' + String(min).padStart(2, '0') + ' AM';
                    }
                }
                
                // Contenido slots siempre presentes; placeholders cuando no hay dato
                const textoCitasSlot = totalCitas === 0 ? '0 citas' : (totalCitas === 1 ? '1 cita' : totalCitas + ' citas');
                const mostrarBtnRuta = citasConUbicacion.length > 0;
                const mostrarBtnTecnicos = ruta !== 'Sin asignar';
                const mostrarBtnMigrar = citas.length > 0 && ruta !== 'Sin asignar';
                const htmlBtnRuta = mostrarBtnRuta ? `<button class="btn-slot btn-slot-icon" onclick="window.mostrarRutaVehiculo('${ruta.replace(/'/g, "\\'")}', '${claveCompleta}')" style="background: ${ruta === 'Sin asignar' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}; border: 1px solid ${ruta === 'Sin asignar' ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.5)'}; color: ${ruta === 'Sin asignar' ? '#000' : 'white'}; padding: 2px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 26px; height: 22px; flex-shrink: 0;" title="Ver Ruta (${citasConUbicacion.length} citas)"><i class="fas fa-map-marked-alt" style="font-size: 0.7rem;"></i></button>` : '<span class="btn-slot-placeholder" aria-hidden="true"></span>';
                const htmlBtnTecnicos = mostrarBtnTecnicos ? `<button class="btn-slot btn-slot-icon" onclick="if(window.editarRuteador){ window.editarRuteador('${ruta.replace(/'/g, "\\'")}', '${fechaFormateadaParaRuta || ''}'); }" style="background: rgba(76,175,80,0.95); border: 1px solid rgba(255,255,255,0.5); color: #fff; padding: 2px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 26px; height: 22px; flex-shrink: 0;" title="Asignar Técnicos, Vehículos y Hora de convocatoria"><i class="fas fa-users-cog" style="font-size: 0.7rem;"></i></button>` : '<span class="btn-slot-placeholder" aria-hidden="true"></span>';
                const htmlBtnMigrar = mostrarBtnMigrar ? `<button class="btn-slot btn-slot-icon" onclick="window.abrirModalMigrarRuta('${ruta.replace(/'/g, "\\'")}', '${fechaFormateadaParaRuta}')" style="background: rgba(255,193,7,0.9); border: 1px solid rgba(255,255,255,0.5); color: #000; padding: 2px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 26px; height: 22px; flex-shrink: 0;" title="Migrar citas"><i class="fas fa-exchange-alt" style="font-size: 0.7rem;"></i></button>` : '<span class="btn-slot-placeholder" aria-hidden="true"></span>';
                
                const htmlVehiculos = datosRuteador.vehiculos.length > 0 
                    ? datosRuteador.vehiculos.filter(v => v && String(v).trim() !== '').map(v => {
                        const vehiculoEscapado = String(v).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const rutaEscapada = ruta.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        return `<span class="ruta-badge-item ruta-badge-vehiculo" draggable="true" data-tipo="vehiculo" data-vehiculo="${vehiculoEscapado}" data-ruta="${rutaEscapada}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}">${v}</span>`;
                    }).join('')
                    : '<span style="color: #2196F3; font-size: 0.6rem; font-style: italic; opacity: 0.8;">Arrastre vehículos aquí</span>';
                
                const htmlTecnicos = datosRuteador.tecnicos.length > 0 
                    ? datosRuteador.tecnicos.filter(tecnicoId => tecnicoId && String(tecnicoId).trim() !== '').map(tecnicoId => {
                        const empleado = window.empleados?.find(e => (e.username && e.username === tecnicoId) || (e.id && e.id === tecnicoId) || (e.username && e.id === tecnicoId) || (e.id && e.username === tecnicoId));
                        let usernameFinal = empleado ? (empleado.username || empleado.id) : tecnicoId;
                        if (!usernameFinal || String(usernameFinal).trim() === '') return null;
                        usernameFinal = String(usernameFinal).trim();
                        let nombre = String(tecnicoId);
                        if (empleado) {
                            const pr = empleado.primerNombre || '', ap = empleado.primerApellido || '';
                            const iniAp = ap ? ap.charAt(0).toUpperCase() + '.' : '';
                            nombre = `${pr} ${iniAp}`.trim() || nombre;
                        }
                        const usernameEscapado = String(usernameFinal).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const nombreEscapado = String(nombre).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const rutaEscapada = ruta.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        return `<span class="ruta-badge-item ruta-badge-tecnico" draggable="true" data-tipo="tecnico" data-username="${usernameEscapado}" data-nombre="${nombreEscapado}" data-ruta="${rutaEscapada}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}">${nombre}</span>`;
                    }).filter(b => b !== null).join('')
                    : '<span style="color: #FF9800; font-size: 0.6rem; font-style: italic; opacity: 0.8;">Arrastre técnicos aquí</span>';
                
                return `
                    <div class="vehiculo-columna-cronograma" style="background: ${colorFondo};">
                        <div class="vehiculo-header-cronograma ${ruta.replace(' ', '-')}" style="${colorHeader}">
                            <div class="ruta-row ruta-row-numero ruta-nombre-header" style="${ruta === 'Sin asignar' ? 'cursor: default;' : ''}">
                                ${ruta === 'Sin asignar' ? 
                                    `<span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: white; border: 2.5px solid #000; font-size: 0.75rem; font-weight: 800; color: #000; ${!tieneCitas ? 'opacity: 0.5; background: #bdbdbd !important; border: 2.5px solid #9e9e9e !important;' : ''}">S/A${!tieneCitas ? '<i class="fas fa-moon" style="position: absolute; top: 2px; right: 2px; font-size: 0.45rem; color: #757575;"></i>' : ''}</span>` : 
                                    `<span style="display: inline-flex; align-items: center; justify-content: center; min-width: ${tamanoCirculo}; ${(ruta === 'Ruta 19' || ruta === 'Ruta 20') ? 'width: auto; padding: 0 6px; border-radius: 16px;' : 'width: ' + tamanoCirculo + '; height: ' + tamanoCirculo + '; border-radius: 50%;'} background: white; border: 2.5px solid #000; font-size: ${tamanoFuente}; font-weight: 800; color: #000; ${estiloCirculoDeshabilitado}">${textoCirculo}</span>${simboloDormida}`
                                }
                            </div>
                            <div class="ruta-row ruta-row-citas">
                                <span class="ruta-citas-badge" style="font-size: clamp(0.6rem, 1vw, 0.7rem); font-weight: 600; background: #ffffff; color: #000000; padding: 2px 6px; border-radius: 4px; white-space: nowrap;"><i class="fas fa-calendar-check" style="font-size: 0.65rem;"></i> ${textoCitasSlot}</span>
                            </div>
                            <div class="ruta-row ruta-row-monto">
                                <span class="ruta-monto-badge" style="background: #ffffff; color: #000000; border: 1px solid rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">${iconoBadge}${montoFormateado !== '₡0m' ? montoFormateado : '₡0'}</span>
                            </div>
                            <div class="ruta-row ruta-row-botones">
                                ${htmlBtnRuta}
                                ${htmlBtnTecnicos}
                                ${htmlBtnMigrar}
                            </div>
                            <div class="ruta-row ruta-row-vehiculos ruta-info-row ${datosRuteador.vehiculos.length === 0 ? 'drop-zone-empty' : ''}" data-tipo-fila="vehiculo" data-ruta="${ruta.replace(/'/g, "\\'")}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}" title="Arrastre vehículos aquí" style="${colorInfoRow}">${htmlVehiculos}</div>
                            <div class="ruta-row ruta-row-tecnicos">
                                <div class="ruta-info-row ruta-cell-tecnicos ${datosRuteador.tecnicos.length === 0 ? 'drop-zone-empty' : ''}" data-tipo-fila="tecnico" data-ruta="${ruta.replace(/'/g, "\\'")}" data-fecha-ruta="${fechaFormateadaParaRuta || ''}" title="Arrastre técnicos aquí" style="${colorInfoRow}">${htmlTecnicos}</div>
                            </div>
                            <div class="ruta-row ruta-row-hora ruta-hora-convocatoria" data-tipo-fila="hora-convocatoria" style="font-size: 0.55rem; color: #000000; font-weight: 600; ${colorInfoRow}">${horaConvocatoriaTexto ? `<i class="fas fa-clock" style="font-size: 0.6rem; color: #1565C0;"></i><span> ${horaConvocatoriaTexto}</span>` : '<span style="color: #9e9e9e; font-weight: 500; font-style: italic;">Sin hora</span>'}${ruta !== 'Sin asignar' ? ` <button type="button" class="btn-editar-hora-ruta" onclick="event.stopPropagation(); if(window.editarRuteador){ window.editarRuteador('${ruta.replace(/'/g, "\\'")}', '${fechaFormateadaParaRuta || ''}'); }" title="Editar hora de convocatoria" style="background: none; border: none; padding: 0 2px; cursor: pointer; color: #1565C0; font-size: 0.65rem;"><i class="fas fa-pencil-alt"></i></button>` : ''}</div>
                        </div>
                        <div class="citas-timeline" id="timeline-${(fechaFormateadaParaRuta || '').replace(/-/g, '')}-${ruta.replace(/ /g, '-')}" data-ruta="${ruta}" data-fecha="${fechaFormateadaParaRuta || ''}">${generarCitasTimeline(citas, ruta, datosRuteador.horaConvocatoria || null, fechaFormateadaParaRuta || '')}</div>
                    </div>
                `;
            };

            // Generar HTML en dos contenedores completamente separados
            const vehiculosCronogramaDiurnas = document.getElementById('vehiculosCronogramaDiurnas');
            const vehiculosCronogramaNocturnas = document.getElementById('vehiculosCronogramaNocturnas');
            
            // Generar sección diurnas - SIEMPRE solo un día operacional
            if (vehiculosCronogramaDiurnas) {
                // Siempre mostrar solo el día operacional seleccionado (5am a 5am del siguiente día)
                const htmlDiurnas = rutasDiurnas.map(ruta => generarColumnaRuta(ruta, citasPorRuta[ruta] || [], fechaFormateada)).join('');
                vehiculosCronogramaDiurnas.innerHTML = htmlDiurnas;
            }
            
            // Generar sección nocturnas - SIEMPRE solo un día operacional
            if (vehiculosCronogramaNocturnas && rutasNocturnas.length > 0) {
                // Siempre mostrar solo el día operacional seleccionado (5am a 5am del siguiente día)
                const htmlNocturnas = rutasNocturnas.map(ruta => generarColumnaRuta(ruta, citasPorRuta[ruta] || [], fechaFormateada)).join('');
                vehiculosCronogramaNocturnas.innerHTML = htmlNocturnas;
            }

            // Siempre mostrar todas las rutas, incluso sin citas
            
            // Función para calcular y actualizar rangos de horas en los títulos y colapsar filas fuera del rango
            const actualizarRangosEnTitulos = () => {
                // Función auxiliar para obtener minutos desde medianoche
                const obtenerMinutosDesdeMedianoche = (cita) => {
                    const timestamp = obtenerInicio(cita);
                    if (!timestamp) return null;
                    
                    let fechaLocal;
                    if (timestamp && timestamp.toDate) {
                        fechaLocal = timestamp.toDate();
                    } else if (timestamp instanceof Date) {
                        fechaLocal = timestamp;
                    } else {
                        return null;
                    }
                    
                    const horaInicio = fechaLocal.getHours();
                    const minutoInicio = fechaLocal.getMinutes();
                    const minutosDesdeMedianoche = horaInicio * 60 + minutoInicio;
                    
                    // Convertir a minutos desde las 5 AM (día laborable)
                    // Si la hora es antes de las 5 AM, pertenece al día siguiente (sumar 19 horas)
                    // Si la hora es 5 AM o después, restar 5 horas
                    if (horaInicio < 5) {
                        // Hora entre 0:00 y 4:59 AM -> pertenece al día siguiente
                        return minutosDesdeMedianoche + (19 * 60); // Sumar 19 horas (1140 minutos)
                    } else {
                        // Hora entre 5:00 AM y 23:59 -> restar 5 horas (300 minutos)
                        return minutosDesdeMedianoche - (5 * 60);
                    }
                };
                
                // Función para formatear minutos a hora legible
                const formatearMinutosAHora = (minutos) => {
                    if (minutos === null || minutos === undefined) return '';
                    const horas = Math.floor(minutos / 60);
                    const mins = minutos % 60;
                    const hora12 = horas === 0 ? 12 : horas > 12 ? horas - 12 : horas;
                    const ampm = horas < 12 ? 'AM' : 'PM';
                    return `${hora12}:${mins.toString().padStart(2, '0')} ${ampm}`;
                };
                
                // Calcular rango para rutas diurnas
                let minInicioDiurnas = null;
                let maxFinDiurnas = null;
                rutasDiurnas.forEach(ruta => {
                    const citas = citasPorRuta[ruta] || [];
                    citas.forEach(cita => {
                        const minutosInicio = obtenerMinutosDesdeMedianoche(cita);
                        if (minutosInicio !== null) {
                            const duracion = obtenerDuracion(cita);
                            const minutosFin = minutosInicio + duracion;
                            
                            if (minInicioDiurnas === null || minutosInicio < minInicioDiurnas) {
                                minInicioDiurnas = minutosInicio;
                            }
                            if (maxFinDiurnas === null || minutosFin > maxFinDiurnas) {
                                maxFinDiurnas = minutosFin;
                            }
                        }
                    });
                });
                
                // Calcular rango para rutas nocturnas
                let minInicioNocturnas = null;
                let maxFinNocturnas = null;
                rutasNocturnas.forEach(ruta => {
                    const citas = citasPorRuta[ruta] || [];
                    citas.forEach(cita => {
                        const minutosInicio = obtenerMinutosDesdeMedianoche(cita);
                        if (minutosInicio !== null) {
                            const duracion = obtenerDuracion(cita);
                            const minutosFin = minutosInicio + duracion;
                            
                            if (minInicioNocturnas === null || minutosInicio < minInicioNocturnas) {
                                minInicioNocturnas = minutosInicio;
                            }
                            if (maxFinNocturnas === null || minutosFin > maxFinNocturnas) {
                                maxFinNocturnas = minutosFin;
                            }
                        }
                    });
                });
                
                // Agregar 1 hora de margen antes y después (en minutos)
                const minutosInicioDiurnasConMargen = minInicioDiurnas !== null ? Math.max(0, minInicioDiurnas - 60) : null;
                const minutosFinDiurnasConMargen = maxFinDiurnas !== null ? Math.min(1440, maxFinDiurnas + 60) : null;
                
                const minutosInicioNocturnasConMargen = minInicioNocturnas !== null ? Math.max(0, minInicioNocturnas - 60) : null;
                const minutosFinNocturnasConMargen = maxFinNocturnas !== null ? Math.min(1440, maxFinNocturnas + 60) : null;
                
                // Actualizar título de sección diurnas (sin rango de horas)
                const tituloDiurnas = document.querySelector('#seccionRutasDiurnas .seccion-titulo');
                if (tituloDiurnas) {
                    tituloDiurnas.innerHTML = `<i class="fas fa-sun me-2"></i>Rutas Diurnas (Sin asignar, Ruta 1-10)`;
                }
                
                // Actualizar título de sección nocturnas (sin rango de horas)
                const tituloNocturnas = document.querySelector('#seccionRutasNocturnas .seccion-titulo');
                if (tituloNocturnas) {
                    tituloNocturnas.innerHTML = `<i class="fas fa-moon me-2"></i>Rutas Nocturnas / Especiales (Ruta 11-Cancelaciones)`;
                }
                
                // Función para ocultar/mostrar filas de horas fuera del rango en una sección
                const colapsarFilasHoras = (contenedorId, minutosInicioConMargen, minutosFinConMargen, colapsar = true) => {
                    const contenedor = document.getElementById(contenedorId);
                    if (!contenedor) return;
                    
                    // Calcular altura del timeline en vista compacta
                    let alturaTimeline = 960; // Altura por defecto (24 horas * 40px = 1cm por hora)
                    let offsetTop = 0; // Offset para reposicionar elementos
                    
                    if (colapsar && minutosInicioConMargen !== null && minutosFinConMargen !== null) {
                        // Calcular altura basada en el rango visible (con margen)
                        const minutosTotales = minutosFinConMargen - minutosInicioConMargen;
                        alturaTimeline = (minutosTotales / 60) * 40; // 40px por hora = 1cm
                        offsetTop = (minutosInicioConMargen / 60) * 40; // Offset para reposicionar (40px por hora = 1cm)
                    }
                    
                    // Obtener todas las columnas de rutas en esta sección
                    const columnas = contenedor.querySelectorAll('.vehiculo-columna-cronograma');
                    
                    columnas.forEach(columna => {
                        const timeline = columna.querySelector('.citas-timeline');
                        if (!timeline) return;
                        
                        // Ajustar altura del timeline
                        if (colapsar && minutosInicioConMargen !== null && minutosFinConMargen !== null) {
                            timeline.style.height = `${alturaTimeline}px`;
                            timeline.style.minHeight = `${alturaTimeline}px`;
                            timeline.style.overflow = 'hidden';
                        } else {
                            // Vista total: restaurar altura original (24h = 5am a 5am del día siguiente)
                            timeline.style.height = '960px';
                            timeline.style.minHeight = '960px';
                            timeline.style.overflow = 'visible';
                        }
                        
                        // Ocultar/mostrar y reposicionar marcadores de hora
                        const marcadores = timeline.querySelectorAll('.marcador-hora-timeline');
                        marcadores.forEach(marcador => {
                            const topOriginal = parseFloat(marcador.style.top) || 0;
                            // Convertir top (px) a minutos desde las 5 AM: top / 40 * 60 (40px por hora = 1cm)
                            const minutosDesde5AM = (topOriginal / 40) * 60;
                            
                            if (!colapsar || minutosInicioConMargen === null || minutosFinConMargen === null) {
                                // Vista total: mostrar todas las horas en su posición original
                                marcador.style.display = 'block';
                                marcador.style.top = `${topOriginal}px`;
                                marcador.style.transform = 'none';
                            } else {
                                // Vista compacta: ocultar fuera del rango y reposicionar los visibles
                                if (minutosDesde5AM < minutosInicioConMargen || minutosDesde5AM > minutosFinConMargen) {
                                    marcador.style.display = 'none';
                                } else {
                                    marcador.style.display = 'block';
                                    // Reposicionar: restar el offset para que empiece desde 0
                                    const nuevoTop = topOriginal - offsetTop;
                                    marcador.style.top = `${nuevoTop}px`;
                                }
                            }
                        });
                        
                        // Ocultar/mostrar y reposicionar líneas divisorias
                        const lineas = timeline.querySelectorAll('.linea-divisoria-hora');
                        lineas.forEach(linea => {
                            const topOriginal = parseFloat(linea.style.top) || 0;
                            // Convertir top (px) a minutos desde las 5 AM: top / 40 * 60 (40px por hora = 1cm)
                            const minutosDesde5AM = (topOriginal / 40) * 60;
                            
                            if (!colapsar || minutosInicioConMargen === null || minutosFinConMargen === null) {
                                // Vista total: mostrar todas las líneas en su posición original
                                linea.style.display = 'block';
                                linea.style.top = `${topOriginal}px`;
                            } else {
                                // Vista compacta: ocultar fuera del rango y reposicionar las visibles
                                if (minutosDesde5AM < minutosInicioConMargen || minutosDesde5AM > minutosFinConMargen) {
                                    linea.style.display = 'none';
                                } else {
                                    linea.style.display = 'block';
                                    // Reposicionar: restar el offset para que empiece desde 0
                                    const nuevoTop = topOriginal - offsetTop;
                                    linea.style.top = `${nuevoTop}px`;
                                }
                            }
                        });
                        
                        // Reposicionar citas en vista compacta
                        if (colapsar && minutosInicioConMargen !== null && minutosFinConMargen !== null) {
                            const citas = timeline.querySelectorAll('.cita-bloque');
                            citas.forEach(cita => {
                                const topOriginal = parseFloat(cita.style.top) || 0;
                                const alturaCita = parseFloat(cita.style.height) || 0;
                                const minutosCitaInicio = (topOriginal / 40) * 60; // 40px por hora = 1cm
                                const minutosCitaFin = minutosCitaInicio + (alturaCita / 40) * 60; // 40px por hora = 1cm
                                
                                // Verificar si la cita está dentro del rango visible (o se superpone)
                                if (minutosCitaFin >= minutosInicioConMargen && minutosCitaInicio <= minutosFinConMargen) {
                                    // La cita está dentro o se superpone con el rango visible
                                    cita.style.display = 'block';
                                    // Reposicionar: restar el offset para que empiece desde 0
                                    const nuevoTop = topOriginal - offsetTop;
                                    cita.style.top = `${nuevoTop}px`;
                                } else {
                                    // La cita está completamente fuera del rango visible
                                    cita.style.display = 'none';
                                }
                            });
                        } else {
                            // Vista total: mostrar todas las citas y restaurar posiciones originales
                            const citas = timeline.querySelectorAll('.cita-bloque');
                            citas.forEach(cita => {
                                cita.style.display = 'block';
                                // Las posiciones se restauran al regenerar el cronograma
                            });
                        }
                    });
                };
                
                // Guardar rangos en variables globales para poder usarlos desde el toggle
                window.rangosHoras = {
                    diurnas: {
                        inicio: minutosInicioDiurnasConMargen,
                        fin: minutosFinDiurnasConMargen
                    },
                    nocturnas: {
                        inicio: minutosInicioNocturnasConMargen,
                        fin: minutosFinNocturnasConMargen
                    }
                };
                
                // Siempre usar vista extendida (no compacta)
                const estaCompacta = false;
                
                // Colapsar filas de horas para sección diurnas
                colapsarFilasHoras('vehiculosCronogramaDiurnas', minutosInicioDiurnasConMargen, minutosFinDiurnasConMargen, estaCompacta);
                
                // Colapsar filas de horas para sección nocturnas
                colapsarFilasHoras('vehiculosCronogramaNocturnas', minutosInicioNocturnasConMargen, minutosFinNocturnasConMargen, estaCompacta);
            };
            
            // Actualizar rangos en los títulos
            actualizarRangosEnTitulos();
            
            // Calcular y actualizar resumen de ventas por ruta
            const calcularResumenVentasPorRuta = () => {
                const ventasPorRuta = {};
                
                // Calcular ventas totales por ruta
                Object.keys(citasPorRuta).forEach(ruta => {
                    const citas = citasPorRuta[ruta];
                    const totalVentas = citas.reduce((sum, cita) => {
                        const monto = obtenerMonto(cita);
                        return sum + (monto || 0);
                    }, 0);
                    
                    // Solo contar rutas que tienen citas
                    if (citas.length > 0) {
                        ventasPorRuta[ruta] = totalVentas;
                    }
                });
            };
            
            // Inicializar drag and drop
            setTimeout(() => {
                inicializarDragAndDrop();
                inicializarDragAndDropRecursos(fechaFormateada);
                inicializarArrastreCrearCitas(fechaFormateada);
                inicializarArrastreLineaConvocatoria();
            }, 100);
        }
        
        function inicializarArrastreLineaConvocatoria() {
            const containers = document.querySelectorAll('.cronograma-container');
            if (!containers.length) return;
            let lineaEl = null;
            let timelineEl = null;
            let startY = 0;
            let startTop = 0;
            const TIMELINE_H = 960;
            const onMove = (e) => {
                if (!lineaEl || !timelineEl) return;
                const rect = timelineEl.getBoundingClientRect();
                const y = e.clientY - rect.top;
                const top = Math.max(0, Math.min(TIMELINE_H - 4, startTop + (y - startY)));
                lineaEl.style.top = top + 'px';
            };
            const onUp = async () => {
                if (!lineaEl || !timelineEl) return;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                lineaEl.classList.remove('dragging');
                const top = parseFloat(lineaEl.style.top) || 0;
                const ruta = lineaEl.getAttribute('data-ruta');
                const fecha = lineaEl.getAttribute('data-fecha');
                const nuevaHora = typeof topToHoraConvocatoria === 'function' ? topToHoraConvocatoria(top) : null;
                if (ruta && fecha && nuevaHora && window.actualizarHoraConvocatoriaSolo) {
                    await window.actualizarHoraConvocatoriaSolo(ruta, fecha, nuevaHora);
                }
                lineaEl = null;
                timelineEl = null;
            };
            const onMouseDown = (e) => {
                const line = e.target.closest('.linea-convocatoria');
                if (!line) return;
                e.preventDefault();
                e.stopPropagation();
                lineaEl = line;
                timelineEl = line.closest('.citas-timeline');
                if (!timelineEl) return;
                const rect = timelineEl.getBoundingClientRect();
                startY = e.clientY - rect.top;
                startTop = parseFloat(line.style.top) || 0;
                line.classList.add('dragging');
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            };
            containers.forEach(container => container.addEventListener('mousedown', onMouseDown));
        }

        // Convierte hora "HH:mm" a top en px (timeline: 5 AM = 0, 40px por hora)
        function horaConvocatoriaToTop(horaStr) {
            if (!horaStr || typeof horaStr !== 'string') return 0;
            const parts = horaStr.trim().split(':');
            const h = parseInt(parts[0], 10) || 0;
            const m = parseInt(parts[1], 10) || 0;
            const minutosDesde5AM = h >= 5 ? (h - 5) * 60 + m : (h + 19) * 60 + m;
            return Math.max(0, Math.min(958, (minutosDesde5AM / 60) * 40));
        }
        // Convierte top en px a hora "HH:mm" (día laborable: 5 AM = 0px, 40px/hora)
        function topToHoraConvocatoria(topPx) {
            const minutosDesde5AM = (topPx / 40) * 60;
            const totalMin = Math.max(0, Math.min(1439, Math.round(minutosDesde5AM / 15) * 15));
            if (totalMin >= 1140) {
                const minNext = totalMin - 1140;
                const h = Math.floor(minNext / 60);
                const m = minNext % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            }
            const h = Math.floor(totalMin / 60) + 5;
            const m = totalMin % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        // Función para generar timeline de citas
        function generarCitasTimeline(citas, ruta, horaConvocatoria, fechaFormateada) {
            // Usar versión síncrona para renderizado rápido
            const obtenerClienteNombre = function(cita) {
                if (!window.obtenerClienteNombreSync) {
                    console.error('❌ [generarCitasTimeline] obtenerClienteNombreSync no está disponible');
                    return window.obtenerCampoCita(cita, 'cliente_nombre', '') || 'Sin nombre';
                }
                
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('❌ [generarCitasTimeline] obtenerClienteNombreSync retornó una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado || 'Sin nombre';
            };
            
            // Generar marcadores de hora dentro del timeline (basados en el contenedor de citas)
            let timelineHTML = '';
            
            // Agregar líneas divisorias de hora en todas las columnas (grises delgadas)
            // Día laborable: 5 AM a 4:59 AM del día siguiente (24 horas desplazadas)
            for (let i = 0; i < 24; i++) {
                // Hora del día laborable: 5 AM + i horas
                const horaReal = (5 + i) % 24; // 5, 6, 7, ..., 23, 0, 1, 2, 3, 4
                const top = i * 40; // Posición desde el inicio del contenedor (40px por hora = 1cm)
                timelineHTML += `
                    <div class="linea-divisoria-hora" style="top: ${top}px;"></div>
                `;
            }
            
            // Agregar marcadores de hora con texto en la columna "Sin asignar"
            if (ruta === 'Sin asignar') {
                // Agregar marcadores de hora (24 horas, empezando desde 5 AM)
                for (let i = 0; i < 24; i++) {
                    const horaReal = (5 + i) % 24; // 5, 6, 7, ..., 23, 0, 1, 2, 3, 4
                    const top = i * 40; // Posición desde el inicio del contenedor (40px por hora = 1cm)
                    const horaFormateada = horaReal === 0 ? '12:00 AM' : 
                                         horaReal < 12 ? `${horaReal}:00 AM` : 
                                         horaReal === 12 ? '12:00 PM' : 
                                         `${horaReal - 12}:00 PM`;
                    timelineHTML += `
                        <div class="marcador-hora-timeline" style="top: ${top}px;">
                            <span class="marcador-hora-timeline-label">${horaFormateada}</span>
                        </div>
                    `;
                }
            }
            
            // Línea de hora de convocatoria (solo rutas asignadas, con hora definida o por defecto 6:00 para poder arrastrar)
            if (ruta !== 'Sin asignar') {
                const horaParaLinea = horaConvocatoria && String(horaConvocatoria).trim() !== '' ? String(horaConvocatoria).trim() : '06:00';
                const topConvocatoria = horaConvocatoriaToTop(horaParaLinea);
                const convocatoriaMinutosDesde5AM = (topConvocatoria / 40) * 60;
                // Minutos desde 5 AM de la primera cita del día (para "Xh Ymin hasta 1ª cita")
                let minutosPrimeraCitaDesde5AM = null;
                if (citas.length > 0) {
                    let minMin = Infinity;
                    for (const c of citas) {
                        const ts = obtenerInicio(c);
                        if (!ts) continue;
                        let h, m;
                        if (ts.toDate) {
                            const utc = ts.toDate();
                            h = utc.getUTCHours() - 6;
                            if (h < 0) h += 24; else if (h >= 24) h -= 24;
                            m = utc.getUTCMinutes();
                        } else {
                            const fd = window.formatearFecha(ts);
                            if (!fd) continue;
                            h = fd.getHours();
                            m = fd.getMinutes();
                        }
                        const minMed = h * 60 + m;
                        const min5 = h < 5 ? minMed + 19 * 60 : minMed - 5 * 60;
                        if (min5 < minMin) minMin = min5;
                    }
                    if (minMin !== Infinity) minutosPrimeraCitaDesde5AM = minMin;
                }
                let textoAntes = '—';
                if (minutosPrimeraCitaDesde5AM != null) {
                    const diff = minutosPrimeraCitaDesde5AM - convocatoriaMinutosDesde5AM;
                    if (diff > 0) {
                        const h = Math.floor(diff / 60);
                        const min = Math.round(diff % 60);
                        textoAntes = (h > 0 ? h + 'h ' : '') + (min > 0 ? min + 'min' : '').trim() || '0min';
                    } else {
                        textoAntes = 'Ya pasó';
                    }
                } else {
                    textoAntes = 'Sin citas';
                }
                const fechaEscapada = (fechaFormateada || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const rutaEscapada = (ruta || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const claseRuta = (ruta || '').replace(/\s+/g, '-');
                const sinCitas = citas.length === 0;
                const partesHora = horaParaLinea.split(':');
                const h = parseInt(partesHora[0], 10) || 0;
                const m = parseInt(partesHora[1], 10) || 0;
                const h12 = h === 0 ? 12 : (h > 12 ? h - 12 : h);
                const ampm = h < 12 ? 'AM' : 'PM';
                const horaDisplay = h12 + ':' + String(m).padStart(2, '0') + ' ' + ampm;
                const horaEsc = horaDisplay.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const antesEsc = textoAntes.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const claseSinCitas = sinCitas ? ' sin-citas' : '';
                timelineHTML += `<div class="linea-convocatoria ${claseRuta}${claseSinCitas}" data-ruta="${rutaEscapada}" data-fecha="${fechaEscapada}" style="top: ${topConvocatoria}px;" title="Hora de convocatoria. Arrastre para cambiar."><span class="linea-convocatoria-label"><span class="linea-convocatoria-caja">${horaEsc}</span><span class="linea-convocatoria-caja">${antesEsc}</span></span></div>`;
            }
            
            if (citas.length === 0) {
                return timelineHTML;
            }

            // Ordenar citas por hora
            citas.sort((a, b) => {
                const fechaA = window.formatearFecha(obtenerInicio(a));
                const fechaB = window.formatearFecha(obtenerInicio(b));
                if (!fechaA || !fechaB) return 0;
                return fechaA.getTime() - fechaB.getTime();
            });

            let ultimaHoraFin = 0; // 12:00 AM en minutos

            citas.forEach((cita, index) => {
                const fechaInicio = window.formatearFecha(obtenerInicio(cita));
                if (!fechaInicio) return;

                // Obtener hora y minuto correctamente del timestamp
                // El timestamp de Firestore almacena en UTC, pero representa la hora en GMT-6
                const timestamp = obtenerInicio(cita);
                let horaInicio, minutoInicio;
                
                if (timestamp && timestamp.toDate) {
                    // Es un Timestamp de Firestore
                    // El timestamp fue creado con Timestamp.fromDate(fechaInicio)
                    // donde fechaInicio es un Date que representa GMT-6
                    // Firestore almacena el timestamp en UTC
                    const fechaUTC = timestamp.toDate();
                    
                    // Obtener componentes UTC (el timestamp interno es UTC)
                    const utcHours = fechaUTC.getUTCHours();
                    const utcMinutes = fechaUTC.getUTCMinutes();
                    
                    // Cuando se guardó: fechaInicio (GMT-6) -> Timestamp (UTC)
                    // Al leer: Timestamp (UTC) -> fechaUTC (UTC)
                    // Para obtener GMT-6: UTC - 6 horas
                    let horaGMT6 = utcHours - 6;
                    if (horaGMT6 < 0) {
                        horaGMT6 += 24;
                    } else if (horaGMT6 >= 24) {
                        horaGMT6 -= 24;
                    }
                    
                    horaInicio = horaGMT6;
                    minutoInicio = utcMinutes;
                    
                } else {
                    // Es un Date normal, usar directamente
                    horaInicio = fechaInicio.getHours();
                    minutoInicio = fechaInicio.getMinutes();
                }
                
                const minutosInicioDesdeMedianoche = horaInicio * 60 + minutoInicio;
                
                // Convertir a minutos desde las 5 AM (día laborable)
                let minutosDesde5AM;
                if (horaInicio < 5) {
                    // Hora entre 0:00 y 4:59 AM -> pertenece al día siguiente (sumar 19 horas)
                    minutosDesde5AM = minutosInicioDesdeMedianoche + (19 * 60);
                } else {
                    // Hora entre 5:00 AM y 23:59 -> restar 5 horas
                    minutosDesde5AM = minutosInicioDesdeMedianoche - (5 * 60);
                }
                
                const duracion = obtenerDuracion(cita);
                const minutosFinDesde5AM = minutosDesde5AM + duracion;

                // Calcular posición y altura (40px por hora = 1cm)
                // 5:00 AM = 0px, cada hora = 40px
                // Las citas están dentro del contenedor .citas-timeline, que comienza después del header
                const top = (minutosDesde5AM / 60) * 40; // Posición desde las 5 AM
                const height = Math.max((duracion / 60) * 40, 20); // Mínimo 20px de altura

                // Ya no mostramos "Tiempo libre", solo las líneas divisorias de hora
                // Las líneas ya están agregadas al inicio de la función

                // Generar bloque de cita
                const horaFormateada = horaInicio === 0 ? '12' : 
                                     horaInicio < 12 ? horaInicio.toString() : 
                                     horaInicio === 12 ? '12' : 
                                     (horaInicio - 12).toString();
                const ampm = horaInicio < 12 ? 'AM' : 'PM';
                const minutoFormateado = minutoInicio.toString().padStart(2, '0');
                
                // Determinar emoji de turno
                const emojiTurno = obtenerTurnoEmoji(cita);
                
                const citaBloque = document.createElement('div');
                const montoCitaBloque = window.obtenerMonto ? window.obtenerMonto(cita) : undefined;
                const esMontoCeroBloque = (Number(montoCitaBloque) || 0) === 0;
                citaBloque.className = `cita-bloque ${ruta.replace(' ', '-')}${esMontoCeroBloque ? ' monto-cero' : ''}`;
                citaBloque.style.cssText = `top: ${top}px; height: ${height}px; cursor: move;`;
                citaBloque.setAttribute('data-cita-id', cita.id);
                citaBloque.setAttribute('draggable', 'true');
                citaBloque.setAttribute('data-ruta-origen', ruta);
                
                // Obtener nombre del cliente con validación
                let clienteNombre = obtenerClienteNombre(cita);
                
                // Log detallado para debugging
                console.log('🔍 [generarCitasTimeline] Renderizando cita en timeline', {
                    citaId: cita.id,
                    ruta: ruta,
                    telefono: window.obtenerTelefono(cita),
                    clienteNombre: clienteNombre,
                    tipoClienteNombre: typeof clienteNombre,
                    esPromise: clienteNombre && typeof clienteNombre.then === 'function',
                    metadata: cita.metadata ? Object.keys(cita.metadata) : []
                });
                
                // Asegurar que sea string
                if (clienteNombre && typeof clienteNombre.then === 'function') {
                    console.error('❌ [generarCitasTimeline] clienteNombre es una Promise!', cita.id);
                    clienteNombre = 'Sin nombre';
                }
                clienteNombre = clienteNombre || 'Sin nombre';
                
                // Usar versión síncrona del indicador GPS para evitar [object Promise]
                const indicadorGPS = window.obtenerIndicadorGPSSync ? window.obtenerIndicadorGPSSync(cita) : '';
                
                // Obtener estado de la encuesta
                const estadoEncuesta = obtenerEstadoEncuesta(cita);
                let indicadorEncuesta = '';
                let colorPuntoEncuesta = '';
                if (estadoEncuesta === 0) {
                    // Sin link generado - rojo
                    indicadorEncuesta = '<i class="fas fa-heart" style="color: #f44336; font-size: 14px; margin-left: 4px;" title="Encuesta no enviada"></i>';
                    colorPuntoEncuesta = 'rojo';
                } else if (estadoEncuesta === 1) {
                    // Link generado sin respuesta - amarillo
                    indicadorEncuesta = '<i class="fas fa-heart" style="color: #ffc107; font-size: 14px; margin-left: 4px;" title="Encuesta enviada, esperando respuesta"></i>';
                    colorPuntoEncuesta = 'amarillo';
                } else if (estadoEncuesta === 2) {
                    // Cliente respondió - verde
                    indicadorEncuesta = '<i class="fas fa-heart" style="color: #4caf50; font-size: 14px; margin-left: 4px;" title="Cliente respondió la encuesta"></i>';
                    colorPuntoEncuesta = 'verde';
                } else if (estadoEncuesta === 3) {
                    // No requiere encuesta - azul
                    const justificacion = obtenerJustificacion(cita);
                    const tituloJustificacion = justificacion ? `Justificada: ${justificacion.substring(0, 50)}${justificacion.length > 50 ? '...' : ''}` : 'No requiere encuesta';
                    indicadorEncuesta = `<i class="fas fa-heart" style="color: #2196f3; font-size: 14px; margin-left: 4px;" title="${tituloJustificacion}"></i>`;
                    colorPuntoEncuesta = 'azul';
                }
                
                // Obtener datos para mostrar en las citas (una sola forma de leer: obtenerCampoCita)
                // Obtener vendedor
                const vendedores = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                const vendedorMostrar = vendedores && vendedores.length > 0 ? vendedores[0] : '';
                const vendedorTexto = vendedorMostrar || 'Sin vendedor';
                
                // Obtener hora
                const horaMostrar = `${horaFormateada}:${minutoFormateado} ${ampm}`;
                
                // Obtener precio: si 0 o nulo, recuadro rojo "Precio 0"; si no, recuadro verde
                const montoValCron = window.obtenerMonto ? window.obtenerMonto(cita) : null;
                const esPrecioCeroCron = montoValCron == null || montoValCron === '' || Number(montoValCron) === 0;
                const precioMostrar = esPrecioCeroCron ? '' : (window.formatearMontoVenta ? window.formatearMontoVenta(montoValCron) : String(montoValCron));
                
                // Obtener ubicación (Provincia, Cantón, Distrito en ese orden)
                const ubicacionPartes = [];
                const provinciaId = window.obtenerCampoCita(cita, 'provinciaId', null);
                const cantonId = window.obtenerCampoCita(cita, 'cantonId', null);
                const distritoId = window.obtenerCampoCita(cita, 'distritoId', null);
                
                // Convertir IDs a nombres usando ubicacionesCR - Orden: Provincia, Cantón, Distrito
                if (window.ubicacionesCR && provinciaId && window.ubicacionesCR[provinciaId]) {
                    ubicacionPartes.push(window.ubicacionesCR[provinciaId].nombre || '');
                    
                    if (cantonId && window.ubicacionesCR[provinciaId].cantones && window.ubicacionesCR[provinciaId].cantones[cantonId]) {
                        ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].nombre || '');
                        
                        if (distritoId && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos && window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId]) {
                            ubicacionPartes.push(window.ubicacionesCR[provinciaId].cantones[cantonId].distritos[distritoId].nombre || '');
                        }
                    }
                }
                const ubicacionTexto = ubicacionPartes.length > 0 ? ubicacionPartes.join(', ') : '';
                
                // Construir línea principal: Vendedor (badge) + Hora (gris) + Precio (verde o rojo "Precio 0")
                const infoPrincipal = [];
                infoPrincipal.push(window.vendedorBadgeHtml ? window.vendedorBadgeHtml(cita) : vendedorTexto);
                if (horaMostrar) infoPrincipal.push('<span class="cita-hora-texto">' + String(horaMostrar).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');
                if (esPrecioCeroCron) infoPrincipal.push('<span class="cita-monto-cero">Precio 0</span>');
                else if (precioMostrar) infoPrincipal.push('<span class="cita-monto-texto">' + String(precioMostrar).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');
                const textoPrincipal = infoPrincipal.join('');
                
                // Línea 2: cliente en recuadro | Línea 3: Provincia, Cantón, Distrito o "Dirección pendiente" en rojo
                const clienteEscapado = (clienteNombre && clienteNombre !== 'Sin nombre') ? String(clienteNombre).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                const ubicacionEscapada = ubicacionTexto ? String(ubicacionTexto).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                const lineaUbicacion = ubicacionEscapada
                    ? `<div class="cita-linea-recursos"><span class="cita-ubicacion-texto">${ubicacionEscapada}</span></div>`
                    : `<div class="cita-linea-recursos"><span class="cita-ubicacion-pendiente">Dirección pendiente</span></div>`;
                
                const metodoPagoCron = (window.obtenerCampoCita(cita, 'metodoPago', '') || '').trim();
                const pagoIndicadoCron = metodoPagoCron !== '' && metodoPagoCron.toLowerCase() !== 'seleccionar método de pago';
                const ventanasCron = window.indicadoresVentanasCita ? window.indicadoresVentanasCita(cita) : { dentroVentanaConfirmacion: true, citaYaPasada: true };
                const confirmada24_48Cron = window.obtenerConfirmada24_48 ? window.obtenerConfirmada24_48(cita) : { confirmada: false };
                const confirmadaCitaCron = !!confirmada24_48Cron.confirmada;
                const claseConfirmadaCron = !ventanasCron.dentroVentanaConfirmacion ? 'gris' : (confirmadaCitaCron ? 'confirmada' : 'no-confirmada');
                const tituloConfirmadaCron = !ventanasCron.dentroVentanaConfirmacion ? 'Fuera de ventana de confirmación' : (confirmadaCitaCron ? 'Cita confirmada' : 'Cita no confirmada');
                const colorPuntoEncuestaCron = !ventanasCron.citaYaPasada ? 'gris' : (colorPuntoEncuesta || 'gris');
                const tituloEncuestaCron = !ventanasCron.citaYaPasada ? 'Encuesta después del servicio' : (estadoEncuesta === 0 ? 'Encuesta no enviada' : estadoEncuesta === 1 ? 'Encuesta enviada, esperando respuesta' : estadoEncuesta === 3 ? 'No requiere encuesta' : 'Cliente respondió la encuesta');
                const clasePagoCron = !ventanasCron.citaYaPasada ? 'pago-gris' : (pagoIndicadoCron ? 'pago-indicado' : 'pago-pendiente');
                const tituloPagoCron = !ventanasCron.citaYaPasada ? 'Arqueo después del servicio' : (pagoIndicadoCron ? 'Método de pago indicado' : 'Seleccionar método de pago');
                
                citaBloque.innerHTML = `
                    <div class="cita-indicadores-derecha">
                        <div class="indicador-confirmada-punto ${claseConfirmadaCron}" title="${tituloConfirmadaCron}"><i class="fas fa-check indicador-icono"></i></div>
                        <div class="indicador-encuesta-punto ${colorPuntoEncuestaCron}" title="${tituloEncuestaCron}"><i class="fas fa-heart indicador-icono"></i></div>
                        <div class="indicador-pago-punto ${clasePagoCron}" title="${tituloPagoCron}"><i class="fas fa-dollar-sign indicador-icono"></i></div>
                    </div>
                    <div class="cita-estado-cronograma ${(window.estadoDisplayCita && window.estadoDisplayCita(cita)) ? window.estadoDisplayCita(cita).clase : 'agendada'}"></div>
                    <div class="cita-tres-lineas">
                        <div class="cita-hora-cronograma cita-linea-badges">${textoPrincipal}</div>
                        ${clienteEscapado ? `<div class="cita-linea-recursos"><span class="cita-cliente-texto">${clienteEscapado}</span></div>` : ''}
                        ${lineaUbicacion}
                    </div>
                `;
                
                timelineHTML += citaBloque.outerHTML;

                ultimaHoraFin = Math.max(ultimaHoraFin, minutosFinDesde5AM);
            });

            // Ya no mostramos "Tiempo libre" al final, solo las líneas divisorias de hora
            // Las líneas ya están agregadas al inicio de la función

            return timelineHTML;
        }


        // Función para generar el calendario
        function generarCalendario() {
            // Usar versión síncrona para renderizado rápido
            const obtenerClienteNombre = function(cita) {
                if (!window.obtenerClienteNombreSync) {
                    console.error('❌ [generarCalendario] obtenerClienteNombreSync no está disponible');
                    return window.obtenerCampoCita(cita, 'cliente_nombre', '') || 'Sin nombre';
                }
                
                const resultado = window.obtenerClienteNombreSync(cita);
                
                // Verificar que no sea una Promise
                if (resultado && typeof resultado.then === 'function') {
                    console.error('❌ [generarCalendario] obtenerClienteNombreSync retornó una Promise!', {
                        citaId: cita.id,
                        resultado: resultado
                    });
                    return 'Sin nombre';
                }
                
                return resultado || 'Sin nombre';
            };
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Actualizar título del mes
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            // currentMonth.textContent = `${monthNames[month]} ${year}`; // Elemento eliminado

            // Obtener primer día del mes y cuántos días tiene
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Limpiar calendario
            calendarGrid.innerHTML = '';

            // Agregar encabezados de días
            diasSemana.forEach(dia => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = dia;
                calendarGrid.appendChild(dayHeader);
            });

            // Agregar días del mes anterior
            const prevMonth = new Date(year, month - 1, 0);
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${prevMonth.getDate() - i}</div>`;
                calendarGrid.appendChild(dayElement);
            }

            // Agregar días del mes actual
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dayDate = new Date(year, month, day);
                const isToday = dayDate.toDateString() === new Date().toDateString();
                
                dayElement.className = `calendar-day ${isToday ? 'today' : ''}`;
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                dayElement.setAttribute('data-day', day);
                dayElement.setAttribute('data-month', month);
                dayElement.setAttribute('data-year', year);
                dayElement.style.position = 'relative';
                dayElement.style.cursor = 'crosshair';
                
                // Agregar citas del día
                const citasDelDia = citasFiltradas.filter(cita => {
                    const fechaCita = window.formatearFecha(obtenerInicio(cita));
                    if (!fechaCita) return false;
                    return fechaCita.getDate() === day && 
                           fechaCita.getMonth() === month && 
                           fechaCita.getFullYear() === year;
                });

                citasDelDia.forEach(cita => {
                    const citaElement = document.createElement('div');
                    const ruta = obtenerRuta(cita);
                    const montoCitaVal = window.obtenerMonto ? window.obtenerMonto(cita) : undefined;
                    const esMontoCero = (Number(montoCitaVal) || 0) === 0;
                    citaElement.className = `cita-item ${ruta?.replace(' ', '-')}${esMontoCero ? ' monto-cero' : ''}`;
                    citaElement.setAttribute('data-cita-id', cita.id);
                    citaElement.style.cursor = 'pointer';
                    citaElement.style.position = 'relative';
                    citaElement.style.zIndex = '10'; // Citas por encima pero permiten eventos en áreas vacías
                    
                    // Determinar emoji de turno
                    const emojiTurno = obtenerTurnoEmoji(cita);
                    
                    // Crear contenido con indicador GPS en esquina superior derecha (usar versión síncrona)
                    const indicadorGPS = window.obtenerIndicadorGPSSync ? window.obtenerIndicadorGPSSync(cita) : '';
                    const vehiculo = obtenerRuta(cita);
                    // Usar la versión síncrona definida al inicio de la función
                    let clienteNombre = obtenerClienteNombre(cita);
                    
                    // Log detallado para debugging
                    console.log('🔍 [generarCalendario] Renderizando cita', {
                        citaId: cita.id,
                        telefono: window.obtenerTelefono(cita),
                        clienteNombre: clienteNombre,
                        tipoClienteNombre: typeof clienteNombre,
                        esPromise: clienteNombre && typeof clienteNombre.then === 'function',
                        metadata: cita.metadata ? Object.keys(cita.metadata) : []
                    });
                    
                    // Asegurar que sea string
                    if (clienteNombre && typeof clienteNombre.then === 'function') {
                        console.error('❌ [generarCalendario] clienteNombre es una Promise!', cita.id);
                        clienteNombre = 'Sin nombre';
                    }
                    clienteNombre = clienteNombre || 'Sin nombre';
                    
                    // Obtener estado de la encuesta
                    const estadoEncuesta = obtenerEstadoEncuesta(cita);
                    let indicadorEncuesta = '';
                    let colorPuntoEncuesta = '';
                    if (estadoEncuesta === 0) {
                        // Sin link generado - rojo
                        indicadorEncuesta = '<i class="fas fa-heart" style="color: #f44336; font-size: 12px; margin-left: 4px;" title="Encuesta no enviada"></i>';
                        colorPuntoEncuesta = 'rojo';
                    } else if (estadoEncuesta === 1) {
                        // Link generado sin respuesta - amarillo
                        indicadorEncuesta = '<i class="fas fa-heart" style="color: #ffc107; font-size: 12px; margin-left: 4px;" title="Encuesta enviada, esperando respuesta"></i>';
                        colorPuntoEncuesta = 'amarillo';
                    } else if (estadoEncuesta === 2) {
                        // Cliente respondió - verde
                        indicadorEncuesta = '<i class="fas fa-heart" style="color: #4caf50; font-size: 12px; margin-left: 4px;" title="Cliente respondió la encuesta"></i>';
                        colorPuntoEncuesta = 'verde';
                    } else if (estadoEncuesta === 3) {
                        // No requiere encuesta - azul
                        const justificacion = obtenerJustificacion(cita);
                        const tituloJustificacion = justificacion ? `Justificada: ${justificacion.substring(0, 50)}${justificacion.length > 50 ? '...' : ''}` : 'No requiere encuesta';
                        indicadorEncuesta = `<i class="fas fa-heart" style="color: #2196f3; font-size: 12px; margin-left: 4px;" title="${tituloJustificacion}"></i>`;
                        colorPuntoEncuesta = 'azul';
                    }
                    
                    // Obtener datos para mostrar en las citas (una sola forma de leer: obtenerCampoCita)
                    // Obtener vendedor
                    const vendedoresVista = window.obtenerVendedores ? window.obtenerVendedores(cita) : [];
                    const vendedorMostrarVista = vendedoresVista && vendedoresVista.length > 0 ? vendedoresVista[0] : '';
                    const vendedorTexto = vendedorMostrarVista || 'Sin vendedor';
                    
                    // Obtener hora
                    const fechaInicioVista = window.formatearFecha ? window.formatearFecha(window.obtenerInicio(cita)) : null;
                    const horaMostrarVista = fechaInicioVista ? fechaInicioVista.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' }) : '';
                    
                    // Obtener ganancia neta (en lugar del monto de venta)
                    const gananciaNeta = window.obtenerGananciaNeta ? window.obtenerGananciaNeta(cita) : 0;
                    console.log('🔍 [CALENDARIO] Ganancia neta calculada:', gananciaNeta, 'para cita:', cita.id);
                    // Mostrar la ganancia neta: si 0 o no válido, recuadro rojo "Precio 0"; si no, recuadro verde
                    const esPrecioCeroVista = gananciaNeta == null || gananciaNeta === undefined || isNaN(gananciaNeta) || Number(gananciaNeta) === 0;
                    let precioMostrarVista = '';
                    if (!esPrecioCeroVista) {
                        const numeroFormateado = Math.abs(gananciaNeta).toLocaleString('es-CR');
                        precioMostrarVista = `₡${numeroFormateado}`;
                        console.log('🔍 [CALENDARIO] Precio formateado:', precioMostrarVista);
                    } else {
                        console.log('🔍 [CALENDARIO] Ganancia neta 0 o no válida (valor:', gananciaNeta, ')');
                    }
                    
                    // Obtener ubicación (Provincia, Cantón, Distrito en ese orden)
                    const ubicacionPartesVista = [];
                    const provinciaIdVista = window.obtenerCampoCita(cita, 'provinciaId', null);
                    const cantonIdVista = window.obtenerCampoCita(cita, 'cantonId', null);
                    const distritoIdVista = window.obtenerCampoCita(cita, 'distritoId', null);
                    
                    // Convertir IDs a nombres usando ubicacionesCR - Orden: Provincia, Cantón, Distrito
                    if (window.ubicacionesCR && provinciaIdVista && window.ubicacionesCR[provinciaIdVista]) {
                        ubicacionPartesVista.push(window.ubicacionesCR[provinciaIdVista].nombre || '');
                        
                        if (cantonIdVista && window.ubicacionesCR[provinciaIdVista].cantones && window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista]) {
                            ubicacionPartesVista.push(window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].nombre || '');
                            
                            if (distritoIdVista && window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].distritos && window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].distritos[distritoIdVista]) {
                                ubicacionPartesVista.push(window.ubicacionesCR[provinciaIdVista].cantones[cantonIdVista].distritos[distritoIdVista].nombre || '');
                            }
                        }
                    }
                    const ubicacionTextoVista = ubicacionPartesVista.length > 0 ? ubicacionPartesVista.join(', ') : '';
                    
                    // Construir línea principal: Vendedor (badge) + Hora (gris) + Precio (verde o rojo "Precio 0")
                    const infoPrincipal = [];
                    infoPrincipal.push(window.vendedorBadgeHtml ? window.vendedorBadgeHtml(cita) : vendedorTexto);
                    if (horaMostrarVista) infoPrincipal.push('<span class="cita-hora-texto">' + String(horaMostrarVista).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');
                    if (esPrecioCeroVista) infoPrincipal.push('<span class="cita-monto-cero">Precio 0</span>');
                    else if (precioMostrarVista) infoPrincipal.push('<span class="cita-monto-texto">' + String(precioMostrarVista).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');
                    const textoPrincipal = infoPrincipal.join('');
                    
                    // Línea 2: cliente en recuadro | Línea 3: Provincia, Cantón, Distrito o "Dirección pendiente" en rojo
                    const clienteEscapadoVista = (clienteNombre && clienteNombre !== 'Sin nombre') ? String(clienteNombre).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                    const ubicacionEscapadaVista = ubicacionTextoVista ? String(ubicacionTextoVista).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                    const lineaUbicacionVista = ubicacionEscapadaVista
                        ? `<div class="cita-linea-recursos"><span class="cita-ubicacion-texto">${ubicacionEscapadaVista}</span></div>`
                        : `<div class="cita-linea-recursos"><span class="cita-ubicacion-pendiente">Dirección pendiente</span></div>`;
                    
                    const metodoPagoVista = (window.obtenerCampoCita(cita, 'metodoPago', '') || '').trim();
                    const pagoIndicadoVista = metodoPagoVista !== '' && metodoPagoVista.toLowerCase() !== 'seleccionar método de pago';
                    const ventanasVista = window.indicadoresVentanasCita ? window.indicadoresVentanasCita(cita) : { dentroVentanaConfirmacion: true, citaYaPasada: true };
                    const confirmada24_48Vista = window.obtenerConfirmada24_48 ? window.obtenerConfirmada24_48(cita) : { confirmada: false };
                    const confirmadaCitaVista = !!confirmada24_48Vista.confirmada;
                    const claseConfirmadaVista = !ventanasVista.dentroVentanaConfirmacion ? 'gris' : (confirmadaCitaVista ? 'confirmada' : 'no-confirmada');
                    const tituloConfirmadaVista = !ventanasVista.dentroVentanaConfirmacion ? 'Fuera de ventana de confirmación' : (confirmadaCitaVista ? 'Cita confirmada' : 'Cita no confirmada');
                    const colorPuntoEncuestaVista = !ventanasVista.citaYaPasada ? 'gris' : (colorPuntoEncuesta || 'gris');
                    const tituloEncuestaVista = !ventanasVista.citaYaPasada ? 'Encuesta después del servicio' : (estadoEncuesta === 0 ? 'Encuesta no enviada' : estadoEncuesta === 1 ? 'Encuesta enviada, esperando respuesta' : estadoEncuesta === 3 ? 'No requiere encuesta' : 'Cliente respondió la encuesta');
                    const clasePagoVista = !ventanasVista.citaYaPasada ? 'pago-gris' : (pagoIndicadoVista ? 'pago-indicado' : 'pago-pendiente');
                    const tituloPagoVista = !ventanasVista.citaYaPasada ? 'Arqueo después del servicio' : (pagoIndicadoVista ? 'Método de pago indicado' : 'Seleccionar método de pago');
                    
                    citaElement.innerHTML = `
                        <div class="cita-indicadores-derecha">
                            <div class="indicador-confirmada-punto ${claseConfirmadaVista}" title="${tituloConfirmadaVista}"><i class="fas fa-check indicador-icono"></i></div>
                            <div class="indicador-encuesta-punto ${colorPuntoEncuestaVista}" title="${tituloEncuestaVista}"><i class="fas fa-heart indicador-icono"></i></div>
                            <div class="indicador-pago-punto ${clasePagoVista}" title="${tituloPagoVista}"><i class="fas fa-dollar-sign indicador-icono"></i></div>
                        </div>
                        <div class="cita-tres-lineas">
                            <div class="cita-linea-principal cita-linea-badges">${textoPrincipal}</div>
                            ${clienteEscapadoVista ? `<div class="cita-linea-recursos"><span class="cita-cliente-texto">${clienteEscapadoVista}</span></div>` : ''}
                            ${lineaUbicacionVista}
                        </div>
                    `;
                    // GPS ahora se obtiene desde la sucursal, no desde la cita
                    const tieneSucursal = window.esSucursalIndiceValido(window.obtenerCampoCita(cita, 'sucursalIndice', null));
                    const tituloVendedor = (window.obtenerNombreDisplayVendedor && window.obtenerNombreDisplayVendedor(vendedorMostrarVista)) || vendedorMostrarVista || 'Sin vendedor';
                    citaElement.title = `Vendedor: ${tituloVendedor}\n${vehiculo}\n${obtenerDescripcion(cita)}\nTurno: ${obtenerTurno(cita)}\nSucursal: ${tieneSucursal ? 'Sí' : 'No'}`;
                    
                    // Agregar click handler para abrir edición
                    citaElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (window.abrirModalEdicion) {
                            window.abrirModalEdicion(cita.id);
                        }
                    });
                    
                    dayElement.appendChild(citaElement);
                });
                
                // Agregar funcionalidad de arrastre para crear citas
                let isDragging = false;
                let dragStartY = 0;
                let dragEndY = 0;
                let dragPreview = null;
                
                // Handlers globales para mousemove y mouseup
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    
                    // Calcular posición relativa al dayElement
                    const rect = dayElement.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    dragEndY = Math.max(0, Math.min(y, dayElement.offsetHeight));
                    
                    actualizarDragPreview();
                    
                    e.preventDefault();
                };
                
                const handleMouseUp = (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    // Remover listeners globales primero
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    
                    // Calcular duración basada en el rango arrastrado
                    const alturaCelda = dayElement.offsetHeight;
                    const alturaMinima = 20; // Mínimo 20px para considerar un arrastre válido
                    const alturaArrastrada = Math.abs(dragEndY - dragStartY);
                    
                    console.log('🖱️ Finalizando arrastre', {
                        alturaCelda,
                        alturaArrastrada,
                        dragStartY,
                        dragEndY
                    });
                    
                    if (alturaArrastrada < alturaMinima) {
                        // Si el arrastre es muy pequeño, no crear cita
                        if (dragPreview) {
                            dragPreview.remove();
                            dragPreview = null;
                        }
                        return;
                    }
                    
                    // Calcular hora de inicio y duración
                    // Asumimos que la celda representa todo el día (24 horas)
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    
                    // Convertir posición Y a hora del día (0-24)
                    const horaInicio = (inicioY / alturaCelda) * 24;
                    const horaFin = (finY / alturaCelda) * 24;
                    const duracionHoras = horaFin - horaInicio;
                    const duracionMinutos = Math.max(15, Math.round(duracionHoras * 60));
                    const duracionRedondeada = Math.max(15, Math.round(duracionMinutos / 15) * 15);
                    
                    // Calcular hora y minuto de inicio
                    const horasInicio = Math.floor(horaInicio);
                    const minutosInicio = Math.round((horaInicio - horasInicio) * 60);
                    const minutosRedondeados = Math.round(minutosInicio / 15) * 15;
                    
                    // Crear fecha con la hora calculada (en hora local)
                    const fechaInicio = new Date(year, month, day, horasInicio, minutosRedondeados, 0, 0);
                    
                    // Formatear para datetime-local en hora local (no UTC)
                    const yearFormatted = fechaInicio.getFullYear();
                    const monthFormatted = String(fechaInicio.getMonth() + 1).padStart(2, '0');
                    const dayFormatted = String(fechaInicio.getDate()).padStart(2, '0');
                    const hoursFormatted = String(fechaInicio.getHours()).padStart(2, '0');
                    const minutesFormatted = String(fechaInicio.getMinutes()).padStart(2, '0');
                    const fechaFormateada = `${yearFormatted}-${monthFormatted}-${dayFormatted}T${hoursFormatted}:${minutesFormatted}`;
                    
                    console.log('✅ Abriendo modal con:', {
                        fechaFormateada,
                        duracionRedondeada,
                        horaInicio: `${horasInicio}:${minutosRedondeados.toString().padStart(2, '0')}`
                    });
                    
                    // Limpiar preview
                    if (dragPreview) {
                        dragPreview.remove();
                        dragPreview = null;
                    }
                    
                    // Abrir modal de nueva cita con datos prellenados
                    abrirModalNuevaCitaDesdeArrastre(fechaFormateada, duracionRedondeada, day, month, year);
                    
                    e.preventDefault();
                };
                
                // Usar captura de eventos para asegurar que se capture antes que otros elementos
                dayElement.addEventListener('mousedown', (e) => {
                    // Solo iniciar arrastre si no se hace click en una cita existente o en el número del día
                    const target = e.target;
                    console.log('🖱️ [DEBUG] mousedown detectado', {
                        target: target.tagName,
                        className: target.className,
                        isCitaItem: !!target.closest('.cita-item'),
                        isDayNumber: target.classList.contains('day-number'),
                        day: day
                    });
                    
                    if (target.closest('.cita-item') || target.classList.contains('day-number')) {
                        console.log('🖱️ [DEBUG] Click en cita o número, ignorando arrastre');
                        return;
                    }
                    
                    console.log('🖱️ Iniciando arrastre en día', day, 'offsetY:', e.offsetY);
                    
                    isDragging = true;
                    dragStartY = e.offsetY;
                    dragEndY = e.offsetY;
                    
                    // Crear preview visual del rango
                    dragPreview = document.createElement('div');
                    dragPreview.className = 'drag-preview';
                    dragPreview.style.position = 'absolute';
                    dragPreview.style.left = '0';
                    dragPreview.style.right = '0';
                    dragPreview.style.backgroundColor = 'rgba(102, 126, 234, 0.3)';
                    dragPreview.style.border = '2px dashed #667eea';
                    dragPreview.style.borderRadius = '4px';
                    dragPreview.style.pointerEvents = 'none';
                    dragPreview.style.zIndex = '1000';
                    dayElement.appendChild(dragPreview);
                    
                    actualizarDragPreview();
                    
                    // Agregar listeners globales para que funcionen incluso fuera del elemento
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    
                    e.stopPropagation();
                    e.preventDefault();
                }, true); // Usar captura
                
                function actualizarDragPreview() {
                    if (!dragPreview) return;
                    
                    const inicioY = Math.min(dragStartY, dragEndY);
                    const finY = Math.max(dragStartY, dragEndY);
                    const altura = finY - inicioY;
                    
                    dragPreview.style.top = `${inicioY}px`;
                    dragPreview.style.height = `${Math.max(altura, 20)}px`;
                }

                calendarGrid.appendChild(dayElement);
            }

            // Agregar días del mes siguiente para completar la grilla
            const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                calendarGrid.appendChild(dayElement);
            }
        }

        // Función para determinar el turno basado en la hora
        function determinarTurno(horaInicio) {
            if (!horaInicio) return 'Turno 1';
            
            const match = horaInicio.match(/(\d{1,2}):(\d{2})/);
            if (!match) return 'Turno 1';
            
            const hora = parseInt(match[1]);
            const minuto = parseInt(match[2]);
            const horaDecimal = hora + (minuto / 60);
            
            return horaDecimal < 17 ? 'Turno 1' : 'Turno 2';
        }

        // Función para obtener el emoji del turno
        function obtenerEmojiTurno(turno) {
            return turno === 'Turno 1' ? '☀️' : '🌙';
        }

        /**
         * Construye entradas de historial de edición comparando cita anterior con datos nuevos.
         * @param {Object} citaAnterior - Cita antes de editar (selectedCita)
         * @param {Object} datosNuevos - Objeto con telefono, inicio_gmt6, duracion_minutos, metadata
         * @returns {Array<{usuario, timestamp, campo, valorAnterior, valorNuevo}>}
         */
        function buildHistorialEdicion(citaAnterior, datosNuevos) {
            const usuario = (window.firebaseAuth && window.firebaseAuth.currentUser)
                ? (window.firebaseAuth.currentUser.email || window.firebaseAuth.currentUser.uid || 'Anónimo')
                : 'Anónimo';
            const timestamp = new Date().toLocaleString('es-CR', { dateStyle: 'short', timeStyle: 'medium' });
            const entradas = [];

            // JSON con claves ordenadas para que {a:1,b:2} y {b:2,a:1} se consideren iguales
            function jsonOrdenado(v) {
                if (v == null) return null;
                if (Array.isArray(v)) return v.map(jsonOrdenado);
                if (typeof v === 'object' && v && typeof v.toMillis === 'function') return v.toMillis();
                if (typeof v === 'object' && v && v.constructor === Object) {
                    const o = {};
                    Object.keys(v).sort().forEach(k => { o[k] = jsonOrdenado(v[k]); });
                    return o;
                }
                return v;
            }
            function valorParaComparar(v) {
                if (v == null) return '';
                if (typeof v === 'object' && v && typeof v.toMillis === 'function') return v.toMillis();
                if (typeof v === 'object') return JSON.stringify(jsonOrdenado(v));
                return String(v);
            }
            function valorParaMostrar(v, maxLen) {
                if (v == null) return '';
                const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
                return maxLen && s.length > maxLen ? s.substring(0, maxLen) + '…' : s;
            }

            // Campos de nivel raíz
            if (datosNuevos.telefono !== undefined && valorParaComparar(citaAnterior.telefono) !== valorParaComparar(datosNuevos.telefono)) {
                entradas.push({ usuario, timestamp, campo: 'telefono', valorAnterior: valorParaMostrar(citaAnterior.telefono, 80), valorNuevo: valorParaMostrar(datosNuevos.telefono, 80) });
            }
            if (datosNuevos.inicio_gmt6 !== undefined) {
                const ant = citaAnterior.inicio_gmt6 ? (citaAnterior.inicio_gmt6.toMillis ? citaAnterior.inicio_gmt6.toMillis() : citaAnterior.inicio_gmt6) : '';
                const nuevo = datosNuevos.inicio_gmt6 && datosNuevos.inicio_gmt6.toMillis ? datosNuevos.inicio_gmt6.toMillis() : datosNuevos.inicio_gmt6;
                if (String(ant) !== String(nuevo)) {
                    entradas.push({ usuario, timestamp, campo: 'inicio_gmt6', valorAnterior: valorParaMostrar(citaAnterior.inicio_gmt6, 80), valorNuevo: valorParaMostrar(datosNuevos.inicio_gmt6, 80) });
                }
            }
            if (datosNuevos.duracion_minutos !== undefined && valorParaComparar(citaAnterior.duracion_minutos) !== valorParaComparar(datosNuevos.duracion_minutos)) {
                entradas.push({ usuario, timestamp, campo: 'duracion_minutos', valorAnterior: valorParaMostrar(citaAnterior.duracion_minutos, 80), valorNuevo: valorParaMostrar(datosNuevos.duracion_minutos, 80) });
            }

            const metaAnt = citaAnterior.metadata || {};
            const metaNuevo = datosNuevos.metadata || {};
            const keysMeta = new Set([...Object.keys(metaAnt), ...Object.keys(metaNuevo)]);
            keysMeta.forEach(campo => {
                if (campo === 'historial') return;
                const va = metaAnt[campo];
                const vn = metaNuevo[campo];
                if (valorParaComparar(va) === valorParaComparar(vn)) return;
                entradas.push({
                    usuario,
                    timestamp,
                    campo: 'metadata.' + campo,
                    valorAnterior: valorParaMostrar(va, 80),
                    valorNuevo: valorParaMostrar(vn, 80)
                });
            });

            return entradas;
        }

        // Función para guardar cita editada
        async function guardarCita() {
            if (!selectedCita) return;

            // Definir originalText fuera del try para que esté disponible en finally
            const btnSave = document.getElementById('btnSaveCitaTop');
            const originalText = '<i class="fas fa-save me-1"></i>Guardar';

            try {
                // Validar solo campos indispensables
                const clientPhone = document.getElementById('editClientPhone').value.trim();
                const startTime = document.getElementById('editStartTime').value;
                const duration = document.getElementById('editDuration').value;
                const ruta = document.getElementById('editRuta').value;
                const vendedoresSeleccionados = window.vendedoresSeleccionadosEdit || [];

                if (!clientPhone || !startTime || !duration || !ruta) {
                    alert('Por favor completa todos los campos indispensables: Teléfono, Fecha y Hora de Inicio, Duración y Ruta.');
                    return;
                }

                if (!vendedoresSeleccionados.length) {
                    alert('Debe seleccionar al menos un vendedor para guardar la cita.');
                    return;
                }
                
                // Validar comentarios de servicios (ahora opcionales, siempre pasa)
                if (!window.validarComentariosServicios('edit')) {
                    return;
                }
                
                // Validar que todas las plagas tengan comentarios (obligatorio, excepto excepciones)
                if (!window.validarComentariosPlagas('edit')) {
                    return;
                }
                
                // Campos opcionales
                const clientName = document.getElementById('editClientName').value.trim();
                const montoVentaInput = document.getElementById('editMontoVenta');
                const valorNumerico = montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0';
                const montoVenta = valorNumerico || '0';

                const fechaInicio = new Date(startTime);
                console.log('🔍 Hora ingresada por usuario:', startTime);
                console.log('🔍 Fecha convertida a objeto Date:', fechaInicio);
                console.log('🔍 Fecha en UTC (lo que se guardará):', fechaInicio.toISOString());
                
                // Turno eliminado - usar valor por defecto
                const turnoSeleccionado = 'Turno 1';
                const emojiTurno = '☀️';
                
                // Calcular hora de fin
                const duracion = parseInt(document.getElementById('editDuration').value);
                const fechaFin = new Date(fechaInicio.getTime() + (duracion * 60000));
                
                // Mostrar indicador de carga (footer y header)
                btnSave.disabled = true;
                btnSave.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                const btnSaveCitaTop = document.getElementById('btnSaveCitaTop');
                if (btnSaveCitaTop) {
                    btnSaveCitaTop.disabled = true;
                    btnSaveCitaTop.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }

                // Convertir fecha a Timestamp GMT-06
                const timestampGMT6 = Timestamp.fromDate(fechaInicio);
                
                // Normalizar teléfono usando función helper
                const telefonoNormalizado = window.normalizarTelefono(clientPhone);
                if (!telefonoNormalizado) {
                    alert('Por favor ingrese un teléfono válido de 8 dígitos');
                    return;
                }
                
                // Generar link de WhatsApp
                const editWhatsApp = document.getElementById('editWhatsApp');
                if (editWhatsApp) {
                    editWhatsApp.value = window.generarLinkWhatsApp(telefonoNormalizado, 'Hola desde Ecoplagas');
                }
                
                // Obtener o crear cliente
                let cliente = await window.buscarCliente(telefonoNormalizado);
                if (!cliente) {
                    cliente = await window.crearCliente(telefonoNormalizado, clientName);
                } else {
                    // Actualizar nombre del cliente si fue modificado
                    if (clientName && clientName.trim()) {
                        await window.actualizarNombreCliente(telefonoNormalizado, clientName.trim());
                        // Actualizar también en el objeto cliente local
                        cliente.nombre = clientName.trim();
                    }
                }
                
                // Obtener nombre del cliente para guardarlo en metadata (fallback para renderizado rápido)
                const nombreClienteParaMetadata = cliente?.nombre || clientName || '';
                
                // Obtener sucursal seleccionada o crear nueva
                const sucursalSelect = document.getElementById('editSucursal');
                const sucursalSeleccionada = sucursalSelect?.value;
                let sucursalIndice = null;

                // Valores de ubicación (necesarios para actualizar sucursal existente y para metadata de la cita)
                let provinciaId = document.getElementById('editProvincia')?.value || '';
                let cantonId = document.getElementById('editCanton')?.value || '';
                let distritoId = document.getElementById('editDistrito')?.value || '';
                
                if (sucursalSeleccionada === 'nueva' || !sucursalSeleccionada) {
                    // Crear nueva sucursal
                    const nombreSucursal = document.getElementById('editNombreSucursal')?.value.trim() || 'Hogar principal';
                    const coordsTexto = document.getElementById('editCoordenadas')?.value.trim();
                    
                    // Intentar parsear coordenadas (opcional)
                    let coordsParsed = null;
                    if (coordsTexto) {
                        if (window.limpiarYExtraerCoordenadas) {
                            coordsParsed = window.limpiarYExtraerCoordenadas(coordsTexto);
                        }
                        // Si no funciona, intentar parseo directo
                        if (!coordsParsed) {
                            const match = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                            if (match) {
                                coordsParsed = {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                };
                            }
                        }
                        
                        // Validar que las coordenadas sean válidas (solo si se ingresaron)
                        if (coordsParsed && (!isNaN(coordsParsed.lat) && !isNaN(coordsParsed.lng))) {
                            // Validar que estén dentro de Costa Rica
                            if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(coordsParsed.lat, coordsParsed.lng)) {
                                alert('Las coordenadas deben estar dentro de los límites de Costa Rica.');
                                return;
                            }
                        } else if (coordsTexto) {
                            // Si se ingresó texto pero no se pudo parsear
                            alert('Las coordenadas GPS ingresadas no son válidas. Por favor, ingrese coordenadas válidas (ej: 9.936672, -84.144741) o deje el campo vacío.');
                            return;
                        }
                    }
                    
                    const direccion = document.getElementById('editDireccion')?.value.trim() || '';
                    const otrasSenas = document.getElementById('editOtrasSenas')?.value.trim() || '';
                    
                    const nuevaSucursal = await window.crearSucursal(
                        telefonoNormalizado,
                        nombreSucursal,
                        coordsParsed,
                        provinciaId,
                        cantonId,
                        distritoId,
                        direccion,
                        otrasSenas
                    );
                    sucursalIndice = nuevaSucursal.indice;
                } else {
                    // Usar sucursal existente - validar que existe
                    const indiceSeleccionado = parseInt(sucursalSeleccionada);
                    
                    // Validar que la sucursal existe en cliente.sucursales[]
                    if (!cliente.sucursales || !cliente.sucursales.includes(indiceSeleccionado)) {
                        alert(`La sucursal seleccionada (índice ${indiceSeleccionado}) no existe para este cliente. Por favor seleccione una sucursal válida o cree una nueva.`);
                        return;
                    }
                    
                    sucursalIndice = indiceSeleccionado;
                    
                    // Obtener sucursal actual para verificar si tiene GPS
                    const sucursalActual = await window.obtenerSucursalPorIndice(telefonoNormalizado, sucursalIndice);
                    const tieneGPSActual = window.sonCoordenadasValidas(sucursalActual?.coordenadas);
                    
                    // Actualizar sucursal si cambian coordenadas o nombre
                    const coordsTexto = document.getElementById('editCoordenadas')?.value.trim();
                    const nombreSucursal = document.getElementById('editNombreSucursal')?.value.trim();
                    const provinciaIdSuc = document.getElementById('editProvincia')?.value || '';
                    const cantonIdSuc = document.getElementById('editCanton')?.value || '';
                    const distritoIdSuc = document.getElementById('editDistrito')?.value || '';
                    const direccion = document.getElementById('editDireccion')?.value.trim() || '';
                    const otrasSenas = document.getElementById('editOtrasSenas')?.value.trim() || '';
                    
                    const datosActualizacion = {
                        provinciaId: provinciaIdSuc,
                        cantonId: cantonIdSuc,
                        distritoId: distritoIdSuc,
                        direccion: direccion,
                        otras_senas: otrasSenas
                    };
                    
                    // Procesar coordenadas si se ingresaron
                    let coordsParsed = null;
                    if (coordsTexto) {
                        if (window.limpiarYExtraerCoordenadas) {
                            coordsParsed = window.limpiarYExtraerCoordenadas(coordsTexto);
                        }
                        if (!coordsParsed) {
                            const match = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                            if (match) {
                                coordsParsed = {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                };
                            }
                        }
                        
                        if (coordsParsed && !isNaN(coordsParsed.lat) && !isNaN(coordsParsed.lng)) {
                            // Validar que estén dentro de Costa Rica
                            if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(coordsParsed.lat, coordsParsed.lng)) {
                                alert('Las coordenadas deben estar dentro de los límites de Costa Rica.');
                                return;
                            }
                            
                            // Verificar si se está cambiando un GPS existente
                            if (tieneGPSActual) {
                                const latActual = sucursalActual.coordenadas.lat;
                                const lngActual = sucursalActual.coordenadas.lng;
                                const latNueva = coordsParsed.lat;
                                const lngNueva = coordsParsed.lng;
                                
                                // Verificar si las coordenadas son diferentes (con tolerancia de 0.0001)
                                const sonDiferentes = Math.abs(latActual - latNueva) > 0.0001 || Math.abs(lngActual - lngNueva) > 0.0001;
                                
                                if (sonDiferentes) {
                                    const confirmar = confirm(
                                        `⚠️ ADVERTENCIA: Esta sucursal ya tiene coordenadas GPS guardadas (${latActual}, ${lngActual}).\n\n` +
                                        `Está intentando cambiarlas a (${latNueva}, ${lngNueva}).\n\n` +
                                        `¿Desea continuar y actualizar las coordenadas?`
                                    );
                                    if (!confirmar) {
                                        return; // Cancelar si el usuario no confirma
                                    }
                                }
                            }
                            
                            datosActualizacion.coordenadas = {
                                lat: coordsParsed.lat,
                                lng: coordsParsed.lng,
                                texto: `${coordsParsed.lat}, ${coordsParsed.lng}`
                            };
                        } else if (coordsTexto) {
                            alert('Las coordenadas GPS ingresadas no son válidas. Por favor, ingrese coordenadas válidas (ej: 9.936672, -84.144741) o deje el campo vacío.');
                            return;
                        }
                    } else if (tieneGPSActual) {
                        // Si se borra el campo de coordenadas pero había GPS, preguntar si desea eliminarlo
                        const confirmar = confirm(
                            `⚠️ ADVERTENCIA: Esta sucursal tiene coordenadas GPS guardadas (${sucursalActual.coordenadas.lat}, ${sucursalActual.coordenadas.lng}).\n\n` +
                            `El campo de coordenadas está vacío. ¿Desea eliminar las coordenadas GPS de esta sucursal?`
                        );
                        if (confirmar) {
                            datosActualizacion.coordenadas = null;
                        } else {
                            // Restaurar las coordenadas originales en el campo
                            document.getElementById('editCoordenadas').value = `${sucursalActual.coordenadas.lat}, ${sucursalActual.coordenadas.lng}`;
                            return;
                        }
                    }
                    
                    if (nombreSucursal) {
                        datosActualizacion.nombre = nombreSucursal;
                    }
                    
                    await window.actualizarSucursal(telefonoNormalizado, sucursalIndice, datosActualizacion);
                }

                // Obtener servicios y productos seleccionados y serializar para metadata (sin undefined)
                const serviciosEnMemoria = window.obtenerServiciosSeleccionados ? window.obtenerServiciosSeleccionados('edit') : [];
                const serviciosSeleccionados = (serviciosEnMemoria || []).map(s => ({
                    id: (s && s.id) != null ? String(s.id) : '',
                    cantidad: (s && s.cantidad) != null ? Number(s.cantidad) : 1,
                    precio: (s && s.precio) != null ? Number(s.precio) : 0,
                    comentarios: (s && s.comentarios) != null ? String(s.comentarios) : ''
                })).filter(s => s.id);
                
                const productosEnMemoria = window.obtenerProductosSeleccionados ? window.obtenerProductosSeleccionados('edit') : [];
                const productosSeleccionados = (productosEnMemoria || []).map(p => ({
                    id: (p && p.id) != null ? String(p.id) : '',
                    cantidad: (p && p.cantidad) != null ? Number(p.cantidad) : 1,
                    precio: (p && p.precio) != null ? Number(p.precio) : 0
                })).filter(p => p.id);
                
                // Obtener plagas seleccionadas
                const plagasSeleccionadas = window.obtenerPlagasSeleccionadas('edit');
                
                // Obtener equipo seleccionado
                const equipoSeleccionado = window.obtenerEquipoSeleccionado('edit');
                
                // Obtener certificados
                const certificadosTexto = document.getElementById('editCertificados')?.value.trim() || '';
                
                // provinciaId, cantonId, distritoId ya declarados arriba (antes del if de sucursal)
                
                // Detalle de lo cotizado (para metadata: total_servicios, total_productos, detalle_cotizacion)
                const detalleParaGuardar = window.obtenerDetalleCotizacionParaGuardar ? window.obtenerDetalleCotizacionParaGuardar('edit') : { total_servicios: 0, total_productos: 0, detalle_cotizacion: { servicios: [], productos: [] } };
                
                // Preparar datos para actualizar
                const datosActualizacion = {
                    telefono: telefonoNormalizado, // Solo telefono (mismo campo que formulario y CSV)
                    inicio_gmt6: timestampGMT6,  // Permitir editar fecha/hora
                    duracion_minutos: duracion,  // Permitir editar duración
                    metadata: {
                        // cliente_nombre: guardado como fallback para renderizado rápido (el nombre oficial está en clientes/{telefono}.nombre)
                        cliente_nombre: nombreClienteParaMetadata,
                        // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                        sucursalIndice: sucursalIndice, // Índice de la sucursal (0, 1, 2, 3, ...) o null si no tiene sucursal
                        ruta: window.validarRuta ? window.validarRuta(document.getElementById('editRuta')?.value || 'Sin asignar') : (document.getElementById('editRuta')?.value || 'Sin asignar'),
                        estado: 'agendada',
                        confirmada24_48: document.getElementById('editConfirmada24_48')?.checked
                            ? { confirmada: true, timestamp: new Date().toISOString() }
                            : { confirmada: false, timestamp: null },
                        monto: parseInt(montoVenta) || 0,
                        total_servicios: detalleParaGuardar.total_servicios,
                        total_productos: detalleParaGuardar.total_productos,
                        detalle_cotizacion: detalleParaGuardar.detalle_cotizacion,
                        monto_es_manual: !!(window.editandoMontoVentaManual && window.editandoMontoVentaManual.edit),
                        costo_servicio: 0, // Monto = solo Servicios + Productos (MECE)
                        vendedores: vendedoresSeleccionados, // Array de usernames
                        servicios: serviciosSeleccionados, // Array de objetos {id, precio} con precios personalizados por cita
                        plagas: plagasSeleccionadas, // Array de nombres de plagas
                        productos: productosSeleccionados, // Array de { id, cantidad, precio } (precio cobrado en la cita)
                        equipo: equipoSeleccionado, // Array de IDs de equipo
                        certificados: certificadosTexto, // Texto para generar certificados
                        direccion: document.getElementById('editDireccion')?.value.trim() || '', // Link de Waze/Google Maps
                        whatsapp: document.getElementById('editWhatsApp')?.value.trim() || '', // Link de WhatsApp
                        // coordenadas removido - las coordenadas pertenecen solo a la sucursal, no a la cita
                        // Para obtener coordenadas: buscar sucursal por sucursalIndice y usar sucursal.coordenadas
                        otras_senas: document.getElementById('editOtrasSenas')?.value.trim() || '',
                        observaciones: document.getElementById('editDescription')?.value.trim() || '',
                    turno: turnoSeleccionado,
                        turno_emoji: emojiTurno,
                        provinciaId: provinciaId,
                        cantonId: cantonId,
                        distritoId: distritoId,
                        metodoPago: document.getElementById('editMetodoPago')?.value || '',
                        numeroFactura: document.getElementById('editNumeroFactura')?.value.trim() || '',
                        // Campos de la sección "Rápido" - removidos (no se usan actualmente)
                    },
                    fecha_actualizacion: serverTimestamp()
                };

                // Historial de ediciones: comparar con cita anterior y añadir entradas
                const historialEntradas = buildHistorialEdicion(selectedCita, datosActualizacion);
                if (historialEntradas.length > 0) {
                    datosActualizacion.metadata.historial = [...(selectedCita.metadata?.historial || []), ...historialEntradas];
                }
                
                // Limpiar valores undefined que Firestore no acepta
                const limpiarUndefined = (obj) => {
                    if (obj === null || obj === undefined) return null;
                    if (Array.isArray(obj)) return obj.map(limpiarUndefined);
                    if (typeof obj === 'object' && obj.constructor === Object) {
                        const cleaned = {};
                        for (const key in obj) {
                            if (obj[key] !== undefined) {
                                cleaned[key] = limpiarUndefined(obj[key]);
                            }
                        }
                        return cleaned;
                    }
                    return obj;
                };
                
                const datosLimpios = limpiarUndefined(datosActualizacion);
                
                // Log para depuración
                console.log('🔍 [guardarCita] Datos a actualizar:', {
                    citaId: selectedCita.id,
                    telefono: datosLimpios.telefono,
                    tieneMetadata: !!datosLimpios.metadata,
                    keysMetadata: datosLimpios.metadata ? Object.keys(datosLimpios.metadata) : []
                });
                
                // Actualizar todos los campos, incluyendo los "invariables" ya que el usuario quiere poder editarlos
                await updateDoc(doc(window.db, 'citas', selectedCita.id), datosLimpios);

                bootstrap.Modal.getInstance(document.getElementById('editCitaModal')).hide();
                await cargarDatos();
                
                // Mostrar notificación de éxito
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Cita actualizada exitosamente';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('❌ Error guardando cita:', error);
                console.error('❌ Error completo:', {
                    message: error?.message,
                    stack: error?.stack,
                    name: error?.name,
                    code: error?.code,
                    error: error,
                    stringified: JSON.stringify(error, Object.getOwnPropertyNames(error))
                });
                
                // Intentar obtener el mensaje de error de diferentes formas
                let errorMessage = 'Error desconocido al guardar la cita';
                if (error?.message) {
                    errorMessage = error.message;
                } else if (error?.code) {
                    errorMessage = `Error de Firestore (código: ${error.code})`;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else if (error?.toString && typeof error.toString === 'function') {
                    try {
                        errorMessage = error.toString();
                    } catch (e) {
                        errorMessage = 'Error al convertir error a string';
                    }
                }
                
                console.error('❌ Mensaje de error final:', errorMessage);
                alert('Error guardando cita: ' + errorMessage);
            } finally {
                // Restaurar botones (footer y header)
                console.log('🔧 Restaurando botón...');
                if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.innerHTML = originalText;
                    console.log('✅ Botón restaurado correctamente');
                } else {
                    console.error('❌ No se encontró el botón btnSaveCita');
                }
                const btnSaveCitaTop = document.getElementById('btnSaveCitaTop');
                if (btnSaveCitaTop) {
                    btnSaveCitaTop.disabled = false;
                    btnSaveCitaTop.innerHTML = originalText;
                }
            }
        }

        // Función para guardar nueva cita
        async function guardarNuevaCita() {
            const btnSave = document.getElementById('btnSaveNewCitaTop');
            const originalText = '<i class="fas fa-save me-1"></i>Guardar';

            try {
                // Validar campos requeridos
                const clientPhone = document.getElementById('newClientPhone').value.trim();
                const startTime = document.getElementById('newStartTime').value;
                const duration = document.getElementById('newDuration').value;
                const ruta = document.getElementById('newRuta').value;
                const vendedoresSeleccionados = window.obtenerVendedoresSeleccionados ? window.obtenerVendedoresSeleccionados('newVendedoresSelected') : (window.vendedoresSeleccionadosNew || []);

                if (!clientPhone || !startTime || !duration || !ruta) {
                    alert('Por favor completa todos los campos indispensables: Teléfono, Fecha y Hora de Inicio, Duración y Ruta.');
                    return;
                }

                if (!vendedoresSeleccionados.length) {
                    alert('Debe seleccionar al menos un vendedor para crear la cita.');
                    return;
                }
                
                // Validar comentarios de servicios (ahora opcionales, siempre pasa)
                if (!window.validarComentariosServicios('new')) {
                    return;
                }
                
                // Validar que todas las plagas tengan comentarios (obligatorio, excepto excepciones)
                if (!window.validarComentariosPlagas('new')) {
                    return;
                }
                
                const clientName = document.getElementById('newClientName').value.trim();
                const montoVentaInput = document.getElementById('newMontoVenta');
                const valorNumerico = montoVentaInput ? window.extraerValorNumerico(montoVentaInput.value) : '0';
                const montoVenta = valorNumerico || '0';

                const fechaInicio = new Date(startTime);
                console.log('🔍 Hora ingresada por usuario:', startTime);
                console.log('🔍 Fecha convertida a objeto Date:', fechaInicio);
                console.log('🔍 Fecha en UTC (lo que se guardará):', fechaInicio.toISOString());
                
                // Turno eliminado - usar valor por defecto
                const turnoSeleccionado = 'Turno 1';
                const emojiTurno = '☀️';
                
                // Calcular hora de fin
                const duracion = parseInt(document.getElementById('newDuration').value);
                const fechaFin = new Date(fechaInicio.getTime() + (duracion * 60000));
                
                // Mostrar indicador de carga (footer y header)
                if (btnSave) {
                    btnSave.disabled = true;
                    btnSave.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }
                const btnSaveNewCitaTop = document.getElementById('btnSaveNewCitaTop');
                if (btnSaveNewCitaTop) {
                    btnSaveNewCitaTop.disabled = true;
                    btnSaveNewCitaTop.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }

                // Convertir fecha a Timestamp GMT-06
                const timestampGMT6 = Timestamp.fromDate(fechaInicio);
                
                // Normalizar teléfono usando función helper
                const telefonoNormalizado = window.normalizarTelefono(clientPhone);
                if (!telefonoNormalizado) {
                    alert('Por favor ingrese un teléfono válido de 8 dígitos');
                    return;
                }
                
                // Generar link de WhatsApp
                const newWhatsApp = document.getElementById('newWhatsApp');
                if (newWhatsApp) {
                    newWhatsApp.value = window.generarLinkWhatsApp(telefonoNormalizado, 'Hola desde Ecoplagas');
                }
                
                // Obtener o crear cliente
                let cliente = await window.buscarCliente(telefonoNormalizado);
                if (!cliente) {
                    cliente = await window.crearCliente(telefonoNormalizado, clientName);
                } else {
                    // Actualizar nombre del cliente si fue modificado
                    if (clientName && clientName.trim()) {
                        await window.actualizarNombreCliente(telefonoNormalizado, clientName.trim());
                        // Actualizar también en el objeto cliente local
                        cliente.nombre = clientName.trim();
                    }
                }
                
                // Obtener nombre del cliente para guardarlo en metadata (fallback para renderizado rápido)
                const nombreClienteParaMetadata = cliente?.nombre || clientName || '';
                
                // Obtener sucursal seleccionada o crear nueva
                const sucursalSelect = document.getElementById('newSucursal');
                const sucursalSeleccionada = sucursalSelect?.value;
                let sucursalIndice = null;
                
                if (sucursalSeleccionada === 'nueva' || !sucursalSeleccionada) {
                    // Crear nueva sucursal
                    const nombreSucursal = document.getElementById('newNombreSucursal')?.value.trim() || 'Hogar principal';
                    const coordsTexto = document.getElementById('newCoordenadas')?.value.trim();
                    
                    // Intentar parsear coordenadas (opcional)
                    let coordsParsed = null;
                    if (coordsTexto) {
                        if (window.limpiarYExtraerCoordenadas) {
                            coordsParsed = window.limpiarYExtraerCoordenadas(coordsTexto);
                        }
                        // Si no funciona, intentar parseo directo
                        if (!coordsParsed) {
                            const match = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                            if (match) {
                                coordsParsed = {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                };
                            }
                        }
                        
                        // Validar que las coordenadas sean válidas (solo si se ingresaron)
                        if (coordsParsed && (!isNaN(coordsParsed.lat) && !isNaN(coordsParsed.lng))) {
                            // Validar que estén dentro de Costa Rica
                            if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(coordsParsed.lat, coordsParsed.lng)) {
                                alert('Las coordenadas deben estar dentro de los límites de Costa Rica.');
                                return;
                            }
                        } else if (coordsTexto) {
                            // Si se ingresó texto pero no se pudo parsear
                            alert('Las coordenadas GPS ingresadas no son válidas. Por favor, ingrese coordenadas válidas (ej: 9.936672, -84.144741) o deje el campo vacío.');
                            return;
                        }
                    }
                    
                    const provinciaId = document.getElementById('newProvincia')?.value || '';
                    const cantonId = document.getElementById('newCanton')?.value || '';
                    const distritoId = document.getElementById('newDistrito')?.value || '';
                    const direccion = document.getElementById('newDireccion')?.value.trim() || '';
                    const otrasSenas = document.getElementById('newOtrasSenas')?.value.trim() || '';
                    
                    const nuevaSucursal = await window.crearSucursal(
                        telefonoNormalizado,
                        nombreSucursal,
                        coordsParsed,
                        provinciaId,
                        cantonId,
                        distritoId,
                        direccion,
                        otrasSenas
                    );
                    sucursalIndice = nuevaSucursal.indice;
                } else {
                    // Usar sucursal existente - validar que existe
                    const indiceSeleccionado = parseInt(sucursalSeleccionada);
                    
                    // Validar que la sucursal existe en cliente.sucursales[]
                    if (!cliente.sucursales || !cliente.sucursales.includes(indiceSeleccionado)) {
                        alert(`La sucursal seleccionada (índice ${indiceSeleccionado}) no existe para este cliente. Por favor seleccione una sucursal válida o cree una nueva.`);
                        return;
                    }
                    
                    sucursalIndice = indiceSeleccionado;
                }

                // Serializar servicios y productos para metadata (sin undefined)
                const serviciosEnMemoria = window.serviciosSeleccionadosNew || [];
                const serviciosSeleccionados = (serviciosEnMemoria || []).map(s => ({
                    id: (s && s.id) != null ? String(s.id) : '',
                    cantidad: (s && s.cantidad) != null ? Number(s.cantidad) : 1,
                    precio: (s && s.precio) != null ? Number(s.precio) : 0,
                    comentarios: (s && s.comentarios) != null ? String(s.comentarios) : ''
                })).filter(s => s.id);
                
                const productosEnMemoria = window.productosSeleccionadosNew || [];
                const productosSeleccionados = (productosEnMemoria || []).map(p => ({
                    id: (p && p.id) != null ? String(p.id) : '',
                    cantidad: (p && p.cantidad) != null ? Number(p.cantidad) : 1,
                    precio: (p && p.precio) != null ? Number(p.precio) : 0
                })).filter(p => p.id);
                
                // Obtener plagas seleccionadas
                const plagasSeleccionadas = window.obtenerPlagasSeleccionadas('new');
                
                // Obtener equipo seleccionado
                const equipoSeleccionado = window.obtenerEquipoSeleccionado('new');
                
                // Obtener certificados
                const certificadosTexto = document.getElementById('newCertificados')?.value.trim() || '';
                
                // Obtener valores de ubicación
                const provinciaId = document.getElementById('newProvincia')?.value || '';
                const cantonId = document.getElementById('newCanton')?.value || '';
                const distritoId = document.getElementById('newDistrito')?.value || '';
                
                // Función helper para parsear coordenadas
                function parsearCoordenadas(texto) {
                    const match = texto.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                    if (match) {
                        return {
                            lat: parseFloat(match[1]),
                            lng: parseFloat(match[2])
                        };
                    }
                    return null;
                }
                
                // Detalle de lo cotizado (para metadata)
                const detalleParaGuardarNew = window.obtenerDetalleCotizacionParaGuardar ? window.obtenerDetalleCotizacionParaGuardar('new') : { total_servicios: 0, total_productos: 0, detalle_cotizacion: { servicios: [], productos: [] } };
                
                // Crear nueva cita (solo telefono en raíz; mismo campo que CSV)
                const nuevaCita = {
                    telefono: telefonoNormalizado,
                    inicio_gmt6: timestampGMT6,
                    duracion_minutos: duracion,
                    metadata: {
                        // cliente_nombre: guardado como fallback para renderizado rápido (el nombre oficial está en clientes/{telefono}.nombre)
                        cliente_nombre: nombreClienteParaMetadata,
                        // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                        sucursalIndice: sucursalIndice, // Índice de la sucursal (0, 1, 2, 3, ...) o null si no tiene sucursal
                        ruta: window.validarRuta ? window.validarRuta(document.getElementById('newRuta')?.value || 'Sin asignar') : (document.getElementById('newRuta')?.value || 'Sin asignar'),
                        estado: 'agendada',
                        confirmada24_48: document.getElementById('newConfirmada24_48')?.checked
                            ? { confirmada: true, timestamp: new Date().toISOString() }
                            : { confirmada: false, timestamp: null },
                        monto: parseInt(montoVenta) || 0,
                        total_servicios: detalleParaGuardarNew.total_servicios,
                        total_productos: detalleParaGuardarNew.total_productos,
                        detalle_cotizacion: detalleParaGuardarNew.detalle_cotizacion,
                        monto_es_manual: !!(window.editandoMontoVentaManual && window.editandoMontoVentaManual.new),
                        costo_servicio: 0, // Monto = solo Servicios + Productos (MECE)
                        vendedores: vendedoresSeleccionados,
                        servicios: serviciosSeleccionados,
                        plagas: plagasSeleccionadas, // Array de nombres de plagas
                        productos: productosSeleccionados,
                        equipo: equipoSeleccionado, // Array de IDs de equipo
                        certificados: certificadosTexto, // Texto para generar certificados
                        direccion: document.getElementById('newDireccion')?.value.trim() || '',
                        whatsapp: document.getElementById('newWhatsApp')?.value.trim() || '', // Link de WhatsApp
                        // coordenadas removido - las coordenadas pertenecen solo a la sucursal, no a la cita
                        // Para obtener coordenadas: buscar sucursal por sucursalIndice y usar sucursal.coordenadas
                        otras_senas: document.getElementById('newOtrasSenas')?.value.trim() || '',
                        observaciones: document.getElementById('newDescription')?.value.trim() || '',
                        turno: turnoSeleccionado,
                        turno_emoji: emojiTurno,
                        provinciaId: provinciaId,
                        cantonId: cantonId,
                        distritoId: distritoId,
                        metodoPago: document.getElementById('newMetodoPago')?.value || '',
                        numeroFactura: document.getElementById('newNumeroFactura')?.value.trim() || ''
                    },
                    fecha_creacion: serverTimestamp(),
                    fecha_actualizacion: serverTimestamp(),
                    version_esquema: 1
                };

                await addDoc(collection(window.db, 'citas'), nuevaCita);

                bootstrap.Modal.getInstance(document.getElementById('nuevaCitaModal')).hide();
                await cargarDatos();
                
                // Mostrar notificación de éxito
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Cita creada exitosamente';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('Error guardando nueva cita:', error);
                alert('Error guardando nueva cita: ' + error.message);
            } finally {
                // Restaurar botones (footer y header)
                if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.innerHTML = originalText;
                }
                const btnSaveNewCitaTop = document.getElementById('btnSaveNewCitaTop');
                if (btnSaveNewCitaTop) {
                    btnSaveNewCitaTop.disabled = false;
                    btnSaveNewCitaTop.innerHTML = originalText;
                }
            }
        }

        // Función para eliminar cita
        async function eliminarCita() {
            if (!selectedCita) return;

            const confirmacion = confirm(`¿Estás seguro de que deseas eliminar la cita de ${window.obtenerClienteNombre(selectedCita)}?`);
            if (!confirmacion) return;

            try {
                const btnDelete = document.getElementById('btnDeleteCita');
                const originalText = '<i class="fas fa-trash me-2"></i>Eliminar Cita';
                btnDelete.disabled = true;
                btnDelete.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';

                await deleteDoc(doc(window.db, 'citas', selectedCita.id));

                bootstrap.Modal.getInstance(document.getElementById('editCitaModal')).hide();
                await cargarDatos();
                
                // Mostrar notificación de éxito
                const notification = document.createElement('div');
                notification.className = 'alert alert-danger position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = '<i class="fas fa-trash me-2"></i>Cita eliminada exitosamente';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('Error eliminando cita:', error);
                alert('Error eliminando cita: ' + error.message);
            } finally {
                // Restaurar botón
                const btnDelete = document.getElementById('btnDeleteCita');
                btnDelete.disabled = false;
                btnDelete.innerHTML = '<i class="fas fa-trash me-2"></i>Eliminar Cita';
            }
        }

        // Event listeners eliminados para btnPrevMonth, btnNextMonth, btnToday

        if (datePicker) {
        datePicker.addEventListener('change', async () => {
            // Crear fecha en zona horaria local (no UTC)
            const fechaString = datePicker.value; // Formato: YYYY-MM-DD
            const [year, month, day] = fechaString.split('-').map(Number);
            const nuevaFecha = new Date(year, month - 1, day, 12, 0, 0); // Mediodía para evitar problemas de zona horaria
            currentDate = nuevaFecha;
            diaSeleccionado = nuevaFecha;
            
            // Actualizar botones de días
            generarBotonesDiasMes(nuevaFecha);
            
            console.log('🔍 DatePicker cambió:', {
                valor: fechaString,
                fechaCreada: nuevaFecha.toString(),
                diaSeleccionado: diaSeleccionado.toString()
            });
            
                if (vistaActual === 'cronograma') {
                await generarCronograma();
            }
        });
        }
        
        // Inicializar botones de días al cargar
        if (diaSeleccionado) {
            generarBotonesDiasMes(diaSeleccionado);
        }

        if (searchInput) {
            searchInput.addEventListener('input', async () => {
                aplicarFiltros();
                if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }

        if (vehicleFilter) {
            vehicleFilter.addEventListener('change', async () => {
                aplicarFiltros();
                if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }

        if (statusFilter) {
            statusFilter.addEventListener('change', async () => {
                aplicarFiltros();
                if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                } else if (vistaActual === 'cronograma') {
                    await generarCronograma();
                }
            });
        }

        // Función para generar id_encuesta alfanumérico único (máximo 9 caracteres)
        // Usa base36 (0-9, a-z) para generar IDs cortos pero difíciles de adivinar
        window.generarIdEncuestaUnico = async function() {
            const db = window.db;
            const maxIntentos = 10; // Máximo de intentos para encontrar un ID único
            const longitudId = 9; // Máximo 9 caracteres alfanuméricos
            
            for (let intento = 0; intento < maxIntentos; intento++) {
                // Generar número aleatorio grande y convertir a base36
                // Base36 usa 0-9 y a-z, así que 9 caracteres = 36^9 = ~101 trillones de posibilidades
                const numeroAleatorio = Math.floor(Math.random() * Math.pow(36, longitudId));
                const idEncuesta = numeroAleatorio.toString(36).padStart(longitudId, '0').substring(0, longitudId);
                
                // Verificar si ya existe en encuestas_id
                const encuestaIdRef = doc(db, 'encuestas_id', idEncuesta);
                const encuestaIdSnap = await getDoc(encuestaIdRef);
                
                if (!encuestaIdSnap.exists()) {
                    console.log(`✅ ID único generado: ${idEncuesta} (intento ${intento + 1})`);
                    return idEncuesta;
                }
                
                console.log(`⚠️ ID ${idEncuesta} ya existe, intentando otro...`);
            }
            
            // Si no se encontró un ID único después de maxIntentos, usar timestamp como fallback
            console.warn('⚠️ No se pudo generar ID único después de varios intentos, usando timestamp');
            const timestampBase36 = Date.now().toString(36).substring(0, longitudId);
            return timestampBase36;
        };
        
        window.generarLinkEncuesta = async function(cita) {
            if (!cita || !cita.id) {
                console.error('❌ No se puede generar link: cita no proporcionada o sin id');
                return null;
            }
            try {
                const refEncuestaCita = doc(window.db, 'encuestas_citas', cita.id);
                const baseUrl = window.location.origin + '/encuesta.html';
                const url = `${baseUrl}?c=${encodeURIComponent(cita.id)}`;

                const docSnap = await getDoc(refEncuestaCita);
                if (docSnap.exists() && docSnap.data().estado === 'respondida') {
                    // Ya hay respuesta: no sobrescribir, solo devolver el link para volver a copiar
                    console.log('✅ Encuesta ya respondida; se devuelve el link para reenviar sin modificar resultados');
                    return url;
                }

                // Sin respuesta (o pendiente): crear/actualizar a pendiente para que el cliente pueda responder
                await setDoc(refEncuestaCita, {
                    cita_id: cita.id,
                    estado: 'pendiente',
                    fecha_link_generado: serverTimestamp()
                }, { merge: true });
                mapEncuestasCitas.set(cita.id, { estado: 'pendiente' });
                console.log('✅ Link de encuesta (primaria) generado:', url);
                if (vistaActual === 'cronograma') await generarCronograma();
                else if (vistaActual === 'mes') generarCalendario();
                else if (vistaActual === 'dia') generarVistaDia();
                return url;
            } catch (error) {
                console.error('❌ Error generando link de encuesta:', error);
                return null;
            }
        };
        
        // Función para manejar el botón de encuesta (simplificada: copia directamente)
        async function manejarBotonEncuesta() {
            // window.selectedCita puede ser el objeto completo o el ID
            let cita = null;
            
            if (!window.selectedCita) {
                return;
            }
            
            // Si selectedCita es un string (ID), buscar la cita
            if (typeof window.selectedCita === 'string') {
                cita = window.todasLasCitas.find(c => c.id === window.selectedCita);
            } else {
                // Si es un objeto, usarlo directamente
                cita = window.selectedCita;
            }
            
            if (!cita) {
                return;
            }
            
            try {
                // Esperar a que se genere el link (ahora es async porque genera hash)
                const linkEncuesta = await window.generarLinkEncuesta(cita);
                if (!linkEncuesta) {
                    console.warn('⚠️ No se pudo generar el link de encuesta');
                    return;
                }
                
                console.log('📋 Link generado, copiando al portapapeles:', linkEncuesta);
                
                // Crear mensaje completo para WhatsApp
                const mensajeEncuesta = `Nos apoyaría con una encuesta de satisfacción con el objetivo de mejorar o reforzar áreas de oportunidad en el siguiente link:\n\n${linkEncuesta}`;
                
                // Copiar mensaje completo al portapapeles
                await navigator.clipboard.writeText(mensajeEncuesta);
                console.log('✅ Mensaje con link copiado al portapapeles exitosamente');
            } catch (err) {
                console.error('❌ Error generando o copiando link de encuesta:', err);
            }
        }

        // Textos de preguntas para el modal de resultado (igual que reporte_encuestas)
        const TEXTO_PREGUNTAS_ENCUESTA = [
            { id: 'Q1', texto: 'Servicio técnico en general', seccion: 'Calidad' },
            { id: 'Q2', texto: 'Trato y respeto del técnico', seccion: 'Calidad' },
            { id: 'Q3', texto: 'Presentación personal del técnico', seccion: 'Calidad' },
            { id: 'Q4', texto: 'Tiempo que duró el servicio', seccion: 'Calidad' },
            { id: 'Q5', texto: 'Explicación del técnico sobre lo que hizo', seccion: 'Calidad' },
            { id: 'Q6', texto: 'Medidas preventivas para mascotas/personas', seccion: 'Calidad' },
            { id: 'Q7', texto: 'Limpieza área y retiro de excesos', seccion: 'Cumplimiento' },
            { id: 'Q8', texto: 'Aplicación de puntos de gel', seccion: 'Cumplimiento' },
            { id: 'Q9', texto: 'Tratamiento en tuberías/desagües/cajas', seccion: 'Cumplimiento' },
            { id: 'Q10', texto: 'Preguntó si necesitaba otro servicio', seccion: 'Cumplimiento' },
            { id: 'Q11', texto: 'Informó métodos de pago disponibles', seccion: 'Cumplimiento' },
            { id: 'Q12', texto: 'Puntualidad con horario acordado', seccion: 'Cumplimiento' }
        ];

        async function abrirModalResultadoEncuesta() {
            const cita = typeof window.selectedCita === 'string'
                ? window.todasLasCitas.find(c => c.id === window.selectedCita)
                : window.selectedCita;
            if (!cita) return;
            const ident = obtenerIdentificadorEncuestaRespuesta(cita);
            if (!ident) {
                console.warn('⚠️ No hay encuesta respondida para esta cita');
                return;
            }
            const body = document.getElementById('modalResultadoEncuestaBody');
            const cargando = document.getElementById('modalResultadoEncuestaCargando');
            const contenido = document.getElementById('modalResultadoEncuestaContenido');
            cargando.style.display = 'block';
            contenido.style.display = 'none';
            contenido.innerHTML = '';
            const modal = new bootstrap.Modal(document.getElementById('modalResultadoEncuesta'));
            modal.show();
            try {
                const ref = ident.tipo === 'primaria'
                    ? doc(window.db, 'encuestas_citas', ident.id)
                    : doc(window.db, 'encuestas', ident.id);
                const snap = await getDoc(ref);
                if (!snap.exists()) {
                    contenido.innerHTML = '<div class="p-4 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>No se encontró el resultado de la encuesta.</div>';
                    cargando.style.display = 'none';
                    contenido.style.display = 'block';
                    return;
                }
                const d = snap.data();
                const scores = d.scores || {};
                const global = scores.global || {};
                const sectionA = scores.sectionA || {};
                const sectionB = scores.sectionB || {};
                const percent = global.percent != null ? Number(global.percent) : 0;
                const label = global.label || 'N/A';
                let fechaEnvio = 'N/A';
                if (d.fecha_envio_local) {
                    try {
                        const fd = new Date(d.fecha_envio_local);
                        fechaEnvio = fd.toLocaleDateString('es-CR', { day: 'numeric', month: 'short', year: 'numeric' }) + ', ' + fd.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit', hour12: true });
                    } catch (e) {}
                } else if (d.fecha_envio && d.fecha_envio.toDate) {
                    try {
                        const fd = d.fecha_envio.toDate();
                        fechaEnvio = fd.toLocaleDateString('es-CR', { day: 'numeric', month: 'short', year: 'numeric' }) + ', ' + fd.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit', hour12: true });
                    } catch (e) {}
                }
                const scoreClass = label === 'Excelente' ? 'success' : label === 'Bueno' ? 'info' : label === 'Aceptable' ? 'warning' : 'danger';
                let html = `
                    <div class="p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-12 col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="text-muted small mb-1">Score global</div>
                                        <div class="display-6 fw-bold text-${scoreClass}">${percent.toFixed(0)}%</div>
                                        <div class="badge bg-${scoreClass} mt-1">${label}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="text-muted small mb-1">Calidad (Q1-Q6)</div>
                                        <div class="h4 mb-0 text-primary">${(sectionA.percent != null ? Number(sectionA.percent) : 0).toFixed(0)}%</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="text-muted small mb-1">Cumplimiento (Q7-Q12)</div>
                                        <div class="h4 mb-0 text-success">${(sectionB.percent != null ? Number(sectionB.percent) : 0).toFixed(0)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted small mb-3"><i class="fas fa-clock me-1"></i>Fecha de envío: ${fechaEnvio}</p>
                        <h6 class="fw-bold mb-2"><i class="fas fa-list me-1"></i>Respuestas por pregunta</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr><th style="width:32%">Pregunta</th><th>Respuesta</th><th class="text-center">Nota</th><th class="text-center">Comentario</th></tr>
                                </thead>
                                <tbody>
                `;
                const esc = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const questionsScores = (scores.questions || []);
                const scoreByQ = {};
                questionsScores.forEach((q) => { if (q.id) scoreByQ[q.id] = q; });
                for (let i = 1; i <= 12; i++) {
                    const qId = 'Q' + i;
                    const p = TEXTO_PREGUNTAS_ENCUESTA[i - 1];
                    const resp = esc(d['pregunta' + i] || '-');
                    const com = (d['comentario' + i] || '').trim();
                    const qScore = scoreByQ[qId];
                    const notaRaw = qScore && (qScore.scoreRaw != null) ? qScore.scoreRaw : null;
                    const notaPct = qScore && (qScore.scorePercent != null) ? Number(qScore.scorePercent) : null;
                    let notaStr = '-';
                    if (notaRaw != null && notaPct != null) notaStr = notaRaw + '/3 (' + notaPct.toFixed(0) + '%)';
                    else if (notaPct != null) notaStr = notaPct.toFixed(0) + '%';
                    html += `<tr><td><small>${p.texto}</small></td><td>${resp}</td><td class="text-center fw-semibold">${notaStr}</td><td class="text-center">${com ? '<span class="text-info" title="' + esc(com) + '"><i class="fas fa-comment"></i></span>' : '-'}</td></tr>`;
                }
                html += `
                                </tbody>
                            </table>
                        </div>
                `;
                const comentariosGenerales = (d.comentarios_generales || '').trim();
                if (comentariosGenerales) {
                    html += `
                        <h6 class="fw-bold mt-3 mb-2"><i class="fas fa-comment-dots me-1"></i>Comentarios generales</h6>
                        <div class="alert alert-light border">${esc(comentariosGenerales).replace(/\n/g, '<br>')}</div>
                    `;
                }
                html += '</div>';
                contenido.innerHTML = html;
            } catch (err) {
                console.error('❌ Error cargando resultado encuesta:', err);
                contenido.innerHTML = '<div class="p-4 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar el resultado. Intente de nuevo.</div>';
            }
            cargando.style.display = 'none';
            contenido.style.display = 'block';
        }

        // Los datos se cargan automáticamente al inicializar
        // btnSaveCita movido al header como btnSaveCitaTop
        document.getElementById('btnDeleteCita').addEventListener('click', eliminarCita);
        // Función para manejar el botón de justificar sin encuesta
        async function manejarJustificarSinEncuesta() {
            if (!window.selectedCita) {
                console.warn('⚠️ No hay cita seleccionada');
                return;
            }

            let cita = null;
            if (typeof window.selectedCita === 'string') {
                cita = window.todasLasCitas.find(c => c.id === window.selectedCita);
            } else {
                cita = window.selectedCita;
            }

            if (!cita || !cita.id) {
                console.error('❌ No se pudo encontrar la cita');
                return;
            }

            // Verificar si ya existe justificación
            const justificacionExistente = obtenerJustificacion(cita);
            
            // Mostrar modal de justificación
            const modalJustificar = document.getElementById('modalJustificarSinEncuesta');
            const textareaJustificacion = document.getElementById('justificacionSinEncuesta');
            const divJustificacionExistente = document.getElementById('justificacionExistente');
            const textoJustificacionExistente = document.getElementById('textoJustificacionExistente');

            if (justificacionExistente) {
                // Mostrar justificación existente
                textoJustificacionExistente.textContent = justificacionExistente;
                divJustificacionExistente.style.display = 'block';
                textareaJustificacion.value = justificacionExistente;
            } else {
                // Ocultar justificación existente
                divJustificacionExistente.style.display = 'none';
                textareaJustificacion.value = '';
            }

            const modal = new bootstrap.Modal(modalJustificar);
            modal.show();

            // Guardar referencia de la cita en el modal
            modalJustificar.dataset.citaId = cita.id;
        }

        // Event listener para botón de justificar sin encuesta
        document.getElementById('btnJustificarSinEncuesta').addEventListener('click', async (e) => {
            e.preventDefault();
            await manejarJustificarSinEncuesta();
        });

        // Ver historial de ediciones de la cita
        document.getElementById('btnVerHistorial').addEventListener('click', () => {
            const cita = window.selectedCita;
            const historial = (cita && cita.metadata && Array.isArray(cita.metadata.historial)) ? cita.metadata.historial : [];
            const sinReg = document.getElementById('historialSinRegistros');
            const contenedor = document.getElementById('historialContenedorTabla');
            const tbody = document.getElementById('historialCuerpoTabla');
            if (!historial.length) {
                sinReg.style.display = 'block';
                contenedor.style.display = 'none';
            } else {
                sinReg.style.display = 'none';
                contenedor.style.display = 'block';
                const ordenado = historial.slice().reverse();
                tbody.innerHTML = ordenado.map(h => `
                    <tr>
                        <td class="text-nowrap">${escapeHtml(h.timestamp || '')}</td>
                        <td>${escapeHtml(h.usuario || '')}</td>
                        <td><code class="small">${escapeHtml(h.campo || '')}</code></td>
                        <td class="small text-break" style="max-width: 180px;">${escapeHtml(h.valorAnterior || '')}</td>
                        <td class="small text-break" style="max-width: 180px;">${escapeHtml(h.valorNuevo || '')}</td>
                    </tr>
                `).join('');
            }
            const modalHistorial = new bootstrap.Modal(document.getElementById('modalHistorialEdiciones'));
            modalHistorial.show();
        });
        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        // Event listener para guardar justificación
        document.getElementById('btnGuardarJustificacion').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const modalJustificar = document.getElementById('modalJustificarSinEncuesta');
            const citaId = modalJustificar.dataset.citaId;
            const justificacion = document.getElementById('justificacionSinEncuesta').value.trim();

            if (!citaId) {
                alert('Error: No se encontró la cita');
                return;
            }

            if (!justificacion) {
                alert('Por favor, ingrese una justificación');
                return;
            }

            try {
                // Guardar justificación en Firestore
                const justificacionRef = doc(window.db, 'justificaciones_sin_encuesta', citaId);
                await setDoc(justificacionRef, {
                    cita_id: citaId,
                    justificacion: justificacion,
                    fecha_creacion: serverTimestamp(),
                    fecha_actualizacion: serverTimestamp()
                }, { merge: true });

                // Actualizar mapa en memoria
                mapaJustificacionesSinEncuesta.set(citaId, justificacion);

                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(modalJustificar);
                modal.hide();

                // Regenerar vista actual
                if (vistaActual === 'cronograma') {
                    await generarCronograma();
                } else if (vistaActual === 'mes') {
                    generarCalendario();
                } else if (vistaActual === 'dia') {
                    generarVistaDia();
                }

                console.log('✅ Justificación guardada exitosamente');
            } catch (error) {
                console.error('❌ Error guardando justificación:', error);
                alert('Error al guardar la justificación. Por favor, intente nuevamente.');
            }
        });

        // Event listener para botón de encuesta (ahora en el header)
        const btnEnviarEncuesta = document.getElementById('btnEnviarEncuesta');
        if (btnEnviarEncuesta) {
            btnEnviarEncuesta.addEventListener('click', async (e) => {
                e.preventDefault();
                await manejarBotonEncuesta();
            });
        }
        const btnVerResultadoEncuesta = document.getElementById('btnVerResultadoEncuesta');
        if (btnVerResultadoEncuesta) {
            btnVerResultadoEncuesta.addEventListener('click', (e) => {
                e.preventDefault();
                abrirModalResultadoEncuesta();
            });
        }
        
        // Event listeners para botones del header (editar cita)
        const btnSaveCitaTop = document.getElementById('btnSaveCitaTop');
        if (btnSaveCitaTop) {
            btnSaveCitaTop.addEventListener('click', guardarCita);
        }
        
        // Event listener para botón del header (nueva cita)
        const btnSaveNewCitaTop = document.getElementById('btnSaveNewCitaTop');
        if (btnSaveNewCitaTop) {
            btnSaveNewCitaTop.addEventListener('click', guardarNuevaCita);
        }
        
        // Event listeners para botones adicionales de Nueva Cita
        const btnDescargarProformaNew = document.getElementById('btnDescargarProformaNew');
        if (btnDescargarProformaNew) {
            btnDescargarProformaNew.addEventListener('click', async () => {
                btnDescargarProformaNew.disabled = true;
                btnDescargarProformaNew.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
                try {
                    await window.generarProformaPNG();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al generar la proforma: ' + error.message);
                } finally {
                    btnDescargarProformaNew.disabled = false;
                    btnDescargarProformaNew.innerHTML = '<i class="fas fa-download me-2"></i>Descargar Proforma PNG';
                }
            });
        }
        
        const btnJustificarSinEncuestaNew = document.getElementById('btnJustificarSinEncuestaNew');
        if (btnJustificarSinEncuestaNew) {
            btnJustificarSinEncuestaNew.addEventListener('click', async (e) => {
                e.preventDefault();
                await manejarJustificarSinEncuesta();
            });
        }
        
        const btnEnviarEncuestaNew = document.getElementById('btnEnviarEncuestaNew');
        if (btnEnviarEncuestaNew) {
            btnEnviarEncuestaNew.addEventListener('click', async (e) => {
                e.preventDefault();
                await manejarBotonEncuesta();
            });
        }
        
        const btnDeleteCitaNew = document.getElementById('btnDeleteCitaNew');
        if (btnDeleteCitaNew) {
            btnDeleteCitaNew.addEventListener('click', eliminarCita);
        }
        
        // Función para abrir modal de nueva cita desde arrastre en cronograma
        async function abrirModalNuevaCitaDesdeArrastreCronograma(fechaInicio, duracion, ruta) {
            // Prellenar campos del formulario
            const newStartTime = document.getElementById('newStartTime');
            const newDuration = document.getElementById('newDuration');
            const newRuta = document.getElementById('newRuta');
            
            if (newStartTime) newStartTime.value = fechaInicio;
            if (newDuration) {
                // Seleccionar la opción más cercana
                const opcionesDuracion = [15, 30, 45, 60, 75, 90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345, 360, 375, 390, 405, 420, 435, 450, 465, 480, 540, 600, 660, 720];
                let duracionSeleccionada = 60; // Valor por defecto
                for (let i = 0; i < opcionesDuracion.length; i++) {
                    if (duracion <= opcionesDuracion[i]) {
                        duracionSeleccionada = opcionesDuracion[i];
                        break;
                    }
                }
                if (duracion > 720) duracionSeleccionada = 720;
                newDuration.value = duracionSeleccionada;
            }
            if (newRuta) newRuta.value = ruta; // Usar la ruta del timeline donde se hizo el arrastre
            
            // Limpiar otros campos (solo los que existen)
            const newClientName = document.getElementById('newClientName');
            const newClientPhone = document.getElementById('newClientPhone');
            const newCoordenadas = document.getElementById('newCoordenadas');
            const newOtrasSenas = document.getElementById('newOtrasSenas');
            const newConfirmada24_48 = document.getElementById('newConfirmada24_48');
            const newConfirmada24_48Msg = document.getElementById('newConfirmada24_48Mensaje');
            const newConfirmada24_48Ts = document.getElementById('newConfirmada24_48Timestamp');
            const newMontoVenta = document.getElementById('newMontoVenta');
            const newDescription = document.getElementById('newDescription');
            
            if (newClientName) newClientName.value = '';
            if (newClientPhone) newClientPhone.value = '';
            if (newCoordenadas) newCoordenadas.value = '';
            if (newOtrasSenas) newOtrasSenas.value = '';
            if (newConfirmada24_48) { newConfirmada24_48.checked = false; newConfirmada24_48.disabled = true; }
            if (newConfirmada24_48Msg) newConfirmada24_48Msg.textContent = '';
            if (newConfirmada24_48Ts) { newConfirmada24_48Ts.textContent = ''; newConfirmada24_48Ts.style.display = 'none'; }
            if (newMontoVenta) newMontoVenta.value = '';
            if (newDescription) newDescription.value = '';
            
            // Limpiar selecciones de vendedores, servicios, productos y plagas
            window.vendedoresSeleccionadosNew = [];
            window.serviciosSeleccionadosNew = [];
            window.productosSeleccionadosNew = [];
            window.plagasSeleccionadasNew = [];
            
            const newVendedoresSelected = document.getElementById('newVendedoresSelected');
            const newServiciosSelected = document.getElementById('newServiciosSelected');
            const newProductosSelected = document.getElementById('newProductosSelected');
            
            if (newVendedoresSelected) newVendedoresSelected.innerHTML = '';
            // Renderizar tabla de servicios (vacía inicialmente)
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('new');
            }
            if (window.renderizarTablaProductos) {
                window.renderizarTablaProductos('new');
            }
            
            // Limpiar campos de búsqueda
            const newVendedorSearch = document.getElementById('newVendedorSearch');
            const newServicioSearch = document.getElementById('newServicioSearch');
            const newProductoSearch = document.getElementById('newProductoSearch');
            
            if (newVendedorSearch) newVendedorSearch.value = '';
            if (newServicioSearch) newServicioSearch.value = '';
            if (newProductoSearch) newProductoSearch.value = '';
            
            // Ocultar resultados de búsqueda
            const newVendedoresResults = document.getElementById('newVendedoresResults');
            const newServiciosResults = document.getElementById('newServiciosResults');
            const newProductosResults = document.getElementById('newProductosResults');
            
            if (newVendedoresResults) newVendedoresResults.style.display = 'none';
            if (newServiciosResults) newServiciosResults.style.display = 'none';
            if (newProductosResults) newProductosResults.style.display = 'none';
            
            // Inicializar búsquedas si no están inicializadas
            if (window.empleados && window.empleados.length > 0 && window.inicializarBusquedaVendedores) {
                window.inicializarBusquedaVendedores('new');
            }
            if (window.todosLosServicios && window.todosLosServicios.length > 0 && window.inicializarBusquedaServicios) {
                window.inicializarBusquedaServicios('new');
            }
            if (window.todosLosProductos && window.todosLosProductos.length > 0 && window.inicializarBusquedaProductos) {
                window.inicializarBusquedaProductos('new');
            }
            // Inicializar búsqueda de plagas
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('new');
            }
            // Inicializar búsqueda de equipo
            if (!window.todosLosEquipos || window.todosLosEquipos.length === 0) {
                await window.cargarEquipo();
            }
            if (window.inicializarBusquedaEquipo) {
                window.inicializarBusquedaEquipo('new');
            }
            
            // Limpiar campo de certificados
            const newCertificados = document.getElementById('newCertificados');
            if (newCertificados) newCertificados.value = '';
            
            // Llenar provincias en el formulario de nueva cita
            if (window.llenarProvinciasNew) {
                llenarProvinciasNew();
            }
            
            // Habilitar switch Confirmada 24-48h si la fecha prellenada está dentro de 48h
            if (window.actualizarHabilitacionConfirmada24_48New) window.actualizarHabilitacionConfirmada24_48New();
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('nuevaCitaModal'));
            modal.show();
            
            // Actualizar resumen financiero cuando el modal se muestre
            const modalElement = document.getElementById('nuevaCitaModal');
            if (modalElement) {
                const actualizarResumenOnShow = () => {
                    setTimeout(() => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                        // Calcular y mostrar hora de fin
                        window.calcularHoraFin('new');
                    }, 300);
                };
                modalElement.addEventListener('shown.bs.modal', actualizarResumenOnShow, { once: true });
            }
            
            // Agregar event listeners para actualizar hora de fin automáticamente
            setTimeout(() => {
                const newStartTimeInput = document.getElementById('newStartTime');
                const newDurationSelect = document.getElementById('newDuration');
                
                if (newStartTimeInput) {
                    const newStartTimeHandler = () => {
                        window.calcularHoraFin('new');
                        if (window.actualizarHabilitacionConfirmada24_48New) window.actualizarHabilitacionConfirmada24_48New();
                    };
                    newStartTimeInput.removeEventListener('change', window._newStartTimeHandler);
                    newStartTimeInput.removeEventListener('input', window._newStartTimeHandler);
                    window._newStartTimeHandler = newStartTimeHandler;
                    newStartTimeInput.addEventListener('change', window._newStartTimeHandler);
                    newStartTimeInput.addEventListener('input', window._newStartTimeHandler);
                }
                
                if (newDurationSelect) {
                    const newDurationHandler = () => window.calcularHoraFin('new');
                    newDurationSelect.removeEventListener('change', window._newDurationHandler);
                    window._newDurationHandler = newDurationHandler;
                    newDurationSelect.addEventListener('change', window._newDurationHandler);
                }
            }, 100);
            
            // Agregar event listeners para actualizar resumen financiero
            setTimeout(() => {
                const newMontoVentaInput = document.getElementById('newMontoVenta');
                if (newMontoVentaInput) {
                    // Detectar cuando el usuario empieza a editar manualmente
                    newMontoVentaInput.addEventListener('focus', () => {
                        // No activar el flag todavía, solo cuando presione Enter
                    });
                    
                    // Detectar cuando el usuario presiona Enter para confirmar valor manual
                    newMontoVentaInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            // Activar modo manual y formatear el valor
                            const valorNumerico = window.extraerValorNumerico(newMontoVentaInput.value);
                            if (valorNumerico !== null && !isNaN(valorNumerico)) {
                                newMontoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                                window.editandoMontoVentaManual.new = true;
                                // Actualizar resumen financiero con el valor manual
                                if (window.actualizarResumenFinancieroNew) {
                                    window.actualizarResumenFinancieroNew();
                                }
                            }
                            newMontoVentaInput.blur();
                        }
                    });
                    
                    // Detectar cuando el usuario termina de editar (sin Enter)
                    newMontoVentaInput.addEventListener('blur', () => {
                        // Si no se presionó Enter, volver a modo automático
                        if (!window.editandoMontoVentaManual.new) {
                            // Formatear el valor al perder el foco
                            const valorNumerico = window.extraerValorNumerico(newMontoVentaInput.value);
                            if (valorNumerico !== '') {
                                newMontoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                            }
                            // Recalcular automáticamente
                            window.calcularMontoVenta('new');
                            if (window.actualizarResumenFinancieroNew) {
                                window.actualizarResumenFinancieroNew();
                            }
                        } else {
                            // Si se presionó Enter, solo formatear sin recalcular
                            const valorNumerico = window.extraerValorNumerico(newMontoVentaInput.value);
                            if (valorNumerico !== '') {
                                newMontoVentaInput.value = window.formatearMontoVenta(valorNumerico);
                            }
                            if (window.actualizarResumenFinancieroNew) {
                                window.actualizarResumenFinancieroNew();
                            }
                        }
                    });
                    newMontoVentaInput.addEventListener('input', () => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                        // actualizarEncabezadoAutoNuevaCita(); // Función eliminada - encabezado removido
                    });
                }
                
                // Stub: función de encabezado automático fue removida; se deja para no romper listeners
                function actualizarEncabezadoAutoNuevaCita() {}
                
                // Event listeners para actualizar encabezado automático
                const newClientNameInput = document.getElementById('newClientName');
                if (newClientNameInput) {
                    newClientNameInput.addEventListener('input', actualizarEncabezadoAutoNuevaCita);
                }
                
                // Event listeners para provincia, cantón y distrito en formulario nueva cita
                const newProvinciaSelect = document.getElementById('newProvincia');
                if (newProvinciaSelect) {
                    newProvinciaSelect.addEventListener('change', function() {
                        const provinciaId = this.value;
                        
                        if (!provinciaId) {
                            const selectCanton = document.getElementById('newCanton');
                            const selectDistrito = document.getElementById('newDistrito');
                            if (selectCanton) {
                                selectCanton.innerHTML = '<option value="">Primero seleccione una provincia</option>';
                                selectCanton.disabled = true;
                            }
                            if (selectDistrito) {
                                selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                                selectDistrito.disabled = true;
                            }
                            return;
                        }
                        
                        // Llenar cantones
                        llenarCantonesNew(provinciaId);
                        
                        // Limpiar selección de distrito
                        const selectDistrito = document.getElementById('newDistrito');
                        if (selectDistrito) {
                            selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                            selectDistrito.disabled = true;
                        }
                    });
                }
                
                const newCantonSelect = document.getElementById('newCanton');
                if (newCantonSelect) {
                    newCantonSelect.addEventListener('change', function() {
                        const provinciaId = newProvinciaSelect ? newProvinciaSelect.value : null;
                        const cantonId = this.value;
                        
                        if (!cantonId) {
                            const selectDistrito = document.getElementById('newDistrito');
                            if (selectDistrito) {
                                selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                                selectDistrito.disabled = true;
                            }
                            return;
                        }
                        
                        // Llenar distritos
                        llenarDistritosNew(provinciaId, cantonId);
                    });
                }
                
                const newDistritoSelect = document.getElementById('newDistrito');
                if (newDistritoSelect) {
                    newDistritoSelect.addEventListener('change', function() {
                        // El distrito se seleccionó, no hay acción adicional necesaria
                        // pero se puede usar para actualizar el mapa si es necesario
                    });
                }
                
                // Observar cambios en vendedores seleccionados usando MutationObserver
                const newVendedoresSelected = document.getElementById('newVendedoresSelected');
                if (newVendedoresSelected) {
                    const observer = new MutationObserver(() => {
                        actualizarEncabezadoAutoNuevaCita();
                    });
                    observer.observe(newVendedoresSelected, { childList: true, subtree: true });
                }
                
                // Actualizar encabezado inicial
                actualizarEncabezadoAutoNuevaCita();
            }, 500);
        }

        // Función para abrir modal de nueva cita desde arrastre
        async function abrirModalNuevaCitaDesdeArrastre(fechaInicio, duracion, day, month, year) {
            // Prellenar campos del formulario
            const newStartTime = document.getElementById('newStartTime');
            const newDuration = document.getElementById('newDuration');
            const newRuta = document.getElementById('newRuta');
            
            if (newStartTime) newStartTime.value = fechaInicio;
            if (newDuration) {
                // Seleccionar la opción más cercana
                const opcionesDuracion = [15, 30, 45, 60, 75, 90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345, 360, 375, 390, 405, 420, 435, 450, 465, 480, 540, 600, 660, 720];
                let duracionSeleccionada = 60; // Valor por defecto
                for (let i = 0; i < opcionesDuracion.length; i++) {
                    if (duracion <= opcionesDuracion[i]) {
                        duracionSeleccionada = opcionesDuracion[i];
                        break;
                    }
                }
                if (duracion > 720) duracionSeleccionada = 720;
                newDuration.value = duracionSeleccionada;
            }
            if (newRuta) newRuta.value = 'Sin asignar'; // Ruta por defecto
            
            // Limpiar otros campos (solo los que existen)
            const newClientName = document.getElementById('newClientName');
            const newClientPhone = document.getElementById('newClientPhone');
            const newCoordenadas = document.getElementById('newCoordenadas');
            const newOtrasSenas = document.getElementById('newOtrasSenas');
            const newConfirmada24_48 = document.getElementById('newConfirmada24_48');
            const newConfirmada24_48Msg = document.getElementById('newConfirmada24_48Mensaje');
            const newConfirmada24_48Ts = document.getElementById('newConfirmada24_48Timestamp');
            const newMontoVenta = document.getElementById('newMontoVenta');
            const newDescription = document.getElementById('newDescription');
            
            if (newClientName) newClientName.value = '';
            if (newClientPhone) newClientPhone.value = '';
            if (newCoordenadas) newCoordenadas.value = '';
            if (newOtrasSenas) newOtrasSenas.value = '';
            if (newConfirmada24_48) { newConfirmada24_48.checked = false; newConfirmada24_48.disabled = true; }
            if (newConfirmada24_48Msg) newConfirmada24_48Msg.textContent = '';
            if (newConfirmada24_48Ts) { newConfirmada24_48Ts.textContent = ''; newConfirmada24_48Ts.style.display = 'none'; }
            if (newMontoVenta) newMontoVenta.value = '';
            if (newDescription) newDescription.value = '';
            
            // Limpiar selecciones de vendedores, servicios, productos y plagas
            window.vendedoresSeleccionadosNew = [];
            window.serviciosSeleccionadosNew = [];
            window.productosSeleccionadosNew = [];
            window.plagasSeleccionadasNew = [];
            
            const newVendedoresSelected = document.getElementById('newVendedoresSelected');
            const newServiciosSelected = document.getElementById('newServiciosSelected');
            const newProductosSelected = document.getElementById('newProductosSelected');
            
            if (newVendedoresSelected) newVendedoresSelected.innerHTML = '';
            // Renderizar tabla de servicios (vacía inicialmente)
            if (window.renderizarTablaServicios) {
                window.renderizarTablaServicios('new');
            }
            if (window.renderizarTablaProductos) {
                window.renderizarTablaProductos('new');
            }
            
            // Limpiar campos de búsqueda
            const newVendedorSearch = document.getElementById('newVendedorSearch');
            const newServicioSearch = document.getElementById('newServicioSearch');
            const newProductoSearch = document.getElementById('newProductoSearch');
            
            if (newVendedorSearch) newVendedorSearch.value = '';
            if (newServicioSearch) newServicioSearch.value = '';
            if (newProductoSearch) newProductoSearch.value = '';
            
            // Ocultar resultados de búsqueda
            const newVendedoresResults = document.getElementById('newVendedoresResults');
            const newServiciosResults = document.getElementById('newServiciosResults');
            const newProductosResults = document.getElementById('newProductosResults');
            
            if (newVendedoresResults) newVendedoresResults.style.display = 'none';
            if (newServiciosResults) newServiciosResults.style.display = 'none';
            if (newProductosResults) newProductosResults.style.display = 'none';
            
            // Inicializar búsquedas si no están inicializadas
            if (window.empleados && window.empleados.length > 0 && window.inicializarBusquedaVendedores) {
                window.inicializarBusquedaVendedores('new');
            }
            if (window.todosLosServicios && window.todosLosServicios.length > 0 && window.inicializarBusquedaServicios) {
                window.inicializarBusquedaServicios('new');
            }
            if (window.todosLosProductos && window.todosLosProductos.length > 0 && window.inicializarBusquedaProductos) {
                window.inicializarBusquedaProductos('new');
            }
            // Inicializar búsqueda de plagas
            if (window.inicializarBusquedaPlagas) {
                window.inicializarBusquedaPlagas('new');
            }
            // Inicializar búsqueda de equipo
            if (!window.todosLosEquipos || window.todosLosEquipos.length === 0) {
                await window.cargarEquipo();
            }
            if (window.inicializarBusquedaEquipo) {
                window.inicializarBusquedaEquipo('new');
            }
            
            // Limpiar campo de certificados
            const newCertificados = document.getElementById('newCertificados');
            if (newCertificados) newCertificados.value = '';
            
            // Llenar provincias en el formulario de nueva cita
            if (window.llenarProvinciasNew) {
                llenarProvinciasNew();
            }
            
            // Habilitar switch Confirmada 24-48h si la fecha prellenada está dentro de 48h
            if (window.actualizarHabilitacionConfirmada24_48New) window.actualizarHabilitacionConfirmada24_48New();
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('nuevaCitaModal'));
            modal.show();
            
            // Actualizar resumen financiero cuando el modal se muestre
            const modalElement = document.getElementById('nuevaCitaModal');
            if (modalElement) {
                const actualizarResumenOnShow = () => {
                    setTimeout(() => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                        // Calcular y mostrar hora de fin
                        window.calcularHoraFin('new');
                    }, 300);
                };
                modalElement.addEventListener('shown.bs.modal', actualizarResumenOnShow, { once: true });
            }
            
            // Agregar event listeners para actualizar hora de fin automáticamente
            setTimeout(() => {
                const newStartTimeInput = document.getElementById('newStartTime');
                const newDurationSelect = document.getElementById('newDuration');
                
                if (newStartTimeInput) {
                    const newStartTimeHandler = () => {
                        window.calcularHoraFin('new');
                        if (window.actualizarHabilitacionConfirmada24_48New) window.actualizarHabilitacionConfirmada24_48New();
                    };
                    newStartTimeInput.removeEventListener('change', window._newStartTimeHandler);
                    newStartTimeInput.removeEventListener('input', window._newStartTimeHandler);
                    window._newStartTimeHandler = newStartTimeHandler;
                    newStartTimeInput.addEventListener('change', window._newStartTimeHandler);
                    newStartTimeInput.addEventListener('input', window._newStartTimeHandler);
                }
                
                if (newDurationSelect) {
                    const newDurationHandler = () => window.calcularHoraFin('new');
                    newDurationSelect.removeEventListener('change', window._newDurationHandler);
                    window._newDurationHandler = newDurationHandler;
                    newDurationSelect.addEventListener('change', window._newDurationHandler);
                }
            }, 100);
            
            // Agregar event listeners para actualizar resumen financiero
            setTimeout(() => {
                const newMontoVentaInput = document.getElementById('newMontoVenta');
                if (newMontoVentaInput) {
                    newMontoVentaInput.addEventListener('input', () => {
                        if (window.actualizarResumenFinancieroNew) {
                            window.actualizarResumenFinancieroNew();
                        }
                    });
                }
                
                }, 500);
        }
        
        const btnDescargarProforma = document.getElementById('btnDescargarProforma');
        if (btnDescargarProforma) {
            btnDescargarProforma.addEventListener('click', async () => {
                btnDescargarProforma.disabled = true;
                btnDescargarProforma.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
                try {
                    await window.generarProformaPNG();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al generar la proforma: ' + error.message);
                } finally {
                    btnDescargarProforma.disabled = false;
                    btnDescargarProforma.innerHTML = '<i class="fas fa-download me-2"></i>Descargar Proforma PNG';
                }
            });
        }
        
        // Event listener para actualizar turno automáticamente cuando cambie la hora
        // Campo editTurno eliminado - este listener ya no es necesario

        // Event listeners para vistas
        // Event listener para Cronograma - ELIMINADO (botón removido del menú)
        // const btnVistaCronograma = document.getElementById('btnVistaCronograma');
        // if (btnVistaCronograma) {
        //     btnVistaCronograma.addEventListener('click', async () => {
        //         await cambiarVista('cronograma');
        //         const menuHamburguesa = document.getElementById('menuHamburguesa');
        //         if (menuHamburguesa) menuHamburguesa.style.display = 'none';
        //     });
        // }
        
        // Event listener para toggle de vista compacta
        // Event listeners para navegación de semana
        const btnSemanaAnterior = document.getElementById('btnSemanaAnterior');
        const btnSemanaSiguiente = document.getElementById('btnSemanaSiguiente');
        
        if (btnSemanaAnterior) {
            btnSemanaAnterior.addEventListener('click', async () => {
                try {
                    console.log('⬅️ [CALENDARIO] Navegando semana anterior...');
                    if (!semanaActual) {
                        semanaActual = obtenerLunesSemana(new Date());
                    }
                    semanaActual.setDate(semanaActual.getDate() - 7);
                    console.log('📅 [CALENDARIO] Nueva semana actual:', semanaActual);
                    
                    // Actualizar botones de días para mostrar la nueva semana (siempre)
                    if (diaSeleccionado) {
                        console.log('🔄 [CALENDARIO] Regenerando botones de días...');
                        generarBotonesDiasMes(diaSeleccionado);
                        console.log('✅ [CALENDARIO] Botones de días regenerados');
                    }
                    
                    // Actualizar cronograma si está en vista cronograma
                    if (vistaActual === 'cronograma') {
                        console.log('🔄 [CALENDARIO] Regenerando cronograma...');
                        await generarCronograma();
                        console.log('✅ [CALENDARIO] Cronograma regenerado');
                    }
                } catch (error) {
                    console.error('❌ [CALENDARIO] Error navegando semana anterior:', error);
                }
            });
        }
        
        if (btnSemanaSiguiente) {
            btnSemanaSiguiente.addEventListener('click', async () => {
                try {
                    console.log('➡️ [CALENDARIO] Navegando semana siguiente...');
                    if (!semanaActual) {
                        semanaActual = obtenerLunesSemana(new Date());
                    }
                    semanaActual.setDate(semanaActual.getDate() + 7);
                    console.log('📅 [CALENDARIO] Nueva semana actual:', semanaActual);
                    
                    // Actualizar botones de días para mostrar la nueva semana (siempre)
                    if (diaSeleccionado) {
                        console.log('🔄 [CALENDARIO] Regenerando botones de días...');
                        generarBotonesDiasMes(diaSeleccionado);
                        console.log('✅ [CALENDARIO] Botones de días regenerados');
                    }
                    
                    // Actualizar cronograma si está en vista cronograma
                    if (vistaActual === 'cronograma') {
                        console.log('🔄 [CALENDARIO] Regenerando cronograma...');
                        await generarCronograma();
                        console.log('✅ [CALENDARIO] Cronograma regenerado');
                    }
                } catch (error) {
                    console.error('❌ [CALENDARIO] Error navegando semana siguiente:', error);
                }
            });
        }
        
        // Event listener para botón "Actualizar" en Técnicos Sin Asignar
        const btnActualizarTecnicos = document.getElementById('btnActualizarTecnicos');
        if (btnActualizarTecnicos) {
            btnActualizarTecnicos.addEventListener('click', async () => {
                try {
                    btnActualizarTecnicos.disabled = true;
                    btnActualizarTecnicos.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
                    await window.actualizarTecnicosSinAsignar();
                } catch (error) {
                    console.error('Error actualizando técnicos:', error);
                } finally {
                    btnActualizarTecnicos.disabled = false;
                    btnActualizarTecnicos.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Actualizar';
                }
            });
        }
        
        // Event listener para botón "Actualizar" en Vehículos Sin Asignar
        const btnActualizarVehiculos = document.getElementById('btnActualizarVehiculos');
        if (btnActualizarVehiculos) {
            btnActualizarVehiculos.addEventListener('click', async () => {
                try {
                    btnActualizarVehiculos.disabled = true;
                    btnActualizarVehiculos.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
                    await window.actualizarVehiculosSinAsignar();
                } catch (error) {
                    console.error('Error actualizando vehículos:', error);
                } finally {
                    btnActualizarVehiculos.disabled = false;
                    btnActualizarVehiculos.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Actualizar';
                }
            });
        }
        
        // Botón de vista compacta eliminado - siempre usar vista extendida
        const btnToggleVistaCompacta = null;
        if (false && btnToggleVistaCompacta) {
            // Event listener deshabilitado - siempre usar vista extendida
            btnToggleVistaCompacta.addEventListener('click', async () => {
                const estaActiva = btnToggleVistaCompacta.classList.contains('active');
                
                if (estaActiva) {
                    // Cambiar de vista total a vista compacta
                    btnToggleVistaCompacta.classList.remove('active');
                    btnToggleVistaCompacta.style.background = '#6c757d';
                    btnToggleVistaCompacta.innerHTML = '<i class="fas fa-compress-alt me-2"></i>Vista Compacta';
                    
                    // Actualizar botones de días para mostrar solo el día seleccionado
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    } else {
                        // Si no hay día seleccionado, usar el día actual
                        const hoy = new Date();
                        diaSeleccionado = hoy;
                        generarBotonesDiasMes(hoy);
                    }
                    // Regenerar cronograma para mostrar vista compacta
                    await generarCronograma();
                } else {
                    // Cambiar de vista compacta a vista total
                    btnToggleVistaCompacta.classList.add('active');
                    btnToggleVistaCompacta.style.background = '#4CAF50';
                    btnToggleVistaCompacta.innerHTML = '<i class="fas fa-expand-alt me-2"></i>Vista Total';
                    
                    // Actualizar botones de días para mostrar todos los días del mes
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    }
                    
                    // Restaurar vista total: mostrar todas las horas y restaurar altura
                    const restaurarVistaTotal = (contenedorId) => {
                        const contenedor = document.getElementById(contenedorId);
                        if (!contenedor) return;
                        const columnas = contenedor.querySelectorAll('.vehiculo-columna-cronograma');
                        columnas.forEach(columna => {
                            const timeline = columna.querySelector('.citas-timeline');
                            if (!timeline) return;
                            
                            // Restaurar altura original (24h = 5am a 5am del día siguiente)
                            timeline.style.height = '960px';
                            timeline.style.minHeight = '960px';
                            timeline.style.overflow = 'visible';
                            
                            // Restaurar marcadores de hora
                            const marcadores = timeline.querySelectorAll('.marcador-hora-timeline');
                            marcadores.forEach(m => {
                                m.style.display = 'block';
                                // Restaurar posición original (se recalcula desde minutos)
                                const minutosDesdeMedianoche = parseFloat(m.getAttribute('data-minutos-original')) || (parseFloat(m.style.top) || 0) / 40 * 60; // 40px por hora = 1cm
                                m.style.top = `${(minutosDesdeMedianoche / 60) * 40}px`;
                            });
                            
                            // Restaurar líneas divisorias
                            const lineas = timeline.querySelectorAll('.linea-divisoria-hora');
                            lineas.forEach(l => {
                                l.style.display = 'block';
                                // Restaurar posición original
                                const minutosDesdeMedianoche = parseFloat(l.getAttribute('data-minutos-original')) || (parseFloat(l.style.top) || 0) / 40 * 60; // 40px por hora = 1cm
                                l.style.top = `${(minutosDesdeMedianoche / 60) * 40}px`;
                            });
                            
                            // Las citas se reposicionan automáticamente al regenerar el cronograma
                        });
                    };
                    
                    // Regenerar cronograma para restaurar posiciones originales
                    await generarCronograma();
                    // Actualizar botones de días para mostrar todo el mes
                    if (diaSeleccionado) {
                        generarBotonesDiasMes(diaSeleccionado);
                    }
                }
                
                // Colapsar filas de horas fuera del rango (solo si estamos en vista compacta)
                const estaEnVistaCompactaDespues = !btnToggleVistaCompacta.classList.contains('active');
                if (estaEnVistaCompactaDespues) {
                    // Colapsar filas de horas fuera del rango
                    if (window.rangosHoras) {
                        const colapsarFilasHoras = (contenedorId, minutosInicio, minutosFin) => {
                            if (minutosInicio === null || minutosFin === null) return;
                            
                            const contenedor = document.getElementById(contenedorId);
                            if (!contenedor) return;
                            
                            // Calcular altura del timeline en vista compacta
                            const minutosTotales = minutosFin - minutosInicio;
                            const alturaTimeline = (minutosTotales / 60) * 40; // 40px por hora = 1cm
                            const offsetTop = (minutosInicio / 60) * 40; // 40px por hora = 1cm
                            
                            const columnas = contenedor.querySelectorAll('.vehiculo-columna-cronograma');
                            columnas.forEach(columna => {
                                const timeline = columna.querySelector('.citas-timeline');
                                if (!timeline) return;
                                
                                // Ajustar altura del timeline
                                timeline.style.height = `${alturaTimeline}px`;
                                timeline.style.minHeight = `${alturaTimeline}px`;
                                timeline.style.overflow = 'hidden';
                                
                                // Reposicionar marcadores de hora
                                const marcadores = timeline.querySelectorAll('.marcador-hora-timeline');
                                marcadores.forEach(marcador => {
                                    const topOriginal = parseFloat(marcador.style.top) || 0;
                                    const minutosDesde5AM = (topOriginal / 33) * 60; // Ya está en minutos desde 5 AM
                                    if (minutosDesde5AM < minutosInicio || minutosDesde5AM > minutosFin) {
                                        marcador.style.display = 'none';
                                    } else {
                                        marcador.style.display = 'block';
                                        const nuevoTop = topOriginal - offsetTop;
                                        marcador.style.top = `${nuevoTop}px`;
                                    }
                                });
                                
                                // Reposicionar líneas divisorias
                                const lineas = timeline.querySelectorAll('.linea-divisoria-hora');
                                lineas.forEach(linea => {
                                    const topOriginal = parseFloat(linea.style.top) || 0;
                                    const minutosDesde5AM = (topOriginal / 33) * 60; // Ya está en minutos desde 5 AM
                                    if (minutosDesde5AM < minutosInicio || minutosDesde5AM > minutosFin) {
                                        linea.style.display = 'none';
                                    } else {
                                        linea.style.display = 'block';
                                        const nuevoTop = topOriginal - offsetTop;
                                        linea.style.top = `${nuevoTop}px`;
                                    }
                                });
                                
                                // Reposicionar u ocultar citas
                                const citas = timeline.querySelectorAll('.cita-bloque');
                                citas.forEach(cita => {
                                    const topOriginal = parseFloat(cita.style.top) || 0;
                                    const alturaCita = parseFloat(cita.style.height) || 0;
                                    const minutosCitaInicio = (topOriginal / 33) * 60; // Ya está en minutos desde 5 AM
                                    const minutosCitaFin = minutosCitaInicio + (alturaCita / 33) * 60;
                                    
                                    // Verificar si la cita está dentro del rango visible (o se superpone)
                                    if (minutosCitaFin >= minutosInicio && minutosCitaInicio <= minutosFin) {
                                        // La cita está dentro o se superpone con el rango visible
                                        cita.style.display = 'block';
                                        const nuevoTop = topOriginal - offsetTop;
                                        cita.style.top = `${nuevoTop}px`;
                                    } else {
                                        // La cita está completamente fuera del rango visible
                                        cita.style.display = 'none';
                                    }
                                });
                            });
                        };
                        
                        colapsarFilasHoras('vehiculosCronogramaDiurnas', window.rangosHoras.diurnas.inicio, window.rangosHoras.diurnas.fin);
                        colapsarFilasHoras('vehiculosCronogramaNocturnas', window.rangosHoras.nocturnas.inicio, window.rangosHoras.nocturnas.fin);
                    }
                }
            });
        }
        

        // Event listeners del reporte táctico removidos - ahora está en reporte_tactico.html
        
        // Menú hamburguesa
        const btnMenuHamburguesa = document.getElementById('btnMenuHamburguesa');
        const menuHamburguesa = document.getElementById('menuHamburguesa');
        
        if (btnMenuHamburguesa && menuHamburguesa) {
            btnMenuHamburguesa.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = menuHamburguesa.style.display === 'block';
                menuHamburguesa.style.display = isVisible ? 'none' : 'block';
            });
            
            // Cerrar menú al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!btnMenuHamburguesa.contains(e.target) && !menuHamburguesa.contains(e.target)) {
                    menuHamburguesa.style.display = 'none';
                }
            });
            
            // Cerrar menú al hacer clic en cualquier botón del menú
            const botonesMenu = menuHamburguesa.querySelectorAll('button');
            botonesMenu.forEach(btn => {
                btn.addEventListener('click', () => {
                    menuHamburguesa.style.display = 'none';
                });
            });
        }
        
        // Event listener para pre-cargar citas - ELIMINADO

        // Event listeners para cargar CSV
        const btnCargarCSV = document.getElementById('btnCargarCSV');
        const inputCSV = document.getElementById('inputCSV');
        
        if (btnCargarCSV) {
            btnCargarCSV.addEventListener('click', cargarCitasDesdeCSV);
        }
        
        if (inputCSV) {
            inputCSV.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    procesarArchivoCSV(e.target.files[0]);
                }
            });
        }
        
        // Event listeners para actualizar desde CSV
        const btnActualizarCSV = document.getElementById('btnActualizarCSV');
        const inputCSVActualizar = document.getElementById('inputCSVActualizar');
        
        if (btnActualizarCSV) {
            btnActualizarCSV.addEventListener('click', () => {
                if (inputCSVActualizar) {
                    inputCSVActualizar.click();
                }
            });
        }
        
        if (inputCSVActualizar) {
            inputCSVActualizar.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    procesarArchivoCSVActualizar(e.target.files[0]);
                }
            });
        }
        
        // Event listeners para Google Sheets
        const btnCargarGoogleSheets = document.getElementById('btnCargarGoogleSheets');
        const btnActualizarGoogleSheets = document.getElementById('btnActualizarGoogleSheets');
        
        if (btnCargarGoogleSheets) {
            btnCargarGoogleSheets.addEventListener('click', () => {
                solicitarURLGoogleSheets(false); // false = cargar (no actualizar)
            });
        }
        
        if (btnActualizarGoogleSheets) {
            btnActualizarGoogleSheets.addEventListener('click', () => {
                solicitarURLGoogleSheets(true); // true = actualizar
            });
        }
        
        // Botón para actualizar desde Google Sheets oficial (URL predefinida)
        const btnActualizarGoogleSheetsAuto = document.getElementById('btnActualizarGoogleSheetsAuto');
        if (btnActualizarGoogleSheetsAuto) {
            btnActualizarGoogleSheetsAuto.addEventListener('click', () => {
                // URL oficial de Google Sheets - Hoja "vaciado" (gid=0)
                const urlOficial = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhFnfEHF0IuYIhXM8FWaPjbHqUFbdYpzWTd6Fs_xm8VZgEp-MnVBrIdscsbk-owo5ID3g1hbmBAvBe/pubhtml?gid=0&single=true';
                const urlCSV = convertirURLGoogleSheetsACSV(urlOficial);
                if (urlCSV) {
                    procesarGoogleSheetsActualizar(urlCSV);
                } else {
                    alert('Error: No se pudo convertir la URL de Google Sheets');
                }
            });
        }

        // Event listener para eliminar todas las citas
        const btnEliminarTodasCitas = document.getElementById('btnEliminarTodasCitas');
        if (btnEliminarTodasCitas) {
            btnEliminarTodasCitas.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('modalEliminarCitas'));
                modal.show();
            });
        }
        
        // Lógica del modal de eliminación
        const tipoEliminacion = document.getElementById('tipoEliminacion');
        const opcionesRango = document.getElementById('opcionesRango');
        const opcionesMayor = document.getElementById('opcionesMayor');
        const opcionesMenor = document.getElementById('opcionesMenor');
        const vistaPreviaEliminacion = document.getElementById('vistaPreviaEliminacion');
        const textoVistaPrevia = document.getElementById('textoVistaPrevia');
        const btnConfirmarEliminacion = document.getElementById('btnConfirmarEliminacion');
        
        if (tipoEliminacion) {
            tipoEliminacion.addEventListener('change', () => {
                const tipo = tipoEliminacion.value;
                
                // Ocultar todas las opciones
                if (opcionesRango) opcionesRango.style.display = 'none';
                if (opcionesMayor) opcionesMayor.style.display = 'none';
                if (opcionesMenor) opcionesMenor.style.display = 'none';
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
                
                // Mostrar opciones según el tipo
                if (tipo === 'rango' && opcionesRango) {
                    opcionesRango.style.display = 'block';
                } else if (tipo === 'mayor' && opcionesMayor) {
                    opcionesMayor.style.display = 'block';
                } else if (tipo === 'menor' && opcionesMenor) {
                    opcionesMenor.style.display = 'block';
                }
                
                // Actualizar vista previa
                actualizarVistaPreviaEliminacion();
            });
        }
        
        // Actualizar vista previa cuando cambian las fechas
        const fechaInicioRango = document.getElementById('fechaInicioRango');
        const fechaFinRango = document.getElementById('fechaFinRango');
        const fechaMayor = document.getElementById('fechaMayor');
        const fechaMenor = document.getElementById('fechaMenor');
        
        if (fechaInicioRango) fechaInicioRango.addEventListener('change', actualizarVistaPreviaEliminacion);
        if (fechaFinRango) fechaFinRango.addEventListener('change', actualizarVistaPreviaEliminacion);
        if (fechaMayor) fechaMayor.addEventListener('change', actualizarVistaPreviaEliminacion);
        if (fechaMenor) fechaMenor.addEventListener('change', actualizarVistaPreviaEliminacion);
        
        function actualizarVistaPreviaEliminacion() {
            const tipo = tipoEliminacion?.value;
            if (!tipo) {
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
                return;
            }
            
            let texto = '';
            if (tipo === 'todas') {
                texto = 'Se eliminarán <strong>TODAS</strong> las citas de la base de datos.';
            } else if (tipo === 'rango') {
                const inicio = fechaInicioRango?.value;
                const fin = fechaFinRango?.value;
                if (inicio && fin) {
                    texto = `Se eliminarán todas las citas cuya fecha de inicio esté entre <strong>${inicio}</strong> y <strong>${fin}</strong> (inclusive).`;
                } else {
                    texto = 'Complete las fechas para ver la vista previa.';
                }
            } else if (tipo === 'mayor') {
                const fecha = fechaMayor?.value;
                if (fecha) {
                    texto = `Se eliminarán todas las citas cuya fecha de inicio sea mayor o igual a <strong>${fecha}</strong> (inclusive).`;
                } else {
                    texto = 'Complete la fecha para ver la vista previa.';
                }
            } else if (tipo === 'menor') {
                const fecha = fechaMenor?.value;
                if (fecha) {
                    texto = `Se eliminarán todas las citas cuya fecha de inicio sea menor o igual a <strong>${fecha}</strong> (inclusive).`;
                } else {
                    texto = 'Complete la fecha para ver la vista previa.';
                }
            }
            
            if (texto && textoVistaPrevia) {
                textoVistaPrevia.innerHTML = texto;
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'block';
            } else {
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
            }
        }
        
        // Event listener para confirmar eliminación
        if (btnConfirmarEliminacion) {
            btnConfirmarEliminacion.addEventListener('click', async () => {
                const tipo = tipoEliminacion?.value;
                if (!tipo) {
                    alert('Por favor, seleccione un tipo de eliminación.');
                    return;
                }
                
                // Validar fechas según el tipo
                if (tipo === 'rango') {
                    const inicio = fechaInicioRango?.value;
                    const fin = fechaFinRango?.value;
                    if (!inicio || !fin) {
                        alert('Por favor, complete ambas fechas del rango.');
                        return;
                    }
                    if (new Date(inicio) > new Date(fin)) {
                        alert('La fecha de inicio no puede ser mayor que la fecha de fin.');
                        return;
                    }
                } else if (tipo === 'mayor') {
                    if (!fechaMayor?.value) {
                        alert('Por favor, complete la fecha límite.');
                        return;
                    }
                } else if (tipo === 'menor') {
                    if (!fechaMenor?.value) {
                        alert('Por favor, complete la fecha límite.');
                        return;
                    }
                }
                
                // Confirmación
                let mensajeConfirmacion = '';
                if (tipo === 'todas') {
                    mensajeConfirmacion = '⚠️ ADVERTENCIA: Esta acción eliminará TODAS las citas de la base de datos.\n\nEsta acción NO se puede deshacer.\n\n¿Estás seguro de que deseas continuar?';
                } else if (tipo === 'rango') {
                    mensajeConfirmacion = `⚠️ ADVERTENCIA: Esta acción eliminará todas las citas entre ${fechaInicioRango.value} y ${fechaFinRango.value}.\n\nEsta acción NO se puede deshacer.\n\n¿Estás seguro de que deseas continuar?`;
                } else if (tipo === 'mayor') {
                    mensajeConfirmacion = `⚠️ ADVERTENCIA: Esta acción eliminará todas las citas mayores o iguales a ${fechaMayor.value}.\n\nEsta acción NO se puede deshacer.\n\n¿Estás seguro de que deseas continuar?`;
                } else if (tipo === 'menor') {
                    mensajeConfirmacion = `⚠️ ADVERTENCIA: Esta acción eliminará todas las citas menores o iguales a ${fechaMenor.value}.\n\nEsta acción NO se puede deshacer.\n\n¿Estás seguro de que deseas continuar?`;
                }
                
                if (!confirm(mensajeConfirmacion)) {
                    return;
                }
                
                // Ejecutar eliminación
                await eliminarCitasPorFiltro(tipo);
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminarCitas'));
                if (modal) {
                    modal.hide();
                }
                
                // Limpiar formulario
                if (tipoEliminacion) tipoEliminacion.value = '';
                if (fechaInicioRango) fechaInicioRango.value = '';
                if (fechaFinRango) fechaFinRango.value = '';
                if (fechaMayor) fechaMayor.value = '';
                if (fechaMenor) fechaMenor.value = '';
                if (vistaPreviaEliminacion) vistaPreviaEliminacion.style.display = 'none';
            });
        }
        
        // Event listener para descargar CSV de ubicaciones
        // Event listener para descargar ubicaciones CSV - ELIMINADO
        // const btnDescargarUbicacionesCSV = document.getElementById('btnDescargarUbicacionesCSV');
        
        // Función para abrir modal de migración desde una ruta específica
        window.abrirModalMigrarRuta = function(rutaOrigen, fechaFormateada) {
            const rutaOrigenInput = document.getElementById('rutaOrigenMigrar');
            const fechaDiaInput = document.getElementById('fechaDiaMigrar');
            const previewDiv = document.getElementById('previewMigracion');
            const btnConfirmar = document.getElementById('btnConfirmarMigracion');
            
            if (!rutaOrigenInput || !fechaDiaInput) {
                console.error('Elementos del modal no encontrados');
                return;
            }
            
            rutaOrigenInput.value = rutaOrigen;
            fechaDiaInput.value = fechaFormateada || '';
            if (previewDiv) previewDiv.style.display = 'none';
            if (btnConfirmar) btnConfirmar.disabled = true;
            
            const modalElement = document.getElementById('modalMigrarRutas');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('Modal modalMigrarRutas no encontrado');
            }
        };
        
        // Agregar listeners para actualizar preview cuando cambien las rutas
        const rutaOrigenSelect = document.getElementById('rutaOrigenMigrar');
        const rutaDestinoSelect = document.getElementById('rutaDestinoMigrar');
        if (rutaOrigenSelect) {
            rutaOrigenSelect.addEventListener('change', () => {
                const previewDiv = document.getElementById('previewMigracion');
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                if (previewDiv) previewDiv.style.display = 'none';
                if (btnConfirmar) btnConfirmar.disabled = true;
            });
        }
        if (rutaDestinoSelect) {
            rutaDestinoSelect.addEventListener('change', () => {
                const previewDiv = document.getElementById('previewMigracion');
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                if (previewDiv) previewDiv.style.display = 'none';
                if (btnConfirmar) btnConfirmar.disabled = true;
            });
        }
        
        btnPrevDay.addEventListener('click', () => {
            diaSeleccionado.setDate(diaSeleccionado.getDate() - 1);
            if (vistaActual === 'dia') {
                generarVistaDia();
            }
        });
        
        btnNextDay.addEventListener('click', () => {
            diaSeleccionado.setDate(diaSeleccionado.getDate() + 1);
            if (vistaActual === 'dia') {
                generarVistaDia();
            }
        });

        // Event listeners para cronograma ya configurados arriba

        // Poblar filtros
        function poblarFiltros() {
            const rutasUnicas = [...new Set(todasLasCitas.map(cita => obtenerRuta(cita)).filter(r => r))];
            if (vehicleFilter) {
                vehicleFilter.innerHTML = '<option value="">Todas las rutas</option>' +
                    rutasUnicas.map(ruta => 
                        `<option value="${ruta}">${ruta}</option>`
                    ).join('');
            }
            if (statusFilter) {
                statusFilter.innerHTML = '<option value="">Todos los estados</option>' +
                    '<option value="agendada">Agendada</option>' +
                    '<option value="confirmada-24-48">Confirmada 24-48h</option>';
            }
        }

        // Función para pre-cargar citas ficticias
        async function precargarCitasFicticias() {
            const btnPrecargar = document.getElementById('btnPrecargarCitas');
            if (!btnPrecargar) return;

            const confirmacion = confirm('¿Deseas crear citas ficticias para el 14 de noviembre de 2025?\n\nHorario: 6:00 AM - 3:00 PM\nDuración: 60 minutos cada una\nEspacio entre citas: 1 hora\nTodas se crearán en "Sin asignar"');
            
            if (!confirmacion) return;

            try {
                btnPrecargar.disabled = true;
                btnPrecargar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando citas...';

                // Fecha: 14 de noviembre de 2025
                const fechaBase = new Date('2025-11-14T00:00:00-06:00'); // GMT-06 (Costa Rica)
                
                // Horarios: 6:00 AM, 7:00 AM, 8:00 AM, ..., 2:00 PM (14:00)
                const horas = [6, 7, 8, 9, 10, 11, 12, 13, 14]; // 6am a 2pm (9 citas)
                const duracionMinutos = 60;
                
                let citasCreadas = 0;
                
                for (let i = 0; i < horas.length; i++) {
                    const hora = horas[i];
                    const fechaInicio = new Date(fechaBase);
                    fechaInicio.setHours(hora, 0, 0, 0);
                    
                    // Convertir a Timestamp GMT-06
                    const timestampGMT6 = Timestamp.fromDate(fechaInicio);
                    
                    // Teléfono ficticio
                    const telefonoFicticio = `506${String(80000000 + i).padStart(8, '0')}`;
                    const nombreClienteFicticio = `Cliente Ficticio ${i + 1}`;
                    
                    // Crear o actualizar cliente primero (siguiendo principios de jerarquía)
                    try {
                        let cliente = await window.buscarCliente(telefonoFicticio);
                        if (!cliente) {
                            await window.crearCliente(telefonoFicticio, nombreClienteFicticio);
                        } else if (cliente.nombre !== nombreClienteFicticio) {
                            await window.actualizarNombreCliente(telefonoFicticio, nombreClienteFicticio);
                        }
                    } catch (error) {
                        console.warn(`Error creando/actualizando cliente ficticio ${i + 1}:`, error);
                    }
                    
                    // Crear cita con estructura nueva (sin cliente_nombre en metadata)
                    const nuevaCita = {
                        telefono: telefonoFicticio, // Fuente de verdad: teléfono en raíz
                        inicio_gmt6: timestampGMT6,
                        duracion_minutos: duracionMinutos,
                        metadata: {
                            // cliente_nombre removido - el nombre pertenece al documento del cliente, no a la cita
                            // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                            sucursalIndice: null, // Citas ficticias sin sucursal
                            vehiculo: 'Sin asignar',
                            ruta: 'Sin asignar',
                            estado: 'agendada',
                            monto: 0,
                            costo_servicio: 20000, // Costo del servicio por defecto
                            vendedores: [], // Array vacío para citas ficticias
                            observaciones: `Cita de prueba ${i + 1}`
                        },
                        fecha_creacion: serverTimestamp(),
                        version_esquema: 1
                    };
                    
                    await addDoc(collection(window.db, 'citas'), nuevaCita);
                    citasCreadas++;
                }

                // Recargar datos
                await cargarDatos();
                
                // Mostrar notificación de éxito
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `<i class="fas fa-check-circle me-2"></i>${citasCreadas} citas ficticias creadas exitosamente`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);

            } catch (error) {
                console.error('Error pre-cargando citas:', error);
                alert('Error pre-cargando citas: ' + error.message);
            } finally {
                btnPrecargar.disabled = false;
                btnPrecargar.innerHTML = '<i class="fas fa-magic me-2"></i>Pre-cargar Citas';
            }
        }

        // Función mejorada para parsear CSV (maneja saltos de línea dentro de campos entre comillas)
        // Función para actualizar citas desde CSV (reemplaza solo las del rango de fechas)
        async function procesarArchivoCSVActualizar(archivo) {
            if (!archivo) return;

            if (!archivo.name.endsWith('.csv')) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }

            const btnActualizarCSV = document.getElementById('btnActualizarCSV');
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    btnActualizarCSV.disabled = true;
                    btnActualizarCSV.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analizando CSV...';

                    const textoCSV = e.target.result;
                    const datos = parsearCSV(textoCSV);

                    if (datos.length === 0) {
                        throw new Error('No se encontraron datos en el CSV');
                    }

                    // Determinar rango de fechas del CSV
                    let fechaMin = null;
                    let fechaMax = null;
                    
                    for (const fila of datos) {
                        if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') continue;
                        
                        try {
                            const fechaInicio = new Date(fila.inicio_gmt6);
                            if (isNaN(fechaInicio.getTime())) continue;
                            
                            if (!fechaMin || fechaInicio < fechaMin) {
                                fechaMin = new Date(fechaInicio);
                            }
                            if (!fechaMax || fechaInicio > fechaMax) {
                                fechaMax = new Date(fechaInicio);
                            }
                        } catch (error) {
                            console.warn('Error parseando fecha:', fila.inicio_gmt6, error);
                        }
                    }

                    if (!fechaMin || !fechaMax) {
                        throw new Error('No se pudieron determinar las fechas del CSV. Verifica que la columna inicio_gmt6 tenga fechas válidas.');
                    }

                    // Ajustar rango para incluir todo el día (00:00:00 a 23:59:59)
                    fechaMin.setHours(0, 0, 0, 0);
                    fechaMax.setHours(23, 59, 59, 999);

                    const fechaMinStr = fechaMin.toLocaleDateString('es-CR');
                    const fechaMaxStr = fechaMax.toLocaleDateString('es-CR');

                    // Confirmar antes de actualizar
                    const confirmacion = confirm(
                        `Se encontraron ${datos.length} citas en el CSV.\n\n` +
                        `Rango de fechas del CSV: ${fechaMinStr} a ${fechaMaxStr}\n\n` +
                        `⚠️ ADVERTENCIA: Se eliminarán TODAS las citas existentes en este rango de fechas y se crearán las nuevas del CSV.\n\n` +
                        `Las citas fuera de este rango NO se modificarán.\n\n` +
                        `¿Deseas continuar?`
                    );

                    if (!confirmacion) {
                        btnActualizarCSV.disabled = false;
                        btnActualizarCSV.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV';
                        document.getElementById('inputCSVActualizar').value = '';
                        return;
                    }

                    btnActualizarCSV.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando citas del rango...';

                    // Buscar y eliminar citas en el rango de fechas
                    const q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '>=', Timestamp.fromDate(fechaMin)),
                        where('inicio_gmt6', '<=', Timestamp.fromDate(fechaMax)),
                        orderBy('inicio_gmt6', 'desc')
                    );

                    const querySnapshot = await getDocs(q);
                    const citasAEliminar = [];
                    querySnapshot.forEach((docSnapshot) => {
                        citasAEliminar.push(docSnapshot.id);
                    });

                    let citasEliminadas = 0;
                    if (citasAEliminar.length > 0) {
                        // Eliminar en lotes de 10
                        const batchSize = 10;
                        for (let i = 0; i < citasAEliminar.length; i += batchSize) {
                            const batch = citasAEliminar.slice(i, i + batchSize);
                            const promises = batch.map(citaId => 
                                deleteDoc(doc(window.db, 'citas', citaId))
                            );
                            await Promise.all(promises);
                            citasEliminadas += batch.length;
                        }
                    }

                    console.log(`✅ Eliminadas ${citasEliminadas} citas del rango ${fechaMinStr} a ${fechaMaxStr}`);

                    // Ahora crear las nuevas citas del CSV (reutilizar la lógica de procesarArchivoCSV)
                    btnActualizarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;

                    let citasCreadas = 0;
                    let errores = [];

                    for (let i = 0; i < datos.length; i++) {
                        const fila = datos[i];
                        
                        try {
                            // Validar fecha de inicio
                            if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                                errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                                continue;
                            }

                            // Parsear fecha (formato: 2025-11-14T01:00:00-06:00)
                            const fechaInicio = new Date(fila.inicio_gmt6);
                            if (isNaN(fechaInicio.getTime())) {
                                errores.push(`Fila ${i + 2}: Fecha de inicio inválida: ${fila.inicio_gmt6}`);
                                continue;
                            }

                            // Validar teléfono
                            let telefono = fila.telefono ? fila.telefono.trim() : '';
                            if (telefono) {
                                telefono = window.normalizarTelefono ? window.normalizarTelefono(telefono) : telefono;
                            }
                            
                            // Si no hay teléfono, crear uno temporal
                            if (!telefono || telefono === '') {
                                telefono = `temp_${Date.now()}_${i}`;
                            }

                            // Validar duración
                            const duracionMinutos = parseInt(fila.duracion_minutos) || 60;
                            if (duracionMinutos <= 0) {
                                errores.push(`Fila ${i + 2}: Duración inválida: ${fila.duracion_minutos}`);
                                continue;
                            }

                            // Validar y normalizar ruta (el CSV tiene columna ruta)
                            const ruta = window.validarRuta ? window.validarRuta(fila.ruta || 'Sin asignar') : (fila.ruta || 'Sin asignar');
                            
                            // Estado
                            const estado = fila.estado && fila.estado.trim() !== '' 
                                ? fila.estado.trim() 
                                : 'agendada';

                            // Monto
                            const monto = parseInt(fila.monto) || 0;

                            // Cliente nombre
                            const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                                ? fila.cliente_nombre.trim() 
                                : 'Sin nombre';

                            // Iniciales
                            const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                                ? fila.iniciales.trim() 
                                : '';

                            // Observaciones
                            let observaciones = '';
                            if (fila.observaciones && fila.observaciones.trim() !== '') {
                                observaciones = fila.observaciones.trim();
                            }

                            // Dirección
                            let direccion = '';
                            if (fila.direccion && fila.direccion.trim() !== '') {
                                direccion = fila.direccion.trim();
                            } else if (observaciones) {
                                const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                                if (urlMatch) {
                                    direccion = urlMatch[0];
                                }
                            }

                            // Parsear vendedores
                            let vendedores = [];
                            if (fila.vendedores && fila.vendedores.trim() !== '') {
                                let vendedoresStr = String(fila.vendedores).trim();
                                while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                       (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                    vendedoresStr = vendedoresStr.slice(1, -1).trim();
                                }
                                
                                if (vendedoresStr && vendedoresStr !== '') {
                                    try {
                                        const parsed = JSON.parse(vendedoresStr);
                                        if (Array.isArray(parsed)) {
                                            vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                        } else {
                                            vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                        }
                                    } catch (e) {
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                    
                                    vendedores = vendedores
                                        .map(v => {
                                            let vendedor = v.trim();
                                            while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                                   (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                                vendedor = vendedor.slice(1, -1).trim();
                                            }
                                            return vendedor;
                                        })
                                        .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                        .map(v => v.toLowerCase());
                                }
                            }

                            // Convertir fecha a Timestamp GMT-06
                            const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                            // Crear o actualizar documento del cliente con el nombre
                            if (telefono && !telefono.startsWith('temp_')) {
                                try {
                                    let cliente = await window.buscarCliente(telefono);
                                    if (!cliente) {
                                        await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                    } else {
                                        if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                            await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        }
                                    }
                                } catch (error) {
                                    console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                                }
                            }

                            // Crear objeto metadata
                            const metadata = {
                                cliente_nombre: clienteNombre !== 'Sin nombre' ? clienteNombre : '',
                                sucursalIndice: null,
                                ruta: ruta,
                                estado: estado,
                                monto: monto,
                                costo_servicio: 20000,
                                vendedores: vendedores,
                                observaciones: observaciones
                            };

                            // Agregar campos opcionales
                            if (fila.vehiculo) {
                                metadata.vehiculo = fila.vehiculo;
                            }
                            if (iniciales) {
                                metadata.iniciales = iniciales;
                            }
                            if (direccion) {
                                metadata.direccion = direccion;
                            }

                            // Crear cita
                            const nuevaCita = {
                                telefono: telefono,
                                inicio_gmt6: timestampGMT6,
                                duracion_minutos: duracionMinutos,
                                metadata: metadata,
                                fecha_creacion: serverTimestamp(),
                                version_esquema: 1
                            };

                            await addDoc(collection(window.db, 'citas'), nuevaCita);
                            citasCreadas++;

                            btnActualizarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;

                        } catch (error) {
                            console.error(`Error procesando fila ${i + 2}:`, error);
                            errores.push(`Fila ${i + 2}: ${error.message}`);
                        }
                    }

                    // Mostrar resultado
                    let mensaje = `✅ Actualización completada:\n\n`;
                    mensaje += `- Citas eliminadas del rango: ${citasEliminadas}\n`;
                    mensaje += `- Citas creadas desde CSV: ${citasCreadas}\n`;
                    mensaje += `- Rango de fechas: ${fechaMinStr} a ${fechaMaxStr}\n`;
                    
                    if (errores.length > 0) {
                        mensaje += `\n⚠️ Errores (${errores.length}):\n${errores.slice(0, 10).join('\n')}`;
                        if (errores.length > 10) {
                            mensaje += `\n... y ${errores.length - 10} más`;
                        }
                    }

                    alert(mensaje);

                    // Recargar datos
                    if (window.cargarDatos) {
                        await window.cargarDatos();
                    }

                    btnActualizarCSV.disabled = false;
                    btnActualizarCSV.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV';
                    document.getElementById('inputCSVActualizar').value = '';

                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error procesando CSV: ' + error.message);
                    btnActualizarCSV.disabled = false;
                    btnActualizarCSV.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar desde CSV';
                    document.getElementById('inputCSVActualizar').value = '';
                }
            };

            reader.readAsText(archivo);
        }

        function parsearCSV(texto) {
            const lineas = [];
            let lineaActual = '';
            let dentroComillas = false;
            
            // Primero, reconstruir las líneas correctamente manejando saltos de línea dentro de comillas
            for (let i = 0; i < texto.length; i++) {
                const char = texto[i];
                const nextChar = texto[i + 1];
                
                if (char === '"') {
                    // Manejar comillas dobles escapadas ("")
                    if (dentroComillas && nextChar === '"') {
                        lineaActual += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        dentroComillas = !dentroComillas;
                        lineaActual += char;
                    }
                } else if (char === '\n' || char === '\r') {
                    if (dentroComillas) {
                        // Si estamos dentro de comillas, mantener el salto de línea como parte del valor
                        lineaActual += char === '\n' ? '\n' : '';
                    } else {
                        // Si no estamos dentro de comillas, es un separador de fila
                        if (lineaActual.trim()) {
                            lineas.push(lineaActual);
                            lineaActual = '';
                        }
                        // Saltar \r\n
                        if (char === '\r' && nextChar === '\n') {
                            i++;
                        }
                    }
                } else {
                    lineaActual += char;
                }
            }
            
            // Agregar la última línea si existe
            if (lineaActual.trim()) {
                lineas.push(lineaActual);
            }
            
            if (lineas.length < 2) {
                throw new Error('El CSV debe tener al menos una fila de encabezados y una fila de datos');
            }

            // Parsear encabezados
            const encabezados = parsearLineaCSVCompleta(lineas[0]);
            
            // Validar campos requeridos
            const camposRequeridos = ['inicio_gmt6', 'duracion_minutos'];
            const camposFaltantes = camposRequeridos.filter(campo => !encabezados.includes(campo));
            if (camposFaltantes.length > 0) {
                throw new Error(`Faltan campos requeridos: ${camposFaltantes.join(', ')}`);
            }

            // Parsear datos
            const datos = [];
            for (let i = 1; i < lineas.length; i++) {
                const valores = parsearLineaCSVCompleta(lineas[i]);
                
                // Asegurar que tenemos suficientes valores (rellenar con strings vacíos si faltan)
                while (valores.length < encabezados.length) {
                    valores.push('');
                }
                
                const fila = {};
                encabezados.forEach((encabezado, indice) => {
                    let valor = valores[indice] || '';
                    // Limpiar el valor: remover comillas exteriores y espacios
                    valor = limpiarValorCSV(valor);
                    fila[encabezado] = valor;
                });
                datos.push(fila);
            }

            return datos;
        }

        // Función para parsear una línea CSV completa
        function parsearLineaCSVCompleta(linea) {
            const valores = [];
            let valorActual = '';
            let dentroComillas = false;
            
            for (let i = 0; i < linea.length; i++) {
                const char = linea[i];
                const nextChar = linea[i + 1];
                
                if (char === '"') {
                    // Manejar comillas dobles escapadas ("")
                    if (dentroComillas && nextChar === '"') {
                        valorActual += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        dentroComillas = !dentroComillas;
                        // No agregar las comillas al valor
                    }
                } else if (char === ',' && !dentroComillas) {
                    valores.push(valorActual);
                    valorActual = '';
                } else {
                    valorActual += char;
                }
            }
            
            // Agregar el último valor
            valores.push(valorActual);
            
            return valores;
        }

        // Función para limpiar valores del CSV
        function limpiarValorCSV(valor) {
            if (!valor) return '';
            
            // Remover espacios al inicio y final
            valor = valor.trim();
            
            // Remover comillas exteriores si existen
            if ((valor.startsWith('"') && valor.endsWith('"')) || 
                (valor.startsWith("'") && valor.endsWith("'"))) {
                valor = valor.slice(1, -1);
            }
            
            return valor;
        }

        function normalizarTelefono(telefono) {
            if (!telefono || telefono.trim() === '') {
                return null; // Permitir teléfono vacío
            }
            let telefonoNormalizado = telefono.trim();
            // Remover espacios, guiones, paréntesis
            telefonoNormalizado = telefonoNormalizado.replace(/[\s\-\(\)]/g, '');
            // Agregar código de país si no lo tiene
            if (!telefonoNormalizado.startsWith('506')) {
                telefonoNormalizado = '506' + telefonoNormalizado;
            }
            return telefonoNormalizado;
        }

        function validarRuta(ruta) {
            const rutasValidas = [
                'Sin asignar', 'Ruta 1', 'Ruta 2', 'Ruta 3', 'Ruta 4', 
                'Ruta 5', 'Ruta 6', 'Ruta 7', 'Ruta 8', 
                'Ruta 9', 'Ruta 10', 'Ruta 11', 'Ruta 12', 'Ruta 13', 'Ruta 14', 'Ruta 15',
                'Ruta 16', 'Ruta 17', 'Ruta 18', 'Ruta 19', 'Ruta 20'
            ];
            if (!ruta || ruta.trim() === '') {
                return 'Sin asignar';
            }
            const rutaNormalizada = ruta.trim();
            
            // Si ya está en el formato correcto, retornarlo
            if (rutasValidas.includes(rutaNormalizada)) {
                return rutaNormalizada;
            }
            
            // Si es solo un número (1-20), convertirlo a "Ruta X"
            const numeroRuta = parseInt(rutaNormalizada);
            if (!isNaN(numeroRuta) && numeroRuta >= 1 && numeroRuta <= 20) {
                return `Ruta ${numeroRuta}`;
            }
            
            // Si no es válido, retornar "Sin asignar"
            return 'Sin asignar';
        }
        
        // Exponer validarRuta a window para que esté disponible globalmente
        window.validarRuta = validarRuta;
        
        // Función para convertir vehículo (APV 01, APV 02, etc.) a ruta (Ruta 1, Ruta 2, etc.)
        function vehiculoARuta(vehiculo) {
            if (!vehiculo || vehiculo.trim() === '') {
                return 'Sin asignar';
            }
            
            const vehiculoNormalizado = vehiculo.trim();
            
            // Mapeo directo: APV 01 -> Ruta 1, APV 02 -> Ruta 2, etc.
            const matchAPV = vehiculoNormalizado.match(/^APV\s*0?(\d+)$/i);
            if (matchAPV) {
                const numeroRuta = parseInt(matchAPV[1]);
                if (numeroRuta >= 1 && numeroRuta <= 20) {
                    return `Ruta ${numeroRuta}`;
                }
            }
            
            // Si no es APV, usar validarRuta para otros formatos
            return validarRuta(vehiculoNormalizado);
        }
        
        // Mantener compatibilidad temporal
        function validarVehiculo(vehiculo) {
            return vehiculoARuta(vehiculo);
        }

        async function cargarCitasDesdeCSV() {
            const inputCSV = document.getElementById('inputCSV');
            const btnCargarCSV = document.getElementById('btnCargarCSV');
            
            if (!inputCSV || !btnCargarCSV) return;

            // Abrir selector de archivos
            inputCSV.click();
        }
        
        // Función para solicitar URL de Google Sheets
        function solicitarURLGoogleSheets(esActualizar) {
            const mensaje = esActualizar 
                ? 'Ingresa la URL pública de Google Sheets (debe estar publicada como CSV)\n\nEjemplo: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing\n\nO la URL directa del CSV: https://docs.google.com/spreadsheets/d/ID/export?format=csv&gid=0'
                : 'Ingresa la URL pública de Google Sheets (debe estar publicada como CSV)\n\nEjemplo: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing\n\nO la URL directa del CSV: https://docs.google.com/spreadsheets/d/ID/export?format=csv&gid=0';
            
            const url = prompt(mensaje);
            if (!url || url.trim() === '') {
                return;
            }
            
            // Convertir URL de Google Sheets a URL de exportación CSV si es necesario
            let urlCSV = convertirURLGoogleSheetsACSV(url.trim());
            
            if (esActualizar) {
                procesarGoogleSheetsActualizar(urlCSV);
            } else {
                procesarGoogleSheets(urlCSV);
            }
        }
        
        // Función para convertir URL de Google Sheets a URL de exportación CSV
        function convertirURLGoogleSheetsACSV(url) {
            // Si ya es una URL de exportación CSV, retornarla tal cual
            if (url.includes('/export?format=csv') || url.includes('output=csv')) {
                return url;
            }
            
            // Formato 1: URL de "Publicar en la web" (pubhtml)
            // Ejemplo: https://docs.google.com/spreadsheets/d/e/2PACX-.../pubhtml?gid=0&single=true
            const matchPub = url.match(/\/spreadsheets\/d\/e\/([a-zA-Z0-9-_]+)/);
            if (matchPub && matchPub[1]) {
                const pubId = matchPub[1];
                const gidMatch = url.match(/[#&?]gid=(\d+)/);
                const gid = gidMatch ? gidMatch[1] : '0';
                // Convertir pubhtml a pub con output=csv
                return `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?output=csv&gid=${gid}`;
            }
            
            // Formato 2: URL normal de Google Sheets
            // Ejemplo: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!match || !match[1]) {
                alert('URL de Google Sheets inválida. Por favor, verifica que sea una URL válida de Google Sheets.');
                return null;
            }
            
            const sheetId = match[1];
            
            // Extraer el GID si está presente (número de hoja)
            const gidMatch = url.match(/[#&?]gid=(\d+)/);
            const gid = gidMatch ? gidMatch[1] : '0';
            
            // Construir URL de exportación CSV
            return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
        }
        
        // Función auxiliar para descargar CSV desde Google Sheets con manejo de CORS
        async function descargarCSVDesdeGoogleSheets(urlCSV) {
            // Método 1: Intentar fetch directo
            try {
                console.log('🔄 Intentando descarga directa...', urlCSV);
                const response = await fetch(urlCSV, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const texto = await response.text();
                    if (texto && texto.trim().length > 0) {
                        console.log('✅ Descarga directa exitosa');
                        return texto;
                    }
                }
            } catch (error) {
                console.warn('⚠️ Fetch directo falló:', error.message);
            }
            
            // Método 2: Usar proxy público de CORS
            try {
                console.log('🔄 Intentando con proxy CORS...');
                const proxyURL = `https://api.allorigins.win/raw?url=${encodeURIComponent(urlCSV)}`;
                const response = await fetch(proxyURL);
                
                if (response.ok) {
                    const texto = await response.text();
                    if (texto && texto.trim().length > 0) {
                        console.log('✅ Descarga con proxy exitosa');
                        return texto;
                    }
                }
            } catch (error) {
                console.warn('⚠️ Proxy falló:', error.message);
            }
            
            // Si todos los métodos fallan
            throw new Error(`No se pudo descargar el Google Sheets debido a restricciones de CORS.\n\nPor favor:\n1. Asegúrate de que la hoja esté publicada como "Cualquiera con el enlace puede ver"\n2. Ve a Archivo → Compartir → Publicar en la web → Publicar como CSV\n3. O descarga el CSV manualmente y úsalo con el botón "Cargar CSV"`);
        }
        
        // Función para procesar Google Sheets (cargar)
        async function procesarGoogleSheets(urlCSV) {
            if (!urlCSV) return;
            
            const btnCargar = document.getElementById('btnCargarGoogleSheets');
            const textoOriginal = btnCargar ? btnCargar.innerHTML : '';
            
            try {
                if (btnCargar) {
                    btnCargar.disabled = true;
                    btnCargar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cargando desde Google Sheets...';
                }
                
                // Descargar CSV desde la URL usando función auxiliar
                const textoCSV = await descargarCSVDesdeGoogleSheets(urlCSV);
                const datos = parsearCSV(textoCSV);
                
                if (datos.length === 0) {
                    throw new Error('No se encontraron datos en el Google Sheets');
                }
                
                // Confirmar antes de crear
                const confirmacion = confirm(
                    `Se encontraron ${datos.length} citas en Google Sheets.\n\n` +
                    `¿Deseas crear estas citas en el sistema?\n\n` +
                    `Nota: Las citas con teléfono vacío se crearán sin teléfono.`
                );
                
                if (!confirmacion) {
                    if (btnCargar) {
                        btnCargar.disabled = false;
                        btnCargar.innerHTML = textoOriginal;
                    }
                    return;
                }
                
                // Usar la misma lógica que procesarArchivoCSV
                const btnCargarCSV = document.getElementById('btnCargarCSV');
                let citasCreadas = 0;
                let errores = [];
                
                if (btnCargarCSV) {
                    btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;
                }
                
                // Procesar cada fila (reutilizar lógica de procesarArchivoCSV)
                for (let i = 0; i < datos.length; i++) {
                    const fila = datos[i];
                    
                    try {
                        // Validar fecha de inicio
                        if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                            errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                            continue;
                        }

                        // Parsear fecha (formato: 2025-11-14T01:00:00-06:00)
                        const fechaInicio = new Date(fila.inicio_gmt6);
                        if (isNaN(fechaInicio.getTime())) {
                            errores.push(`Fila ${i + 2}: Fecha de inicio inválida: ${fila.inicio_gmt6}`);
                            continue;
                        }

                        // Validar teléfono
                        let telefono = fila.telefono ? fila.telefono.trim() : '';
                        if (telefono) {
                            telefono = window.normalizarTelefono ? window.normalizarTelefono(telefono) : telefono;
                        }
                        
                        // Si no hay teléfono, crear uno temporal
                        if (!telefono || telefono === '') {
                            telefono = `temp_${Date.now()}_${i}`;
                        }

                        // Validar duración
                        const duracionMinutos = parseInt(fila.duracion_minutos) || 60;
                        if (duracionMinutos <= 0) {
                            errores.push(`Fila ${i + 2}: Duración inválida: ${fila.duracion_minutos}`);
                            continue;
                        }

                        // Validar y normalizar ruta (el CSV tiene columna ruta)
                        const ruta = window.validarRuta ? window.validarRuta(fila.ruta || 'Sin asignar') : (fila.ruta || 'Sin asignar');
                        
                        // Estado
                        const estado = fila.estado && fila.estado.trim() !== '' 
                            ? fila.estado.trim() 
                            : 'agendada';

                        // Monto
                        const monto = parseInt(fila.monto) || 0;

                        // Cliente nombre
                        const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                            ? fila.cliente_nombre.trim() 
                            : 'Sin nombre';

                        // Iniciales
                        const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                            ? fila.iniciales.trim() 
                            : '';

                        // Observaciones
                        let observaciones = '';
                        if (fila.observaciones && fila.observaciones.trim() !== '') {
                            observaciones = fila.observaciones.trim();
                        }

                        // Dirección
                        let direccion = '';
                        if (fila.direccion && fila.direccion.trim() !== '') {
                            direccion = fila.direccion.trim();
                        } else if (observaciones) {
                            const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                            if (urlMatch) {
                                direccion = urlMatch[0];
                            }
                        }

                        // Parsear vendedores
                        let vendedores = [];
                        if (fila.vendedores && fila.vendedores.trim() !== '') {
                            let vendedoresStr = String(fila.vendedores).trim();
                            while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                   (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                vendedoresStr = vendedoresStr.slice(1, -1).trim();
                            }
                            
                            if (vendedoresStr && vendedoresStr !== '') {
                                try {
                                    const parsed = JSON.parse(vendedoresStr);
                                    if (Array.isArray(parsed)) {
                                        vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                    } else {
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                } catch (e) {
                                    vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                }
                                
                                vendedores = vendedores
                                    .map(v => {
                                        let vendedor = v.trim();
                                        while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                               (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                            vendedor = vendedor.slice(1, -1).trim();
                                        }
                                        return vendedor;
                                    })
                                    .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                    .map(v => v.toLowerCase());
                            }
                        }

                        // Convertir fecha a Timestamp GMT-06
                        const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                        // Crear o actualizar documento del cliente con el nombre
                        if (telefono && !telefono.startsWith('temp_')) {
                            try {
                                let cliente = await window.buscarCliente(telefono);
                                if (!cliente) {
                                    await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                } else {
                                    if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                        await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        cliente.nombre = clienteNombre.trim();
                                    }
                                }
                            } catch (error) {
                                console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                            }
                        }

                        // Obtener nombre del cliente para guardarlo en metadata (fallback para renderizado rápido)
                        const nombreClienteParaMetadata = clienteNombre !== 'Sin nombre' ? clienteNombre : '';

                        // Crear objeto metadata
                        const metadata = {
                            cliente_nombre: nombreClienteParaMetadata,
                            sucursalIndice: null,
                            ruta: ruta,
                            estado: estado,
                            monto: monto,
                            costo_servicio: 20000,
                            vendedores: vendedores,
                            observaciones: observaciones
                        };

                        // Agregar campos opcionales
                        if (fila.vehiculo) {
                            metadata.vehiculo = fila.vehiculo;
                        }
                        if (iniciales) {
                            metadata.iniciales = iniciales;
                        }
                        if (direccion) {
                            metadata.direccion = direccion;
                        }

                        // Verificar si ya existe una cita duplicada (mismo teléfono, fecha/hora y ruta)
                        // Solo verificar en modo "Cargar" (no "Actualizar", que ya elimina el rango)
                        let esDuplicado = false;
                        if (btnCargarCSV) {
                            try {
                                const qDuplicado = query(
                                    collection(window.db, 'citas'),
                                    where('telefono', '==', telefono),
                                    where('inicio_gmt6', '==', timestampGMT6)
                                );
                                const snapshotDuplicado = await getDocs(qDuplicado);
                                
                                snapshotDuplicado.forEach(doc => {
                                    const citaExistente = doc.data();
                                    const rutaExistente = window.obtenerRuta(citaExistente);
                                    if (rutaExistente === ruta) {
                                        esDuplicado = true;
                                    }
                                });
                            } catch (error) {
                                // Si falla la query (por ejemplo, falta índice), continuar sin verificar
                                console.warn(`No se pudo verificar duplicado para fila ${i + 2}:`, error);
                            }
                        }
                        
                        if (esDuplicado) {
                            console.warn(`⚠️ Cita duplicada omitida (fila ${i + 2}): teléfono=${telefono}, fecha=${timestampGMT6.toDate().toLocaleString('es-ES')}, ruta=${ruta}`);
                            errores.push(`Fila ${i + 2}: Cita duplicada (ya existe con mismo teléfono, fecha y ruta)`);
                            continue;
                        }

                        // Crear cita
                        const nuevaCita = {
                            telefono: telefono,
                            inicio_gmt6: timestampGMT6,
                            duracion_minutos: duracionMinutos,
                            metadata: metadata,
                            fecha_creacion: serverTimestamp(),
                            version_esquema: 1
                        };

                        await addDoc(collection(window.db, 'citas'), nuevaCita);
                        citasCreadas++;

                        if (btnCargarCSV) {
                            btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;
                        }

                    } catch (error) {
                        console.error(`Error procesando fila ${i + 2}:`, error);
                        errores.push(`Fila ${i + 2}: ${error.message}`);
                    }
                }

                // Mostrar resultado
                let mensaje = `✅ Citas creadas desde Google Sheets: ${citasCreadas}\n`;
                if (errores.length > 0) {
                    mensaje += `\n⚠️ Errores (${errores.length}):\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} más`;
                    }
                }

                alert(mensaje);

                // Recargar datos
                if (window.cargarDatos) {
                    await window.cargarDatos();
                }

                if (btnCargarCSV) {
                    btnCargarCSV.disabled = false;
                    btnCargarCSV.innerHTML = '<i class="fas fa-file-csv me-2"></i>Cargar CSV';
                }
                
                if (btnCargar) {
                    btnCargar.disabled = false;
                    btnCargar.innerHTML = textoOriginal;
                }
                
            } catch (error) {
                console.error('Error procesando Google Sheets:', error);
                alert('Error al cargar desde Google Sheets: ' + error.message + '\n\nAsegúrate de que:\n1. La hoja esté publicada como "Cualquiera con el enlace puede ver"\n2. La URL sea correcta\n3. La hoja tenga datos');
                if (btnCargar) {
                    btnCargar.disabled = false;
                    btnCargar.innerHTML = textoOriginal;
                }
            }
        }
        
        // Función para procesar Google Sheets (actualizar)
        async function procesarGoogleSheetsActualizar(urlCSV) {
            if (!urlCSV) return;
            
            const btnActualizar = document.getElementById('btnActualizarGoogleSheets');
            const textoOriginal = btnActualizar ? btnActualizar.innerHTML : '';
            
            try {
                if (btnActualizar) {
                    btnActualizar.disabled = true;
                    btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analizando Google Sheets...';
                }
                
                // Descargar CSV desde la URL usando función auxiliar
                const textoCSV = await descargarCSVDesdeGoogleSheets(urlCSV);
                const datos = parsearCSV(textoCSV);
                
                if (datos.length === 0) {
                    throw new Error('No se encontraron datos en el Google Sheets');
                }

                // Determinar rango de fechas del Google Sheets
                let fechaMin = null;
                let fechaMax = null;
                
                for (const fila of datos) {
                    if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') continue;
                    
                    try {
                        const fechaInicio = new Date(fila.inicio_gmt6);
                        if (isNaN(fechaInicio.getTime())) continue;
                        
                        if (!fechaMin || fechaInicio < fechaMin) {
                            fechaMin = new Date(fechaInicio);
                        }
                        if (!fechaMax || fechaInicio > fechaMax) {
                            fechaMax = new Date(fechaInicio);
                        }
                    } catch (error) {
                        console.warn('Error parseando fecha:', fila.inicio_gmt6, error);
                    }
                }

                if (!fechaMin || !fechaMax) {
                    throw new Error('No se pudieron determinar las fechas del Google Sheets. Verifica que la columna inicio_gmt6 tenga fechas válidas.');
                }

                // Ajustar rango para incluir todo el día (00:00:00 a 23:59:59)
                fechaMin.setHours(0, 0, 0, 0);
                fechaMax.setHours(23, 59, 59, 999);

                const fechaMinStr = fechaMin.toLocaleDateString('es-CR');
                const fechaMaxStr = fechaMax.toLocaleDateString('es-CR');

                // Confirmar antes de actualizar
                const confirmacion = confirm(
                    `Se encontraron ${datos.length} citas en Google Sheets.\n\n` +
                    `Rango de fechas: ${fechaMinStr} a ${fechaMaxStr}\n\n` +
                    `⚠️ ADVERTENCIA: Se eliminarán TODAS las citas existentes en este rango de fechas y se crearán las nuevas del Google Sheets.\n\n` +
                    `Las citas fuera de este rango NO se modificarán.\n\n` +
                    `¿Deseas continuar?`
                );

                if (!confirmacion) {
                    if (btnActualizar) {
                        btnActualizar.disabled = false;
                        btnActualizar.innerHTML = textoOriginal;
                    }
                    return;
                }

                if (btnActualizar) {
                    btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando citas del rango...';
                }

                // Buscar y eliminar citas en el rango de fechas
                const q = query(
                    collection(window.db, 'citas'),
                    where('inicio_gmt6', '>=', Timestamp.fromDate(fechaMin)),
                    where('inicio_gmt6', '<=', Timestamp.fromDate(fechaMax)),
                    orderBy('inicio_gmt6', 'desc')
                );

                const querySnapshot = await getDocs(q);
                const citasAEliminar = [];
                querySnapshot.forEach((docSnapshot) => {
                    citasAEliminar.push(docSnapshot.id);
                });

                let citasEliminadas = 0;
                if (citasAEliminar.length > 0) {
                    // Eliminar en lotes de 10
                    const batchSize = 10;
                    for (let i = 0; i < citasAEliminar.length; i += batchSize) {
                        const batch = citasAEliminar.slice(i, i + batchSize);
                        const promises = batch.map(citaId => 
                            deleteDoc(doc(window.db, 'citas', citaId))
                        );
                        await Promise.all(promises);
                        citasEliminadas += batch.length;
                    }
                }

                console.log(`✅ Eliminadas ${citasEliminadas} citas del rango ${fechaMinStr} a ${fechaMaxStr}`);

                // Ahora crear las nuevas citas (reutilizar lógica de procesarGoogleSheets)
                if (btnActualizar) {
                    btnActualizar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;
                }

                // Reutilizar la misma lógica de creación que procesarGoogleSheets
                let citasCreadas = 0;
                let errores = [];

                for (let i = 0; i < datos.length; i++) {
                    const fila = datos[i];
                    
                    try {
                        // Validar fecha de inicio
                        if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                            errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                            continue;
                        }

                        // Parsear fecha
                        const fechaInicio = new Date(fila.inicio_gmt6);
                        if (isNaN(fechaInicio.getTime())) {
                            errores.push(`Fila ${i + 2}: Fecha de inicio inválida: ${fila.inicio_gmt6}`);
                            continue;
                        }

                        // Validar teléfono
                        let telefono = fila.telefono ? fila.telefono.trim() : '';
                        if (telefono) {
                            telefono = window.normalizarTelefono ? window.normalizarTelefono(telefono) : telefono;
                        }
                        
                        if (!telefono || telefono === '') {
                            telefono = `temp_${Date.now()}_${i}`;
                        }

                        // Validar duración
                        const duracionMinutos = parseInt(fila.duracion_minutos) || 60;
                        if (duracionMinutos <= 0) {
                            errores.push(`Fila ${i + 2}: Duración inválida: ${fila.duracion_minutos}`);
                            continue;
                        }

                        // Validar y normalizar ruta
                        const ruta = window.validarRuta ? window.validarRuta(fila.ruta || 'Sin asignar') : (fila.ruta || 'Sin asignar');
                        
                        // Estado
                        const estado = fila.estado && fila.estado.trim() !== '' 
                            ? fila.estado.trim() 
                            : 'agendada';

                        // Monto
                        const monto = parseInt(fila.monto) || 0;

                        // Cliente nombre
                        const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                            ? fila.cliente_nombre.trim() 
                            : 'Sin nombre';

                        // Iniciales
                        const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                            ? fila.iniciales.trim() 
                            : '';

                        // Observaciones
                        let observaciones = '';
                        if (fila.observaciones && fila.observaciones.trim() !== '') {
                            observaciones = fila.observaciones.trim();
                        }

                        // Dirección
                        let direccion = '';
                        if (fila.direccion && fila.direccion.trim() !== '') {
                            direccion = fila.direccion.trim();
                        } else if (observaciones) {
                            const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                            if (urlMatch) {
                                direccion = urlMatch[0];
                            }
                        }

                        // Parsear vendedores
                        let vendedores = [];
                        if (fila.vendedores && fila.vendedores.trim() !== '') {
                            let vendedoresStr = String(fila.vendedores).trim();
                            while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                   (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                vendedoresStr = vendedoresStr.slice(1, -1).trim();
                            }
                            
                            if (vendedoresStr && vendedoresStr !== '') {
                                try {
                                    const parsed = JSON.parse(vendedoresStr);
                                    if (Array.isArray(parsed)) {
                                        vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                    } else {
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                } catch (e) {
                                    vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                }
                                
                                vendedores = vendedores
                                    .map(v => {
                                        let vendedor = v.trim();
                                        while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                               (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                            vendedor = vendedor.slice(1, -1).trim();
                                        }
                                        return vendedor;
                                    })
                                    .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                    .map(v => v.toLowerCase());
                            }
                        }

                        // Convertir fecha a Timestamp GMT-06
                        const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                        // Crear o actualizar documento del cliente
                        if (telefono && !telefono.startsWith('temp_')) {
                            try {
                                let cliente = await window.buscarCliente(telefono);
                                if (!cliente) {
                                    await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                } else {
                                    if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                        await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        cliente.nombre = clienteNombre.trim();
                                    }
                                }
                            } catch (error) {
                                console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                            }
                        }

                        // Obtener nombre del cliente para metadata
                        const nombreClienteParaMetadata = clienteNombre !== 'Sin nombre' ? clienteNombre : '';

                        // Crear objeto metadata
                        const metadata = {
                            cliente_nombre: nombreClienteParaMetadata,
                            sucursalIndice: null,
                            ruta: ruta,
                            estado: estado,
                            monto: monto,
                            costo_servicio: 20000,
                            vendedores: vendedores,
                            observaciones: observaciones
                        };

                        // Agregar campos opcionales
                        if (fila.vehiculo) {
                            metadata.vehiculo = fila.vehiculo;
                        }
                        if (iniciales) {
                            metadata.iniciales = iniciales;
                        }
                        if (direccion) {
                            metadata.direccion = direccion;
                        }

                        // Crear cita
                        const nuevaCita = {
                            telefono: telefono,
                            inicio_gmt6: timestampGMT6,
                            duracion_minutos: duracionMinutos,
                            metadata: metadata,
                            fecha_creacion: serverTimestamp(),
                            version_esquema: 1
                        };

                        await addDoc(collection(window.db, 'citas'), nuevaCita);
                        citasCreadas++;

                        if (btnActualizar) {
                            btnActualizar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;
                        }

                    } catch (error) {
                        console.error(`Error procesando fila ${i + 2}:`, error);
                        errores.push(`Fila ${i + 2}: ${error.message}`);
                    }
                }

                // Mostrar resultado
                let mensaje = `✅ Actualización completada:\n\n`;
                mensaje += `- Citas eliminadas del rango: ${citasEliminadas}\n`;
                mensaje += `- Citas creadas desde Google Sheets: ${citasCreadas}\n`;
                mensaje += `- Rango de fechas: ${fechaMinStr} a ${fechaMaxStr}\n`;
                
                if (errores.length > 0) {
                    mensaje += `\n⚠️ Errores (${errores.length}):\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} más`;
                    }
                }

                alert(mensaje);

                // Recargar datos
                if (window.cargarDatos) {
                    await window.cargarDatos();
                }
                
                if (btnActualizar) {
                    btnActualizar.disabled = false;
                    btnActualizar.innerHTML = textoOriginal;
                }
                
            } catch (error) {
                console.error('Error procesando Google Sheets:', error);
                alert('Error al actualizar desde Google Sheets: ' + error.message + '\n\nAsegúrate de que:\n1. La hoja esté publicada como "Cualquiera con el enlace puede ver"\n2. La URL sea correcta\n3. La hoja tenga datos');
                if (btnActualizar) {
                    btnActualizar.disabled = false;
                    btnActualizar.innerHTML = textoOriginal;
                }
            }
        }

        async function procesarArchivoCSV(archivo) {
            if (!archivo) return;

            if (!archivo.name.endsWith('.csv')) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }

            const btnCargarCSV = document.getElementById('btnCargarCSV');
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    btnCargarCSV.disabled = true;
                    btnCargarCSV.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';

                    const textoCSV = e.target.result;
                    const datos = parsearCSV(textoCSV);

                    if (datos.length === 0) {
                        throw new Error('No se encontraron datos en el CSV');
                    }

                    // Confirmar antes de crear
                    const confirmacion = confirm(
                        `Se encontraron ${datos.length} citas en el CSV.\n\n` +
                        `¿Deseas crear estas citas en el sistema?\n\n` +
                        `Nota: Las citas con teléfono vacío se crearán sin teléfono.`
                    );

                    if (!confirmacion) {
                        btnCargarCSV.disabled = false;
                        btnCargarCSV.innerHTML = '<i class="fas fa-file-csv me-2"></i>Cargar CSV';
                        return;
                    }

                    let citasCreadas = 0;
                    let errores = [];

                    btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (0/${datos.length})...`;

                    for (let i = 0; i < datos.length; i++) {
                        const fila = datos[i];
                        
                        try {
                            // Validar fecha de inicio
                            if (!fila.inicio_gmt6 || fila.inicio_gmt6.trim() === '') {
                                errores.push(`Fila ${i + 2}: Fecha de inicio requerida`);
                                continue;
                            }

                            // Parsear fecha (formato: 2025-11-14T01:00:00-06:00)
                            const fechaInicio = new Date(fila.inicio_gmt6);
                            if (isNaN(fechaInicio.getTime())) {
                                errores.push(`Fila ${i + 2}: Fecha de inicio inválida: ${fila.inicio_gmt6}`);
                                continue;
                            }

                            // Validar duración
                            const duracion = parseInt(fila.duracion_minutos) || 60;
                            if (duracion < 15) {
                                errores.push(`Fila ${i + 2}: Duración mínima es 15 minutos`);
                                continue;
                            }

                            // Normalizar teléfono (misma lógica que formularios: solo cita.telefono)
                            let telefono = (window.normalizarTelefono && fila.telefono != null && String(fila.telefono).trim() !== '')
                                ? window.normalizarTelefono(fila.telefono)
                                : (fila.telefono ? normalizarTelefono(fila.telefono) : null);
                            if (!telefono || telefono === '') {
                                telefono = `temp_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 9)}`;
                            }

                            // Validar y normalizar ruta
                            const ruta = validarRuta(fila.ruta);

                            // Vehículo (guardar en metadata aunque no se use para la ruta)
                            const vehiculo = fila.vehiculo && fila.vehiculo.trim() !== '' 
                                ? fila.vehiculo.trim() 
                                : '';

                            // Parsear monto
                            const monto = fila.monto && fila.monto.trim() !== '' 
                                ? parseInt(fila.monto) || 0 
                                : 0;

                            // Validar estado
                            const estado = fila.estado && fila.estado.trim() !== '' 
                                ? fila.estado.trim() 
                                : 'agendada';

                            // Cliente nombre
                            const clienteNombre = fila.cliente_nombre && fila.cliente_nombre.trim() !== '' 
                                ? fila.cliente_nombre.trim() 
                                : 'Sin nombre';

                            // Iniciales (guardar en metadata)
                            const iniciales = fila.iniciales && fila.iniciales.trim() !== '' 
                                ? fila.iniciales.trim() 
                                : '';

                            // Observaciones (preservar saltos de línea y HTML, pero limpiar espacios innecesarios)
                            let observaciones = '';
                            if (fila.observaciones && fila.observaciones.trim() !== '') {
                                observaciones = fila.observaciones.trim();
                                // Preservar saltos de línea y contenido HTML tal como viene
                            }

                            // Dirección (puede venir en observaciones o como campo separado)
                            let direccion = '';
                            if (fila.direccion && fila.direccion.trim() !== '') {
                                direccion = fila.direccion.trim();
                            } else if (observaciones) {
                                // Intentar extraer dirección de observaciones si contiene enlaces de Google Maps o Waze
                                const urlMatch = observaciones.match(/(?:https?:\/\/)?(?:maps\.app\.goo\.gl|waze\.com|maps\.google\.com)[^\s<>"]+/i);
                                if (urlMatch) {
                                    direccion = urlMatch[0];
                                }
                            }

                            // Parsear vendedores
                            // Formato esperado: string separado por comas (ej: "username1,username2") o array JSON
                            let vendedores = [];
                            if (fila.vendedores && fila.vendedores.trim() !== '') {
                                let vendedoresStr = String(fila.vendedores).trim();
                                
                                // Remover comillas exteriores si existen (puede haber múltiples niveles)
                                while ((vendedoresStr.startsWith('"') && vendedoresStr.endsWith('"')) || 
                                       (vendedoresStr.startsWith("'") && vendedoresStr.endsWith("'"))) {
                                    vendedoresStr = vendedoresStr.slice(1, -1).trim();
                                }
                                
                                // Si está vacío después de limpiar, salir
                                if (!vendedoresStr || vendedoresStr === '') {
                                    vendedores = [];
                                } else {
                                    try {
                                        // Intentar parsear como JSON array primero
                                        const parsed = JSON.parse(vendedoresStr);
                                        if (Array.isArray(parsed)) {
                                            vendedores = parsed.map(v => String(v).trim()).filter(v => v !== '');
                                        } else {
                                            // Si no es array, tratarlo como string separado por comas
                                            vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                        }
                                    } catch (e) {
                                        // Si falla el parse JSON, tratarlo como string separado por comas
                                        vendedores = vendedoresStr.split(',').map(v => v.trim()).filter(v => v !== '');
                                    }
                                    
                                    // Limpiar y validar cada vendedor
                                    vendedores = vendedores
                                        .map(v => {
                                            // Remover comillas adicionales que puedan quedar
                                            let vendedor = v.trim();
                                            while ((vendedor.startsWith('"') && vendedor.endsWith('"')) || 
                                                   (vendedor.startsWith("'") && vendedor.endsWith("'"))) {
                                                vendedor = vendedor.slice(1, -1).trim();
                                            }
                                            return vendedor;
                                        })
                                        .filter(v => v !== '' && v !== 'null' && v !== 'undefined' && v.length > 0)
                                        .map(v => v.toLowerCase()); // Normalizar a minúsculas para consistencia
                                }
                                
                                console.log(`📋 Vendedores parseados para fila ${i + 2} (original: "${fila.vendedores}"):`, vendedores);
                            }

                            // Convertir fecha a Timestamp GMT-06
                            const timestampGMT6 = Timestamp.fromDate(fechaInicio);

                            // Crear o actualizar documento del cliente con el nombre
                            // El nombre pertenece SOLO al nivel de Cliente, no a la cita
                            // Solo hacerlo si el teléfono es válido (no es temporal)
                            if (telefono && !telefono.startsWith('temp_')) {
                                try {
                                    let cliente = await window.buscarCliente(telefono);
                                    if (!cliente) {
                                        // Crear nuevo cliente
                                        await window.crearCliente(telefono, clienteNombre !== 'Sin nombre' ? clienteNombre : '');
                                    } else {
                                        // Actualizar nombre del cliente si fue modificado
                                        if (clienteNombre && clienteNombre.trim() && clienteNombre !== 'Sin nombre' && cliente.nombre !== clienteNombre.trim()) {
                                            await window.actualizarNombreCliente(telefono, clienteNombre.trim());
                                        }
                                    }
                                } catch (error) {
                                    console.warn(`Error creando/actualizando cliente para fila ${i + 2}:`, error);
                                    // Continuar con la creación de la cita aunque falle la actualización del cliente
                                }
                            }

                            // Crear objeto metadata con todos los campos relevantes
                            // cliente_nombre: guardado como fallback para renderizado rápido (el nombre oficial está en clientes/{telefono}.nombre)
                            const metadata = {
                                    cliente_nombre: clienteNombre !== 'Sin nombre' ? clienteNombre : '', // Guardar nombre del CSV en metadata para renderizado rápido
                                    // clienteTelefono removido - redundante con cita.telefono (fuente de verdad)
                                    sucursalIndice: null, // No hay información de sucursal en CSV, puede ser null
                                    ruta: ruta,
                                    estado: estado,
                                    monto: monto,
                                    costo_servicio: 20000, // Costo del servicio por defecto
                                vendedores: vendedores, // Array de usernames
                                    observaciones: observaciones
                            };

                            // Agregar campos opcionales solo si tienen valor
                            if (vehiculo) {
                                metadata.vehiculo = vehiculo;
                            }
                            if (iniciales) {
                                metadata.iniciales = iniciales;
                            }
                            if (direccion) {
                                metadata.direccion = direccion;
                            }

                            // Crear cita (solo telefono en raíz; mismo campo que formularios Nueva/Editar cita)
                            const nuevaCita = {
                                telefono: telefono,
                                inicio_gmt6: timestampGMT6,
                                duracion_minutos: duracion,
                                metadata: metadata,
                                fecha_creacion: serverTimestamp(),
                                version_esquema: 1
                            };

                            await addDoc(collection(window.db, 'citas'), nuevaCita);
                            citasCreadas++;

                            // Actualizar progreso cada 10 citas
                            if (citasCreadas % 10 === 0 || citasCreadas === datos.length) {
                                btnCargarCSV.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Creando citas (${citasCreadas}/${datos.length})...`;
                            }

                        } catch (error) {
                            console.error(`Error creando cita de fila ${i + 2}:`, error);
                            errores.push(`Fila ${i + 2}: ${error.message}`);
                        }
                    }

                    // Recargar datos
                    await cargarDatos();

                    // Mostrar resultado
                    let mensaje = `✅ ${citasCreadas} citas creadas exitosamente`;
                    if (errores.length > 0) {
                        mensaje += `\n\n⚠️ ${errores.length} errores:\n${errores.slice(0, 10).join('\n')}`;
                        if (errores.length > 10) {
                            mensaje += `\n... y ${errores.length - 10} errores más`;
                        }
                    }

                    const notification = document.createElement('div');
                    notification.className = errores.length > 0 ? 'alert alert-warning position-fixed' : 'alert alert-success position-fixed';
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; white-space: pre-line;';
                    notification.innerHTML = `<i class="fas fa-${errores.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>${mensaje}`;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, errores.length > 0 ? 10000 : 5000);

                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error procesando CSV: ' + error.message);
                } finally {
                    btnCargarCSV.disabled = false;
                    btnCargarCSV.innerHTML = '<i class="fas fa-file-csv me-2"></i>Cargar CSV';
                    // Limpiar input
                    document.getElementById('inputCSV').value = '';
                }
            };

            reader.readAsText(archivo);
        }

        // Función para eliminar citas por filtro
        async function eliminarCitasPorFiltro(tipo) {
            const btnEliminar = document.getElementById('btnConfirmarEliminacion');
            if (!btnEliminar) return;

            try {
                btnEliminar.disabled = true;
                btnEliminar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';

                let q;
                const fechaInicioRango = document.getElementById('fechaInicioRango');
                const fechaFinRango = document.getElementById('fechaFinRango');
                const fechaMayor = document.getElementById('fechaMayor');
                const fechaMenor = document.getElementById('fechaMenor');

                // Construir query según el tipo
                if (tipo === 'todas') {
                    // Obtener todas las citas
                    q = query(collection(window.db, 'citas'));
                } else if (tipo === 'rango') {
                    // Rango de fechas (inclusive)
                    const inicio = fechaInicioRango?.value;
                    const fin = fechaFinRango?.value;
                    
                    if (!inicio || !fin) {
                        alert('Por favor, complete ambas fechas del rango.');
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación';
                        return;
                    }
                    
                    // Crear timestamps para inicio y fin del día
                    const fechaInicio = new Date(inicio + 'T00:00:00');
                    const fechaFin = new Date(fin + 'T23:59:59');
                    const timestampInicio = Timestamp.fromDate(fechaInicio);
                    const timestampFin = Timestamp.fromDate(fechaFin);
                    
                    q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '>=', timestampInicio),
                        where('inicio_gmt6', '<=', timestampFin)
                    );
                } else if (tipo === 'mayor') {
                    // Mayor o igual a una fecha (inclusive)
                    const fecha = fechaMayor?.value;
                    
                    if (!fecha) {
                        alert('Por favor, complete la fecha límite.');
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación';
                        return;
                    }
                    
                    // Crear timestamp para inicio del día
                    const fechaLimite = new Date(fecha + 'T00:00:00');
                    const timestampLimite = Timestamp.fromDate(fechaLimite);
                    
                    q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '>=', timestampLimite)
                    );
                } else if (tipo === 'menor') {
                    // Menor o igual a una fecha (inclusive)
                    const fecha = fechaMenor?.value;
                    
                    if (!fecha) {
                        alert('Por favor, complete la fecha límite.');
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación';
                        return;
                    }
                    
                    // Crear timestamp para fin del día
                    const fechaLimite = new Date(fecha + 'T23:59:59');
                    const timestampLimite = Timestamp.fromDate(fechaLimite);
                    
                    q = query(
                        collection(window.db, 'citas'),
                        where('inicio_gmt6', '<=', timestampLimite)
                    );
                } else {
                    alert('Tipo de eliminación no válido.');
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación';
                    return;
                }

                const querySnapshot = await getDocs(q);
                const totalCitas = querySnapshot.size;
                
                if (totalCitas === 0) {
                    alert('No hay citas que coincidan con los criterios seleccionados.');
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación';
                    return;
                }

                btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (0/${totalCitas})...`;

                let citasEliminadas = 0;
                let errores = [];

                // Eliminar cada cita
                for (const docSnapshot of querySnapshot.docs) {
                    try {
                        await deleteDoc(doc(window.db, 'citas', docSnapshot.id));
                        citasEliminadas++;

                        // Actualizar progreso cada 10 citas
                        if (citasEliminadas % 10 === 0 || citasEliminadas === totalCitas) {
                            btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (${citasEliminadas}/${totalCitas})...`;
                        }
                    } catch (error) {
                        console.error(`Error eliminando cita ${docSnapshot.id}:`, error);
                        errores.push(`Error eliminando cita ${docSnapshot.id}: ${error.message}`);
                    }
                }

                // Recargar datos
                await cargarDatos();

                // Mostrar resultado
                let mensaje = `✅ ${citasEliminadas} citas eliminadas exitosamente`;
                if (errores.length > 0) {
                    mensaje += `\n\n⚠️ ${errores.length} errores:\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} errores más`;
                    }
                }

                const notification = document.createElement('div');
                notification.className = errores.length > 0 ? 'alert alert-warning position-fixed' : 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; white-space: pre-line;';
                notification.innerHTML = `<i class="fas fa-${errores.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>${mensaje}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, errores.length > 0 ? 10000 : 5000);

            } catch (error) {
                console.error('Error eliminando citas:', error);
                alert('Error eliminando citas: ' + error.message);
            } finally {
                if (btnEliminar) {
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación';
                }
            }
        }

        // Función para eliminar todas las citas (SOLO PARA PRUEBAS) - DEPRECADA, usar eliminarCitasPorFiltro
        async function eliminarTodasLasCitas() {
            const btnEliminar = document.getElementById('btnEliminarTodasCitas');
            if (!btnEliminar) return;

            // Primera confirmación
            const confirmacion1 = confirm(
                '⚠️ ADVERTENCIA: Esta acción eliminará TODAS las citas de la base de datos.\n\n' +
                'Esta acción NO se puede deshacer.\n\n' +
                '¿Estás seguro de que deseas continuar?'
            );

            if (!confirmacion1) return;

            // Segunda confirmación (doble verificación)
            const confirmacion2 = confirm(
                '⚠️ ÚLTIMA CONFIRMACIÓN\n\n' +
                'Vas a eliminar TODAS las citas permanentemente.\n\n' +
                'Escribe "ELIMINAR" en el siguiente prompt para confirmar.'
            );

            if (!confirmacion2) return;

            // Tercera confirmación con texto
            const textoConfirmacion = prompt(
                'Para confirmar, escribe exactamente: ELIMINAR TODAS LAS CITAS\n\n' +
                '(Escribe el texto completo para continuar)'
            );

            if (textoConfirmacion !== 'ELIMINAR TODAS LAS CITAS') {
                alert('Operación cancelada. El texto no coincide.');
                return;
            }

            try {
                btnEliminar.disabled = true;
                btnEliminar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';

                // Obtener todas las citas
                const q = query(collection(window.db, 'citas'));
                const querySnapshot = await getDocs(q);
                
                const totalCitas = querySnapshot.size;
                
                if (totalCitas === 0) {
                    alert('No hay citas para eliminar.');
                    btnEliminar.disabled = false;
                    btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Eliminar Todas';
                    return;
                }

                btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (0/${totalCitas})...`;

                let citasEliminadas = 0;
                let errores = [];

                // Eliminar cada cita
                for (const docSnapshot of querySnapshot.docs) {
                    try {
                        await deleteDoc(doc(window.db, 'citas', docSnapshot.id));
                        citasEliminadas++;

                        // Actualizar progreso cada 10 citas
                        if (citasEliminadas % 10 === 0 || citasEliminadas === totalCitas) {
                            btnEliminar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Eliminando (${citasEliminadas}/${totalCitas})...`;
                        }
                    } catch (error) {
                        console.error(`Error eliminando cita ${docSnapshot.id}:`, error);
                        errores.push(`Error eliminando cita ${docSnapshot.id}: ${error.message}`);
                    }
                }

                // Recargar datos
                await cargarDatos();

                // Mostrar resultado
                let mensaje = `✅ ${citasEliminadas} citas eliminadas exitosamente`;
                if (errores.length > 0) {
                    mensaje += `\n\n⚠️ ${errores.length} errores:\n${errores.slice(0, 10).join('\n')}`;
                    if (errores.length > 10) {
                        mensaje += `\n... y ${errores.length - 10} errores más`;
                    }
                }

                const notification = document.createElement('div');
                notification.className = errores.length > 0 ? 'alert alert-warning position-fixed' : 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; white-space: pre-line;';
                notification.innerHTML = `<i class="fas fa-${errores.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>${mensaje}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, errores.length > 0 ? 10000 : 5000);

            } catch (error) {
                console.error('Error eliminando citas:', error);
                alert('Error eliminando citas: ' + error.message);
            } finally {
                btnEliminar.disabled = false;
                btnEliminar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Eliminar Todas';
            }
        }

            // Event listeners para gestión de servicios
            const btnGestionarServicios = document.getElementById('btnGestionarServicios');
            if (btnGestionarServicios) {
                btnGestionarServicios.addEventListener('click', async () => {
                    // Cargar servicios antes de abrir el modal
                    await window.cargarServicios();
                    window.renderizarTablaServiciosCatalogo();
                    const modal = new bootstrap.Modal(document.getElementById('modalGestionarServicios'));
                    modal.show();
                });
            }
            
            // Event listeners para gestión de equipo
            const btnGestionarEquipo = document.getElementById('btnGestionarEquipo');
            if (btnGestionarEquipo) {
                btnGestionarEquipo.addEventListener('click', async () => {
                    // Cargar equipo antes de abrir el modal
                    await window.cargarEquipo();
                    window.renderizarTablaEquipo();
                    const modal = new bootstrap.Modal(document.getElementById('modalGestionarEquipo'));
                    modal.show();
                });
            }
            
            const btnAgregarEquipo = document.getElementById('btnAgregarEquipo');
            if (btnAgregarEquipo) {
                btnAgregarEquipo.addEventListener('click', async () => {
                    const nombreInput = document.getElementById('nuevoEquipoNombre');
                    
                    const nombre = nombreInput.value.trim();
                    
                    if (!nombre) {
                        alert('El nombre del equipo es requerido');
                        return;
                    }
                    
                    try {
                        btnAgregarEquipo.disabled = true;
                        btnAgregarEquipo.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando...';
                        
                        const nuevoEquipo = {
                            nombre: nombre,
                            fecha_creacion: serverTimestamp(),
                            fecha_actualizacion: serverTimestamp()
                        };
                        
                        const docRef = await addDoc(collection(window.db, 'equipo'), nuevoEquipo);
                        console.log('✅ Equipo creado con ID:', docRef.id);
                        
                        // Limpiar formulario
                        nombreInput.value = '';
                        
                        // Recargar equipo y actualizar tabla
                        await window.cargarEquipo();
                        window.renderizarTablaEquipo();
                        
                        btnAgregarEquipo.innerHTML = '<i class="fas fa-check me-2"></i>Agregado';
                        setTimeout(() => {
                            btnAgregarEquipo.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Equipo';
                            btnAgregarEquipo.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error agregando equipo:', error);
                        alert('Error agregando equipo: ' + error.message);
                        btnAgregarEquipo.disabled = false;
                        btnAgregarEquipo.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Equipo';
                    }
                });
            }
            
            // Event listeners para botones de generar certificado
            const btnGenerarCertificadoEdit = document.getElementById('btnGenerarCertificadoEdit');
            if (btnGenerarCertificadoEdit) {
                btnGenerarCertificadoEdit.addEventListener('click', () => {
                    const textoCertificado = document.getElementById('editCertificados')?.value.trim() || '';
                    const fechaInicioInput = document.getElementById('editStartTime');
                    const duracionInput = document.getElementById('editDuration');
                    
                    if (!fechaInicioInput || !fechaInicioInput.value) {
                        alert('Por favor ingrese la fecha y hora de inicio de la cita');
                        return;
                    }
                    
                    const fechaInicio = new Date(fechaInicioInput.value);
                    const duracion = parseInt(duracionInput?.value || 0);
                    
                    if (window.generarCertificadoFumigacion) {
                        window.generarCertificadoFumigacion(textoCertificado, fechaInicio, duracion, 'edit');
                    }
                });
            }
            
            const btnGenerarCertificadoNew = document.getElementById('btnGenerarCertificadoNew');
            if (btnGenerarCertificadoNew) {
                btnGenerarCertificadoNew.addEventListener('click', () => {
                    const textoCertificado = document.getElementById('newCertificados')?.value.trim() || '';
                    const fechaInicioInput = document.getElementById('newStartTime');
                    const duracionInput = document.getElementById('newDuration');
                    
                    if (!fechaInicioInput || !fechaInicioInput.value) {
                        alert('Por favor ingrese la fecha y hora de inicio de la cita');
                        return;
                    }
                    
                    const fechaInicio = new Date(fechaInicioInput.value);
                    const duracion = parseInt(duracionInput?.value || 0);
                    
                    if (window.generarCertificadoFumigacion) {
                        window.generarCertificadoFumigacion(textoCertificado, fechaInicio, duracion, 'new');
                    }
                });
            }
            
            const btnAgregarServicio = document.getElementById('btnAgregarServicio');
            if (btnAgregarServicio) {
                btnAgregarServicio.addEventListener('click', async () => {
                    const nombreInput = document.getElementById('nuevoServicioNombre');
                    const precioInput = document.getElementById('nuevoServicioPrecio');
                    
                    const nombre = nombreInput.value.trim();
                    const precio = parseInt(precioInput.value) || 0;
                    
                    if (!nombre) {
                        alert('El nombre del servicio es requerido');
                        return;
                    }
                    
                    if (precio < 0) {
                        alert('El precio no puede ser negativo');
                        return;
                    }
                    
                    try {
                        btnAgregarServicio.disabled = true;
                        btnAgregarServicio.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando...';
                        
                        const nuevoServicio = {
                            nombre: nombre,
                            precio: precio,
                            fecha_creacion: serverTimestamp(),
                            fecha_actualizacion: serverTimestamp()
                        };
                        
                        const docRef = await addDoc(collection(window.db, 'servicios'), nuevoServicio);
                        console.log('✅ Servicio creado con ID:', docRef.id);
                        
                        // Limpiar formulario
                        nombreInput.value = '';
                        precioInput.value = '';
                        
                        // Recargar servicios y actualizar tabla del catálogo
                        await window.cargarServicios();
                        window.renderizarTablaServiciosCatalogo();
                        
                        btnAgregarServicio.innerHTML = '<i class="fas fa-check me-2"></i>Agregado';
                        setTimeout(() => {
                            btnAgregarServicio.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Servicio';
                            btnAgregarServicio.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('Error agregando servicio:', error);
                        alert('Error agregando servicio: ' + error.message);
                        btnAgregarServicio.disabled = false;
                        btnAgregarServicio.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Servicio';
                    }
                });
        }

            // Event listeners para los selectores de ubicación en edición
            const selectEditProvincia = document.getElementById('editProvincia');
            if (selectEditProvincia) {
                selectEditProvincia.addEventListener('change', function() {
                    const provinciaId = this.value;
                    
                    // Si no hay provincia seleccionada, mostrar todas las provincias
                    if (!provinciaId) {
                        const selectCanton = document.getElementById('editCanton');
                        const selectDistrito = document.getElementById('editDistrito');
                        if (selectCanton) {
                            selectCanton.innerHTML = '<option value="">Primero seleccione una provincia</option>';
                            selectCanton.disabled = true;
                        }
                        if (selectDistrito) {
                            selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                            selectDistrito.disabled = true;
                        }
                        // Mostrar todas las provincias del país
                        mostrarProvinciasPais();
                        return;
                    }
                    
                    // Llenar cantones
                    llenarCantonesEdit(provinciaId);
                    
                    // Limpiar selección de distrito (pero no de cantón si ya está seleccionado)
                    const selectDistrito = document.getElementById('editDistrito');
                    if (selectDistrito) {
                        selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                        selectDistrito.disabled = true;
                    }
                    
                    // Mostrar cantones en el mapa
                    mostrarCantonesProvincia(provinciaId);
                });
            }
            
            const selectEditCanton = document.getElementById('editCanton');
            if (selectEditCanton) {
                selectEditCanton.addEventListener('change', function() {
                    const provinciaId = selectEditProvincia ? selectEditProvincia.value : null;
                    const cantonId = this.value;
                    
                    // Solo limpiar si no hay cantón seleccionado
                    if (!cantonId) {
                        const selectDistrito = document.getElementById('editDistrito');
                        if (selectDistrito) {
                            selectDistrito.innerHTML = '<option value="">Primero seleccione un cantón</option>';
                            selectDistrito.disabled = true;
                        }
                        // Volver a mostrar cantones si hay provincia
                        if (provinciaId) {
                            mostrarCantonesProvincia(provinciaId);
                        } else {
                            limpiarPoligonosEdit();
                        }
                        return;
                    }
                    
                    // Llenar distritos
                    llenarDistritosEdit(provinciaId, cantonId);
                    
                    // Mostrar distritos en el mapa
                    if (provinciaId && cantonId) {
                        mostrarDistritosCanton(provinciaId, cantonId);
                    } else if (provinciaId) {
                        mostrarCantonesProvincia(provinciaId);
                    } else {
                        limpiarPoligonosEdit();
                    }
                });
            }
            
            const selectEditDistrito = document.getElementById('editDistrito');
            if (selectEditDistrito) {
                selectEditDistrito.addEventListener('change', function() {
                    const provinciaId = selectEditProvincia ? selectEditProvincia.value : null;
                    const cantonId = selectEditCanton ? selectEditCanton.value : null;
                    const distritoId = this.value;
                    
                    // Mostrar distrito seleccionado en el mapa
                    if (provinciaId && cantonId && distritoId) {
                        if (window.mostrarDistritoSeleccionado) {
                            window.mostrarDistritoSeleccionado(provinciaId, cantonId, distritoId);
                        }
                    } else if (provinciaId && cantonId) {
                        if (window.mostrarDistritosCanton) {
                            window.mostrarDistritosCanton(provinciaId, cantonId);
                        }
                    } else if (provinciaId) {
                        if (window.mostrarCantonesProvincia) {
                            window.mostrarCantonesProvincia(provinciaId);
                        }
                    } else {
                        if (window.limpiarPoligonosEdit) {
                            window.limpiarPoligonosEdit();
                        }
                    }
                });
            }
            
            // Event listener para coordenadas en edición
            const inputEditCoordenadas = document.getElementById('editCoordenadas');
            if (inputEditCoordenadas) {
                // Event listener para limpiar texto pegado
                inputEditCoordenadas.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const textoPegado = (e.clipboardData || window.clipboardData).getData('text');
                    const coordenadasLimpias = limpiarYExtraerCoordenadas(textoPegado);
                    
                    if (coordenadasLimpias) {
                        this.value = coordenadasLimpias.textoLimpio;
                        // Disparar evento blur para procesar las coordenadas
                        setTimeout(() => {
                            this.dispatchEvent(new Event('blur'));
                        }, 100);
                    } else {
                        // Si no se encontraron coordenadas, mostrar error
                        this.style.borderColor = '#dc3545';
                        alert('No se encontraron coordenadas válidas en el texto pegado. Por favor, pegue solo las coordenadas en formato: lat, lng');
                    }
                });
                inputEditCoordenadas.addEventListener('blur', async function() {
                    const texto = this.value.trim();
                    if (texto) {
                        // Intentar limpiar y extraer coordenadas primero
                        let coords = limpiarYExtraerCoordenadas(texto);
                        if (!coords) {
                            // Si no funciona, intentar parseo normal
                            coords = parsearCoordenadas(texto);
                        }
                        
                        if (coords) {
                            // Validar que estén dentro de Costa Rica
                            if (!validarCoordenadasCostaRica(coords.lat, coords.lng)) {
                                this.setCustomValidity(`Las coordenadas (${coords.lat}, ${coords.lng}) están fuera de los límites de Costa Rica.`);
                                this.reportValidity();
                                this.style.borderColor = '#dc3545';
                                return;
                            }
                            
                            // Actualizar el campo con el texto limpio
                            if (coords.textoLimpio) {
                                this.value = coords.textoLimpio;
                            }
                            
                            // Procesar coordenadas y llenar automáticamente provincia, cantón y distrito
                            const resultado = await procesarCoordenadasEdit(coords.lat, coords.lng);
                            if (!resultado) {
                                this.style.borderColor = '#dc3545';
                            }
                        } else {
                            // Mostrar error si el formato es inválido
                            this.setCustomValidity('Formato inválido. Usa: latitud, longitud (ej: 9.838501, -83.866745)');
                            this.reportValidity();
                            this.style.borderColor = '#dc3545';
                        }
                    } else {
                        this.setCustomValidity('');
                        this.style.borderColor = '#ced4da';
                    }
                });
                
                inputEditCoordenadas.addEventListener('input', function() {
                    // Limpiar validación mientras se escribe
                    this.setCustomValidity('');
                    this.style.borderColor = '#ced4da';
                });
        }
            
            // Event listener para coordenadas en nueva cita
            const inputNewCoordenadas = document.getElementById('newCoordenadas');
            if (inputNewCoordenadas) {
                // Event listener para limpiar texto pegado
                inputNewCoordenadas.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const textoPegado = (e.clipboardData || window.clipboardData).getData('text');
                    const coordenadasLimpias = limpiarYExtraerCoordenadas(textoPegado);
                    
                    if (coordenadasLimpias) {
                        this.value = coordenadasLimpias.textoLimpio;
                        // Disparar evento blur para procesar las coordenadas
                        setTimeout(() => {
                            this.dispatchEvent(new Event('blur'));
                        }, 100);
                    } else {
                        // Si no se encontraron coordenadas, mostrar error
                        this.style.borderColor = '#dc3545';
                        alert('No se encontraron coordenadas válidas en el texto pegado. Por favor, pegue solo las coordenadas en formato: lat, lng');
                    }
                });
                
                inputNewCoordenadas.addEventListener('blur', async function() {
                    const texto = this.value.trim();
                    if (texto) {
                        // Intentar limpiar y extraer coordenadas primero
                        let coords = limpiarYExtraerCoordenadas(texto);
                        if (!coords) {
                            // Si no funciona, intentar parseo normal
                            coords = parsearCoordenadas(texto);
                        }
                        
                        if (coords) {
                            // Validar que estén dentro de Costa Rica
                            if (!validarCoordenadasCostaRica(coords.lat, coords.lng)) {
                                this.setCustomValidity(`Las coordenadas (${coords.lat}, ${coords.lng}) están fuera de los límites de Costa Rica.`);
                                this.reportValidity();
                                this.style.borderColor = '#dc3545';
                                return;
                            }
                            
                            // Actualizar el campo con el texto limpio
                            if (coords.textoLimpio) {
                                this.value = coords.textoLimpio;
                            }
                            
                            // Procesar coordenadas y llenar automáticamente provincia, cantón y distrito
                            const resultado = await procesarCoordenadasNew(coords.lat, coords.lng);
                            if (!resultado) {
                                this.style.borderColor = '#dc3545';
                            }
                        } else {
                            // Mostrar error si el formato es inválido
                            this.setCustomValidity('Formato inválido. Usa: latitud, longitud (ej: 9.838501, -83.866745)');
                            this.reportValidity();
                            this.style.borderColor = '#dc3545';
                        }
                    } else {
                        this.setCustomValidity('');
                        this.style.borderColor = '#ced4da';
                    }
                });
                
                inputNewCoordenadas.addEventListener('input', function() {
                    // Limpiar validación mientras se escribe
                    this.setCustomValidity('');
                    this.style.borderColor = '#ced4da';
                });
        }

            // Event listeners para campos de teléfono
            const editClientPhone = document.getElementById('editClientPhone');
            const newClientPhone = document.getElementById('newClientPhone');
            const editPhoneDisplay = document.getElementById('editPhoneDisplay');
            const newPhoneDisplay = document.getElementById('newPhoneDisplay');
            
            // Función para manejar cambios en teléfono
            async function manejarCambioTelefono(input, display, sucursalSelectId, whatsappId, nombreSucursalId) {
                const valor = input.value.trim();
                
                // Validar que sean solo números
                input.value = valor.replace(/\D/g, '').substring(0, 8);
                
                if (input.value.length === 8) {
                    const telefonoNormalizado = window.normalizarTelefono(input.value);
                    if (telefonoNormalizado && display) {
                        display.textContent = window.formatearTelefono(telefonoNormalizado);
                    }
                    
                    // Generar link de WhatsApp
                    if (whatsappId) {
                        const whatsappField = document.getElementById(whatsappId);
                        if (whatsappField && telefonoNormalizado) {
                            whatsappField.value = window.generarLinkWhatsApp(telefonoNormalizado, 'Hola desde Ecoplagas');
                        }
                    }
                    
                    // Cargar sucursales
                    if (sucursalSelectId && telefonoNormalizado) {
                        await window.cargarSucursalesEnSelect(sucursalSelectId, telefonoNormalizado);
                        
                        // Si hay solo una sucursal, pre-seleccionarla y disparar change para llenar todo y mostrar botón editar
                        const select = document.getElementById(sucursalSelectId);
                        if (select && select.options.length === 2) { // 1 sucursal + opción "nueva"
                            select.value = select.options[0].value;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    if (display) display.textContent = '';
                    if (whatsappId) {
                        const whatsappField = document.getElementById(whatsappId);
                        if (whatsappField) whatsappField.value = '';
                    }
                    if (sucursalSelectId) {
                        const select = document.getElementById(sucursalSelectId);
                        if (select) select.innerHTML = '<option value="">Ingrese teléfono primero</option>';
                    }
                }
            }
            
            // Event listener para teléfono en formulario de edición
            if (editClientPhone) {
                editClientPhone.addEventListener('input', async function() {
                    await manejarCambioTelefono(this, editPhoneDisplay, 'editSucursal', 'editWhatsApp', 'editNombreSucursal');
                });
                
                editClientPhone.addEventListener('blur', async function() {
                    await manejarCambioTelefono(this, editPhoneDisplay, 'editSucursal', 'editWhatsApp', 'editNombreSucursal');
                });
            }
            
            // Event listener para teléfono en formulario de nueva cita
            if (newClientPhone) {
                newClientPhone.addEventListener('input', async function() {
                    await manejarCambioTelefono(this, newPhoneDisplay, 'newSucursal', 'newWhatsApp', 'newNombreSucursal');
                });
                
                newClientPhone.addEventListener('blur', async function() {
                    await manejarCambioTelefono(this, newPhoneDisplay, 'newSucursal', 'newWhatsApp', 'newNombreSucursal');
                });
            }
            
            // Event listeners para selección de sucursal
            const editSucursal = document.getElementById('editSucursal');
            const newSucursal = document.getElementById('newSucursal');
            const editNombreSucursal = document.getElementById('editNombreSucursal');
            const newNombreSucursal = document.getElementById('newNombreSucursal');
            const btnNuevaSucursalEdit = document.getElementById('btnNuevaSucursalEdit');
            const btnNuevaSucursalNew = document.getElementById('btnNuevaSucursalNew');
            
            async function manejarCambioSucursal(select, nombreField, btnNueva, esEdit = false) {
                if (select.value === 'nueva') {
                    if (nombreField) nombreField.style.display = 'block';
                    if (btnNueva) btnNueva.disabled = true;
                    // Limpiar campos de coordenadas si se crea nueva
                    if (esEdit) {
                        document.getElementById('editCoordenadas').value = '';
                        document.getElementById('editProvincia').value = '';
                        document.getElementById('editCanton').value = '';
                        document.getElementById('editDistrito').value = '';
                        document.getElementById('editDireccion').value = '';
                        document.getElementById('editOtrasSenas').value = '';
                    } else {
                        document.getElementById('newCoordenadas').value = '';
                        document.getElementById('newProvincia').value = '';
                        document.getElementById('newCanton').value = '';
                        document.getElementById('newDistrito').value = '';
                        document.getElementById('newDireccion').value = '';
                        document.getElementById('newOtrasSenas').value = '';
                    }
                } else if (select.value) {
                    if (nombreField) nombreField.style.display = 'none';
                    if (btnNueva) btnNueva.disabled = false;
                    
                    // Cargar datos de la sucursal seleccionada
                    try {
                        // Obtener teléfono del cliente
                        const telefonoInput = esEdit ? 
                            document.getElementById('editClientPhone') : 
                            document.getElementById('newClientPhone');
                        const telefono = telefonoInput?.value.trim();
                        
                        if (!telefono) return;
                        
                        const telefonoNormalizado = window.normalizarTelefono(telefono);
                        if (!telefonoNormalizado) return;
                        
                        const sucursalIndice = parseInt(select.value);
                        const sucursal = await window.obtenerSucursalPorIndice(telefonoNormalizado, sucursalIndice);
                        
                        if (sucursal) {
                            
                            // Pre-llenar nombre de sucursal
                            if (nombreField) nombreField.value = sucursal.nombre || '';
                            
                            // Pre-llenar coordenadas
                            if (sucursal.coordenadas) {
                                const coordsTexto = `${sucursal.coordenadas.lat}, ${sucursal.coordenadas.lng}`;
                                if (esEdit) {
                                    document.getElementById('editCoordenadas').value = coordsTexto;
                                    // Procesar coordenadas para actualizar mapa y ubicación
                                    if (window.procesarCoordenadasEdit) {
                                        await window.procesarCoordenadasEdit(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
                                    }
                                } else {
                                    document.getElementById('newCoordenadas').value = coordsTexto;
                                    // Procesar coordenadas para actualizar mapa y ubicación
                                    if (window.procesarCoordenadasNew) {
                                        await window.procesarCoordenadasNew(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
                                    }
                                }
                            }
                            
                            // Pre-llenar ubicación
                            if (esEdit) {
                                if (sucursal.provinciaId) document.getElementById('editProvincia').value = sucursal.provinciaId;
                                if (sucursal.cantonId) document.getElementById('editCanton').value = sucursal.cantonId;
                                if (sucursal.distritoId) document.getElementById('editDistrito').value = sucursal.distritoId;
                                if (sucursal.direccion) document.getElementById('editDireccion').value = sucursal.direccion;
                                if (sucursal.otras_senas || sucursal.otrasSenas) document.getElementById('editOtrasSenas').value = sucursal.otras_senas || sucursal.otrasSenas;
                            } else {
                                if (sucursal.provinciaId) document.getElementById('newProvincia').value = sucursal.provinciaId;
                                if (sucursal.cantonId) document.getElementById('newCanton').value = sucursal.cantonId;
                                if (sucursal.distritoId) document.getElementById('newDistrito').value = sucursal.distritoId;
                                if (sucursal.direccion) document.getElementById('newDireccion').value = sucursal.direccion;
                                if (sucursal.otras_senas || sucursal.otrasSenas) document.getElementById('newOtrasSenas').value = sucursal.otras_senas || sucursal.otrasSenas;
                            }
                        }
                    } catch (error) {
                        console.error('Error cargando datos de sucursal:', error);
                    }
                }
            }
            
            function actualizarVisibilidadBotonEditarSucursal(esEdit) {
                const select = esEdit ? editSucursal : newSucursal;
                const btn = document.getElementById(esEdit ? 'btnEditarSucursalEdit' : 'btnEditarSucursalNew');
                if (!select || !btn) return;
                const v = select.value;
                const tieneSucursalSeleccionada = v !== '' && v !== 'nueva' && !isNaN(parseInt(v, 10));
                btn.style.display = tieneSucursalSeleccionada ? 'inline-block' : 'none';
            }
            
            if (editSucursal) {
                editSucursal.addEventListener('change', async function() {
                    await manejarCambioSucursal(this, editNombreSucursal, btnNuevaSucursalEdit, true);
                    actualizarVisibilidadBotonEditarSucursal(true);
                });
            }
            
            if (newSucursal) {
                newSucursal.addEventListener('change', async function() {
                    await manejarCambioSucursal(this, newNombreSucursal, btnNuevaSucursalNew, false);
                    actualizarVisibilidadBotonEditarSucursal(false);
                });
            }
            
            window.actualizarVisibilidadBotonEditarSucursal = actualizarVisibilidadBotonEditarSucursal;
            
            // Abrir modal editar sucursal (solo cuando hay sucursal seleccionada)
            async function abrirModalEditarSucursal(esEdit) {
                const select = esEdit ? editSucursal : newSucursal;
                const telefonoInput = document.getElementById(esEdit ? 'editClientPhone' : 'newClientPhone');
                const telefono = telefonoInput?.value?.trim();
                const val = select?.value;
                if (!telefono || val === '' || val === 'nueva' || isNaN(parseInt(val, 10))) return;
                const telefonoNormalizado = window.normalizarTelefono(telefono);
                if (!telefonoNormalizado) return;
                const sucursalIndice = parseInt(val, 10);
                const sucursal = await window.obtenerSucursalPorIndice(telefonoNormalizado, sucursalIndice);
                if (!sucursal) return;
                const modal = document.getElementById('modalEditarSucursal');
                modal.dataset.telefono = telefonoNormalizado;
                modal.dataset.sucursalIndice = String(sucursalIndice);
                modal.dataset.esEdit = esEdit ? '1' : '0';
                document.getElementById('sucursalModalNombre').value = sucursal.nombre || '';
                document.getElementById('sucursalModalCoordenadas').value = sucursal.coordenadas ? `${sucursal.coordenadas.lat}, ${sucursal.coordenadas.lng}` : '';
                document.getElementById('sucursalModalDireccion').value = sucursal.direccion || '';
                document.getElementById('sucursalModalOtrasSenas').value = sucursal.otras_senas || sucursal.otrasSenas || '';
                const sp = document.getElementById('sucursalModalProvincia');
                const sc = document.getElementById('sucursalModalCanton');
                const sd = document.getElementById('sucursalModalDistrito');
                if (window.ubicacionesCR && sp) {
                    sp.innerHTML = '<option value="">Seleccionar provincia...</option>';
                    Object.values(window.ubicacionesCR).forEach(prov => {
                        const o = document.createElement('option');
                        o.value = prov.id;
                        o.textContent = prov.nombre;
                        sp.appendChild(o);
                    });
                    sp.value = sucursal.provinciaId || '';
                    sp.disabled = false;
                    sc.innerHTML = '<option value="">Cantón...</option>';
                    sc.disabled = true;
                    sd.innerHTML = '<option value="">Distrito...</option>';
                    sd.disabled = true;
                    if (sucursal.provinciaId) {
                        const prov = window.ubicacionesCR[sucursal.provinciaId];
                        if (prov && prov.cantones) {
                            sc.innerHTML = '<option value="">Seleccionar cantón...</option>';
                            Object.values(prov.cantones).forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.nombre; sc.appendChild(o); });
                            sc.disabled = false;
                            sc.value = sucursal.cantonId || '';
                        }
                        if (sucursal.cantonId && prov && prov.cantones && prov.cantones[sucursal.cantonId]) {
                            const canton = prov.cantones[sucursal.cantonId];
                            if (canton.distritos) {
                                sd.innerHTML = '<option value="">Seleccionar distrito...</option>';
                                Object.values(canton.distritos).forEach(d => { const o = document.createElement('option'); o.value = d.id; o.textContent = d.nombre; sd.appendChild(o); });
                                sd.disabled = false;
                                sd.value = sucursal.distritoId || '';
                            }
                        }
                    }
                }
                bootstrap.Modal.getOrCreateInstance(modal).show();
            }
            
            (function initModalSucursalProvinciaCanton() {
                const sp = document.getElementById('sucursalModalProvincia');
                const sc = document.getElementById('sucursalModalCanton');
                const sd = document.getElementById('sucursalModalDistrito');
                if (!sp || !sc || !sd) return;
                sp.addEventListener('change', function() {
                    const pid = this.value;
                    sc.innerHTML = '<option value="">Cantón...</option>';
                    sd.innerHTML = '<option value="">Distrito...</option>';
                    sd.disabled = true;
                    if (!pid || !window.ubicacionesCR || !window.ubicacionesCR[pid]) { sc.disabled = true; return; }
                    const prov = window.ubicacionesCR[pid];
                    if (prov.cantones) {
                        sc.innerHTML = '<option value="">Seleccionar cantón...</option>';
                        Object.values(prov.cantones).forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.nombre; sc.appendChild(o); });
                        sc.disabled = false;
                    }
                });
                sc.addEventListener('change', function() {
                    const pid = sp.value;
                    const cid = this.value;
                    sd.innerHTML = '<option value="">Distrito...</option>';
                    if (!pid || !cid || !window.ubicacionesCR || !window.ubicacionesCR[pid]) { sd.disabled = true; return; }
                    const canton = window.ubicacionesCR[pid].cantones && window.ubicacionesCR[pid].cantones[cid] ? window.ubicacionesCR[pid].cantones[cid] : null;
                    if (canton && canton.distritos) {
                        sd.innerHTML = '<option value="">Seleccionar distrito...</option>';
                        Object.values(canton.distritos).forEach(d => { const o = document.createElement('option'); o.value = d.id; o.textContent = d.nombre; sd.appendChild(o); });
                        sd.disabled = false;
                    }
                });
            })();
            
            document.getElementById('btnEditarSucursalEdit').addEventListener('click', () => abrirModalEditarSucursal(true));
            document.getElementById('btnEditarSucursalNew').addEventListener('click', () => abrirModalEditarSucursal(false));
            
            document.getElementById('btnGuardarSucursalModal').addEventListener('click', async function() {
                const modal = document.getElementById('modalEditarSucursal');
                const telefono = modal.dataset.telefono;
                const sucursalIndice = parseInt(modal.dataset.sucursalIndice, 10);
                const esEdit = modal.dataset.esEdit === '1';
                if (!telefono || isNaN(sucursalIndice)) return;
                const nombre = document.getElementById('sucursalModalNombre').value.trim() || 'Hogar principal';
                const coordsTexto = document.getElementById('sucursalModalCoordenadas').value.trim();
                const provinciaId = document.getElementById('sucursalModalProvincia').value || '';
                const cantonId = document.getElementById('sucursalModalCanton').value || '';
                const distritoId = document.getElementById('sucursalModalDistrito').value || '';
                const direccion = document.getElementById('sucursalModalDireccion').value.trim() || '';
                const otras_senas = document.getElementById('sucursalModalOtrasSenas').value.trim() || '';
                let coordenadas = null;
                if (coordsTexto) {
                    const parsed = window.limpiarYExtraerCoordenadas ? window.limpiarYExtraerCoordenadas(coordsTexto) : null;
                    if (parsed && !isNaN(parsed.lat) && !isNaN(parsed.lng)) {
                        if (window.validarCoordenadasCostaRica && !window.validarCoordenadasCostaRica(parsed.lat, parsed.lng)) {
                            alert('Las coordenadas deben estar dentro de Costa Rica.');
                            return;
                        }
                        coordenadas = { lat: parsed.lat, lng: parsed.lng, texto: coordsTexto };
                    } else if (coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/)) {
                        const m = coordsTexto.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
                        coordenadas = { lat: parseFloat(m[1]), lng: parseFloat(m[2]), texto: coordsTexto };
                    }
                }
                const datos = {
                    nombre: nombre,
                    provinciaId: provinciaId,
                    cantonId: cantonId,
                    distritoId: distritoId,
                    direccion: direccion,
                    otras_senas: otras_senas
                };
                if (coordenadas) datos.coordenadas = coordenadas;
                else datos.coordenadas = null;
                try {
                    await window.actualizarSucursal(telefono, sucursalIndice, datos);
                    bootstrap.Modal.getInstance(modal).hide();
                    const select = esEdit ? editSucursal : newSucursal;
                    if (select) await manejarCambioSucursal(select, esEdit ? editNombreSucursal : newNombreSucursal, esEdit ? btnNuevaSucursalEdit : btnNuevaSucursalNew, esEdit);
                } catch (e) {
                    console.error('Error guardando sucursal:', e);
                    alert('Error al guardar la sucursal: ' + (e.message || e));
                }
            });
            
            if (btnNuevaSucursalEdit) {
                btnNuevaSucursalEdit.addEventListener('click', function() {
                    if (editSucursal) {
                        editSucursal.value = 'nueva';
                        editSucursal.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            if (btnNuevaSucursalNew) {
                btnNuevaSucursalNew.addEventListener('click', function() {
                    if (newSucursal) {
                        newSucursal.value = 'nueva';
                        newSucursal.dispatchEvent(new Event('change'));
                    }
                });
        }

            // Inicializar
            console.log('🔍 [INIT] Iniciando event listener load...');
            // Verificar que el código se ejecuta
            console.log('🔍 [INIT] Código de inicialización ejecutándose...');
            window.addEventListener('load', async () => {
                console.log('🔍 [load] Evento load disparado');
                // Vista extendida siempre activa (botón de vista compacta eliminado)
                
                // Inicializar semana actual (mantenido para compatibilidad)
                if (!window.semanaActual) {
                    function obtenerLunesSemanaInit(fecha) {
                        const d = new Date(fecha);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        return new Date(d.setDate(diff));
                    }
                    window.semanaActual = obtenerLunesSemanaInit(new Date());
                    console.log('✅ [load] semanaActual inicializada:', window.semanaActual);
                }
                
                // Cargar ubicaciones al iniciar
                await cargarUbicaciones();
                
                if (datePicker) {
                    datePicker.value = formatearFechaParaInput(diaSeleccionado);
                }
                
                // Inicializar botones de días del mes
                if (diaSeleccionado) {
                    generarBotonesDiasMes(diaSeleccionado);
                }
                
                // Cargar empleados al inicio
                await cargarEmpleados();
                // Cargar servicios al inicio
                await window.cargarServicios();
                // Cargar productos al inicio
                await window.cargarProductos();
                // Cargar herramientas al inicio (para el dropdown de Equipo y Herramientas)
                await window.cargarEquipo();
                // Mostrar cronograma por defecto (ahora con botón ya configurado)
                await cambiarVista('cronograma');
                await cargarDatos();
            });
            
        // Función para inicializar el buscador de citas
        window.inicializarBuscadorCitas = function() {
            const buscadorInput = document.getElementById('buscadorCitas');
            const resultadosDropdown = document.getElementById('resultadosBusquedaCitas');
            
            if (!buscadorInput || !resultadosDropdown) {
                console.warn('⚠️ Campos del buscador de citas no encontrados');
                return;
            }
            
            let timeoutBusqueda;
            
            // Event listener para la búsqueda
            buscadorInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Limpiar timeout anterior
                clearTimeout(timeoutBusqueda);
                
                if (query.length < 2) {
                    resultadosDropdown.style.display = 'none';
                    resultadosDropdown.innerHTML = '';
                    return;
                }
                
                // Debounce: esperar 300ms antes de buscar
                timeoutBusqueda = setTimeout(() => {
                    buscarCitas(query);
                }, 300);
            });
            
            // Ocultar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!buscadorInput.contains(e.target) && !resultadosDropdown.contains(e.target)) {
                    resultadosDropdown.style.display = 'none';
                }
            });
            
            // Función para buscar citas
            async function buscarCitas(query) {
                if (!window.todasLasCitas || window.todasLasCitas.length === 0) {
                    resultadosDropdown.innerHTML = '<div class="dropdown-item-text text-muted">No hay citas disponibles</div>';
                    resultadosDropdown.style.display = 'block';
                    return;
                }
                
                const queryLower = query.toLowerCase();
                const resultados = [];
                
                // Buscar en todas las citas
                for (const cita of window.todasLasCitas) {
                    // Buscar por teléfono
                    const telefono = window.obtenerTelefono(cita);
                    const telefonoNormalizado = telefono.replace(/\D/g, ''); // Solo números
                    const queryNormalizada = query.replace(/\D/g, ''); // Solo números de la búsqueda
                    
                    let coincide = false;
                    
                    // Coincidencia por teléfono
                    if (telefonoNormalizado.includes(queryNormalizada) || telefono.includes(queryLower)) {
                        coincide = true;
                    }
                    
                    // Coincidencia por nombre del cliente
                    if (!coincide) {
                        let nombreCliente = '';
                        if (window.obtenerClienteNombreSync) {
                            nombreCliente = window.obtenerClienteNombreSync(cita) || '';
                        } else {
                            nombreCliente = window.obtenerCampoCita(cita, 'cliente_nombre', '') || '';
                        }
                        
                        if (nombreCliente.toLowerCase().includes(queryLower)) {
                            coincide = true;
                        }
                    }
                    
                    if (coincide) {
                        // Obtener información de la cita
                        const fechaInicio = window.formatearFecha ? window.formatearFecha(window.obtenerInicio(cita)) : null;
                        const fechaFormateada = fechaInicio ? fechaInicio.toLocaleDateString('es-CR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Fecha no disponible';
                        
                        let nombreCliente = '';
                        if (window.obtenerClienteNombreSync) {
                            nombreCliente = window.obtenerClienteNombreSync(cita) || 'Sin nombre';
                        } else {
                            nombreCliente = window.obtenerCampoCita(cita, 'cliente_nombre', '') || 'Sin nombre';
                        }
                        
                        const telefonoMostrar = telefono || 'Sin teléfono';
                        const estadoDisplay = window.estadoDisplayCita ? window.estadoDisplayCita(cita) : { texto: 'Agendada', clase: 'agendada' };
                        
                        resultados.push({
                            cita: cita,
                            nombre: nombreCliente,
                            telefono: telefonoMostrar,
                            fecha: fechaFormateada,
                            estadoTexto: estadoDisplay.texto,
                            estadoClase: estadoDisplay.clase
                        });
                    }
                }
                
                // Limitar a 10 resultados
                const resultadosLimitados = resultados.slice(0, 10);
                
                // Mostrar resultados
                if (resultadosLimitados.length === 0) {
                    resultadosDropdown.innerHTML = '<div class="dropdown-item-text text-muted">No se encontraron citas</div>';
                } else {
                    resultadosDropdown.innerHTML = resultadosLimitados.map(item => {
                        const estadoClass = item.estadoClase === 'confirmada-24-48' ? 'success' : 'secondary';
                        return `
                            <a href="#" class="dropdown-item" data-cita-id="${item.cita.id}" style="padding: 0.75rem; border-bottom: 1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #000; margin-bottom: 4px;">${item.nombre}</div>
                                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 2px;">
                                            <i class="fas fa-phone me-1"></i>${item.telefono}
                                        </div>
                                        <div style="font-size: 0.85rem; color: #666;">
                                            <i class="fas fa-calendar me-1"></i>${item.fecha}
                                        </div>
                                    </div>
                                    <span class="badge bg-${estadoClass}" style="margin-left: 8px;">${item.estadoTexto}</span>
                                </div>
                            </a>
                        `;
                    }).join('');
                    
                    // Agregar event listeners a los resultados
                    resultadosDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            const citaId = item.getAttribute('data-cita-id');
                            if (citaId && window.abrirModalEdicion) {
                                // Cerrar dropdown
                                resultadosDropdown.style.display = 'none';
                                buscadorInput.value = '';
                                // Abrir modal de edición
                                window.abrirModalEdicion(citaId);
                            }
                        });
                    });
                }
                
                resultadosDropdown.style.display = 'block';
            }
        };
            
        // Variables globales para gráficos
        // Código del reporte táctico movido a reporte_tactico.html
            
        // Código del reporte táctico movido a reporte_tactico.html
            
        } catch (error) {
            console.error('❌ Error al cargar Firebase:', error);
            alert('Error al cargar Firebase. Verifica la consola para más detalles.');
        }
    </script>

    <script>
        // Verificar autenticación al cargar la página
        window.addEventListener('load', async function() {
            // Verificar permisos de acceso
            if (!checkPagePermissions()) {
                return;
            }
            // Verificar que el body esté autenticado (ya verificado en el head)
            if (document.body && !document.body.classList.contains('authenticated')) {
                console.log('⏳ [CALENDARIO_SECURE] Esperando verificación de autenticación del head...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (!document.body.classList.contains('authenticated')) {
                    if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                        console.log('❌ [CALENDARIO_SECURE] No autenticado, redirigiendo...');
                        if (!window.location.pathname.includes('iniciar_sesion.html')) {
                            window.location.replace('iniciar_sesion.html');
                        }
                        return;
                    } else {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                }
            }
            
            // Esperar a secureAuthManager
            if (!window.secureAuthManager) {
                let retries = 0;
                while (!window.secureAuthManager && retries < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
            }
            
            if (window.secureAuthManager) {
                window.authManager = window.secureAuthManager;
            }
            
            if (window.authManager && window.authManager.isAuthenticated()) {
                // Mostrar información del usuario (desde load-headersecure.js)
                if (window.headerLoader && window.headerLoader.showUserInfo) {
                    window.headerLoader.showUserInfo();
                }
                // Agregar funcionalidad de logout (desde load-headersecure.js)
                if (window.headerLoader && window.headerLoader.addLogoutButton) {
                    window.headerLoader.addLogoutButton();
                }
            }
            
            // Vista extendida siempre activa (botón de vista compacta eliminado)
            // La navegación de semana está oculta ya que solo mostramos un día operacional
        });
        
        // Función para vista previa de migración
        window.previewMigracionRutas = async function() {
            const rutaOrigen = document.getElementById('rutaOrigenMigrar').value;
            const rutaDestino = document.getElementById('rutaDestinoMigrar').value;
            const fechaDia = document.getElementById('fechaDiaMigrar').value;
            
            if (!rutaOrigen || !rutaDestino) {
                alert('Por favor selecciona la ruta destino');
                return;
            }
            
            if (rutaOrigen === rutaDestino) {
                alert('La ruta origen y destino no pueden ser la misma');
                return;
            }
            
            try {
                const btnPreview = document.getElementById('btnPreviewMigracion');
                btnPreview.disabled = true;
                btnPreview.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Buscando...';
                
                // Usar la fecha del modal (día del cronograma desde el que se abrió Migrar), no window.diaSeleccionado
                const fechaDiaStr = (document.getElementById('fechaDiaMigrar') && document.getElementById('fechaDiaMigrar').value) || '';
                let year, month, day;
                if (fechaDiaStr && /^\d{4}-\d{2}-\d{2}$/.test(fechaDiaStr)) {
                    const [y, m, d] = fechaDiaStr.split('-').map(Number);
                    year = y;
                    month = m - 1;
                    day = d;
                } else {
                    const fallback = window.diaSeleccionado || new Date();
                    year = fallback.getFullYear();
                    month = fallback.getMonth();
                    day = fallback.getDate();
                }
                
                // Calcular rango del día laborable (5am a 5am del siguiente día)
                const fechaInicioDiaLaborable = new Date(year, month, day, 5, 0, 0);
                const fechaFinDiaLaborable = new Date(year, month, day + 1, 4, 59, 59);
                
                // Buscar citas de la ruta origen solo del día laborable seleccionado
                const todasLasCitas = window.todasLasCitas || [];
                const citasFiltradas = todasLasCitas.filter(cita => {
                    const rutaCita = window.obtenerRuta(cita);
                    if (rutaCita !== rutaOrigen) return false;
                    
                    const fechaCita = window.formatearFecha(window.obtenerInicio(cita));
                    if (!fechaCita) return false;
                    
                    // Verificar si la cita está en el rango del día laborable
                    const duracion = window.obtenerDuracion(cita);
                    const fechaFinCita = new Date(fechaCita.getTime() + duracion * 60000);
                    
                    const estaEnRango = (fechaCita >= fechaInicioDiaLaborable && fechaCita <= fechaFinDiaLaborable) ||
                                       (fechaFinCita >= fechaInicioDiaLaborable && fechaFinCita <= fechaFinDiaLaborable) ||
                                       (fechaCita <= fechaInicioDiaLaborable && fechaFinCita >= fechaFinDiaLaborable);
                    
                    return estaEnRango;
                });
                
                // Mostrar preview
                document.getElementById('totalCitasMigrar').textContent = citasFiltradas.length;
                document.getElementById('previewRutaOrigen').textContent = rutaOrigen;
                document.getElementById('previewRutaDestino').textContent = rutaDestino;
                document.getElementById('previewMigracion').style.display = 'block';
                document.getElementById('btnConfirmarMigracion').disabled = false;
                
                btnPreview.disabled = false;
                btnPreview.innerHTML = '<i class="fas fa-eye me-2"></i>Vista Previa';
                
            } catch (error) {
                console.error('Error en vista previa:', error);
                alert('Error al generar vista previa: ' + error.message);
                const btnPreview = document.getElementById('btnPreviewMigracion');
                btnPreview.disabled = false;
                btnPreview.innerHTML = '<i class="fas fa-eye me-2"></i>Vista Previa';
            }
        };
        
        // Función para confirmar y ejecutar migración
        window.confirmarMigracionRutas = async function() {
            const rutaOrigen = document.getElementById('rutaOrigenMigrar').value;
            const rutaDestino = document.getElementById('rutaDestinoMigrar').value;
            
            if (!rutaOrigen || !rutaDestino) {
                alert('Por favor selecciona la ruta destino');
                return;
            }
            
            if (rutaOrigen === rutaDestino) {
                alert('La ruta origen y destino no pueden ser la misma');
                return;
            }
            
            // Confirmación final
            const confirmacion = confirm(
                `¿Estás seguro de migrar todas las citas de "${rutaOrigen}" a "${rutaDestino}" del día seleccionado?\n\n` +
                `Esta acción actualizará la ruta de todas las citas del día laborable (5am a 5am del siguiente día).`
            );
            
            if (!confirmacion) return;
            
            try {
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Migrando...';
                
                // Usar la fecha del modal (día del cronograma desde el que se abrió Migrar), no window.diaSeleccionado
                const fechaDiaStrConfirm = (document.getElementById('fechaDiaMigrar') && document.getElementById('fechaDiaMigrar').value) || '';
                let year, month, day;
                if (fechaDiaStrConfirm && /^\d{4}-\d{2}-\d{2}$/.test(fechaDiaStrConfirm)) {
                    const [y, m, d] = fechaDiaStrConfirm.split('-').map(Number);
                    year = y;
                    month = m - 1;
                    day = d;
                } else {
                    const fallback = window.diaSeleccionado || new Date();
                    year = fallback.getFullYear();
                    month = fallback.getMonth();
                    day = fallback.getDate();
                }
                
                // Calcular rango del día laborable (5am a 5am del siguiente día)
                const fechaInicioDiaLaborable = new Date(year, month, day, 5, 0, 0);
                const fechaFinDiaLaborable = new Date(year, month, day + 1, 4, 59, 59);
                
                // Buscar citas de la ruta origen solo del día laborable seleccionado
                const todasLasCitas = window.todasLasCitas || [];
                const citasAMigrar = todasLasCitas.filter(cita => {
                    const rutaCita = window.obtenerRuta(cita);
                    if (rutaCita !== rutaOrigen) return false;
                    
                    const fechaCita = window.formatearFecha(window.obtenerInicio(cita));
                    if (!fechaCita) return false;
                    
                    // Verificar si la cita está en el rango del día laborable
                    const duracion = window.obtenerDuracion(cita);
                    const fechaFinCita = new Date(fechaCita.getTime() + duracion * 60000);
                    
                    const estaEnRango = (fechaCita >= fechaInicioDiaLaborable && fechaCita <= fechaFinDiaLaborable) ||
                                       (fechaFinCita >= fechaInicioDiaLaborable && fechaFinCita <= fechaFinDiaLaborable) ||
                                       (fechaCita <= fechaInicioDiaLaborable && fechaFinCita >= fechaFinDiaLaborable);
                    
                    return estaEnRango;
                });
                
                if (citasAMigrar.length === 0) {
                    alert('No se encontraron citas para migrar del día seleccionado');
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar Migración';
                    return;
                }
                
                // Migrar cada cita
                let migradas = 0;
                let errores = 0;
                
                for (const cita of citasAMigrar) {
                    try {
                        // Obtener metadata actual o crear nueva
                        const metadataActual = cita.metadata || {};
                        
                        // Actualizar solo la ruta en metadata
                        await window.updateDoc(window.doc(window.db, 'citas', cita.id), {
                            metadata: {
                                ...metadataActual,
                                ruta: rutaDestino
                            },
                            fecha_actualizacion: window.serverTimestamp()
                        });
                        
                        migradas++;
                    } catch (error) {
                        console.error(`Error migrando cita ${cita.id}:`, error);
                        errores++;
                    }
                }
                
                // Mostrar resultado
                if (errores === 0) {
                    alert(`✅ Migración completada exitosamente\n\n${migradas} cita(s) migrada(s) de "${rutaOrigen}" a "${rutaDestino}"`);
                } else {
                    alert(`⚠️ Migración completada con algunos errores\n\n✅ Migradas: ${migradas}\n❌ Errores: ${errores}`);
                }
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('modalMigrarRutas')).hide();
                
                // Limpiar formulario
                document.getElementById('rutaOrigenMigrar').value = '';
                document.getElementById('rutaDestinoMigrar').value = '';
                document.getElementById('fechaDiaMigrar').value = '';
                document.getElementById('previewMigracion').style.display = 'none';
                document.getElementById('btnConfirmarMigracion').disabled = true;
                
                // Recargar datos
                if (window.cargarDatos) {
                    await window.cargarDatos();
                }
                
            } catch (error) {
                console.error('Error en migración:', error);
                alert('Error al migrar citas: ' + error.message);
                const btnConfirmar = document.getElementById('btnConfirmarMigracion');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar Migración';
            }
        };
    </script>

    <!-- ========== MODAL: ELIMINAR CITAS ========== -->
    <!-- data-section="modal-eliminar-citas" -->
    <div class="modal fade" id="modalEliminarCitas" data-section="modal-eliminar-citas" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-trash-alt me-2"></i>Eliminar Citas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> Esta acción NO se puede deshacer. Por favor, seleccione el tipo de eliminación.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Eliminación <span class="text-danger">*</span></label>
                        <select id="tipoEliminacion" class="form-select" required>
                            <option value="">Seleccione una opción...</option>
                            <option value="todas">Eliminar Todas las Citas</option>
                            <option value="rango">Eliminar por Rango de Fechas</option>
                            <option value="mayor">Eliminar Citas Mayores o Iguales a una Fecha</option>
                            <option value="menor">Eliminar Citas Menores o Iguales a una Fecha</option>
                        </select>
                    </div>
                    
                    <!-- Rango de Fechas -->
                    <div id="opcionesRango" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" id="fechaInicioRango" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" id="fechaFinRango" class="form-control">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>Se eliminarán todas las citas cuya fecha de inicio esté dentro del rango especificado (inclusive).</small>
                        </div>
                    </div>
                    
                    <!-- Mayor o Igual -->
                    <div id="opcionesMayor" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha Límite <span class="text-danger">*</span></label>
                            <input type="date" id="fechaMayor" class="form-control">
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>Se eliminarán todas las citas cuya fecha de inicio sea mayor o igual a la fecha especificada (inclusive).</small>
                        </div>
                    </div>
                    
                    <!-- Menor o Igual -->
                    <div id="opcionesMenor" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha Límite <span class="text-danger">*</span></label>
                            <input type="date" id="fechaMenor" class="form-control">
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>Se eliminarán todas las citas cuya fecha de inicio sea menor o igual a la fecha especificada (inclusive).</small>
                        </div>
                    </div>
                    
                    <!-- Vista Previa -->
                    <div id="vistaPreviaEliminacion" class="alert alert-secondary" style="display: none;">
                        <strong>Vista Previa:</strong>
                        <div id="textoVistaPrevia" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnConfirmarEliminacion" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Cargador de Header Unificado -->
    <script src="cache-buster.js"></script>
    <script type="module" src="load-headersecure.js"></script>
</body>
</html>

