<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Horas Seguro - Eco Plagas</title>
    <!-- Deploy timestamp: 2026-01-09 01:15:00 CST -->
    <script>
        (function() {
            const deployInfo = {
                date: '2026-01-09',
                time: '01:15:00',
                timezone: 'CST',
                timestamp: '2026-01-09T07:15:00.000Z'
            };
            console.log('%cüöÄ DEPLOY INFO', 'color: #0b7835; font-weight: bold; font-size: 14px;');
            console.log('üìÖ Deploy Date:', `${deployInfo.date} ${deployInfo.time} ${deployInfo.timezone}`);
            console.log('üïê Timestamp:', deployInfo.timestamp);
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="eco-plagas-styles.css?v=1.6.0" rel="stylesheet">
    <link href="unified-styles.css?v=1.0" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Fuente unificada Inter para toda la p√°gina */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }
        
        /* Excepci√≥n para iconos de Font Awesome */
        i[class*="fa-"], i[class^="fa-"], .fas, .far, .fab, .fal, .fad, [class*=" fa-"], [class^="fa-"] {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "FontAwesome" !important;
            font-weight: 900 !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-transform: none !important;
            line-height: 1 !important;
            display: inline-block !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Ocultar contenido hasta verificar autenticaci√≥n */
        body {
            display: none !important;
        }
        body.authenticated {
            display: block !important;
        }
        
        .jornada-type {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            color: #495057;
        }

        .policy-section {
            margin: 20px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .policy-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .policy-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .policy-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .policy-header i {
            transition: transform 0.3s ease;
        }

        .policy-header.expanded i {
            transform: rotate(180deg);
        }

        .policy-content {
            background: white;
            padding: 20px;
            display: none;
        }
        
        .gps-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gps-info i {
            color: #1976d2;
        }

        .policy-content.show {
            display: block;
        }

        .policy-text {
            line-height: 1.6;
            color: #333;
        }

        .policy-text h4 {
            color: #495057;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }

        .policy-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .policy-text li {
            margin: 5px 0;
        }

        .policy-text p {
            margin: 10px 0;
        }

        /* Estilos para modal de inventario - Mobile friendly */
        @media (max-width: 768px) {
            .modal-dialog.modal-lg {
                max-width: 95%;
                margin: 0.5rem auto;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .btn-lg {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
            
            .input-group-lg .btn {
                min-width: 45px;
                font-size: 1.1rem;
            }
            
            .input-group-lg input {
                font-size: 1rem;
            }
            
            .card-body {
                padding: 1rem !important;
            }
            
            .form-check-input {
                width: 22px !important;
                height: 22px !important;
                margin-top: 0.25rem;
            }
        }

        .producto-faltante-item {
            transition: all 0.2s ease;
        }

        .producto-faltante-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-group-lg .btn {
            padding: 0.5rem 0.75rem;
        }

        .modal-content.modal-apv,
        .modal-content.modal-especial {
            border: 0;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
        }

        .modal-apv-header {
            background: linear-gradient(135deg, #0d6efd 0%, #5a6ffb 100%);
            color: #fff;
            border-bottom: none;
            align-items: center;
        }

        .modal-especial-header {
            background: linear-gradient(135deg, #0f5132 0%, #198754 100%);
            color: #fff;
            border-bottom: none;
            align-items: center;
        }

        .modal-apv-body {
            background: #f5f8ff;
        }

        .modal-especial-body {
            background: #f3fdf8;
        }

        .modal-apv-footer,
        .modal-especial-footer {
            border-top: none;
        }

        .modal-apv-highlight,
        .modal-especial-highlight {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-apv-highlight {
            color: #0d6efd;
        }

        .modal-especial-highlight {
            color: #146c43;
        }

        .modal-compact-text p {
            margin-bottom: 0.5rem;
        }

        .modal-compact-buttons .btn {
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }

        .modal-compact-buttons .btn i {
            font-size: 1.1rem;
        }

        /* Estilos Mejorados Reportes del Mes - Compacto */
        .summary-stats-container {
            background: #ffffff;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .stat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            background-color: #ffffff;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .stat-row:hover {
            background-color: #ffffff;
            border-color: rgba(0, 0, 0, 0.08);
        }

        .stat-icon {
            width: auto;
            height: auto;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            background: transparent;
            padding: 0;
            margin-right: 0.5rem;
        }

        .stat-icon.worked { background-color: transparent; color: #1565c0; opacity: 0.7; }
        .stat-icon.expected { background-color: transparent; color: #6a1b9a; opacity: 0.7; }
        
        .highlight-stat {
            background-color: transparent;
            border: none;
        }

        .highlight-stat.positive .stat-icon { background-color: transparent; color: #2e7d32; opacity: 0.7; }
        .highlight-stat.negative .stat-icon { background-color: transparent; color: #c62828; opacity: 0.7; }

        .stat-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #000000;
            font-weight: 700;
            margin: 0;
            padding: 0;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            margin: 0;
            padding: 0;
            line-height: 1.2;
            color: #000000;

        /* Estilos para bot√≥n de vacaciones - Estilo de bot√≥n del header */
        .btn-vacaciones-destacado {
            background: #0b7835 !important;
            border: 2px solid rgba(0, 0, 0, 0.25) !important;
            color: white !important;
            padding: 1rem 1.5rem !important;
            font-size: 1rem !important;
            font-weight: 600 !important;
            border-radius: 12px !important;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
            transition: all 0.3s ease !important;
            text-align: center !important;
            position: relative !important;
            overflow: hidden !important;
            text-decoration: none !important;
            display: block !important;
            transform: translateY(0) !important;
            cursor: pointer !important;
        }

        .btn-vacaciones-destacado::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg);
            transition: all 0.8s;
            z-index: 0;
        }

        .btn-vacaciones-destacado::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
            z-index: 0;
        }

        .btn-vacaciones-destacado:hover {
            background: #0d8a3f !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.35), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.25) !important;
            border-color: rgba(0, 0, 0, 0.3) !important;
        }

        .btn-vacaciones-destacado:hover::before {
            left: 100%;
        }

        .btn-vacaciones-destacado:hover::after {
            opacity: 1;
        }

        .btn-vacaciones-destacado:active {
            transform: translateY(-2px) scale(1.02) !important;
        }

        .btn-vacaciones-destacado i {
            font-size: 1.5rem !important;
            display: inline-block !important;
            margin-right: 0.5rem !important;
            margin-bottom: 0 !important;
            position: relative;
            z-index: 2;
        }

        .btn-vacaciones-destacado strong {
            font-size: 1rem !important;
            display: inline !important;
            text-shadow: none !important;
            letter-spacing: 0.3px !important;
            position: relative;
            z-index: 2;
            margin-bottom: 0 !important;
        }

        .btn-vacaciones-destacado small {
            display: none !important;
        }

        @keyframes pulse-glow-vacaciones {
            0%, 100% {
                box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4), 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 10px 25px rgba(40, 167, 69, 0.5), 0 5px 12px rgba(0, 0, 0, 0.25), inset 0 2px 4px rgba(255, 255, 255, 0.35);
            }
        }

        @keyframes bounce-soft-vacaciones {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-8px) scale(1.05);
            }
        }

        /* Estilo para bot√≥n de procedimientos */
        .btn-procedimientos:hover {
            background: #0d8a3f !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.35), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.25) !important;
            border-color: rgba(0, 0, 0, 0.3) !important;
        }

        @media (max-width: 768px) {
            .btn-vacaciones-destacado {
                padding: 1rem 1.25rem !important;
                font-size: 0.9rem !important;
            }
            .btn-vacaciones-destacado i {
                font-size: 1.25rem !important;
            }
            .btn-vacaciones-destacado strong {
                font-size: 0.9rem !important;
            }
            .btn-procedimientos {
                padding: 1rem 1.25rem !important;
                font-size: 0.9rem !important;
            }
        }
            color: #212529;
            line-height: 1.2;
        }

        .highlight-stat.positive .stat-value { color: #2e7d32; }
        .highlight-stat.negative .stat-value { color: #c62828; }
        
        /* Ajuste para el filtro de mes - Compacto */
        .filter-container {
            background: transparent !important;
            padding: 0 0 8px 0 !important;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
        }
        
        .month-select {
            border: 1px solid #dee2e6 !important;
            border-radius: 8px !important;
            padding: 10px !important;
            font-size: 0.95rem;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Estilos para Modal de Tutorial de Encuestas */
        .modal-encuestas-tutorial {
            z-index: 9999;
        }

        .modal-encuestas-tutorial .modal-dialog {
            max-width: 900px;
            margin: 1.75rem auto;
            max-height: 90vh;
        }

        .modal-encuestas-tutorial .modal-dialog-scrollable {
            max-height: calc(90vh - 3.5rem);
        }

        .modal-encuestas-tutorial .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .modal-encuestas-tutorial .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 25px 30px;
            position: relative;
        }

        .modal-encuestas-tutorial .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
        }

        .modal-encuestas-tutorial .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-encuestas-tutorial .modal-title i {
            font-size: 1.8rem;
        }

        .modal-encuestas-tutorial .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        .modal-encuestas-tutorial .btn-close:hover {
            opacity: 1;
        }

        .modal-encuestas-tutorial .modal-body {
            padding: 25px;
            background: #f8f9fa;
            max-height: calc(90vh - 200px);
            overflow-y: auto;
        }

        .tutorial-step {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }

        .tutorial-step h5 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tutorial-step p {
            color: #495057;
            line-height: 1.7;
            margin-bottom: 0;
        }

        .encuesta-ejemplo {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid #e9ecef;
        }

        .encuesta-ejemplo h6 {
            color: #495057;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .pregunta-ejemplo {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .pregunta-ejemplo:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .pregunta-ejemplo label {
            font-weight: 600;
            color: #212529;
            margin-bottom: 10px;
            display: block;
            font-size: 0.95rem;
        }

        .opciones-ejemplo {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .opcion-ejemplo {
            padding: 10px 18px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: #f8f9fa;
            color: #495057;
            font-size: 0.9rem;
            cursor: default;
            transition: all 0.2s;
        }

        .opcion-ejemplo.seleccionada {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            border-radius: 10px;
            padding: 15px 20px;
            margin-top: 20px;
        }

        .info-box i {
            color: #2196f3;
            margin-right: 10px;
        }

        .info-box p {
            margin: 0;
            color: #1565c0;
            font-weight: 500;
            line-height: 1.6;
        }

        .modal-encuestas-tutorial .modal-footer {
            background: #f8f9fa;
            border: none;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .btn-tutorial {
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
            border: none;
        }

        .btn-saltar {
            background: #6c757d;
            color: white;
        }

        .btn-saltar:hover {
            background: #5a6268;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-continuar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-continuar:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .badge-transparencia {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        /* Estilos para formulario de encuesta en modal */
        .modal-encuestas-tutorial .pregunta-grupo {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .modal-encuestas-tutorial .pregunta-grupo.cumplimiento {
            border-left-color: #28a745;
        }

        .modal-encuestas-tutorial .pregunta-titulo {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .modal-encuestas-tutorial .opciones-radio {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .modal-encuestas-tutorial .opcion-radio input[type="radio"] {
            display: none;
        }

        .modal-encuestas-tutorial .opcion-radio label {
            display: block;
            padding: 10px 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: #495057;
            font-size: 0.85rem;
        }

        .modal-encuestas-tutorial .opcion-radio label:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal-encuestas-tutorial .opcion-calidad input[type="radio"]:checked + label[for*="_muy"] {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }

        .modal-encuestas-tutorial .opcion-calidad input[type="radio"]:checked + label[for*="_bueno"] {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border-color: #17a2b8;
        }

        .modal-encuestas-tutorial .opcion-calidad input[type="radio"]:checked + label[for*="_regular"] {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            border-color: #ffc107;
        }

        .modal-encuestas-tutorial .opcion-calidad input[type="radio"]:checked + label[for*="_malo"] {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-color: #dc3545;
        }

        .modal-encuestas-tutorial .opcion-cumplimiento input[type="radio"]:checked + label[for*="_si"] {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }

        .modal-encuestas-tutorial .opcion-cumplimiento input[type="radio"]:checked + label[for*="_no"] {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-color: #dc3545;
        }

        .modal-encuestas-tutorial .opcion-puntualidad input[type="radio"]:checked + label[for*="_puntual"] {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }

        .modal-encuestas-tutorial .opcion-puntualidad input[type="radio"]:checked + label[for*="_conversado"] {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            border-color: #ffc107;
        }

        .modal-encuestas-tutorial .opcion-puntualidad input[type="radio"]:checked + label[for*="_impuntual"] {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-color: #dc3545;
        }

        .modal-encuestas-tutorial .comentarios-campo {
            margin-top: 12px;
        }

        .modal-encuestas-tutorial .comentarios-campo label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
            display: block;
        }

        .modal-encuestas-tutorial .comentarios-campo textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
        }

        .modal-encuestas-tutorial .seccion-titulo {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin: 25px 0 15px 0;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-encuestas-tutorial .seccion-titulo.seccion-cumplimiento {
            color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
        }

        .modal-encuestas-tutorial .optional-badge {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 6px;
        }
        
        /* Estilos para tarjetas semanales - Verde Pastel */
        .weekly-card .weekly-header {
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            color: #000000 !important;
        }
        
        .weekly-card .weekly-header * {
            color: #000000 !important;
        }
        
        .weekly-card .weekly-header:hover {
            background-color: #a5d6a7 !important;
            background: #a5d6a7 !important;
        }
        
        .weekly-card .weekly-dates,
        .weekly-card .weekly-dates i,
        .weekly-card .weekly-summary {
            color: #000000 !important;
        }
        
        .weekly-card .calculation-label,
        .weekly-card .calculation-value {
            color: #000000 !important;
        }
        
        /* Estilos para tarjetas diarias - Azul Pastel */
        .daily-card .daily-header {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            color: #000000 !important;
            box-shadow: none !important;
            border: none !important;
            border-radius: 6px !important;
        }
        
        .daily-card .daily-header * {
            color: #000000 !important;
        }
        
        .daily-card .daily-header:hover {
            background-color: #90CAF9 !important;
            background: #90CAF9 !important;
            box-shadow: none !important;
        }
        
        .daily-card .daily-date,
        .daily-card .daily-date i,
        .daily-card .calculation-label,
        .daily-card .calculation-value {
            color: #000000 !important;
        }
        
        /* Eliminar bordes y sombras de la tarjeta diaria completa */
        .daily-card {
            box-shadow: none !important;
            border: none !important;
            border-radius: 6px !important;
        }
        
        /* Animaci√≥n pulse para iconos de despliegue */
        @keyframes pulse-down {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.3);
            }
        }
        
        .icon-expand-pulse {
            animation: pulse-down 1.5s ease-in-out infinite;
        }
        
        /* Ocultar √≠cono no animado si existe */
        .daily-header .expand-icon:not(.icon-expand-pulse) {
            display: none !important;
        }
        
        /* Ocultar √≠cono no animado en semanas */
        .weekly-header .expand-icon:not(.icon-expand-pulse) {
            display: none !important;
        }
        
        /* Ocultar √≠cono por defecto del select de mes */
        #monthFilter.month-select {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-image: none !important;
        }
        
        #monthFilter.month-select::-ms-expand {
            display: none !important;
        }
    </style>
    <!-- Sistema de Autenticaci√≥n -->
    <script src="cache-buster.js"></script>
    <script src="utils.js"></script>
    <!-- Sistema de Autenticaci√≥n Seguro -->
    <script type="module">
        import { auth } from './auth-secure.js';
        
        // Guardar auth en window para uso global
        window.firebaseAuth = auth;
        
        // VERIFICACI√ìN INMEDIATA DE AUTENTICACI√ìN - Redirigir antes de cargar contenido
        (async function() {
            // Prevenir m√∫ltiples ejecuciones
            if (window.authCheckInProgress) {
                return;
            }
            window.authCheckInProgress = true;
            
            // Ocultar body inmediatamente
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Esperar a que auth-secure.js se cargue completamente
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verificar si ya estamos en iniciar_sesion.html (evitar loop)
            if (window.location.pathname.includes('iniciar_sesion.html')) {
                window.authCheckInProgress = false;
                return;
            }
            
            // Verificar autenticaci√≥n de manera simple
            let retries = 0;
            const maxRetries = 100; // 10 segundos
            
            while (retries < maxRetries) {
                // Verificar Firebase Auth directamente
                if (auth.currentUser) {
                    if (window.safeLogger) {
                        window.safeLogger.success('‚úÖ [REGISTRO_HORAS_SECURE] Usuario autenticado');
                    } else {
                        // Usuario autenticado (sin log)
                    }
                    
                    // Esperar a secureAuthManager
                    if (window.secureAuthManager) {
                        window.authManager = window.secureAuthManager;
                    } else {
                        // Esperar un poco m√°s
                        await new Promise(resolve => setTimeout(resolve, 300));
                        if (window.secureAuthManager) {
                            window.authManager = window.secureAuthManager;
                        }
                    }
                    
                    // Mostrar body
                    if (document.body) {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                    
                    window.authCheckInProgress = false;
                    return; // Usuario autenticado, continuar
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            // Si llegamos aqu√≠, no hay autenticaci√≥n
            // No autenticado despu√©s de esperar (sin log)
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Solo redirigir si no estamos ya en loginsecure
            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                try {
                    sessionStorage.setItem('postLoginRedirect', window.location.href);
                } catch (e) { 
                    if (window.safeLogger) {
                        window.safeLogger.error('Error guardando redirecci√≥n', e);
                    } else {
                        console.error('Error guardando redirecci√≥n');
                    }
                }
                window.location.replace('iniciar_sesion.html');
            }
            
            window.authCheckInProgress = false;
        })();
        
        // Funci√≥n para esperar a que secureAuthManager est√© disponible
        function waitForSecureAuthManager() {
            return new Promise((resolve) => {
                let retries = 0;
                const maxRetries = 50; // 5 segundos m√°ximo
                const checkAuth = () => {
                    if (window.secureAuthManager) {
                        // Configurar authManager para compatibilidad
                        window.authManager = window.secureAuthManager;
                        // Sistema seguro configurado (sin log)
                        resolve(true);
                    } else if (retries < maxRetries) {
                        retries++;
                        setTimeout(checkAuth, 100);
                    } else {
                        if (window.safeLogger) {
                            window.safeLogger.error('‚ùå [REGISTRO_HORAS_SECURE] secureAuthManager no disponible despu√©s de esperar');
                        } else {
                            console.error('‚ùå [REGISTRO_HORAS_SECURE] secureAuthManager no disponible despu√©s de esperar');
                        }
                        resolve(false);
                    }
                };
                checkAuth();
            });
        }
        
        // Esperar a que secureAuthManager est√© disponible antes de continuar
        waitForSecureAuthManager().then(available => {
            if (!available) {
                console.error('‚ùå [REGISTRO_HORAS_SECURE] No se pudo cargar el sistema seguro');
            }
        });
    </script>
    <script src="check-permissions.js"></script>
    <!-- Header din√°mico -->
    <script src="load-headersecure.js"></script>
</head>
<body>

    <div class="mobile-app-container">
        <!-- Header se carga din√°micamente -->
        <div id="header-container"></div>

        <!-- Contenido Principal -->

        <!-- Secci√≥n 1: Control de Turno -->
        <div class="section-card" style="margin: 8px 1rem; background: #f5f5f5; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.08); overflow: hidden;">
            <div class="section-header" style="background: #c8e6c9; color: #000000; padding: 12px 20px;">
                <h3 style="color: #000000; margin: 0; font-weight: 700; font-size: 1.2rem;">Control de Turno</h3>
            </div>
            <div class="section-content">
                <!-- Informaci√≥n del Empleado -->
                <div class="employee-card">
                    <div class="employee-info">
                        <h2 id="employeeName">-</h2>
                        <div class="status-indicator" id="workStatus">
                            <div class="status-dot"></div>
                            <span class="status-text">App Apagada</span>
                        </div>
                    </div>
                    
                <!-- Botones de Acci√≥n -->
                <div class="action-buttons">
                    <button class="action-btn primary" id="btnStartWork">
                            <div class="btn-icon">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="btn-content">
                            <span class="btn-title">Iniciar Turno</span>
                            <span class="btn-subtitle">Prender la app</span>
                            </div>
                        </button>
                        
                    <button class="action-btn secondary" id="btnEndWork" style="display: none;">
                            <div class="btn-icon">
                                <i class="fas fa-stop"></i>
                            </div>
                            <div class="btn-content">
                            <span class="btn-title">Finalizar Turno</span>
                            <span class="btn-subtitle">Apagar la app</span>
                            </div>
                        </button>
                </div>
                    </div>
            </div>
        </div>

        <!-- Secci√≥n: Competencia Paniagua (Solo visible para apellido Paniagua) -->
        <div class="section-card" id="seccionPaniagua" style="display: none; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border: 3px solid #ffc107; box-shadow: 0 8px 24px rgba(255, 193, 7, 0.3);">
            <div class="section-header" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white;">
                <h3 style="color: white; margin: 0;">
                    <i class="fas fa-trophy me-2"></i>üèÜ Competencia Paniagua - ‚Ç°3,000/hora
                </h3>
            </div>
            <div class="section-content" style="padding: 20px;">
                <!-- Tu Salario en Tiempo Real -->
                <div id="miSalarioPaniagua" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #ffc107;">
                    <div style="text-align: center;">
                        <h4 style="color: #ff6b35; margin-bottom: 15px;">
                            <i class="fas fa-user-circle me-2"></i>Tu Salario Acumulado
                        </h4>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #28a745; margin: 15px 0;">
                            <span id="salarioActualPaniagua">‚Ç°0</span>
                        </div>
                        <div style="font-size: 1.1rem; color: #666; margin-bottom: 15px;">
                            <span id="horasActualesPaniagua">0.00</span> horas trabajadas
                        </div>
                        
                        <!-- Desglose por D√≠a -->
                        <div style="margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px;">
                            <h5 style="color: #666; font-size: 1rem; margin-bottom: 12px;">
                                <i class="fas fa-calendar-day me-2"></i>√öltimos 7 D√≠as
                            </h5>
                            <div id="desgloseSalarioPorDia" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center;">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                        
                        <div style="font-size: 0.9rem; color: #999; margin-top: 15px;">
                            <i class="fas fa-clock me-1"></i>Actualiz√°ndose en tiempo real...
                        </div>
                    </div>
                </div>
                
                <!-- Presupuesto Mensual -->
                <div id="presupuestoPaniagua" style="background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #17a2b8;">
                    <h5 style="color: #17a2b8; margin-bottom: 12px; font-size: 1rem;">
                        <i class="fas fa-wallet me-2"></i>Presupuesto del Mes
                    </h5>
                    
                    <!-- Barra de progreso animada tipo agua -->
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 3px;">Devengado del Mes</div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: #17a2b8;" id="gastoAcumuladoPaniagua">‚Ç°0</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 3px;">Presupuesto</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #28a745;" id="presupuestoTotalPaniagua">‚Ç°610,000</div>
                            </div>
                        </div>
                        <div style="background: #e9ecef; border-radius: 12px; height: 35px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            <div id="barraProgresoPaniagua" style="
                                background: linear-gradient(90deg, #17a2b8 0%, #20c997 50%, #28a745 100%);
                                height: 100%;
                                width: 0%;
                                transition: width 1s ease-out;
                                position: relative;
                                overflow: visible;
                            ">
                                <!-- Efecto de agua animado -->
                                <div style="
                                    position: absolute;
                                    top: -50%;
                                    left: -100%;
                                    width: 200%;
                                    height: 200%;
                                    background: linear-gradient(90deg, 
                                        transparent 0%, 
                                        rgba(255,255,255,0.3) 50%, 
                                        transparent 100%);
                                    animation: wave 3s infinite;
                                    transform: rotate(15deg);
                                "></div>
                                <div style="
                                    position: absolute;
                                    top: -50%;
                                    left: -100%;
                                    width: 200%;
                                    height: 200%;
                                    background: linear-gradient(90deg, 
                                        transparent 0%, 
                                        rgba(255,255,255,0.2) 50%, 
                                        transparent 100%);
                                    animation: wave 4s infinite 0.5s;
                                    transform: rotate(-10deg);
                                "></div>
                            </div>
                            <!-- Texto del porcentaje centrado en el contenedor completo -->
                            <div style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                color: white;
                                font-size: 0.9rem;
                                font-weight: bold;
                                text-shadow: 0 1px 3px rgba(0,0,0,0.5);
                                z-index: 10;
                                white-space: nowrap;
                                pointer-events: none;
                            " id="progresoTextoPaniagua">0%</div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 6px; font-size: 0.75rem; color: #999;">
                            <span id="saldoDisponiblePaniagua" style="font-weight: bold; color: #28a745;">‚Ç°610,000 restante</span>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes wave {
                        0% {
                            left: -100%;
                        }
                        100% {
                            left: 100%;
                        }
                    }
                </style>
                
                <!-- Premios Rotativos -->
                <div id="premiosPaniagua" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h5 style="color: #ff6b35; margin-bottom: 15px;">
                        <i class="fas fa-trophy me-2"></i>üèÜ Premios de la Semana
                    </h5>
                    <div id="premiosContainerPaniagua" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando premios...
                        </div>
                    </div>
                </div>
                
                <!-- Ranking de Todos los Paniagua -->
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h5 style="color: #ff6b35; margin-bottom: 15px;">
                        <i class="fas fa-medal me-2"></i>Ranking Paniagua (Este Mes)
                    </h5>
                    <div id="rankingPaniagua" style="min-height: 100px;">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando ranking...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 2: Reportes del Mes -->
        <div class="section-card" style="margin: 8px 1rem; background: #f5f5f5; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.08); overflow: hidden;">
            <div class="section-header" style="background: #c8e6c9; color: #000000; padding: 12px 20px;">
                <h3 style="color: #000000; margin: 0; font-weight: 700; font-size: 1.2rem;">Reportes del Mes</h3>
            </div>
            <div class="section-content">
                <!-- Filtro de Mes -->
                <div class="filter-container">
                    <div class="filter-label">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Filtrar por Mes</span>
                    </div>
                    <div style="position: relative; display: inline-block; width: 100%;">
                        <select id="monthFilter" class="month-select" style="width: 100%; padding-right: 40px; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: none;">
                            <option value="">Seleccionar mes</option>
                        </select>
                        <i class="fas fa-angle-down icon-expand-pulse" style="position: absolute; top: 40%; right: 12px; transform: translateY(-50%); font-size: 1.2rem; color: #000000; opacity: 0.7; pointer-events: none; z-index: 10;"></i>
                    </div>
                </div>

                <!-- Resumen de Horas -->
                <div class="hours-summary" id="monthlySummary">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Cargando resumen...</span>
                    </div>
                </div>

                <!-- Historial de Jornadas -->
                <div class="work-history" id="workHistory">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Secci√≥n 3: Enlaces de Inter√©s -->
        <div class="section-card" style="margin: 8px 1rem; background: #f5f5f5; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.08); overflow: hidden;">
            <div class="section-header" style="background: #c8e6c9; color: #000000; padding: 12px 20px;">
                <h3 style="color: #000000; margin: 0; font-weight: 700; font-size: 1.2rem;">Enlaces de Inter√©s</h3>
            </div>
            <div class="section-content">
                <div class="row g-3">
                    <div class="col-md-6">
                        <button type="button" onclick="abrirModalVacaciones(); return false;" class="btn btn-vacaciones-destacado w-100" style="padding: 1rem 1.5rem; text-align: center; background: #0b7835; border: 2px solid rgba(0, 0, 0, 0.25); color: white; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); transition: all 0.3s ease; cursor: pointer; display: block;">
                            <i class="fas fa-umbrella-beach me-2"></i>
                            <strong>Solicitar Vacaciones</strong>
                            <div id="saldoVacacionesDisplay" style="margin-top: 4px; font-size: 0.875rem; font-weight: 500; color: rgba(255,255,255,0.9);">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <a href="recursos_humanos_modulos.html" class="btn btn-procedimientos w-100" style="padding: 1rem 1.5rem; text-align: center; background: #0b7835; border: 2px solid rgba(0, 0, 0, 0.25); color: white; border-radius: 12px; font-weight: 600; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.25), inset 0 -1px 0 rgba(0, 0, 0, 0.2); transition: all 0.3s ease; text-decoration: none; display: block; cursor: pointer;">
                            <i class="fas fa-book me-2"></i>
                            <strong>Procedimientos</strong>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <!-- Modal Mensaje de √âxito -->
    <div class="modal fade" id="modalMensajeExito" tabindex="-1" aria-labelledby="modalMensajeExitoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalMensajeExitoLabel">
                        <i class="fas fa-check-circle me-2"></i>√âxito
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    </div>
                    <h5 class="fw-bold mb-3" id="mensajeExitoTitulo"></h5>
                    <p class="mb-0" id="mensajeExitoTexto"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-check me-2"></i>Entendido
                    </button>
                </div>
            </div>
        </div>
                    </div>
                    
                    
    <!-- Modal Seleccionar Bodega APV -->
    <div class="modal fade" id="modalSeleccionarBodegaAPV" tabindex="-1" aria-labelledby="modalSeleccionarBodegaAPVLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSeleccionarBodegaAPVLabel">
                        <i class="fas fa-warehouse me-2"></i>Seleccionar Bodega APV
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Selecciona la bodega APV donde iniciar√°s tu turno:</p>
                    <select class="form-select form-select-lg" id="selectBodegaAPV" required>
                        <option value="">Cargando bodegas...</option>
                        <option value="OFICINA_SIN_INVENTARIO" style="background-color: #e3f2fd; font-weight: bold;">
                            üè¢ Trabajo en Oficina Sin Inventario
                        </option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Trabajo en Oficina Sin Inventario:</strong> Para empleados sin veh√≠culo o bodega asignada. No requiere verificaci√≥n de inventario ni liquidaci√≥n.
                    </small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="continuarConBodegaAPV()">
                        <i class="fas fa-check me-2"></i>Continuar
                    </button>
                </div>
            </div>
        </div>
                    </div>
                    
    <!-- Modal Confirmar Liquidaci√≥n al Finalizar Turno -->
    <div class="modal fade" id="modalConfirmarLiquidacion" tabindex="-1" aria-labelledby="modalConfirmarLiquidacionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalConfirmarLiquidacionLabel">
                        <i class="fas fa-clipboard-check me-2"></i>Confirmar Liquidaci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-boxes fa-3x text-warning mb-3"></i>
                    <h5 class="fw-bold mb-3">¬øYa liquidaste el inventario de APV e inventario personal del d√≠a?</h5>
                </div>
                <div class="modal-footer d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" onclick="confirmarLiquidacionCompleta()">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>S√≠, ya liquid√© todo</strong>
                        <small class="d-block mt-1" style="font-size: 0.85rem; opacity: 0.9;">Cerrar turno</small>
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" onclick="irALiquidarInventario()">
                        <i class="fas fa-arrow-right me-2"></i>
                        <strong>No, ir a liquidar</strong>
                        <small class="d-block mt-1" style="font-size: 0.85rem; opacity: 0.9;">Abrir p√°gina de liquidaci√≥n</small>
                    </button>
                </div>
            </div>
        </div>
                    </div>
                    
    <!-- Modal Verificar Inventario Especiales -->
    <div class="modal fade" id="modalVerificarInventarioEspeciales" tabindex="-1" aria-labelledby="modalVerificarInventarioEspecialesLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-especial">
            <div class="modal-header modal-especial-header">
                <h5 class="modal-title" id="modalVerificarInventarioEspecialesLabel">
                    <i class="fas fa-star-of-life me-2"></i>Neteo Especial del D√≠a
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-especial-body">
                <!-- Paso 1: Pregunta inicial -->
                <div id="pasoConfirmacionEspeciales" class="paso-inventario">
                    <div class="text-center mb-3 modal-compact-text">
                        <div class="modal-especial-highlight justify-content-center mb-2">
                            <i class="fas fa-star-of-life"></i>
                            <span>Saldo Especial</span>
                        </div>
                        <h5 class="fw-bold mb-2">¬øEl neteo especial est√° cuadrado?</h5>
                        <p class="text-muted mb-0">Confirma que cada producto con neteo positivo de hoy est√© en tus bodegas especiales.</p>
                    </div>
                    
                    <!-- Lista de productos para revisi√≥n -->
                    <div class="mb-3">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-chart-line me-2"></i>Movimientos con neteo positivo:
                        </h6>
                        <div id="listaProductosRevisionEspeciales" class="border rounded p-2" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando productos...
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mb-3 modal-compact-buttons">
                        <button type="button" class="btn btn-success btn-lg" onclick="inventarioCompletoEspeciales()">
                            <i class="fas fa-check-circle me-2"></i>Saldo correcto
                        </button>
                        <button type="button" class="btn btn-warning btn-lg" onclick="mostrarProductosFaltantesEspeciales()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Faltantes en Especial
                        </button>
                    </div>
                    </div>
                    
                <!-- Paso 2: Lista de productos faltantes -->
                <div id="pasoProductosFaltantesEspeciales" class="paso-inventario" style="display: none;">
                    <div class="alert alert-info mb-3 py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Los √≠tems seleccionados se enviar√°n en un ticket a Gerencia.</small>
                    </div>
                    
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-list me-2"></i>Marca lo que falta:
                    </h6>
                    
                    <div id="listaProductosFaltantesEspeciales" class="mb-3" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando productos...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer modal-especial-footer modal-compact-buttons d-flex flex-column flex-sm-row align-items-stretch" id="footerModalInventarioEspeciales">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnVolverAtrasEspeciales" onclick="volverAConfirmacionEspeciales()" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </button>
                <button type="button" class="btn btn-warning btn-lg" id="btnConfirmarFaltantesEspeciales" onclick="confirmarProductosFaltantesEspeciales()" style="display: none;">
                    <i class="fas fa-paper-plane me-2"></i>Abrir ticket y continuar
                </button>
            </div>
        </div>
    </div>
                        </div>
                        
    <!-- Modal Verificar Inventario -->
    <div class="modal fade" id="modalVerificarInventario" tabindex="-1" aria-labelledby="modalVerificarInventarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-apv">
            <div class="modal-header modal-apv-header">
                <h5 class="modal-title" id="modalVerificarInventarioLabel">
                    <i class="fas fa-car-side me-2"></i>Veh√≠culo APV ¬∑ <span id="nombreBodegaInventario"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-apv-body">
                <!-- Paso 1: Pregunta inicial -->
                <div id="pasoConfirmacion" class="paso-inventario">
                    <div class="text-center mb-3 modal-compact-text">
                        <div class="modal-apv-highlight justify-content-center mb-2">
                            <i class="fas fa-car-side"></i>
                            <span>Verificaci√≥n APV</span>
                        </div>
                        <h5 class="fw-bold mb-2">¬øTodo el inventario est√° listo?</h5>
                        <p class="text-muted mb-0">Confirma que cada producto listado est√° dentro del veh√≠culo <span class="fw-semibold" id="nombreBodegaPaso1"></span>.</p>
                        </div>
                        
                    <!-- Lista de productos para revisi√≥n -->
                    <div class="mb-3">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-boxes me-2"></i>Productos a validar:
                        </h6>
                        <div id="listaProductosRevision" class="border rounded p-2" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando productos...
                    </div>
                </div>
            </div>
                    
                    <div class="d-grid gap-2 mb-3 modal-compact-buttons">
                        <button type="button" class="btn btn-success btn-lg" onclick="inventarioCompleto()">
                            <i class="fas fa-check-circle me-2"></i>Todo listo
                        </button>
                        <button type="button" class="btn btn-warning btn-lg" onclick="mostrarProductosFaltantes()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Faltan productos
                        </button>
        </div>
                
                </div>

                <!-- Paso 2: Lista de productos faltantes -->
                <div id="pasoProductosFaltantes" class="paso-inventario" style="display: none;">
                    <div class="alert alert-info mb-3 py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Los productos marcados se enviar√°n en un ticket a Gerencia.</small>
                    </div>
                    
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-list me-2"></i>Marca lo que falta:
                    </h6>
                    
                    <div id="listaProductosFaltantes" class="mb-3" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando productos...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer modal-apv-footer modal-compact-buttons d-flex flex-column flex-sm-row align-items-stretch" id="footerModalInventario">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnVolverAtras" onclick="volverAConfirmacion()" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </button>
                <button type="button" class="btn btn-warning btn-lg" id="btnConfirmarFaltantes" onclick="confirmarProductosFaltantes()" style="display: none;">
                    <i class="fas fa-paper-plane me-2"></i>Abrir ticket y continuar
                </button>
            </div>
        </div>
        </div>
    </div>

    <!-- Sistema de Autenticaci√≥n -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, updateDoc, doc, getDoc, Timestamp, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Capturar importaciones en variables globales del m√≥dulo para uso en funciones
        window.firestoreTimestamp = Timestamp;
        window.firestoreGetDocs = getDocs;
        window.firestoreCollection = collection;
        window.firestoreAddDoc = addDoc;
        window.firestoreQuery = query;
        window.firestoreWhere = where;
        window.firestoreOrderBy = orderBy;
        window.firestoreUpdateDoc = updateDoc;
        window.firestoreDoc = doc;
        window.firestoreServerTimestamp = serverTimestamp;

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            projectId: "cursorwebapp-f376d",
            appId: "1:719990096116:web:07c1ff697e7655b2cd9ea1",
            databaseURL: "https://cursorwebapp-f376d-default-rtdb.firebaseio.com",
            storageBucket: "cursorwebapp-f376d.firebasestorage.app",
            apiKey: "AIzaSyC-IQj0yHR8cELr-mw-v2xlnw6LlJYFUyk",
            authDomain: "cursorwebapp-f376d.firebaseapp.com",
            messagingSenderId: "719990096116",
            measurementId: "G-DJXLKFR7CD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // El sistema de autenticaci√≥n se carga desde auth-secure.js (sistema seguro)

        // Variables globales
        let currentWorkSession = null;
        let timeInterval = null;
        let bodegasAPV = [];
        let productos = [];
        let bodegaAPVSeleccionada = null;
        let inventarioBodega = [];
        let productosNeteoPositivo = [];
        let bodegasEspeciales = [];
        let inventarioEspeciales = [];
        let bodegaEspecialSeleccionada = null;
        
        // ============================================
        // FUNCIONES HELPER PARA FECHAS GMT-6
        // ============================================
        
        function fechaGMT6(fecha) {
            if (!fecha) {
                const ahora = new Date();
                const utcTime = ahora.getTime() + (ahora.getTimezoneOffset() * 60 * 1000);
                const gmt6Time = utcTime - (6 * 60 * 60 * 1000);
                return new Date(gmt6Time);
            }
            let fechaObj;
            if (fecha instanceof Date) {
                fechaObj = new Date(fecha);
            } else if (fecha?.toDate) {
                fechaObj = fecha.toDate();
            } else {
                fechaObj = new Date(fecha);
            }
            const utcTime = fechaObj.getTime() + (fechaObj.getTimezoneOffset() * 60 * 1000);
            const gmt6Time = utcTime - (6 * 60 * 60 * 1000);
            return new Date(gmt6Time);
        }
        
        function ahoraGMT6() {
            return fechaGMT6(new Date());
        }
        
        function inicioDiaGMT6(fecha) {
            let fechaBase;
            if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Si es string YYYY-MM-DD, crear directamente a medianoche GMT-6
                const [year, month, day] = fecha.split('-').map(Number);
                return new Date(Date.UTC(year, month - 1, day, 6, 0, 0, 0));
            }
            
            fechaBase = fechaGMT6(fecha);
            // fechaBase es un Date que representa GMT-6
            // Internamente, el timestamp es UTC
            // Para extraer el d√≠a correcto en GMT-6, necesitamos restar 6 horas del timestamp UTC
            // porque el timestamp UTC interno representa la hora GMT-6
            const utcTime = fechaBase.getTime() - (6 * 60 * 60 * 1000); // Restar 6 horas para obtener el d√≠a GMT-6
            const fechaGMT6ParaExtraer = new Date(utcTime);
            const a√±o = fechaGMT6ParaExtraer.getUTCFullYear();
            const mes = fechaGMT6ParaExtraer.getUTCMonth();
            const d√≠a = fechaGMT6ParaExtraer.getUTCDate();
            // Crear nueva fecha a medianoche GMT-6 (6 AM UTC del d√≠a correcto)
            return new Date(Date.UTC(a√±o, mes, d√≠a, 6, 0, 0, 0));
        }
        
        function fechaSoloDiaGMT6(fecha) {
            // Usar inicioDiaGMT6 para obtener el inicio del d√≠a en GMT-6
            // y luego extraer los componentes UTC (que representan el d√≠a correcto en GMT-6)
            const inicioDia = inicioDiaGMT6(fecha);
            const a√±o = inicioDia.getUTCFullYear();
            const mes = String(inicioDia.getUTCMonth() + 1).padStart(2, '0');
            const d√≠a = String(inicioDia.getUTCDate()).padStart(2, '0');
            return `${a√±o}-${mes}-${d√≠a}`;
        }

        // Elementos del DOM
        const btnStartWork = document.getElementById('btnStartWork');
        const btnEndWork = document.getElementById('btnEndWork');
        const employeeNameEl = document.getElementById('employeeName');
        const workStatusEl = document.getElementById('workStatus');
        const statusIndicatorEl = document.getElementById('statusIndicator');
        const statusTextEl = document.getElementById('statusText');
        const workHistoryEl = document.getElementById('workHistory');
        const monthlySummaryEl = document.getElementById('monthlySummary');

        // Funciones para los botones
        function updateButtonState(isWorking) {
            if (!btnStartWork || !btnEndWork) return;
            
            if (isWorking) {
                // Mostrar bot√≥n de finalizar, ocultar bot√≥n de iniciar
                btnStartWork.style.display = 'none';
                btnEndWork.style.display = 'flex';
                
                // Actualizar indicador de estado
                if (statusIndicatorEl) {
                    const statusDot = statusIndicatorEl.querySelector('.status-dot');
                    const statusText = statusIndicatorEl.querySelector('span');
                    if (statusDot) statusDot.className = 'status-dot online';
                    if (statusText) statusText.textContent = 'Conectado';
                }
                
                // Actualizar estado en la card principal
                if (workStatusEl) {
                    workStatusEl.className = 'status-indicator online';
                    const statusText = workStatusEl.querySelector('.status-text');
                    if (statusText) statusText.textContent = 'App Encendida';
                }
            } else {
                // Mostrar bot√≥n de iniciar, ocultar bot√≥n de finalizar
                btnStartWork.style.display = 'flex';
                btnEndWork.style.display = 'none';
                
                // Actualizar indicador de estado
                if (statusIndicatorEl) {
                    const statusDot = statusIndicatorEl.querySelector('.status-dot');
                    const statusText = statusIndicatorEl.querySelector('span');
                    if (statusDot) statusDot.className = 'status-dot offline';
                    if (statusText) statusText.textContent = 'Desconectado';
                }
                
                // Actualizar estado en la card principal
                if (workStatusEl) {
                    workStatusEl.className = 'status-indicator offline';
                    const statusText = workStatusEl.querySelector('.status-text');
                    if (statusText) statusText.textContent = 'App Apagada';
                }
            }
        }

        function showButtonError(button, message) {
            if (!button) return;
            
            const originalContent = button.innerHTML;
            const originalStyle = button.style.background;
            
            button.innerHTML = `
                <div class="btn-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="btn-content">
                    <h3>Error</h3>
                    <p>${message}</p>
                </div>
            `;
            button.style.background = 'linear-gradient(135deg, #ff4757, #ff6b7a)';
            
            // Restaurar despu√©s de 3 segundos
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.style.background = originalStyle;
            }, 3000);
        }

        function showButtonSuccess(button, message) {
            if (!button) return;
            
            const originalContent = button.innerHTML;
            const originalStyle = button.style.background;
            
            button.innerHTML = `
                <div class="btn-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="btn-content">
                    <h3>¬°√âxito!</h3>
                    <p>${message}</p>
                </div>
            `;
            button.style.background = 'linear-gradient(135deg, #00ff88, #00d4aa)';
            
            // Restaurar despu√©s de 2 segundos
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.style.background = originalStyle;
            }, 2000);
        }

        function showButtonInfo(button, message) {
            if (!button) return;
            
            const originalContent = button.innerHTML;
            const originalStyle = button.style.background;
            
            button.innerHTML = `
                <div class="btn-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="btn-content">
                    <h3>Procesando...</h3>
                    <p>${message}</p>
                </div>
            `;
            button.style.background = 'linear-gradient(135deg, #4fc3f7, #29b6f6)';
            
            // Restaurar despu√©s de 2 segundos
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.style.background = originalStyle;
            }, 2000);
        }

        // Funci√≥n de reloj eliminada - ya no se necesita


        // Funci√≥n para mostrar informaci√≥n GPS en la interfaz (SOLO PARA ADMINISTRADORES)
        function showGPSInfo(gpsData, type = 'start') {
            const user = window.authManager.getCurrentUser();
            if (!user || user.id !== 'prueba.prueba') return;

            // La informaci√≥n GPS se captura pero NO se muestra al usuario
            // Solo se almacena en Firebase para revisi√≥n administrativa
            if (window.safeLogger) {
                window.safeLogger.info(`üìç GPS ${type} capturado`);
            } else {
                // GPS capturado (sin log)
            }
            
            // No mostrar informaci√≥n GPS al usuario seg√∫n la pol√≠tica actualizada
            // La informaci√≥n estar√° disponible solo en vistas de administrador
        }

        // Funci√≥n para mostrar notificaci√≥n de GPS requerido
        function showGPSRequiredNotification(message) {
            // Crear notificaci√≥n m√°s prominente
            const notification = document.createElement('div');
            notification.className = 'gps-required-notification';
            notification.innerHTML = `
                <div class="gps-notification-content">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="gps-notification-text">
                        <h4>Autorizaci√≥n de Ubicaci√≥n Requerida</h4>
                        <p>${message}</p>
                        <p class="gps-help-text">Si anteriormente denegaste el permiso, puedes intentar nuevamente:</p>
                    </div>
                    <div class="gps-notification-actions">
                        <button onclick="requestGPSPermissionAgain()" class="btn btn-primary btn-sm">
                            <i class="fas fa-redo me-1"></i>
                            Intentar Nuevamente
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times me-1"></i>
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            // Agregar estilos si no existen
            if (!document.getElementById('gps-notification-styles')) {
                const style = document.createElement('style');
                style.id = 'gps-notification-styles';
                style.textContent = `
                    .gps-required-notification {
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                        color: white;
                        padding: 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 9999;
                        max-width: 500px;
                        width: 90%;
                    }
                    .gps-notification-content {
                        display: flex;
                        align-items: flex-start;
                        gap: 15px;
                    }
                    .gps-notification-content i {
                        font-size: 2rem;
                        margin-top: 5px;
                    }
                    .gps-notification-text {
                        flex: 1;
                    }
                    .gps-notification-text h4 {
                        margin: 0 0 10px 0;
                        font-size: 1.2rem;
                    }
                    .gps-notification-text p {
                        margin: 5px 0;
                        font-size: 0.9rem;
                    }
                    .gps-notification-text ul {
                        margin: 10px 0;
                        padding-left: 20px;
                    }
                    .gps-help-text {
                        font-style: italic;
                        color: #ffeb3b;
                        margin: 10px 0 !important;
                    }
                    .gps-notification-actions {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        margin-top: 10px;
                    }
                    .gps-notification-actions .btn {
                        font-size: 0.8rem;
                        padding: 6px 12px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remover despu√©s de 30 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 30000);
        }


        // Cargar bodegas APV
        async function cargarBodegasAPV() {
            try {
                // Cargando bodegas APV (sin log)
                const bodegasAPVQuery = query(
                    collection(db, 'bodegas'),
                    where('tipo', '==', 'apv')
                );
                const bodegasAPVSnapshot = await getDocs(bodegasAPVQuery);
                
                bodegasAPV = bodegasAPVSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Ordenar alfab√©ticamente por nombre
                bodegasAPV.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
                
                if (window.safeLogger) {
                    window.safeLogger.success(`‚úÖ Bodegas APV cargadas: ${bodegasAPV.length}`);
                } else {
                    // Bodegas APV cargadas (sin log)
                }
                
                // Llenar select de bodegas
                const selectBodega = document.getElementById('selectBodegaAPV');
                if (selectBodega) {
                    selectBodega.innerHTML = '<option value="">Selecciona una bodega...</option>';
                    bodegasAPV.forEach(bodega => {
                        const option = document.createElement('option');
                        option.value = bodega.id;
                        option.textContent = bodega.nombre;
                        selectBodega.appendChild(option);
                    });
                }
                
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå Error cargando bodegas APV', error);
                } else {
                    console.error('‚ùå Error cargando bodegas APV');
                }
            }
        }

        // Cargar productos
        async function cargarProductos() {
            try {
                // Cargando productos (sin log)
                const productosQuery = query(collection(db, 'productos'), orderBy('nombre'));
                const productosSnapshot = await getDocs(productosQuery);
                
                productos = productosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                if (window.safeLogger) {
                    window.safeLogger.success(`‚úÖ Productos cargados: ${productos.length}`);
                } else {
                    // Productos cargados (sin log)
                }
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå Error cargando productos', error);
                } else {
                    console.error('‚ùå Error cargando productos');
                }
            }
        }

        // Cargar inventario de bodega APV
        async function cargarInventarioBodega(bodegaId) {
            try {
                if (window.safeLogger) {
                    window.safeLogger.info('üì¶ Cargando inventario de bodega');
                } else {
                    // Cargando inventario de bodega (sin log)
                }
                const stockQuery = query(
                    collection(db, 'stock_bodegas'),
                    where('bodegaId', '==', bodegaId)
                );
                const stockSnapshot = await getDocs(stockQuery);
                
                inventarioBodega = [];
                stockSnapshot.forEach(doc => {
                    const stock = doc.data();
                    const producto = productos.find(p => p.id === stock.productoId);
                    if (producto && (stock.stockActual || 0) > 0) {
                        inventarioBodega.push({
                            productoId: stock.productoId,
                            productoNombre: producto.nombre,
                            cantidad: stock.stockActual || 0
                        });
                    }
                });
                
                // Ordenar por nombre de producto
                inventarioBodega.sort((a, b) => a.productoNombre.localeCompare(b.productoNombre, 'es', { sensitivity: 'base' }));
                
                if (window.safeLogger) {
                    window.safeLogger.success(`‚úÖ Inventario cargado: ${inventarioBodega.length} productos`);
                } else {
                    // Inventario cargado (sin log)
                }
                return inventarioBodega;
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå Error cargando inventario', error);
                } else {
                    console.error('‚ùå Error cargando inventario');
                }
                return [];
            }
        }
        
        // Cargar productos con neteo positivo del d√≠a contable actual
        async function cargarProductosNeteoPositivo() {
            try {
                if (window.safeLogger) {
                    window.safeLogger.info('üì¶ Cargando productos con neteo positivo del d√≠a contable...');
                } else {
                    if (window.safeLogger) {
                        window.safeLogger.info('üì¶ Cargando productos con neteo positivo del d√≠a contable...');
                    } else {
                        // Cargando productos con neteo positivo (sin log)
                    }
                }
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) {
                    console.error('‚ùå Usuario no autenticado');
                    productosNeteoPositivo = [];
                    return;
                }
                
                // Obtener bodegas especiales del empleado
                const bodegasEspecialesQuery = query(
                    collection(db, 'bodegas'),
                    where('empleadoId', '==', user.id),
                    where('tipo', '==', 'especial')
                );
                const bodegasEspecialesSnapshot = await getDocs(bodegasEspecialesQuery);
                const bodegasEspecialesIds = bodegasEspecialesSnapshot.docs.map(doc => doc.id);
                
                if (bodegasEspecialesIds.length === 0) {
                    productosNeteoPositivo = [];
                    return;
                }
                
                // Obtener d√≠a contable actual
                const hoy = ahoraGMT6();
                const diaContableActual = fechaSoloDiaGMT6(hoy);
                
                // Calcular rango de fechas para el d√≠a contable (desde inicio del d√≠a hasta fin del d√≠a en GMT-6)
                // Usar inicioDiaGMT6 para obtener el inicio correcto del d√≠a en GMT-6
                const inicioDia = inicioDiaGMT6(diaContableActual);
                // Fin del d√≠a: inicio del d√≠a siguiente menos 1ms
                const diaSiguiente = new Date(inicioDia.getTime() + (24 * 60 * 60 * 1000));
                const finDia = new Date(diaSiguiente.getTime() - 1);
                
                const inicioTimestamp = Timestamp.fromDate(inicioDia);
                const finTimestamp = Timestamp.fromDate(finDia);
                
                // Cargar solo movimientos del d√≠a contable actual (optimizado con filtro de fecha)
                // Nota: Requiere √≠ndice compuesto en Firestore para fecha + orderBy
                let movimientosSnapshot;
                try {
                    const movimientosQuery = query(
                        collection(db, 'movimientos_inventario'),
                        where('fecha', '>=', inicioTimestamp),
                        where('fecha', '<', finTimestamp),
                        orderBy('fecha', 'desc')
                    );
                    movimientosSnapshot = await getDocs(movimientosQuery);
                } catch (error) {
                    // Si falla por falta de √≠ndice, cargar solo los √∫ltimos 2 d√≠as y filtrar en cliente
                    if (window.safeLogger) {
                        window.safeLogger.warn('‚ö†Ô∏è No se pudo filtrar por fecha en query, cargando √∫ltimos 2 d√≠as');
                    } else {
                        // No se pudo filtrar por fecha, cargando √∫ltimos 2 d√≠as (sin log)
                    }
                    const dosDiasAtras = new Date(inicioDia.getTime() - (2 * 24 * 60 * 60 * 1000));
                    const dosDiasAtrasTimestamp = Timestamp.fromDate(dosDiasAtras);
                    try {
                        const movimientosQuery = query(
                            collection(db, 'movimientos_inventario'),
                            where('fecha', '>=', dosDiasAtrasTimestamp),
                            orderBy('fecha', 'desc'),
                            limit(500) // Limitar a 500 movimientos m√°ximo
                        );
                        movimientosSnapshot = await getDocs(movimientosQuery);
                    } catch (error2) {
                        // Si a√∫n falla, cargar sin orderBy (m√°s r√°pido)
                        if (window.safeLogger) {
                            window.safeLogger.warn('‚ö†Ô∏è No se pudo usar orderBy, cargando sin orden');
                        } else {
                            // No se pudo usar orderBy, cargando sin orden (sin log)
                        }
                        const movimientosQuery = query(
                            collection(db, 'movimientos_inventario'),
                            where('fecha', '>=', dosDiasAtrasTimestamp),
                            limit(500)
                        );
                        movimientosSnapshot = await getDocs(movimientosQuery);
                    }
                }
                
                // Filtrar y calcular neteo por producto y bodega
                const neteoPorProductoBodega = {};
                
                movimientosSnapshot.docs.forEach(doc => {
                    const mov = doc.data();
                    // Solo verificar fecha si no se filtr√≥ en la query (fallback)
                    const fechaMov = mov.fecha?.toDate ? mov.fecha.toDate() : (mov.fecha ? new Date(mov.fecha) : new Date());
                    const fechaMovGMT6 = fechaGMT6(fechaMov);
                    const diaContableMov = fechaSoloDiaGMT6(fechaMovGMT6);
                    
                    // Filtrar por d√≠a contable (necesario si se cargaron m√°s d√≠as como fallback)
                    if (diaContableMov !== diaContableActual) return;
                    
                    const esEntrada = bodegasEspecialesIds.includes(mov.destino) && 
                                     (mov.tipo === 'transferencia' || mov.tipo === 'compra');
                    const esSalida = bodegasEspecialesIds.includes(mov.origen) && 
                                    (mov.tipo === 'gasto' || mov.tipo === 'transferencia' || 
                                     (mov.tipo === 'reversion' && mov.tipoOriginal === 'gasto'));
                    
                    if (!esEntrada && !esSalida) return;
                    
                    const productoId = mov.productoId;
                    const bodegaId = esEntrada ? mov.destino : mov.origen;
                    
                    if (!productoId || !bodegaId) return;
                    
                    const clave = `${productoId}_${bodegaId}`;
                    if (!neteoPorProductoBodega[clave]) {
                        neteoPorProductoBodega[clave] = {
                            productoId,
                            bodegaId,
                            entradas: 0,
                            salidas: 0,
                            saldo: 0
                        };
                    }
                    
                    if (esEntrada) {
                        neteoPorProductoBodega[clave].entradas += (mov.cantidad || 0);
                    } else if (esSalida) {
                        if (mov.tipo === 'reversion' && mov.tipoOriginal === 'gasto') {
                            neteoPorProductoBodega[clave].salidas -= (mov.cantidad || 0);
                        } else {
                            neteoPorProductoBodega[clave].salidas += (mov.cantidad || 0);
                        }
                    }
                    
                    neteoPorProductoBodega[clave].saldo = 
                        neteoPorProductoBodega[clave].entradas - neteoPorProductoBodega[clave].salidas;
                });
                
                // Filtrar solo productos con saldo positivo
                productosNeteoPositivo = Object.values(neteoPorProductoBodega)
                    .filter(item => item.saldo > 0)
                    .map(item => {
                        const producto = productos.find(p => p.id === item.productoId);
                        const bodega = bodegasEspecialesSnapshot.docs.find(doc => doc.id === item.bodegaId);
                        return {
                            productoId: item.productoId,
                            productoNombre: producto ? producto.nombre : 'Producto no encontrado',
                            bodegaId: item.bodegaId,
                            bodegaNombre: bodega ? bodega.data().nombre : 'Bodega no encontrada',
                            saldo: item.saldo,
                            entradas: item.entradas,
                            salidas: item.salidas
                        };
                    })
                    .sort((a, b) => a.productoNombre.localeCompare(b.productoNombre, 'es', { sensitivity: 'base' }));
                
                if (window.safeLogger) {
                    window.safeLogger.success(`‚úÖ Productos con neteo positivo cargados: ${productosNeteoPositivo.length}`);
                } else {
                    // Productos con neteo positivo cargados (sin log)
                }
            } catch (error) {
                console.error('‚ùå Error cargando productos con neteo positivo:', error);
                productosNeteoPositivo = [];
            }
        }
        
        // Cargar bodegas especiales del empleado
        async function cargarBodegasEspeciales() {
            try {
                if (window.safeLogger) {
                    window.safeLogger.info('üì¶ Cargando bodegas especiales...');
                } else {
                    // Cargando bodegas especiales (sin log)
                }
                
                // Obtener usuario de secureAuthManager primero, luego de authManager
                let user = null;
                if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                    user = window.secureAuthManager.getCurrentUser();
                } else if (window.authManager && window.authManager.isAuthenticated()) {
                    user = window.authManager.getCurrentUser();
                }
                
                // Si no hay usuario, esperar un poco y reintentar
                if (!user || (!user.id && !user.username)) {
                    if (window.safeLogger) {
                        window.safeLogger.warn('‚ö†Ô∏è Usuario no disponible, esperando...');
                    } else {
                        // Usuario no disponible, esperando (sin log)
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Reintentar
                    if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                        user = window.secureAuthManager.getCurrentUser();
                    } else if (window.authManager && window.authManager.isAuthenticated()) {
                        user = window.authManager.getCurrentUser();
                    }
                }
                
                if (!user || (!user.id && !user.username)) {
                    if (window.safeLogger) {
                        window.safeLogger.error('‚ùå Usuario no autenticado despu√©s de esperar');
                    } else {
                        console.error('‚ùå Usuario no autenticado despu√©s de esperar');
                    }
                    bodegasEspeciales = [];
                    return;
                }
                
                const userId = user.id || user.username;
                
                const bodegasQuery = query(
                    collection(db, 'bodegas'),
                    where('empleadoId', '==', userId),
                    where('tipo', '==', 'especial')
                );
                const bodegasSnapshot = await getDocs(bodegasQuery);
                
                bodegasEspeciales = bodegasSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Ordenar alfab√©ticamente por nombre
                bodegasEspeciales.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
                
                // Bodegas especiales cargadas (sin log)
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå Error cargando bodegas especiales', error);
                } else {
                    console.error('‚ùå Error cargando bodegas especiales');
                }
                bodegasEspeciales = [];
            }
        }
        
        // Cargar inventario de bodegas especiales (optimizado - queries en paralelo)
        async function cargarInventarioEspeciales() {
            try {
                // Cargando inventario de bodegas especiales (sin log)
                inventarioEspeciales = [];
                
                if (bodegasEspeciales.length === 0) {
                    return [];
                }
                
                // Crear mapa de bodegas para acceso r√°pido
                const bodegasMap = {};
                bodegasEspeciales.forEach(b => {
                    bodegasMap[b.id] = b.nombre;
                });
                
                // Crear mapa de productos para acceso r√°pido
                const productosMap = {};
                productos.forEach(p => {
                    productosMap[p.id] = p.nombre;
                });
                
                // Cargar stock de todas las bodegas en paralelo (m√°s eficiente)
                const stockPromises = bodegasEspeciales.map(async (bodega) => {
                    const stockQuery = query(
                        collection(db, 'stock_bodegas'),
                        where('bodegaId', '==', bodega.id)
                    );
                    const stockSnapshot = await getDocs(stockQuery);
                    return stockSnapshot.docs.map(doc => ({
                        ...doc.data(),
                        bodegaId: bodega.id,
                        bodegaNombre: bodega.nombre
                    }));
                });
                
                const stocksArrays = await Promise.all(stockPromises);
                
                // Combinar todos los stocks
                stocksArrays.flat().forEach(stock => {
                    if ((stock.stockActual || 0) > 0) {
                        const productoNombre = productosMap[stock.productoId];
                        if (productoNombre) {
                            inventarioEspeciales.push({
                                productoId: stock.productoId,
                                productoNombre: productoNombre,
                                bodegaId: stock.bodegaId,
                                bodegaNombre: stock.bodegaNombre,
                                cantidad: stock.stockActual || 0
                            });
                        }
                    }
                });
                
                // Ordenar por nombre de bodega y luego por nombre de producto
                inventarioEspeciales.sort((a, b) => {
                    const bodegaCompare = a.bodegaNombre.localeCompare(b.bodegaNombre, 'es', { sensitivity: 'base' });
                    if (bodegaCompare !== 0) return bodegaCompare;
                    return a.productoNombre.localeCompare(b.productoNombre, 'es', { sensitivity: 'base' });
                });
                
                if (window.safeLogger) {
                    window.safeLogger.success(`‚úÖ Inventario de especiales cargado: ${inventarioEspeciales.length} productos`);
                } else {
                    // Inventario de especiales cargado (sin log)
                }
                return inventarioEspeciales;
            } catch (error) {
                console.error('‚ùå Error cargando inventario de especiales:', error);
                return [];
            }
        }

        // Continuar con bodega APV seleccionada
        window.continuarConBodegaAPV = async function() {
            const selectBodega = document.getElementById('selectBodegaAPV');
            const bodegaId = selectBodega.value;
            
            if (!bodegaId) {
                mostrarMensajeExito('Por favor selecciona una bodega APV', '');
                return;
            }
            
            // Obtener referencia al modal antes de cualquier operaci√≥n
            const modalElement = document.getElementById('modalSeleccionarBodegaAPV');
            const modalSeleccionar = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            
            // Si es "Trabajo en Oficina Sin Inventario", iniciar turno directamente
            if (bodegaId === 'OFICINA_SIN_INVENTARIO') {
                // Configurar bodega seleccionada
                bodegaAPVSeleccionada = {
                    id: 'OFICINA_SIN_INVENTARIO',
                    nombre: 'Trabajo en Oficina Sin Inventario',
                    sinInventario: true
                };
                
                // Cerrar modal inmediatamente
                modalSeleccionar.hide();
                
                // Esperar un momento para que el modal se cierre visualmente
                // y luego iniciar el turno
                setTimeout(async () => {
                    try {
                        await iniciarTurnoConBodegaAPV();
                        mostrarMensajeExito('Turno iniciado correctamente', 'Trabajo en oficina sin inventario.');
                    } catch (error) {
                        if (window.safeLogger) {
                            window.safeLogger.error('Error iniciando turno', error);
                        } else {
                            console.error('Error iniciando turno');
                        }
                        mostrarMensajeExito('Error al iniciar turno', error.message || '');
                    }
                }, 300); // 300ms es suficiente para que el modal se cierre
                
                return;
            }
            
            bodegaAPVSeleccionada = bodegasAPV.find(b => b.id === bodegaId);
            if (!bodegaAPVSeleccionada) {
                mostrarMensajeExito('Error: Bodega no encontrada', '');
                return;
            }
            
            // Cerrar modal de selecci√≥n
            modalSeleccionar.hide();
            
            // Mostrar modal de verificaci√≥n inmediatamente con mensaje de carga
            mostrarModalVerificacionInventario();
            
            // Cargar inventario en segundo plano y actualizar
            cargarInventarioBodega(bodegaId).then(() => {
                // Actualizar lista de productos cuando termine de cargar
                const listaProductosRevision = document.getElementById('listaProductosRevision');
                if (listaProductosRevision) {
                    if (inventarioBodega.length === 0) {
                        listaProductosRevision.innerHTML = `
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-info-circle me-2"></i>No hay productos en esta bodega
                            </div>
                        `;
                    } else {
                        listaProductosRevision.innerHTML = inventarioBodega.map(item => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="flex-grow-1">
                                    <strong>${item.productoNombre}</strong>
                                </div>
                                <div>
                                    <span class="badge bg-primary" style="font-size: 0.9rem;">${item.cantidad} unidades</span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }).catch(error => {
                console.error('Error cargando inventario:', error);
                const listaProductosRevision = document.getElementById('listaProductosRevision');
                if (listaProductosRevision) {
                    listaProductosRevision.innerHTML = `
                        <div class="alert alert-danger text-center mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar inventario
                        </div>
                    `;
                }
            });
        }

        // Mostrar modal de verificaci√≥n de inventario
        function mostrarModalVerificacionInventario() {
            const nombreBodega = document.getElementById('nombreBodegaInventario');
            const nombreBodegaPaso1 = document.getElementById('nombreBodegaPaso1');
            const listaProductosRevision = document.getElementById('listaProductosRevision');
            
            // Mostrar nombre de bodega
            if (nombreBodega) {
                nombreBodega.textContent = bodegaAPVSeleccionada ? bodegaAPVSeleccionada.nombre : '';
            }
            if (nombreBodegaPaso1) {
                nombreBodegaPaso1.textContent = bodegaAPVSeleccionada ? bodegaAPVSeleccionada.nombre : '';
            }
            
            // Mostrar mensaje de carga inicial
            if (listaProductosRevision) {
                listaProductosRevision.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-spinner fa-spin me-2"></i>Cargando inventario...
                    </div>
                `;
            }
            
            // Resetear a paso 1
            document.getElementById('pasoConfirmacion').style.display = 'block';
            document.getElementById('pasoProductosFaltantes').style.display = 'none';
            document.getElementById('btnVolverAtras').style.display = 'none';
            document.getElementById('btnConfirmarFaltantes').style.display = 'none';
            
            // Mostrar modal
            const modalVerificacion = new bootstrap.Modal(document.getElementById('modalVerificarInventario'));
            modalVerificacion.show();
        }

        // Inventario completo APV - confirmar y continuar con Especiales
        window.inventarioCompleto = async function() {
            // Cerrar modal de APV
            const modalVerificacion = bootstrap.Modal.getInstance(document.getElementById('modalVerificarInventario'));
            modalVerificacion.hide();
            
            // Continuar directamente con Especiales
            await continuarConEspeciales();
        }
        
        // Continuar con verificaci√≥n de Especiales
        async function continuarConEspeciales() {
            // Cargar bodegas especiales del empleado
            await cargarBodegasEspeciales();
            
            if (bodegasEspeciales.length === 0) {
                // Si no hay bodegas especiales, iniciar turno directamente
                await iniciarTurnoConBodegaAPV();
                mostrarMensajeExito('Turno iniciado correctamente', 'Gracias por confirmar los inventarios.');
            } else {
                // Mostrar modal de verificaci√≥n de Especiales
                mostrarModalVerificacionEspeciales();
            }
        }
        
        // Mostrar modal de verificaci√≥n de Especiales
        async function mostrarModalVerificacionEspeciales() {
            const listaProductosRevision = document.getElementById('listaProductosRevisionEspeciales');
            
            // Mostrar mensaje de carga inmediatamente
            if (listaProductosRevision) {
                listaProductosRevision.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-spinner fa-spin me-2"></i>Cargando productos con neteo positivo...
                    </div>
                `;
            }
            
            // Mostrar modal inmediatamente
            const modalEspeciales = new bootstrap.Modal(document.getElementById('modalVerificarInventarioEspeciales'));
            modalEspeciales.show();
            
            // Cargar productos con neteo del d√≠a contable actual en segundo plano
            cargarProductosNeteoPositivo().then(() => {
                // Actualizar lista cuando termine de cargar
                if (listaProductosRevision) {
                    if (productosNeteoPositivo.length === 0) {
                        listaProductosRevision.innerHTML = `
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-info-circle me-2"></i>No hay productos con neteo positivo para el d√≠a contable actual en tus bodegas especiales
                            </div>
                        `;
                    } else {
                        listaProductosRevision.innerHTML = productosNeteoPositivo.map(item => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="flex-grow-1">
                                    <strong>${item.productoNombre}</strong>
                                    <small class="d-block text-muted">${item.bodegaNombre}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success" style="font-size: 0.9rem;">Saldo: +${item.saldo}</span>
                                    <small class="d-block text-muted" style="font-size: 0.75rem;">E: ${item.entradas} | S: ${item.salidas}</small>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }).catch(error => {
                if (window.safeLogger) {
                    window.safeLogger.error('Error cargando productos con neteo positivo', error);
                } else {
                    console.error('Error cargando productos con neteo positivo');
                }
                if (listaProductosRevision) {
                    listaProductosRevision.innerHTML = `
                        <div class="alert alert-danger text-center mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar productos
                        </div>
                    `;
                }
            });
            
            // Resetear a paso 1
            document.getElementById('pasoConfirmacionEspeciales').style.display = 'block';
            document.getElementById('pasoProductosFaltantesEspeciales').style.display = 'none';
            document.getElementById('btnVolverAtrasEspeciales').style.display = 'none';
            document.getElementById('btnConfirmarFaltantesEspeciales').style.display = 'none';
        }
        
        // Mostrar productos faltantes de Especiales
        window.mostrarProductosFaltantesEspeciales = function() {
            const pasoConfirmacion = document.getElementById('pasoConfirmacionEspeciales');
            const pasoProductosFaltantes = document.getElementById('pasoProductosFaltantesEspeciales');
            const listaProductosFaltantes = document.getElementById('listaProductosFaltantesEspeciales');
            const btnVolverAtras = document.getElementById('btnVolverAtrasEspeciales');
            const btnConfirmarFaltantes = document.getElementById('btnConfirmarFaltantesEspeciales');
            
            // Ocultar paso 1, mostrar paso 2
            pasoConfirmacion.style.display = 'none';
            pasoProductosFaltantes.style.display = 'block';
            btnVolverAtras.style.display = 'inline-block';
            btnConfirmarFaltantes.style.display = 'inline-block';
            
            // Llenar lista de productos faltantes usando productos con neteo positivo
            if (productosNeteoPositivo.length === 0) {
                listaProductosFaltantes.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>No hay productos con neteo positivo para reportar faltantes
                    </div>
                `;
            } else {
                listaProductosFaltantes.innerHTML = productosNeteoPositivo.map(item => `
                    <div class="card mb-3 producto-faltante-item" data-producto-id="${item.productoId}" data-bodega-id="${item.bodegaId}">
                        <div class="card-body p-3">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" value="${item.productoId}" id="checkProductoEspecial_${item.productoId}_${item.bodegaId}" 
                                       onchange="toggleCantidadFaltanteEspecial('${item.productoId}', '${item.bodegaId}', ${item.saldo})" 
                                       style="width: 20px; height: 20px;">
                                <label class="form-check-label ms-2" for="checkProductoEspecial_${item.productoId}_${item.bodegaId}" style="cursor: pointer; font-size: 1rem;">
                                    <strong>${item.productoNombre}</strong>
                                    <span class="text-muted d-block small">${item.bodegaNombre} - Saldo esperado: +${item.saldo} unidades (E: ${item.entradas} | S: ${item.salidas})</span>
                                </label>
                            </div>
                            <div class="cantidad-faltante-container" id="cantidadFaltanteEspecial_${item.productoId}_${item.bodegaId}" style="display: none;">
                                <label class="form-label fw-bold mb-2">
                                    <i class="fas fa-exclamation-circle text-warning me-1"></i>Cantidad faltante:
                                </label>
                                <div class="input-group input-group-lg">
                                    <button class="btn btn-outline-danger" type="button" onclick="decrementarCantidadFaltanteEspecial('${item.productoId}', '${item.bodegaId}', ${item.saldo})" style="min-width: 50px; font-size: 1.2rem; font-weight: bold;">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="form-control text-center fw-bold" id="inputCantidadFaltanteEspecial_${item.productoId}_${item.bodegaId}" 
                                           min="1" max="${item.saldo}" value="1" 
                                           onchange="validarCantidadFaltanteEspecial('${item.productoId}', '${item.bodegaId}', ${item.saldo})"
                                           style="font-size: 1.1rem;">
                                    <button class="btn btn-outline-success" type="button" onclick="incrementarCantidadFaltanteEspecial('${item.productoId}', '${item.bodegaId}', ${item.saldo})" style="min-width: 50px; font-size: 1.2rem; font-weight: bold;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <span class="input-group-text fw-bold">de ${item.saldo}</span>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Se abrir√° un ticket de investigaci√≥n a Gerencia
                                </small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Volver a confirmaci√≥n inicial de Especiales
        window.volverAConfirmacionEspeciales = function() {
            const pasoConfirmacion = document.getElementById('pasoConfirmacionEspeciales');
            const pasoProductosFaltantes = document.getElementById('pasoProductosFaltantesEspeciales');
            const btnVolverAtras = document.getElementById('btnVolverAtrasEspeciales');
            const btnConfirmarFaltantes = document.getElementById('btnConfirmarFaltantesEspeciales');
            
            // Mostrar paso 1, ocultar paso 2
            pasoConfirmacion.style.display = 'block';
            pasoProductosFaltantes.style.display = 'none';
            btnVolverAtras.style.display = 'none';
            btnConfirmarFaltantes.style.display = 'none';
            
            // Limpiar checkboxes
            const checkboxes = document.querySelectorAll('#listaProductosFaltantesEspeciales input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const idParts = checkbox.id.split('_');
                const productoId = idParts[1];
                const bodegaId = idParts[2];
                const cantidadContainer = document.getElementById(`cantidadFaltanteEspecial_${productoId}_${bodegaId}`);
                if (cantidadContainer) {
                    cantidadContainer.style.display = 'none';
                }
            });
        }
        
        // Toggle para mostrar/ocultar campo de cantidad faltante Especiales
        window.toggleCantidadFaltanteEspecial = function(productoId, bodegaId, cantidadMaxima) {
            const checkbox = document.getElementById(`checkProductoEspecial_${productoId}_${bodegaId}`);
            const cantidadContainer = document.getElementById(`cantidadFaltanteEspecial_${productoId}_${bodegaId}`);
            const cantidadInput = document.getElementById(`inputCantidadFaltanteEspecial_${productoId}_${bodegaId}`);
            
            if (checkbox.checked) {
                cantidadContainer.style.display = 'block';
                cantidadInput.value = 1;
                cantidadInput.max = cantidadMaxima;
                cantidadInput.dataset.max = cantidadMaxima;
            } else {
                cantidadContainer.style.display = 'none';
                cantidadInput.value = '';
            }
        }
        
        // Incrementar cantidad faltante Especiales
        window.incrementarCantidadFaltanteEspecial = function(productoId, bodegaId, cantidadMaxima) {
            const input = document.getElementById(`inputCantidadFaltanteEspecial_${productoId}_${bodegaId}`);
            if (input) {
                let valor = parseInt(input.value) || 0;
                if (valor < cantidadMaxima) {
                    valor++;
                    input.value = valor;
                    validarCantidadFaltanteEspecial(productoId, bodegaId, cantidadMaxima);
                }
            }
        }
        
        // Decrementar cantidad faltante Especiales
        window.decrementarCantidadFaltanteEspecial = function(productoId, bodegaId, cantidadMaxima) {
            const input = document.getElementById(`inputCantidadFaltanteEspecial_${productoId}_${bodegaId}`);
            if (input) {
                let valor = parseInt(input.value) || 1;
                if (valor > 1) {
                    valor--;
                    input.value = valor;
                    validarCantidadFaltanteEspecial(productoId, bodegaId, cantidadMaxima);
                }
            }
        }
        
        // Validar cantidad faltante Especiales
        window.validarCantidadFaltanteEspecial = function(productoId, bodegaId, cantidadMaxima) {
            const input = document.getElementById(`inputCantidadFaltanteEspecial_${productoId}_${bodegaId}`);
            if (input) {
                let valor = parseInt(input.value) || 0;
                if (valor < 1) {
                    input.value = 1;
                } else if (valor > cantidadMaxima) {
                    input.value = cantidadMaxima;
                }
            }
        }
        
        // Confirmar productos faltantes de Especiales
        window.confirmarProductosFaltantesEspeciales = async function() {
            const checkboxes = document.querySelectorAll('#listaProductosFaltantesEspeciales input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Por favor selecciona al menos un producto faltante');
                return;
            }
            
            const productosFaltantes = [];
            checkboxes.forEach(checkbox => {
                const idParts = checkbox.id.split('_');
                const productoId = idParts[1];
                const bodegaId = idParts[2];
                const cantidadInput = document.getElementById(`inputCantidadFaltanteEspecial_${productoId}_${bodegaId}`);
                const cantidadFaltante = parseInt(cantidadInput.value) || 1;
                
                const item = productosNeteoPositivo.find(i => i.productoId === productoId && i.bodegaId === bodegaId);
                if (item) {
                    productosFaltantes.push({
                        productoId: productoId,
                        productoNombre: item.productoNombre,
                        bodegaId: bodegaId,
                        bodegaNombre: item.bodegaNombre,
                        cantidadEsperada: item.saldo,
                        cantidadFaltante: cantidadFaltante,
                        entradas: item.entradas,
                        salidas: item.salidas
                    });
                }
            });
            
            if (productosFaltantes.length === 0) {
                return;
            }
            
            const confirmacion = confirm(`¬øConfirmar que faltan ${productosFaltantes.length} producto(s) en las bodegas especiales?`);
            if (!confirmacion) {
                return;
            }
            
            // Crear ticket para Especiales
            await crearTicketProductosFaltantesEspeciales(productosFaltantes);
            
            // Cerrar modal de Especiales
            const modalEspeciales = bootstrap.Modal.getInstance(document.getElementById('modalVerificarInventarioEspeciales'));
            modalEspeciales.hide();

        // Iniciar turno
            await iniciarTurnoConBodegaAPV();
            
            // Mensaje de agradecimiento
            mostrarMensajeExito('Turno iniciado correctamente', 'Gracias por reportar los productos faltantes en Especiales.');
        }
        
        // Funci√≥n helper para obtener nombre completo de empleado
        async function obtenerNombreEmpleado(username) {
            try {
                const empleadosQuery = query(
                    collection(db, 'empleados'),
                    where('username', '==', username)
                );
                const empleadosSnapshot = await getDocs(empleadosQuery);
                if (!empleadosSnapshot.empty) {
                    const empleado = empleadosSnapshot.docs[0].data();
                    return `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim();
                }
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.warn('‚ö†Ô∏è No se pudo obtener nombre del empleado');
                } else {
                    // No se pudo obtener nombre del empleado (sin log)
                }
            }
            return username; // Fallback al username
        }

        // Crear ticket para productos faltantes de Especiales
        async function crearTicketProductosFaltantesEspeciales(productosFaltantes) {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user) return;
                
                const listaProductos = productosFaltantes.map((p, index) => 
                    `${index + 1}. ${p.productoNombre} (${p.bodegaNombre})\n   - Saldo Esperado (Neteo): +${p.cantidadEsperada} unidades (E: ${p.entradas} | S: ${p.salidas})\n   - Cantidad Faltante: ${p.cantidadFaltante} unidades`
                ).join('\n\n');
                
                const descripcion = `PRODUCTOS FALTANTES EN BODEGAS ESPECIALES\n\n` +
                    `Reportado por: ${user.nombre || user.id}\n` +
                    `Fecha: ${new Date().toLocaleString('es-ES')}\n\n` +
                    `PRODUCTOS FALTANTES (${productosFaltantes.length} producto(s)):\n\n` +
                    `${listaProductos}\n\n` +
                    `Se requiere investigaci√≥n interna para determinar la causa de la falta de inventario.`;
                
                // Obtener nombres completos
                const creadoPorNombre = user.nombre || user.id;
                const asignadoANombre = await obtenerNombreEmpleado('fabian.soto');
                
                // Calcular fecha de vencimiento (24 horas despu√©s de la creaci√≥n, a las 23:59:59.999)
                const fechaVencimiento = new Date();
                fechaVencimiento.setTime(fechaVencimiento.getTime() + (24 * 60 * 60 * 1000)); // Sumar 24 horas
                fechaVencimiento.setHours(23, 59, 59, 999); // Establecer a 23:59:59.999 del d√≠a siguiente
                
                const ticketData = {
                    titulo: `Investigaci√≥n de Inventario Especiales: ${productosFaltantes.length} producto(s) faltante(s)`,
                    descripcion: descripcion,
                    creadoPor: user.id,
                    creadoPorNombre: creadoPorNombre,
                    asignadoA: 'fabian.soto',
                    asignadoANombre: asignadoANombre,
                    prioridad: 'urgente',
                    estado: 'pendiente',
                    fechaCreacion: serverTimestamp(),
                    fechaVencimiento: Timestamp.fromDate(fechaVencimiento),
                    comentarios: [],
                    tipo: 'inventario_especiales'
                };
                
                // Agregar token CSRF antes de crear ticket
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(ticketData);
                }
                
                await addDoc(collection(db, 'tickets'), ticketData);
                // Ticket de Especiales creado exitosamente (sin log)
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå Error creando ticket de Especiales', error);
                } else {
                    console.error('‚ùå Error creando ticket de Especiales');
                }
                alert('Error al crear el ticket. Por favor, reporta esto al administrador.');
            }
        }
        
        // Inventario completo Especiales - confirmar y continuar
        window.inventarioCompletoEspeciales = async function() {
            // Cerrar modal de Especiales
            const modalEspeciales = bootstrap.Modal.getInstance(document.getElementById('modalVerificarInventarioEspeciales'));
            modalEspeciales.hide();
            
            // Iniciar turno
            await iniciarTurnoConBodegaAPV();
            
            // Mensaje de agradecimiento
            mostrarMensajeExito('Turno iniciado correctamente', 'Gracias por confirmar todos los inventarios.');
        }

        // Mostrar productos faltantes
        window.mostrarProductosFaltantes = function() {
            const pasoConfirmacion = document.getElementById('pasoConfirmacion');
            const pasoProductosFaltantes = document.getElementById('pasoProductosFaltantes');
            const listaProductosFaltantes = document.getElementById('listaProductosFaltantes');
            const btnVolverAtras = document.getElementById('btnVolverAtras');
            const btnConfirmarFaltantes = document.getElementById('btnConfirmarFaltantes');
            
            // Ocultar paso 1, mostrar paso 2
            pasoConfirmacion.style.display = 'none';
            pasoProductosFaltantes.style.display = 'block';
            btnVolverAtras.style.display = 'inline-block';
            btnConfirmarFaltantes.style.display = 'inline-block';
            
            // Llenar lista de productos faltantes
            if (inventarioBodega.length === 0) {
                listaProductosFaltantes.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>No hay productos en esta bodega
                    </div>
                `;
            } else {
                listaProductosFaltantes.innerHTML = inventarioBodega.map(item => `
                    <div class="card mb-3 producto-faltante-item" data-producto-id="${item.productoId}">
                        <div class="card-body p-3">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" value="${item.productoId}" id="checkProducto_${item.productoId}" onchange="toggleCantidadFaltante('${item.productoId}', ${item.cantidad})" style="width: 20px; height: 20px;">
                                <label class="form-check-label ms-2" for="checkProducto_${item.productoId}" style="cursor: pointer; font-size: 1rem;">
                                    <strong>${item.productoNombre}</strong>
                                    <span class="text-muted d-block small">Cantidad esperada: ${item.cantidad} unidades</span>
                                </label>
                            </div>
                            <div class="cantidad-faltante-container" id="cantidadFaltante_${item.productoId}" style="display: none;">
                                <label class="form-label fw-bold mb-2">
                                    <i class="fas fa-exclamation-circle text-warning me-1"></i>Cantidad faltante:
                                </label>
                                <div class="input-group input-group-lg">
                                    <button class="btn btn-outline-danger" type="button" onclick="decrementarCantidadFaltante('${item.productoId}', ${item.cantidad})" style="min-width: 50px; font-size: 1.2rem; font-weight: bold;">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="form-control text-center fw-bold" id="inputCantidadFaltante_${item.productoId}" 
                                           min="1" max="${item.cantidad}" value="1" 
                                           onchange="validarCantidadFaltante('${item.productoId}', ${item.cantidad})"
                                           style="font-size: 1.1rem;">
                                    <button class="btn btn-outline-success" type="button" onclick="incrementarCantidadFaltante('${item.productoId}', ${item.cantidad})" style="min-width: 50px; font-size: 1.2rem; font-weight: bold;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <span class="input-group-text fw-bold">de ${item.cantidad}</span>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Se abrir√° un ticket de investigaci√≥n a Gerencia
                                </small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Volver a confirmaci√≥n inicial
        window.volverAConfirmacion = function() {
            const pasoConfirmacion = document.getElementById('pasoConfirmacion');
            const pasoProductosFaltantes = document.getElementById('pasoProductosFaltantes');
            const btnVolverAtras = document.getElementById('btnVolverAtras');
            const btnConfirmarFaltantes = document.getElementById('btnConfirmarFaltantes');
            
            // Mostrar paso 1, ocultar paso 2
            pasoConfirmacion.style.display = 'block';
            pasoProductosFaltantes.style.display = 'none';
            btnVolverAtras.style.display = 'none';
            btnConfirmarFaltantes.style.display = 'none';
            
            // Limpiar checkboxes
            const checkboxes = document.querySelectorAll('#listaProductosFaltantes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const productoId = checkbox.value;
                const cantidadContainer = document.getElementById(`cantidadFaltante_${productoId}`);
                if (cantidadContainer) {
                    cantidadContainer.style.display = 'none';
                }
            });
        }

        // Toggle para mostrar/ocultar campo de cantidad faltante
        window.toggleCantidadFaltante = function(productoId, cantidadMaxima) {
            const checkbox = document.getElementById(`checkProducto_${productoId}`);
            const cantidadContainer = document.getElementById(`cantidadFaltante_${productoId}`);
            const cantidadInput = document.getElementById(`inputCantidadFaltante_${productoId}`);
            
            if (checkbox.checked) {
                cantidadContainer.style.display = 'block';
                cantidadInput.value = 1;
                cantidadInput.max = cantidadMaxima;
                cantidadInput.dataset.max = cantidadMaxima;
            } else {
                cantidadContainer.style.display = 'none';
                cantidadInput.value = '';
            }
        }

        // Incrementar cantidad faltante
        window.incrementarCantidadFaltante = function(productoId, cantidadMaxima) {
            const cantidadInput = document.getElementById(`inputCantidadFaltante_${productoId}`);
            if (!cantidadInput) return;
            
            let valorActual = parseInt(cantidadInput.value) || 1;
            if (valorActual < cantidadMaxima) {
                valorActual++;
                cantidadInput.value = valorActual;
                validarCantidadFaltante(productoId, cantidadMaxima);
            }
        }

        // Decrementar cantidad faltante
        window.decrementarCantidadFaltante = function(productoId, cantidadMaxima) {
            const cantidadInput = document.getElementById(`inputCantidadFaltante_${productoId}`);
            if (!cantidadInput) return;
            
            let valorActual = parseInt(cantidadInput.value) || 1;
            if (valorActual > 1) {
                valorActual--;
                cantidadInput.value = valorActual;
                validarCantidadFaltante(productoId, cantidadMaxima);
            }
        }

        // Validar cantidad faltante
        window.validarCantidadFaltante = function(productoId, cantidadMaxima) {
            const cantidadInput = document.getElementById(`inputCantidadFaltante_${productoId}`);
            if (!cantidadInput) return;
            
            let valor = parseInt(cantidadInput.value) || 1;
            
            // Asegurar que no sea menor a 1
            if (valor < 1) {
                valor = 1;
                cantidadInput.value = valor;
            }
            
            // Asegurar que no sea mayor a la cantidad m√°xima
            if (valor > cantidadMaxima) {
                valor = cantidadMaxima;
                cantidadInput.value = valor;
                alert(`La cantidad faltante no puede ser mayor a ${cantidadMaxima} (cantidad disponible)`);
            }
        }

        // Confirmar productos faltantes y crear tickets
        window.confirmarProductosFaltantes = async function() {
            // Obtener productos faltantes de los checkboxes marcados
            const checkboxes = document.querySelectorAll('#listaProductosFaltantes input[type="checkbox"]:checked');
            const productosFaltantes = [];
            
            checkboxes.forEach(checkbox => {
                const productoId = checkbox.value;
                const cantidadInput = document.getElementById(`inputCantidadFaltante_${productoId}`);
                const cantidadFaltante = cantidadInput ? parseInt(cantidadInput.value) || 1 : 1;
                
                const producto = inventarioBodega.find(p => p.productoId === productoId);
                if (producto) {
                    productosFaltantes.push({
                        productoId: producto.productoId,
                        productoNombre: producto.productoNombre,
                        cantidadEsperada: producto.cantidad,
                        cantidadFaltante: cantidadFaltante
                    });
                }
            });
            
            if (productosFaltantes.length === 0) {
                alert('Por favor, marca al menos un producto faltante o vuelve atr√°s si el inventario est√° completo.');
                return;
            }
            
            // Confirmar antes de crear ticket
            const listaProductos = productosFaltantes.map(p => 
                `- ${p.productoNombre} (Faltante: ${p.cantidadFaltante} de ${p.cantidadEsperada})`
            ).join('\n');
            
            const confirmacion = confirm(
                `Se abrir√° un ticket de investigaci√≥n a Gerencia con ${productosFaltantes.length} producto(s) faltante(s):\n\n` +
                `${listaProductos}\n\n` +
                `¬øDeseas continuar?`
            );
            
            if (!confirmacion) {
                return;
            }
            
            // Crear un solo ticket con todos los productos faltantes
            await crearTicketProductosFaltantes(productosFaltantes);
            
            // Cerrar modal de APV
            const modalVerificacion = bootstrap.Modal.getInstance(document.getElementById('modalVerificarInventario'));
            modalVerificacion.hide();
            
            // Continuar directamente con Especiales
            await continuarConEspeciales();
        }

        // Crear un solo ticket con todos los productos faltantes
        async function crearTicketProductosFaltantes(productosFaltantes) {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user) return;
                
                // Crear descripci√≥n con todos los productos faltantes
                const listaProductos = productosFaltantes.map((p, index) => 
                    `${index + 1}. ${p.productoNombre}\n   - Cantidad Esperada: ${p.cantidadEsperada} unidades\n   - Cantidad Faltante: ${p.cantidadFaltante} unidades`
                ).join('\n\n');
                
                const descripcion = `PRODUCTOS FALTANTES EN BODEGA APV\n\n` +
                    `Bodega: ${bodegaAPVSeleccionada.nombre}\n` +
                    `Reportado por: ${user.nombre || user.id}\n` +
                    `Fecha: ${new Date().toLocaleString('es-ES')}\n\n` +
                    `PRODUCTOS FALTANTES (${productosFaltantes.length} producto(s)):\n\n` +
                    `${listaProductos}\n\n` +
                    `Se requiere investigaci√≥n interna para determinar la causa de la falta de inventario.`;
                
                // Obtener nombres completos
                const creadoPorNombre = user.nombre || user.id;
                const asignadoANombre = await obtenerNombreEmpleado('fabian.soto');
                
                // Calcular fecha de vencimiento (24 horas despu√©s de la creaci√≥n, a las 23:59:59.999)
                const fechaVencimiento = new Date();
                fechaVencimiento.setTime(fechaVencimiento.getTime() + (24 * 60 * 60 * 1000)); // Sumar 24 horas
                fechaVencimiento.setHours(23, 59, 59, 999); // Establecer a 23:59:59.999 del d√≠a siguiente
                
                const ticketData = {
                    titulo: `Investigaci√≥n de Inventario: ${productosFaltantes.length} producto(s) faltante(s) en ${bodegaAPVSeleccionada.nombre}`,
                    descripcion: descripcion,
                    creadoPor: user.id,
                    creadoPorNombre: creadoPorNombre,
                    asignadoA: 'fabian.soto',
                    asignadoANombre: asignadoANombre,
                    prioridad: 'urgente',
                    estado: 'pendiente',
                    fechaCreacion: serverTimestamp(),
                    fechaVencimiento: Timestamp.fromDate(fechaVencimiento),
                    comentarios: [],
                    tipo: 'revision_inventario',
                    bodegaAPV: bodegaAPVSeleccionada.id,
                    bodegaAPVNombre: bodegaAPVSeleccionada.nombre,
                    productosFaltantes: productosFaltantes.map(p => ({
                        productoId: p.productoId,
                        productoNombre: p.productoNombre,
                        cantidadEsperada: p.cantidadEsperada,
                        cantidadFaltante: p.cantidadFaltante
                    }))
                };
                
                // Agregar token CSRF antes de crear ticket
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(ticketData);
                }
                
                await addDoc(collection(db, 'tickets'), ticketData);
                if (window.safeLogger) {
                    window.safeLogger.success(`‚úÖ Ticket de investigaci√≥n creado con ${productosFaltantes.length} producto(s) faltante(s)`);
                } else {
                    // Ticket de investigaci√≥n creado (sin log)
                }
                
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå Error creando ticket', error);
                } else {
                    console.error('‚ùå Error creando ticket');
                }
                alert('Error al crear el ticket. Por favor, reporta esto al administrador.');
            }
        }

        // Iniciar turno con bodega APV seleccionada
        async function iniciarTurnoConBodegaAPV() {
            try {
                // Obtener usuario de secureAuthManager primero, luego de authManager
                let user = null;
                if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                    user = window.secureAuthManager.getCurrentUser();
                } else if (window.authManager && window.authManager.isAuthenticated()) {
                    user = window.authManager.getCurrentUser();
                }
                
                // Si no hay usuario, esperar un poco y reintentar
                if (!user || (!user.id && !user.username)) {
                    if (window.safeLogger) {
                        window.safeLogger.warn('‚ö†Ô∏è [REGISTRO_HORAS_SECURE] Usuario no disponible, esperando...');
                    } else {
                        // Usuario no disponible, esperando (sin log)
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Reintentar
                    if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                        user = window.secureAuthManager.getCurrentUser();
                    } else if (window.authManager && window.authManager.isAuthenticated()) {
                        user = window.authManager.getCurrentUser();
                    }
                }
                
                if (!user || (!user.id && !user.username)) {
                    if (window.safeLogger) {
                        window.safeLogger.error('‚ùå [REGISTRO_HORAS_SECURE] Usuario no disponible o sin ID/username despu√©s de esperar');
                    } else {
                        console.error('‚ùå [REGISTRO_HORAS_SECURE] Usuario no disponible o sin ID/username despu√©s de esperar');
                    }
                    showButtonError(btnStartWork, 'No autenticado');
                    return;
                }
                
                // Asegurar que tenemos un identificador v√°lido
                const userId = user.id || user.username;
                if (!userId) {
                    console.error('‚ùå [REGISTRO_HORAS_SECURE] Usuario sin ID ni username:', user);
                    showButtonError(btnStartWork, 'Error: Usuario sin identificador');
                    return;
                }
                
                // Iniciando turno (sin exponer datos)

                // Verificar si ya hay una sesi√≥n activa localmente
                if (currentWorkSession && currentWorkSession.status === 'working') {
                    showButtonError(btnStartWork, 'Sesi√≥n activa');
                    return;
                }

                // Verificar si hay una sesi√≥n activa en Firebase para este usuario
                // Usar firebaseAuthUID para consultas (m√°s confiable con reglas)
                const userIdForQuery = user.firebaseUID || user.firebaseAuthUID || userId;
                if (window.safeLogger) {
                    window.safeLogger.info('üîç Verificando sesiones activas en Firebase');
                } else {
                    // Verificando sesiones activas (sin log)
                }
                
                // Intentar primero con firebaseAuthUID (m√°s confiable)
                let q;
                if (user.firebaseUID || user.firebaseAuthUID) {
                    q = query(
                        collection(db, 'work_sessions'),
                        where('firebaseAuthUID', '==', userIdForQuery),
                        where('status', '==', 'working')
                    );
                } else {
                    // Fallback a username si no hay firebaseAuthUID
                    q = query(
                        collection(db, 'work_sessions'),
                        where('username', '==', userId),
                        where('status', '==', 'working')
                    );
                }
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const activeSessions = querySnapshot.docs;
                    if (window.safeLogger) {
                        window.safeLogger.warn(`‚ö†Ô∏è ${activeSessions.length} sesi√≥n(es) activa(s) encontrada(s) en Firebase`);
                    } else {
                        // Sesiones activas encontradas (sin log)
                    }
                    
                    if (activeSessions.length > 1) {
                        console.error('‚ùå M√öLTIPLES SESIONES ACTIVAS DETECTADAS AL INICIAR TURNO:', activeSessions.length);
                        showButtonError(btnStartWork, 'Error: M√∫ltiples sesiones activas detectadas. Contacta al administrador.');
                        return;
                    }
                    
                    const activeSession = activeSessions[0].data();
                    const sessionId = activeSessions[0].id;
                    // Sesi√≥n activa encontrada (sin log)
                    showButtonError(btnStartWork, 'Ya tienes un turno activo. Term√≠nalo antes de iniciar uno nuevo.');
                    return;
                }

                const startTime = new Date();
                const startTimestamp = Timestamp.fromDate(startTime);
                
                currentWorkSession = {
                    username: userId,
                    startTime: startTime,
                    endTime: null,
                    status: 'working'
                };

                // Preparar datos de la sesi√≥n
                const sessionData = {
                    username: userId,
                    userId: userId, // Campo adicional para compatibilidad con reglas
                    firebaseAuthUID: user.firebaseUID || (window.firebaseAuth?.currentUser?.uid), // Campo para verificaci√≥n en reglas
                    startTime: startTimestamp,
                    endTime: null,
                    status: 'working',
                    bodegaAPV: bodegaAPVSeleccionada ? bodegaAPVSeleccionada.id : null,
                    bodegaAPVNombre: bodegaAPVSeleccionada ? bodegaAPVSeleccionada.nombre : null
                };

                // Lista de usuarios exentos de GPS obligatorio
                const usuariosExentosGPS = ['luis.nu√±ez', 'andres.rodriguez', 'alfredo.delgado'];
                
                // Capturar GPS obligatorio para todos excepto usuarios exentos
                if (!usuariosExentosGPS.includes(userId)) {
                    // Verificar disponibilidad de GPS
                    if (!navigator.geolocation) {
                        showButtonError(btnStartWork, 'GPS no disponible en este dispositivo');
                        return;
                    }

                    try {
                        if (window.safeLogger) {
                            window.safeLogger.info('üìç Capturando GPS (obligatorio)...');
                        } else {
                            // Capturando GPS (obligatorio) (sin log)
                        }
                        const gpsData = await window.captureGPS();
                        
                        // Validar distancia desde Central Guachipelin
                        const distancia = calcularDistancia(
                            gpsData.latitude,
                            gpsData.longitude,
                            CENTRAL_GUACHIPELIN.lat,
                            CENTRAL_GUACHIPELIN.lng
                        );
                        
                        // Distancia calculada (sin log)
                        
                        if (distancia > RADIO_PERMITIDO_METROS) {
                            // Est√° fuera del radio, mostrar alerta informativa
                            const distanciaKm = (distancia / 1000).toFixed(2);
                            alert(`‚ö†Ô∏è Alerta de Ubicaci√≥n\n\nTe encuentras a ${distanciaKm} km de Central Guachipelin.\n\nEsta acci√≥n ser√° registrada para revisi√≥n.`);
                            
                            // Marcar que se inici√≥ desde lejos
                            sessionData.inicioFueraRadio = true;
                            sessionData.distanciaInicio = distancia;
                            
                            // Enviar alerta a gerencia
                            await enviarAlertaGerencia(userId, user.nombre, 'inicio', distancia, gpsData);
                        }
                        
                        sessionData.gpsStart = gpsData;
                        sessionData.distanciaInicio = distancia;
                        if (window.safeLogger) {
                            window.safeLogger.success('‚úÖ GPS capturado al iniciar turno');
                        } else {
                            // GPS capturado al iniciar turno (sin log)
                        }
                        showGPSInfo(gpsData, 'start');
                    } catch (error) {
                        console.error('‚ùå Error capturando GPS:', error.message);
                        showButtonError(btnStartWork, 'Error de ubicaci√≥n');
                        showGPSRequiredNotification(error.message);
                        return; // No continuar si no hay GPS
                    }
                } else {
                    // Usuario exento de GPS obligatorio (sin log)
                }

                // Guardar en Firebase
                // Agregar token CSRF a los datos antes de guardar
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(sessionData);
                }
                
                const docRef = await addDoc(collection(db, 'work_sessions'), sessionData);

                // Guardar el ID de la sesi√≥n
                currentWorkSession.id = docRef.id;

                // Actualizar UI
                if (workStatusEl) {
                    workStatusEl.className = 'status-indicator-elegant online';
                    const statusText = workStatusEl.querySelector('.status-text');
                    if (statusText) statusText.textContent = 'App Encendida';
                }
                if (employeeNameEl) employeeNameEl.textContent = user.nombre;

                // Actualizar botones
                updateButtonState(true);

                // Iniciar contador de tiempo
                timeInterval = setInterval(updateWorkDuration, 1000);

                // Recargar historial para mostrar turno activo
                await loadWorkHistory();

            } catch (error) {
                console.error('Error iniciando turno:', error);
                showButtonError(btnStartWork, 'Error al iniciar');
            }
        }

        // Funci√≥n para mostrar mensajes de √©xito en modal personalizado
        function mostrarMensajeExito(titulo, texto) {
            const tituloEl = document.getElementById('mensajeExitoTitulo');
            const textoEl = document.getElementById('mensajeExitoTexto');
            
            if (tituloEl) tituloEl.textContent = titulo;
            if (textoEl) textoEl.textContent = texto;
            
            const modal = new bootstrap.Modal(document.getElementById('modalMensajeExito'));
            modal.show();
        }

        // Continuar con el proceso de inicio de turno (sin modal de modo prueba)
        window.continuarConModoPrueba = async function() {
            // Continuar con el flujo normal
            await continuarIniciarTurno();
        }

        // Continuar con el inicio de turno (despu√©s del mensaje de prueba)
        async function continuarIniciarTurno() {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) {
                    showButtonError(btnStartWork, 'No autenticado');
                    return;
                }

                // Verificar si ya hay una sesi√≥n activa localmente
                if (currentWorkSession && currentWorkSession.status === 'working') {
                    showButtonError(btnStartWork, 'Sesi√≥n activa');
                    return;
                }

                // Verificar si hay una sesi√≥n activa en Firebase para este usuario
                // Usar firebaseAuthUID para consultas (m√°s confiable con reglas)
                const userIdForQuery = user.firebaseUID || user.firebaseAuthUID || user.id;
                // Verificando sesiones activas (sin log)
                
                // Intentar primero con firebaseAuthUID (m√°s confiable)
                let q;
                if (user.firebaseUID || user.firebaseAuthUID) {
                    q = query(
                        collection(db, 'work_sessions'),
                        where('firebaseAuthUID', '==', userIdForQuery),
                        where('status', '==', 'working')
                    );
                } else {
                    // Fallback a username si no hay firebaseAuthUID
                    q = query(
                        collection(db, 'work_sessions'),
                        where('username', '==', user.id),
                        where('status', '==', 'working')
                    );
                }
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const activeSessions = querySnapshot.docs;
                    // Sesiones activas encontradas (sin log)
                    
                    if (activeSessions.length > 1) {
                        console.error('‚ùå M√öLTIPLES SESIONES ACTIVAS DETECTADAS AL INICIAR TURNO:', activeSessions.length);
                        showButtonError(btnStartWork, 'Error: M√∫ltiples sesiones activas detectadas. Contacta al administrador.');
                        return;
                    }
                    
                    const activeSession = activeSessions[0].data();
                    const sessionId = activeSessions[0].id;
                    // Sesi√≥n activa encontrada (sin log)
                    showButtonError(btnStartWork, 'Ya tienes un turno activo. Term√≠nalo antes de iniciar uno nuevo.');
                    return;
                }

                // Abrir modal inmediatamente
                const modalSeleccionar = new bootstrap.Modal(document.getElementById('modalSeleccionarBodegaAPV'));
                modalSeleccionar.show();
                
                // Cargar bodegas APV y productos en segundo plano (si no est√°n cargados)
                Promise.all([
                    bodegasAPV.length === 0 ? cargarBodegasAPV() : Promise.resolve(),
                    productos.length === 0 ? cargarProductos() : Promise.resolve()
                ]).catch(error => {
                    console.error('Error cargando datos:', error);
                });

            } catch (error) {
                console.error('Error iniciando turno:', error);
                showButtonError(btnStartWork, 'Error al iniciar');
            }
        }

        // Iniciar turno
        async function startWork() {
            try {
                // Continuar directamente con el proceso de inicio de turno
                await continuarConModoPrueba();
            } catch (error) {
                console.error('Error iniciando turno:', error);
                showButtonError(btnStartWork, 'Error al iniciar');
            }
        }

        // Finalizar turno (abre modal de confirmaci√≥n)
        async function finalizarWork() {
            try {
                if (!currentWorkSession) {
                    showButtonError(btnEndWork, 'No hay sesi√≥n');
                    return;
                }

                // Verificar si la bodega es "Trabajo en Oficina Sin Inventario"
                let esOficinaSinInventario = false;
                
                if (bodegaAPVSeleccionada && (bodegaAPVSeleccionada.id === 'OFICINA_SIN_INVENTARIO' || bodegaAPVSeleccionada.sinInventario)) {
                    esOficinaSinInventario = true;
                } else if (currentWorkSession.id) {
                    // Buscar en Firebase si no est√° en memoria
                    try {
                        const sessionDoc = await getDoc(doc(db, 'work_sessions', currentWorkSession.id));
                        if (sessionDoc.exists()) {
                            const sessionData = sessionDoc.data();
                            if (sessionData.bodegaAPV === 'OFICINA_SIN_INVENTARIO' || sessionData.bodegaAPVNombre === 'Trabajo en Oficina Sin Inventario') {
                                esOficinaSinInventario = true;
                            }
                        }
                    } catch (error) {
                        // Error verificando bodega (sin log)
                    }
                }

                // Si es "Trabajo en Oficina Sin Inventario", finalizar directamente
                if (esOficinaSinInventario) {
                    await finalizarTurnoCompleto();
                    mostrarMensajeExito('Turno finalizado correctamente', 'Trabajo en oficina sin inventario.');
                    return;
                }

                // Abrir modal para confirmar liquidaci√≥n
                const modal = new bootstrap.Modal(document.getElementById('modalConfirmarLiquidacion'));
                modal.show();

            } catch (error) {
                console.error('Error al intentar finalizar turno:', error);
                showButtonError(btnEndWork, 'Error al finalizar');
            }
        }

        // Ir a liquidar inventario
        window.irALiquidarInventario = function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarLiquidacion'));
            modal.hide();
            window.location.href = 'operario_bodega.html';
        }

        // Confirmar liquidaci√≥n completa y cerrar turno
        window.confirmarLiquidacionCompleta = async function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarLiquidacion'));
            modal.hide();
            await finalizarTurnoCompleto();
        }

        // Finalizar turno completo
        async function finalizarTurnoCompleto() {
            try {
                if (!currentWorkSession) {
                    showButtonError(btnEndWork, 'No hay sesi√≥n');
                    return;
                }

                const endTime = new Date();
                const endTimestamp = Timestamp.fromDate(endTime);
                
                // Calcular duraci√≥n total
                const duration = calculateDurationHours(currentWorkSession.startTime, endTime);

                // Preparar datos de actualizaci√≥n
                const updateData = {
                    endTime: endTimestamp,
                    status: 'completed'
                };

                // Lista de usuarios exentos de GPS obligatorio
                const usuariosExentosGPS = ['luis.nu√±ez', 'andres.rodriguez', 'alfredo.delgado'];
                
                // Capturar GPS al terminar obligatorio para todos excepto usuarios exentos
                if (!usuariosExentosGPS.includes(currentWorkSession.username)) {
                    try {
                        // Capturando GPS al terminar turno (sin log)
                        const gpsData = await window.captureGPS();
                        
                        // Validar distancia desde Central Guachipelin
                        const distancia = calcularDistancia(
                            gpsData.latitude,
                            gpsData.longitude,
                            CENTRAL_GUACHIPELIN.lat,
                            CENTRAL_GUACHIPELIN.lng
                        );
                        
                        // Distancia calculada (sin log)
                        
                        if (distancia > RADIO_PERMITIDO_METROS) {
                            // Est√° fuera del radio, mostrar alerta informativa
                            const distanciaKm = (distancia / 1000).toFixed(2);
                            alert(`‚ö†Ô∏è Alerta de Ubicaci√≥n\n\nTe encuentras a ${distanciaKm} km de Central Guachipelin.\n\nEsta acci√≥n ser√° registrada para revisi√≥n.`);
                            
                            // Marcar que se finaliz√≥ desde lejos
                            updateData.finFueraRadio = true;
                            updateData.distanciaFin = distancia;
                            
                            // Enviar alerta a gerencia
                            const user = window.authManager.getCurrentUser();
                            await enviarAlertaGerencia(currentWorkSession.username, user?.nombre || currentWorkSession.username, 'fin', distancia, gpsData);
                        }
                        
                        updateData.gpsEnd = gpsData;
                        updateData.distanciaFin = distancia;
                        // GPS capturado al terminar turno (sin log)
                        showGPSInfo(gpsData, 'end');
                    } catch (error) {
                        console.error('‚ùå Error capturando GPS al terminar:', error.message);
                        showButtonError(btnEndWork, 'Error de ubicaci√≥n');
                        showGPSRequiredNotification(error.message);
                        return; // No continuar si no hay GPS
                    }
                } else {
                    console.log(`‚ÑπÔ∏è Usuario ${currentWorkSession.username} exento de GPS obligatorio`);
                }

                // Actualizar en Firebase usando el ID de la sesi√≥n actual
                if (currentWorkSession.id) {
                    const sessionRef = doc(db, 'work_sessions', currentWorkSession.id);
                    // Agregar token CSRF antes de actualizar
                    if (window.csrfProtection) {
                        window.csrfProtection.addTokenToData(updateData);
                    }
                    
                    await updateDoc(sessionRef, updateData);
                } else {
                    // Fallback: buscar por query si no tenemos ID
                    // Usar firebaseAuthUID para consultas (m√°s confiable con reglas)
                    const user = window.authManager.getCurrentUser();
                    const userIdForQuery = user?.firebaseUID || user?.firebaseAuthUID || currentWorkSession.username;
                    // Buscando sesi√≥n por query (sin log)
                    
                    let q;
                    if (user?.firebaseUID || user?.firebaseAuthUID) {
                        q = query(collection(db, 'work_sessions'), 
                            where('firebaseAuthUID', '==', userIdForQuery),
                            where('status', '==', 'working'));
                    } else {
                        q = query(collection(db, 'work_sessions'), 
                            where('username', '==', currentWorkSession.username),
                            where('status', '==', 'working'));
                    }
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const sessionDoc = querySnapshot.docs[0];
                        // Agregar token CSRF antes de actualizar
                        if (window.csrfProtection) {
                            window.csrfProtection.addTokenToData(updateData);
                        }
                        
                        await updateDoc(sessionDoc.ref, updateData);
                    }
                }

                // Actualizar UI
                if (workStatusEl) {
                    workStatusEl.className = 'status-indicator offline';
                    const statusText = workStatusEl.querySelector('.status-text');
                    if (statusText) statusText.textContent = 'App Apagada';
                }

                // Actualizar botones
                updateButtonState(false);

                // Limpiar sesi√≥n actual
                currentWorkSession = null;
                clearInterval(timeInterval);

                // Mostrar feedback visual de √©xito
                showButtonSuccess(btnEndWork, '¬°Turno finalizado!');

                // Recargar historial
                loadWorkHistory();
                
                // Si es Paniagua, actualizar salario
                if (esPaniagua) {
                    iniciarActualizacionSalarioPaniagua();
                }

            } catch (error) {
                console.error('Error finalizando turno:', error);
                showButtonError(btnEndWork, 'Error al finalizar');
            }
        }

        // Funci√≥n de duraci√≥n eliminada - ya no se necesita

        // Formatear duraci√≥n
        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = (minutes % 60).toFixed(2);
            return `${hours}h ${mins}m`;
        }

        // Variables para secci√≥n Paniagua
        let esPaniagua = false;
        let datosEmpleadoPaniagua = null;
        let rankingPaniagua = [];
        let salarioIntervalPaniagua = null;
        const SALARIO_POR_HORA_PANIAGUA = 3000;
        const PRESUPUESTO_MENSUAL_PANIAGUA = 610000; // 610,000 colones por mes
        
        // Coordenadas de Central Guachipelin y radio permitido
        const CENTRAL_GUACHIPELIN = {
            lat: 9.953893,
            lng: -84.165365
        };
        const RADIO_PERMITIDO_METROS = 200;
        const PASSWORD_FUERA_RADIO = 'GUACHIPELIN2025'; // Contrase√±a para iniciar/finalizar desde lejos
        
        // Calcular distancia entre dos coordenadas usando f√≥rmula de Haversine
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distancia en metros
        }
        
        // Solicitar contrase√±a cuando est√° fuera del radio
        function solicitarPasswordFueraRadio(tipo) {
            return new Promise((resolve) => {
                // Crear modal din√°micamente
                const modalHTML = `
                    <div class="modal fade" id="modalPasswordFueraRadio" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Ubicaci√≥n Fuera del Radio Permitido
                                    </h5>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        <strong>Te encuentras muy lejos de Central Guachipelin</strong>
                                        <p class="mb-0 mt-2">Para ${tipo === 'inicio' ? 'iniciar' : 'finalizar'} el turno desde esta ubicaci√≥n, ingresa la contrase√±a de autorizaci√≥n.</p>
                                        <p class="mb-0 mt-2"><small>Esta acci√≥n ser√° reportada a gerencia para revisi√≥n manual.</small></p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="passwordFueraRadio" class="form-label">Contrase√±a de Autorizaci√≥n</label>
                                        <input type="password" class="form-control" id="passwordFueraRadio" placeholder="Ingresa la contrase√±a" autocomplete="new-password">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="cancelarPasswordFueraRadio()">Cancelar</button>
                                    <button type="button" class="btn btn-warning" onclick="confirmarPasswordFueraRadio()">
                                        <i class="fas fa-check me-2"></i>Autorizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal anterior si existe
                const modalAnterior = document.getElementById('modalPasswordFueraRadio');
                if (modalAnterior) {
                    modalAnterior.remove();
                }
                
                // Agregar modal al body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalPasswordFueraRadio'));
                modal.show();
                
                // Focus en el input
                setTimeout(() => {
                    const input = document.getElementById('passwordFueraRadio');
                    if (input) {
                        input.focus();
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                confirmarPasswordFueraRadio();
                            }
                        });
                    }
                }, 300);
                
                // Guardar resolve en variable global para acceso desde botones
                window._passwordFueraRadioResolve = resolve;
            });
        }
        
        // Confirmar contrase√±a fuera del radio
        window.confirmarPasswordFueraRadio = function() {
            const input = document.getElementById('passwordFueraRadio');
            const password = input ? input.value : '';
            
            if (password === PASSWORD_FUERA_RADIO) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalPasswordFueraRadio'));
                if (modal) modal.hide();
                
                // Limpiar
                setTimeout(() => {
                    const modalEl = document.getElementById('modalPasswordFueraRadio');
                    if (modalEl) modalEl.remove();
                }, 300);
                
                if (window._passwordFueraRadioResolve) {
                    window._passwordFueraRadioResolve(true);
                    window._passwordFueraRadioResolve = null;
                }
            } else {
                input.classList.add('is-invalid');
                input.value = '';
                setTimeout(() => {
                    input.classList.remove('is-invalid');
                    input.focus();
                }, 1000);
            }
        };
        
        // Cancelar contrase√±a fuera del radio
        window.cancelarPasswordFueraRadio = function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalPasswordFueraRadio'));
            if (modal) modal.hide();
            
            setTimeout(() => {
                const modalEl = document.getElementById('modalPasswordFueraRadio');
                if (modalEl) modalEl.remove();
            }, 300);
            
            if (window._passwordFueraRadioResolve) {
                window._passwordFueraRadioResolve(false);
                window._passwordFueraRadioResolve = null;
            }
        };
        
        // Enviar alerta a gerencia cuando se inicia/finaliza turno desde lejos
        async function enviarAlertaGerencia(username, nombreEmpleado, tipo, distancia, gpsData) {
            try {
                const user = window.authManager.getCurrentUser();
                const ahora = new Date();
                
                const alertaData = {
                    tipo: 'turno_fuera_radio',
                    username: username,
                    nombreEmpleado: nombreEmpleado,
                    accion: tipo === 'inicio' ? 'Inicio de turno' : 'Finalizaci√≥n de turno',
                    distancia: distancia,
                    coordenadas: {
                        lat: gpsData.latitude,
                        lng: gpsData.longitude
                    },
                    fecha: serverTimestamp(),
                    revisado: false,
                    asignadoA: 'fabian.soto', // Gerencia
                    prioridad: 'alta',
                    mensaje: `El empleado ${nombreEmpleado} (${username}) ${tipo === 'inicio' ? 'inici√≥' : 'finaliz√≥'} un turno desde una ubicaci√≥n a ${distancia.toFixed(2)} metros (${(distancia / 1000).toFixed(2)} km) de Central Guachipelin.`
                };
                
                // Agregar token CSRF
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(alertaData);
                }
                
                await addDoc(collection(db, 'alertas_gerencia'), alertaData);
                // Alerta enviada a gerencia (sin log)
            } catch (error) {
                console.error('‚ùå Error enviando alerta a gerencia:', error);
            }
        }
        
        // Premios disponibles para rotaci√≥n
        const PREMIOS_PANIAGUA = [
            {
                id: 'madrugador',
                nombre: 'üåÖ Madrugador',
                descripcion: 'Inicia turno m√°s temprano',
                icono: 'fa-sun',
                color: '#FFA500',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let horaMasTemprana = 25; // M√°s tarde que cualquier hora
                    paniaguas.forEach(pan => {
                        if (pan.horaInicioPromedio !== undefined && pan.horaInicioPromedio < horaMasTemprana) {
                            horaMasTemprana = pan.horaInicioPromedio;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'buho',
                nombre: 'ü¶â B√∫ho Nocturno',
                descripcion: 'Trabaja m√°s tarde',
                icono: 'fa-moon',
                color: '#4B0082',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let horaMasTarde = -1;
                    paniaguas.forEach(pan => {
                        if (pan.horaFinPromedio !== undefined && pan.horaFinPromedio > horaMasTarde) {
                            horaMasTarde = pan.horaFinPromedio;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'guardian',
                nombre: 'üõ°Ô∏è Guardi√°n',
                descripcion: 'M√°s horas trabajadas',
                icono: 'fa-shield-alt',
                color: '#FF6347',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let maxHoras = -1;
                    paniaguas.forEach(pan => {
                        if (pan.totalHoras > maxHoras) {
                            maxHoras = pan.totalHoras;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'consistente',
                nombre: '‚ö° M√°s Turnos',
                descripcion: 'M√°s turnos completados',
                icono: 'fa-bolt',
                color: '#FFD700',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let maxTurnos = -1;
                    paniaguas.forEach(pan => {
                        if (pan.numeroTurnos > maxTurnos) {
                            maxTurnos = pan.numeroTurnos;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'eficiente',
                nombre: '‚è±Ô∏è Eficiente',
                descripcion: 'M√°s per√≠odos offline de ~1 hora (apag√≥ app en ratos muertos)',
                icono: 'fa-clock',
                color: '#00CED1',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let maxPeriodosOffline = -1;
                    paniaguas.forEach(pan => {
                        if (pan.periodosOffline1Hora !== undefined && pan.periodosOffline1Hora > maxPeriodosOffline) {
                            maxPeriodosOffline = pan.periodosOffline1Hora;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'cobertura',
                nombre: 'üì° Cobertura Total',
                descripcion: 'M√°s horas de cobertura (menos gaps)',
                icono: 'fa-satellite-dish',
                color: '#32CD32',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let maxCobertura = -1;
                    paniaguas.forEach(pan => {
                        if (pan.horasCobertura !== undefined && pan.horasCobertura > maxCobertura) {
                            maxCobertura = pan.horasCobertura;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'solitario',
                nombre: 'üéØ Gerente Solitario',
                descripcion: 'Menos coincidencia con otros gerentes',
                icono: 'fa-user-secret',
                color: '#9370DB',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let minCoincidencia = Infinity;
                    paniaguas.forEach(pan => {
                        if (pan.esGerente && pan.coincidenciaConGerentes !== undefined) {
                            if (pan.coincidenciaConGerentes < minCoincidencia) {
                                minCoincidencia = pan.coincidenciaConGerentes;
                                ganador = pan;
                            }
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'resistente',
                nombre: 'üí™ M√°s Resistente',
                descripcion: 'Sesiones m√°s largas (mayor promedio)',
                icono: 'fa-dumbbell',
                color: '#FF1493',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let maxPromedioSesion = -1;
                    paniaguas.forEach(pan => {
                        if (pan.promedioDuracionSesion !== undefined && pan.promedioDuracionSesion > maxPromedioSesion) {
                            maxPromedioSesion = pan.promedioDuracionSesion;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            },
            {
                id: 'disciplinado',
                nombre: 'üéñÔ∏è M√°s Disciplinado',
                descripcion: 'M√°s d√≠as trabajados en el mes',
                icono: 'fa-medal',
                color: '#FF8C00',
                calcular: (paniaguas) => {
                    let ganador = null;
                    let maxDiasTrabajados = -1;
                    paniaguas.forEach(pan => {
                        if (pan.diasTrabajados !== undefined && pan.diasTrabajados > maxDiasTrabajados) {
                            maxDiasTrabajados = pan.diasTrabajados;
                            ganador = pan;
                        }
                    });
                    return ganador;
                }
            }
        ];

        // Verificar si el usuario es Paniagua y cargar datos
        window.verificarYConfigurarPaniagua = async function() {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) return;
                
                // Cargar datos completos del empleado desde Firestore
                const empleadosQuery = query(
                    collection(db, 'empleados'),
                    where('username', '==', user.id)
                );
                const empleadosSnapshot = await getDocs(empleadosQuery);
                
                if (!empleadosSnapshot.empty) {
                    const empleado = empleadosSnapshot.docs[0].data();
                    const apellido = (empleado.primerApellido || '').toLowerCase();
                    
                    if (apellido.includes('paniagua')) {
                        esPaniagua = true;
                        datosEmpleadoPaniagua = empleado;
                        
                        // Mostrar secci√≥n
                        const seccionPaniagua = document.getElementById('seccionPaniagua');
                        if (seccionPaniagua) {
                            seccionPaniagua.style.display = 'block';
                        }
                        
                        // Cargar ranking de todos los Paniagua
                        await cargarRankingPaniagua();
                        
                        // Iniciar actualizaci√≥n de salario en tiempo real
                        iniciarActualizacionSalarioPaniagua();
                    }
                }
            } catch (error) {
                console.error('Error verificando Paniagua:', error);
            }
        };
        
        // Disparar evento cuando el m√≥dulo est√© listo (con delay para asegurar que los listeners est√©n registrados)
        setTimeout(() => {
            window.dispatchEvent(new CustomEvent('paniaguaModuleReady'));
        }, 100);

        // Cargar ranking de todos los Paniagua (optimizado)
        async function cargarRankingPaniagua() {
            try {
                const ahora = new Date();
                const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
                inicioMes.setHours(0, 0, 0, 0);
                
                // Cargar todos los empleados Paniagua
                const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                const paniaguas = [];
                
                empleadosSnapshot.forEach(doc => {
                    const emp = doc.data();
                    const apellido = (emp.primerApellido || '').toLowerCase();
                    if (apellido.includes('paniagua') && emp.username) {
                        paniaguas.push({
                            id: doc.id,
                            username: emp.username,
                            nombre: `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim() || emp.username,
                            ...emp
                        });
                    }
                });
                
                if (paniaguas.length === 0) {
                    const rankingEl = document.getElementById('rankingPaniagua');
                    if (rankingEl) {
                        rankingEl.innerHTML = '<div class="text-center text-muted">No hay empleados Paniagua registrados</div>';
                    }
                    return;
                }
                
                // Inicializar objeto de horas
                const horasPorPaniagua = {};
                paniaguas.forEach(pan => {
                    horasPorPaniagua[pan.username] = {
                        horas: 0,
                        horasActivas: 0,
                        salario: 0,
                        nombre: pan.nombre,
                        username: pan.username
                    };
                });
                
                // Cargar sesiones del mes actual de forma optimizada (solo para Paniagua)
                const usernamesPaniagua = paniaguas.map(p => p.username).filter(Boolean);
                
                // Cargar sesiones activas primero
                const sesionesActivasPromises = usernamesPaniagua.map(async (username) => {
                    try {
                        const q = query(
                            collection(db, 'work_sessions'),
                            where('username', '==', username),
                            where('status', '==', 'working')
                        );
                        const snapshot = await getDocs(q);
                        return { username, snapshot };
                    } catch (error) {
                        // Error cargando sesiones activas (sin log)
                        return { username, snapshot: null };
                    }
                });
                
                const sesionesActivas = await Promise.all(sesionesActivasPromises);
                
                // Procesar sesiones activas
                sesionesActivas.forEach(({ username, snapshot }) => {
                    if (!snapshot) return;
                    snapshot.forEach(doc => {
                        const session = doc.data();
                        try {
                            let fechaInicio;
                            if (session.startTime?.toDate) {
                                fechaInicio = session.startTime.toDate();
                            } else if (session.startTime instanceof Date) {
                                fechaInicio = session.startTime;
                            } else if (session.startTime) {
                                fechaInicio = new Date(session.startTime);
                            } else {
                                return;
                            }
                            
                            if (fechaInicio >= inicioMes && !isNaN(fechaInicio.getTime())) {
                                const horas = (ahora - fechaInicio) / (1000 * 60 * 60);
                                if (horas > 0 && horas <= 24) {
                                    horasPorPaniagua[username].horasActivas = Math.max(horasPorPaniagua[username].horasActivas, horas);
                                }
                            }
                        } catch (error) {
                            console.warn('Error procesando sesi√≥n activa:', error);
                        }
                    });
                });
                
                // Cargar sesiones completadas del mes (optimizado: solo del mes actual)
                const finMes = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0, 23, 59, 59);
                
                const sesionesCompletadasPromises = usernamesPaniagua.map(async (username) => {
                    try {
                        const q = query(
                            collection(db, 'work_sessions'),
                            where('username', '==', username),
                            where('status', '==', 'completed')
                        );
                        const snapshot = await getDocs(q);
                        return { username, snapshot };
                    } catch (error) {
                        console.warn(`Error cargando sesiones completadas para ${username}:`, error);
                        return { username, snapshot: null };
                    }
                });
                
                const sesionesCompletadas = await Promise.all(sesionesCompletadasPromises);
                
                // Procesar sesiones completadas
                sesionesCompletadas.forEach(({ username, snapshot }) => {
                    if (!snapshot) return;
                    snapshot.forEach(doc => {
                        const session = doc.data();
                        try {
                            let fechaInicio;
                            if (session.startTime?.toDate) {
                                fechaInicio = session.startTime.toDate();
                            } else if (session.startTime instanceof Date) {
                                fechaInicio = session.startTime;
                            } else if (session.startTime) {
                                fechaInicio = new Date(session.startTime);
                            } else {
                                return;
                            }
                            
                            if (fechaInicio >= inicioMes && fechaInicio <= finMes && !isNaN(fechaInicio.getTime())) {
                                let horas = 0;
                                
                                if (session.endTime) {
                                    let fechaFin;
                                    if (session.endTime?.toDate) {
                                        fechaFin = session.endTime.toDate();
                                    } else if (session.endTime instanceof Date) {
                                        fechaFin = session.endTime;
                                    } else if (session.endTime) {
                                        fechaFin = new Date(session.endTime);
                                    } else {
                                        return;
                                    }
                                    
                                    if (!isNaN(fechaFin.getTime()) && fechaFin > fechaInicio) {
                                        horas = (fechaFin - fechaInicio) / (1000 * 60 * 60);
                                    }
                                } else if (session.duracion) {
                                    horas = parseFloat(session.duracion) || 0;
                                }
                                
                                if (horas > 0 && horas <= 24) {
                                    horasPorPaniagua[username].horas += horas;
                                }
                            }
                        } catch (error) {
                            console.warn('Error procesando sesi√≥n completada:', error);
                        }
                    });
                });
                
                // Calcular m√©tricas adicionales para cada Paniagua
                const todasSesionesPromises = usernamesPaniagua.map(async (username) => {
                    try {
                        const q = query(
                            collection(db, 'work_sessions'),
                            where('username', '==', username)
                        );
                        const snapshot = await getDocs(q);
                        return { username, snapshot };
                    } catch (error) {
                        console.warn(`Error cargando todas las sesiones para ${username}:`, error);
                        return { username, snapshot: null };
                    }
                });
                
                const todasSesiones = await Promise.all(todasSesionesPromises);
                
                // Procesar todas las sesiones para calcular m√©tricas
                todasSesiones.forEach(({ username, snapshot }) => {
                    if (!snapshot) return;
                    
                    const pan = horasPorPaniagua[username];
                    if (!pan) return;
                    
                    pan.numeroTurnos = 0;
                    pan.horasInicio = [];
                    pan.horasFin = [];
                    pan.horasPorDia = {}; // Para calcular racha
                    pan.diasConTurno = new Set(); // Para calcular d√≠as consecutivos
                    pan.sesionesCompletas = []; // Para calcular m√©tricas adicionales
                    pan.duracionesSesiones = []; // Para calcular promedio de duraci√≥n
                    pan.esGerente = false; // Para identificar gerentes
                    
                    // Verificar si es gerente (por permisos o cargo) y obtener departamento
                    const empleado = paniaguas.find(p => p.username === username);
                    let requiereDescuento = false;
                    if (empleado) {
                        const permisos = empleado.permisos || {};
                        const cargo = (empleado.cargo || empleado.tipoContrato || '').toLowerCase();
                        pan.esGerente = permisos.reportes_gerenciales === true || 
                                       permisos.administrador_bodega === true ||
                                       cargo.includes('gerente') || 
                                       cargo.includes('gerencia');
                        
                        // Verificar si requiere descuento de almuerzo
                        requiereDescuento = requiereDescuentoAlmuerzo(empleado.departamento);
                    }
                    
                    snapshot.forEach(doc => {
                        const session = doc.data();
                        const fechaInicio = parsearFecha(session.startTime);
                        if (!fechaInicio || isNaN(fechaInicio.getTime())) return;
                        
                        // Contar turnos
                        if (session.status === 'completed' || session.status === 'working') {
                            pan.numeroTurnos++;
                            
                            // Guardar hora de inicio
                            const horaInicio = fechaInicio.getHours() + (fechaInicio.getMinutes() / 60);
                            pan.horasInicio.push(horaInicio);
                            
                            // Guardar hora de fin si existe
                            let fechaFin = null;
                            if (session.endTime) {
                                fechaFin = parsearFecha(session.endTime);
                                if (fechaFin && !isNaN(fechaFin.getTime())) {
                                    const horaFin = fechaFin.getHours() + (fechaFin.getMinutes() / 60);
                                    pan.horasFin.push(horaFin);
                                    
                                    // Guardar sesi√≥n completa para an√°lisis
                                    const duracion = (fechaFin - fechaInicio) / (1000 * 60 * 60);
                                    if (duracion > 0 && duracion <= 24) {
                                        pan.sesionesCompletas.push({
                                            inicio: fechaInicio,
                                            fin: fechaFin,
                                            duracion: duracion
                                        });
                                        pan.duracionesSesiones.push(duracion);
                                    }
                                }
                            } else if (session.status === 'working') {
                                // Sesi√≥n activa: usar hora actual
                                const ahora = new Date();
                                fechaFin = ahora;
                                const duracion = (ahora - fechaInicio) / (1000 * 60 * 60);
                                if (duracion > 0 && duracion <= 24) {
                                    pan.sesionesCompletas.push({
                                        inicio: fechaInicio,
                                        fin: ahora,
                                        duracion: duracion
                                    });
                                    pan.duracionesSesiones.push(duracion);
                                }
                            }
                            
                            // Guardar horas por d√≠a (para racha)
                            const fechaDia = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth(), fechaInicio.getDate());
                            const diaKey = fechaDia.toISOString().split('T')[0];
                            
                            if (!pan.horasPorDia[diaKey]) {
                                pan.horasPorDia[diaKey] = 0;
                            }
                            
                            let horasDia = 0;
                            if (session.endTime) {
                                const fechaFin = parsearFecha(session.endTime);
                                if (fechaFin && !isNaN(fechaFin.getTime()) && fechaFin > fechaInicio) {
                                    horasDia = (fechaFin - fechaInicio) / (1000 * 60 * 60);
                                }
                            } else if (session.duracion) {
                                horasDia = parseFloat(session.duracion) || 0;
                            } else if (session.status === 'working') {
                                // Sesi√≥n activa: calcular hasta ahora
                                const ahora = new Date();
                                horasDia = (ahora - fechaInicio) / (1000 * 60 * 60);
                            }
                            
                            if (horasDia > 0 && horasDia <= 24) {
                                pan.horasPorDia[diaKey] += horasDia;
                            }
                            
                            // Guardar d√≠a con turno (para d√≠as consecutivos)
                            pan.diasConTurno.add(diaKey);
                        }
                    });
                    
                    // Inicializar arrays si no existen
                    if (!pan.sesionesCompletas) pan.sesionesCompletas = [];
                    if (!pan.duracionesSesiones) pan.duracionesSesiones = [];
                    
                    // Aplicar descuento de 1 hora por d√≠a para empleados de departamentos con almuerzo
                    if (requiereDescuento) {
                        Object.keys(pan.horasPorDia).forEach(diaKey => {
                            if (pan.horasPorDia[diaKey] > 0) {
                                // Descontar 1 hora por d√≠a trabajado (solo una vez por d√≠a)
                                pan.horasPorDia[diaKey] = Math.max(0, pan.horasPorDia[diaKey] - 1);
                            }
                        });
                    }
                    
                    // Calcular promedios
                    if (pan.horasInicio.length > 0) {
                        pan.horaInicioPromedio = pan.horasInicio.reduce((a, b) => a + b, 0) / pan.horasInicio.length;
                    }
                    if (pan.horasFin.length > 0) {
                        pan.horaFinPromedio = pan.horasFin.reduce((a, b) => a + b, 0) / pan.horasFin.length;
                    }
                    
                    // Calcular promedio de duraci√≥n de sesiones
                    if (pan.duracionesSesiones && pan.duracionesSesiones.length > 0) {
                        pan.promedioDuracionSesion = pan.duracionesSesiones.reduce((a, b) => a + b, 0) / pan.duracionesSesiones.length;
                    }
                    
                    // Calcular d√≠as trabajados (d√≠as √∫nicos con turno)
                    pan.diasTrabajados = pan.diasConTurno.size;
                    
                    // Calcular per√≠odos offline de ~1 hora (gaps entre sesiones)
                    pan.periodosOffline1Hora = 0;
                    if (pan.sesionesCompletas && pan.sesionesCompletas.length > 1) {
                        // Ordenar sesiones por fecha de inicio
                        const sesionesOrdenadas = [...pan.sesionesCompletas].sort((a, b) => a.inicio - b.inicio);
                        
                        for (let i = 0; i < sesionesOrdenadas.length - 1; i++) {
                            const sesionActual = sesionesOrdenadas[i];
                            const sesionSiguiente = sesionesOrdenadas[i + 1];
                            
                            // Calcular gap entre fin de sesi√≥n actual e inicio de siguiente
                            const gapHoras = (sesionSiguiente.inicio - sesionActual.fin) / (1000 * 60 * 60);
                            
                            // Si el gap est√° entre 0.8 y 1.2 horas (aproximadamente 1 hora)
                            if (gapHoras >= 0.8 && gapHoras <= 1.2) {
                                pan.periodosOffline1Hora++;
                            }
                        }
                    }
                    
                    // Calcular horas de cobertura (suma de todas las horas trabajadas, considerando solapamientos)
                    pan.horasCobertura = 0;
                    if (pan.sesionesCompletas && pan.sesionesCompletas.length > 0) {
                        // Ordenar sesiones por inicio
                        const sesionesOrdenadas = [...pan.sesionesCompletas].sort((a, b) => a.inicio - b.inicio);
                        
                        // Calcular cobertura total sin solapamientos
                        let coberturaTotal = 0;
                        let ultimoFin = null;
                        
                        sesionesOrdenadas.forEach(sesion => {
                            if (ultimoFin === null || sesion.inicio > ultimoFin) {
                                // No hay solapamiento, agregar toda la duraci√≥n
                                coberturaTotal += sesion.duracion;
                                ultimoFin = sesion.fin;
                            } else if (sesion.fin > ultimoFin) {
                                // Hay solapamiento parcial, agregar solo la parte no solapada
                                const solapamiento = (ultimoFin - sesion.inicio) / (1000 * 60 * 60);
                                const nuevaCobertura = sesion.duracion - solapamiento;
                                if (nuevaCobertura > 0) {
                                    coberturaTotal += nuevaCobertura;
                                }
                                ultimoFin = sesion.fin;
                            }
                            // Si sesion.fin <= ultimoFin, est√° completamente solapada, no agregar nada
                        });
                        
                        pan.horasCobertura = coberturaTotal;
                    }
                    
                    // Calcular promedio de duraci√≥n de sesiones
                    if (pan.duracionesSesiones.length > 0) {
                        pan.promedioDuracionSesion = pan.duracionesSesiones.reduce((a, b) => a + b, 0) / pan.duracionesSesiones.length;
                    }
                    
                    // Calcular d√≠as trabajados (d√≠as √∫nicos con turno)
                    pan.diasTrabajados = pan.diasConTurno.size;
                    
                    // Calcular per√≠odos offline de ~1 hora (gaps entre sesiones)
                    pan.periodosOffline1Hora = 0;
                    if (pan.sesionesCompletas.length > 1) {
                        // Ordenar sesiones por fecha de inicio
                        const sesionesOrdenadas = [...pan.sesionesCompletas].sort((a, b) => a.inicio - b.inicio);
                        
                        for (let i = 0; i < sesionesOrdenadas.length - 1; i++) {
                            const sesionActual = sesionesOrdenadas[i];
                            const sesionSiguiente = sesionesOrdenadas[i + 1];
                            
                            // Calcular gap entre fin de sesi√≥n actual e inicio de siguiente
                            const gapHoras = (sesionSiguiente.inicio - sesionActual.fin) / (1000 * 60 * 60);
                            
                            // Si el gap est√° entre 0.8 y 1.2 horas (aproximadamente 1 hora)
                            if (gapHoras >= 0.8 && gapHoras <= 1.2) {
                                pan.periodosOffline1Hora++;
                            }
                        }
                    }
                    
                    // Calcular horas de cobertura (suma de todas las horas trabajadas, considerando solapamientos)
                    pan.horasCobertura = 0;
                    if (pan.sesionesCompletas.length > 0) {
                        // Ordenar sesiones por inicio
                        const sesionesOrdenadas = [...pan.sesionesCompletas].sort((a, b) => a.inicio - b.inicio);
                        
                        // Calcular cobertura total sin solapamientos
                        let coberturaTotal = 0;
                        let ultimoFin = null;
                        
                        sesionesOrdenadas.forEach(sesion => {
                            if (ultimoFin === null || sesion.inicio > ultimoFin) {
                                // No hay solapamiento, agregar toda la duraci√≥n
                                coberturaTotal += sesion.duracion;
                                ultimoFin = sesion.fin;
                            } else if (sesion.fin > ultimoFin) {
                                // Hay solapamiento parcial, agregar solo la parte no solapada
                                const solapamiento = (ultimoFin - sesion.inicio) / (1000 * 60 * 60);
                                const nuevaCobertura = sesion.duracion - solapamiento;
                                if (nuevaCobertura > 0) {
                                    coberturaTotal += nuevaCobertura;
                                }
                                ultimoFin = sesion.fin;
                            }
                            // Si sesion.fin <= ultimoFin, est√° completamente solapada, no agregar nada
                        });
                        
                        pan.horasCobertura = coberturaTotal;
                    }
                });
                
                // Calcular coincidencia entre gerentes (despu√©s de procesar todos)
                const gerentes = Object.values(horasPorPaniagua).filter(pan => pan.esGerente);
                
                if (gerentes.length > 1) {
                    gerentes.forEach(gerente => {
                        let coincidenciaTotal = 0;
                        
                        gerentes.forEach(otroGerente => {
                            if (gerente.username === otroGerente.username) return;
                            
                            // Calcular horas de solapamiento entre los dos gerentes
                            if (gerente.sesionesCompletas && otroGerente.sesionesCompletas) {
                                gerente.sesionesCompletas.forEach(sesionG => {
                                    otroGerente.sesionesCompletas.forEach(sesionO => {
                                        // Verificar si hay solapamiento
                                        const inicioSolapamiento = sesionG.inicio > sesionO.inicio ? sesionG.inicio : sesionO.inicio;
                                        const finSolapamiento = sesionG.fin < sesionO.fin ? sesionG.fin : sesionO.fin;
                                        
                                        if (inicioSolapamiento < finSolapamiento) {
                                            const horasSolapadas = (finSolapamiento - inicioSolapamiento) / (1000 * 60 * 60);
                                            coincidenciaTotal += horasSolapadas;
                                        }
                                    });
                                });
                            }
                        });
                        
                        gerente.coincidenciaConGerentes = coincidenciaTotal;
                    });
                } else {
                    // Si solo hay un gerente, no hay coincidencia
                    gerentes.forEach(gerente => {
                        gerente.coincidenciaConGerentes = 0;
                    });
                }
                
                // Calcular salarios y ordenar
                rankingPaniagua = Object.values(horasPorPaniagua).map(pan => {
                    const totalHoras = pan.horas + pan.horasActivas;
                    pan.salario = totalHoras * SALARIO_POR_HORA_PANIAGUA;
                    pan.totalHoras = totalHoras;
                    return pan;
                }).sort((a, b) => b.salario - a.salario);
                
                // Calcular y mostrar premios
                calcularYMostrarPremios();
                
                // Mostrar ranking
                mostrarRankingPaniagua();
                
            } catch (error) {
                console.error('Error cargando ranking Paniagua:', error);
                const rankingEl = document.getElementById('rankingPaniagua');
                if (rankingEl) {
                    rankingEl.innerHTML = '<div class="text-center text-danger">Error al cargar el ranking. Intenta recargar la p√°gina.</div>';
                }
            }
        }

        // Mostrar ranking de Paniagua
        function mostrarRankingPaniagua() {
            const rankingEl = document.getElementById('rankingPaniagua');
            if (!rankingEl) return;
            
            if (rankingPaniagua.length === 0) {
                rankingEl.innerHTML = '<div class="text-center text-muted">No hay datos disponibles</div>';
                return;
            }
            
            // Funci√≥n para formatear en miles (compacto)
            const formatearMiles = (valor) => {
                if (valor >= 1000000) {
                    // Millones: mostrar como "1.5M" o "2M"
                    const millones = valor / 1000000;
                    return `‚Ç°${millones % 1 === 0 ? millones.toFixed(0) : millones.toFixed(1)}M`;
                } else if (valor >= 1000) {
                    // Miles: mostrar como "610k" o "1.5k"
                    const miles = valor / 1000;
                    return `‚Ç°${miles % 1 === 0 ? miles.toFixed(0) : miles.toFixed(1)}k`;
                } else {
                    // Menos de 1000: mostrar completo
                    return new Intl.NumberFormat('es-CR', {
                        style: 'currency',
                        currency: 'CRC',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(valor);
                }
            };
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            rankingPaniagua.forEach((pan, index) => {
                const posicion = index + 1;
                const esYo = datosEmpleadoPaniagua && pan.username === datosEmpleadoPaniagua.username;
                const badgePosicion = posicion === 1 ? 'ü•á' : posicion === 2 ? 'ü•à' : posicion === 3 ? 'ü•â' : `${posicion}¬∞`;
                const salarioFormateado = formatearMiles(pan.salario);
                
                html += `
                    <div style="
                        background: ${esYo ? 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)' : '#f8f9fa'};
                        border: ${esYo ? '3px solid #ffc107' : '1px solid #dee2e6'};
                        border-radius: 10px;
                        padding: 12px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        ${esYo ? 'box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); font-weight: bold;' : ''}
                    ">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${badgePosicion}</span>
                            <div>
                                <div style="font-weight: ${esYo ? 'bold' : 'normal'}; color: ${esYo ? '#ff6b35' : '#333'};">
                                    ${pan.nombre} ${esYo ? '<span style="color: #28a745;">(T√ö)</span>' : ''}
                                </div>
                                <small class="text-muted">${pan.totalHoras.toFixed(2)} horas</small>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;">
                                ${salarioFormateado}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            rankingEl.innerHTML = html;
        }

        // Iniciar actualizaci√≥n de salario en tiempo real
        function iniciarActualizacionSalarioPaniagua() {
            if (salarioIntervalPaniagua) {
                clearInterval(salarioIntervalPaniagua);
            }
            
            // Actualizar inmediatamente
            actualizarSalarioPaniagua();
            
            // Actualizar cada 5 segundos (reducido de 1 segundo para optimizar)
            salarioIntervalPaniagua = setInterval(() => {
                actualizarSalarioPaniagua();
            }, 5000);
        }
        
        // Limpiar intervalos al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            if (salarioIntervalPaniagua) {
                clearInterval(salarioIntervalPaniagua);
            }
        });
        
        // Funci√≥n calcularEstadisticasPersonales() eliminada - Los elementos HTML ya no existen
        
        // Calcular y mostrar premios rotativos
        function calcularYMostrarPremios() {
            if (rankingPaniagua.length === 0) return;
            
            const premiosContainer = document.getElementById('premiosContainerPaniagua');
            if (!premiosContainer) return;
            
            // Obtener n√∫mero de semana para rotar premios
            const ahora = new Date();
            const inicioAno = new Date(ahora.getFullYear(), 0, 1);
            const diasTranscurridos = Math.floor((ahora - inicioAno) / (1000 * 60 * 60 * 24));
            const semana = Math.floor(diasTranscurridos / 7);
            
            // Seleccionar 4 premios rotativos (uno por cada Paniagua si hay 4)
            const premiosActivos = [];
            const premiosDisponibles = [...PREMIOS_PANIAGUA];
            
            // Rotar premios seg√∫n la semana
            const indiceInicial = semana % premiosDisponibles.length;
            const premiosRotados = [
                ...premiosDisponibles.slice(indiceInicial),
                ...premiosDisponibles.slice(0, indiceInicial)
            ];
            
            // Calcular ganadores para cada premio
            premiosRotados.forEach((premio, index) => {
                if (index >= 4) return; // Solo 4 premios
                
                const ganador = premio.calcular(rankingPaniagua);
                if (ganador) {
                    premiosActivos.push({
                        ...premio,
                        ganador: ganador
                    });
                }
            });
            
            // Mostrar premios
            if (premiosActivos.length === 0) {
                premiosContainer.innerHTML = '<div class="text-center text-muted">No hay premios disponibles</div>';
                return;
            }
            
            let html = '';
            premiosActivos.forEach(premio => {
                const esYo = datosEmpleadoPaniagua && premio.ganador.username === datosEmpleadoPaniagua.username;
                let valor = '';
                if (premio.id === 'madrugador') {
                    valor = `${premio.ganador.horaInicioPromedio.toFixed(1)}h`;
                } else if (premio.id === 'buho') {
                    valor = `${premio.ganador.horaFinPromedio.toFixed(1)}h`;
                } else if (premio.id === 'guardian') {
                    valor = `${premio.ganador.totalHoras.toFixed(1)}h`;
                } else if (premio.id === 'consistente') {
                    valor = `${premio.ganador.numeroTurnos} turnos`;
                } else if (premio.id === 'eficiente') {
                    valor = `${premio.ganador.periodosOffline1Hora} per√≠odos`;
                } else if (premio.id === 'cobertura') {
                    valor = `${premio.ganador.horasCobertura.toFixed(1)}h`;
                } else if (premio.id === 'solitario') {
                    valor = `${premio.ganador.coincidenciaConGerentes.toFixed(1)}h solapadas`;
                } else if (premio.id === 'resistente') {
                    valor = `${premio.ganador.promedioDuracionSesion.toFixed(1)}h/sesi√≥n`;
                } else if (premio.id === 'disciplinado') {
                    valor = `${premio.ganador.diasTrabajados} d√≠as`;
                } else {
                    valor = 'N/A';
                }
                
                html += `
                    <div style="
                        background: ${esYo ? 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)' : 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'};
                        border: ${esYo ? '3px solid #ffc107' : '2px solid #dee2e6'};
                        border-radius: 12px;
                        padding: 15px;
                        text-align: center;
                        ${esYo ? 'box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);' : ''}
                    ">
                        <div style="font-size: 2rem; margin-bottom: 8px;">
                            ${premio.nombre.split(' ')[0]}
                        </div>
                        <div style="font-weight: bold; color: ${premio.color}; margin-bottom: 5px;">
                            ${premio.nombre.split(' ').slice(1).join(' ')}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                            ${premio.descripcion}
                        </div>
                        <div style="
                            background: ${premio.color};
                            color: white;
                            border-radius: 8px;
                            padding: 8px;
                            font-weight: bold;
                            margin-bottom: 8px;
                        ">
                            ${premio.ganador.nombre} ${esYo ? '<span style="font-size: 0.8rem;">(T√ö)</span>' : ''}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${valor}
                        </div>
                    </div>
                `;
            });
            
            premiosContainer.innerHTML = html;
        }

        // Funci√≥n auxiliar para parsear fechas de forma segura
        function parsearFecha(fecha) {
            if (!fecha) return null;
            try {
                if (fecha.toDate && typeof fecha.toDate === 'function') {
                    return fecha.toDate();
                } else if (fecha instanceof Date) {
                    return fecha;
                } else if (typeof fecha === 'string') {
                    const parsed = new Date(fecha);
                    return isNaN(parsed.getTime()) ? null : parsed;
                } else if (fecha.seconds) {
                    return new Date(fecha.seconds * 1000);
                }
                return null;
            } catch (error) {
                console.warn('Error parseando fecha:', error);
                return null;
            }
        }

        // Funci√≥n helper para verificar si un departamento requiere descuento de 1 hora por d√≠a
        function requiereDescuentoAlmuerzo(departamento) {
            if (!departamento) return false;
            const departamentosConAlmuerzo = [
                'Ventas',
                'Administraci√≥n',
                'Log√≠stica',
                'Recursos Humanos',
                'Contabilidad',
                'Gerencia'
            ];
            return departamentosConAlmuerzo.includes(departamento);
        }

        // Actualizar salario en tiempo real (optimizado con validaci√≥n robusta)
        async function actualizarSalarioPaniagua() {
            if (!esPaniagua || !datosEmpleadoPaniagua) return;
            
            try {
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) return;
                
                // Obtener departamento del empleado
                let departamentoEmpleado = null;
                try {
                    // Buscar empleado por username en lugar de por ID del documento
                    const empleadosQuery = query(
                        collection(db, 'empleados'),
                        where('username', '==', user.id)
                    );
                    const empleadosSnapshot = await getDocs(empleadosQuery);
                    
                    if (!empleadosSnapshot.empty) {
                        const empleadoDoc = empleadosSnapshot.docs[0];
                        departamentoEmpleado = empleadoDoc.data().departamento || null;
                    }
                } catch (error) {
                    console.warn('Error obteniendo departamento del empleado:', error);
                }
                
                const requiereDescuento = requiereDescuentoAlmuerzo(departamentoEmpleado);
                
                const ahora = new Date();
                const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
                inicioMes.setHours(0, 0, 0, 0);
                
                // Calcular horas del mes (completadas + activas)
                let horasMes = 0;
                let horasActivas = 0;
                
                // Buscar sesi√≥n activa
                const userIdForQuery = user.firebaseUID || user.firebaseAuthUID || user.id;
                let q;
                try {
                    if (user.firebaseUID || user.firebaseAuthUID) {
                        q = query(
                            collection(db, 'work_sessions'),
                            where('firebaseAuthUID', '==', userIdForQuery),
                            where('status', '==', 'working')
                        );
                    } else {
                        q = query(
                            collection(db, 'work_sessions'),
                            where('username', '==', user.id),
                            where('status', '==', 'working')
                        );
                    }
                    
                    const activasSnapshot = await getDocs(q);
                    if (!activasSnapshot.empty) {
                        const sessionActiva = activasSnapshot.docs[0].data();
                        const fechaInicio = parsearFecha(sessionActiva.startTime);
                        
                        if (fechaInicio && !isNaN(fechaInicio.getTime()) && fechaInicio >= inicioMes) {
                            const horas = (ahora - fechaInicio) / (1000 * 60 * 60);
                            if (horas > 0 && horas <= 24) {
                                horasActivas = horas;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error buscando sesi√≥n activa:', error);
                }
                
                // Calcular horas completadas del mes y por d√≠a (√∫ltimos 7 d√≠as)
                const horasPorDia = {};
                const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
                
                // Inicializar los √∫ltimos 7 d√≠as
                for (let i = 0; i < 7; i++) {
                    const fecha = new Date(hoy);
                    fecha.setDate(fecha.getDate() - i);
                    const fechaKey = fecha.toISOString().split('T')[0];
                    horasPorDia[fechaKey] = { horas: 0, fecha: fecha };
                }
                
                try {
                    const todasSessionsQuery = query(
                        collection(db, 'work_sessions'),
                        where('username', '==', user.id),
                        where('status', '==', 'completed')
                    );
                    const todasSessionsSnapshot = await getDocs(todasSessionsQuery);
                    
                    todasSessionsSnapshot.forEach(doc => {
                        const session = doc.data();
                        const fechaInicio = parsearFecha(session.startTime);
                        
                        if (!fechaInicio || isNaN(fechaInicio.getTime())) {
                            return;
                        }
                        
                        let horas = 0;
                        
                        if (session.endTime) {
                            const fechaFin = parsearFecha(session.endTime);
                            if (fechaFin && !isNaN(fechaFin.getTime()) && fechaFin > fechaInicio) {
                                horas = (fechaFin - fechaInicio) / (1000 * 60 * 60);
                            }
                        } else if (session.duracion) {
                            horas = parseFloat(session.duracion) || 0;
                        }
                        
                        if (horas > 0 && horas <= 24) {
                            // Sumar al total del mes
                            if (fechaInicio >= inicioMes) {
                                horasMes += horas;
                            }
                            
                            // Sumar al d√≠a correspondiente
                            const fechaDia = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth(), fechaInicio.getDate());
                            const fechaKey = fechaDia.toISOString().split('T')[0];
                            
                            if (horasPorDia[fechaKey]) {
                                horasPorDia[fechaKey].horas += horas;
                            }
                        }
                    });
                } catch (error) {
                    console.warn('Error calculando horas completadas:', error);
                }
                
                // Agregar horas activas al d√≠a de hoy
                if (horasActivas > 0) {
                    const hoyKey = hoy.toISOString().split('T')[0];
                    if (horasPorDia[hoyKey]) {
                        horasPorDia[hoyKey].horas += horasActivas;
                    }
                }
                
                // Aplicar descuento de 1 hora por d√≠a para empleados de departamentos con almuerzo
                if (requiereDescuento) {
                    Object.keys(horasPorDia).forEach(fechaKey => {
                        if (horasPorDia[fechaKey].horas > 0) {
                            // Descontar 1 hora por d√≠a trabajado (solo una vez por d√≠a)
                            const horasAntes = horasPorDia[fechaKey].horas;
                            horasPorDia[fechaKey].horas = Math.max(0, horasPorDia[fechaKey].horas - 1);
                            
                            // Ajustar horasMes si el d√≠a est√° en el mes actual
                            const fechaDia = new Date(horasPorDia[fechaKey].fecha);
                            if (fechaDia >= inicioMes) {
                                horasMes -= (horasAntes - horasPorDia[fechaKey].horas);
                            }
                        }
                    });
                    
                    // Ajustar horasActivas si hay turno activo hoy
                    if (horasActivas > 0) {
                        const hoyKey = hoy.toISOString().split('T')[0];
                        if (horasPorDia[hoyKey] && horasPorDia[hoyKey].horas > 0) {
                            // Ya se descont√≥ en el loop anterior, solo ajustar horasActivas
                            const horasDiaDespues = horasPorDia[hoyKey].horas;
                            const horasDiaAntes = horasDiaDespues + 1; // Revertir el descuento para calcular
                            horasActivas = horasDiaDespues - (horasDiaAntes - horasActivas - 1);
                            horasActivas = Math.max(0, horasActivas);
                        }
                    }
                }
                
                const totalHoras = horasMes + horasActivas;
                const salario = totalHoras * SALARIO_POR_HORA_PANIAGUA;
                
                // Calcular presupuesto
                const gastoAcumulado = salario;
                const saldoDisponible = PRESUPUESTO_MENSUAL_PANIAGUA - gastoAcumulado;
                const porcentajeGastado = (gastoAcumulado / PRESUPUESTO_MENSUAL_PANIAGUA) * 100;
                
                // Formatear en miles de colones (compacto)
                const formatearMiles = (valor) => {
                    if (valor >= 1000000) {
                        // Millones: mostrar como "1.5M" o "2M"
                        const millones = valor / 1000000;
                        return `‚Ç°${millones % 1 === 0 ? millones.toFixed(0) : millones.toFixed(1)}M`;
                    } else if (valor >= 1000) {
                        // Miles: mostrar como "610k" o "1.5k"
                        const miles = valor / 1000;
                        return `‚Ç°${miles % 1 === 0 ? miles.toFixed(0) : miles.toFixed(1)}k`;
                    } else {
                        // Menos de 1000: mostrar completo
                        return new Intl.NumberFormat('es-CR', {
                            style: 'currency',
                            currency: 'CRC',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(valor);
                    }
                };
                
                // Actualizar UI
                const salarioEl = document.getElementById('salarioActualPaniagua');
                const horasEl = document.getElementById('horasActualesPaniagua');
                const desgloseEl = document.getElementById('desgloseSalarioPorDia');
                
                // Actualizar presupuesto
                const presupuestoTotalEl = document.getElementById('presupuestoTotalPaniagua');
                const gastoAcumuladoEl = document.getElementById('gastoAcumuladoPaniagua');
                const saldoDisponibleEl = document.getElementById('saldoDisponiblePaniagua');
                const barraProgresoEl = document.getElementById('barraProgresoPaniagua');
                const progresoTextoEl = document.getElementById('progresoTextoPaniagua');
                
                if (presupuestoTotalEl) {
                    presupuestoTotalEl.textContent = formatearMiles(PRESUPUESTO_MENSUAL_PANIAGUA);
                }
                
                if (gastoAcumuladoEl) {
                    gastoAcumuladoEl.textContent = formatearMiles(gastoAcumulado);
                }
                
                if (saldoDisponibleEl) {
                    saldoDisponibleEl.textContent = `${formatearMiles(Math.max(0, saldoDisponible))} restante`;
                    saldoDisponibleEl.style.color = saldoDisponible < 0 ? '#dc3545' : '#28a745';
                }
                
                if (barraProgresoEl) {
                    const porcentajeProgreso = Math.min(100, Math.max(0, porcentajeGastado));
                    barraProgresoEl.style.width = `${porcentajeProgreso}%`;
                }
                
                if (progresoTextoEl) {
                    progresoTextoEl.textContent = `${porcentajeGastado.toFixed(0)}%`;
                }
                
                if (salarioEl) {
                    const salarioFormateado = formatearMiles(salario);
                    salarioEl.textContent = salarioFormateado;
                }
                
                if (horasEl) {
                    horasEl.textContent = totalHoras.toFixed(1);
                }
                
                // Mostrar desglose por d√≠a
                if (desgloseEl) {
                    const nombresDias = ['Hoy', 'Ayer', 'Anteayer', 'Hace 3 d√≠as', 'Hace 4 d√≠as', 'Hace 5 d√≠as', 'Hace 6 d√≠as'];
                    
                    desgloseEl.innerHTML = Object.keys(horasPorDia)
                        .sort((a, b) => b.localeCompare(a)) // Ordenar de m√°s reciente a m√°s antiguo
                        .slice(0, 7)
                        .map((fechaKey, index) => {
                            const { horas, fecha } = horasPorDia[fechaKey];
                            const salarioDia = horas * SALARIO_POR_HORA_PANIAGUA;
                            const nombreDia = nombresDias[index] || fecha.toLocaleDateString('es-CR', { weekday: 'short', day: 'numeric' });
                            
                            return `
                                <div style="background: ${index === 0 ? '#e8f5e9' : '#f5f5f5'}; border-radius: 8px; padding: 10px; border: ${index === 0 ? '2px solid #4caf50' : '1px solid #ddd'};">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: ${index === 0 ? 'bold' : 'normal'};">${nombreDia}</div>
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #28a745; margin-bottom: 3px;">${formatearMiles(salarioDia)}</div>
                                    <div style="font-size: 0.75rem; color: #999;">${horas.toFixed(1)}h</div>
                                </div>
                            `;
                        }).join('');
                }
                
                // Actualizar ranking tambi√©n (solo si hay cambios significativos para optimizar)
                if (rankingPaniagua.length > 0) {
                    const miIndex = rankingPaniagua.findIndex(p => p.username === user.id);
                    if (miIndex >= 0) {
                        const salarioAnterior = rankingPaniagua[miIndex].salario;
                        rankingPaniagua[miIndex].horas = horasMes;
                        rankingPaniagua[miIndex].horasActivas = horasActivas;
                        rankingPaniagua[miIndex].totalHoras = totalHoras;
                        rankingPaniagua[miIndex].salario = salario;
                        
                        // Solo reordenar y mostrar si hay cambio significativo (m√°s de 1 col√≥n de diferencia)
                        if (Math.abs(salario - salarioAnterior) > 1) {
                            rankingPaniagua.sort((a, b) => b.salario - a.salario);
                            mostrarRankingPaniagua();
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error actualizando salario Paniagua:', error);
                // No mostrar error al usuario para no interrumpir la experiencia
            }
        }

        // Actualizar duraci√≥n del trabajo en tiempo real
        function updateWorkDuration() {
            if (!currentWorkSession || !currentWorkSession.startTime) {
                return;
            }

            const now = new Date();
            let startTime;
            
            // Manejar diferentes tipos de fecha
            if (currentWorkSession.startTime.toDate) {
                // Es un Timestamp de Firebase
                startTime = currentWorkSession.startTime.toDate();
            } else if (currentWorkSession.startTime instanceof Date) {
                // Es un objeto Date
                startTime = currentWorkSession.startTime;
            } else if (typeof currentWorkSession.startTime === 'string') {
                // Es un string de fecha
                startTime = new Date(currentWorkSession.startTime);
            } else if (currentWorkSession.startTime.seconds) {
                // Es un Timestamp con formato {seconds, nanoseconds}
                startTime = new Date(currentWorkSession.startTime.seconds * 1000);
            } else {
                console.error('Formato de fecha no reconocido:', currentWorkSession.startTime);
                return;
            }

            const durationMs = now - startTime;
            const durationMinutes = durationMs / (1000 * 60);
            
            // Actualizar el elemento de duraci√≥n si existe
            const durationElement = document.getElementById('currentDuration');
            if (durationElement) {
                durationElement.textContent = formatDuration(durationMinutes);
            }

            // Actualizar el tiempo transcurrido en el estado del trabajo
            const workStatusElement = document.querySelector('.work-status');
            if (workStatusElement) {
                const hours = Math.floor(durationMinutes / 60);
                const minutes = Math.floor(durationMinutes % 60);
                const seconds = Math.floor((durationMinutes % 1) * 60);
                
                workStatusElement.innerHTML = `
                    <div class="work-status-content">
                        <div class="work-status-text">üü¢ App Prendida</div>
                        <div class="work-duration">${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</div>
                    </div>
                `;
            }
            
            // Si es Paniagua, el intervalo ya se encarga de actualizar el salario
            // No llamar aqu√≠ para evitar consultas duplicadas
        }

        // Funci√≥n para limpiar sesiones duplicadas
        async function cleanupDuplicateSessions() {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) {
                    console.error('‚ùå [CLEANUP] Usuario no disponible:', { user });
                    return;
                }

                // Usar firebaseAuthUID para consultas (m√°s confiable con reglas)
                const userIdForQuery = user.firebaseUID || user.firebaseAuthUID || user.id;
                
                if (!window.firebaseAuth?.currentUser) {
                    return;
                }
                
                // Intentar primero con firebaseAuthUID (m√°s confiable)
                let q;
                if (user.firebaseUID || user.firebaseAuthUID) {
                    q = query(
                        collection(db, 'work_sessions'),
                        where('firebaseAuthUID', '==', userIdForQuery),
                        where('status', '==', 'working')
                    );
                } else {
                    // Fallback a username si no hay firebaseAuthUID
                    q = query(
                        collection(db, 'work_sessions'),
                        where('username', '==', user.id),
                        where('status', '==', 'working')
                    );
                }
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.docs.length > 1) {
                    console.warn(`‚ö†Ô∏è Encontradas ${querySnapshot.docs.length} sesiones activas, limpiando duplicadas...`);
                    
                    // Ordenar por fecha de inicio (mantener la m√°s reciente)
                    const sessions = querySnapshot.docs.sort((a, b) => {
                        const dateA = a.data().startTime?.toDate ? a.data().startTime.toDate() : new Date(a.data().startTime);
                        const dateB = b.data().startTime?.toDate ? b.data().startTime.toDate() : new Date(b.data().startTime);
                        return dateB - dateA; // M√°s reciente primero
                    });
                    
                    // Cerrar todas excepto la m√°s reciente
                    const sessionsToClose = sessions.slice(1);
                    for (const sessionDoc of sessionsToClose) {
                        const sessionData = sessionDoc.data();
                        const endTime = new Date();
                        const endTimestamp = Timestamp.fromDate(endTime);
                        
                        console.log(`üîí Cerrando sesi√≥n duplicada: ${sessionDoc.id}`);
                        await updateDoc(sessionDoc.ref, {
                            endTime: endTimestamp,
                            status: 'completed',
                            notes: (sessionData.notes || '') + ' [Sesi√≥n cerrada autom√°ticamente por duplicaci√≥n]'
                        });
                    }
                    
                    console.log(`‚úÖ ${sessionsToClose.length} sesiones duplicadas cerradas`);
                }
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('Error limpiando sesiones duplicadas', error);
                } else {
                    console.error('‚ùå [CLEANUP] Error limpiando sesiones duplicadas');
                }
            }
        }

        // Verificar si hay una sesi√≥n abierta
        async function checkOpenSession() {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) {
                    console.error('‚ùå [CHECK_SESSION] Usuario no autenticado o sin ID:', { user });
                    return;
                }

                // Usar firebaseAuthUID para consultas (m√°s confiable con reglas)
                const userIdForQuery = user.firebaseUID || user.firebaseAuthUID || user.id;
                
                // Intentar primero con firebaseAuthUID (m√°s confiable)
                let q;
                if (user.firebaseUID || user.firebaseAuthUID) {
                    q = query(
                        collection(db, 'work_sessions'),
                        where('firebaseAuthUID', '==', userIdForQuery),
                        where('status', '==', 'working')
                    );
                } else {
                    // Fallback a username si no hay firebaseAuthUID
                    q = query(
                        collection(db, 'work_sessions'),
                        where('username', '==', user.id),
                        where('status', '==', 'working')
                    );
                }
                
                console.log('‚è≥ [CHECK_SESSION] Ejecutando consulta...');
                const querySnapshot = await getDocs(q);
                console.log('‚úÖ [CHECK_SESSION] Consulta exitosa, documentos encontrados:', querySnapshot.size);

                if (!querySnapshot.empty) {
                    const sessions = querySnapshot.docs;
                    console.log(`‚ö†Ô∏è Encontradas ${sessions.length} sesiones activas para ${user.id}`);
                    
                    if (sessions.length > 1) {
                        console.error('‚ùå M√öLTIPLES SESIONES ACTIVAS DETECTADAS:', sessions.length);
                        // Mostrar error y no permitir continuar hasta resolver
                        if (workStatusEl) workStatusEl.textContent = '‚ö†Ô∏è M√∫ltiples sesiones activas';
                        if (workStatusEl) workStatusEl.style.color = '#d32f2f';
                        if (employeeNameEl) employeeNameEl.textContent = 'Error: Contactar administrador';
                        updateButtonState(false);
                        showButtonError(btnStartWork, 'Error: M√∫ltiples sesiones activas. Contacta al administrador.');
                        return;
                    }
                    
                    const sessionDoc = sessions[0];
                    const sessionData = sessionDoc.data();
                    
                    // Restaurar sesi√≥n actual
                    currentWorkSession = {
                        id: sessionDoc.id,
                        username: sessionData.username,
                        startTime: sessionData.startTime.toDate(),
                        endTime: null,
                        status: 'working'
                    };

                    // Actualizar UI para mostrar sesi√≥n activa
                    if (workStatusEl) {
                        workStatusEl.className = 'status-indicator online';
                        const statusText = workStatusEl.querySelector('.status-text');
                        if (statusText) statusText.textContent = 'App Encendida';
                    }
                    if (employeeNameEl) employeeNameEl.textContent = sessionData.employeeName;
                    
                    // Actualizar botones
                    updateButtonState(true);

                    if (window.safeLogger) {
                        window.safeLogger.success('‚úÖ Sesi√≥n abierta encontrada y restaurada');
                    } else {
                        console.log('‚úÖ Sesi√≥n abierta encontrada y restaurada');
                    }
                } else {
                    console.log('‚ÑπÔ∏è No hay sesiones abiertas');
                }

            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå [CHECK_SESSION] Error verificando sesi√≥n abierta', error);
                } else {
                    console.error('‚ùå [CHECK_SESSION] Error verificando sesi√≥n abierta');
                }
            }
        }

        // ===== FUNCIONES DE FORMATEO DE TIEMPO =====
        
        // Convertir timestamp a hora 12h (am/pm) - ya est√° en hora local
        function formatTime12h(timestamp) {
            if (!timestamp) return '--:--';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            // Los timestamps de Firebase ya est√°n ajustados para representar hora local de Costa Rica
            // No necesitamos ajustar, usar directamente
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Calcular duraci√≥n en horas desde timestamps
        function calculateDurationHours(startTime, endTime) {
            try {
            if (!startTime || !endTime) return 0;
            
            const start = startTime.toDate ? startTime.toDate() : new Date(startTime);
            const end = endTime.toDate ? endTime.toDate() : new Date(endTime);
                
                // Validar que las fechas sean v√°lidas
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    console.error('‚ùå Fechas inv√°lidas en calculateDurationHours:', { startTime, endTime });
                    return 0;
                }
            
            const diffMs = end - start;
                
                // Validar que la diferencia sea positiva
                if (diffMs < 0) {
                    console.warn('‚ö†Ô∏è Duraci√≥n negativa detectada:', { start, end, diffMs });
                    return 0;
                }
                
            const hours = diffMs / (1000 * 60 * 60); // Convertir de ms a horas
                return Math.max(0, hours); // Asegurar que no sea negativo
                
            } catch (error) {
                console.error('‚ùå Error calculando duraci√≥n:', error);
                return 0;
            }
        }

        // Formatear duraci√≥n en horas con 2 decimales
        function formatHoursDecimal(startTime, endTime) {
            const hours = calculateDurationHours(startTime, endTime);
            return hours.toFixed(2);
        }

        // Funci√≥n unificada para calcular tipo de jornada
        function getJornadaType(startTime) {
            if (!startTime || isNaN(startTime.getTime())) {
                return 'Diurna'; // Valor por defecto si la fecha es inv√°lida
            }
            
            const hour = startTime.getHours();
            
            // L√≥gica corregida:
            // Diurna: 05:00 - 11:59
            // Mixta: 12:00 - 18:59
            // Nocturna: 19:00 - 04:59
            if (hour >= 5 && hour < 12) {
                return 'Diurna';
            } else if (hour >= 12 && hour < 19) {
                return 'Mixta';
            } else {
                return 'Nocturna';
            }
        }

        // Obtener nombre de jornada seg√∫n la l√≥gica O (inicio) y P (cierre) - para an√°lisis de d√≠as
        function getJornadaName(dayData) {
            const O = dayData.minHour; // Hora de inicio m√≠nima del d√≠a
            const P = dayData.maxHour; // Hora de cierre m√°xima del d√≠a
            
            // Validar datos
            if (O === undefined || P === undefined || O < 0 || O > 23 || P < 0 || P > 23) {
                return 'Error en l√≥gica';
            }
            
            // Si la hora de O < 12 ‚Üí Diurna
            if (O < 12) {
                return 'Diurna';
            }
            
            // Si O >= 12 y O < 19 y (P >= 19 o P < 5) ‚Üí Mixta
            if (O >= 12 && O < 19 && (P >= 19 || P < 5)) {
                return 'Mixta';
            }
            
            // Si (O >= 19 o O < 5 o P < 5) ‚Üí Nocturna
            if (O >= 19 || O < 5 || P < 5) {
                return 'Nocturna';
            }
            
            // Si O >= 5 y O < 19 y P >= 5 y P < 19 ‚Üí Diurna
            if (O >= 5 && O < 19 && P >= 5 && P < 19) {
                return 'Diurna';
            }
            
            // En cualquier otro caso ‚Üí Error en l√≥gica
            return 'Error en l√≥gica';
        }

        // Obtener la fecha del d√≠a de inicio (maneja turnos que cruzan medianoche)
        function getStartDay(timestamp) {
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            // Los timestamps de Firebase ya est√°n ajustados para representar hora local de Costa Rica
            // No necesitamos ajustar, usar directamente
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Formatear fecha para mostrar
        function formatDateDisplay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ===== FUNCIONES DE AGRUPACI√ìN Y RENDERIZADO =====

        // Cargar historial de trabajo con nueva estructura
        async function loadWorkHistory() {
            try {
                const user = window.authManager.getCurrentUser();
                if (!user || !user.id) {
                    console.error('‚ùå [LOAD_HISTORY] Usuario no autenticado o sin ID:', { user });
                    return;
                }

                // Usar firebaseAuthUID para consultas (m√°s confiable con reglas)
                const userIdForQuery = user.firebaseUID || user.firebaseAuthUID || user.id;
                const usernameForQuery = user.id || user.username;
                
                // Hacer ambas consultas para incluir turnos manuales (que solo tienen username)
                // y turnos autom√°ticos (que tienen firebaseAuthUID)
                const queries = [];
                
                // Consulta por firebaseAuthUID (turnos autom√°ticos)
                if (user.firebaseUID || user.firebaseAuthUID) {
                    queries.push(
                        query(
                            collection(db, 'work_sessions'),
                            where('firebaseAuthUID', '==', userIdForQuery)
                        )
                    );
                }
                
                // Consulta por username (incluye turnos manuales)
                queries.push(
                    query(
                        collection(db, 'work_sessions'),
                        where('username', '==', usernameForQuery)
                    )
                );
                
                // Ejecutar ambas consultas en paralelo
                const querySnapshots = await Promise.all(queries.map(q => getDocs(q)));
                
                // Combinar resultados y eliminar duplicados
                const allDocs = new Map();
                querySnapshots.forEach(snapshot => {
                    snapshot.forEach(doc => {
                        if (!allDocs.has(doc.id)) {
                            allDocs.set(doc.id, doc);
                        }
                    });
                });
                
                // Crear un QuerySnapshot simulado con los documentos √∫nicos
                const querySnapshot = {
                    empty: allDocs.size === 0,
                    docs: Array.from(allDocs.values()),
                    forEach: function(callback) {
                        this.docs.forEach(callback);
                    }
                };

                if (querySnapshot.empty) {
                    workHistoryEl.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No hay registros de trabajo</p>
                        </div>
                    `;
                    return;
                }

                const history = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data
                    };
                });

                // Filtrar sesiones activas (solo completadas para c√°lculos)
                const completedHistory = history.filter(session => session.status === 'completed');
                // Sesiones procesadas (sin log)

                // Filtrar por mes seleccionado
                const selectedMonth = document.getElementById('monthFilter').value;
                const filteredHistory = filterByMonth(completedHistory, selectedMonth);

                // Agrupar por semana
                const groupedByWeek = await groupSessionsByWeek(filteredHistory);
                
                // Calcular y renderizar resumen mensual
                const monthlySummary = calculateMonthlySummary(groupedByWeek);
                renderMonthlySummary(monthlySummary);
                
                // Renderizar mini-cards por semana
                renderWeeklyCards(groupedByWeek);

                // Historial renderizado correctamente (sin log)

            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('Error cargando historial', error);
                } else {
                    console.error('‚ùå [LOAD_HISTORY] Error cargando historial');
                }
                
                workHistoryEl.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error cargando historial: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Agrupar sesiones por d√≠a
        // Filtrar sesiones por mes
        function filterByMonth(sessions, monthYear) {
            if (!monthYear) return sessions;
            
            const [year, month] = monthYear.split('-');
            const targetYear = parseInt(year);
            const targetMonth = parseInt(month);
            
            return sessions.filter(session => {
                try {
                    const startTime = session.startTime ? session.startTime.toDate() : new Date(session.startTime);
                    return startTime.getFullYear() === targetYear && startTime.getMonth() === targetMonth - 1;
                } catch (error) {
                    console.error('Error filtrando sesi√≥n por mes:', error);
                    return false;
                }
            });
        }

        // Agrupar sesiones por semana (lunes a domingo)
        async function groupSessionsByWeek(sessions) {
            const grouped = {};
            
            sessions.forEach(session => {
                try {
                    const startTime = session.startTime ? session.startTime.toDate() : new Date(session.startTime);
                    const weekKey = getWeekKey(startTime);
                    
                    if (!grouped[weekKey]) {
                        const weekInfo = getWeekInfo(startTime);
                        grouped[weekKey] = {
                            weekKey: weekInfo.weekKey,
                            weekInfo: weekInfo,
                            sessions: [],
                            totalHours: 0,
                            days: {},
                            jornadaHours: 0,
                            overtimeHours: 0,
                            overtimeType: 'normal' // 'normal', 'extra', 'deuda'
                        };
                    }
                    
                    // Agregar sesi√≥n a la semana
                    grouped[weekKey].sessions.push(session);
                    
                    // Calcular duraci√≥n de la sesi√≥n
                    const endTime = session.endTime ? session.endTime.toDate() : new Date(session.endTime);
                    const durationHours = (endTime - startTime) / (1000 * 60 * 60);
                    grouped[weekKey].totalHours += durationHours;
                    
                    // Agrupar tambi√©n por d√≠a dentro de la semana
                    const dayKey = getStartDay(session.startTime);
                    if (!grouped[weekKey].days[dayKey]) {
                        grouped[weekKey].days[dayKey] = {
                            date: dayKey,
                            sessions: [],
                            totalHours: 0,
                            minHour: 24,
                            maxHour: -1,
                            jornadaType: 'Diurna' // Se calcular√° despu√©s
                        };
                    }
                    
                    grouped[weekKey].days[dayKey].sessions.push(session);
                    grouped[weekKey].days[dayKey].totalHours += durationHours;
                    
                    // Calcular hora m√≠nima y m√°xima del d√≠a
                    const startHour = startTime.getHours();
                    const endHour = endTime.getHours();
                    grouped[weekKey].days[dayKey].minHour = Math.min(grouped[weekKey].days[dayKey].minHour, startHour);
                    grouped[weekKey].days[dayKey].maxHour = Math.max(grouped[weekKey].days[dayKey].maxHour, endHour);
                    
                } catch (error) {
                    console.error('Error procesando sesi√≥n:', error, session);
                }
            });
            
            // Aplicar descuento de 1 hora por d√≠a para empleados de departamentos con almuerzo
            // Esto se hace despu√©s de agrupar todas las sesiones por d√≠a
            // Obtener departamento del usuario actual
            let requiereDescuento = false;
            let departamentoEmpleado = null;
            try {
                const user = window.authManager.getCurrentUser();
                if (user && user.id) {
                    // Buscar empleado por username en lugar de por ID del documento
                    const empleadosQuery = query(
                        collection(db, 'empleados'),
                        where('username', '==', user.id)
                    );
                    const empleadosSnapshot = await getDocs(empleadosQuery);
                    
                    if (!empleadosSnapshot.empty) {
                        const empleadoDoc = empleadosSnapshot.docs[0];
                        const empleadoData = empleadoDoc.data();
                        departamentoEmpleado = empleadoData.departamento || null;
                        requiereDescuento = requiereDescuentoAlmuerzo(departamentoEmpleado);
                        console.log('üçΩÔ∏è [DESCUENTO] Verificaci√≥n:', {
                            userId: user.id,
                            departamento: departamentoEmpleado,
                            requiereDescuento: requiereDescuento
                        });
                    } else {
                        console.warn('üçΩÔ∏è [DESCUENTO] No se encontr√≥ documento de empleado para username:', user.id);
                    }
                } else {
                    console.warn('üçΩÔ∏è [DESCUENTO] No hay usuario autenticado');
                }
            } catch (error) {
                console.error('üçΩÔ∏è [DESCUENTO] Error obteniendo departamento del empleado:', error);
            }
            
            // Aplicar descuento si es necesario
            if (requiereDescuento) {
                console.log('üçΩÔ∏è [DESCUENTO] Aplicando descuento de almuerzo para departamento:', departamentoEmpleado);
                Object.keys(grouped).forEach(weekKey => {
                    const weekData = grouped[weekKey];
                    const horasAntesSemana = weekData.totalHours;
                    let totalDescuentoSemana = 0;
                    let diasConDescuento = 0;
                    
                    // Aplicar descuento por d√≠a
                    Object.keys(weekData.days).forEach(dayKey => {
                        const dayData = weekData.days[dayKey];
                        if (dayData.totalHours > 0) {
                            // Descontar 1 hora por d√≠a trabajado (solo una vez por d√≠a)
                            const horasAntesDia = dayData.totalHours;
                            dayData.totalHours = Math.max(0, dayData.totalHours - 1);
                            const descuentoDia = horasAntesDia - dayData.totalHours;
                            if (descuentoDia > 0) {
                                totalDescuentoSemana += descuentoDia;
                                diasConDescuento++;
                                console.log(`üçΩÔ∏è [DESCUENTO] D√≠a ${dayKey}: ${horasAntesDia.toFixed(2)}h ‚Üí ${dayData.totalHours.toFixed(2)}h (descuento: ${descuentoDia.toFixed(2)}h)`);
                            }
                        }
                    });
                    
                    // Ajustar totalHours de la semana con el descuento total
                    weekData.totalHours = Math.max(0, weekData.totalHours - totalDescuentoSemana);
                    
                    if (totalDescuentoSemana > 0) {
                        console.log(`üçΩÔ∏è [DESCUENTO] Semana ${weekKey}: ${diasConDescuento} d√≠as, ${horasAntesSemana.toFixed(1)}h ‚Üí ${weekData.totalHours.toFixed(1)}h (descuento: ${totalDescuentoSemana.toFixed(1)}h)`);
                    }
                });
            } else {
                console.log('üçΩÔ∏è [DESCUENTO] No se aplica descuento. Departamento:', departamentoEmpleado);
            }
            
            // Calcular jornada y horas extra/pendientes para cada semana
            Object.keys(grouped).forEach(weekKey => {
                const weekData = grouped[weekKey];
                calculateWeekOvertime(weekData);
            });
            
            return grouped;
        }

        // Obtener informaci√≥n completa de la semana (lunes a domingo)
        function getWeekInfo(date) {
            // Obtener componentes de fecha local
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            const dayOfWeek = date.getDay();
            
            // Calcular d√≠as hasta el lunes
            // Lunes = 1, Domingo = 0
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            
            // Crear fecha del lunes usando componentes locales
            const monday = new Date(year, month, day + daysToMonday);
            const sunday = new Date(year, month, day + daysToMonday + 6);
            
            // Formatear fechas como YYYY-MM-DD
            const formatDate = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            
            const weekKey = formatDate(monday);
            const mondayStr = formatDate(monday);
            const sundayStr = formatDate(sunday);
            
            // Calcular semana (sin log)
            
            return {
                weekKey: weekKey,
                monday: mondayStr,
                sunday: sundayStr,
                month: monday.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })
            };
        }

        // Obtener clave de semana (lunes a domingo) - funci√≥n de conveniencia
        function getWeekKey(date) {
            return getWeekInfo(date).weekKey;
        }

        // Calcular horas extra/pendientes para una semana
        function calculateWeekOvertime(weekData) {
            // Obtener tipo de contrato del usuario
            const user = window.authManager.getCurrentUser();
            const tipoContrato = user?.tipoContrato || 'Mensual';
            
            // Calcular horas extra de la semana (sin log de debug)
            
            let diurnos = 0;
            let mixtos = 0;
            let nocturnos = 0;
            
            // Contar d√≠as por tipo de jornada
            Object.keys(weekData.days).forEach(dayKey => {
                const dayData = weekData.days[dayKey];
                
                // Calcular tipo de jornada del d√≠a basado en la hora de inicio
                const startTime = dayData.sessions[0]?.startTime;
                const jornadaType = startTime ? getJornadaType(startTime.toDate ? startTime.toDate() : new Date(startTime)) : 'Diurna';
                dayData.jornadaType = jornadaType;
                // Calcular tipo de jornada (sin log)
                
                // Contar d√≠as por tipo
                if (jornadaType === 'Diurna') {
                    diurnos++;
                } else if (jornadaType === 'Mixta') {
                    mixtos++;
                } else if (jornadaType === 'Nocturna') {
                    nocturnos++;
                }
            });
            
            // Calcular horas de jornada esperadas
            // Diurna: 8h, Mixta: 7h, Nocturna: 6h
            const expectedHours = (diurnos * 8) + (mixtos * 7) + (nocturnos * 6);
            weekData.jornadaHours = expectedHours;
            
            if (tipoContrato === 'Por horas') {
                console.log('üîç Ejecutando l√≥gica PARA HORAS');
                // L√ìGICA PARA EMPLEADOS "POR HORAS"
                // Solo se calculan horas extra diarias, sin neteo semanal
                let totalExtraHours = 0;
                
                Object.keys(weekData.days).forEach(dayKey => {
                    const dayData = weekData.days[dayKey];
                    const jornadaType = dayData.jornadaType;
                    
                    let jornadaHours = 0;
                    switch(jornadaType) {
                        case 'Diurna':
                            jornadaHours = 8;
                            break;
                        case 'Mixta':
                            jornadaHours = 7;
                            break;
                        case 'Nocturna':
                            jornadaHours = 6;
                            break;
                    }
                    
                    const dayHours = dayData.totalHours;
                    console.log(`üîç D√≠a ${dayKey}: ${dayHours}h trabajadas, ${jornadaHours}h jornada (${jornadaType})`);
                    
                    if (dayHours > jornadaHours) {
                        const extraDelDia = dayHours - jornadaHours;
                        totalExtraHours += extraDelDia;
                        console.log(`üîç D√≠a ${dayKey}: +${extraDelDia}h extra`);
                    } else {
                        console.log(`üîç D√≠a ${dayKey}: Sin horas extra`);
                    }
                    // Para empleados por horas, no se calculan horas pendientes
                });
                
                weekData.overtimeHours = totalExtraHours;
                weekData.debtHours = 0; // No existen horas pendientes para empleados por horas
                weekData.overtimeType = totalExtraHours > 0 ? 'extra' : 'normal';
                
                console.log(`üîç Semana ${weekData.weekKey} (Por horas) - RESULTADO:`, {
                    diurnos,
                    mixtos,
                    nocturnos,
                    expectedHours,
                    totalHours: weekData.totalHours,
                    overtimeHours: weekData.overtimeHours,
                    overtimeType: weekData.overtimeType,
                    totalExtraHours: totalExtraHours
                });
                
            } else {
                // Ejecutando l√≥gica MENSUAL (sin log)
                // L√ìGICA PARA EMPLEADOS "MENSUAL" (actual)
                // Calcular diferencia semanal con neteo
            const difference = weekData.totalHours - expectedHours;
            weekData.overtimeHours = Math.abs(difference);
            
            // Determinar tipo
            if (difference > 0) {
                weekData.overtimeType = 'extra';
            } else if (difference < 0) {
                weekData.overtimeType = 'deuda';
            } else {
                weekData.overtimeType = 'normal';
            }
            
                // Resultado calculado (sin log de debug)
            }
        }

        // Renderizar mini-cards por d√≠a
        function renderWeeklyCards(groupedSessions) {
            const weeks = Object.keys(groupedSessions).sort().reverse(); // M√°s recientes primero
            // Renderizando semanas (sin log)
            
            workHistoryEl.innerHTML = weeks.map(weekKey => {
                const weekData = groupedSessions[weekKey];
                const weekId = `week-${weekKey.replace(/-/g, '')}`;
                const days = Object.keys(weekData.days).sort().reverse();
                
                // Procesando semana (sin log)
                
                return `
                    <div class="weekly-card" data-week="${weekKey}">
                        <div class="weekly-header" onclick="toggleWeek('${weekId}')">
                            <div class="weekly-info">
                                <div class="weekly-dates">
                                    <i class="fas fa-calendar-week"></i>
                                    <span>${formatWeekDisplay(weekData.weekInfo)}</span>
                                </div>
                                <div class="weekly-summary">
                                    ${days.length} d√≠as trabajados
                                </div>
                            </div>
                            <div class="weekly-total">
                                <div class="hours-calculation">
                                    <div class="calculation-row">
                                        <span class="calculation-label">Horas Laboradas:</span>
                                        <span class="calculation-value">${weekData.totalHours.toFixed(1)}h</span>
                                    </div>
                                    <div class="calculation-row">
                                        <span class="calculation-label">Horas Jornada:</span>
                                        <span class="calculation-value">${weekData.jornadaHours.toFixed(1)}h</span>
                                    </div>
                                    <div class="calculation-row calculation-result">
                                        <span class="calculation-label">Resultado:</span>
                                        ${getOvertimeDisplay(weekData)}
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down icon-expand-pulse" style="font-size: 1.8rem; color: #000000; opacity: 0.7;"></i>
                            </div>
                        </div>
                        <div class="weekly-days" id="${weekId}" style="display: none;">
                            ${days.map(dayKey => {
                                const dayData = weekData.days[dayKey];
                                const jornadaName = dayData.jornadaType || 'Diurna';
                                const dayId = `day-${dayKey.replace(/-/g, '')}`;
                                
                                // Procesando d√≠a (sin log)
                                
                                return `
                                    <div class="daily-card" data-day="${dayKey}">
                                        <div class="daily-header" onclick="toggleDay('${dayId}')">
                                            <div class="daily-info">
                                                <div class="daily-date">
                                                    <i class="fas fa-calendar-day"></i>
                                                    <span>${formatDateDisplay(dayKey)} ${getJornadaEmoji(jornadaName)} (${jornadaName})</span>
                                                </div>
                                            </div>
                                            <div class="daily-total">
                                                <div class="daily-calculation">
                                                    <div class="calculation-row">
                                                        <span class="calculation-label">Horas Laboradas:</span>
                                                        <span class="calculation-value">${dayData.totalHours.toFixed(1)}h</span>
                                                    </div>
                                                </div>
                                                <i class="fas fa-chevron-down icon-expand-pulse" style="font-size: 1.8rem; color: #000000; opacity: 0.7;"></i>
                                            </div>
                                        </div>
                                        <div class="daily-sessions" id="${dayId}" style="display: none;">
                                            ${renderDaySessions(dayData.sessions)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // HTML generado (sin log)
        }

        // Renderizar sesiones de un d√≠a espec√≠fico
        function renderDaySessions(sessions) {
            if (!sessions || sessions.length === 0) {
                return '<div class="no-sessions">No hay turnos registrados</div>';
            }
            
            // Ordenar sesiones por fecha de inicio (cronol√≥gico ascendente)
            const sortedSessions = sessions.sort((a, b) => {
                const startTimeA = a.startTime ? a.startTime.toDate() : new Date(0);
                const startTimeB = b.startTime ? b.startTime.toDate() : new Date(0);
                return startTimeA - startTimeB;
            });
            
            return sortedSessions.map(session => {
                const startTime = session.startTime ? session.startTime.toDate() : new Date();
                const endTime = session.endTime ? session.endTime.toDate() : null;
                
                return `
                    <div class="session-item">
                        <div class="session-times-horizontal">
                            <span class="session-start-time">${formatTime12h(session.startTime)}</span>
                            <span class="session-separator">‚Üí</span>
                            <span class="session-end-time">${endTime ? formatTime12h(session.endTime) : 'En curso'}</span>
                        </div>
                        <div class="session-duration-horizontal">
                            <i class="fas fa-clock"></i>
                            <span>${formatHoursDecimal(session.startTime, session.endTime)}h</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle para expandir/colapsar d√≠as
        function toggleDay(dayId) {
            console.log('Toggle day:', dayId);
            const sessionsDiv = document.getElementById(dayId);
            
            if (!sessionsDiv) {
                console.error('No se encontr√≥ el elemento:', dayId);
                return;
            }
            
            const isHidden = sessionsDiv.style.display === 'none' || sessionsDiv.style.display === '';
            
            if (isHidden) {
                sessionsDiv.style.display = 'block';
                console.log('Expandiendo d√≠a:', dayId);
            } else {
                sessionsDiv.style.display = 'none';
                console.log('Colapsando d√≠a:', dayId);
            }
        }


        // Toggle para expandir/contraer semana
        function toggleWeek(weekId) {
            console.log('Toggle week:', weekId);
            const weekElement = document.getElementById(weekId);
            
            if (!weekElement) {
                console.error('No se encontr√≥ el elemento de semana:', weekId);
                return;
            }
            
            const isHidden = weekElement.style.display === 'none' || weekElement.style.display === '';
            
            if (isHidden) {
                weekElement.style.display = 'block';
                console.log('Expandiendo semana:', weekId);
            } else {
                weekElement.style.display = 'none';
                console.log('Colapsando semana:', weekId);
            }
        }

        // Formatear display de semana
        function formatWeekDisplay(weekInfo) {
            // Parsear fechas desde strings YYYY-MM-DD
            const [mondayYear, mondayMonth, mondayDay] = weekInfo.monday.split('-').map(Number);
            const [sundayYear, sundayMonth, sundayDay] = weekInfo.sunday.split('-').map(Number);
            
            const monday = new Date(mondayYear, mondayMonth - 1, mondayDay);
            const sunday = new Date(sundayYear, sundayMonth - 1, sundayDay);
            
            // Verificar si es el mismo mes
            const isSameMonth = monday.getMonth() === sunday.getMonth() && monday.getFullYear() === sunday.getFullYear();
            
            if (isSameMonth) {
                // Mismo mes: "29 sept - 5 oct 2025"
                const monthName = monday.toLocaleDateString('es-ES', { month: 'short' });
                const year = monday.getFullYear();
                const mondayDay = monday.getDate();
                const sundayDay = sunday.getDate();
                
                return `${mondayDay} ${monthName} - ${sundayDay} ${monthName} ${year}`;
            } else {
                // Diferentes meses: "29 sept - 5 oct 2025"
                const mondayMonthName = monday.toLocaleDateString('es-ES', { month: 'short' });
                const sundayMonthName = sunday.toLocaleDateString('es-ES', { month: 'short' });
                const year = monday.getFullYear();
                const mondayDay = monday.getDate();
                const sundayDay = sunday.getDate();
                
                return `${mondayDay} ${mondayMonthName} - ${sundayDay} ${sundayMonthName} ${year}`;
            }
        }

        // Generar display de horas extra/pendientes
        function getOvertimeDisplay(weekData) {
            // Obtener tipo de contrato del usuario
            const user = window.authManager.getCurrentUser();
            const tipoContrato = user?.tipoContrato || 'Mensual';
            
            if (weekData.overtimeType === 'normal') {
                return `<span class="calculation-value overtime-normal">‚úì Normal</span>`;
            } else if (weekData.overtimeType === 'extra') {
                if (tipoContrato === 'Por horas') {
                    return `<span class="calculation-value overtime-extra">+${weekData.overtimeHours.toFixed(1)}h extra</span>`;
                } else {
                    return `<span class="calculation-value overtime-extra">+${weekData.overtimeHours.toFixed(1)}h extra</span>`;
                }
            } else if (weekData.overtimeType === 'deuda') {
                if (tipoContrato === 'Por horas') {
                    // Para empleados por horas, no hay horas pendientes
                    return `<span class="calculation-value overtime-normal">‚úì Normal</span>`;
                } else {
                    return `<span class="calculation-value overtime-deuda">-${weekData.overtimeHours.toFixed(1)}h pendientes</span>`;
                }
            }
            return '';
        }

        // Obtener horas esperadas seg√∫n tipo de jornada
        function getJornadaHours(jornadaName) {
            switch(jornadaName) {
                case 'Diurna':
                    return '8.00';
                case 'Mixta':
                    return '7.00';
                case 'Nocturna':
                    return '6.00';
                default:
                    return '0.00';
            }
        }

        function getJornadaEmoji(jornadaName) {
            switch(jornadaName) {
                case 'Diurna':
                    return '‚òÄÔ∏è';
                case 'Mixta':
                    return 'üåÖ';
                case 'Nocturna':
                    return 'üåô';
                default:
                    return '‚è∞';
            }
        }

        // Calcular resumen mensual
        function calculateMonthlySummary(groupedSessions) {
            // Obtener tipo de contrato del usuario
            const user = window.authManager.getCurrentUser();
            const tipoContrato = user?.tipoContrato || 'Mensual';
            
            let totalHoursWorked = 0;
            let totalHoursExpected = 0;
            let totalOvertimeHours = 0;
            let totalDebtHours = 0;

            Object.values(groupedSessions).forEach(weekData => {
                totalHoursWorked += weekData.totalHours;
                totalHoursExpected += weekData.jornadaHours;
                
                if (tipoContrato === 'Por horas') {
                    // L√ìGICA PARA EMPLEADOS "POR HORAS"
                    // Solo se suman las horas extra (sin neteo)
                    if (weekData.overtimeType === 'extra') {
                        totalOvertimeHours += weekData.overtimeHours;
                    }
                    // No se calculan horas pendientes para empleados por horas
                    
                } else {
                    // L√ìGICA PARA EMPLEADOS "MENSUAL"
                    // Solo se suman las semanas con neteo positivo
                if (weekData.overtimeType === 'extra') {
                    totalOvertimeHours += weekData.overtimeHours;
                } else if (weekData.overtimeType === 'deuda') {
                        // Las horas pendientes se reportan para informaci√≥n del colaborador
                    totalDebtHours += weekData.overtimeHours;
                    }
                }
            });

            return {
                hoursWorked: totalHoursWorked,
                hoursExpected: totalHoursExpected,
                overtimeHours: totalOvertimeHours,
                debtHours: totalDebtHours,
                tipoContrato: tipoContrato
            };
        }

        // Renderizar resumen mensual
        function renderMonthlySummary(summary) {
            const tipoContrato = summary.tipoContrato || 'Mensual';
            
            // Determinar si hay saldo positivo o negativo
            const hasOvertime = summary.overtimeHours > 0;
            const hasDebt = summary.debtHours > 0;
            
            let html = `
                <div class="summary-stats-container">
                    <!-- Horas Trabajadas -->
                    <div class="stat-row">
                        <div class="stat-icon worked"><i class="fas fa-clock"></i></div>
                        <div class="stat-details">
                            <span class="stat-label">Horas Trabajadas</span>
                            <span class="stat-value">${summary.hoursWorked.toFixed(1)} h</span>
                        </div>
                    </div>
            `;
            
            // Para empleados Mensuales mostramos Horas Esperadas
            if (tipoContrato !== 'Por horas') {
                html += `
                    <div class="stat-row">
                        <div class="stat-icon expected"><i class="fas fa-calendar-check"></i></div>
                        <div class="stat-details">
                            <span class="stat-label">Horas Esperadas</span>
                            <span class="stat-value">${summary.hoursExpected.toFixed(1)} h</span>
                        </div>
                    </div>
                `;
            }
            
            // Mostrar Horas Extra o Pendientes seg√∫n corresponda
            if (hasOvertime) {
                html += `
                    <div class="stat-row highlight-stat positive">
                        <div class="stat-icon"><i class="fas fa-plus-circle"></i></div>
                        <div class="stat-details">
                            <span class="stat-label">Horas Extra</span>
                            <span class="stat-value">+${summary.overtimeHours.toFixed(1)} h</span>
                        </div>
                    </div>
                `;
            } else if (hasDebt && tipoContrato !== 'Por horas') {
                 html += `
                    <div class="stat-row highlight-stat negative">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-details">
                            <span class="stat-label">Horas Pendientes</span>
                            <span class="stat-value">-${summary.debtHours.toFixed(1)} h</span>
                        </div>
                    </div>
                `;
            } else if (tipoContrato !== 'Por horas') {
                // Caso de equilibrio perfecto (raro pero posible)
                 html += `
                    <div class="stat-row highlight-stat">
                        <div class="stat-icon" style="background-color: transparent; color: #666; opacity: 0.6;"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-details">
                            <span class="stat-label">Estado</span>
                            <span class="stat-value" style="color: #666; font-size: 1rem;">Al d√≠a</span>
                        </div>
                    </div>
                `;
            } else {
                 // Caso empleados por horas sin extras
                 html += `
                    <div class="stat-row highlight-stat">
                        <div class="stat-icon" style="background-color: transparent; color: #666; opacity: 0.6;"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-details">
                            <span class="stat-label">Horas Extra</span>
                            <span class="stat-value" style="color: #666;">0.0 h</span>
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            monthlySummaryEl.innerHTML = html;
        }

        // Inicializar filtro de mes
        function initializeMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const currentDate = new Date();
            const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
            
            // Generar solo 2 opciones: mes actual y mes anterior
            for (let i = 0; i < 2; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthValue = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                const monthText = date.toLocaleDateString('es-ES', { 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthText;
                if (i === 0) option.selected = true; // Mes actual por defecto
                monthFilter.appendChild(option);
            }
            
            // Event listener para recargar cuando cambie el mes
            monthFilter.addEventListener('change', loadWorkHistory);
        }

        // Hacer funciones globales para que funcionen desde el HTML
        window.toggleDay = toggleDay;
        window.toggleWeek = toggleWeek;



        // Funcionalidad de los botones
        function initButtons() {
            // Inicializando botones (sin log)
            
            // Event listener para bot√≥n de iniciar
            if (btnStartWork) {
                btnStartWork.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Click en bot√≥n iniciar');
                    startWork();
                });
            }
            
            // Event listener para bot√≥n de finalizar
            if (btnEndWork) {
                btnEndWork.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Click en bot√≥n finalizar');
                    finalizarWork();
                });
            }
        }


        // Funci√≥n para mostrar informaci√≥n del usuario
        function showUserInfo() {
            // Intentar obtener usuario de secureAuthManager primero, luego de authManager
            let user = null;
            if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                user = window.secureAuthManager.getCurrentUser();
            } else if (window.authManager && window.authManager.isAuthenticated()) {
                user = window.authManager.getCurrentUser();
            }
            
            if (user) {
                // Actualizar nombre del empleado en la tarjeta
                const employeeNameEl = document.getElementById('employeeName');
                if (employeeNameEl) {
                    employeeNameEl.textContent = user.nombre || user.username || 'Usuario';
                }
                
                // Actualizar header usando load-headersecure.js si est√° disponible
                if (window.headerLoader && typeof window.headerLoader.showUserInfo === 'function') {
                    window.headerLoader.showUserInfo();
                }
                
                // Tambi√©n actualizar directamente los elementos del header
                const userInfoElements = document.querySelectorAll('.user-info, #mobile-user-info');
                
                userInfoElements.forEach(userInfoElement => {
                    if (userInfoElement) {
                        if (userInfoElement.id === 'mobile-user-info') {
                            userInfoElement.innerHTML = `<i class="fas fa-user"></i><span>${user.nombre || user.username || 'Usuario'}</span>`;
                        } else {
                            userInfoElement.innerHTML = `<i class="fas fa-user me-2"></i>${user.nombre || user.username || 'Usuario'}`;
                        }
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è [REGISTRO_HORAS_SECURE] No se pudo obtener informaci√≥n del usuario');
            }
        }

        // Funci√≥n para agregar bot√≥n de logout (SISTEMA SEGURO)
        function addLogoutButton() {
            // Buscar botones de logout en el header
            const logoutButtons = document.querySelectorAll('.logout-btn, #mobile-logout-btn');
            
            logoutButtons.forEach(logoutBtn => {
                if (logoutBtn) {
                    // Remover listeners existentes para evitar duplicados
                    const newLogoutBtn = logoutBtn.cloneNode(true);
                    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                    
                    newLogoutBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('üîí [REGISTRO_HORAS_SECURE] Iniciando logout...');
                        
                        try {
                            // Usar secureAuthManager si est√° disponible, sino authManager
                            if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                                await window.secureAuthManager.logout();
                                console.log('‚úÖ [REGISTRO_HORAS_SECURE] Logout exitoso con secureAuthManager');
                            } else if (window.authManager && window.authManager.isAuthenticated()) {
                                await window.authManager.logout();
                                console.log('‚úÖ [REGISTRO_HORAS_SECURE] Logout exitoso con authManager');
                            } else {
                                console.log('‚ö†Ô∏è [REGISTRO_HORAS_SECURE] No hay manager disponible, redirigiendo directamente');
                            }
                            
                            // Redirigir a login seguro
                            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                        } catch (error) {
                            console.error('‚ùå [REGISTRO_HORAS_SECURE] Error en logout:', error);
                            // Redirigir de todas formas
                            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                        }
                    });
                    
                    // Bot√≥n de logout configurado (sin log)
                }
            });
            
            // Tambi√©n usar el m√©todo de load-headersecure.js si est√° disponible
            if (window.headerLoader && typeof window.headerLoader.addLogoutButton === 'function') {
                window.headerLoader.addLogoutButton();
            }
        }

        // Event listeners - ya no necesitamos botones, solo el slider


        // Funci√≥n global para capturar GPS
        window.captureGPS = async function() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no soportada en este dispositivo'));
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000, // 15 segundos para dar m√°s tiempo
                    maximumAge: 0 // No usar cache, siempre obtener ubicaci√≥n actual
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const gpsData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            timestamp: new Date()
                        };
                        console.log('üìç GPS capturado:', gpsData);
                        resolve(gpsData);
                    },
                    (error) => {
                        let errorMessage = 'Error desconocido al obtener ubicaci√≥n';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Se deneg√≥ el permiso de ubicaci√≥n. Por favor, autorice el acceso a la ubicaci√≥n en su navegador.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'La ubicaci√≥n no est√° disponible. Verifique que el GPS est√© activado.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Tiempo de espera agotado. Intente nuevamente.';
                                break;
                        }
                        
                        console.error('‚ùå Error GPS:', errorMessage);
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        };

        // Funci√≥n global para solicitar nuevamente el permiso de GPS
        window.requestGPSPermissionAgain = async function() {
            try {
                console.log('üîÑ Solicitando permiso de GPS nuevamente...');
                
                // Cerrar la notificaci√≥n actual
                const notification = document.getElementById('gps-notification');
                if (notification) {
                    notification.remove();
                }
                
                // Mostrar mensaje de instrucciones
                showButtonInfo(btnStartWork, 'Solicitando permiso de ubicaci√≥n...');
                
                // Forzar solicitud de permiso con opciones m√°s estrictas
                const gpsData = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocalizaci√≥n no soportada en este dispositivo'));
                        return;
                    }

                    const options = {
                        enableHighAccuracy: true,
                        timeout: 20000, // 20 segundos
                        maximumAge: 0 // Forzar nueva ubicaci√≥n
                    };

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const gpsData = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                altitude: position.coords.altitude,
                                timestamp: new Date()
                            };
                            console.log('üìç GPS capturado exitosamente:', gpsData);
                            resolve(gpsData);
                        },
                        (error) => {
                            console.error('‚ùå Error GPS al reintentar:', error);
                            reject(error);
                        },
                        options
                    );
                });
                
                // Mostrar mensaje de √©xito
                showButtonSuccess(btnStartWork, '¬°Permiso de GPS otorgado! Ahora puedes iniciar turno.');
                
                // Habilitar el bot√≥n de iniciar turno
                btnStartWork.disabled = false;
                btnStartWork.style.opacity = '1';
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al solicitar GPS nuevamente:', error);
                
                // Mostrar mensaje de error m√°s espec√≠fico
                let errorMessage = 'No se pudo obtener la ubicaci√≥n. ';
                if (error.code === 1) {
                    errorMessage += 'Permiso denegado. Por favor, ve a la configuraci√≥n de tu navegador y permite el acceso a la ubicaci√≥n para este sitio, luego recarga la p√°gina.';
                } else if (error.code === 2) {
                    errorMessage += 'No se pudo determinar la ubicaci√≥n. Verifica que el GPS est√© activado y tu conexi√≥n a internet.';
                } else if (error.code === 3) {
                    errorMessage += 'La solicitud de ubicaci√≥n tard√≥ demasiado. Intenta nuevamente.';
                } else {
                    errorMessage += error.message;
                }
                
                showGPSRequiredNotification(errorMessage);
            }
        };

        // Verificar autenticaci√≥n antes de inicializar (SISTEMA SEGURO)
        async function checkAuthentication() {
            // Esperar a que secureAuthManager est√© disponible
            if (!window.secureAuthManager) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå [SECURE] secureAuthManager no disponible');
                } else {
                    console.error('‚ùå [SECURE] secureAuthManager no disponible');
                }
                return false;
            }
            
            // Configurar authManager para compatibilidad
            if (!window.authManager) {
                window.authManager = window.secureAuthManager;
            }
            
            // Esperar a que firebaseAuth est√© disponible
            if (!window.firebaseAuth) {
                if (window.safeLogger) {
                    window.safeLogger.info('‚è≥ [SECURE] Esperando a que firebaseAuth est√© disponible...');
                } else {
                    console.log('‚è≥ [SECURE] Esperando a que firebaseAuth est√© disponible...');
                }
                let retries = 0;
                const maxRetries = 30; // 3 segundos
                while (!window.firebaseAuth && retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                if (!window.firebaseAuth) {
                    if (window.safeLogger) {
                        window.safeLogger.error('‚ùå [SECURE] firebaseAuth no disponible despu√©s de esperar');
                    } else {
                        console.error('‚ùå [SECURE] firebaseAuth no disponible despu√©s de esperar');
                    }
                    if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                    return false;
                }
            }
            
            // Esperar a que currentUser est√© disponible (puede tardar un momento despu√©s de la redirecci√≥n)
            let retriesAuth = 0;
            const maxRetriesAuth = 50; // 5 segundos
            while (!window.firebaseAuth.currentUser && retriesAuth < maxRetriesAuth) {
                console.log(`‚è≥ [SECURE] Esperando currentUser... (${retriesAuth + 1}/${maxRetriesAuth})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                retriesAuth++;
            }
            
            if (!window.firebaseAuth.currentUser) {
                console.log('‚ùå [SECURE] Usuario no autenticado en Firebase despu√©s de esperar, redirigiendo a login seguro...');
                if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                return false;
            }
            
            // Usuario autenticado en Firebase (sin exponer email)
            
            // Esperar a que los datos se carguen (hasta 3 segundos)
            let retries = 0;
            const maxRetries = 30;
            while (retries < maxRetries) {
                if (window.secureAuthManager.isAuthenticated() && window.secureAuthManager.getCurrentUser()) {
                    // Usuario autenticado y datos cargados (sin log)
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            // Si despu√©s de esperar a√∫n no hay datos, intentar refrescar
            if (!window.secureAuthManager.getCurrentUser()) {
                // Intentando refrescar permisos (sin log)
                await window.secureAuthManager.refreshUserPermissions();
                
                if (!window.secureAuthManager.isAuthenticated() || !window.secureAuthManager.getCurrentUser()) {
                    console.log('‚ùå [SECURE] Usuario no autenticado despu√©s de refrescar, redirigiendo...');
                    if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                    return false;
                }
            }
            
            return true;
        }

        // Funci√≥n para esperar a que secureAuthManager est√© disponible (SISTEMA SEGURO)
        function waitForAuthManager() {
            return new Promise((resolve) => {
                let retries = 0;
                const maxRetries = 50; // 5 segundos m√°ximo
                const checkAuth = () => {
                    if (window.secureAuthManager) {
                        // Configurar authManager para compatibilidad
                        window.authManager = window.secureAuthManager;
                        // secureAuthManager disponible y configurado (sin log)
                        resolve(true);
                    } else if (retries < maxRetries) {
                        retries++;
                        setTimeout(checkAuth, 100);
                    } else {
                        console.error('‚ùå [SECURE] secureAuthManager no disponible despu√©s de esperar');
                        // No redirigir autom√°ticamente, dejar que checkAuthentication lo maneje
                        resolve(false);
                    }
                };
                checkAuth();
            });
        }

        // Inicializar
        window.addEventListener('load', async function() {
            // Iniciando carga (sin log)
            
            // Si el body no est√° autenticado, no hacer nada (ya se manej√≥ en el script del head)
            if (document.body && !document.body.classList.contains('authenticated')) {
                // Esperando verificaci√≥n de autenticaci√≥n (sin log)
                // Esperar un momento m√°s para que la verificaci√≥n del head termine
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Si despu√©s de esperar a√∫n no est√° autenticado, verificar
                if (!document.body.classList.contains('authenticated')) {
                    if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                        if (window.safeLogger) {
                            window.safeLogger.warn('‚ö†Ô∏è [REGISTRO_HORAS_SECURE] No autenticado en load, redirigiendo...');
                        } else {
                            console.warn('‚ö†Ô∏è [REGISTRO_HORAS_SECURE] No autenticado en load, redirigiendo...');
                        }
                        if (document.body) {
                            document.body.style.display = 'none';
                        }
                        if (!window.location.pathname.includes('iniciar_sesion.html')) {
                            window.location.replace('iniciar_sesion.html');
                        }
                        return;
                    }
                }
            }
            
            // Esperar a que secureAuthManager est√© disponible
            const authManagerReady = await waitForAuthManager();
            if (!authManagerReady) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå [REGISTRO_HORAS_SECURE] No se pudo cargar secureAuthManager');
                } else {
                    console.error('‚ùå [REGISTRO_HORAS_SECURE] No se pudo cargar secureAuthManager');
                }
                if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                return;
            }
            
            // Verificar autenticaci√≥n primero
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                if (window.safeLogger) {
                    window.safeLogger.error('‚ùå [REGISTRO_HORAS_SECURE] checkAuthentication fall√≥');
                } else {
                    console.error('‚ùå [REGISTRO_HORAS_SECURE] checkAuthentication fall√≥');
                }
                if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                return;
            }
            
            // Verificar nuevamente que secureAuthManager est√© autenticado
            if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                // Asegurar que authManager apunte a secureAuthManager
                window.authManager = window.secureAuthManager;
                // Usuario autenticado, continuando (sin log)
                
                // Esperar un momento para que el header se cargue completamente
                setTimeout(() => {
                    // Mostrar informaci√≥n del usuario
                    showUserInfo();
                    // Agregar funcionalidad de logout
                    addLogoutButton();
                }, 500);
                
                // Inicializar botones
                initButtons();
                
                // Limpiar sesiones duplicadas primero
                await cleanupDuplicateSessions();
                
                // Verificar sesiones abiertas despu√©s de la limpieza
                await checkOpenSession();
                
                // Inicializar filtro de mes
                initializeMonthFilter();
                
                // Verificar y configurar secci√≥n Paniagua
                if (window.verificarYConfigurarPaniagua) {
                    window.verificarYConfigurarPaniagua();
                } else {
                    if (window.safeLogger) {
                        window.safeLogger.warn('‚ö†Ô∏è verificarYConfigurarPaniagua no est√° disponible a√∫n');
                    } else {
                        console.warn('‚ö†Ô∏è verificarYConfigurarPaniagua no est√° disponible a√∫n');
                    }
                }
                
                // Funci√≥n de prueba removida para mejorar rendimiento
                
                // Cargar historial
                loadWorkHistory();
            }
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    
    <!-- Meta tags para evitar cach√© -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Script para mostrar el comunicado -->
    <script>
        // Versi√≥n de la aplicaci√≥n
        const APP_VERSION = '1.6.0';
        
        // Verificar versi√≥n en localStorage
        const storedVersion = localStorage.getItem('app_version');
        if (storedVersion !== APP_VERSION) {
            console.log('üîÑ Nueva versi√≥n detectada, limpiando cach√©...');
            localStorage.clear();
            sessionStorage.clear();
            localStorage.setItem('app_version', APP_VERSION);
            
            // Forzar recarga si es una versi√≥n diferente
            if (storedVersion && storedVersion !== APP_VERSION) {
                window.location.reload(true);
            }
        }

        // Funci√≥n para verificar acceso a otros m√≥dulos y cargar header
        async function checkUserModuleAccess() {
            try {
                // Verificando acceso a m√≥dulos (sin log)

                // Usar la funci√≥n global de verificaci√≥n de permisos
                if (typeof window.hasAccessToOtherModules === 'function') {
                    const hasOtherModuleAccess = window.hasAccessToOtherModules();
                    // Verificando acceso a m√≥dulos (sin log)

                    if (hasOtherModuleAccess) {
                        // Header ya cargado (sin log)
                    }
                }
            } catch (error) {
                if (window.safeLogger) {
                    window.safeLogger.error('Error verificando acceso a m√≥dulos', error);
                } else {
                    console.error('Error verificando acceso a m√≥dulos');
                }
                console.log('‚ÑπÔ∏è Error en verificaci√≥n, header simple se mantiene');
            }
        }

        // Funci√≥n para verificar si el usuario tiene acceso a otros m√≥dulos
        async function checkUserHasOtherModules(userId) {
            try {
                console.log('üîç Verificando m√≥dulos para usuario ID:', userId);
                
                // Importar Firebase Firestore
                const { getFirestore, collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                // Obtener el perfil del usuario
                console.log('üì° Consultando Firestore para usuario:', userId);
                const userDoc = await getDoc(doc(db, 'users', userId));
                
                if (!userDoc.exists()) {
                    console.log('‚ùå Perfil de usuario no encontrado en Firestore');
                    console.log('üîç Intentando con username como ID...');
                    
                    // Intentar con el username como ID
                    const userDocByUsername = await getDoc(doc(db, 'users', userId));
                    if (!userDocByUsername.exists()) {
                        console.log('‚ùå Perfil no encontrado con username tampoco');
                        return false;
                    }
                    
                    const userData = userDocByUsername.data();
                    console.log('üë§ Datos del usuario (por username):', userData);
                    
                    // Verificar si tiene acceso a m√≥dulos diferentes a registro de horas
                    const modules = userData.modules || [];
                    const otherModules = modules.filter(module => module !== 'registro_horas');
                    
                    console.log('üìã M√≥dulos del usuario:', modules);
                    console.log('üîç Otros m√≥dulos (no registro):', otherModules);
                    
                    return otherModules.length > 0;
                }

                const userData = userDoc.data();
                console.log('üë§ Datos del usuario:', userData);

                // Verificar si tiene acceso a m√≥dulos diferentes a registro de horas
                const modules = userData.modules || [];
                const otherModules = modules.filter(module => module !== 'registro_horas');
                
                console.log('üìã M√≥dulos del usuario:', modules);
                console.log('üîç Otros m√≥dulos (no registro):', otherModules);
                
                return otherModules.length > 0;
            } catch (error) {
                console.error('‚ùå Error verificando m√≥dulos del usuario:', error);
                return false;
            }
        }

        // Funci√≥n para cargar el header din√°mico
        async function loadDynamicHeader() {
            const headerContainer = document.getElementById('header-container');
            if (!headerContainer) return;

            // Cargar el header usando el sistema existente
            try {
                const response = await fetch('header.html');
                const headerHTML = await response.text();
                headerContainer.innerHTML = headerHTML;
                headerContainer.style.display = 'block';
                
                // Ocultar el header simple
                const simpleHeader = document.querySelector('.app-header-simple');
                if (simpleHeader) {
                    simpleHeader.style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Error cargando header din√°mico:', error);
            }
        }

        
        // Funci√≥n para llamar verificarYConfigurarPaniagua de forma segura
        function llamarVerificarPaniagua() {
            if (window.verificarYConfigurarPaniagua) {
                window.verificarYConfigurarPaniagua();
            } else {
                console.warn('‚ö†Ô∏è verificarYConfigurarPaniagua no est√° disponible a√∫n, esperando evento...');
                // Reintentar despu√©s de un breve delay
                setTimeout(() => {
                    if (window.verificarYConfigurarPaniagua) {
                        window.verificarYConfigurarPaniagua();
                    }
                }, 500);
            }
        }
        
        // Escuchar evento cuando el m√≥dulo est√© listo (registrar ANTES de que se dispare)
        window.addEventListener('paniaguaModuleReady', function() {
                // M√≥dulo Paniagua listo (sin log)
            llamarVerificarPaniagua();
        });
        
        // Tambi√©n verificar si ya est√° disponible cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar acceso a m√≥dulos y cargar header apropiado con delay
            setTimeout(() => {
                checkUserModuleAccess();
                // Intentar llamar inmediatamente (por si el m√≥dulo ya est√° listo)
                llamarVerificarPaniagua();
                // Iniciar carga optimizada de saldo de vacaciones (esperar a que el m√≥dulo est√© cargado)
                if (window.iniciarCargaSaldoVacaciones) {
                    window.iniciarCargaSaldoVacaciones();
                } else {
                    // Si no est√° disponible, intentar despu√©s de un delay adicional
                    setTimeout(() => {
                        if (window.iniciarCargaSaldoVacaciones) {
                            window.iniciarCargaSaldoVacaciones();
                        }
                    }, 500);
                }
            }, 1000);
            
        });
    </script>
    <!-- Modal Solicitud de Vacaciones -->
    <div class="modal fade" id="modalSolicitudVacaciones" tabindex="-1" aria-labelledby="modalSolicitudVacacionesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalSolicitudVacacionesLabel">
                        <i class="fas fa-umbrella-beach me-2"></i>Solicitud de Vacaciones
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 text-success">Nueva Solicitud</h6>
                        </div>
                        <div class="card-body">
                            <form id="formSolicitudVacaciones">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="fechaInicioVacaciones" class="form-label">Fecha Inicio</label>
                                        <input type="date" class="form-control" id="fechaInicioVacaciones" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="fechaFinVacaciones" class="form-label">Fecha Fin</label>
                                        <input type="date" class="form-control" id="fechaFinVacaciones" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="motivoVacaciones" class="form-label">Motivo (Opcional)</label>
                                        <textarea class="form-control" id="motivoVacaciones" rows="2" placeholder="Comentarios adicionales..."></textarea>
                                    </div>
                                    
                                    <div class="col-12" id="infoDiasVacaciones" style="display:none;">
                                        <div class="alert alert-info py-2 mb-0" style="font-size: 0.9rem;">
                                            <i class="fas fa-info-circle me-1"></i> Se solicitar√°n <strong id="cantidadDiasCalc">0</strong> d√≠as h√°biles (se excluyen domingos y feriados).
                                        </div>
                                    </div>

                                    <div class="col-12 text-end">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Lista de Solicitudes -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 text-secondary">Estado de Mis Solicitudes</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Fecha Solicitud</th>
                                            <th>Desde</th>
                                            <th>Hasta</th>
                                            <th>D√≠as</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaSolicitudesVacaciones">
                                        <tr><td colspan="5" class="text-center py-3 text-muted">Cargando solicitudes...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs,
            query, 
            where, 
            orderBy, 
            onSnapshot,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        
        // Obtener db
        const db = getFirestore();
        
        let modalVacaciones = null;
        let unsubscribeSolicitudes = null;
        
        window.abrirModalVacaciones = function() {
            // Verificar auth
            if (!window.secureAuthManager || !window.secureAuthManager.currentUser) {
                // Si no est√° listo el manager pero hay sesi√≥n, esperar o alertar
                // Asumimos que en registro_horas ya se valid√≥ auth para mostrar el body
                alert('Debe estar autenticado para solicitar vacaciones.');
                return;
            }
            
            if (!modalVacaciones) {
                modalVacaciones = new bootstrap.Modal(document.getElementById('modalSolicitudVacaciones'));
            }
            
            modalVacaciones.show();
            cargarSolicitudesVacaciones();
            // Actualizar saldo al abrir el modal (solo si ya est√° cargado)
            if (window.secureAuthManager && window.secureAuthManager.currentUser) {
                window.cargarSaldoVacacionesEmpleado();
            }
        };

        // Lista de feriados (a√±o-mes-d√≠a)
        const FERIADOS = [
            '2025-01-01', '2025-04-11', '2025-04-17', '2025-04-18', '2025-05-01',
            '2025-07-25', '2025-08-02', '2025-08-15', '2025-08-31', '2025-09-15',
            '2025-12-01', '2025-12-25',
            '2026-01-01', '2026-04-02', '2026-04-03', '2026-04-11', '2026-05-01',
            '2026-07-25', '2026-08-02', '2026-08-15', '2026-08-31', '2026-09-15',
            '2026-12-01', '2026-12-25'
        ];
        
        // Funci√≥n para verificar si una fecha es feriado
        function esFeriado(fechaStr) {
            return FERIADOS.includes(fechaStr);
        }
        
        // Funci√≥n para calcular d√≠as h√°biles (excluyendo domingos y feriados)
        function calcularDiasHabiles(inicio, fin) {
            if (!inicio || !fin) return [];
            
            // Usar T12:00:00 para evitar problemas de zona horaria al rotar d√≠as
            let current = new Date(inicio + 'T12:00:00'); 
            const end = new Date(fin + 'T12:00:00');
            
            if (end < current) return [];
            
            const fechas = [];
            while (current <= end) {
                const fechaStr = new Date(current).toISOString().split('T')[0];
                const esDomingo = current.getDay() === 0;
                const esFeriadoFecha = esFeriado(fechaStr);
                
                // Si NO es domingo y NO es feriado, lo agregamos
                if (!esDomingo && !esFeriadoFecha) {
                    fechas.push(fechaStr);
                }
                current.setDate(current.getDate() + 1);
            }
            return fechas;
        }

        // Listeners para calcular d√≠as din√°micamente en el formulario
        const inputInicio = document.getElementById('fechaInicioVacaciones');
        const inputFin = document.getElementById('fechaFinVacaciones');
        const infoDiv = document.getElementById('infoDiasVacaciones');
        const countSpan = document.getElementById('cantidadDiasCalc');
        
        function actualizarCalculoDias() {
            const inicio = inputInicio.value;
            const fin = inputFin.value;
            
            if (inicio && fin) {
                const dias = calcularDiasHabiles(inicio, fin);
                if (dias.length > 0) {
                    countSpan.textContent = dias.length;
                    infoDiv.style.display = 'block';
                } else {
                    infoDiv.style.display = 'none';
                }
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        if (inputInicio && inputFin) {
            inputInicio.addEventListener('change', actualizarCalculoDias);
            inputFin.addEventListener('change', actualizarCalculoDias);
        }
        
        // Event listener para el formulario
        const formVacaciones = document.getElementById('formSolicitudVacaciones');
        if (formVacaciones) {
            formVacaciones.addEventListener('submit', async function(e) {
                e.preventDefault();
                await guardarSolicitudVacaciones();
            });
        }
        
        async function guardarSolicitudVacaciones() {
            const fechaInicio = document.getElementById('fechaInicioVacaciones').value;
            const fechaFin = document.getElementById('fechaFinVacaciones').value;
            const motivo = document.getElementById('motivoVacaciones').value;
            
            if (!fechaInicio || !fechaFin) {
                alert('Por favor seleccione ambas fechas.');
                return;
            }

            const diasEfectivos = calcularDiasHabiles(fechaInicio, fechaFin);
            
            if (diasEfectivos.length === 0) {
                 alert('El rango de fechas no es v√°lido o no contiene d√≠as h√°biles.');
                 return;
            }
            
            const btnSubmit = document.querySelector('#formSolicitudVacaciones button[type="submit"]');
            const originalText = btnSubmit.innerHTML;
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            
            try {
                const db = getFirestore();
                const user = window.secureAuthManager.currentUser;
                
                // Convertir fechas a Timestamps - usar variable global del m√≥dulo
                const TimestampLocal = window.firestoreTimestamp;
                const fechaInicioTimestamp = TimestampLocal.fromDate(new Date(fechaInicio + 'T00:00:00'));
                const fechaFinTimestamp = TimestampLocal.fromDate(new Date(fechaFin + 'T00:00:00'));
                
                // Convertir array de strings de fechas a array de Timestamps
                const diasTimestamps = diasEfectivos.map(fechaStr => {
                    return TimestampLocal.fromDate(new Date(fechaStr + 'T00:00:00'));
                });
                
                const empleadoId = user.username || user.email.split('@')[0];
                const empleadoNombre = user.displayName || user.nombre || user.nombreCompleto || 'Usuario';
                
                const nuevaSolicitud = {
                    empleadoId: empleadoId,
                    empleadoNombre: empleadoNombre,
                    estado: 'pendiente',
                    fechaInicio: fechaInicioTimestamp,
                    fechaFin: fechaFinTimestamp,
                    fechaSolicitud: serverTimestamp(),
                    fechaHoraSolicitud: new Date().toISOString(),
                    dias: diasTimestamps,
                    totalDias: diasEfectivos.length
                };
                
                // Agregar motivo si existe
                if (motivo && motivo.trim()) {
                    nuevaSolicitud.motivo = motivo.trim();
                }
                
                await addDoc(collection(db, 'vacaciones'), nuevaSolicitud);
                
                // Limpiar formulario
                document.getElementById('formSolicitudVacaciones').reset();
                if (infoDiv) infoDiv.style.display = 'none';
                
                // Recargar lista
                cargarSolicitudesVacaciones();
                
                // Mostrar mensaje √©xito
                alert('Solicitud enviada correctamente');
                
            } catch (error) {
                console.error("Error al guardar solicitud:", error);
                alert('Error al enviar la solicitud: ' + error.message);
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
            }
        }
        
        function cargarSolicitudesVacaciones() {
            const db = getFirestore();
            const user = window.secureAuthManager.currentUser;
            const lista = document.getElementById('listaSolicitudesVacaciones');
            
            if (unsubscribeSolicitudes) {
                unsubscribeSolicitudes();
            }
            
            const empleadoId = user.username || user.email.split('@')[0];

            // Consulta sin orderBy para evitar necesidad de √≠ndice - ordenamos en el cliente
            const q = query(
                collection(db, 'vacaciones'),
                where('empleadoId', '==', empleadoId)
            );
            
            unsubscribeSolicitudes = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    lista.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted">No tienes solicitudes registradas.</td></tr>';
                    return;
                }
                
                // Ordenar en el cliente por fechaSolicitud descendente
                const solicitudes = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    solicitudes.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                solicitudes.sort((a, b) => {
                    const fechaA = a.fechaSolicitud ? (a.fechaSolicitud.toDate ? a.fechaSolicitud.toDate().getTime() : 0) : 0;
                    const fechaB = b.fechaSolicitud ? (b.fechaSolicitud.toDate ? b.fechaSolicitud.toDate().getTime() : 0) : 0;
                    return fechaB - fechaA; // Descendente
                });
                
                let html = '';
                solicitudes.forEach(item => {
                    const fechaSol = item.fechaSolicitud ? (item.fechaSolicitud.toDate ? item.fechaSolicitud.toDate().toLocaleDateString() : 'Pendiente') : 'Pendiente';
                    const dias = item.totalDias || (item.dias ? item.dias.length : 0);
                    
                    // Formatear fechas desde Timestamps
                    const fechaInicioStr = item.fechaInicio ? (item.fechaInicio.toDate ? item.fechaInicio.toDate().toISOString().split('T')[0] : '') : '';
                    const fechaFinStr = item.fechaFin ? (item.fechaFin.toDate ? item.fechaFin.toDate().toISOString().split('T')[0] : '') : '';
                    
                    html += `
                        <tr>
                            <td>${fechaSol}</td>
                            <td>${formatearFecha(fechaInicioStr)}</td>
                            <td>${formatearFecha(fechaFinStr)}</td>
                            <td>${dias}</td>
                            <td>${obtenerBadgeEstado(item.estado)}</td>
                        </tr>
                    `;
                });
                lista.innerHTML = html;
            }, (error) => {
                console.error("Error cargando solicitudes:", error);
                lista.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-danger">Error cargando datos.</td></tr>';
            });
        }
        
        // Funci√≥n para calcular d√≠as de vacaciones ganados seg√∫n legislaci√≥n de Costa Rica
        function calcularDiasGanados(fechaIngreso) {
            if (!fechaIngreso) return 0;
            
            const fechaIngresoObj = new Date(fechaIngreso + 'T00:00:00');
            const fechaActual = new Date();
            
            // Calcular diferencia en meses
            const mesesTrabajados = (fechaActual.getFullYear() - fechaIngresoObj.getFullYear()) * 12 + 
                                   (fechaActual.getMonth() - fechaIngresoObj.getMonth());
            
            // Ajustar por d√≠as del mes
            const diasDelMes = fechaActual.getDate() - fechaIngresoObj.getDate();
            const mesesDecimales = mesesTrabajados + (diasDelMes / 30);
            
            // F√≥rmula Costa Rica: meses trabajados √ó 1.1667 d√≠as por mes
            const diasGanados = mesesDecimales * 1.1667;
            
            return Math.max(0, Math.round(diasGanados * 100) / 100); // Redondear a 2 decimales
        }

        // Funci√≥n para calcular d√≠as redimidos (desde 01/12/2025 + d√≠as manuales antes de 01/12/2025)
        function calcularDiasRedimidos(vacacionesAprobadas, diasManualesAntes2025) {
            const fechaCorte = new Date('2025-12-01T00:00:00');
            fechaCorte.setHours(0, 0, 0, 0);
            let diasAprobadosDesde2025 = 0;
            
            vacacionesAprobadas.forEach(vac => {
                let diasDespues2025 = 0;
                
                if (vac.dias && Array.isArray(vac.dias) && vac.dias.length > 0) {
                    vac.dias.forEach(diaTimestamp => {
                        try {
                            const fechaDia = diaTimestamp.toDate ? diaTimestamp.toDate() : new Date(diaTimestamp);
                            fechaDia.setHours(0, 0, 0, 0);
                            if (fechaDia >= fechaCorte) {
                                diasDespues2025++;
                            }
                        } catch (e) {
                            console.warn('Error procesando d√≠a de vacaci√≥n:', e);
                        }
                    });
                } else {
                    const fechaInicio = vac.fechaInicio?.toDate ? vac.fechaInicio.toDate() : null;
                    if (fechaInicio) {
                        fechaInicio.setHours(0, 0, 0, 0);
                        if (fechaInicio >= fechaCorte) {
                            diasDespues2025 = vac.totalDias || 0;
                        } else {
                            const fechaFin = vac.fechaFin?.toDate ? vac.fechaFin.toDate() : null;
                            if (fechaFin) {
                                fechaFin.setHours(0, 0, 0, 0);
                                if (fechaFin >= fechaCorte) {
                                    const diffTime = fechaFin.getTime() - fechaCorte.getTime();
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                    diasDespues2025 = Math.min(diffDays, vac.totalDias || 0);
                                }
                            }
                        }
                    }
                }
                
                diasAprobadosDesde2025 += diasDespues2025;
            });
            
            const diasManuales = parseFloat(diasManualesAntes2025) || 0;
            const total = diasAprobadosDesde2025 + diasManuales;
            
            return {
                total: total,
                diasManualesAntes2025: diasManuales,
                diasAprobadosDesde2025: diasAprobadosDesde2025
            };
        }

        // Cargar y mostrar saldo de vacaciones del empleado actual (optimizado)
        window.cargarSaldoVacacionesEmpleado = async function() {
            const display = document.getElementById('saldoVacacionesDisplay');
            if (!display) return;
            
            // Mostrar loading inmediatamente
            display.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // Esperar m√°ximo 2 segundos a que secureAuthManager est√© disponible
                let retries = 0;
                while ((!window.secureAuthManager || !window.secureAuthManager.currentUser) && retries < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                if (!window.secureAuthManager || !window.secureAuthManager.currentUser) {
                    display.innerHTML = '<span style="color: white !important;">-</span>';
                    return;
                }
                
                const currentUser = window.secureAuthManager.currentUser;
                const empleadoId = currentUser.username || currentUser.uid;
                
                // Hacer ambas consultas en paralelo para mayor velocidad
                const [empleadoSnapshot, vacacionesSnapshot] = await Promise.all([
                    getDocs(query(
                        collection(db, 'empleados'),
                        where('username', '==', empleadoId)
                    )),
                    getDocs(query(
                        collection(db, 'vacaciones'),
                        where('empleadoId', '==', empleadoId),
                        where('estado', '==', 'aprobada')
                    ))
                ]);
                
                if (empleadoSnapshot.empty) {
                    display.innerHTML = '<span style="color: white !important;">-</span>';
                    return;
                }
                
                const empleado = empleadoSnapshot.docs[0].data();
                const vacacionesAprobadas = vacacionesSnapshot.docs.map(doc => doc.data());
                
                // Calcular saldo
                const diasGanados = calcularDiasGanados(empleado.fechaIngreso);
                const diasRedimidosInfo = calcularDiasRedimidos(
                    vacacionesAprobadas,
                    empleado.diasVacacionesAntes2025 || 0
                );
                const diasRedimidos = diasRedimidosInfo.total;
                const saldoDisponible = diasGanados - diasRedimidos;
                const saldoDisponibleCompleto = Math.floor(saldoDisponible);
                
                // Mostrar saldo con color blanco para contraste con fondo verde
                display.innerHTML = `
                    <span style="color: white !important;">
                        <i class="fas fa-calendar-check me-1"></i>
                        ${saldoDisponibleCompleto} d√≠a${saldoDisponibleCompleto !== 1 ? 's' : ''} disponible${saldoDisponibleCompleto !== 1 ? 's' : ''}
                    </span>
                `;
                
            } catch (error) {
                console.error('Error cargando saldo de vacaciones:', error);
                display.innerHTML = '<span style="color: white !important;">-</span>';
            }
        };
        
        // Funci√≥n para esperar y cargar saldo cuando secureAuthManager est√© listo
        window.iniciarCargaSaldoVacaciones = function() {
            // Intentar cargar inmediatamente si ya est√° disponible
            if (window.secureAuthManager && window.secureAuthManager.currentUser) {
                window.cargarSaldoVacacionesEmpleado();
                return;
            }
            
            // Escuchar evento cuando secureAuth est√© listo
            const handleAuthReady = () => {
                if (window.secureAuthManager && window.secureAuthManager.currentUser) {
                    window.cargarSaldoVacacionesEmpleado();
                    window.removeEventListener('secure-auth-ready', handleAuthReady);
                }
            };
            window.addEventListener('secure-auth-ready', handleAuthReady);
            
            // Fallback: Si no se dispara el evento, intentar despu√©s de un delay
            setTimeout(() => {
                if (window.secureAuthManager && window.secureAuthManager.currentUser) {
                    window.cargarSaldoVacacionesEmpleado();
                } else {
                    const display = document.getElementById('saldoVacacionesDisplay');
                    if (display) {
                        display.innerHTML = '<span style="color: white !important;">-</span>';
                    }
                }
            }, 1000);
        };
        
        // Iniciar carga autom√°ticamente cuando el m√≥dulo est√© listo
        // Usar un peque√±o delay para asegurar que el DOM est√© listo
        setTimeout(() => {
            window.iniciarCargaSaldoVacaciones();
        }, 2000);

        function calcularDias(inicio, fin) {
            const d1 = new Date(inicio);
            const d2 = new Date(fin);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            return diffDays;
        }
        
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const partes = fechaStr.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        
        function obtenerBadgeEstado(estado) {
            switch(estado) {
                case 'aprobada': return '<span class="badge bg-success">Aprobada</span>';
                case 'rechazada': return '<span class="badge bg-danger">Rechazada</span>';
                default: return '<span class="badge bg-warning text-dark">Pendiente</span>';
            }
        }
        
        // Iniciar carga autom√°ticamente cuando el m√≥dulo est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    if (window.iniciarCargaSaldoVacaciones) {
                        window.iniciarCargaSaldoVacaciones();
                    }
                }, 1500);
            });
        } else {
            // DOM ya est√° cargado
            setTimeout(() => {
                if (window.iniciarCargaSaldoVacaciones) {
                    window.iniciarCargaSaldoVacaciones();
                }
            }, 1500);
        }
    </script>

    <!-- Modal de Tutorial de Encuestas -->
    <div class="modal fade modal-encuestas-tutorial" id="modalTutorialEncuestas" tabindex="-1" aria-labelledby="modalTutorialEncuestasLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTutorialEncuestasLabel">
                        <i class="fas fa-heart"></i>
                        Sistema de Encuestas de Satisfacci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" id="btnCerrarTutorial"></button>
                </div>
                <div class="modal-body">
                    <div class="tutorial-step">
                        <h5><i class="fas fa-info-circle"></i> Sistema de Encuestas de Satisfacci√≥n</h5>
                        <p>
                            Estamos retomando el sistema de encuestas de satisfacci√≥n. Despu√©s de cada servicio, 
                            los clientes recibir√°n un link para evaluar su experiencia. Las encuestas est√°n asociadas 
                            directamente a tu servicio y se utilizan para reconocer excelente desempe√±o, identificar 
                            √°reas de mejora y dar seguimiento personalizado.
                        </p>
                    </div>

                    <div class="info-box" style="margin-bottom: 20px;">
                        <p style="margin: 0;">
                            <i class="fas fa-shield-alt"></i>
                            <strong>Transparencia:</strong> Tu trabajo es importante y queremos reconocerlo. 
                            Las encuestas se utilizan para reconocimientos y desarrollo profesional.
                        </p>
                    </div>

                    <h2 class="seccion-titulo seccion-calidad">
                        <span>‚≠ê</span>
                        <span>Calidad del Servicio</span>
                    </h2>

                    <!-- Q1 -->
                    <div class="pregunta-grupo">
                        <div class="pregunta-titulo">
                            <strong>Q1.</strong> ¬øC√≥mo califica el servicio del t√©cnico en general?
                        </div>
                        <div class="opciones-radio opcion-calidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p1" id="tutorial_p1_muy" value="Muy bueno" checked>
                                <label for="tutorial_p1_muy">‚úÖ Muy bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p1" id="tutorial_p1_bueno" value="Bueno">
                                <label for="tutorial_p1_bueno">üëç Bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p1" id="tutorial_p1_regular" value="Regular">
                                <label for="tutorial_p1_regular">üòê Regular</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p1" id="tutorial_p1_malo" value="Malo">
                                <label for="tutorial_p1_malo">‚ùå Malo</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c1">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c1" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q2 -->
                    <div class="pregunta-grupo">
                        <div class="pregunta-titulo">
                            <strong>Q2.</strong> ¬øC√≥mo califica el trato y respeto del t√©cnico durante la visita?
                        </div>
                        <div class="opciones-radio opcion-calidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p2" id="tutorial_p2_muy" value="Muy bueno" checked>
                                <label for="tutorial_p2_muy">‚úÖ Muy bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p2" id="tutorial_p2_bueno" value="Bueno">
                                <label for="tutorial_p2_bueno">üëç Bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p2" id="tutorial_p2_regular" value="Regular">
                                <label for="tutorial_p2_regular">üòê Regular</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p2" id="tutorial_p2_malo" value="Malo">
                                <label for="tutorial_p2_malo">‚ùå Malo</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c2"><i class="fas fa-comment me-1"></i>Comentarios (opcional):</label>
                            <textarea id="tutorial_c2" placeholder="Explique su respuesta..."></textarea>
                        </div>
                    </div>

                    <!-- Q3 -->
                    <div class="pregunta-grupo">
                        <div class="pregunta-titulo">
                            <strong>Q3.</strong> ¬øC√≥mo califica la presentaci√≥n personal del t√©cnico?
                        </div>
                        <div class="opciones-radio opcion-calidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p3" id="tutorial_p3_muy" value="Muy bueno" checked>
                                <label for="tutorial_p3_muy">‚úÖ Muy bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p3" id="tutorial_p3_bueno" value="Bueno">
                                <label for="tutorial_p3_bueno">üëç Bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p3" id="tutorial_p3_regular" value="Regular">
                                <label for="tutorial_p3_regular">üòê Regular</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p3" id="tutorial_p3_malo" value="Malo">
                                <label for="tutorial_p3_malo">‚ùå Malo</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c3">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c3" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q4 -->
                    <div class="pregunta-grupo">
                        <div class="pregunta-titulo">
                            <strong>Q4.</strong> ¬øC√≥mo califica el tiempo que dur√≥ el servicio?
                        </div>
                        <div class="opciones-radio opcion-calidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p4" id="tutorial_p4_muy" value="Muy bueno" checked>
                                <label for="tutorial_p4_muy">‚úÖ Muy bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p4" id="tutorial_p4_bueno" value="Bueno">
                                <label for="tutorial_p4_bueno">üëç Bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p4" id="tutorial_p4_regular" value="Regular">
                                <label for="tutorial_p4_regular">üòê Regular</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p4" id="tutorial_p4_malo" value="Malo">
                                <label for="tutorial_p4_malo">‚ùå Malo</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c4">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c4" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q5 -->
                    <div class="pregunta-grupo">
                        <div class="pregunta-titulo">
                            <strong>Q5.</strong> ¬øC√≥mo califica la explicaci√≥n del t√©cnico sobre lo que hizo durante el servicio?
                        </div>
                        <div class="opciones-radio opcion-calidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p5" id="tutorial_p5_muy" value="Muy bueno" checked>
                                <label for="tutorial_p5_muy">‚úÖ Muy bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p5" id="tutorial_p5_bueno" value="Bueno">
                                <label for="tutorial_p5_bueno">üëç Bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p5" id="tutorial_p5_regular" value="Regular">
                                <label for="tutorial_p5_regular">üòê Regular</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p5" id="tutorial_p5_malo" value="Malo">
                                <label for="tutorial_p5_malo">‚ùå Malo</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c5">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c5" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q6 -->
                    <div class="pregunta-grupo">
                        <div class="pregunta-titulo">
                            <strong>Q6.</strong> ¬øC√≥mo califica las medidas preventivas aplicadas o explicadas para proteger mascotas y personas sensibles?
                        </div>
                        <div class="opciones-radio opcion-calidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p6" id="tutorial_p6_muy" value="Muy bueno" checked>
                                <label for="tutorial_p6_muy">‚úÖ Muy bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p6" id="tutorial_p6_bueno" value="Bueno">
                                <label for="tutorial_p6_bueno">üëç Bueno</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p6" id="tutorial_p6_regular" value="Regular">
                                <label for="tutorial_p6_regular">üòê Regular</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p6" id="tutorial_p6_malo" value="Malo">
                                <label for="tutorial_p6_malo">‚ùå Malo</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c6"><i class="fas fa-comment me-1"></i>Comentarios (opcional):</label>
                            <textarea id="tutorial_c6" placeholder="Explique su respuesta..."></textarea>
                        </div>
                    </div>

                    <h2 class="seccion-titulo seccion-cumplimiento">
                        <span>‚úÖ</span>
                        <span>Cumplimiento Operativo</span>
                    </h2>

                    <!-- Q7 -->
                    <div class="pregunta-grupo cumplimiento">
                        <div class="pregunta-titulo">
                            <strong>Q7.</strong> ¬øEl t√©cnico limpi√≥ el √°rea y retir√≥ los excesos de producto al finalizar el servicio?
                        </div>
                        <div class="opciones-radio opcion-cumplimiento">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p7" id="tutorial_p7_si" value="S√≠" checked>
                                <label for="tutorial_p7_si">‚úÖ S√≠</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p7" id="tutorial_p7_no" value="No">
                                <label for="tutorial_p7_no">‚ùå No</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c7">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c7" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q8 -->
                    <div class="pregunta-grupo cumplimiento">
                        <div class="pregunta-titulo">
                            <strong>Q8.</strong> ¬øEl t√©cnico aplic√≥ puntos de gel durante el servicio?
                        </div>
                        <div class="opciones-radio opcion-cumplimiento">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p8" id="tutorial_p8_si" value="S√≠" checked>
                                <label for="tutorial_p8_si">‚úÖ S√≠</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p8" id="tutorial_p8_no" value="No">
                                <label for="tutorial_p8_no">‚ùå No</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c8"><i class="fas fa-comment me-1"></i>Comentarios (opcional):</label>
                            <textarea id="tutorial_c8" placeholder="Explique su respuesta..."></textarea>
                        </div>
                    </div>

                    <!-- Q9 -->
                    <div class="pregunta-grupo cumplimiento">
                        <div class="pregunta-titulo">
                            <strong>Q9.</strong> ¬øEl t√©cnico aplic√≥ tratamiento en tuber√≠as, desag√ºes y cajas de registro?
                        </div>
                        <div class="opciones-radio opcion-cumplimiento">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p9" id="tutorial_p9_si" value="S√≠" checked>
                                <label for="tutorial_p9_si">‚úÖ S√≠</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p9" id="tutorial_p9_no" value="No">
                                <label for="tutorial_p9_no">‚ùå No</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c9">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c9" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q10 -->
                    <div class="pregunta-grupo cumplimiento">
                        <div class="pregunta-titulo">
                            <strong>Q10.</strong> ¬øEl t√©cnico al finalizar le pregunt√≥ si necesitaba alg√∫n otro servicio o detalle adicional?
                        </div>
                        <div class="opciones-radio opcion-cumplimiento">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p10" id="tutorial_p10_si" value="S√≠" checked>
                                <label for="tutorial_p10_si">‚úÖ S√≠</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p10" id="tutorial_p10_no" value="No">
                                <label for="tutorial_p10_no">‚ùå No</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c10"><i class="fas fa-comment me-1"></i>Comentarios (opcional):</label>
                            <textarea id="tutorial_c10" placeholder="Explique su respuesta..."></textarea>
                        </div>
                    </div>

                    <!-- Q11 -->
                    <div class="pregunta-grupo cumplimiento">
                        <div class="pregunta-titulo">
                            <strong>Q11.</strong> ¬øEl t√©cnico le inform√≥ los m√©todos de pago disponibles al finalizar el servicio?
                        </div>
                        <div class="opciones-radio opcion-cumplimiento">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p11" id="tutorial_p11_si" value="S√≠" checked>
                                <label for="tutorial_p11_si">‚úÖ S√≠</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p11" id="tutorial_p11_no" value="No">
                                <label for="tutorial_p11_no">‚ùå No</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c11">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c11" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Q12 -->
                    <div class="pregunta-grupo cumplimiento">
                        <div class="pregunta-titulo">
                            <strong>Q12.</strong> ¬øC√≥mo fue la puntualidad del t√©cnico con respecto al horario acordado?
                        </div>
                        <div class="opciones-radio opcion-cumplimiento opcion-puntualidad">
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p12" id="tutorial_p12_puntual" value="Puntual" checked>
                                <label for="tutorial_p12_puntual">‚úÖ Puntual</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p12" id="tutorial_p12_conversado" value="No fue puntual, pero se convers√≥ oportunamente">
                                <label for="tutorial_p12_conversado">‚ö†Ô∏è No fue puntual, pero se convers√≥ oportunamente</label>
                            </div>
                            <div class="opcion-radio">
                                <input type="radio" name="tutorial_p12" id="tutorial_p12_impuntual" value="Impuntual y sin avisar">
                                <label for="tutorial_p12_impuntual">‚ùå Impuntual y sin avisar</label>
                            </div>
                        </div>
                        <div class="comentarios-campo">
                            <label for="tutorial_c12">
                                <i class="fas fa-comment me-1"></i>Comentarios adicionales
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <textarea id="tutorial_c12" placeholder="Si desea agregar algo m√°s, puede hacerlo aqu√≠..."></textarea>
                        </div>
                    </div>

                    <!-- Comentarios Generales -->
                    <div class="pregunta-grupo" style="background: #fff3cd; border-left-color: #ffc107;">
                        <div class="pregunta-titulo">
                            <i class="fas fa-comments me-2"></i>Comentarios o Observaciones Generales
                            <span class="optional-badge">Opcional</span>
                        </div>
                        <div class="comentarios-campo">
                            <textarea id="tutorial_comentarios_generales" placeholder="Comparta cualquier comentario adicional, sugerencia o observaci√≥n que considere importante..." style="min-height: 80px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-tutorial btn-continuar" id="btnContinuarTutorial" style="width: 100%;">
                        <i class="fas fa-check"></i> Entendido, Continuar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // L√≥gica para mostrar el modal de tutorial de encuestas
        document.addEventListener('DOMContentLoaded', function() {
            let modalShown = false; // Prevenir m√∫ltiples intentos
            
            // Funci√≥n para verificar autenticaci√≥n de m√∫ltiples formas
            const isUserAuthenticated = () => {
                // Verificar clase en body
                if (document.body && document.body.classList.contains('authenticated')) {
                    return true;
                }
                // Verificar secureAuthManager
                if (window.secureAuthManager && window.secureAuthManager.isAuthenticated()) {
                    return true;
                }
                // Verificar firebaseAuth
                if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    return true;
                }
                return false;
            };
            
            // Funci√≥n para mostrar el modal
            const showModal = () => {
                if (modalShown) return; // Ya se intent√≥ mostrar
                
                const modalElement = document.getElementById('modalTutorialEncuestas');
                if (!modalElement) {
                    console.warn('‚ö†Ô∏è Modal de tutorial de encuestas no encontrado');
                    return;
                }
                
                // Verificar si el usuario ya complet√≥ el tutorial
                const tutorialCompletado = localStorage.getItem('tutorialEncuestasCompletado');
                if (tutorialCompletado === 'true') {
                    return; // Ya complet√≥ el tutorial
                }
                
                modalShown = true;
                
                // Esperar un momento para que Bootstrap est√© completamente cargado
                setTimeout(() => {
                    try {
                        const modal = new bootstrap.Modal(modalElement, {
                            backdrop: 'static',
                            keyboard: false
                        });
                        modal.show();
                        
                        // Manejar bot√≥n de continuar
                        const btnContinuar = document.getElementById('btnContinuarTutorial');
                        const btnCerrar = document.getElementById('btnCerrarTutorial');
                        
                        const cerrarModal = () => {
                            modal.hide();
                            localStorage.setItem('tutorialEncuestasCompletado', 'true');
                        };
                        
                        if (btnContinuar) {
                            // Remover listeners previos para evitar duplicados
                            btnContinuar.replaceWith(btnContinuar.cloneNode(true));
                            document.getElementById('btnContinuarTutorial').addEventListener('click', cerrarModal);
                        }
                        
                        if (btnCerrar) {
                            // Remover listeners previos para evitar duplicados
                            btnCerrar.replaceWith(btnCerrar.cloneNode(true));
                            document.getElementById('btnCerrarTutorial').addEventListener('click', cerrarModal);
                        }
                        
                        // Cerrar cuando se oculta el modal
                        modalElement.addEventListener('hidden.bs.modal', function() {
                            localStorage.setItem('tutorialEncuestasCompletado', 'true');
                        }, { once: true });
                        
                        console.log('‚úÖ Modal de tutorial de encuestas mostrado');
                    } catch (error) {
                        console.error('‚ùå Error al mostrar modal de tutorial:', error);
                    }
                }, 1500); // Aumentado a 1.5 segundos para asegurar que todo est√© cargado
            };
            
            // Esperar a que el usuario est√© autenticado
            const checkAuthAndShowModal = () => {
                if (isUserAuthenticated()) {
                    showModal();
                } else {
                    // Si a√∫n no est√° autenticado, intentar de nuevo
                    setTimeout(checkAuthAndShowModal, 500);
                }
            };
            
            // Iniciar verificaci√≥n despu√©s de un breve delay
            setTimeout(() => {
                checkAuthAndShowModal();
            }, 1000);
            
            // Tambi√©n escuchar cuando se agregue la clase authenticated
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (isUserAuthenticated() && !modalShown) {
                            showModal();
                        }
                    }
                });
            });
            
            // Observar cambios en el body
            if (document.body) {
                observer.observe(document.body, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }
        });
    </script>
</body>
</html>
