<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados Seguro - Eco Plagas</title>
    <link rel="icon" type="image/png" href="Logo Eco Plagas.png">
    <link rel="shortcut icon" type="image/png" href="Logo Eco Plagas.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="eco-plagas-styles.css?v=4.0" rel="stylesheet">
    <link href="unified-styles.css?v=1.0" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <script src="check-permissions.js"></script>
    <script type="module" src="tickets-badge.js"></script>
    <script type="module" src="csrf-token.js"></script>
    
    <!-- Sistema de Autenticación Seguro -->
    <script type="module">
        import { auth } from './auth-secure.js';
        import { fetchSignInMethodsForEmail } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        
        // Guardar auth en window para uso global
        window.firebaseAuth = auth;
        window.fetchSignInMethodsForEmail = fetchSignInMethodsForEmail;
        
        // VERIFICACIÓN INMEDIATA DE AUTENTICACIÓN - Redirigir antes de cargar contenido
        (async function() {
            // Prevenir múltiples ejecuciones
            if (window.authCheckInProgress) {
                return;
            }
            window.authCheckInProgress = true;
            
            // Ocultar body inmediatamente
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Esperar a que auth-secure.js se cargue completamente
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verificar si ya estamos en iniciar_sesion.html (evitar loop)
            if (window.location.pathname.includes('iniciar_sesion.html')) {
                window.authCheckInProgress = false;
                return;
            }
            
            // Verificar autenticación de manera simple
            let retries = 0;
            const maxRetries = 20; // 2 segundos
            
            while (retries < maxRetries) {
                // Verificar Firebase Auth directamente
                if (auth.currentUser) {
                    if (window.safeLogger) {
                        window.safeLogger.success('✅ [EMPLEADOS_SECURE] Usuario autenticado');
                    } else {
                        console.log('✅ [EMPLEADOS_SECURE] Usuario autenticado');
                    }
                    
                    // Esperar a secureAuthManager
                    if (window.secureAuthManager) {
                        window.authManager = window.secureAuthManager;
                    } else {
                        // Esperar un poco más
                        await new Promise(resolve => setTimeout(resolve, 300));
                        if (window.secureAuthManager) {
                            window.authManager = window.secureAuthManager;
                        }
                    }
                    
                    // Mostrar body
                    if (document.body) {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                    
                    window.authCheckInProgress = false;
                    return; // Usuario autenticado, continuar
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            // Si llegamos aquí, no hay autenticación
            console.log('❌ [EMPLEADOS_SECURE] No autenticado después de esperar');
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Solo redirigir si no estamos ya en loginsecure
            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                window.location.replace('iniciar_sesion.html');
            }
            
            window.authCheckInProgress = false;
        })();
    </script>
    <style>
        /* Ocultar contenido hasta verificar autenticación */
        body {
            display: none !important;
        }
        body.authenticated {
            display: block !important;
        }
        
        /* Estilos para tabs mejorados y muy visibles */
        .nav-tabs {
            border-bottom: 3px solid #e9ecef;
            background: #f8f9fa;
            padding: 8px 8px 0 8px;
            border-radius: 12px 12px 0 0;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 12px 12px 0 0;
            color: #6c757d;
            background: #e9ecef;
            margin-right: 4px;
            padding: 14px 24px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            position: relative;
            border-bottom: 3px solid transparent;
        }
        .nav-tabs .nav-link:hover {
            background: #dee2e6;
            color: #495057;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .nav-tabs .nav-link.active {
            background: #2196F3 !important;
            background-color: #2196F3 !important;
            color: white !important;
            border-bottom: 3px solid #2196F3;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
            transform: translateY(-2px);
        }
        .nav-tabs .nav-link.active:hover {
            background: #1976D2 !important;
            background-color: #1976D2 !important;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.5);
        }
        .nav-tabs .nav-link i {
            margin-right: 8px;
            font-size: 1rem;
        }
        
        /* Mejoras visuales para las tarjetas */
        .mobile-card {
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.3s ease;
        }
        .mobile-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
        }
        
        /* Botones de acción mejorados */
        .mobile-action-btn {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .mobile-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Estadísticas con hover */
        .stat-box {
            cursor: default;
        }
        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Estilos para el encabezado "Gestión de Empleados" */
        .container-fluid .mobile-card:first-of-type .mobile-card-header {
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            color: #ffffff !important;
            border-radius: 12px 12px 0 0;
            padding: 15px 20px;
        }
        
        .container-fluid .mobile-card:first-of-type .mobile-card-header h5 {
            color: #ffffff !important;
            margin: 0;
        }
        
        .container-fluid .mobile-card:first-of-type .mobile-card-header h5 i {
            color: #ffffff !important;
        }
        
        /* Estilos para el encabezado "Lista de Empleados" - Azul Pastel */
        #panel-lista .mobile-card-header {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            color: #000000 !important;
        }
        
        #panel-lista .mobile-card-header h6 {
            color: #000000 !important;
        }
        
        #panel-lista .mobile-card-header h6 i {
            color: #000000 !important;
        }
        
        /* Estilos para el encabezado "Saldo de Vacaciones por Empleado" - Azul Pastel */
        #panel-vacaciones .mobile-card-header {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            color: #000000 !important;
        }
        
        #panel-vacaciones .mobile-card-header h6 {
            color: #000000 !important;
        }
        
        #panel-vacaciones .mobile-card-header h6 i {
            color: #000000 !important;
        }
        
        /* Estilos para columnas de la tabla de vacaciones */
        /* Verde Pastel para: Empleado, Ingreso, Acciones */
        #panel-vacaciones table thead th:nth-child(1), /* Empleado */
        #panel-vacaciones table thead th:nth-child(3), /* Ingreso */
        #panel-vacaciones table thead th:nth-child(4) { /* Acciones */
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            color: #000000 !important;
        }
        
        /* Verde Primario para: Saldo */
        #panel-vacaciones table thead th:nth-child(2) { /* Saldo */
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            color: #ffffff !important;
        }
        
        /* Asegurar que los iconos en las columnas tengan el color correcto */
        #panel-vacaciones table thead th:nth-child(1) i,
        #panel-vacaciones table thead th:nth-child(3) i,
        #panel-vacaciones table thead th:nth-child(4) i {
            color: #000000 !important;
        }
        
        #panel-vacaciones table thead th:nth-child(2) i {
            color: #ffffff !important;
        }
        
        /* Eliminar el estilo table-dark que puede estar interfiriendo */
        #panel-vacaciones table thead.table-dark {
            background: transparent !important;
        }
        
        /* Estilos para los botones "Actualizar" y "Liquidación" - Azul Primario */
        #panel-vacaciones .mobile-card-header button.btn-sm {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-color: #2196F3 !important;
            color: #ffffff !important;
        }
        
        #panel-vacaciones .mobile-card-header button.btn-sm:hover {
            background-color: #1976D2 !important;
            background: #1976D2 !important;
            border-color: #1976D2 !important;
            color: #ffffff !important;
        }
        
        #panel-vacaciones .mobile-card-header button.btn-sm:active,
        #panel-vacaciones .mobile-card-header button.btn-sm:focus {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-color: #2196F3 !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25) !important;
        }
        
        /* Asegurar que los iconos también sean blancos */
        #panel-vacaciones .mobile-card-header button.btn-sm i {
            color: #ffffff !important;
        }
        
        /* Estilos para columnas de la tabla de empleados */
        /* Verde Pastel para: Nombre, Usuario, Ingreso, Valor Inventario, Permisos, Acciones */
        #panel-lista table thead th:nth-child(1), /* Nombre */
        #panel-lista table thead th:nth-child(2), /* Usuario */
        #panel-lista table thead th:nth-child(3), /* Ingreso */
        #panel-lista table thead th:nth-child(5), /* Valor Inventario */
        #panel-lista table thead th:nth-child(6), /* Permisos */
        #panel-lista table thead th:nth-child(8) { /* Acciones */
            background-color: #c8e6c9 !important;
            background: #c8e6c9 !important;
            color: #000000 !important;
        }
        
        /* Verde Primario para: Actividad y Estado */
        #panel-lista table thead th:nth-child(4), /* Actividad */
        #panel-lista table thead th:nth-child(7) { /* Estado */
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            color: #ffffff !important;
        }
        
        /* Asegurar que los iconos en las columnas tengan el color correcto */
        #panel-lista table thead th:nth-child(1) i,
        #panel-lista table thead th:nth-child(2) i,
        #panel-lista table thead th:nth-child(3) i,
        #panel-lista table thead th:nth-child(5) i,
        #panel-lista table thead th:nth-child(6) i,
        #panel-lista table thead th:nth-child(8) i {
            color: #000000 !important;
        }
        
        #panel-lista table thead th:nth-child(4) i,
        #panel-lista table thead th:nth-child(7) i {
            color: #ffffff !important;
        }
        
        /* Eliminar el estilo table-dark que puede estar interfiriendo */
        #panel-lista table thead.table-dark {
            background: transparent !important;
        }
        
        /* Estilos para recuadros de estadísticas - Verde Pastel y Azul Pastel */
        .stat-box.stat-total,
        .stat-box.stat-active,
        .stat-box.stat-vehicle {
            background: #c8e6c9 !important;
            background-color: #c8e6c9 !important;
            box-shadow: none !important;
        }
        
        .stat-box.stat-departments {
            background: #BBDEFB !important;
            background-color: #BBDEFB !important;
            box-shadow: none !important;
        }
        
        /* Texto negro para todos los recuadros de estadísticas */
        .stat-box .stat-value,
        .stat-box .stat-label {
            color: #000000 !important;
        }
        
        /* Iconos negros para todos los recuadros */
        .stat-box .stat-icon {
            background: rgba(0, 0, 0, 0.1) !important;
        }
        
        .stat-box .stat-icon i {
            color: #000000 !important;
        }
        
        /* Estilos para el botón "Nuevo Empleado" - Azul Primario */
        #btnNuevo {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-color: #2196F3 !important;
            color: #ffffff !important;
        }
        
        #btnNuevo:hover {
            background-color: #1976D2 !important;
            background: #1976D2 !important;
            border-color: #1976D2 !important;
            color: #ffffff !important;
        }
        
        #btnNuevo:active,
        #btnNuevo:focus {
            background-color: #2196F3 !important;
            background: #2196F3 !important;
            border-color: #2196F3 !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25) !important;
        }
        
        /* Estilos para el botón "Acceso Masivo" - Verde Primario */
        #btnAccesoMasivo {
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            border-color: #0b7835 !important;
            color: #ffffff !important;
        }
        
        #btnAccesoMasivo:hover {
            background-color: #0a6b2f !important;
            background: #0a6b2f !important;
            border-color: #0a6b2f !important;
            color: #ffffff !important;
        }
        
        #btnAccesoMasivo:active,
        #btnAccesoMasivo:focus {
            background-color: #0b7835 !important;
            background: #0b7835 !important;
            border-color: #0b7835 !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(11, 120, 53, 0.25) !important;
        }
        
        /* Asegurar que los iconos también sean blancos */
        #btnAccesoMasivo i {
            color: #ffffff !important;
        }
        
        /* Estilos para el botón "Exportar CSV" - Amarillo Pastel */
        #btnExportarEmpleados {
            background-color: #fff9c4 !important;
            background: #fff9c4 !important;
            border-color: #fff9c4 !important;
            color: #000000 !important;
            box-shadow: none !important;
        }
        
        #btnExportarEmpleados:hover {
            background-color: #fff59d !important;
            background: #fff59d !important;
            border-color: #fff59d !important;
            color: #000000 !important;
        }
        
        #btnExportarEmpleados:active,
        #btnExportarEmpleados:focus {
            background-color: #fff9c4 !important;
            background: #fff9c4 !important;
            border-color: #fff9c4 !important;
            color: #000000 !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 249, 196, 0.5) !important;
        }
        
        /* Asegurar que los iconos también sean negros */
        #btnExportarEmpleados i {
            color: #000000 !important;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <div class="container-fluid mt-2 px-3">
        <!-- Header Principal -->
        <div class="mobile-card mb-3">
            <div class="mobile-card-header">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Gestión de Empleados</h5>
            </div>
            <div class="mobile-card-body">
                <!-- Estadísticas -->
                <div class="stats-horizontal mb-3" id="statsCards" style="display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; gap: 8px; padding: 4px 0; width: 100%;">
                    <div class="stat-box stat-total" style="display: flex !important; align-items: center; padding: 10px 12px; border-radius: 12px; flex: 1; background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="stat-icon" style="width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; background: rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-users" style="font-size: 0.85rem; color: white;"></i>
                        </div>
                        <div class="stat-info" style="flex: 1; min-width: 0;">
                            <div class="stat-value" id="totalEmpleados" style="font-size: 1.3rem; font-weight: 700; line-height: 1.2; color: white; margin-bottom: 2px;">0</div>
                            <div class="stat-label" style="font-size: 0.65rem; font-weight: 500; color: rgba(255, 255, 255, 0.9); text-transform: uppercase; letter-spacing: 0.3px;">Total</div>
                        </div>
                    </div>
                    <div class="stat-box stat-active" style="display: flex !important; align-items: center; padding: 10px 12px; border-radius: 12px; flex: 1; background: linear-gradient(135deg, #553c9a 0%, #44337a 100%); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="stat-icon" style="width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; background: rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-user-check" style="font-size: 0.85rem; color: white;"></i>
                        </div>
                        <div class="stat-info" style="flex: 1; min-width: 0;">
                            <div class="stat-value" id="empleadosActivos" style="font-size: 1.3rem; font-weight: 700; line-height: 1.2; color: white; margin-bottom: 2px;">0</div>
                            <div class="stat-label" style="font-size: 0.65rem; font-weight: 500; color: rgba(255, 255, 255, 0.9); text-transform: uppercase; letter-spacing: 0.3px;">Activos</div>
                        </div>
                    </div>
                    <div class="stat-box stat-vehicle" style="display: flex !important; align-items: center; padding: 10px 12px; border-radius: 12px; flex: 1; background: linear-gradient(135deg, #2f855a 0%, #276749 100%); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="stat-icon" style="width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; background: rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-car" style="font-size: 0.85rem; color: white;"></i>
                        </div>
                        <div class="stat-info" style="flex: 1; min-width: 0;">
                            <div class="stat-value" id="empleadosConVehiculo" style="font-size: 1.3rem; font-weight: 700; line-height: 1.2; color: white; margin-bottom: 2px;">0</div>
                            <div class="stat-label" style="font-size: 0.65rem; font-weight: 500; color: rgba(255, 255, 255, 0.9); text-transform: uppercase; letter-spacing: 0.3px;">Con Vehículo</div>
                        </div>
                    </div>
                    <div class="stat-box stat-departments" style="display: flex !important; align-items: center; padding: 10px 12px; border-radius: 12px; flex: 1; background: linear-gradient(135deg, #2b6cb0 0%, #2c5282 100%); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="stat-icon" style="width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; background: rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-building" style="font-size: 0.85rem; color: white;"></i>
                        </div>
                        <div class="stat-info" style="flex: 1; min-width: 0;">
                            <div class="stat-value" id="departamentos" style="font-size: 1.3rem; font-weight: 700; line-height: 1.2; color: white; margin-bottom: 2px;">0</div>
                            <div class="stat-label" style="font-size: 0.65rem; font-weight: 500; color: rgba(255, 255, 255, 0.9); text-transform: uppercase; letter-spacing: 0.3px;">Departamentos</div>
                        </div>
                    </div>
                </div>

                <!-- Botón Principal de Acción -->
                <div class="d-grid mb-3">
                    <button id="btnNuevo" class="btn btn-primary btn-lg mobile-action-btn" style="padding: 12px; font-size: 1rem; font-weight: 600;">
                        <i class="fas fa-plus me-2"></i>Nuevo Empleado
                    </button>
                    </div>

                <!-- Acciones Rápidas en Grid -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <button id="btnAccesoMasivo" class="btn btn-success w-100 mobile-action-btn" data-bs-toggle="modal" data-bs-target="#modalAccesoMasivo" style="padding: 10px; font-size: 0.9rem;">
                            <i class="fas fa-users-cog me-2"></i>Acceso Masivo
                        </button>
                            </div>
                    <div class="col-6">
                        <button id="btnEstadoMasivo" class="btn btn-warning w-100 mobile-action-btn" data-bs-toggle="modal" data-bs-target="#modalEstadoMasivo" style="padding: 10px; font-size: 0.9rem;">
                            <i class="fas fa-user-slash me-2"></i>Activar/Desactivar
                        </button>
                        </div>
                    <div class="col-6">
                        <button id="btnExportarEmpleados" class="btn btn-info w-100 mobile-action-btn" style="padding: 10px; font-size: 0.9rem;">
                            <i class="fas fa-file-csv me-2"></i>Exportar CSV
                            </button>
                    </div>
                    <div class="col-6">
                        <button id="btnLimpiarEmpleadosInvalidos" class="btn btn-danger w-100 mobile-action-btn" onclick="verificarEmpleadosInvalidos()" style="padding: 10px; font-size: 0.9rem;">
                            <i class="fas fa-trash-alt me-2"></i>Limpiar Inválidos
                            </button>
                    </div>
                        </div>
                    </div>
                </div>

        <!-- Tabs para Organizar Contenido -->
        <ul class="nav nav-tabs mb-3" id="empleadosTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-lista" data-bs-toggle="tab" data-bs-target="#panel-lista" type="button" role="tab" aria-controls="panel-lista" aria-selected="true">
                    <i class="fas fa-list"></i>Lista de Empleados
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-vacaciones" data-bs-toggle="tab" data-bs-target="#panel-vacaciones" type="button" role="tab" aria-controls="panel-vacaciones" aria-selected="false">
                    <i class="fas fa-umbrella-beach"></i>Vacaciones
                </button>
            </li>
        </ul>

        <div class="tab-content" id="empleadosTabContent">
            <!-- Tab: Lista de Empleados -->
            <div class="tab-pane fade show active" id="panel-lista" role="tabpanel" aria-labelledby="tab-lista">
                <div class="mobile-card">
                    <div class="mobile-card-header" style="padding: 10px 15px; background: #BBDEFB; background-color: #BBDEFB; color: #000000;">
                        <h6 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000;">
                            <i class="fas fa-users me-2" style="color: #000000;"></i>Lista de Empleados
                        </h6>
                    </div>
                    <div class="mobile-card-body" style="padding: 15px;">
                        <div class="table-responsive">
                            <table class="table table-modern table-hover table-sm" style="font-size: 0.8rem; margin-bottom: 0;">
                                <thead class="table-dark" style="font-size: 0.75rem;">
                                    <tr>
                                        <th style="padding: 8px 10px;"><i class="fas fa-user me-1"></i>Nombre</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-user-circle me-1"></i>Usuario</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-calendar-alt me-1"></i>Ingreso</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-chart-line me-1"></i>Actividad</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-dollar-sign me-1"></i>Valor Inventario</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-key me-1"></i>Permisos</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-info-circle me-1"></i>Estado</th>
                                        <th style="padding: 8px 10px; width: 180px;"><i class="fas fa-cogs me-1"></i>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="empleadosList" style="line-height: 1.4;">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Vacaciones -->
            <div class="tab-pane fade" id="panel-vacaciones" role="tabpanel" aria-labelledby="tab-vacaciones">
                <div class="mobile-card">
                    <div class="mobile-card-header" style="padding: 10px 15px; background: #BBDEFB; background-color: #BBDEFB; color: #000000;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" style="font-size: 1rem; font-weight: 600; color: #000000;">
                                <i class="fas fa-umbrella-beach me-2" style="color: #000000;"></i>Saldo de Vacaciones por Empleado
                            </h6>
                            <div>
                                <button class="btn btn-sm me-2" onclick="cargarSaldoVacaciones()" style="font-size: 0.85rem;">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                                <button class="btn btn-sm" onclick="mostrarLiquidacionVacaciones()" style="font-size: 0.85rem;">
                                    <i class="fas fa-calculator me-1"></i>Liquidación
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mobile-card-body" style="padding: 15px;">
                        <div class="mb-3 text-muted" style="font-size: 0.8rem;">
                            <i class="fas fa-info-circle me-1"></i>Última actualización: <span id="ultimaActualizacionVacaciones">-</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover" style="font-size: 0.85rem;">
                                <thead class="table-dark" style="font-size: 0.75rem;">
                                    <tr>
                                        <th style="padding: 8px 10px;"><i class="fas fa-user me-1"></i>Empleado</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-wallet me-1" title="Saldo disponible (días completos)"></i>Saldo</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-calendar-alt me-1" title="Fecha de ingreso (editable)"></i>Ingreso</th>
                                        <th style="padding: 8px 10px;"><i class="fas fa-cog me-1"></i>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaSaldoVacaciones">
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando saldo de vacaciones...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Verificar y Eliminar Empleados Inválidos -->
    <div class="modal fade" id="modalLimpiarEmpleadosInvalidos" tabindex="-1" aria-labelledby="modalLimpiarEmpleadosInvalidosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalLimpiarEmpleadosInvalidosLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Verificar Empleados Inválidos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Se mostrarán los empleados que serán eliminados. 
                        Revise cuidadosamente antes de confirmar. Esta acción no se puede deshacer.
                    </div>
                    
                    <div class="mb-3">
                        <h6>Empleados Inválidos Encontrados: <span class="badge bg-danger" id="contadorEmpleadosInvalidos">0</span></h6>
                        <small class="text-muted">Empleados con nombres o apellidos vacíos o "undefined"</small>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>ID/Username</th>
                                    <th>Primer Nombre</th>
                                    <th>Primer Apellido</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="listaEmpleadosInvalidos">
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Verificando empleados...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Protección:</strong> Solo se eliminarán empleados que cumplan TODOS estos criterios:
                        <ul class="mb-0 mt-2">
                            <li>Primer nombre vacío, "undefined" o solo espacios</li>
                            <li>Primer apellido vacío, "undefined" o solo espacios</li>
                            <li>Segundo nombre vacío, "undefined" o solo espacios (si existe)</li>
                            <li>Segundo apellido vacío, "undefined" o solo espacios (si existe)</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminacion" onclick="eliminarEmpleadosInvalidos()" disabled>
                        <i class="fas fa-trash-alt me-2"></i>Eliminar Empleados Inválidos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar empleado -->
    <div class="modal fade" id="empleadoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Nuevo Empleado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="empleadoForm">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Información Personal</h6>
                                <div class="mb-3">
                                    <label for="cedula" class="form-label">Cédula *</label>
                                    <input type="text" id="cedula" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="primerNombre" class="form-label">Primer Nombre *</label>
                                    <input type="text" id="primerNombre" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="segundoNombre" class="form-label">Segundo Nombre</label>
                                    <input type="text" id="segundoNombre" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="primerApellido" class="form-label">Primer Apellido *</label>
                                    <input type="text" id="primerApellido" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="segundoApellido" class="form-label">Segundo Apellido *</label>
                                    <input type="text" id="segundoApellido" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="inicial" class="form-label">Inicial</label>
                                    <input type="text" id="inicial" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" id="fechaNacimiento" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Información de Contacto</h6>
                                <div class="mb-3">
                                    <label for="telefonoPersonal" class="form-label">Teléfono Personal</label>
                                    <input type="text" id="telefonoPersonal" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="telefonoEmpresa" class="form-label">Teléfono de Empresa</label>
                                    <input type="text" id="telefonoEmpresa" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="correoPersonal" class="form-label">Correo Personal</label>
                                    <input type="email" id="correoPersonal" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="correoEmpresa" class="form-label">Correo de Empresa</label>
                                    <input type="email" id="correoEmpresa" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="direccion" class="form-label">Dirección de Residencia</label>
                                    <textarea id="direccion" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Información Laboral</h6>
                                <div class="mb-3">
                                    <label for="salario" class="form-label">Salario Mensual Base Bruto</label>
                                    <input type="number" id="salario" class="form-control" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label for="tipoPago" class="form-label">Tipo de Contrato</label>
                                    <select id="tipoPago" class="form-control">
                                        <option value="Mensual" selected>Mensual</option>
                                        <option value="Por horas">Por horas</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="banco" class="form-label">Banco</label>
                                    <select id="banco" class="form-control">
                                        <option value="">Seleccionar banco...</option>
                                        <option value="BAC San José">BAC San José</option>
                                        <option value="Banco de Costa Rica">Banco de Costa Rica</option>
                                        <option value="Scotiabank">Scotiabank</option>
                                        <option value="Promerica">Promerica</option>
                                        <option value="Coopenae">Coopenae</option>
                                        <option value="Coocique">Coocique</option>
                                        <option value="Banco Popular">Banco Popular</option>
                                        <option value="Banco Nacional">Banco Nacional</option>
                                        <option value="Davivienda">Davivienda</option>
                                        <option value="Lafise">Lafise</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="cuentaBancaria" class="form-label">Cuenta Bancaria</label>
                                    <input type="text" id="cuentaBancaria" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="fechaIngreso" class="form-label">Fecha de Ingreso</label>
                                    <input type="date" id="fechaIngreso" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="cargo" class="form-label">Cargo/Posición</label>
                                    <input type="text" id="cargo" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="diasVacacionesAntes2025" class="form-label">
                                        Días de Vacaciones Disfrutados antes del 01/12/2025
                                    </label>
                                    <input type="number" id="diasVacacionesAntes2025" class="form-control" min="0" step="0.5" placeholder="0">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Ingrese los días de vacaciones que el empleado disfrutó antes del 01 de diciembre de 2025. 
                                        Estos días se descontarán del saldo total de vacaciones ganadas.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Información Adicional</h6>
                                <div class="mb-3">
                                    <label for="departamento" class="form-label">Departamento</label>
                                    <select id="departamento" class="form-control">
                                        <option value="">Seleccionar departamento...</option>
                                        <option value="Fumigación">Fumigación</option>
                                        <option value="Ventas">Ventas</option>
                                        <option value="Administración">Administración</option>
                                        <option value="Logística">Logística</option>
                                        <option value="Recursos Humanos">Recursos Humanos</option>
                                        <option value="Contabilidad">Contabilidad</option>
                                        <option value="Gerencia">Gerencia</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="tipoContrato" class="form-label">Tipo de Contrato *</label>
                                    <select id="tipoContrato" class="form-control" required>
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="Tiempo Completo">Tiempo Completo</option>
                                        <option value="Medio Tiempo">Medio Tiempo</option>
                                        <option value="Por Proyecto">Por Proyecto</option>
                                        <option value="Temporal">Temporal</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="estado" class="form-label">Estado Laboral *</label>
                                    <select id="estado" class="form-control" required>
                                        <option value="Activo">Activo</option>
                                        <option value="Inactivo">Inactivo</option>
                                        <option value="Suspendido">Suspendido</option>
                                        <option value="Vacaciones">Vacaciones</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="vehiculoAsignado" class="form-label">Vehículo Asignado</label>
                                    <select id="vehiculoAsignado" class="form-control">
                                        <option value="">Sin asignar</option>
                                        <option value="APV 01">APV 01</option>
                                        <option value="APV 02">APV 02</option>
                                        <option value="APV 03">APV 03</option>
                                        <option value="APV 04">APV 04</option>
                                        <option value="APV 05">APV 05</option>
                                        <option value="APV 06">APV 06</option>
                                        <option value="APV 07">APV 07</option>
                                        <option value="APV 08">APV 08</option>
                                        <option value="Yaris">Yaris</option>
                                        <option value="Kangoo">Kangoo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Uniforme</h6>
                                <div class="mb-3">
                                    <label for="tallaCamisa" class="form-label">Talla de Camisa *</label>
                                    <select id="tallaCamisa" class="form-control" required>
                                        <option value="">Seleccionar talla...</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                        <option value="XXXL">XXXL</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="tallaPantalon" class="form-label">Talla de Pantalón *</label>
                                    <select id="tallaPantalon" class="form-control" required>
                                        <option value="">Seleccionar talla...</option>
                                        <option value="28">28</option>
                                        <option value="30">30</option>
                                        <option value="32">32</option>
                                        <option value="34">34</option>
                                        <option value="36">36</option>
                                        <option value="38">38</option>
                                        <option value="40">40</option>
                                        <option value="42">42</option>
                                        <option value="44">44</option>
                                        <option value="46">46</option>
                                        <option value="48">48</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="tallaZapatos" class="form-label">Talla de Zapatos *</label>
                                    <select id="tallaZapatos" class="form-control" required>
                                        <option value="">Seleccionar talla...</option>
                                        <option value="35">35</option>
                                        <option value="36">36</option>
                                        <option value="37">37</option>
                                        <option value="38">38</option>
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                        <option value="45">45</option>
                                        <option value="46">46</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Información Adicional</h6>
                                <div class="mb-3">
                                    <label for="licenciaConducir" class="form-label">Licencia de Conducir</label>
                                    <input type="text" id="licenciaConducir" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="vencimientoLicencia" class="form-label">Vencimiento de Licencia</label>
                                    <input type="date" id="vencimientoLicencia" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="certificaciones" class="form-label">Certificaciones</label>
                                    <textarea id="certificaciones" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="especializacion" class="form-label">Especialización</label>
                                    <select id="especializacion" class="form-control">
                                        <option value="">Seleccionar especialización...</option>
                                        <option value="Fumigación Residencial">Fumigación Residencial</option>
                                        <option value="Fumigación Industrial">Fumigación Industrial</option>
                                        <option value="Control de Plagas">Control de Plagas</option>
                                        <option value="Desinfección">Desinfección</option>
                                        <option value="Manejo de Productos">Manejo de Productos</option>
                                        <option value="Supervisión">Supervisión</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3">Permisos de Módulos</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoCalendario">
                                            <label class="form-check-label" for="permisoCalendario">Calendario</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoEmpleados">
                                            <label class="form-check-label" for="permisoEmpleados">Empleados</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoRegistroHoras">
                                            <label class="form-check-label" for="permisoRegistroHoras">Registro de Horas</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoEdicionHoras">
                                            <label class="form-check-label" for="permisoEdicionHoras">Edición de Horas</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoReportesGerenciales">
                                            <label class="form-check-label" for="permisoReportesGerenciales">Reportes Gerenciales</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoOperarioBodega">
                                            <label class="form-check-label" for="permisoOperarioBodega">Operario de Bodega</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoAdministradorBodega">
                                            <label class="form-check-label" for="permisoAdministradorBodega">Administrador de Bodega</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoTickets">
                                            <label class="form-check-label" for="permisoTickets">Tickets Internos</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permisoRecursosHumanos">
                                            <label class="form-check-label" for="permisoRecursosHumanos">Recursos Humanos</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notas" class="form-label">Notas</label>
                            <textarea id="notas" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modern btn-secondary-modern" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnEliminarEmpleado" class="btn btn-modern btn-danger-modern" style="display: none;" title="Eliminar empleado">
                        <i class="fas fa-trash me-2"></i>Eliminar Empleado
                    </button>
                    <button type="button" id="btnCrearFirebaseAuth" class="btn btn-modern btn-success-modern" style="display: none;" title="Crear usuario en Firebase Authentication">
                        <i class="fas fa-user-plus me-2"></i>Crear en Firebase Auth
                    </button>
                    <button type="button" id="btnGuardar" class="btn btn-modern btn-primary-modern">
                        <i class="fas fa-save me-2"></i>Guardar Empleado
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar eliminación de empleado -->
    <div class="modal fade" id="modalEliminarEmpleado" tabindex="-1" aria-labelledby="modalEliminarEmpleadoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalEliminarEmpleadoLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación de Empleado
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>⚠️ ADVERTENCIA IMPORTANTE:</strong>
                        <p class="mb-0 mt-2">Solo se deben eliminar empleados que tengan <strong>0 horas trabajadas</strong> registradas en el sistema.</p>
                    </div>
                    
                    <div id="infoEmpleadoEliminar" class="mb-3">
                        <p><strong>Empleado a eliminar:</strong> <span id="nombreEmpleadoEliminar"></span></p>
                        <p><strong>Total de horas trabajadas:</strong> <span id="horasTotalesEmpleado" class="fw-bold"></span></p>
                    </div>
                    
                    <div id="advertenciaHoras" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>No se puede eliminar:</strong> Este empleado tiene horas trabajadas registradas. La eliminación está bloqueada por seguridad.
                    </div>
                    
                    <div class="mb-3">
                        <label for="verificacionMatematica" class="form-label">
                            <strong>Verificación de seguridad:</strong> Resuelve la siguiente operación matemática
                        </label>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span id="formulaMatematica" class="fs-5 fw-bold" style="min-width: 150px; text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;"></span>
                            <span class="fs-5">=</span>
                            <input type="number" class="form-control" id="verificacionMatematica" placeholder="Resultado" style="max-width: 100px;" autocomplete="off">
                        </div>
                        <small class="text-muted">Ingresa el resultado de la operación para confirmar la eliminación</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Consecuencias de la eliminación:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Se eliminará el registro del empleado de la base de datos</li>
                            <li>NO se eliminará el historial de horas trabajadas (si existe)</li>
                            <li>NO se eliminará el usuario de Firebase Authentication (si existe)</li>
                            <li>Esta acción NO se puede deshacer</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminarEmpleado" disabled>
                        <i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para acceso masivo -->
    <div class="modal fade" id="modalAccesoMasivo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-users-cog me-2"></i>Gestión Masiva de Acceso a Módulo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> Selecciona los empleados y la acción (agregar o quitar acceso) para el módulo seleccionado.
                    </div>
                    <div class="mb-3">
                        <label for="moduloAccesoMasivo" class="form-label"><strong>Seleccionar Módulo *</strong></label>
                        <select class="form-select form-select-lg" id="moduloAccesoMasivo" required style="font-size: 1rem;" onchange="actualizarListaEmpleados()">
                            <option value="">Selecciona un módulo</option>
                            <option value="calendario">Calendario</option>
                            <option value="empleados">Empleados</option>
                            <option value="registro_horas">Registro de Horas</option>
                            <option value="edicion_horas">Edición de Horas</option>
                            <option value="reportes_gerenciales">Reportes Gerenciales</option>
                            <option value="operario_bodega">Operario de Bodega</option>
                            <option value="administrador_bodega">Administrador de Bodega</option>
                            <option value="tickets">Tickets Internos</option>
                            <option value="recursos_humanos">Recursos Humanos</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Acción a realizar:</strong></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="accionAccesoMasivo" id="accionAgregar" value="agregar" checked>
                            <label class="btn btn-outline-success" for="accionAgregar">
                                <i class="fas fa-plus me-2"></i>Agregar Acceso
                            </label>
                            <input type="radio" class="btn-check" name="accionAccesoMasivo" id="accionQuitar" value="quitar">
                            <label class="btn btn-outline-danger" for="accionQuitar">
                                <i class="fas fa-minus me-2"></i>Quitar Acceso
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0"><strong>Seleccionar Empleados:</strong></label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodosEmpleados(true)" style="font-size: 0.85rem;">
                                    <i class="fas fa-check-double me-1"></i>Seleccionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="seleccionarTodosEmpleados(false)" style="font-size: 0.85rem;">
                                    <i class="fas fa-times me-1"></i>Deseleccionar Todos
                                </button>
                            </div>
                        </div>
                        <div id="listaEmpleadosAccesoMasivo" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                            <p class="text-muted mb-0">Selecciona un módulo para ver los empleados</p>
                        </div>
                        <small class="text-muted" id="contadorEmpleadosSeleccionados">0 empleados seleccionados</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnAplicarAccesoMasivo" onclick="aplicarAccesoMasivo()">
                        <i class="fas fa-check me-2"></i>Agregar Acceso
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para activar/desactivar empleados masivo -->
    <div class="modal fade" id="modalEstadoMasivo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-slash me-2"></i>Activar/Desactivar Empleados Masivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Importante:</strong> Al desactivar empleados, estos no podrán ingresar al sistema. Al activar empleados, recuperarán el acceso.
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Acción a realizar:</strong></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="accionEstadoMasivo" id="accionActivar" value="activar" checked>
                            <label class="btn btn-outline-success" for="accionActivar">
                                <i class="fas fa-check me-2"></i>Activar Empleados
                            </label>
                            <input type="radio" class="btn-check" name="accionEstadoMasivo" id="accionDesactivar" value="desactivar">
                            <label class="btn btn-outline-danger" for="accionDesactivar">
                                <i class="fas fa-ban me-2"></i>Desactivar Empleados
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0"><strong>Seleccionar Empleados:</strong></label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodosEmpleadosEstado(true)" style="font-size: 0.85rem;">
                                    <i class="fas fa-check-double me-1"></i>Seleccionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="seleccionarTodosEmpleadosEstado(false)" style="font-size: 0.85rem;">
                                    <i class="fas fa-times me-1"></i>Deseleccionar Todos
                                </button>
                            </div>
                        </div>
                        <div id="listaEmpleadosEstadoMasivo" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                            <p class="text-muted mb-0">Cargando empleados...</p>
                        </div>
                        <small class="text-muted" id="contadorEmpleadosEstadoSeleccionados">0 empleados seleccionados</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnAplicarEstadoMasivo" onclick="aplicarEstadoMasivo()">
                        <i class="fas fa-check me-2"></i>Activar Empleados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver contraseña -->
    <div class="modal fade" id="modalCambiarPassword" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-key me-2"></i>Ver Contraseña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Formulario de desbloqueo izquierda -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="codigoDesbloqueo" class="form-label">Código de Desbloqueo *</label>
                                <input type="password" id="codigoDesbloqueo" class="form-control" placeholder="Ingresa el código para ver la contraseña" autocomplete="off">
                                <small class="form-text text-muted">Ingresa el código de seguridad para desbloquear la visualización de la contraseña</small>
                                </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-lock me-2"></i>
                                <strong>Seguridad:</strong> La contraseña está protegida. Ingresa el código correcto para visualizarla.
                            </div>
                        </div>
                        <!-- Cuadrito de credenciales derecha -->
                        <div class="col-md-6">
                            <div class="card border-primary" style="background: #f8f9fa; border-width: 2px;">
                                <div class="card-header bg-primary text-white text-center">
                                    <strong><i class="fas fa-user-shield me-2"></i>Credenciales de Acceso</strong>
                                </div>
                                <div class="card-body text-center" style="padding: 20px;">
                                    <div class="mb-3">
                                        <label class="form-label text-muted mb-1" style="font-size: 0.85rem;">Usuario:</label>
                                        <div class="p-2 bg-white border rounded" style="font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: bold;" id="credencialUsuario">
                                            -
                                        </div>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label text-muted mb-1" style="font-size: 0.85rem;">Contraseña:</label>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="p-2 bg-white border rounded flex-grow-1" style="font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: bold; min-height: 2.5rem;" id="credencialPassword">
                                                ••••••••••••
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnMostrarPassword" onclick="toggleMostrarPassword()" title="Mostrar contraseña" style="display: none;">
                                                <i class="fas fa-eye" id="iconoMostrarPassword"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copiarPasswordAlPortapapeles()" title="Copiar contraseña" id="btnCopiarPassword" style="display: none;">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="verificarCodigoDesbloqueo()">
                        <i class="fas fa-unlock me-2"></i>Desbloquear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, setDoc, query, where, orderBy, Timestamp, limit } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Configuración de Firebase
        const firebaseConfig = {
            projectId: "cursorwebapp-f376d",
            appId: "1:719990096116:web:07c1ff697e7655b2cd9ea1",
            databaseURL: "https://cursorwebapp-f376d-default-rtdb.firebaseio.com",
            storageBucket: "cursorwebapp-f376d.firebasestorage.app",
            apiKey: "AIzaSyC-IQj0yHR8cELr-mw-v2xlnw6LlJYFUyk",
            authDomain: "cursorwebapp-f376d.firebaseapp.com",
            messagingSenderId: "719990096116",
            measurementId: "G-DJXLKFR7CD"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let empleados = [];
        let currentEmpleadoId = null;
        let workSessions = []; // Sesiones de trabajo
        let bodegas = []; // Bodegas asignadas
        let stockBodegas = []; // Stock por bodega
        let productos = []; // Productos para calcular valores
        let metricasEmpleados = {}; // Cache de métricas por empleado

        // Elementos del DOM
        const empleadosList = document.getElementById('empleadosList');
        const btnNuevo = document.getElementById('btnNuevo');
        const empleadoModal = new bootstrap.Modal(document.getElementById('empleadoModal'));
        const empleadoForm = document.getElementById('empleadoForm');
        const btnGuardar = document.getElementById('btnGuardar');
        const modalTitle = document.getElementById('modalTitle');

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar permisos de acceso
            if (!checkPagePermissions()) {
                return;
            }
            cargarDatos();
            configurarEventListeners();
        });

        // Lista de usuarios registrados en Firebase Auth (actualizada desde Firebase Console - 12 dic 2025)
        const usuariosFirebaseAuth = [
            'sol.gutierrez',
            'maria.gutierrez',
            'manuel.paniagua',
            'cristhian.paniagua',
            'veronica.palma',
            'fabiola.retana',
            'david.ortiz',
            'wagner.camacho',
            'ricardo.perez',
            'rolando.salazar',
            'jefferson.carvajal',
            'andres.rodriguez',
            'steve.ulloa',
            'alfredo.delgado',
            'luis.nuñez', // Actualizado: luis.nuñez (con tilde)
            'kevin.lara',
            'miguel.trejos',
            'jose.madrigal',
            'prueba.prueba',
            'minor.leon',
            'sebastian.gonzalez',
            'jose.garcia',
            'jaime.fernandez',
            'carlo.antonini',
            'victor.solis',
            'marchena.marchena',
            'fabian.soto',
            'susan.varela',
            'mayren.rodriguez',
            'mario.paniagua',
            'pablo.paniagua'
        ].map(u => u.toLowerCase());

        // Objeto estático de credenciales REMOVIDO
        // Ahora las credenciales se obtienen directamente desde Firestore
        // Función obsoleta removida: obtenerCredencialesEmpleado
        // Usar verCredencialesEmpleado() que consulta Firestore directamente

        // Función para verificar si el username está en Firebase Auth
        // Verifica directamente si el empleado tiene firebaseAuthUID en Firestore
        function verificarUsuarioEnFirebase(empleado) {
            if (!empleado) return false;
            // Si el empleado tiene firebaseAuthUID, significa que fue creado en Firebase Auth
            return !!empleado.firebaseAuthUID;
        }

        // Cargar datos de actividad
        async function cargarDatosActividad() {
            try {
                console.log('📊 Cargando datos de actividad...');
                
                // Cargar work_sessions
                // ⚠️ SEGURIDAD: Limitar a 1000 para prevenir dumpeado masivo
                const workSessionsQuery = query(collection(db, 'work_sessions'), orderBy('startTime', 'desc'), limit(1000));
                const workSessionsSnapshot = await getDocs(workSessionsQuery);
                workSessions = workSessionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`✅ Cargadas ${workSessions.length} sesiones de trabajo`);
                
                // Cargar bodegas
                // ⚠️ SEGURIDAD: Limitar a 500 (número razonable de bodegas)
                const bodegasQuery = query(collection(db, 'bodegas'), limit(500));
                const bodegasSnapshot = await getDocs(bodegasQuery);
                bodegas = bodegasSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`✅ Cargadas ${bodegas.length} bodegas`);
                
                // Cargar stock_bodegas
                // NOTA: Esta consulta es para VISUALIZACIÓN (calcular valor inventario en tabla)
                // Si necesitas TODOS los datos para procesamiento, usar función administrativa específica
                // ⚠️ SEGURIDAD: Limitar a 10000 registros para prevenir dumpeado masivo en visualización
                const stockQuery = query(collection(db, 'stock_bodegas'), limit(10000));
                const stockSnapshot = await getDocs(stockQuery);
                stockBodegas = stockSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`✅ Cargado stock de ${stockBodegas.length} bodegas`);
                
                // Cargar productos para calcular valores
                // NOTA: Esta consulta es para VISUALIZACIÓN (calcular valor inventario en tabla)
                // Si necesitas TODOS los productos para procesamiento, usar función administrativa específica
                // ⚠️ SEGURIDAD: Limitar a 5000 productos para prevenir dumpeado masivo en visualización
                const productosQuery = query(collection(db, 'productos'), limit(5000));
                const productosSnapshot = await getDocs(productosQuery);
                productos = productosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`✅ Cargados ${productos.length} productos`);
                
                // Calcular métricas para cada empleado
                calcularMetricasEmpleados();
                
            } catch (error) {
                console.error('❌ Error cargando datos de actividad:', error);
            }
        }

        // Calcular métricas de actividad por empleado
        function calcularMetricasEmpleados() {
            metricasEmpleados = {};
            const ahora = new Date();
            const hace30Dias = new Date(ahora.getTime() - 30 * 24 * 60 * 60 * 1000);
            const hace7Dias = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            empleados.forEach(empleado => {
                const username = empleado.username || '';
                if (!username) {
                    metricasEmpleados[empleado.id] = {
                        horas30Dias: 0,
                        horas7Dias: 0,
                        ultimaSesion: null,
                        diasActivos30: 0,
                        bodegasAsignadas: 0,
                        valorInventario: 0
                    };
                    return;
                }
                
                // Filtrar sesiones del empleado
                const sesionesEmpleado = workSessions.filter(s => {
                    const sessionUsername = s.username || s.employeeName || '';
                    return sessionUsername.toLowerCase() === username.toLowerCase();
                });
                
                // Calcular horas en últimos 30 días
                const sesiones30Dias = sesionesEmpleado.filter(s => {
                    try {
                        const fechaInicio = s.startTime?.toDate ? s.startTime.toDate() : (s.startTime ? new Date(s.startTime) : null);
                        if (!fechaInicio || isNaN(fechaInicio.getTime())) return false;
                        return fechaInicio >= hace30Dias;
                    } catch (e) {
                        return false;
                    }
                });
                
                let horas30Dias = 0;
                let horas7Dias = 0;
                let ultimaSesion = null;
                const diasUnicos = new Set();
                
                sesiones30Dias.forEach(s => {
                    try {
                        const fechaInicio = s.startTime?.toDate ? s.startTime.toDate() : (s.startTime ? new Date(s.startTime) : null);
                        let fechaFin = s.endTime?.toDate ? s.endTime.toDate() : (s.endTime ? new Date(s.endTime) : null);
                        
                        // Validar fecha de inicio
                        if (!fechaInicio || isNaN(fechaInicio.getTime())) {
                            // Si no hay fecha de inicio válida, intentar usar duración
                            if (s.duracion) {
                                const duracion = parseFloat(s.duracion) || 0;
                                if (duracion > 0 && duracion <= 24) { // Validar que sea razonable (0-24h)
                                    horas30Dias += duracion;
                                }
                            }
                            return;
                        }
                        
                        // Si la sesión está activa (working) y no tiene endTime, usar hora actual
                        if ((s.status === 'working' || s.status === 'active') && (!fechaFin || isNaN(fechaFin.getTime()))) {
                            fechaFin = ahora; // Usar hora actual para sesiones activas
                        }
                        
                        // Si hay fecha de fin válida y es posterior a inicio
                        if (fechaFin && !isNaN(fechaFin.getTime()) && fechaFin > fechaInicio) {
                            const horas = (fechaFin - fechaInicio) / (1000 * 60 * 60);
                            
                            // Validar que las horas sean razonables (entre 0 y 24 horas por sesión)
                            if (horas > 0 && horas <= 24) {
                                horas30Dias += horas;
                                
                                if (fechaInicio >= hace7Dias) {
                                    horas7Dias += horas;
                                }
                                
                                // Día único
                                const dia = fechaInicio.toISOString().split('T')[0];
                                diasUnicos.add(dia);
                            }
                        } else if (s.duracion) {
                            // Usar duración si está disponible y es válida
                            const duracion = parseFloat(s.duracion) || 0;
                            if (duracion > 0 && duracion <= 24) { // Validar que sea razonable
                                horas30Dias += duracion;
                                
                                if (fechaInicio >= hace7Dias) {
                                    horas7Dias += duracion;
                                }
                                
                                // Día único
                                const dia = fechaInicio.toISOString().split('T')[0];
                                diasUnicos.add(dia);
                            }
                        } else if (s.status === 'active' || s.status === 'completed' || s.status === 'working') {
                            // Si la sesión está activa o completada pero no tiene endTime válido, contar el día
                            const dia = fechaInicio.toISOString().split('T')[0];
                            diasUnicos.add(dia);
                        }
                        
                        // Última sesión (solo si tiene fecha válida)
                        if (fechaInicio && (!ultimaSesion || fechaInicio > ultimaSesion)) {
                            ultimaSesion = fechaInicio;
                        }
                    } catch (e) {
                        console.warn('Error procesando sesión:', e, s);
                    }
                });
                
                // Buscar bodegas asignadas
                const bodegasAsignadas = bodegas.filter(b => {
                    const empleadoId = b.empleadoId || b.empleado || '';
                    return empleadoId === empleado.id || empleadoId === username;
                });
                
                // Calcular valor monetario del inventario en las bodegas asignadas
                let valorInventario = 0;
                bodegasAsignadas.forEach(bodega => {
                    const stockBodega = stockBodegas.filter(s => s.bodegaId === bodega.id);
                    stockBodega.forEach(stock => {
                        const stockActual = parseFloat(stock.stockActual) || 0;
                        if (stockActual > 0) {
                            const producto = productos.find(p => p.id === stock.productoId);
                            if (producto && producto.precioUnitario) {
                                valorInventario += stockActual * parseFloat(producto.precioUnitario);
                            }
                        }
                    });
                });
                
                metricasEmpleados[empleado.id] = {
                    horas30Dias: Math.round(horas30Dias * 10) / 10,
                    horas7Dias: Math.round(horas7Dias * 10) / 10,
                    ultimaSesion: ultimaSesion,
                    diasActivos30: diasUnicos.size,
                    bodegasAsignadas: bodegasAsignadas.length,
                    valorInventario: valorInventario
                };
            });
        }

        // Cargar datos
        async function cargarDatos() {
            try {
                console.log('👥 Cargando empleados...');
                
                const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                empleados = empleadosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`✅ Cargados ${empleados.length} empleados`);
                
                // Cargar datos de actividad
                await cargarDatosActividad();
                
                mostrarEmpleados(empleados);
                mostrarEstadisticas();
                
            } catch (error) {
                console.error('❌ Error cargando empleados:', error);
                mostrarError('Error cargando empleados.');
            }
        }

        // Contar cantidad de permisos de un empleado
        function contarPermisos(permisos) {
            if (!permisos) return 0;
            
            const permisosArray = [
                permisos.calendario,
                permisos.empleados,
                permisos.registro_horas,
                permisos.edicion_horas,
                permisos.reportes_gerenciales,
                permisos.operario_bodega,
                permisos.administrador_bodega,
                permisos.tickets,
                permisos.recursos_humanos
            ];
            
            return permisosArray.filter(permiso => permiso === true).length;
        }

        // Mostrar empleados
        function mostrarEmpleados(empleadosFiltrados) {
            if (empleadosFiltrados.length === 0) {
                empleadosList.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="no-data">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <p>No se encontraron empleados</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Ordenar empleados por última sesión (más reciente primero)
            const empleadosOrdenados = empleadosFiltrados.sort((a, b) => {
                const metricasA = metricasEmpleados[a.id] || { ultimaSesion: null };
                const metricasB = metricasEmpleados[b.id] || { ultimaSesion: null };
                
                const fechaA = metricasA.ultimaSesion;
                const fechaB = metricasB.ultimaSesion;
                
                // Si ambos tienen fecha, ordenar descendente (más reciente primero)
                if (fechaA && fechaB) {
                    return fechaB - fechaA; // Descendente
                }
                
                // Si solo uno tiene fecha, ese va primero
                if (fechaA && !fechaB) return -1;
                if (!fechaA && fechaB) return 1;
                
                // Si ninguno tiene fecha, mantener orden original
                return 0;
            });

            empleadosList.innerHTML = empleadosOrdenados.map(empleado => {
                const estado = empleado.estado || 'Activo';
                const esActivo = estado === 'Activo';
                const estadoBadge = esActivo 
                    ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Activo</span>'
                    : `<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>${estado}</span>`;
                
                const fechaIngreso = empleado.fechaIngreso || '';
                const fechaIngresoDisplay = fechaIngreso 
                    ? new Date(fechaIngreso + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })
                    : '<span class="text-muted"><i class="fas fa-calendar-times me-1"></i>Sin fecha</span>';
                
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.segundoNombre || ''} ${empleado.primerApellido || ''} ${empleado.segundoApellido || ''}`.trim();
                
                // Username (solo texto, sin funcionalidad de login)
                const username = empleado.username || '';
                const usernameDisplay = username 
                    ? `<code style="font-size: 0.7rem; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; color: #000000; border: 1px solid #dee2e6;">
                            ${username}
                          </code>`
                    : '<span class="text-muted" style="font-size: 0.65rem;"><i class="fas fa-exclamation-triangle me-1"></i>Sin usuario</span>';
                
                // Verificar si el empleado está en Firebase Auth (verificando firebaseAuthUID)
                const estaEnFirebaseAuth = verificarUsuarioEnFirebase(empleado);
                
                // Badge de verificación de nombre en Firebase con botón de sincronizar
                const nombreCorrectoBadge = username 
                    ? (estaEnFirebaseAuth
                        ? '<span class="badge bg-success" style="font-size: 0.65rem;"><i class="fas fa-check me-1"></i>En Firebase</span>'
                        : `<span class="badge bg-warning text-dark" style="font-size: 0.65rem;">
                            <i class="fas fa-exclamation-triangle me-1"></i>No en Firebase
                            <button class="btn btn-sm p-0 ms-1" 
                                    onclick="sincronizarConFirebaseAuth('${empleado.id}', '${username}')" 
                                    title="Sincronizar con Firebase Auth"
                                    style="background: none; border: none; color: inherit; padding: 0; margin: 0; line-height: 1;">
                                <i class="fas fa-sync-alt" style="font-size: 0.6rem;"></i>
                            </button>
                           </span>`)
                    : '';
                
                // Obtener métricas del empleado
                const metricas = metricasEmpleados[empleado.id] || {
                    horas30Dias: 0,
                    horas7Dias: 0,
                    ultimaSesion: null,
                    diasActivos30: 0,
                    bodegasAsignadas: 0,
                    productosInventario: 0
                };
                
                // Formatear última sesión
                let ultimaSesionDisplay = 'Nunca';
                if (metricas.ultimaSesion) {
                    const diasDesdeUltima = Math.floor((new Date() - metricas.ultimaSesion) / (1000 * 60 * 60 * 24));
                    if (diasDesdeUltima === 0) {
                        ultimaSesionDisplay = '<span class="text-success">Hoy</span>';
                    } else if (diasDesdeUltima === 1) {
                        ultimaSesionDisplay = '<span class="text-success">Ayer</span>';
                    } else if (diasDesdeUltima <= 7) {
                        ultimaSesionDisplay = `<span class="text-info">Hace ${diasDesdeUltima}d</span>`;
                    } else if (diasDesdeUltima <= 30) {
                        ultimaSesionDisplay = `<span class="text-warning">Hace ${diasDesdeUltima}d</span>`;
                    } else {
                        ultimaSesionDisplay = `<span class="text-danger">Hace ${diasDesdeUltima}d</span>`;
                    }
                }
                
                // Indicador de actividad basado en horas promedio por día
                let actividadBadge = '';
                const horasPromedioDia = metricas.diasActivos30 > 0 ? (metricas.horas30Dias / metricas.diasActivos30) : 0;
                
                if (metricas.horas30Dias === 0) {
                    actividadBadge = '<span class="badge bg-danger" style="font-size: 0.65rem;"><i class="fas fa-times me-1"></i>0h registradas</span>';
                } else if (metricas.horas30Dias < 10) {
                    actividadBadge = `<span class="badge bg-secondary" style="font-size: 0.65rem;"><i class="fas fa-clock me-1"></i>${metricas.horas30Dias}h total</span>`;
                } else if (horasPromedioDia < 2) {
                    actividadBadge = `<span class="badge bg-warning text-dark" style="font-size: 0.65rem;"><i class="fas fa-clock me-1"></i>${Math.round(horasPromedioDia * 10) / 10}h/día</span>`;
                } else if (horasPromedioDia < 4) {
                    actividadBadge = `<span class="badge bg-info" style="font-size: 0.65rem;"><i class="fas fa-check-circle me-1"></i>${Math.round(horasPromedioDia * 10) / 10}h/día</span>`;
                } else if (horasPromedioDia < 6) {
                    actividadBadge = `<span class="badge bg-success" style="font-size: 0.65rem;"><i class="fas fa-check-double me-1"></i>${Math.round(horasPromedioDia * 10) / 10}h/día</span>`;
                } else {
                    actividadBadge = `<span class="badge bg-success" style="font-size: 0.65rem;"><i class="fas fa-fire me-1"></i>${Math.round(horasPromedioDia * 10) / 10}h/día</span>`;
                }
                
                // Formatear horas con color según nivel
                let horas30DiasDisplay = metricas.horas30Dias > 0 
                    ? `<span class="fw-bold" style="color: ${metricas.horas30Dias >= 120 ? '#28a745' : metricas.horas30Dias >= 60 ? '#17a2b8' : metricas.horas30Dias >= 20 ? '#ffc107' : '#6c757d'};">${metricas.horas30Dias}h</span>`
                    : '<span class="text-muted">0h</span>';
                
                // Formatear valor del inventario
                let bodegasInventarioDisplay = '';
                if (metricas.valorInventario > 0) {
                    const valorFormateado = new Intl.NumberFormat('es-CR', {
                        style: 'currency',
                        currency: 'CRC',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(metricas.valorInventario);
                    bodegasInventarioDisplay = `
                        <div style="font-size: 0.7rem;">
                            <span class="fw-bold text-success">${valorFormateado}</span>
                        </div>
                    `;
                } else {
                    bodegasInventarioDisplay = '<span class="text-muted" style="font-size: 0.7rem;">₡0</span>';
                }
                
                return `
                <tr class="table-row-modern" style="font-size: 0.75rem; line-height: 1.2;">
                    <td class="fw-semibold" style="padding: 3px 6px; white-space: nowrap;">${nombreCompleto || 'Sin nombre'}</td>
                    <td style="padding: 3px 6px;">
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <div>${usernameDisplay}</div>
                            ${nombreCorrectoBadge ? `<div>${nombreCorrectoBadge}</div>` : ''}
                        </div>
                    </td>
                    <td class="text-center" style="padding: 3px 6px;">
                        <div class="fecha-ingreso-editable" data-empleado-id="${empleado.id}" style="position: relative;">
                            <div class="fecha-display-wrapper" style="display: inline-flex; align-items: center; gap: 3px; cursor: pointer; padding: 2px 6px; border-radius: 3px; transition: all 0.2s; border: 1px dashed transparent;" 
                                 onmouseover="this.style.borderColor='#28a745'; this.style.background='#f0f8f0';" 
                                 onmouseout="if(!this.querySelector('.fecha-input:focus')) { this.style.borderColor='transparent'; this.style.background=''; }">
                                <span class="fecha-display" style="display: inline-block; font-size: 0.7rem;">
                                    ${fechaIngresoDisplay}
                                </span>
                                <i class="fas fa-edit" style="font-size: 0.6rem; color: #28a745; opacity: 0.7;"></i>
                            </div>
                            <input type="date" 
                                   class="fecha-input" 
                                   value="${fechaIngreso}" 
                                   data-empleado-id="${empleado.id}"
                                   style="display: none; font-size: 0.7rem; padding: 2px 4px; width: 120px; border: 2px solid #28a745; border-radius: 3px; outline: none;"
                                   onblur="guardarFechaIngresoInline('${empleado.id}', this.value)"
                                   onkeydown="if(event.key === 'Enter') { this.blur(); } if(event.key === 'Escape') { cancelarEdicionFecha('${empleado.id}'); }">
                        </div>
                    </td>
                    <td style="padding: 3px 6px; font-size: 0.7rem;">
                        <div style="display: flex; flex-direction: column; gap: 1px;">
                            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                ${horas30DiasDisplay}
                                ${metricas.horas7Dias > 0 ? `<span class="text-muted" style="font-size: 0.65rem;">(${metricas.horas7Dias}h/7d)</span>` : ''}
                            </div>
                            <div style="font-size: 0.65rem;">
                                ${ultimaSesionDisplay}
                                ${metricas.diasActivos30 > 0 ? ` • <span class="text-primary">${metricas.diasActivos30}d</span>` : ''}
                            </div>
                            <div style="margin-top: 1px;">${actividadBadge}</div>
                        </div>
                    </td>
                    <td class="text-center" style="padding: 3px 6px; font-size: 0.7rem;">
                        ${bodegasInventarioDisplay}
                    </td>
                    <td class="text-center" style="padding: 3px 6px;">
                        <div class="permisos-icons" style="display: flex; gap: 2px; justify-content: center; flex-wrap: wrap; max-width: 150px;">
                            ${empleado.permisos?.calendario ? '<i class="fas fa-calendar text-info" title="Calendario" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.empleados ? '<i class="fas fa-users text-primary" title="Empleados" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.registro_horas ? '<i class="fas fa-clock text-warning" title="Registro Horas" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.edicion_horas ? '<i class="fas fa-edit text-secondary" title="Edición Horas" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.reportes_gerenciales ? '<i class="fas fa-chart-bar text-danger" title="Reportes Gerenciales" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.operario_bodega ? '<i class="fas fa-box text-success" title="Operario Bodega" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.administrador_bodega ? '<i class="fas fa-warehouse text-primary" title="Admin Bodega" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.tickets ? '<i class="fas fa-ticket-alt text-info" title="Tickets" style="font-size: 0.65rem;"></i>' : ''}
                            ${empleado.permisos?.recursos_humanos ? '<i class="fas fa-users-cog text-purple" title="Recursos Humanos" style="font-size: 0.65rem;"></i>' : ''}
                        </div>
                    </td>
                    <td class="text-center" style="padding: 3px 6px;">
                        ${estadoBadge}
                    </td>
                    <td style="padding: 3px 6px;">
                        <div style="display: flex; gap: 3px; justify-content: center; flex-wrap: nowrap;">
                            <button class="btn btn-sm ${esActivo ? 'btn-outline-danger' : 'btn-outline-success'} btn-modern" 
                                    onclick="toggleEstadoEmpleado('${empleado.id}', ${esActivo})" 
                                    style="font-size: 0.65rem; padding: 2px 6px;"
                                    title="${esActivo ? 'Desactivar' : 'Activar'}">
                                <i class="fas ${esActivo ? 'fa-ban' : 'fa-check'}" style="font-size: 0.55rem;"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info btn-modern" 
                                    onclick="verCredencialesEmpleado('${empleado.username || ''}')" 
                                    style="font-size: 0.65rem; padding: 2px 6px;"
                                    title="Ver Credenciales">
                                <i class="fas fa-eye" style="font-size: 0.55rem;"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning btn-modern" 
                                    onclick="abrirModalCambiarPassword('${empleado.id}', '${empleado.username || ''}')" 
                                    style="font-size: 0.65rem; padding: 2px 6px;"
                                    title="Ver Contraseña">
                                <i class="fas fa-key" style="font-size: 0.55rem;"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary btn-modern" onclick="editarEmpleado('${empleado.id}')" style="font-size: 0.65rem; padding: 2px 6px;" title="Editar">
                                <i class="fas fa-edit" style="font-size: 0.55rem;"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-modern" 
                                    onclick="eliminarEmpleado('${empleado.id}', '${nombreCompleto || empleado.username || 'este empleado'}')" 
                                    style="font-size: 0.5rem; padding: 1px 4px; opacity: 0.4; transition: opacity 0.3s;"
                                    onmouseover="this.style.opacity='0.7';"
                                    onmouseout="this.style.opacity='0.4';"
                                    title="Eliminar Empleado (Peligroso)">
                                <i class="fas fa-trash-alt" style="font-size: 0.5rem;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Mostrar estadísticas
        function mostrarEstadisticas() {
            const totalEmpleados = empleados.length;
            const empleadosActivos = empleados.filter(e => e.estado === 'Activo').length;
            const empleadosConVehiculo = empleados.filter(e => e.vehiculoAsignado && e.vehiculoAsignado !== '').length;
            const departamentos = [...new Set(empleados.map(e => e.departamento).filter(d => d))].length;

            document.getElementById('totalEmpleados').textContent = totalEmpleados;
            document.getElementById('empleadosActivos').textContent = empleadosActivos;
            document.getElementById('empleadosConVehiculo').textContent = empleadosConVehiculo;
            document.getElementById('departamentos').textContent = departamentos;
        }

        // Obtener clase del badge según el estado
        function getEstadoBadgeClass(estado) {
            switch(estado) {
                case 'Activo': return 'badge-success';
                case 'Inactivo': return 'badge-danger';
                case 'Suspendido': return 'badge-warning';
                case 'Vacaciones': return 'badge-info';
                default: return 'badge-secondary';
            }
        }

        // Función para exportar empleados a CSV
        function exportarEmpleadosCSV() {
            if (!empleados || empleados.length === 0) {
                alert('No hay empleados para exportar');
                return;
            }

            // Crear contenido CSV
            const headers = ['Nombre', 'Apellido', 'Usuario'];
            const rows = empleados.map(empleado => {
                const nombre = empleado.primerNombre || '';
                const apellido = empleado.primerApellido || '';
                const usuario = empleado.username || '';
                
                // Escapar comillas y envolver en comillas si contiene comas
                const escapeCSV = (str) => {
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };
                
                return [
                    escapeCSV(nombre),
                    escapeCSV(apellido),
                    escapeCSV(usuario)
                ].join(',');
            });

            // Combinar headers y rows
            const csvContent = [
                headers.join(','),
                ...rows
            ].join('\n');

            // Crear blob y descargar
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `empleados_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`✅ Exportados ${empleados.length} empleados a CSV`);
        }

        // Hacer fecha de ingreso editable inline
        document.addEventListener('click', function(e) {
            const fechaDisplayWrapper = e.target.closest('.fecha-display-wrapper');
            if (fechaDisplayWrapper) {
                const container = fechaDisplayWrapper.closest('.fecha-ingreso-editable');
                const input = container.querySelector('.fecha-input');
                const displayWrapper = container.querySelector('.fecha-display-wrapper');
                
                if (input && displayWrapper) {
                    displayWrapper.style.display = 'none';
                    input.style.display = 'inline-block';
                    input.focus();
                    // Mostrar el calendario nativo si está disponible
                    input.showPicker && input.showPicker();
                }
            }
        });

        // Cancelar edición de fecha
        window.cancelarEdicionFecha = function(empleadoId) {
            const container = document.querySelector(`.fecha-ingreso-editable[data-empleado-id="${empleadoId}"]`);
            if (!container) return;
            
            const input = container.querySelector('.fecha-input');
            const displayWrapper = container.querySelector('.fecha-display-wrapper');
            
            // Restaurar valor original
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (empleado && input) {
                input.value = empleado.fechaIngreso || '';
            }
            
            // Ocultar input y mostrar display
            if (input) input.style.display = 'none';
            if (displayWrapper) displayWrapper.style.display = 'inline-flex';
        };

        // Guardar fecha de ingreso inline
        window.guardarFechaIngresoInline = async function(empleadoId, nuevaFecha) {
            const container = document.querySelector(`.fecha-ingreso-editable[data-empleado-id="${empleadoId}"]`);
            if (!container) return;
            
            const input = container.querySelector('.fecha-input');
            const displayWrapper = container.querySelector('.fecha-display-wrapper');
            const display = displayWrapper ? displayWrapper.querySelector('.fecha-display') : null;
            
            // Ocultar input y mostrar display
            if (input) input.style.display = 'none';
            if (displayWrapper) displayWrapper.style.display = 'inline-flex';
            
            // Si no hay cambio, no hacer nada
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (!empleado) return;
            
            if (empleado.fechaIngreso === nuevaFecha) {
                return;
            }
            
            try {
                // Actualizar en Firestore
                const updateData = { fechaIngreso: nuevaFecha || null };
                
                // Agregar token CSRF si está disponible
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(updateData);
                }
                
                await updateDoc(doc(db, 'empleados', empleadoId), updateData);
                
                // Actualizar en el array local
                empleado.fechaIngreso = nuevaFecha;
                
                // Actualizar display
                if (display) {
                    if (nuevaFecha) {
                        const fechaObj = new Date(nuevaFecha + 'T00:00:00');
                        display.innerHTML = fechaObj.toLocaleDateString('es-ES', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric' 
                        });
                    } else {
                        display.innerHTML = '<span class="text-muted"><i class="fas fa-calendar-times me-1"></i>Sin fecha</span>';
                    }
                }
                
                // Actualizar input
                if (input) {
                    input.value = nuevaFecha || '';
                }
                
                // Mostrar feedback visual
                if (displayWrapper) {
                    displayWrapper.style.background = '#d4edda';
                    displayWrapper.style.borderColor = '#28a745';
                    setTimeout(() => {
                        displayWrapper.style.background = '';
                        displayWrapper.style.borderColor = 'transparent';
                    }, 1500);
                }
                
                console.log(`✅ Fecha de ingreso actualizada para empleado ${empleadoId}`);
                
            } catch (error) {
                console.error('Error actualizando fecha de ingreso:', error);
                alert('Error al actualizar la fecha de ingreso: ' + error.message);
                
                // Restaurar valor anterior
                if (input) input.value = empleado.fechaIngreso || '';
            }
        };

        // Configurar event listeners
        function configurarEventListeners() {
            btnNuevo.addEventListener('click', () => abrirModal());
            btnGuardar.addEventListener('click', guardarEmpleado);
            
            // Event listener para crear usuario en Firebase Auth
            const btnCrearFirebaseAuth = document.getElementById('btnCrearFirebaseAuth');
            if (btnCrearFirebaseAuth) {
                btnCrearFirebaseAuth.addEventListener('click', window.crearUsuarioFirebaseAuth);
            }
            
            // Event listener para eliminar empleado
            const btnEliminarEmpleado = document.getElementById('btnEliminarEmpleado');
            if (btnEliminarEmpleado) {
                btnEliminarEmpleado.addEventListener('click', window.abrirModalEliminarEmpleado);
            }
            
            // Event listener para confirmar eliminación
            const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminarEmpleado');
            if (btnConfirmarEliminar) {
                btnConfirmarEliminar.addEventListener('click', window.confirmarEliminarEmpleado);
            }
            
            // Event listener para exportar empleados
            const btnExportar = document.getElementById('btnExportarEmpleados');
            if (btnExportar) {
                btnExportar.addEventListener('click', exportarEmpleadosCSV);
            }
        }

        // Función para filtrar por nombre (si se necesita en el futuro)
        window.filtrarPorNombre = function(nombre) {
            if (!nombre || nombre.trim() === '') {
                mostrarEmpleados(empleados);
                return;
            }

            const searchTerm = nombre.trim().toLowerCase();
            const empleadosFiltrados = empleados.filter(empleado => {
                const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.segundoNombre || ''} ${empleado.primerApellido || ''} ${empleado.segundoApellido || ''}`.trim().toLowerCase();
                return nombreCompleto.includes(searchTerm) ||
                    empleado.primerNombre?.toLowerCase().includes(searchTerm) ||
                    empleado.primerApellido?.toLowerCase().includes(searchTerm);
            });

            mostrarEmpleados(empleadosFiltrados);
        };

        // Abrir modal
        function abrirModal(empleadoId = null) {
            currentEmpleadoId = empleadoId;
            const btnCrearFirebaseAuth = document.getElementById('btnCrearFirebaseAuth');
            const btnEliminarEmpleado = document.getElementById('btnEliminarEmpleado');
            
            if (empleadoId) {
                modalTitle.textContent = 'Editar Empleado';
                const empleado = empleados.find(e => e.id === empleadoId);
                
                // Mostrar modal primero
                empleadoModal.show();
                
                // Llenar formulario después de que el modal esté visible
                setTimeout(() => {
                    llenarFormulario(empleado);
                    
                    // Mostrar botón de crear Firebase Auth si el empleado no tiene firebaseAuthUID
                    if (btnCrearFirebaseAuth) {
                        if (empleado.firebaseAuthUID) {
                            btnCrearFirebaseAuth.style.display = 'none';
                        } else {
                            btnCrearFirebaseAuth.style.display = 'inline-block';
                        }
                    }
                    
                    // Mostrar botón de eliminar para empleados existentes
                    if (btnEliminarEmpleado) {
                        btnEliminarEmpleado.style.display = 'inline-block';
                    }
                }, 100);
            } else {
                modalTitle.textContent = 'Nuevo Empleado';
                empleadoForm.reset();
                empleadoModal.show();
                
                // Ocultar botones para empleados nuevos
                if (btnCrearFirebaseAuth) {
                    btnCrearFirebaseAuth.style.display = 'none';
                }
                if (btnEliminarEmpleado) {
                    btnEliminarEmpleado.style.display = 'none';
                }
            }
        }

        // Llenar formulario
        function llenarFormulario(empleado) {
            document.getElementById('cedula').value = empleado.cedula || '';
            document.getElementById('primerNombre').value = empleado.primerNombre || '';
            document.getElementById('segundoNombre').value = empleado.segundoNombre || '';
            document.getElementById('primerApellido').value = empleado.primerApellido || '';
            document.getElementById('segundoApellido').value = empleado.segundoApellido || '';
            document.getElementById('inicial').value = empleado.inicial || '';
            document.getElementById('fechaNacimiento').value = empleado.fechaNacimiento || '';
            document.getElementById('telefonoPersonal').value = empleado.telefonoPersonal || '';
            document.getElementById('telefonoEmpresa').value = empleado.telefonoEmpresa || '';
            document.getElementById('correoPersonal').value = empleado.correoPersonal || '';
            document.getElementById('correoEmpresa').value = empleado.correoEmpresa || '';
            document.getElementById('direccion').value = empleado.direccion || '';
            document.getElementById('salario').value = empleado.salario || '';
            document.getElementById('banco').value = empleado.banco || '';
            document.getElementById('cuentaBancaria').value = empleado.cuentaBancaria || '';
            document.getElementById('fechaIngreso').value = empleado.fechaIngreso || '';
            document.getElementById('cargo').value = empleado.cargo || '';
            document.getElementById('diasVacacionesAntes2025').value = empleado.diasVacacionesAntes2025 || 0;
            document.getElementById('departamento').value = empleado.departamento || '';
            // Tipo de pago (Mensual/Por horas)
            document.getElementById('tipoPago').value = empleado.tipoPago || empleado.tipoContrato || 'Mensual';
            // Tipo de contrato laboral (Tiempo Completo/Medio Tiempo/etc)
            document.getElementById('tipoContrato').value = empleado.tipoContratoLaboral || empleado.tipoContrato || '';
            document.getElementById('estado').value = empleado.estado || '';
            document.getElementById('vehiculoAsignado').value = empleado.vehiculoAsignado || '';
            document.getElementById('tallaCamisa').value = empleado.tallaCamisa || '';
            document.getElementById('tallaPantalon').value = empleado.tallaPantalon || '';
            document.getElementById('tallaZapatos').value = empleado.tallaZapatos || '';
            document.getElementById('licenciaConducir').value = empleado.licenciaConducir || '';
            document.getElementById('vencimientoLicencia').value = empleado.vencimientoLicencia || '';
            document.getElementById('certificaciones').value = empleado.certificaciones || '';
            document.getElementById('especializacion').value = empleado.especializacion || '';
            document.getElementById('notas').value = empleado.notas || '';
            
            // Permisos
            console.log('🔍 Debug llenarFormulario:', {
                empleado: empleado.primerNombre + ' ' + empleado.primerApellido,
                permisos: empleado.permisos,
                registro_horas: empleado.permisos?.registro_horas
            });
            
            document.getElementById('permisoCalendario').checked = empleado.permisos?.calendario || false;
            document.getElementById('permisoEmpleados').checked = empleado.permisos?.empleados || false;
            
            const permisoRegistroHoras = empleado.permisos?.registro_horas || false;
            console.log('🔍 Asignando permisoRegistroHoras:', permisoRegistroHoras);
            document.getElementById('permisoRegistroHoras').checked = permisoRegistroHoras;
            document.getElementById('permisoEdicionHoras').checked = empleado.permisos?.edicion_horas || false;
            document.getElementById('permisoReportesGerenciales').checked = empleado.permisos?.reportes_gerenciales || false;
            document.getElementById('permisoOperarioBodega').checked = empleado.permisos?.operario_bodega || false;
            document.getElementById('permisoAdministradorBodega').checked = empleado.permisos?.administrador_bodega || false;
            document.getElementById('permisoTickets').checked = empleado.permisos?.tickets || false;
            document.getElementById('permisoRecursosHumanos').checked = empleado.permisos?.recursos_humanos || false;
            
            // Verificar que se asignó correctamente
            setTimeout(() => {
                const checkboxValue = document.getElementById('permisoRegistroHoras').checked;
                console.log('🔍 Checkbox permisoRegistroHoras después de asignar:', checkboxValue);
            }, 50);
        }

        // Guardar empleado
        async function guardarEmpleado() {
            const formData = new FormData(empleadoForm);
            
            // Datos básicos del empleado
            const empleadoData = {
                cedula: document.getElementById('cedula').value,
                primerNombre: document.getElementById('primerNombre').value,
                segundoNombre: document.getElementById('segundoNombre').value || null,
                primerApellido: document.getElementById('primerApellido').value,
                segundoApellido: document.getElementById('segundoApellido').value,
                inicial: document.getElementById('inicial').value || null,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                telefonoPersonal: document.getElementById('telefonoPersonal').value,
                telefonoEmpresa: document.getElementById('telefonoEmpresa').value,
                correoPersonal: document.getElementById('correoPersonal').value,
                correoEmpresa: document.getElementById('correoEmpresa').value,
                direccion: document.getElementById('direccion').value,
                salario: parseFloat(document.getElementById('salario').value) || 0,
                banco: document.getElementById('banco').value,
                cuentaBancaria: document.getElementById('cuentaBancaria').value,
                fechaIngreso: document.getElementById('fechaIngreso').value,
                cargo: document.getElementById('cargo').value,
                diasVacacionesAntes2025: parseFloat(document.getElementById('diasVacacionesAntes2025').value) || 0,
                departamento: document.getElementById('departamento').value,
                tipoPago: document.getElementById('tipoPago').value || 'Mensual',
                tipoContrato: document.getElementById('tipoContrato').value || '',
                estado: document.getElementById('estado').value,
                vehiculoAsignado: document.getElementById('vehiculoAsignado').value,
                tallaCamisa: document.getElementById('tallaCamisa').value,
                tallaPantalon: document.getElementById('tallaPantalon').value,
                tallaZapatos: document.getElementById('tallaZapatos').value,
                licenciaConducir: document.getElementById('licenciaConducir').value,
                vencimientoLicencia: document.getElementById('vencimientoLicencia').value,
                certificaciones: document.getElementById('certificaciones').value,
                especializacion: document.getElementById('especializacion').value,
                notas: document.getElementById('notas').value,
                username: `${document.getElementById('primerNombre').value.toLowerCase()}.${document.getElementById('primerApellido').value.toLowerCase()}`
            };
            
            // Generar contraseña aleatoria SOLO para empleados nuevos (no para actualizaciones)
            // Una vez creada, la contraseña NO se puede modificar desde esta página
            let passwordGenerada = null;
            if (!currentEmpleadoId) {
                // Solo generar contraseña para empleados nuevos
                const palabras = ['casa', 'perro', 'gato', 'arbol', 'sol', 'luna', 'mar', 'rio', 'monte', 'cielo', 'nube', 'viento', 'fuego', 'agua', 'tierra', 'flor', 'hoja', 'fruto', 'semilla', 'raiz'];
                const palabraAleatoria = palabras[Math.floor(Math.random() * palabras.length)];
                const digitosAleatorios = Math.floor(1000 + Math.random() * 9000); // 4 dígitos entre 1000 y 9999
                passwordGenerada = palabraAleatoria + digitosAleatorios;
                
                // Guardar contraseña en texto legible y encriptada
                empleadoData.passwordPlain = passwordGenerada; // Contraseña en texto legible
                empleadoData.password = passwordGenerada; // Se encriptará antes de guardar
            }

            // Agregar permisos para todos los empleados (nuevos y existentes)
            empleadoData.permisos = {
                calendario: document.getElementById('permisoCalendario').checked,
                empleados: document.getElementById('permisoEmpleados').checked,
                registro_horas: document.getElementById('permisoRegistroHoras').checked,
                edicion_horas: document.getElementById('permisoEdicionHoras').checked,
                reportes_gerenciales: document.getElementById('permisoReportesGerenciales').checked,
                operario_bodega: document.getElementById('permisoOperarioBodega').checked,
                administrador_bodega: document.getElementById('permisoAdministradorBodega').checked,
                tickets: document.getElementById('permisoTickets').checked,
                recursos_humanos: document.getElementById('permisoRecursosHumanos').checked
            };

            // Guardar si era un empleado nuevo o existente antes de modificar currentEmpleadoId
            const eraEmpleadoNuevo = !currentEmpleadoId;
            let mantenerModalAbierto = false;

            // ========== VERIFICACIÓN INICIAL DE AUTENTICACIÓN ==========
            // Verificar que el usuario esté autenticado antes de continuar
            const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
            const auth = getAuth();
            
            if (!auth.currentUser) {
                console.error('❌ [GUARDAR EMPLEADO] No hay usuario autenticado en Firebase Auth');
                alert('⚠️ Tu sesión expiró. Por favor, recarga la página e inicia sesión nuevamente.');
                
                // Rehabilitar botón
                if (btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Empleado';
                }
                
                // Redirigir a login si no estamos ya ahí
                if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    setTimeout(() => {
                        window.location.replace('iniciar_sesion.html');
                    }, 2000);
                }
                return;
            }
            
            // Verificar que window.authManager tenga el usuario cargado
            if (!window.authManager?.currentUser) {
                console.warn('⚠️ [GUARDAR EMPLEADO] window.authManager.currentUser no está disponible, intentando recargar...');
                
                // Intentar recargar el usuario desde secureAuthManager
                if (window.secureAuthManager) {
                    window.authManager = window.secureAuthManager;
                    // Esperar un momento para que se cargue
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Si aún no hay usuario, mostrar error
                if (!window.authManager?.currentUser) {
                    console.error('❌ [GUARDAR EMPLEADO] No se pudo cargar el usuario autenticado');
                    alert('⚠️ No se pudo verificar tu sesión. Por favor, recarga la página e inicia sesión nuevamente.');
                    
                    // Rehabilitar botón
                    if (btnGuardar) {
                        btnGuardar.disabled = false;
                        btnGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Empleado';
                    }
                    return;
                }
            }
            
            // ========== LOGS DETALLADOS DE DIAGNÓSTICO ==========
            console.group('🔍 [GUARDAR EMPLEADO] Diagnóstico Completo');
            
            // 1. Información del usuario autenticado
            const currentUser = window.authManager?.currentUser;
            console.log('1️⃣ USUARIO AUTENTICADO:', {
                existe: !!currentUser,
                id: currentUser?.id,
                username: currentUser?.username,
                nombre: currentUser?.nombre,
                email: currentUser?.email,
                uid: currentUser?.uid,
                firebaseUID: currentUser?.firebaseUID,
                firebaseAuthUID: currentUser?.firebaseAuthUID,
                permisos: currentUser?.permisos,
                tienePermisoEmpleados: currentUser?.permisos?.empleados || false
            });
            
            // 2. Obtener UID de Firebase Auth directamente
            let firebaseAuthUID = null;
            let firebaseAuthEmail = null;
            try {
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                const auth = getAuth();
                if (auth.currentUser) {
                    firebaseAuthUID = auth.currentUser.uid;
                    firebaseAuthEmail = auth.currentUser.email;
                    console.log('2️⃣ FIREBASE AUTH DIRECTAMENTE:', {
                        uid: firebaseAuthUID,
                        email: firebaseAuthEmail,
                        emailVerified: auth.currentUser.emailVerified,
                        tokenDisponible: !!auth.currentUser.accessToken
                    });
                    
                    // Intentar obtener el token para ver su contenido
                    try {
                        const token = await auth.currentUser.getIdTokenResult();
                        console.log('3️⃣ TOKEN DE FIREBASE AUTH:', {
                            email: token.claims.email || 'NO DISPONIBLE',
                            firebase: token.claims.firebase || 'NO DISPONIBLE',
                            identities: token.claims.firebase?.identities || 'NO DISPONIBLE',
                            emailEnToken: token.claims.email || token.claims.firebase?.identities?.email?.[0] || 'NO DISPONIBLE'
                        });
                    } catch (tokenError) {
                        console.warn('⚠️ No se pudo obtener el token:', tokenError);
                    }
                } else {
                    console.warn('⚠️ auth.currentUser es null');
                }
            } catch (authError) {
                console.error('❌ Error obteniendo Firebase Auth:', authError);
            }
            
            // 3. Información del documento a crear/actualizar
            const docId = currentEmpleadoId || empleadoData.username;
            console.log('4️⃣ DOCUMENTO A CREAR/ACTUALIZAR:', {
                esNuevo: !currentEmpleadoId,
                docId: docId,
                username: empleadoData.username,
                primerNombre: empleadoData.primerNombre,
                primerApellido: empleadoData.primerApellido,
                tienePermisos: !!empleadoData.permisos,
                permisosEmpleados: empleadoData.permisos?.empleados || false
            });
            
            // 4. Verificar si el documento existe
            try {
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                const docRef = doc(db, 'empleados', docId);
                const docSnap = await getDoc(docRef);
                console.log('5️⃣ ESTADO DEL DOCUMENTO EN FIRESTORE:', {
                    existe: docSnap.exists(),
                    docId: docId,
                    datos: docSnap.exists() ? docSnap.data() : 'NO EXISTE'
                });
            } catch (docError) {
                console.warn('⚠️ No se pudo verificar el documento:', docError);
            }
            
            // 5. Verificar documento del usuario autenticado
            try {
                const { getFirestore, doc, getDoc, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                // Intentar por username
                if (currentUser?.username) {
                    const userDocRef = doc(db, 'empleados', currentUser.username);
                    const userDocSnap = await getDoc(userDocRef);
                    console.log('6️⃣ DOCUMENTO DEL USUARIO AUTENTICADO (por username):', {
                        username: currentUser.username,
                        existe: userDocSnap.exists(),
                        idBuscado: currentUser.username,
                        idEncontrado: userDocSnap.exists() ? userDocSnap.id : 'NO EXISTE',
                        datos: userDocSnap.exists() ? {
                            id: userDocSnap.id,
                            username: userDocSnap.data().username,
                            firebaseAuthUID: userDocSnap.data().firebaseAuthUID || 'NO',
                            permisos: userDocSnap.data().permisos,
                            tienePermisoEmpleados: userDocSnap.data().permisos?.empleados || false
                        } : 'NO EXISTE'
                    });
                    
                    // Si no existe por username, buscar en TODOS los documentos
                    if (!userDocSnap.exists()) {
                        console.log('🔍 Documento no encontrado por username, buscando en TODOS los documentos...');
                        try {
                            const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                            let documentosCoincidentes = [];
                            
                            empleadosSnapshot.forEach(doc => {
                                const emp = { id: doc.id, ...doc.data() };
                                // Buscar por username
                                if (emp.username === currentUser.username) {
                                    documentosCoincidentes.push({ tipo: 'username', documento: emp });
                                }
                                // Buscar por firebaseAuthUID
                                if (firebaseAuthUID && emp.firebaseAuthUID === firebaseAuthUID) {
                                    documentosCoincidentes.push({ tipo: 'firebaseAuthUID', documento: emp });
                                }
                                // Buscar por nombre
                                if (emp.primerNombre === 'Pablo' && emp.primerApellido === 'Paniagua') {
                                    documentosCoincidentes.push({ tipo: 'nombre', documento: emp });
                                }
                            });
                            
                            if (documentosCoincidentes.length > 0) {
                                console.log('✅ DOCUMENTOS ENCONTRADOS (con ID diferente):', documentosCoincidentes);
                                documentosCoincidentes.forEach((item, index) => {
                                    console.log(`\n📄 Documento ${index + 1} (encontrado por ${item.tipo}):`);
                                    console.log('   - ID del documento:', item.documento.id);
                                    console.log('   - Username:', item.documento.username);
                                    console.log('   - firebaseAuthUID:', item.documento.firebaseAuthUID || 'NO');
                                    console.log('   - Permisos:', item.documento.permisos);
                                    console.log('   - ¿Tiene permiso empleados?', item.documento.permisos?.empleados || false);
                                    console.log('   ⚠️ PROBLEMA: El ID del documento ("' + item.documento.id + '") NO coincide con el username ("' + currentUser.username + '")');
                                    console.log('   💡 SOLUCIÓN: El documento debe tener ID = username para que las reglas funcionen');
                                });
                            } else {
                                console.error('❌ No se encontró ningún documento que coincida');
                            }
                        } catch (searchError) {
                            console.error('❌ Error buscando en todos los documentos:', searchError);
                        }
                    }
                }
                
                // Intentar por UID
                if (firebaseAuthUID) {
                    const uidDocRef = doc(db, 'empleados', firebaseAuthUID);
                    const uidDocSnap = await getDoc(uidDocRef);
                    console.log('7️⃣ DOCUMENTO DEL USUARIO AUTENTICADO (por UID):', {
                        uid: firebaseAuthUID,
                        existe: uidDocSnap.exists(),
                        idBuscado: firebaseAuthUID,
                        idEncontrado: uidDocSnap.exists() ? uidDocSnap.id : 'NO EXISTE',
                        datos: uidDocSnap.exists() ? {
                            id: uidDocSnap.id,
                            username: uidDocSnap.data().username,
                            firebaseAuthUID: uidDocSnap.data().firebaseAuthUID || 'NO',
                            permisos: uidDocSnap.data().permisos,
                            tienePermisoEmpleados: uidDocSnap.data().permisos?.empleados || false
                        } : 'NO EXISTE'
                    });
                }
            } catch (userDocError) {
                console.error('❌ Error verificando documento del usuario:', userDocError);
                console.error('   Error completo:', userDocError);
            }
            
            // 6. Resumen de verificación de permisos
            const tienePermiso = window.authManager?.hasPermission('empleados');
            console.log('8️⃣ VERIFICACIÓN DE PERMISOS:', {
                tienePermiso: tienePermiso,
                metodo: 'window.authManager.hasPermission("empleados")',
                authManagerExiste: !!window.authManager,
                currentUserExiste: !!window.authManager?.currentUser
            });
            
            console.log('9️⃣ OPERACIÓN A REALIZAR:', {
                tipo: currentEmpleadoId ? 'UPDATE' : 'CREATE',
                docId: docId,
                coleccion: 'empleados'
            });
            
            console.groupEnd();
            // ========== FIN DE LOGS DETALLADOS ==========

            try {
                if (currentEmpleadoId) {
                    // Para empleados existentes, actualizar todos los campos EXCEPTO contraseña
                    // IMPORTANTE: La contraseña NO se puede modificar desde esta página una vez creada
                    // Obtener el documento actual para preservar passwordPlain y password
                    const empleadoDocRef = doc(db, 'empleados', currentEmpleadoId);
                    const empleadoDocSnap = await getDoc(empleadoDocRef);
                    
                    if (empleadoDocSnap.exists()) {
                        const datosActuales = empleadoDocSnap.data();
                        // Preservar password y passwordPlain del documento existente
                        empleadoData.password = datosActuales.password;
                        empleadoData.passwordPlain = datosActuales.passwordPlain;
                        empleadoData.passwordEncrypted = datosActuales.passwordEncrypted;
                        empleadoData.passwordMigrationDate = datosActuales.passwordMigrationDate;
                        // No incluir passwordChangedDate ya que no se está cambiando
                    }
                    
                    // Agregar token CSRF antes de actualizar
                    if (window.csrfProtection) {
                        window.csrfProtection.addTokenToData(empleadoData);
                    }
                    console.log('🔄 Intentando actualizar empleado...', { docId: currentEmpleadoId });
                    await updateDoc(empleadoDocRef, empleadoData);
                    console.log('✅ Empleado actualizado (contraseña preservada, no modificada)');
                    
                    // Para empleados existentes, verificar si mostrar el botón
                    const empleadoActualizado = empleados.find(e => e.id === currentEmpleadoId);
                    const btnCrearFirebaseAuth = document.getElementById('btnCrearFirebaseAuth');
                    if (btnCrearFirebaseAuth && empleadoActualizado) {
                        if (empleadoActualizado.firebaseAuthUID) {
                            btnCrearFirebaseAuth.style.display = 'none';
                        } else {
                            btnCrearFirebaseAuth.style.display = 'inline-block';
                        }
                    }
                } else {
                    // Para empleados nuevos, encriptar contraseña antes de guardar
                    // Mantener passwordPlain en texto legible para consulta
                    if (!passwordGenerada) {
                        // Si por alguna razón no se generó contraseña, generar una ahora
                        const palabras = ['casa', 'perro', 'gato', 'arbol', 'sol', 'luna', 'mar', 'rio', 'monte', 'cielo', 'nube', 'viento', 'fuego', 'agua', 'tierra', 'flor', 'hoja', 'fruto', 'semilla', 'raiz'];
                        const palabraAleatoria = palabras[Math.floor(Math.random() * palabras.length)];
                        const digitosAleatorios = Math.floor(1000 + Math.random() * 9000);
                        passwordGenerada = palabraAleatoria + digitosAleatorios;
                        empleadoData.passwordPlain = passwordGenerada;
                        empleadoData.password = passwordGenerada;
                    }
                    
                    const passwordPlain = empleadoData.passwordPlain;
                    if (empleadoData.password) {
                        empleadoData.password = await window.authManager.hashPassword(empleadoData.password);
                        empleadoData.passwordEncrypted = true;
                        empleadoData.passwordMigrationDate = new Date().toISOString();
                    }
                    // Asegurar que passwordPlain se mantenga en texto legible
                    empleadoData.passwordPlain = passwordPlain;
                    
                    // Agregar token CSRF antes de crear
                    if (window.csrfProtection) {
                        window.csrfProtection.addTokenToData(empleadoData);
                    }
                    
                    // Usar el username como ID del documento para que las reglas de Firestore puedan encontrarlo
                    const usernameComoId = empleadoData.username;
                    const docRef = doc(db, 'empleados', usernameComoId);
                    console.log('🔄 Intentando crear empleado...', { 
                        docId: usernameComoId,
                        datos: {
                            primerNombre: empleadoData.primerNombre,
                            primerApellido: empleadoData.primerApellido,
                            username: empleadoData.username,
                            tienePermisos: !!empleadoData.permisos,
                            permisosEmpleados: empleadoData.permisos?.empleados || false
                        }
                    });
                    await setDoc(docRef, empleadoData);
                    console.log('✅ Empleado creado con contraseña encriptada (ID: ' + usernameComoId + ')');
                    
                    // Actualizar currentEmpleadoId para que el botón de Firebase Auth funcione
                    currentEmpleadoId = usernameComoId;
                    
                    // Crear usuario en Firebase Auth automáticamente con la contraseña generada
                    const usernameGenerado = empleadoData.username;
                    const passwordParaFirebase = passwordPlain; // Usar la contraseña generada (passwordPlain ya contiene la contraseña)
                    
                    try {
                        console.log('🔄 Creando usuario en Firebase Auth automáticamente...');
                        const resultadoFirebaseAuth = await window.authManager.createUserInFirebaseAuth(
                            usernameGenerado,
                            passwordParaFirebase
                        );
                        
                        if (resultadoFirebaseAuth.success) {
                            console.log('✅ Usuario creado en Firebase Auth:', resultadoFirebaseAuth.email);
                            // Actualizar el empleado local con la información de Firebase Auth
                            const empleadoActualizado = empleados.find(e => e.id === currentEmpleadoId);
                            if (empleadoActualizado) {
                                empleadoActualizado.firebaseAuthUID = resultadoFirebaseAuth.uid;
                                empleadoActualizado.firebaseAuthEmail = resultadoFirebaseAuth.email;
                            }
                            
                            // Mostrar información de credenciales al usuario
                    alert(`✅ Empleado creado exitosamente\n\n` +
                          `Credenciales de acceso:\n` +
                          `Username: ${usernameGenerado}\n` +
                                  `Password: ${passwordParaFirebase}\n\n` +
                                  `✅ Usuario creado automáticamente en Firebase Auth\n` +
                                  `Email: ${resultadoFirebaseAuth.email}\n\n` +
                          `El empleado puede iniciar sesión inmediatamente.`);
                        } else {
                            // Si falla la creación en Firebase Auth, mostrar advertencia pero no bloquear
                            console.warn('⚠️ No se pudo crear usuario en Firebase Auth:', resultadoFirebaseAuth.error);
                            alert(`✅ Empleado creado exitosamente\n\n` +
                                  `Credenciales de acceso:\n` +
                                  `Username: ${usernameGenerado}\n` +
                                  `Password: ${passwordParaFirebase}\n\n` +
                                  `⚠️ Advertencia: No se pudo crear el usuario en Firebase Auth automáticamente.\n` +
                                  `Error: ${resultadoFirebaseAuth.error}\n\n` +
                                  `Puedes crear el usuario manualmente usando el botón "Crear en Firebase Auth".`);
                            
                            // Mostrar botón de crear Firebase Auth como fallback
                            const btnCrearFirebaseAuth = document.getElementById('btnCrearFirebaseAuth');
                            if (btnCrearFirebaseAuth) {
                                btnCrearFirebaseAuth.style.display = 'inline-block';
                                mantenerModalAbierto = true; // Mantener abierto si falló Firebase Auth
                            }
                        }
                    } catch (error) {
                        // Si hay un error inesperado, mostrar advertencia pero no bloquear
                        console.error('❌ Error inesperado creando usuario en Firebase Auth:', error);
                        alert(`✅ Empleado creado exitosamente\n\n` +
                              `Credenciales de acceso:\n` +
                              `Username: ${usernameGenerado}\n` +
                              `Password: ${passwordParaFirebase}\n\n` +
                              `⚠️ Advertencia: Error inesperado al crear usuario en Firebase Auth.\n` +
                              `Error: ${error.message}\n\n` +
                              `Puedes crear el usuario manualmente usando el botón "Crear en Firebase Auth".`);
                        
                        // Mostrar botón de crear Firebase Auth como fallback
                        const btnCrearFirebaseAuth = document.getElementById('btnCrearFirebaseAuth');
                        if (btnCrearFirebaseAuth) {
                            btnCrearFirebaseAuth.style.display = 'inline-block';
                            mantenerModalAbierto = true; // Mantener abierto si falló Firebase Auth
                        }
                    }
                }
                
                // Recargar datos para actualizar la información
                await cargarDatos();
                
                // Cerrar el modal solo si no se debe mantener abierto
                // (solo se mantiene abierto si es empleado nuevo y falló Firebase Auth)
                if (!mantenerModalAbierto) {
                empleadoModal.hide();
                    // Resetear currentEmpleadoId
                    currentEmpleadoId = null;
                }
                
            } catch (error) {
                console.group('❌ [ERROR GUARDANDO EMPLEADO] Diagnóstico Completo del Error');
                console.error('Código del error:', error.code);
                console.error('Mensaje del error:', error.message);
                console.error('Stack trace:', error.stack);
                console.error('Error completo:', error);
                
                // Si es un error de permisos, mostrar información de diagnóstico MUY detallada
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    console.group('🔍 Diagnóstico Detallado de Permisos');
                    
                    // 1. Información del usuario autenticado
                    const currentUser = window.authManager?.currentUser;
                    console.log('1️⃣ USUARIO AUTENTICADO (window.authManager.currentUser):', {
                        existe: !!currentUser,
                        completo: currentUser,
                        id: currentUser?.id,
                        username: currentUser?.username,
                        nombre: currentUser?.nombre,
                        email: currentUser?.email,
                        uid: currentUser?.uid,
                        firebaseUID: currentUser?.firebaseUID,
                        firebaseAuthUID: currentUser?.firebaseAuthUID,
                        permisos: currentUser?.permisos,
                        tienePermisoEmpleados: currentUser?.permisos?.empleados || false
                    });
                    
                    // 2. Firebase Auth directamente
                    try {
                        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                        const auth = getAuth();
                        if (auth.currentUser) {
                            console.log('2️⃣ FIREBASE AUTH (auth.currentUser):', {
                                uid: auth.currentUser.uid,
                                email: auth.currentUser.email,
                                emailVerified: auth.currentUser.emailVerified,
                                displayName: auth.currentUser.displayName,
                                providerData: auth.currentUser.providerData
                            });
                            
                            // Obtener token completo
                            try {
                                const token = await auth.currentUser.getIdTokenResult();
                                console.log('3️⃣ TOKEN DE FIREBASE AUTH (getIdTokenResult):', {
                                    email: token.claims.email || 'NO DISPONIBLE',
                                    firebase: token.claims.firebase || 'NO DISPONIBLE',
                                    identities: token.claims.firebase?.identities || 'NO DISPONIBLE',
                                    emailEnIdentities: token.claims.firebase?.identities?.email?.[0] || 'NO DISPONIBLE',
                                    todasLasClaims: token.claims
                                });
                                
                                // Extraer username del email si está disponible
                                const emailDelToken = token.claims.email || token.claims.firebase?.identities?.email?.[0] || '';
                                const usernameDelToken = emailDelToken ? emailDelToken.replace('rh+', '').replace('@ecoplagascr.com', '') : '';
                                console.log('4️⃣ USERNAME EXTRAÍDO DEL TOKEN:', {
                                    emailDelToken: emailDelToken,
                                    usernameDelToken: usernameDelToken,
                                    usernameCoincide: usernameDelToken === currentUser?.username
                                });
                            } catch (tokenError) {
                                console.error('❌ Error obteniendo token:', tokenError);
                            }
                        } else {
                            console.error('❌ auth.currentUser es NULL');
                        }
                    } catch (authError) {
                        console.error('❌ Error obteniendo Firebase Auth:', authError);
                    }
                    
                    // 3. Verificar documento en Firestore
                    try {
                        const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                        const db = getFirestore();
                        const authInstance = getAuth();
                        
                        // Por username
                        if (currentUser?.username) {
                            const userDocRef = doc(db, 'empleados', currentUser.username);
                            const userDocSnap = await getDoc(userDocRef);
                            console.log('5️⃣ DOCUMENTO EN FIRESTORE (por username):', {
                                username: currentUser.username,
                                existe: userDocSnap.exists(),
                                id: userDocSnap.exists() ? userDocSnap.id : 'NO EXISTE',
                                datos: userDocSnap.exists() ? {
                                    username: userDocSnap.data().username,
                                    firebaseAuthUID: userDocSnap.data().firebaseAuthUID || 'NO',
                                    firebaseAuthEmail: userDocSnap.data().firebaseAuthEmail || 'NO',
                                    permisos: userDocSnap.data().permisos,
                                    tienePermisoEmpleados: userDocSnap.data().permisos?.empleados || false,
                                    todosLosDatos: userDocSnap.data()
                                } : 'NO EXISTE'
                            });
                            
                            if (!userDocSnap.exists()) {
                                console.error('❌ PROBLEMA CRÍTICO: El documento de pablo.paniagua NO EXISTE en Firestore');
                                console.error('   Las reglas de Firestore no pueden verificar los permisos si el documento no existe');
                                console.error('   SOLUCIÓN: El documento debe existir con ID = "pablo.paniagua" y tener permisos.empleados = true');
                            }
                        }
                        
                        // Por UID
                        if (authInstance?.currentUser?.uid) {
                            const uidDocRef = doc(db, 'empleados', authInstance.currentUser.uid);
                            const uidDocSnap = await getDoc(uidDocRef);
                            console.log('6️⃣ DOCUMENTO EN FIRESTORE (por UID):', {
                                uid: authInstance.currentUser.uid,
                                existe: uidDocSnap.exists(),
                                id: uidDocSnap.exists() ? uidDocSnap.id : 'NO EXISTE',
                                datos: uidDocSnap.exists() ? {
                                    username: uidDocSnap.data().username,
                                    firebaseAuthUID: uidDocSnap.data().firebaseAuthUID || 'NO',
                                    permisos: uidDocSnap.data().permisos,
                                    tienePermisoEmpleados: uidDocSnap.data().permisos?.empleados || false
                                } : 'NO EXISTE'
                            });
                        }
                    } catch (docError) {
                        console.error('❌ Error verificando documento:', docError);
                    }
                    
                    // 4. Verificar permiso usando el método del authManager
                    const tienePermiso = window.authManager?.hasPermission('empleados');
                    console.log('7️⃣ VERIFICACIÓN DE PERMISOS:', {
                        tienePermiso: tienePermiso,
                        metodo: 'window.authManager.hasPermission("empleados")',
                        authManagerExiste: !!window.authManager,
                        currentUserExiste: !!window.authManager?.currentUser
                    });
                    
                    // 5. Análisis del problema
                    console.group('8️⃣ ANÁLISIS DEL PROBLEMA:');
                    const problemas = [];
                    
                    if (!currentUser) {
                        problemas.push('❌ No hay usuario autenticado en window.authManager.currentUser');
                    }
                    if (!currentUser?.username) {
                        problemas.push('❌ El usuario no tiene username');
                    }
                    if (!currentUser?.permisos?.empleados) {
                        problemas.push('❌ El usuario no tiene el permiso "empleados: true" en window.authManager.currentUser.permisos');
                    }
                    // Verificar Firebase Auth
                    let authInstance = null;
                    try {
                        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                        authInstance = getAuth();
                    } catch (e) {
                        console.warn('No se pudo obtener auth:', e);
                    }
                    
                    if (!authInstance?.currentUser) {
                        problemas.push('❌ No hay usuario autenticado en Firebase Auth (auth.currentUser)');
                    }
                    if (!authInstance?.currentUser?.email) {
                        problemas.push('⚠️ El usuario de Firebase Auth no tiene email (esto puede causar problemas en las reglas)');
                    }
                    
                    // Verificar si el documento existe en Firestore
                    try {
                        const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        const db = getFirestore();
                        
                        if (currentUser?.username) {
                            const userDocRef = doc(db, 'empleados', currentUser.username);
                            const userDocSnap = await getDoc(userDocRef);
                            if (!userDocSnap.exists()) {
                                problemas.push(`❌ PROBLEMA CRÍTICO: El documento "${currentUser.username}" NO EXISTE en Firestore`);
                                problemas.push(`   Las reglas de Firestore no pueden verificar permisos si el documento no existe`);
                                problemas.push(`   SOLUCIÓN: Ejecuta window.corregirPabloPaniagua() para crear/corregir el documento`);
                                
                                // Ofrecer crear el documento automáticamente
                                console.warn('💡 SOLUCIÓN AUTOMÁTICA DISPONIBLE:');
                                console.warn('   Ejecuta en la consola: window.corregirPabloPaniagua()');
                                console.warn('   Esto creará/corregirá el documento automáticamente');
                            }
                        }
                        
                        if (authInstance?.currentUser?.uid) {
                            const uidDocRef = doc(db, 'empleados', authInstance.currentUser.uid);
                            const uidDocSnap = await getDoc(uidDocRef);
                            if (!uidDocSnap.exists() && !currentUser?.username) {
                                problemas.push(`❌ PROBLEMA CRÍTICO: El documento con ID = UID ("${authInstance.currentUser.uid}") NO EXISTE en Firestore`);
                            }
                        }
                    } catch (docCheckError) {
                        console.warn('No se pudo verificar documento:', docCheckError);
                    }
                    
                    if (problemas.length > 0) {
                        console.error('PROBLEMAS ENCONTRADOS:');
                        problemas.forEach((p, i) => console.error(`${i + 1}. ${p}`));
                    } else {
                        console.log('✅ No se encontraron problemas obvios en el cliente');
                        console.warn('⚠️ El problema puede estar en las reglas de Firestore');
                        console.warn('   Las reglas intentan encontrar el documento del usuario autenticado');
                        console.warn('   Si el email no está disponible, las reglas pueden fallar');
                    }
                    console.groupEnd();
                    
                    console.groupEnd();
                    
                    alert('❌ Error de permisos al guardar empleado.\n\n' +
                          'Revisa la consola para ver el diagnóstico completo.\n\n' +
                          'Posibles causas:\n' +
                          '1. Tu documento en Firestore no tiene el ID = tu username\n' +
                          '2. Tu documento no tiene el permiso "empleados: true"\n' +
                          '3. Tu documento no tiene firebaseAuthUID configurado\n' +
                          '4. El email no está disponible en el token de Firebase Auth\n\n' +
                          'Ejecuta: window.diagnosticarPermisosEmpleados() para más detalles.');
                } else {
                    console.error('Error no relacionado con permisos:', error);
                    alert('Error guardando empleado. Inténtalo de nuevo.\n\nRevisa la consola para más detalles.');
                }
                
                console.groupEnd();
            }
        }
        
        // Función de diagnóstico para verificar permisos del usuario actual
        window.diagnosticarPermisosEmpleados = async function() {
            console.group('🔍 Diagnóstico de Permisos para Crear Empleados');
            
            if (!window.authManager) {
                console.error('❌ window.authManager no está disponible');
                console.groupEnd();
                return;
            }
            
            const currentUser = window.authManager.currentUser;
            if (!currentUser) {
                console.error('❌ No hay usuario autenticado');
                console.groupEnd();
                return;
            }
            
            console.log('✅ Usuario autenticado:', currentUser);
            console.log('📧 Email:', currentUser.email);
            console.log('👤 Username:', currentUser.username);
            
            // Obtener UID de diferentes fuentes
            const uid = currentUser.uid || currentUser.firebaseUID || currentUser.firebaseAuthUID;
            console.log('🆔 UID:', uid);
            console.log('   - currentUser.uid:', currentUser.uid);
            console.log('   - currentUser.firebaseUID:', currentUser.firebaseUID);
            console.log('   - currentUser.firebaseAuthUID:', currentUser.firebaseAuthUID);
            
            // Intentar obtener UID de Firebase Auth directamente
            let firebaseAuthUID = null;
            try {
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                const auth = getAuth();
                if (auth.currentUser) {
                    firebaseAuthUID = auth.currentUser.uid;
                    console.log('   - Firebase Auth UID:', firebaseAuthUID);
                }
            } catch (e) {
                console.warn('   - No se pudo obtener UID de Firebase Auth:', e);
            }
            
            const uidFinal = uid || firebaseAuthUID;
            console.log('🔑 Permisos:', currentUser.permisos);
            
            // Verificar permiso de empleados
            const tienePermiso = window.authManager.hasPermission('empleados');
            console.log('✅ ¿Tiene permiso de empleados?', tienePermiso);
            
            // Buscar el documento del empleado en Firestore
            try {
                const { getFirestore, doc, getDoc, updateDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                let documentoEncontrado = null;
                let documentoPorUsername = null;
                let documentoPorUid = null;
                
                // Intentar buscar por username (ID del documento)
                if (currentUser.username) {
                    const docRef = doc(db, 'empleados', currentUser.username);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        documentoPorUsername = { id: docSnap.id, ...docSnap.data() };
                        documentoEncontrado = documentoPorUsername;
                        console.log('✅ Documento encontrado por username (ID):', currentUser.username);
                        console.log('📄 Datos del documento:', documentoPorUsername);
                        
                        // Verificar que tenga el permiso empleados
                        if (!documentoPorUsername.permisos || !documentoPorUsername.permisos.empleados) {
                            console.error('❌ PROBLEMA: El documento NO tiene el permiso "empleados: true"');
                            console.log('📝 Permisos actuales:', documentoPorUsername.permisos);
                            
                            // Preguntar si quiere corregirlo
                            const corregir = confirm('El documento no tiene el permiso "empleados: true".\n\n¿Deseas agregarlo automáticamente?');
                            if (corregir) {
                                try {
                                    const permisosActualizados = {
                                        ...(documentoPorUsername.permisos || {}),
                                        empleados: true
                                    };
                                    await updateDoc(docRef, { permisos: permisosActualizados });
                                    console.log('✅ Permiso "empleados" agregado correctamente');
                                    alert('✅ Permiso "empleados" agregado correctamente. Recarga la página.');
                                } catch (error) {
                                    console.error('❌ Error al actualizar permisos:', error);
                                    alert('❌ Error al actualizar permisos: ' + error.message);
                                }
                            }
                        } else {
                            console.log('✅ El documento tiene el permiso "empleados: true"');
                        }
                        
                        // Verificar que tenga firebaseAuthUID
                        if (!documentoPorUsername.firebaseAuthUID && uidFinal) {
                            console.warn('⚠️ El documento NO tiene firebaseAuthUID configurado');
                            const corregir = confirm('El documento no tiene firebaseAuthUID configurado.\n\n¿Deseas agregarlo automáticamente?');
                            if (corregir) {
                                try {
                                    await updateDoc(docRef, { 
                                        firebaseAuthUID: uidFinal,
                                        firebaseAuthEmail: currentUser.email || `rh+${currentUser.username}@ecoplagascr.com`
                                    });
                                    console.log('✅ firebaseAuthUID agregado correctamente');
                                    alert('✅ firebaseAuthUID agregado correctamente. Recarga la página.');
                                } catch (error) {
                                    console.error('❌ Error al actualizar firebaseAuthUID:', error);
                                    alert('❌ Error al actualizar firebaseAuthUID: ' + error.message);
                                }
                            }
                        } else if (documentoPorUsername.firebaseAuthUID) {
                            console.log('✅ El documento tiene firebaseAuthUID:', documentoPorUsername.firebaseAuthUID);
                            if (uidFinal && documentoPorUsername.firebaseAuthUID !== uidFinal) {
                                console.warn('⚠️ ADVERTENCIA: El firebaseAuthUID del documento no coincide con el UID del usuario autenticado');
                                console.warn('   Documento firebaseAuthUID:', documentoPorUsername.firebaseAuthUID);
                                console.warn('   Usuario UID:', uidFinal);
                            }
                        }
                    } else {
                        console.warn('⚠️ Documento NO encontrado por username (ID):', currentUser.username);
                    }
                }
                
                // Intentar buscar por UID (ID del documento)
                if (uidFinal) {
                    const docRef = doc(db, 'empleados', uidFinal);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        documentoPorUid = { id: docSnap.id, ...docSnap.data() };
                        console.log('✅ Documento encontrado por UID (ID):', uidFinal);
                        console.log('📄 Datos del documento:', documentoPorUid);
                        
                        if (!documentoEncontrado) {
                            documentoEncontrado = documentoPorUid;
                        }
                    } else {
                        console.warn('⚠️ Documento NO encontrado por UID (ID):', uidFinal);
                    }
                }
                
                // Si no encontramos el documento, buscar en TODOS los documentos
                if (!documentoEncontrado) {
                    console.log('\n🔍 Buscando en TODOS los documentos de empleados...');
                    try {
                        const { getFirestore, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        const db = getFirestore();
                        const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                        
                        let documentosCoincidentes = [];
                        empleadosSnapshot.forEach(doc => {
                            const emp = { id: doc.id, ...doc.data() };
                            // Buscar por username
                            if (emp.username === currentUser.username) {
                                documentosCoincidentes.push({ tipo: 'username', documento: emp });
                            }
                            // Buscar por firebaseAuthUID si tenemos UID
                            if (uidFinal && emp.firebaseAuthUID === uidFinal) {
                                documentosCoincidentes.push({ tipo: 'firebaseAuthUID', documento: emp });
                            }
                            // Buscar por firebaseAuthEmail si tenemos email
                            if (currentUser.email && emp.firebaseAuthEmail === currentUser.email) {
                                documentosCoincidentes.push({ tipo: 'firebaseAuthEmail', documento: emp });
                            }
                            // Buscar por firebaseUID también
                            if (uidFinal && emp.firebaseUID === uidFinal) {
                                documentosCoincidentes.push({ tipo: 'firebaseUID', documento: emp });
                            }
                        });
                        
                        if (documentosCoincidentes.length > 0) {
                            console.log('✅ Encontrados documentos coincidentes:');
                            documentosCoincidentes.forEach((item, index) => {
                                console.log(`\n📄 Documento ${index + 1} (encontrado por ${item.tipo}):`);
                                console.log('   - ID del documento:', item.documento.id);
                                console.log('   - Username:', item.documento.username);
                                console.log('   - firebaseAuthUID:', item.documento.firebaseAuthUID || 'NO');
                                console.log('   - firebaseAuthEmail:', item.documento.firebaseAuthEmail || 'NO');
                                console.log('   - Permisos:', item.documento.permisos);
                                console.log('   - ¿Tiene permiso empleados?', item.documento.permisos?.empleados || false);
                            });
                            
                            // Si encontramos un documento, usarlo
                            documentoEncontrado = documentosCoincidentes[0].documento;
                            
                            // Verificar si el ID del documento es diferente al username
                            if (documentoEncontrado.id !== currentUser.username) {
                                console.error('\n❌ PROBLEMA: El documento tiene un ID diferente al username');
                                console.error('   ID del documento:', documentoEncontrado.id);
                                console.error('   Username esperado:', currentUser.username);
                                console.error('\n💡 SOLUCIÓN: El documento debe tener el ID = username para que las reglas de Firestore funcionen.');
                                console.error('   Puedes corregir esto manualmente en Firestore Console o crear un nuevo documento con el ID correcto.');
                            }
                        } else {
                            console.error('❌ No se encontró ningún documento que coincida con el usuario autenticado');
                        }
                    } catch (error) {
                        console.error('❌ Error al buscar en todos los documentos:', error);
                    }
                }
                
                // Resumen
                console.log('\n📊 RESUMEN:');
                if (documentoEncontrado) {
                    console.log('✅ Documento encontrado:', documentoEncontrado.id);
                    console.log('   - Tiene permiso empleados:', documentoEncontrado.permisos?.empleados || false);
                    console.log('   - Tiene firebaseAuthUID:', documentoEncontrado.firebaseAuthUID || 'NO');
                    console.log('   - Username del documento:', documentoEncontrado.username || 'NO');
                    
                    // Si el documento no tiene el ID correcto, ofrecer solución
                    if (documentoEncontrado.id !== currentUser.username) {
                        console.error('\n❌ PROBLEMA CRÍTICO: El documento tiene un ID diferente al username');
                        console.error('   ID actual:', documentoEncontrado.id);
                        console.error('   ID esperado:', currentUser.username);
                        console.error('\n💡 SOLUCIÓN: Necesitas cambiar el ID del documento en Firestore Console');
                        console.error('   O crear un nuevo documento con el ID = username y copiar los datos.');
                    } else if (!documentoEncontrado.permisos?.empleados) {
                        console.error('\n❌ PROBLEMA: El documento NO tiene el permiso "empleados: true"');
                        console.error('   Necesitas agregar el permiso "empleados: true" al documento.');
                    } else {
                        console.log('\n✅ El documento está correctamente configurado');
                    }
                } else {
                    console.error('❌ PROBLEMA CRÍTICO: No se encontró el documento del empleado');
                    console.error('   El documento debe tener el ID = username:', currentUser.username);
                    console.error('   O el ID = UID:', uidFinal);
                    console.error('\n💡 SOLUCIÓN: Crea un documento en Firestore con:');
                    console.error('   - Colección: empleados');
                    console.error('   - ID del documento: ' + currentUser.username);
                    console.error('   - Campos: username, permisos.empleados = true, etc.');
                }
                
            } catch (error) {
                console.error('❌ Error al buscar documento:', error);
            }
            
            console.groupEnd();
        };

        // Función para crear usuario "Sebastian Trejos" en Firebase Auth
        window.crearSebastianTrejos = async function() {
            console.group('🔧 Creando usuario Sebastian Trejos en Firebase Auth');
            
            try {
                const { getAuth, createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                const { getFirestore, doc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                
                const auth = getAuth();
                const db = getFirestore();
                
                // Datos del usuario
                const primerNombre = 'Sebastian';
                const primerApellido = 'Trejos';
                const username = 'sebastian.trejos';
                const email = `rh+${username}@ecoplagascr.com`;
                const password = 'registro'; // Contraseña por defecto
                
                console.log('📝 Datos del usuario:');
                console.log('   - Nombre:', primerNombre, primerApellido);
                console.log('   - Username:', username);
                console.log('   - Email:', email);
                console.log('   - Password:', password);
                
                // Intentar crear el usuario directamente en Firebase Auth
                try {
                    console.log('📝 Creando usuario en Firebase Auth...');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('✅ Usuario creado en Firebase Auth');
                    console.log('   - UID:', userCredential.user.uid);
                    console.log('   - Email:', userCredential.user.email);
                    
                    // Cerrar sesión INMEDIATAMENTE para evitar que onAuthStateChanged intente cargar datos
                    const { signOut } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                    await signOut(auth);
                    console.log('✅ Sesión cerrada para evitar carga automática de datos');
                    
                    // Esperar un momento para que el listener se complete
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Verificar si el documento ya existe en Firestore
                    const docRef = doc(db, 'empleados', username);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        console.log('✅ El documento ya existe en Firestore');
                        console.log('   - ID:', docSnap.id);
                        
                        // Actualizar con información de Firebase Auth
                        const { updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        await updateDoc(docRef, {
                            firebaseAuthUID: userCredential.user.uid,
                            firebaseAuthEmail: email,
                            firebaseAuthMigrated: true,
                            firebaseAuthMigratedAt: new Date().toISOString()
                        });
                        console.log('✅ Documento actualizado con información de Firebase Auth');
                    } else {
                        console.log('⚠️ El documento NO existe en Firestore');
                        console.log('   Necesitas crear el empleado desde la página de empleados primero.');
                    }
                    
                    alert(`✅ Usuario creado exitosamente en Firebase Auth\n\n` +
                          `Username: ${username}\n` +
                          `Email: ${email}\n` +
                          `Password: ${password}\n` +
                          `UID: ${userCredential.user.uid}\n\n` +
                          `Ahora puedes agregar el empleado desde la página de empleados.`);
                } catch (error) {
                    // Asegurarse de cerrar sesión incluso si hay error
                    try {
                        const { signOut } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                        await signOut(auth);
                    } catch (signOutError) {
                        // Ignorar errores al cerrar sesión
                    }
                    
                    if (error.code === 'auth/email-already-in-use') {
                        console.log('✅ El usuario ya existe en Firebase Auth');
                        alert(`✅ El usuario ya existe en Firebase Auth\n\n` +
                              `Username: ${username}\n` +
                              `Email: ${email}\n\n` +
                              `Puedes agregar el empleado desde la página de empleados.`);
                    } else {
                        console.error('❌ Error creando usuario:', error);
                        alert('❌ Error: ' + error.message);
                    }
                }
                
            } catch (error) {
                console.error('❌ Error general:', error);
                alert('❌ Error: ' + error.message);
            }
            
            console.groupEnd();
        };

        // Función para verificar el documento de sebastian.trejos en Firestore
        window.verificarSebastianTrejos = async function() {
            console.group('🔍 Verificando documento de Sebastian Trejos en Firestore');
            
            try {
                const { getFirestore, doc, getDoc, collection, getDocs, setDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                const username = 'sebastian.trejos';
                const email = `rh+${username}@ecoplagascr.com`;
                
                console.log('📝 Buscando documento:');
                console.log('   - Username:', username);
                console.log('   - Email:', email);
                
                // Buscar por username (ID del documento)
                const docRef = doc(db, 'empleados', username);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const documento = { id: docSnap.id, ...docSnap.data() };
                    console.log('✅ Documento encontrado por username (ID):', username);
                    console.log('📄 Datos del documento:', documento);
                    
                    console.log('\n📊 Análisis del documento:');
                    console.log('   - ID del documento:', documento.id);
                    console.log('   - Username:', documento.username || 'NO');
                    console.log('   - Primer Nombre:', documento.primerNombre || 'NO');
                    console.log('   - Primer Apellido:', documento.primerApellido || 'NO');
                    console.log('   - firebaseAuthUID:', documento.firebaseAuthUID || 'NO');
                    console.log('   - firebaseAuthEmail:', documento.firebaseAuthEmail || 'NO');
                    console.log('   - Permisos:', documento.permisos || 'NO');
                    console.log('   - ¿Tiene permiso empleados?', documento.permisos?.empleados || false);
                    
                    // Verificar si tiene firebaseAuthUID
                    if (!documento.firebaseAuthUID) {
                        console.warn('\n⚠️ PROBLEMA: El documento NO tiene firebaseAuthUID');
                        console.warn('   Necesitas obtener el UID de Firebase Auth y agregarlo al documento.');
                        
                        // Buscar el UID en Firebase Auth
                        try {
                            const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                            const auth = getAuth();
                            
                            // Intentar obtener el usuario por email (esto requiere que estés autenticado como admin)
                            console.log('\n💡 Para obtener el UID, puedes:');
                            console.log('   1. Ir a Firebase Console > Authentication');
                            console.log('   2. Buscar el usuario con email:', email);
                            console.log('   3. Copiar el UID');
                            console.log('   4. Ejecutar: window.actualizarSebastianTrejos(uid)');
                        } catch (e) {
                            console.error('Error:', e);
                        }
                    } else {
                        console.log('\n✅ El documento tiene firebaseAuthUID:', documento.firebaseAuthUID);
                    }
                    
                    // Verificar si tiene el permiso empleados
                    if (!documento.permisos?.empleados) {
                        console.warn('\n⚠️ PROBLEMA: El documento NO tiene el permiso "empleados: true"');
                        const corregir = confirm('El documento no tiene el permiso "empleados: true".\n\n¿Deseas agregarlo automáticamente?');
                        if (corregir) {
                            try {
                                const permisosActualizados = {
                                    ...(documento.permisos || {}),
                                    empleados: true
                                };
                                await updateDoc(docRef, { permisos: permisosActualizados });
                                console.log('✅ Permiso "empleados" agregado correctamente');
                                alert('✅ Permiso "empleados" agregado correctamente.');
                            } catch (error) {
                                console.error('❌ Error al actualizar permisos:', error);
                                alert('❌ Error al actualizar permisos: ' + error.message);
                            }
                        }
                    } else {
                        console.log('\n✅ El documento tiene el permiso "empleados: true"');
                    }
                    
                    // Verificar estructura del documento
                    const camposRequeridos = ['primerNombre', 'primerApellido', 'username'];
                    const camposFaltantes = camposRequeridos.filter(campo => !documento[campo]);
                    if (camposFaltantes.length > 0) {
                        console.warn('\n⚠️ Campos faltantes:', camposFaltantes);
                    } else {
                        console.log('\n✅ El documento tiene todos los campos requeridos');
                    }
                    
                } else {
                    console.error('❌ PROBLEMA: El documento NO existe en Firestore');
                    console.error('   ID esperado:', username);
                    
                    // Buscar en todos los documentos
                    console.log('\n🔍 Buscando en TODOS los documentos de empleados...');
                    const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                    
                    let documentosCoincidentes = [];
                    empleadosSnapshot.forEach(doc => {
                        const emp = { id: doc.id, ...doc.data() };
                        // Buscar por username
                        if (emp.username === username) {
                            documentosCoincidentes.push({ tipo: 'username', documento: emp });
                        }
                        // Buscar por email
                        if (emp.firebaseAuthEmail === email || emp.correoEmpresa === email) {
                            documentosCoincidentes.push({ tipo: 'email', documento: emp });
                        }
                        // Buscar por nombre
                        if (emp.primerNombre === 'Sebastian' && emp.primerApellido === 'Trejos') {
                            documentosCoincidentes.push({ tipo: 'nombre', documento: emp });
                        }
                    });
                    
                    if (documentosCoincidentes.length > 0) {
                        console.log('✅ Encontrados documentos coincidentes:');
                        documentosCoincidentes.forEach((item, index) => {
                            console.log(`\n📄 Documento ${index + 1} (encontrado por ${item.tipo}):`);
                            console.log('   - ID del documento:', item.documento.id);
                            console.log('   - Username:', item.documento.username);
                            console.log('   - Nombre:', item.documento.primerNombre, item.documento.primerApellido);
                            console.log('   - firebaseAuthUID:', item.documento.firebaseAuthUID || 'NO');
                        });
                        
                        console.error('\n❌ PROBLEMA: El documento tiene un ID diferente al username esperado');
                        console.error('   ID actual:', documentosCoincidentes[0].documento.id);
                        console.error('   ID esperado:', username);
                        console.error('\n💡 SOLUCIÓN: Necesitas cambiar el ID del documento en Firestore Console');
                        console.error('   O crear un nuevo documento con el ID = username y copiar los datos.');
                    } else {
                        console.error('\n❌ No se encontró ningún documento que coincida');
                        console.error('\n💡 SOLUCIÓN: Necesitas crear el documento en Firestore:');
                        console.error('   1. Ve a Firebase Console > Firestore');
                        console.error('   2. Colección: empleados');
                        console.error('   3. Crear documento con ID = sebastian.trejos');
                        console.error('   4. Agregar campos: primerNombre, primerApellido, username, permisos, etc.');
                    }
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                alert('❌ Error: ' + error.message);
            }
            
            console.groupEnd();
        };

        // Función para crear el documento de sebastian.trejos en Firestore
        window.crearDocumentoSebastianTrejos = async function() {
            console.group('🔧 Creando documento de Sebastian Trejos en Firestore');
            
            try {
                const { getFirestore, doc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                const username = 'sebastian.trejos';
                const email = `rh+${username}@ecoplagascr.com`;
                const uid = 'IQVc8MoBpbgjZ0SprkOcWjxKA9k1'; // UID de Firebase Auth (obtenido anteriormente)
                
                // Verificar si el documento ya existe
                const docRef = doc(db, 'empleados', username);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    console.log('✅ El documento ya existe');
                    const documento = { id: docSnap.id, ...docSnap.data() };
                    console.log('📄 Datos del documento:', documento);
                    alert('✅ El documento ya existe en Firestore');
                    return;
                }
                
                // Crear documento con campos mínimos necesarios
                const empleadoData = {
                    primerNombre: 'Sebastian',
                    primerApellido: 'Trejos',
                    username: username,
                    cedula: '', // Se completará después
                    fechaIngreso: new Date().toISOString().split('T')[0],
                    estado: 'Activo',
                    tipoContrato: 'Mensual',
                    cargo: '', // Se completará después
                    departamento: '', // Se completará después
                    firebaseAuthUID: uid,
                    firebaseAuthEmail: email,
                    firebaseAuthMigrated: true,
                    firebaseAuthMigratedAt: new Date().toISOString(),
                    permisos: {
                        empleados: false, // No tiene permiso de empleados por defecto
                        calendario: true,
                        registro_horas: true,
                        tickets: true
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                console.log('📝 Creando documento con datos:', empleadoData);
                
                await setDoc(docRef, empleadoData);
                console.log('✅ Documento creado exitosamente en Firestore');
                console.log('   - ID:', username);
                console.log('   - UID:', uid);
                console.log('   - Email:', email);
                
                alert(`✅ Documento creado exitosamente en Firestore\n\n` +
                      `ID: ${username}\n` +
                      `UID: ${uid}\n` +
                      `Email: ${email}\n\n` +
                      `Ahora puedes completar los datos del empleado desde la página de empleados.`);
                
            } catch (error) {
                console.error('❌ Error:', error);
                
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    console.error('❌ Error de permisos al crear documento');
                    console.error('   El usuario autenticado no tiene permisos para crear empleados');
                    alert('❌ Error de permisos: No tienes permisos para crear empleados.\n\n' +
                          'Necesitas que un administrador con permisos de empleados cree el documento.\n\n' +
                          'O verifica que tu documento en Firestore tenga el permiso "empleados: true"');
                } else {
                    alert('❌ Error: ' + error.message);
                }
            }
            
            console.groupEnd();
        };

        // Función para actualizar el documento de sebastian.trejos con el UID de Firebase Auth
        window.actualizarSebastianTrejos = async function(uid) {
            if (!uid) {
                alert('❌ Error: Debes proporcionar el UID de Firebase Auth');
                return;
            }
            
            console.group('🔧 Actualizando documento de Sebastian Trejos');
            
            try {
                const { getFirestore, doc, updateDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                const username = 'sebastian.trejos';
                const email = `rh+${username}@ecoplagascr.com`;
                const docRef = doc(db, 'empleados', username);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    await updateDoc(docRef, {
                        firebaseAuthUID: uid,
                        firebaseAuthEmail: email,
                        firebaseAuthMigrated: true,
                        firebaseAuthMigratedAt: new Date().toISOString()
                    });
                    console.log('✅ Documento actualizado con información de Firebase Auth');
                    console.log('   - UID:', uid);
                    console.log('   - Email:', email);
                    alert('✅ Documento actualizado correctamente');
                } else {
                    console.error('❌ El documento no existe');
                    alert('❌ El documento no existe. Primero crea el empleado desde la página de empleados.');
                }
            } catch (error) {
                console.error('❌ Error:', error);
                alert('❌ Error: ' + error.message);
            }
            
            console.groupEnd();
        };

        // Función para corregir automáticamente el documento de pablo.paniagua
        window.corregirPabloPaniagua = async function() {
            console.group('🔧 Corrigiendo documento de Pablo Paniagua');
            
            try {
                const { getFirestore, doc, getDoc, collection, getDocs, setDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                const db = getFirestore();
                const auth = getAuth();
                
                const username = 'pablo.paniagua';
                const email = `rh+${username}@ecoplagascr.com`;
                const uid = auth.currentUser?.uid || null;
                
                console.log('📋 Información del usuario:', {
                    username: username,
                    email: email,
                    uid: uid,
                    uidDisponible: !!uid
                });
                
                const docRef = doc(db, 'empleados', username);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    // El documento existe, solo verificar y corregir permisos
                    const documento = { id: docSnap.id, ...docSnap.data() };
                    console.log('✅ Documento encontrado:', documento.id);
                    
                    let necesitaActualizacion = false;
                    const actualizaciones = {};
                    
                    // Verificar permiso empleados
                    if (!documento.permisos?.empleados) {
                        console.log('📝 Agregando permiso "empleados: true"');
                        actualizaciones.permisos = {
                            ...(documento.permisos || {}),
                            empleados: true
                        };
                        necesitaActualizacion = true;
                    }
                    
                    // Verificar que tenga username
                    if (!documento.username || documento.username !== username) {
                        console.log('📝 Corrigiendo username');
                        actualizaciones.username = username;
                        necesitaActualizacion = true;
                    }
                    
                    if (necesitaActualizacion) {
                        await updateDoc(docRef, actualizaciones);
                        console.log('✅ Documento actualizado correctamente');
                        alert('✅ Documento de pablo.paniagua corregido exitosamente.\n\nRecarga la página y luego ejecuta: window.crearDocumentoSebastianTrejos()');
                    } else {
                        console.log('✅ El documento ya está correctamente configurado');
                        alert('✅ El documento de pablo.paniagua ya está correctamente configurado.\n\nAhora puedes ejecutar: window.crearDocumentoSebastianTrejos()');
                    }
                } else {
                    // El documento no existe, buscar en todos los documentos
                    console.log('🔍 Documento no encontrado, buscando en todos los documentos...');
                    const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                    
                    let documentoEncontrado = null;
                    empleadosSnapshot.forEach(doc => {
                        const emp = { id: doc.id, ...doc.data() };
                        if (emp.username === username || 
                            (emp.primerNombre === 'Pablo' && emp.primerApellido === 'Paniagua')) {
                            documentoEncontrado = emp;
                        }
                    });
                    
                    if (documentoEncontrado) {
                        console.log('✅ Documento encontrado con ID diferente:', documentoEncontrado.id);
                        console.log('📝 Creando nuevo documento con ID correcto...');
                        
                        // Crear nuevo documento con ID correcto
                        const nuevoDocumento = {
                            ...documentoEncontrado,
                            username: username,
                            permisos: {
                                ...(documentoEncontrado.permisos || {}),
                                empleados: true
                            },
                            firebaseAuthUID: uid || documentoEncontrado.firebaseAuthUID || null,
                            firebaseAuthEmail: email,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Eliminar el campo id del objeto para no incluirlo en los datos
                        delete nuevoDocumento.id;
                        
                        await setDoc(docRef, nuevoDocumento);
                        console.log('✅ Nuevo documento creado con ID correcto, permisos y firebaseAuthUID');
                        alert('✅ Documento de pablo.paniagua creado con ID correcto.\n\nRecarga la página para aplicar los cambios.');
                    } else {
                        // No se encontró ningún documento, crear uno básico
                        console.log('📝 No se encontró documento, creando uno básico...');
                        const documentoBasico = {
                            primerNombre: 'Pablo',
                            primerApellido: 'Paniagua',
                            username: username,
                            estado: 'Activo',
                            tipoContrato: 'Mensual',
                            permisos: {
                                empleados: true,
                                calendario: true,
                                registro_horas: true,
                                tickets: true,
                                reportes_gerenciales: true,
                                operario_bodega: true,
                                administrador_bodega: true,
                                recursos_humanos: true
                            },
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        await setDoc(docRef, documentoBasico);
                        console.log('✅ Documento básico creado');
                        alert('✅ Documento básico de pablo.paniagua creado.\n\nRecarga la página y luego ejecuta: window.crearDocumentoSebastianTrejos()');
                    }
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    alert('❌ Error de permisos: No tienes permisos para modificar documentos.\n\n' +
                          'Necesitas que un administrador con acceso directo a Firestore corrija el documento manualmente.\n\n' +
                          'O verifica que estés autenticado correctamente.');
                } else {
                    alert('❌ Error: ' + error.message);
                }
            }
            
            console.groupEnd();
        };
        
        // Función para migrar el documento de pablo.paniagua al ID correcto
        window.migrarPabloPaniaguaAlIdCorrecto = async function() {
            console.group('🔄 Migrando documento de Pablo Paniagua al ID correcto');
            
            try {
                const { getFirestore, doc, getDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                const db = getFirestore();
                const auth = getAuth();
                
                const username = 'pablo.paniagua';
                const email = `rh+${username}@ecoplagascr.com`;
                const uid = auth.currentUser?.uid || null;
                const idActual = '19Q0flM7CvPcw7gvCUsc'; // ID actual del documento
                
                console.log('📋 Información:', {
                    username: username,
                    idActual: idActual,
                    idNuevo: username,
                    uid: uid,
                    email: email
                });
                
                // 1. Obtener el documento actual
                const docRefActual = doc(db, 'empleados', idActual);
                const docSnapActual = await getDoc(docRefActual);
                
                if (!docSnapActual.exists()) {
                    console.error('❌ El documento con ID actual no existe:', idActual);
                    alert('❌ No se encontró el documento con ID: ' + idActual);
                    console.groupEnd();
                    return;
                }
                
                const datosActuales = { id: docSnapActual.id, ...docSnapActual.data() };
                console.log('✅ Documento actual encontrado:', {
                    id: datosActuales.id,
                    username: datosActuales.username,
                    tienePermisos: !!datosActuales.permisos,
                    tienePermisoEmpleados: datosActuales.permisos?.empleados || false,
                    tieneFirebaseAuthUID: !!datosActuales.firebaseAuthUID
                });
                
                // 2. Verificar si ya existe un documento con el ID correcto
                const docRefNuevo = doc(db, 'empleados', username);
                const docSnapNuevo = await getDoc(docRefNuevo);
                
                if (docSnapNuevo.exists()) {
                    console.warn('⚠️ Ya existe un documento con ID = username');
                    const sobrescribir = confirm('Ya existe un documento con ID = "pablo.paniagua".\n\n¿Deseas sobrescribirlo con los datos del documento actual?');
                    if (!sobrescribir) {
                        console.log('❌ Operación cancelada');
                        console.groupEnd();
                        return;
                    }
                }
                
                // 3. Preparar los datos para el nuevo documento
                const nuevoDocumento = {
                    ...datosActuales
                };
                
                // Eliminar el campo id para no incluirlo en los datos
                delete nuevoDocumento.id;
                
                // Asegurar que tenga los campos correctos
                nuevoDocumento.username = username;
                nuevoDocumento.firebaseAuthUID = uid || datosActuales.firebaseAuthUID || null;
                nuevoDocumento.firebaseAuthEmail = email;
                
                // Asegurar que tenga el permiso empleados
                if (!nuevoDocumento.permisos) {
                    nuevoDocumento.permisos = {};
                }
                nuevoDocumento.permisos.empleados = true;
                
                // Agregar timestamp de migración
                nuevoDocumento.migradoDesdeId = idActual;
                nuevoDocumento.migradoEn = new Date().toISOString();
                nuevoDocumento.updatedAt = new Date().toISOString();
                
                console.log('📝 Datos preparados para el nuevo documento:', {
                    username: nuevoDocumento.username,
                    firebaseAuthUID: nuevoDocumento.firebaseAuthUID,
                    tienePermisoEmpleados: nuevoDocumento.permisos?.empleados || false,
                    migradoDesdeId: nuevoDocumento.migradoDesdeId
                });
                
                // 4. Crear el nuevo documento con ID = username
                await setDoc(docRefNuevo, nuevoDocumento);
                console.log('✅ Nuevo documento creado con ID = username');
                
                // 5. Verificar que se creó correctamente
                const docSnapVerificacion = await getDoc(docRefNuevo);
                if (docSnapVerificacion.exists()) {
                    console.log('✅ Verificación: El nuevo documento existe y tiene:', {
                        id: docSnapVerificacion.id,
                        username: docSnapVerificacion.data().username,
                        firebaseAuthUID: docSnapVerificacion.data().firebaseAuthUID,
                        tienePermisoEmpleados: docSnapVerificacion.data().permisos?.empleados || false
                    });
                    
                    alert('✅ Documento migrado exitosamente.\n\n' +
                          'El documento ahora tiene ID = "pablo.paniagua" y las reglas de Firestore podrán encontrarlo.\n\n' +
                          'IMPORTANTE: El documento antiguo (ID: ' + idActual + ') todavía existe.\n' +
                          'Puedes eliminarlo manualmente desde Firestore Console si lo deseas.\n\n' +
                          'Recarga la página para aplicar los cambios.');
                } else {
                    console.error('❌ Error: El documento no se creó correctamente');
                    alert('❌ Error: El documento no se creó correctamente. Revisa la consola.');
                }
                
            } catch (error) {
                console.error('❌ Error migrando documento:', error);
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    alert('❌ Error de permisos: No tienes permisos para crear documentos.\n\n' +
                          'Necesitas que un administrador con acceso directo a Firestore cree el documento manualmente.');
                } else {
                    alert('❌ Error: ' + error.message);
                }
            }
            
            console.groupEnd();
        };

        // Función para verificar y corregir el documento de pablo.paniagua
        window.verificarPabloPaniagua = async function() {
            console.group('🔍 Verificando documento de Pablo Paniagua');
            
            try {
                const { getFirestore, doc, getDoc, collection, getDocs, setDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                const username = 'pablo.paniagua';
                
                console.log('📝 Buscando documento:', username);
                
                // Buscar por username (ID del documento)
                const docRef = doc(db, 'empleados', username);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const documento = { id: docSnap.id, ...docSnap.data() };
                    console.log('✅ Documento encontrado por username (ID):', username);
                    console.log('📄 Datos del documento:', documento);
                    console.log('   - Permisos:', documento.permisos);
                    console.log('   - ¿Tiene permiso empleados?', documento.permisos?.empleados || false);
                    
                    if (!documento.permisos?.empleados) {
                        console.warn('⚠️ El documento NO tiene el permiso "empleados: true"');
                        const corregir = confirm('El documento no tiene el permiso "empleados: true".\n\n¿Deseas agregarlo automáticamente?');
                        if (corregir) {
                            try {
                                const permisosActualizados = {
                                    ...(documento.permisos || {}),
                                    empleados: true
                                };
                                await updateDoc(docRef, { permisos: permisosActualizados });
                                console.log('✅ Permiso "empleados" agregado correctamente');
                                alert('✅ Permiso "empleados" agregado correctamente. Recarga la página.');
                            } catch (error) {
                                console.error('❌ Error al actualizar permisos:', error);
                                alert('❌ Error al actualizar permisos: ' + error.message);
                            }
                        }
                    } else {
                        console.log('✅ El documento tiene el permiso "empleados: true"');
                        alert('✅ El documento está correctamente configurado con el permiso "empleados: true"');
                    }
                } else {
                    console.error('❌ PROBLEMA: El documento NO existe en Firestore');
                    console.error('   ID esperado:', username);
                    
                    // Buscar en todos los documentos
                    console.log('\n🔍 Buscando en TODOS los documentos de empleados...');
                    const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                    
                    let documentosCoincidentes = [];
                    empleadosSnapshot.forEach(doc => {
                        const emp = { id: doc.id, ...doc.data() };
                        // Buscar por username
                        if (emp.username === username) {
                            documentosCoincidentes.push({ tipo: 'username', documento: emp });
                        }
                        // Buscar por nombre
                        if (emp.primerNombre === 'Pablo' && emp.primerApellido === 'Paniagua') {
                            documentosCoincidentes.push({ tipo: 'nombre', documento: emp });
                        }
                    });
                    
                    if (documentosCoincidentes.length > 0) {
                        console.log('✅ Encontrados documentos coincidentes:');
                        documentosCoincidentes.forEach((item, index) => {
                            console.log(`\n📄 Documento ${index + 1} (encontrado por ${item.tipo}):`);
                            console.log('   - ID del documento:', item.documento.id);
                            console.log('   - Username:', item.documento.username);
                            console.log('   - Permisos:', item.documento.permisos);
                        });
                        
                        console.error('\n❌ PROBLEMA: El documento tiene un ID diferente al username esperado');
                        console.error('   ID actual:', documentosCoincidentes[0].documento.id);
                        console.error('   ID esperado:', username);
                        console.error('\n💡 SOLUCIÓN: Necesitas cambiar el ID del documento en Firestore Console');
                        console.error('   O crear un nuevo documento con el ID = username y copiar los datos.');
                        
                        alert('❌ El documento existe pero tiene un ID diferente.\n\n' +
                              'ID actual: ' + documentosCoincidentes[0].documento.id + '\n' +
                              'ID esperado: ' + username + '\n\n' +
                              'Necesitas cambiar el ID del documento en Firestore Console.');
                    } else {
                        console.error('\n❌ No se encontró ningún documento que coincida');
                        console.error('\n💡 SOLUCIÓN: Necesitas crear el documento en Firestore:');
                        console.error('   1. Ve a Firebase Console > Firestore');
                        console.error('   2. Colección: empleados');
                        console.error('   3. Crear documento con ID = pablo.paniagua');
                        console.error('   4. Agregar campos: primerNombre, primerApellido, username, permisos.empleados = true, etc.');
                        
                        alert('❌ El documento no existe en Firestore.\n\n' +
                              'Necesitas crear el documento manualmente en Firebase Console.');
                    }
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                alert('❌ Error: ' + error.message);
            }
            
            console.groupEnd();
        };

        // Crear usuario en Firebase Auth
        window.crearUsuarioFirebaseAuth = async function() {
            if (!currentEmpleadoId) {
                alert('Error: No hay empleado seleccionado. Por favor, guarda el empleado primero.');
                return;
            }
            
            const empleado = empleados.find(e => e.id === currentEmpleadoId);
            if (!empleado) {
                alert('Error: No se encontró el empleado.');
                return;
            }
            
            if (!empleado.username) {
                alert('Error: El empleado no tiene username. Por favor, verifica los datos.');
                return;
            }
            
            if (empleado.firebaseAuthUID) {
                const confirmar = confirm(`El empleado ya tiene un usuario en Firebase Auth (UID: ${empleado.firebaseAuthUID}).\n\n¿Deseas crear uno nuevo? Esto puede causar conflictos.`);
                if (!confirmar) {
                    return;
                }
            }
            
            const btnCrearFirebaseAuth = document.getElementById('btnCrearFirebaseAuth');
            const textoOriginal = btnCrearFirebaseAuth ? btnCrearFirebaseAuth.innerHTML : '';
            
            try {
                // Deshabilitar botón
                if (btnCrearFirebaseAuth) {
                    btnCrearFirebaseAuth.disabled = true;
                    btnCrearFirebaseAuth.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
                }
                
                // Obtener la contraseña del empleado desde Firestore (passwordPlain si existe)
                let password = empleado.passwordPlain || 'registro'; // Usar passwordPlain si existe, sino usar default
                
                // Intentar crear usuario en Firebase Auth
                const resultado = await window.authManager.createUserInFirebaseAuth(
                    empleado.username,
                    password
                );
                
                if (resultado.success) {
                    alert(`✅ Usuario creado exitosamente en Firebase Auth\n\n` +
                          `Email: ${resultado.email}\n` +
                          `UID: ${resultado.uid}\n\n` +
                          `El empleado puede iniciar sesión con:\n` +
                          `Username: ${empleado.username}\n` +
                          `Password: ${password}`);
                    
                    // Ocultar botón
                    if (btnCrearFirebaseAuth) {
                        btnCrearFirebaseAuth.style.display = 'none';
                    }
                    
                    // Recargar datos para actualizar la información
                    await cargarDatos();
                    
                    // Actualizar empleado local
                    const empleadoActualizado = empleados.find(e => e.id === currentEmpleadoId);
                    if (empleadoActualizado) {
                        empleadoActualizado.firebaseAuthUID = resultado.uid;
                        empleadoActualizado.firebaseAuthEmail = resultado.email;
                    }
                } else {
                    // Si el usuario ya existe, ofrecer sincronizar
                    if (resultado.needsSync || resultado.emailExists) {
                        const email = resultado.email || `rh+${empleado.username}@ecoplagascr.com`;
                        const sincronizar = confirm(`⚠️ El usuario ya existe en Firebase Auth\n\n` +
                                                    `Email: ${email}\n\n` +
                                                    `El usuario fue creado manualmente en Firebase Auth.\n\n` +
                                                    `¿Deseas sincronizar el registro ahora?\n` +
                                                    `(Necesitarás la contraseña de Firebase Auth)`);
                        
                        if (sincronizar) {
                            // Llamar a la función de sincronización
                            await window.sincronizarConFirebaseAuth(currentEmpleadoId, empleado.username);
                        } else {
                            alert(`El usuario existe en Firebase Auth pero no se sincronizó.\n\n` +
                                  `Puedes sincronizarlo más tarde usando el icono de sincronización en la tabla.`);
                        }
                    } else {
                        alert(`❌ Error creando usuario en Firebase Auth\n\n${resultado.error}`);
                    }
                }
            } catch (error) {
                console.error('❌ Error creando usuario en Firebase Auth:', error);
                alert(`❌ Error inesperado: ${error.message}`);
            } finally {
                // Restaurar botón
                if (btnCrearFirebaseAuth) {
                    btnCrearFirebaseAuth.disabled = false;
                    btnCrearFirebaseAuth.innerHTML = textoOriginal;
                }
            }
        };
        
        // Sincronizar empleado con Firebase Auth (solo modo manual)
        window.sincronizarConFirebaseAuth = async function(empleadoId, username) {
            if (!empleadoId || !username) {
                alert('Error: Faltan datos del empleado.');
                return;
            }
            
            const empleado = empleados.find(e => e.id === empleadoId);
            if (!empleado) {
                alert('Error: No se encontró el empleado.');
                return;
            }
            
            const email = `rh+${username}@ecoplagascr.com`;
            
            // Llamar directamente a la función de ingreso manual
            await ingresarUIDManual(empleadoId, email);
        };
        
        // Función para ingresar UID manualmente
        async function ingresarUIDManual(empleadoId, email) {
            const uid = prompt(`Ingresar UID manualmente\n\n` +
                              `Email: ${email}\n\n` +
                              `Ingresa el UID del usuario desde Firebase Authentication Console:\n\n` +
                              `(Puedes encontrarlo en: Firebase Console > Authentication > Users > [Usuario] > UID)`, '');
            
            if (!uid || uid.trim() === '') {
                return; // Usuario canceló
            }
            
            const uidLimpio = uid.trim();
            
            // Validar formato básico de UID (al menos 20 caracteres, solo letras, números y guiones)
            if (uidLimpio.length < 20 || !/^[a-zA-Z0-9_-]+$/.test(uidLimpio)) {
                alert('❌ UID inválido\n\nEl UID debe tener al menos 20 caracteres y contener solo letras, números, guiones y guiones bajos.');
                return;
            }
            
            try {
                // Actualizar el documento del empleado con el UID
                const updateData = {
                    firebaseAuthUID: uidLimpio,
                    firebaseAuthEmail: email,
                    firebaseAuthMigrated: true,
                    firebaseAuthMigratedAt: new Date().toISOString()
                };
                
                // Agregar token CSRF
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(updateData);
                }
                
                await updateDoc(doc(db, 'empleados', empleadoId), updateData);
                
                alert(`✅ Empleado sincronizado exitosamente (UID manual)\n\n` +
                      `Email: ${email}\n` +
                      `UID: ${uidLimpio}\n\n` +
                      `El registro ha sido actualizado.`);
                
                // Recargar datos para actualizar la vista
                await cargarDatos();
            } catch (error) {
                console.error('❌ Error actualizando UID manual:', error);
                alert(`❌ Error actualizando el registro\n\n` +
                      `Error: ${error.message}\n\n` +
                      `Verifica que tengas permisos para editar empleados.`);
            }
        }

        // Editar empleado
        window.editarEmpleado = function(empleadoId) {
            abrirModal(empleadoId);
        };

        // Calcular total de horas trabajadas de un empleado
        async function calcularHorasTotalesEmpleado(empleadoId) {
            const empleado = empleados.find(e => e.id === empleadoId);
            if (!empleado || !empleado.username) {
                return 0;
            }
            
            const username = empleado.username.toLowerCase();
            let totalHoras = 0;
            
            // Filtrar sesiones del empleado
            const sesionesEmpleado = workSessions.filter(s => {
                const sessionUsername = s.username || s.employeeName || '';
                return sessionUsername.toLowerCase() === username;
            });
            
            // Calcular horas totales
            sesionesEmpleado.forEach(s => {
                try {
                    let horas = 0;
                    
                    if (s.endTime && s.startTime) {
                        const fechaInicio = s.startTime?.toDate ? s.startTime.toDate() : (s.startTime ? new Date(s.startTime) : null);
                        const fechaFin = s.endTime?.toDate ? s.endTime.toDate() : (s.endTime ? new Date(s.endTime) : null);
                        
                        if (fechaInicio && fechaFin && !isNaN(fechaInicio.getTime()) && !isNaN(fechaFin.getTime()) && fechaFin > fechaInicio) {
                            horas = (fechaFin - fechaInicio) / (1000 * 60 * 60);
                        }
                    } else if (s.duracion) {
                        horas = parseFloat(s.duracion) || 0;
                    }
                    
                    if (horas > 0 && horas <= 24) {
                        totalHoras += horas;
                    }
                } catch (e) {
                    console.warn('Error calculando horas de sesión:', e);
                }
            });
            
            return Math.round(totalHoras * 100) / 100; // Redondear a 2 decimales
        }
        
        // Generar fórmula matemática aleatoria
        function generarFormulaMatematica() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            const operaciones = ['+', '-', '*'];
            const operacion = operaciones[Math.floor(Math.random() * operaciones.length)];
            
            let resultado;
            let formula;
            
            switch(operacion) {
                case '+':
                    resultado = num1 + num2;
                    formula = `${num1} + ${num2}`;
                    break;
                case '-':
                    // Asegurar que el resultado sea positivo
                    const mayor = Math.max(num1, num2);
                    const menor = Math.min(num1, num2);
                    resultado = mayor - menor;
                    formula = `${mayor} - ${menor}`;
                    break;
                case '*':
                    resultado = num1 * num2;
                    formula = `${num1} × ${num2}`;
                    break;
            }
            
            return { formula, resultado };
        }
        
        // Abrir modal de confirmación para eliminar empleado
        window.abrirModalEliminarEmpleado = async function() {
            if (!currentEmpleadoId) {
                alert('Error: No hay empleado seleccionado.');
                return;
            }
            
            const empleado = empleados.find(e => e.id === currentEmpleadoId);
            if (!empleado) {
                alert('Error: No se encontró el empleado.');
                return;
            }
            
            // Calcular horas totales
            const horasTotales = await calcularHorasTotalesEmpleado(currentEmpleadoId);
            
            // Llenar información del modal
            const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() || 'Empleado sin nombre';
            document.getElementById('nombreEmpleadoEliminar').textContent = nombreCompleto;
            document.getElementById('horasTotalesEmpleado').textContent = `${horasTotales} horas`;
            
            // Verificar si tiene horas trabajadas
            const advertenciaHoras = document.getElementById('advertenciaHoras');
            const btnConfirmar = document.getElementById('btnConfirmarEliminarEmpleado');
            const verificacionInput = document.getElementById('verificacionMatematica');
            
            if (horasTotales > 0) {
                // Bloquear eliminación si tiene horas
                advertenciaHoras.style.display = 'block';
                btnConfirmar.disabled = true;
                btnConfirmar.style.display = 'none';
                verificacionInput.disabled = true;
            } else {
                // Permitir eliminación si tiene 0 horas
                advertenciaHoras.style.display = 'none';
                btnConfirmar.style.display = 'inline-block';
                verificacionInput.disabled = false;
                
                // Generar nueva fórmula matemática
                const { formula, resultado } = generarFormulaMatematica();
                document.getElementById('formulaMatematica').textContent = formula;
                window.resultadoMatematicoEsperado = resultado;
                
                // Limpiar campo de verificación
                verificacionInput.value = '';
                btnConfirmar.disabled = true;
                
                // Validar respuesta matemática en tiempo real
                verificacionInput.oninput = function() {
                    const respuestaUsuario = parseInt(verificacionInput.value);
                    if (respuestaUsuario === window.resultadoMatematicoEsperado) {
                        btnConfirmar.disabled = false;
                        verificacionInput.classList.remove('is-invalid');
                        verificacionInput.classList.add('is-valid');
                    } else {
                        btnConfirmar.disabled = true;
                        verificacionInput.classList.remove('is-valid');
                        if (verificacionInput.value !== '') {
                            verificacionInput.classList.add('is-invalid');
                        } else {
                            verificacionInput.classList.remove('is-invalid');
                        }
                    }
                };
            }
            
            // Mostrar modal
            const modalEliminar = new bootstrap.Modal(document.getElementById('modalEliminarEmpleado'));
            modalEliminar.show();
        };
        
        // Confirmar eliminación de empleado
        window.confirmarEliminarEmpleado = async function() {
            if (!currentEmpleadoId) {
                alert('Error: No hay empleado seleccionado.');
                return;
            }
            
            const empleado = empleados.find(e => e.id === currentEmpleadoId);
            if (!empleado) {
                alert('Error: No se encontró el empleado.');
                return;
            }
            
            const nombreCompleto = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() || 'Empleado sin nombre';
            
            // Verificar respuesta matemática
            const verificacionInput = document.getElementById('verificacionMatematica');
            const respuestaUsuario = parseInt(verificacionInput.value);
            
            if (respuestaUsuario !== window.resultadoMatematicoEsperado) {
                alert('❌ Respuesta matemática incorrecta. Por favor, verifica tu respuesta.');
                return;
            }
            
            // Verificar horas nuevamente antes de eliminar
            const horasTotales = await calcularHorasTotalesEmpleado(currentEmpleadoId);
            if (horasTotales > 0) {
                alert(`❌ No se puede eliminar: El empleado tiene ${horasTotales} horas trabajadas registradas.`);
                return;
            }
            
            // Llamar a la función original de eliminar
            await window.eliminarEmpleado(currentEmpleadoId, nombreCompleto);
            
            // Cerrar modales
            const modalEliminar = bootstrap.Modal.getInstance(document.getElementById('modalEliminarEmpleado'));
            if (modalEliminar) modalEliminar.hide();
            
            const empleadoModal = bootstrap.Modal.getInstance(document.getElementById('empleadoModal'));
            if (empleadoModal) empleadoModal.hide();
        };
        
        // Eliminar empleado (función original)
        window.eliminarEmpleado = async function(empleadoId, nombreEmpleado = 'este empleado') {
            try {
                // Buscar el empleado para obtener su username
                const empleado = empleados.find(e => e.id === empleadoId);
                const username = empleado?.username || '';
                
                // Verificar registros relacionados (huérfanos)
                const registrosHuerfanos = {
                    workSessions: 0,
                    bodegas: 0,
                    citas: 0
                };
                
                // Contar sesiones de trabajo
                if (username) {
                    const workSessionsQuery = query(
                        collection(db, 'work_sessions'),
                        where('username', '==', username)
                    );
                    const workSessionsSnapshot = await getDocs(workSessionsQuery);
                    registrosHuerfanos.workSessions = workSessionsSnapshot.size;
                }
                
                // Contar bodegas asignadas
                const bodegasQuery = query(
                    collection(db, 'bodegas'),
                    where('empleadoId', '==', empleadoId)
                );
                const bodegasSnapshot = await getDocs(bodegasQuery);
                registrosHuerfanos.bodegas = bodegasSnapshot.size;
                
                // Intentar contar citas (si existe la colección)
                try {
                    if (username) {
                        const citasQuery = query(
                            collection(db, 'citas'),
                            where('empleadoUsername', '==', username)
                        );
                        const citasSnapshot = await getDocs(citasQuery);
                        registrosHuerfanos.citas = citasSnapshot.size;
                    }
                } catch (e) {
                    // Si no existe la colección o hay error, ignorar
                    console.log('No se pudo verificar citas:', e);
                }
                
                // Construir mensaje de advertencia sobre registros huérfanos
                let warningHuerfanos = '';
                const totalHuerfanos = registrosHuerfanos.workSessions + registrosHuerfanos.bodegas + registrosHuerfanos.citas;
                
                if (totalHuerfanos > 0) {
                    warningHuerfanos = `\n\n⚠️ ADVERTENCIA: REGISTROS HUÉRFANOS\n` +
                                     `Al eliminar este empleado, quedarán ${totalHuerfanos} registro(s) huérfano(s):\n` +
                                     (registrosHuerfanos.workSessions > 0 ? `• ${registrosHuerfanos.workSessions} sesión(es) de trabajo\n` : '') +
                                     (registrosHuerfanos.bodegas > 0 ? `• ${registrosHuerfanos.bodegas} bodega(s) asignada(s)\n` : '') +
                                     (registrosHuerfanos.citas > 0 ? `• ${registrosHuerfanos.citas} cita(s) asignada(s)\n` : '') +
                                     `\nEstos registros NO se eliminarán y quedarán sin referencia al empleado.\n`;
                }
                
                // Confirmación más detallada
                const mensaje = `⚠️ ¿Estás seguro de que quieres ELIMINAR permanentemente a ${nombreEmpleado}?\n\n` +
                              `Esta acción:\n` +
                              `• Eliminará el registro del empleado de la base de datos\n` +
                              `• NO eliminará el historial de horas trabajadas\n` +
                              `• NO eliminará el usuario de Firebase Authentication (si existe)\n` +
                              `• Esta acción NO se puede deshacer` +
                              warningHuerfanos +
                              `\n¿Deseas continuar?`;
                
                if (!confirm(mensaje)) return;
                
                // Segunda confirmación para mayor seguridad
                const confirmacionFinal = totalHuerfanos > 0
                    ? `⚠️ ÚLTIMA CONFIRMACIÓN\n\nVas a eliminar permanentemente a: ${nombreEmpleado}\n\n` +
                      `ADVERTENCIA: Quedarán ${totalHuerfanos} registro(s) huérfano(s) sin referencia.\n\n` +
                      `¿Estás completamente seguro?`
                    : `⚠️ ÚLTIMA CONFIRMACIÓN\n\nVas a eliminar permanentemente a: ${nombreEmpleado}\n\n¿Estás completamente seguro?`;
                
                if (!confirm(confirmacionFinal)) {
                    return;
                }
                
                // Validar origen CSRF antes de eliminar
                if (window.csrfProtection && !window.csrfProtection.validateOrigin()) {
                    alert('Error de seguridad: Origen no válido');
                    return;
                }
                
                await deleteDoc(doc(db, 'empleados', empleadoId));
                console.log('✅ Empleado eliminado:', empleadoId);
                
                // Mostrar mensaje de éxito con advertencia si hay huérfanos
                const mensajeExito = totalHuerfanos > 0
                    ? `✅ Empleado ${nombreEmpleado} eliminado exitosamente.\n\n` +
                      `⚠️ Nota: Quedaron ${totalHuerfanos} registro(s) huérfano(s) sin referencia al empleado.`
                    : `✅ Empleado ${nombreEmpleado} eliminado exitosamente.`;
                
                alert(mensajeExito);
                
                // Recargar datos
                cargarDatos();
            } catch (error) {
                console.error('❌ Error eliminando empleado:', error);
                alert(`Error eliminando empleado: ${error.message}\n\nInténtalo de nuevo.`);
            }
        };

        // Activar/Desactivar empleado (solo cambia el estado, no elimina datos)
        window.toggleEstadoEmpleado = async function(empleadoId, esActivo) {
            const nuevoEstado = esActivo ? 'Inactivo' : 'Activo';
            const accion = esActivo ? 'desactivar' : 'activar';
            
            if (!confirm(`¿Estás seguro de que quieres ${accion} este empleado?\n\nNota: Esto solo restringe el acceso al sistema. No se eliminará ningún historial.`)) {
                return;
            }
            
            try {
                const updateData = { estado: nuevoEstado };
                // Agregar token CSRF antes de actualizar
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(updateData);
                }
                await updateDoc(doc(db, 'empleados', empleadoId), updateData);
                console.log(`✅ Empleado ${accion}do exitosamente`);
                cargarDatos();
                
                // Mostrar mensaje de éxito
                const mensaje = esActivo 
                    ? 'Empleado desactivado. Ya no podrá ingresar al sistema.'
                    : 'Empleado activado. Ya puede ingresar al sistema.';
                alert(mensaje);
            } catch (error) {
                console.error(`❌ Error ${accion}ando empleado:`, error);
                alert(`Error ${accion}ando empleado. Inténtalo de nuevo.`);
            }
        };

        // Variables para el modal de cambiar contraseña
        let empleadoIdCambiarPassword = null;

        // Abrir modal para cambiar contraseña
        // Ver credenciales de empleado desde Firestore (actualizado)
        window.verCredencialesEmpleado = async function(username) {
            if (!username) {
                alert('El empleado no tiene username configurado');
                return;
            }
            
            try {
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                // Buscar empleado por username en Firestore
                const empleadosQuery = query(collection(db, 'empleados'), where('username', '==', username));
                const empleadosSnapshot = await getDocs(empleadosQuery);
                
                if (empleadosSnapshot.empty) {
                    alert(`No se encontró el empleado con username: ${username}`);
                return;
            }
                
                const empleadoDoc = empleadosSnapshot.docs[0];
                const empleadoData = empleadoDoc.data();
                
                const email = empleadoData.firebaseAuthEmail || `rh+${username}@ecoplagascr.com`;
                const passwordPlain = empleadoData.passwordPlain || 'No disponible';
            
            // Crear mensaje con credenciales
            const mensaje = `📧 Credenciales de Acceso - ${username}\n\n` +
                              `Email: ${email}\n` +
                              `Password: ${passwordPlain}\n\n` +
                          `¿Deseas copiar las credenciales al portapapeles?`;
            
            if (confirm(mensaje)) {
                    const textoACopiar = `Email: ${email}\nPassword: ${passwordPlain}`;
                
                // Copiar al portapapeles
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textoACopiar).then(() => {
                        alert('✅ Credenciales copiadas al portapapeles');
                    }).catch(() => {
                        // Fallback si falla clipboard API
                        copiarTextoFallback(textoACopiar);
                    });
                } else {
                    // Fallback para navegadores antiguos
                    copiarTextoFallback(textoACopiar);
                }
                }
            } catch (error) {
                console.error('❌ Error obteniendo credenciales:', error);
                alert('Error al obtener las credenciales. Inténtalo de nuevo.');
            }
        };

        // Función auxiliar para copiar texto (fallback)
        function copiarTextoFallback(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('✅ Credenciales copiadas al portapapeles');
            } catch (err) {
                alert('❌ No se pudo copiar automáticamente. Por favor copia manualmente:\n\n' + texto);
            }
            document.body.removeChild(textarea);
        }

        window.abrirModalCambiarPassword = async function(empleadoId, username) {
            empleadoIdCambiarPassword = empleadoId;
            
            // Limpiar campos
            document.getElementById('codigoDesbloqueo').value = '';
            document.getElementById('codigoDesbloqueo').style.display = 'block';
            document.querySelector('label[for="codigoDesbloqueo"]').style.display = 'block';
            document.getElementById('credencialPassword').textContent = '••••••••••••';
            document.getElementById('btnMostrarPassword').style.display = 'none';
            document.getElementById('btnCopiarPassword').style.display = 'none';
            
            // Mostrar username en el cuadrito de credenciales
            document.getElementById('credencialUsuario').textContent = username || '-';
            
            const modal = new bootstrap.Modal(document.getElementById('modalCambiarPassword'));
            modal.show();
        };

        // Funciones removidas: actualizarCredencialPassword y generarPasswordAutomatica
        // Ya no se pueden modificar contraseñas desde esta página

        // Función para mostrar/ocultar contraseña en credenciales
        window.toggleMostrarPassword = function() {
            const credencialEl = document.getElementById('credencialPassword');
            const iconoEl = document.getElementById('iconoMostrarPassword');
            
            if (!credencialEl || !iconoEl) return;
            
            const passwordReal = credencialEl.dataset.password || window.passwordGeneradaTemporal;
            
            if (credencialEl.textContent === '••••••••••••' || credencialEl.textContent === '-') {
                // Mostrar contraseña
                if (passwordReal) {
                    credencialEl.textContent = passwordReal;
                    iconoEl.className = 'fas fa-eye-slash';
                }
            } else {
                // Ocultar contraseña
                credencialEl.textContent = '••••••••••••';
                iconoEl.className = 'fas fa-eye';
            }
        };

        // Función para copiar contraseña al portapapeles
        window.copiarPasswordAlPortapapeles = async function() {
            const credencialEl = document.getElementById('credencialPassword');
            const passwordReal = credencialEl?.dataset.password || window.passwordGeneradaTemporal;
            
            if (!passwordReal) {
                alert('No hay contraseña para copiar');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(passwordReal);
                // Mostrar feedback visual
                const btn = event?.target?.closest('button');
                if (btn) {
                    const iconoOriginal = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    btn.classList.add('btn-success');
                    setTimeout(() => {
                        btn.innerHTML = iconoOriginal;
                        btn.classList.remove('btn-success');
                    }, 2000);
                }
            } catch (error) {
                console.error('Error copiando al portapapeles:', error);
                alert('Error al copiar. La contraseña es: ' + passwordReal);
            }
        };

        // Verificar código de desbloqueo para mostrar contraseña (SOLO LECTURA)
        // IMPORTANTE: No se puede modificar la contraseña desde esta página una vez creada
        window.verificarCodigoDesbloqueo = async function() {
            const codigo = document.getElementById('codigoDesbloqueo').value;
            
            if (codigo !== '1234') {
                alert('❌ Código incorrecto. Intenta nuevamente.');
                document.getElementById('codigoDesbloqueo').value = '';
                return;
            }

            // Código correcto, obtener contraseña del empleado desde Firestore (SOLO LECTURA)
            if (!empleadoIdCambiarPassword) {
                alert('Error: No se identificó al empleado');
                return;
            }

            try {
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const db = getFirestore();
                
                const empleadoDocRef = doc(db, 'empleados', empleadoIdCambiarPassword);
                const empleadoDocSnap = await getDoc(empleadoDocRef);
                
                if (!empleadoDocSnap.exists()) {
                    alert('Error: Empleado no encontrado');
                    return;
                }
                
                const empleadoData = empleadoDocSnap.data();
                const passwordPlain = empleadoData.passwordPlain || 'No disponible';
                
                // Mostrar contraseña (SOLO LECTURA - no se puede modificar)
                document.getElementById('credencialPassword').textContent = passwordPlain;
                document.getElementById('btnMostrarPassword').style.display = 'inline-block';
                document.getElementById('btnCopiarPassword').style.display = 'inline-block';
                
                // Ocultar campo de código
                document.getElementById('codigoDesbloqueo').style.display = 'none';
                document.querySelector('label[for="codigoDesbloqueo"]').style.display = 'none';
                
                // Mostrar mensaje informativo
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info mt-3';
                alertDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Nota:</strong> La contraseña solo se puede cambiar desde Firebase Authentication. Esta página es solo para visualización.';
                document.querySelector('#modalCambiarPassword .modal-body .row').appendChild(alertDiv);
                
            } catch (error) {
                console.error('❌ Error obteniendo contraseña:', error);
                alert('Error al obtener la contraseña. Inténtalo de nuevo.');
            }
        };

        // Mostrar error
        function mostrarError(message) {
            empleadosList.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${message}
                        </div>
                    </td>
                </tr>
            `;
        }

        // Variable para almacenar empleados activos
        let empleadosActivosLista = [];

        // Actualizar lista de empleados cuando se selecciona un módulo
        window.actualizarListaEmpleados = function() {
            const modulo = document.getElementById('moduloAccesoMasivo').value;
            empleadosActivosLista = empleados.filter(emp => {
                const estado = emp.estado || emp.activo;
                return estado === 'Activo' || estado === 'activo' || estado === true;
            });
            
            const listaContainer = document.getElementById('listaEmpleadosAccesoMasivo');
            if (empleadosActivosLista.length === 0) {
                listaContainer.innerHTML = '<p class="text-muted mb-0">No hay empleados activos</p>';
                document.getElementById('contadorEmpleadosSeleccionados').textContent = '0 empleados seleccionados';
                return;
            }
            
            // Crear lista con checkboxes, todos seleccionados por defecto
            listaContainer.innerHTML = empleadosActivosLista.map((emp, index) => {
                const nombre = `${emp.primerNombre} ${emp.primerApellido}`;
                const tieneAcceso = emp.permisos && emp.permisos[modulo] === true;
                const checkboxId = `empleadoCheck_${index}`;
                return `
                    <div class="form-check mb-2 p-2" style="background: white; border-radius: 6px; border: 1px solid #e9ecef;">
                        <input class="form-check-input" type="checkbox" id="${checkboxId}" 
                               data-empleado-id="${emp.id}" 
                               checked 
                               onchange="actualizarContadorEmpleados()"
                               style="cursor: pointer;">
                        <label class="form-check-label" for="${checkboxId}" style="cursor: pointer; width: 100%;">
                            <i class="fas fa-user text-primary me-2"></i>
                            <strong>${nombre}</strong>
                            ${tieneAcceso ? '<span class="badge bg-success ms-2" style="font-size: 0.75rem;">Tiene acceso</span>' : '<span class="badge bg-secondary ms-2" style="font-size: 0.75rem;">Sin acceso</span>'}
                        </label>
                    </div>
                `;
            }).join('');
            
            actualizarContadorEmpleados();
        };

        // Seleccionar/deseleccionar todos los empleados
        window.seleccionarTodosEmpleados = function(seleccionar) {
            const checkboxes = document.querySelectorAll('#listaEmpleadosAccesoMasivo input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = seleccionar;
            });
            actualizarContadorEmpleados();
        };

        // Actualizar contador de empleados seleccionados
        window.actualizarContadorEmpleados = function() {
            const checkboxes = document.querySelectorAll('#listaEmpleadosAccesoMasivo input[type="checkbox"]:checked');
            const total = checkboxes.length;
            const contador = document.getElementById('contadorEmpleadosSeleccionados');
            contador.textContent = `${total} empleado${total !== 1 ? 's' : ''} seleccionado${total !== 1 ? 's' : ''}`;
            
            // Actualizar texto del botón según la acción
            const accion = document.querySelector('input[name="accionAccesoMasivo"]:checked').value;
            const btnAplicar = document.getElementById('btnAplicarAccesoMasivo');
            if (accion === 'agregar') {
                btnAplicar.className = 'btn btn-success';
                btnAplicar.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Acceso';
            } else {
                btnAplicar.className = 'btn btn-danger';
                btnAplicar.innerHTML = '<i class="fas fa-minus me-2"></i>Quitar Acceso';
            }
        };

        // Actualizar botón cuando cambia la acción
        document.querySelectorAll('input[name="accionAccesoMasivo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                actualizarContadorEmpleados();
            });
        });

        // Cargar lista cuando se abre el modal
        document.getElementById('modalAccesoMasivo').addEventListener('show.bs.modal', function() {
            document.getElementById('moduloAccesoMasivo').value = '';
            document.getElementById('listaEmpleadosAccesoMasivo').innerHTML = '<p class="text-muted mb-0">Selecciona un módulo para ver los empleados</p>';
            document.getElementById('contadorEmpleadosSeleccionados').textContent = '0 empleados seleccionados';
            document.getElementById('accionAgregar').checked = true;
        });

        // Variables para el modal de estado masivo
        let empleadosEstadoMasivoLista = [];

        // Cargar lista cuando se abre el modal de estado masivo
        document.getElementById('modalEstadoMasivo').addEventListener('show.bs.modal', function() {
            cargarListaEmpleadosEstadoMasivo();
            document.getElementById('accionActivar').checked = true;
            actualizarContadorEmpleadosEstado();
            actualizarBotonEstadoMasivo();
        });

        // Cargar lista de empleados para cambio de estado masivo
        window.cargarListaEmpleadosEstadoMasivo = async function() {
            try {
                const empleadosRef = collection(db, 'empleados');
                const empleadosSnapshot = await getDocs(empleadosRef);
                
                empleadosEstadoMasivoLista = [];
                empleadosSnapshot.forEach(doc => {
                    const emp = { id: doc.id, ...doc.data() };
                    empleadosEstadoMasivoLista.push(emp);
                });

                // Ordenar por nombre
                empleadosEstadoMasivoLista.sort((a, b) => {
                    const nombreA = `${a.primerNombre || ''} ${a.primerApellido || ''}`.trim();
                    const nombreB = `${b.primerNombre || ''} ${b.primerApellido || ''}`.trim();
                    return nombreA.localeCompare(nombreB);
                });

                // Crear lista con checkboxes
                const listaContainer = document.getElementById('listaEmpleadosEstadoMasivo');
                if (empleadosEstadoMasivoLista.length === 0) {
                    listaContainer.innerHTML = '<p class="text-muted mb-0">No hay empleados disponibles</p>';
                    return;
                }

                listaContainer.innerHTML = empleadosEstadoMasivoLista.map((emp, index) => {
                    const nombre = `${emp.primerNombre || ''} ${emp.primerApellido || ''}`.trim() || 'Sin nombre';
                    const estado = emp.estado || 'Activo';
                    const esActivo = estado === 'Activo' || estado === 'activo' || estado === true;
                    const checkboxId = `empleadoEstadoCheck_${index}`;
                    return `
                        <div class="form-check mb-2 p-2" style="background: white; border-radius: 6px; border: 1px solid #e9ecef;">
                            <input class="form-check-input" type="checkbox" id="${checkboxId}" 
                                   data-empleado-id="${emp.id}" 
                                   onchange="actualizarContadorEmpleadosEstado()"
                                   style="cursor: pointer;">
                            <label class="form-check-label" for="${checkboxId}" style="cursor: pointer; width: 100%;">
                                <i class="fas fa-user text-primary me-2"></i>
                                <strong>${nombre}</strong>
                                ${esActivo 
                                    ? '<span class="badge bg-success ms-2" style="font-size: 0.75rem;">Activo</span>' 
                                    : '<span class="badge bg-danger ms-2" style="font-size: 0.75rem;">Inactivo</span>'}
                            </label>
                        </div>
                    `;
                }).join('');
                
                actualizarContadorEmpleadosEstado();
            } catch (error) {
                console.error('Error cargando empleados para estado masivo:', error);
                document.getElementById('listaEmpleadosEstadoMasivo').innerHTML = 
                    '<p class="text-danger mb-0">Error cargando empleados. Inténtalo de nuevo.</p>';
            }
        };

        // Seleccionar/deseleccionar todos los empleados en modal de estado
        window.seleccionarTodosEmpleadosEstado = function(seleccionar) {
            const checkboxes = document.querySelectorAll('#listaEmpleadosEstadoMasivo input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = seleccionar;
            });
            actualizarContadorEmpleadosEstado();
        };

        // Actualizar contador de empleados seleccionados en modal de estado
        window.actualizarContadorEmpleadosEstado = function() {
            const checkboxes = document.querySelectorAll('#listaEmpleadosEstadoMasivo input[type="checkbox"]:checked');
            const contador = document.getElementById('contadorEmpleadosEstadoSeleccionados');
            if (contador) {
                contador.textContent = `${checkboxes.length} empleado${checkboxes.length !== 1 ? 's' : ''} seleccionado${checkboxes.length !== 1 ? 's' : ''}`;
            }
            actualizarBotonEstadoMasivo();
        };

        // Actualizar texto del botón según la acción seleccionada
        window.actualizarBotonEstadoMasivo = function() {
            const accion = document.querySelector('input[name="accionEstadoMasivo"]:checked')?.value || 'activar';
            const btnAplicar = document.getElementById('btnAplicarEstadoMasivo');
            if (!btnAplicar) return;

            if (accion === 'activar') {
                btnAplicar.className = 'btn btn-success';
                btnAplicar.innerHTML = '<i class="fas fa-check me-2"></i>Activar Empleados';
            } else {
                btnAplicar.className = 'btn btn-danger';
                btnAplicar.innerHTML = '<i class="fas fa-ban me-2"></i>Desactivar Empleados';
            }
        };

        // Actualizar botón cuando cambia la acción
        document.querySelectorAll('input[name="accionEstadoMasivo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                actualizarContadorEmpleadosEstado();
            });
        });

        // Aplicar cambio de estado masivo
        window.aplicarEstadoMasivo = async function() {
            // Obtener empleados seleccionados
            const checkboxes = document.querySelectorAll('#listaEmpleadosEstadoMasivo input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Por favor selecciona al menos un empleado');
                return;
            }
            
            const empleadosIdsSeleccionados = Array.from(checkboxes).map(cb => cb.getAttribute('data-empleado-id'));
            const empleadosSeleccionados = empleadosEstadoMasivoLista.filter(emp => empleadosIdsSeleccionados.includes(emp.id));
            
            // Obtener acción (activar o desactivar)
            const accion = document.querySelector('input[name="accionEstadoMasivo"]:checked').value;
            const esActivar = accion === 'activar';
            const nuevoEstado = esActivar ? 'Activo' : 'Inactivo';
            const accionTexto = esActivar ? 'activar' : 'desactivar';
            
            const confirmacion = confirm(
                `¿Estás seguro de ${accionTexto} a ${empleadosSeleccionados.length} empleado${empleadosSeleccionados.length !== 1 ? 's' : ''} seleccionado${empleadosSeleccionados.length !== 1 ? 's' : ''}?\n\n` +
                `${esActivar ? 'Los empleados podrán ingresar al sistema.' : 'Los empleados NO podrán ingresar al sistema.'}\n\n` +
                `Esta acción solo cambia el estado. No se eliminará ningún historial.`
            );
            
            if (!confirmacion) {
                return;
            }
            
            try {
                let actualizados = 0;
                let errores = 0;
                
                // Mostrar indicador de progreso
                const btnAplicar = document.getElementById('btnAplicarEstadoMasivo');
                const textoOriginal = btnAplicar.innerHTML;
                btnAplicar.disabled = true;
                btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
                
                // Actualizar cada empleado seleccionado
                for (const empleado of empleadosSeleccionados) {
                    try {
                        const updateData = { estado: nuevoEstado };
                        // Agregar token CSRF antes de actualizar
                        if (window.csrfProtection) {
                            window.csrfProtection.addTokenToData(updateData);
                        }
                        await updateDoc(doc(db, 'empleados', empleado.id), updateData);
                        actualizados++;
                    } catch (error) {
                        console.error(`Error actualizando empleado ${empleado.id}:`, error);
                        errores++;
                    }
                }
                
                // Restaurar botón
                btnAplicar.disabled = false;
                btnAplicar.innerHTML = textoOriginal;
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEstadoMasivo'));
                modal.hide();
                
                // Mostrar resultado
                const mensaje = errores > 0
                    ? `${actualizados} empleado${actualizados !== 1 ? 's' : ''} ${accionTexto}do${actualizados !== 1 ? 's' : ''} exitosamente. ${errores} error${errores !== 1 ? 'es' : ''}.`
                    : `${actualizados} empleado${actualizados !== 1 ? 's' : ''} ${accionTexto}do${actualizados !== 1 ? 's' : ''} exitosamente.`;
                alert(mensaje);
                
                // Recargar datos
                cargarDatos();
            } catch (error) {
                console.error('Error aplicando estado masivo:', error);
                alert('Error aplicando cambios. Inténtalo de nuevo.');
            }
        };

        // Aplicar acceso masivo a un módulo
        window.aplicarAccesoMasivo = async function() {
            const modulo = document.getElementById('moduloAccesoMasivo').value;
            
            if (!modulo) {
                alert('Por favor selecciona un módulo');
                return;
            }
            
            // Obtener empleados seleccionados
            const checkboxes = document.querySelectorAll('#listaEmpleadosAccesoMasivo input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Por favor selecciona al menos un empleado');
                return;
            }
            
            const empleadosIdsSeleccionados = Array.from(checkboxes).map(cb => cb.getAttribute('data-empleado-id'));
            const empleadosSeleccionados = empleadosActivosLista.filter(emp => empleadosIdsSeleccionados.includes(emp.id));
            
            // Obtener acción (agregar o quitar)
            const accion = document.querySelector('input[name="accionAccesoMasivo"]:checked').value;
            const esAgregar = accion === 'agregar';
            const nombreModulo = document.getElementById('moduloAccesoMasivo').selectedOptions[0].text;
            const accionTexto = esAgregar ? 'dar acceso' : 'quitar acceso';
            
            const confirmacion = confirm(
                `¿Estás seguro de ${accionTexto} al módulo "${nombreModulo}" a ${empleadosSeleccionados.length} empleado${empleadosSeleccionados.length !== 1 ? 's' : ''} seleccionado${empleadosSeleccionados.length !== 1 ? 's' : ''}?\n\n` +
                `Esto actualizará los permisos de los empleados seleccionados.`
            );
            
            if (!confirmacion) {
                return;
            }
            
            try {
                let actualizados = 0;
                let errores = 0;
                
                // Mostrar indicador de progreso
                const btnAplicar = event.target;
                const textoOriginal = btnAplicar.innerHTML;
                btnAplicar.disabled = true;
                btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
                
                // Actualizar cada empleado seleccionado
                for (const empleado of empleadosSeleccionados) {
                    try {
                        const permisosActuales = empleado.permisos || {};
                        const nuevosPermisos = { ...permisosActuales };
                        
                        if (esAgregar) {
                            // Agregar permiso
                            nuevosPermisos[modulo] = true;
                        } else {
                            // Quitar permiso
                            delete nuevosPermisos[modulo];
                        }
                        
                        const permisosUpdateData = { permisos: nuevosPermisos };
                        // Agregar token CSRF antes de actualizar permisos
                        if (window.csrfProtection) {
                            window.csrfProtection.addTokenToData(permisosUpdateData);
                        }
                        await updateDoc(doc(db, 'empleados', empleado.id), permisosUpdateData);
                        actualizados++;
                    } catch (error) {
                        console.error(`Error actualizando empleado ${empleado.id}:`, error);
                        errores++;
                    }
                }
                
                // Restaurar botón
                btnAplicar.disabled = false;
                btnAplicar.innerHTML = textoOriginal;
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAccesoMasivo'));
                modal.hide();
                
                // Mostrar resultado
                const accionCompletada = esAgregar ? 'otorgado' : 'revocado';
                if (errores === 0) {
                    alert(`✅ Acceso ${accionCompletada} exitosamente\n\n${actualizados} empleado${actualizados !== 1 ? 's' : ''} actualizado${actualizados !== 1 ? 's' : ''} correctamente.`);
                } else {
                    alert(`⚠️ Proceso completado con algunos errores\n\n✅ Actualizados: ${actualizados}\n❌ Errores: ${errores}`);
                }
                
                // Recargar datos
                cargarDatos();
                
            } catch (error) {
                console.error('❌ Error aplicando acceso masivo:', error);
                alert('Error al aplicar acceso masivo. Inténtalo de nuevo.');
                
                // Restaurar botón
                const btnAplicar = event.target;
                btnAplicar.disabled = false;
                btnAplicar.innerHTML = esAgregar ? '<i class="fas fa-plus me-2"></i>Agregar Acceso' : '<i class="fas fa-minus me-2"></i>Quitar Acceso';
            }
        };

        // Función para calcular días de vacaciones ganados según legislación de Costa Rica
        function calcularDiasGanados(fechaIngreso) {
            if (!fechaIngreso) return 0;
            
            const fechaIngresoObj = new Date(fechaIngreso + 'T00:00:00');
            const fechaActual = new Date();
            
            // Calcular diferencia en meses
            const mesesTrabajados = (fechaActual.getFullYear() - fechaIngresoObj.getFullYear()) * 12 + 
                                   (fechaActual.getMonth() - fechaIngresoObj.getMonth());
            
            // Ajustar por días del mes
            const diasDelMes = fechaActual.getDate() - fechaIngresoObj.getDate();
            const mesesDecimales = mesesTrabajados + (diasDelMes / 30);
            
            // Fórmula Costa Rica: meses trabajados × 1.1667 días por mes
            const diasGanados = mesesDecimales * 1.1667;
            
            return Math.max(0, Math.round(diasGanados * 100) / 100); // Redondear a 2 decimales
        }

        // Función para calcular días redimidos (desde 01/12/2025 + días manuales antes de 01/12/2025)
        // Retorna objeto con desglose detallado
        // IMPORTANTE: Cuenta días del PERÍODO de vacaciones que caen después del 01/12/2025,
        // no por fecha de aprobación
        function calcularDiasRedimidos(vacacionesAprobadas, diasManualesAntes2025) {
            const fechaCorte = new Date('2025-12-01T00:00:00');
            fechaCorte.setHours(0, 0, 0, 0); // Normalizar a inicio del día
            let diasAprobadosDesde2025 = 0;
            
            // Sumar días de solicitudes aprobadas que caen después del 01/12/2025
            vacacionesAprobadas.forEach(vac => {
                let diasDespues2025 = 0;
                
                // Si tiene array de días, contar solo los que caen después del 01/12/2025
                if (vac.dias && Array.isArray(vac.dias) && vac.dias.length > 0) {
                    vac.dias.forEach(diaTimestamp => {
                        try {
                            const fechaDia = diaTimestamp.toDate ? diaTimestamp.toDate() : new Date(diaTimestamp);
                            fechaDia.setHours(0, 0, 0, 0); // Normalizar a inicio del día
                            if (fechaDia >= fechaCorte) {
                                diasDespues2025++;
                            }
                        } catch (e) {
                            console.warn('Error procesando día de vacación:', e);
                        }
                    });
                } else {
                    // Fallback: usar fechaInicio si no hay array de días
                    const fechaInicio = vac.fechaInicio?.toDate ? vac.fechaInicio.toDate() : null;
                    if (fechaInicio) {
                        fechaInicio.setHours(0, 0, 0, 0);
                        // Si el período de vacaciones inicia después del 01/12/2025, contar todos los días
                        if (fechaInicio >= fechaCorte) {
                            diasDespues2025 = vac.totalDias || 0;
                        } else {
                            // Si el período inicia antes pero termina después, contar días parciales
                            const fechaFin = vac.fechaFin?.toDate ? vac.fechaFin.toDate() : null;
                            if (fechaFin) {
                                fechaFin.setHours(0, 0, 0, 0);
                                if (fechaFin >= fechaCorte) {
                                    // Calcular días desde el 01/12/2025 hasta el fin
                                    const diffTime = fechaFin.getTime() - fechaCorte.getTime();
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                    diasDespues2025 = Math.min(diffDays, vac.totalDias || 0);
                                }
                            }
                        }
                    }
                }
                
                diasAprobadosDesde2025 += diasDespues2025;
            });
            
            // Sumar días manuales registrados antes del 01/12/2025
            const diasManuales = parseFloat(diasManualesAntes2025) || 0;
            const total = diasAprobadosDesde2025 + diasManuales;
            
            return {
                total: total,
                diasManualesAntes2025: diasManuales,
                diasAprobadosDesde2025: diasAprobadosDesde2025
            };
        }

        // Cargar saldo de vacaciones por empleado
        window.cargarSaldoVacaciones = async function() {
            const tabla = document.getElementById('tablaSaldoVacaciones');
            if (!tabla) return;
            
            tabla.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Cargando saldo de vacaciones...
                    </td>
                </tr>
            `;
            
            try {
                // Cargar empleados si no están cargados
                if (!empleados || empleados.length === 0) {
                    const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                    empleados = empleadosSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                // Cargar todas las solicitudes de vacaciones
                const vacacionesSnapshot = await getDocs(collection(db, 'vacaciones'));
                const todasVacaciones = vacacionesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Crear mapa de vacaciones por empleado
                // IMPORTANTE: Usar username como clave para consistencia
                const vacacionesPorEmpleado = {};
                
                todasVacaciones.forEach(vac => {
                    // Normalizar: usar empleadoId de la vacación, pero también verificar empleadoUsername como fallback
                    const empleadoKey = vac.empleadoId || vac.empleadoUsername || '';
                    
                    // Si no hay identificador, saltar esta vacación
                    if (!empleadoKey) {
                        console.warn('⚠️ Vacación sin empleadoId/empleadoUsername encontrada:', vac);
                        return;
                    }
                    
                    if (!vacacionesPorEmpleado[empleadoKey]) {
                        vacacionesPorEmpleado[empleadoKey] = {
                            aprobadas: [],
                            pendientes: [],
                            rechazadas: [],
                            totalDiasUsados: 0
                        };
                    }
                    
                    const dias = vac.totalDias || (vac.dias ? vac.dias.length : 0);
                    
                    if (vac.estado === 'aprobada' || vac.estado === 'aprobado') {
                        vacacionesPorEmpleado[empleadoKey].aprobadas.push(vac);
                        vacacionesPorEmpleado[empleadoKey].totalDiasUsados += dias;
                    } else if (vac.estado === 'pendiente') {
                        vacacionesPorEmpleado[empleadoKey].pendientes.push(vac);
                    } else if (vac.estado === 'rechazada' || vac.estado === 'rechazado') {
                        vacacionesPorEmpleado[empleadoKey].rechazadas.push(vac);
                    }
                });
                
                // Generar HTML de la tabla
                let html = '';
                
                if (empleados.length === 0) {
                    html = `
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">
                                No hay empleados registrados
                            </td>
                        </tr>
                    `;
                } else {
                    // Calcular saldos primero para poder ordenar
                    const empleadosConSaldo = empleados.map(emp => {
                        // IMPORTANTE: Buscar vacaciones usando username (que es lo que se guarda en empleadoId de vacaciones)
                        const username = emp.username || emp.id;
                        
                        // Buscar vacaciones: primero por username, luego por id como fallback
                        let vacaciones = vacacionesPorEmpleado[username];
                        if (!vacaciones && emp.id !== username) {
                            vacaciones = vacacionesPorEmpleado[emp.id];
                        }
                        
                        // Si aún no hay, usar objeto vacío
                        if (!vacaciones) {
                            vacaciones = {
                                aprobadas: [],
                                pendientes: [],
                                rechazadas: [],
                                totalDiasUsados: 0
                            };
                        }
                        
                        const diasGanados = calcularDiasGanados(emp.fechaIngreso);
                        const diasRedimidosInfo = calcularDiasRedimidos(
                            vacaciones.aprobadas,
                            emp.diasVacacionesAntes2025 || 0
                        );
                        const diasRedimidos = diasRedimidosInfo.total;
                        const saldoDisponible = diasGanados - diasRedimidos;
                        const saldoDisponibleCompleto = Math.floor(saldoDisponible);
                        
                        return {
                            ...emp,
                            saldoDisponibleCompleto
                        };
                    });
                    
                    // Ordenar empleados por saldo descendente (mayor a menor)
                    const empleadosOrdenados = empleadosConSaldo.sort((a, b) => {
                        return b.saldoDisponibleCompleto - a.saldoDisponibleCompleto;
                    });
                    
                    empleadosOrdenados.forEach(emp => {
                        const nombreCompleto = `${emp.primerNombre || ''} ${emp.segundoNombre || ''} ${emp.primerApellido || ''} ${emp.segundoApellido || ''}`.trim();
                        const username = emp.username || emp.id;
                        
                        // Buscar vacaciones: primero por username, luego por id como fallback
                        let vacaciones = vacacionesPorEmpleado[username];
                        if (!vacaciones && emp.id !== username) {
                            vacaciones = vacacionesPorEmpleado[emp.id];
                        }
                        
                        // Si aún no hay, usar objeto vacío
                        if (!vacaciones) {
                            vacaciones = {
                                aprobadas: [],
                                pendientes: [],
                                rechazadas: [],
                                totalDiasUsados: 0
                            };
                        }
                        
                        // Calcular días ganados basado en fecha de ingreso
                        const diasGanados = calcularDiasGanados(emp.fechaIngreso);
                        
                        // Calcular días redimidos con desglose (días aprobados desde 01/12/2025 + días manuales antes de 01/12/2025)
                        const diasRedimidosInfo = calcularDiasRedimidos(
                            vacaciones.aprobadas,
                            emp.diasVacacionesAntes2025 || 0
                        );
                        const diasRedimidos = diasRedimidosInfo.total;
                        
                        // Calcular saldo disponible
                        const saldoDisponible = diasGanados - diasRedimidos;
                        
                        // Aplicar FLOOR para redondear hacia abajo a días completos (no adelantar días)
                        const saldoDisponibleCompleto = Math.floor(saldoDisponible);
                        const diasGanadosCompleto = Math.floor(diasGanados);
                        const diasRedimidosCompleto = Math.floor(diasRedimidos);
                        const diasManualesAntes2025 = Math.floor(diasRedimidosInfo.diasManualesAntes2025);
                        const diasAprobadosDesde2025 = Math.floor(diasRedimidosInfo.diasAprobadosDesde2025);
                        
                        const aprobadas = vacaciones.aprobadas.length;
                        const pendientes = vacaciones.pendientes.length;
                        const rechazadas = vacaciones.rechazadas.length;
                        const diasManuales = parseFloat(emp.diasVacacionesAntes2025) || 0;
                        const fechaIngreso = emp.fechaIngreso || '';
                        const fechaIngresoDisplay = fechaIngreso 
                            ? new Date(fechaIngreso + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })
                            : '<span class="text-muted"><i class="fas fa-calendar-times me-1"></i>Sin fecha</span>';
                        
                        // Determinar color del badge según saldo disponible (usar saldo completo para colores)
                        let badgeClass = 'bg-success';
                        if (saldoDisponibleCompleto < 5) badgeClass = 'bg-warning text-dark';
                        if (saldoDisponibleCompleto < 0) badgeClass = 'bg-danger';
                        
                        // Combinar estado de solicitudes en un solo indicador
                        const totalSolicitudes = aprobadas + pendientes + rechazadas;
                        const estadoTexto = totalSolicitudes > 0 
                            ? `${aprobadas}✓ / ${pendientes}⏳ / ${rechazadas}✗`
                            : 'Sin solicitudes';
                        const estadoTooltip = `Aprobadas: ${aprobadas}, Pendientes: ${pendientes}, Rechazadas: ${rechazadas}`;
                        
                        html += `
                            <tr style="line-height: 1.2;">
                                <td style="padding: 4px 8px;">
                                    <div class="fw-bold" style="font-size: 0.85rem;">${nombreCompleto || username}</div>
                                    <small class="text-muted" style="font-size: 0.65rem;">${username}</small>
                                </td>
                                <td style="padding: 4px 8px;">
                                    <div style="display: flex; flex-direction: column; gap: 2px; font-size: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span class="text-muted" style="font-size: 0.7rem;">Ganados:</span>
                                            <span class="fw-bold text-info">${diasGanadosCompleto}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e9ecef; padding-top: 2px; margin-top: 2px;">
                                            <span class="text-muted" style="font-size: 0.7rem;">Devengados:</span>
                                            <span class="fw-bold text-warning">${diasRedimidosCompleto}</span>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 1px; padding-left: 8px; margin-top: 2px; font-size: 0.65rem; border-left: 2px solid #ffc107;">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span class="text-muted" style="font-size: 0.65rem;">• Antes 01/12/2025:</span>
                                                <span class="text-secondary fw-bold">${diasManualesAntes2025}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span class="text-muted" style="font-size: 0.65rem;">• Después 01/12/2025:</span>
                                                <span class="text-secondary fw-bold">${diasAprobadosDesde2025}</span>
                                            </div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #dee2e6; padding-top: 2px; margin-top: 2px;">
                                            <span class="text-muted fw-bold" style="font-size: 0.75rem;">Saldo:</span>
                                            <span class="badge ${badgeClass}" style="font-size: 0.75rem; padding: 2px 6px;">
                                                ${saldoDisponibleCompleto}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center" style="padding: 4px 8px;">
                                    <div class="fecha-ingreso-editable-vacaciones" data-empleado-id="${emp.id}" style="position: relative;">
                                        <div class="fecha-display-wrapper-vacaciones" style="display: inline-flex; align-items: center; gap: 2px; cursor: pointer; padding: 1px 4px; border-radius: 3px; transition: all 0.2s; border: 1px dashed transparent;" 
                                             onmouseover="this.style.borderColor='#28a745'; this.style.background='#f0f8f0';" 
                                             onmouseout="if(!this.querySelector('.fecha-input-vacaciones:focus')) { this.style.borderColor='transparent'; this.style.background=''; }">
                                            <span class="fecha-display-vacaciones" style="display: inline-block; font-size: 0.7rem;">
                                                ${fechaIngresoDisplay}
                                            </span>
                                            <i class="fas fa-edit" style="font-size: 0.55rem; color: #28a745; opacity: 0.7;"></i>
                                        </div>
                                        <input type="date" 
                                               class="fecha-input-vacaciones" 
                                               value="${fechaIngreso}" 
                                               data-empleado-id="${emp.id}"
                                               style="display: none; font-size: 0.7rem; padding: 2px 4px; width: 120px; border: 2px solid #28a745; border-radius: 3px; outline: none;"
                                               onblur="guardarFechaIngresoVacaciones('${emp.id}', this.value)"
                                               onkeydown="if(event.key === 'Enter') { this.blur(); } if(event.key === 'Escape') { cancelarEdicionFechaVacaciones('${emp.id}'); }">
                                    </div>
                                </td>
                                <td class="text-center" style="padding: 4px 8px;">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" style="padding: 2px 6px; font-size: 0.7rem;" onclick="verDetalleVacaciones('${username}', '${nombreCompleto}')" title="Ver detalle completo">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                        <button class="btn btn-outline-info" style="padding: 2px 6px; font-size: 0.7rem;" onclick="mostrarDesgloseVacaciones('${nombreCompleto || username}', ${diasGanadosCompleto}, ${diasRedimidosCompleto}, ${saldoDisponibleCompleto}, ${diasManualesAntes2025}, ${diasAprobadosDesde2025}, '${fechaIngresoDisplay}', '${estadoTooltip}')" title="Ver desglose para enviar">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" style="padding: 2px 6px; font-size: 0.7rem;" onclick="editarDiasManualesVacaciones('${emp.id}', '${diasManuales}')" title="Editar días antes 01/12/2025">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tabla.innerHTML = html;
                
                // Actualizar fecha de última actualización
                const ahora = new Date();
                const fechaStr = ahora.toLocaleString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('ultimaActualizacionVacaciones').textContent = fechaStr;
                
            } catch (error) {
                console.error('Error cargando saldo de vacaciones:', error);
                tabla.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar saldo de vacaciones: ${error.message}
                        </td>
                    </tr>
                `;
            }
        };

        // Hacer fecha de ingreso editable en tabla de vacaciones
        document.addEventListener('click', function(e) {
            const fechaDisplayWrapper = e.target.closest('.fecha-display-wrapper-vacaciones');
            if (fechaDisplayWrapper) {
                const container = fechaDisplayWrapper.closest('.fecha-ingreso-editable-vacaciones');
                const input = container.querySelector('.fecha-input-vacaciones');
                const displayWrapper = container.querySelector('.fecha-display-wrapper-vacaciones');
                
                if (input && displayWrapper) {
                    displayWrapper.style.display = 'none';
                    input.style.display = 'inline-block';
                    input.focus();
                    input.showPicker && input.showPicker();
                }
            }
            
            const diasDisplayWrapper = e.target.closest('.dias-display-wrapper-vacaciones');
            if (diasDisplayWrapper) {
                const container = diasDisplayWrapper.closest('.dias-manuales-editable-vacaciones');
                const input = container.querySelector('.dias-input-vacaciones');
                const displayWrapper = container.querySelector('.dias-display-wrapper-vacaciones');
                
                if (input && displayWrapper) {
                    displayWrapper.style.display = 'none';
                    input.style.display = 'inline-block';
                    input.focus();
                    input.select();
                }
            }
        });

        // Cancelar edición de fecha en tabla de vacaciones
        window.cancelarEdicionFechaVacaciones = function(empleadoId) {
            const container = document.querySelector(`.fecha-ingreso-editable-vacaciones[data-empleado-id="${empleadoId}"]`);
            if (!container) return;
            
            const input = container.querySelector('.fecha-input-vacaciones');
            const displayWrapper = container.querySelector('.fecha-display-wrapper-vacaciones');
            
            // Restaurar valor original
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (empleado && input) {
                input.value = empleado.fechaIngreso || '';
            }
            
            // Ocultar input y mostrar display
            if (input) input.style.display = 'none';
            if (displayWrapper) displayWrapper.style.display = 'inline-flex';
        };

        // Guardar fecha de ingreso en tabla de vacaciones
        window.guardarFechaIngresoVacaciones = async function(empleadoId, nuevaFecha) {
            const container = document.querySelector(`.fecha-ingreso-editable-vacaciones[data-empleado-id="${empleadoId}"]`);
            if (!container) return;
            
            const input = container.querySelector('.fecha-input-vacaciones');
            const displayWrapper = container.querySelector('.fecha-display-wrapper-vacaciones');
            const display = displayWrapper ? displayWrapper.querySelector('.fecha-display-vacaciones') : null;
            
            // Ocultar input y mostrar display
            if (input) input.style.display = 'none';
            if (displayWrapper) displayWrapper.style.display = 'inline-flex';
            
            // Si no hay cambio, no hacer nada
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (!empleado) return;
            
            if (empleado.fechaIngreso === nuevaFecha) {
                return;
            }
            
            try {
                // Actualizar en Firestore
                const updateData = { fechaIngreso: nuevaFecha || null };
                
                // Agregar token CSRF si está disponible
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(updateData);
                }
                
                await updateDoc(doc(db, 'empleados', empleadoId), updateData);
                
                // Actualizar en el array local
                empleado.fechaIngreso = nuevaFecha;
                
                // Actualizar display
                if (display) {
                    if (nuevaFecha) {
                        const fechaObj = new Date(nuevaFecha + 'T00:00:00');
                        display.innerHTML = fechaObj.toLocaleDateString('es-ES', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric' 
                        });
                    } else {
                        display.innerHTML = '<span class="text-muted"><i class="fas fa-calendar-times me-1"></i>Sin fecha</span>';
                    }
                }
                
                // Actualizar input
                if (input) {
                    input.value = nuevaFecha || '';
                }
                
                // Mostrar feedback visual
                if (displayWrapper) {
                    displayWrapper.style.background = '#d4edda';
                    displayWrapper.style.borderColor = '#28a745';
                    setTimeout(() => {
                        displayWrapper.style.background = '';
                        displayWrapper.style.borderColor = 'transparent';
                    }, 1500);
                }
                
                // Recargar la tabla de vacaciones para actualizar cálculos
                window.cargarSaldoVacaciones();
                
                console.log(`✅ Fecha de ingreso actualizada para empleado ${empleadoId}`);
                
            } catch (error) {
                console.error('Error actualizando fecha de ingreso:', error);
                alert('Error al actualizar la fecha de ingreso: ' + error.message);
                
                // Restaurar valor anterior
                if (input) input.value = empleado.fechaIngreso || '';
            }
        };

        // Cancelar edición de días manuales en tabla de vacaciones
        window.cancelarEdicionDiasVacaciones = function(empleadoId) {
            const container = document.querySelector(`.dias-manuales-editable-vacaciones[data-empleado-id="${empleadoId}"]`);
            if (!container) return;
            
            const input = container.querySelector('.dias-input-vacaciones');
            const displayWrapper = container.querySelector('.dias-display-wrapper-vacaciones');
            
            // Restaurar valor original
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (empleado && input) {
                input.value = parseFloat(empleado.diasVacacionesAntes2025) || 0;
            }
            
            // Ocultar input y mostrar display
            if (input) input.style.display = 'none';
            if (displayWrapper) displayWrapper.style.display = 'inline-flex';
        };

        // Mostrar desglose de vacaciones para enviar al empleado
        window.mostrarDesgloseVacaciones = function(nombreEmpleado, diasGanados, diasDevengados, saldo, diasManualesAntes2025, diasAprobadosDesde2025, fechaIngreso, estadoSolicitudes) {
            const fechaActual = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
            
            const desgloseTexto = `
📋 SALDO DE VACACIONES - ${nombreEmpleado}

📅 Ingreso: ${fechaIngreso} | Consulta: ${fechaActual}

✅ Días Ganados: ${diasGanados} días

💰 Días Devengados: ${diasDevengados} días
   • Antes del 01/12/2025: ${diasManualesAntes2025} días
   • Después del 01/12/2025: ${diasAprobadosDesde2025} días

💼 Saldo Disponible: ${saldo} días

Calculado según legislación de Costa Rica.
            `.trim();
            
            // Crear modal con el desglose
            const modalHTML = `
                <div class="modal fade" id="modalDesgloseVacaciones" tabindex="-1">
                    <div class="modal-dialog modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-info-circle me-2"></i>Desglose de Vacaciones: ${nombreEmpleado}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="card">
                                    <div class="card-body">
                                        <pre style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9rem; line-height: 1.6; margin: 0; background: #f8f9fa; padding: 15px; border-radius: 5px;">${desgloseTexto}</pre>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-primary" onclick="copiarDesgloseVacaciones()">
                                    <i class="fas fa-copy me-2"></i>Copiar Desglose
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const modalAnterior = document.getElementById('modalDesgloseVacaciones');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Agregar modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Guardar texto en variable global para copiar
            window.desgloseVacacionesTexto = desgloseTexto;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalDesgloseVacaciones'));
            modal.show();
            
            // Limpiar modal al cerrar
            document.getElementById('modalDesgloseVacaciones').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        };
        
        // Copiar desglose al portapapeles
        window.copiarDesgloseVacaciones = function() {
            if (window.desgloseVacacionesTexto) {
                navigator.clipboard.writeText(window.desgloseVacacionesTexto).then(() => {
                    alert('✅ Desglose copiado al portapapeles. Ya puedes enviarlo al empleado.');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    // Fallback: seleccionar texto manualmente
                    const textarea = document.createElement('textarea');
                    textarea.value = window.desgloseVacacionesTexto;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('✅ Desglose copiado al portapapeles. Ya puedes enviarlo al empleado.');
                });
            }
        };

        // Editar días manuales desde botón de acciones
        window.editarDiasManualesVacaciones = async function(empleadoId, diasActuales) {
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (!empleado) return;
            
            const nombreEmpleado = `${empleado.primerNombre || ''} ${empleado.primerApellido || ''}`.trim() || empleado.username;
            const nuevoValor = prompt(
                `Editar días redimidos antes del 01/12/2025\n\n` +
                `Empleado: ${nombreEmpleado}\n` +
                `Valor actual: ${diasActuales} días\n\n` +
                `Ingrese el nuevo valor:`,
                diasActuales
            );
            
            if (nuevoValor === null) return; // Usuario canceló
            
            const diasValue = parseFloat(nuevoValor);
            if (isNaN(diasValue) || diasValue < 0) {
                alert('Por favor ingrese un valor numérico válido mayor o igual a 0');
                return;
            }
            
            // Usar la función existente para guardar
            await window.guardarDiasManualesVacaciones(empleadoId, diasValue);
        };

        // Guardar días manuales en tabla de vacaciones
        window.guardarDiasManualesVacaciones = async function(empleadoId, nuevosDias) {
            const container = document.querySelector(`.dias-manuales-editable-vacaciones[data-empleado-id="${empleadoId}"]`);
            if (!container) return;
            
            const input = container.querySelector('.dias-input-vacaciones');
            const displayWrapper = container.querySelector('.dias-display-wrapper-vacaciones');
            const display = displayWrapper ? displayWrapper.querySelector('.dias-display-vacaciones') : null;
            
            // Ocultar input y mostrar display
            if (input) input.style.display = 'none';
            if (displayWrapper) displayWrapper.style.display = 'inline-flex';
            
            // Validar y convertir valor
            const diasValue = parseFloat(nuevosDias) || 0;
            if (diasValue < 0) {
                alert('Los días no pueden ser negativos');
                return;
            }
            
            // Si no hay cambio, no hacer nada
            const empleado = empleados.find(emp => emp.id === empleadoId);
            if (!empleado) return;
            
            const diasActuales = parseFloat(empleado.diasVacacionesAntes2025) || 0;
            if (diasActuales === diasValue) {
                return;
            }
            
            try {
                // Actualizar en Firestore
                const updateData = { diasVacacionesAntes2025: diasValue };
                
                // Agregar token CSRF si está disponible
                if (window.csrfProtection) {
                    window.csrfProtection.addTokenToData(updateData);
                }
                
                await updateDoc(doc(db, 'empleados', empleadoId), updateData);
                
                // Actualizar en el array local
                empleado.diasVacacionesAntes2025 = diasValue;
                
                // Actualizar display
                if (display) {
                    display.textContent = diasValue;
                }
                
                // Actualizar input
                if (input) {
                    input.value = diasValue;
                }
                
                // Mostrar feedback visual
                if (displayWrapper) {
                    displayWrapper.style.background = '#d4edda';
                    displayWrapper.style.borderColor = '#6c757d';
                    setTimeout(() => {
                        displayWrapper.style.background = '';
                        displayWrapper.style.borderColor = 'transparent';
                    }, 1500);
                }
                
                // Recargar la tabla de vacaciones para actualizar cálculos
                window.cargarSaldoVacaciones();
                
                console.log(`✅ Días manuales actualizados para empleado ${empleadoId}`);
                
            } catch (error) {
                console.error('Error actualizando días manuales:', error);
                alert('Error al actualizar los días: ' + error.message);
                
                // Restaurar valor anterior
                if (input) input.value = diasActuales;
            }
        };

        // Ver detalle de vacaciones de un empleado
        window.verDetalleVacaciones = async function(empleadoId, empleadoNombre) {
            try {
                // Cargar todas las solicitudes del empleado (sin orderBy para evitar índice compuesto)
                const q = query(
                    collection(db, 'vacaciones'),
                    where('empleadoId', '==', empleadoId)
                );
                
                const snapshot = await getDocs(q);
                const solicitudes = [];
                snapshot.forEach(doc => {
                    solicitudes.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenar en memoria por fechaSolicitud (descendente)
                solicitudes.sort((a, b) => {
                    const fechaA = a.fechaSolicitud?.toDate ? a.fechaSolicitud.toDate() : (a.fechaSolicitud ? new Date(a.fechaSolicitud) : new Date(0));
                    const fechaB = b.fechaSolicitud?.toDate ? b.fechaSolicitud.toDate() : (b.fechaSolicitud ? new Date(b.fechaSolicitud) : new Date(0));
                    return fechaB - fechaA; // Descendente
                });
                
                if (solicitudes.length === 0) {
                    alert(`${empleadoNombre} no tiene solicitudes de vacaciones registradas.`);
                    return;
                }
                
                // Crear modal con detalle
                let detalleHTML = `
                    <div class="modal fade" id="modalDetalleVacaciones" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-umbrella-beach me-2"></i>Detalle de Vacaciones: ${empleadoNombre}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Fecha Solicitud</th>
                                                    <th>Período</th>
                                                    <th>Días</th>
                                                    <th>Estado</th>
                                                    <th>Motivo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;
                
                solicitudes.forEach(sol => {
                    const fechaSol = sol.fechaSolicitud ? sol.fechaSolicitud.toDate().toLocaleDateString('es-ES') : 'N/A';
                    const fechaInicio = sol.fechaInicio ? sol.fechaInicio.toDate().toLocaleDateString('es-ES') : 'N/A';
                    const fechaFin = sol.fechaFin ? sol.fechaFin.toDate().toLocaleDateString('es-ES') : 'N/A';
                    const dias = sol.totalDias || (sol.dias ? sol.dias.length : 'N/A');
                    
                    let estadoBadge = '';
                    if (sol.estado === 'aprobada') {
                        estadoBadge = '<span class="badge bg-success">Aprobada</span>';
                    } else if (sol.estado === 'pendiente') {
                        estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
                    } else {
                        estadoBadge = '<span class="badge bg-danger">Rechazada</span>';
                    }
                    
                    detalleHTML += `
                        <tr>
                            <td>${fechaSol}</td>
                            <td>
                                <small>Del ${fechaInicio}</small><br>
                                <small>Al ${fechaFin}</small>
                            </td>
                            <td><span class="badge bg-info text-dark">${dias} días</span></td>
                            <td>${estadoBadge}</td>
                            <td>${sol.motivo || '<span class="text-muted">-</span>'}</td>
                        </tr>
                    `;
                });
                
                detalleHTML += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal anterior si existe
                const modalAnterior = document.getElementById('modalDetalleVacaciones');
                if (modalAnterior) {
                    modalAnterior.remove();
                }
                
                // Agregar nuevo modal al body
                document.body.insertAdjacentHTML('beforeend', detalleHTML);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalDetalleVacaciones'));
                modal.show();
                
                // Limpiar modal cuando se cierre
                document.getElementById('modalDetalleVacaciones').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
            } catch (error) {
                console.error('Error cargando detalle de vacaciones:', error);
                alert('Error al cargar el detalle de vacaciones: ' + error.message);
            }
        };

        // Mostrar liquidación detallada de vacaciones
        window.mostrarLiquidacionVacaciones = async function() {
            try {
                // Cargar empleados si no están cargados
                if (!empleados || empleados.length === 0) {
                    const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                    empleados = empleadosSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                // Cargar solicitudes de vacaciones
                const vacacionesSnapshot = await getDocs(collection(db, 'vacaciones'));
                const vacacionesPorEmpleado = {};
                vacacionesSnapshot.forEach(doc => {
                    const vac = doc.data();
                    // Normalizar: usar empleadoId como clave principal, empleadoUsername como fallback
                    const username = vac.empleadoId || vac.empleadoUsername || '';
                    
                    // Si no hay identificador, saltar esta vacación
                    if (!username) {
                        console.warn('⚠️ Vacación sin empleadoId/empleadoUsername encontrada en liquidación:', vac);
                        return;
                    }
                    
                    if (!vacacionesPorEmpleado[username]) {
                        vacacionesPorEmpleado[username] = {
                            aprobadas: [],
                            pendientes: [],
                            rechazadas: []
                        };
                    }
                    if (vac.estado === 'aprobada' || vac.estado === 'aprobado') {
                        vacacionesPorEmpleado[username].aprobadas.push(vac);
                    } else if (vac.estado === 'pendiente') {
                        vacacionesPorEmpleado[username].pendientes.push(vac);
                    } else if (vac.estado === 'rechazada' || vac.estado === 'rechazado') {
                        vacacionesPorEmpleado[username].rechazadas.push(vac);
                    }
                });
                
                // Calcular liquidación para cada empleado
                const fechaActual = new Date();
                const fechaCorte = new Date('2025-12-01T00:00:00');
                
                let liquidacionHTML = `
                    <div class="modal fade" id="modalLiquidacionVacaciones" tabindex="-1">
                        <div class="modal-dialog modal-xl modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-calculator me-2"></i>Liquidación Detallada de Vacaciones
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" style="padding: 20px;">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" style="font-size: 0.85rem;">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th style="padding: 8px;">Empleado</th>
                                                    <th style="padding: 8px;">Fecha Ingreso</th>
                                                    <th style="padding: 8px;">Meses Trabajados</th>
                                                    <th style="padding: 8px;">Días Ganados</th>
                                                    <th style="padding: 8px;">Días Redimidos</th>
                                                    <th style="padding: 8px;">Saldo Final</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;
                
                // Ordenar empleados por nombre
                const empleadosOrdenados = [...empleados].sort((a, b) => {
                    const nombreA = `${a.primerNombre || ''} ${a.primerApellido || ''}`.toLowerCase();
                    const nombreB = `${b.primerNombre || ''} ${b.primerApellido || ''}`.toLowerCase();
                    return nombreA.localeCompare(nombreB);
                });
                
                empleadosOrdenados.forEach(emp => {
                    const nombreCompleto = `${emp.primerNombre || ''} ${emp.segundoNombre || ''} ${emp.primerApellido || ''} ${emp.segundoApellido || ''}`.trim();
                    const username = emp.username || emp.id;
                    
                    // Buscar vacaciones: primero por username, luego por id como fallback
                    let vacaciones = vacacionesPorEmpleado[username];
                    if (!vacaciones && emp.id !== username) {
                        vacaciones = vacacionesPorEmpleado[emp.id];
                    }
                    
                    // Si aún no hay, usar objeto vacío
                    if (!vacaciones) {
                        vacaciones = {
                            aprobadas: [],
                            pendientes: [],
                            rechazadas: []
                        };
                    }
                    
                    // Calcular días ganados con detalle
                    let mesesTrabajados = 0;
                    let mesesDecimales = 0;
                    let diasGanados = 0;
                    let fechaIngresoDisplay = 'Sin fecha';
                    
                    if (emp.fechaIngreso) {
                        const fechaIngresoObj = new Date(emp.fechaIngreso + 'T00:00:00');
                        fechaIngresoDisplay = fechaIngresoObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        
                        mesesTrabajados = (fechaActual.getFullYear() - fechaIngresoObj.getFullYear()) * 12 + 
                                         (fechaActual.getMonth() - fechaIngresoObj.getMonth());
                        const diasDelMes = fechaActual.getDate() - fechaIngresoObj.getDate();
                        mesesDecimales = mesesTrabajados + (diasDelMes / 30);
                        diasGanados = mesesDecimales * 1.1667;
                    }
                    
                    // Calcular días redimidos con detalle
                    let diasAprobadosDesde2025 = 0;
                    const detalleAprobadas = [];
                    vacaciones.aprobadas.forEach(vac => {
                        const fechaAprobacion = vac.fechaAprobacion?.toDate ? vac.fechaAprobacion.toDate() : null;
                        if (fechaAprobacion && fechaAprobacion >= fechaCorte) {
                            const dias = vac.totalDias || (vac.dias ? vac.dias.length : 0);
                            diasAprobadosDesde2025 += dias;
                            detalleAprobadas.push({
                                fecha: fechaAprobacion.toLocaleDateString('es-ES'),
                                dias: dias
                            });
                        }
                    });
                    
                    const diasManuales = parseFloat(emp.diasVacacionesAntes2025) || 0;
                    const diasRedimidos = diasAprobadosDesde2025 + diasManuales;
                    
                    // Calcular saldo final (con FLOOR)
                    const saldoDisponible = diasGanados - diasRedimidos;
                    const saldoFinal = Math.floor(saldoDisponible);
                    
                    // Determinar color de fila según saldo
                    let rowClass = '';
                    if (saldoFinal < 0) rowClass = 'table-danger';
                    else if (saldoFinal < 5) rowClass = 'table-warning';
                    else rowClass = 'table-success';
                    
                    liquidacionHTML += `
                        <tr class="${rowClass}">
                            <td style="padding: 8px;">
                                <strong>${nombreCompleto || username}</strong><br>
                                <small class="text-muted">${username}</small>
                            </td>
                            <td style="padding: 8px;">${fechaIngresoDisplay}</td>
                            <td style="padding: 8px;">
                                ${mesesTrabajados > 0 ? `
                                    <div><strong>${mesesTrabajados}</strong> meses</div>
                                    <small class="text-muted">+ ${(mesesDecimales - mesesTrabajados).toFixed(2)} fracción</small>
                                    <div><small class="text-muted">= ${mesesDecimales.toFixed(2)} meses totales</small></div>
                                ` : '-'}
                            </td>
                            <td style="padding: 8px;">
                                ${diasGanados > 0 ? `
                                    <div><strong>${mesesDecimales.toFixed(2)}</strong> meses × 1.1667</div>
                                    <div>= <strong>${diasGanados.toFixed(2)}</strong> días</div>
                                    <div><small class="text-muted">→ ${Math.floor(diasGanados)} días completos</small></div>
                                ` : '-'}
                            </td>
                            <td style="padding: 8px;">
                                <div>
                                    <strong>Total: ${diasRedimidos.toFixed(2)} días</strong>
                                </div>
                                ${diasAprobadosDesde2025 > 0 ? `
                                    <div style="margin-top: 4px;">
                                        <small><strong>Aprobadas desde 01/12/2025:</strong> ${diasAprobadosDesde2025} días</small>
                                        ${detalleAprobadas.length > 0 ? `
                                            <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 0.75rem;">
                                                ${detalleAprobadas.map(a => `<li>${a.fecha}: ${a.dias} días</li>`).join('')}
                                            </ul>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                ${diasManuales > 0 ? `
                                    <div style="margin-top: 4px;">
                                        <small><strong>Días antes 01/12/2025:</strong> ${diasManuales} días</small>
                                    </div>
                                ` : ''}
                            </td>
                            <td style="padding: 8px;">
                                <div style="font-size: 1.1rem; font-weight: bold;">
                                    ${saldoFinal} días
                                </div>
                                <small class="text-muted">
                                    ${saldoDisponible.toFixed(2)} (antes de FLOOR)
                                </small>
                            </td>
                        </tr>
                    `;
                });
                
                liquidacionHTML += `
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <h6><i class="fas fa-info-circle me-2"></i>Notas:</h6>
                                        <ul style="margin-bottom: 0; font-size: 0.85rem;">
                                            <li><strong>Fórmula de días ganados:</strong> Meses trabajados × 1.1667 días/mes (legislación Costa Rica)</li>
                                            <li><strong>Días redimidos:</strong> Suma de días aprobados desde 01/12/2025 + días manuales antes de 01/12/2025</li>
                                            <li><strong>Saldo final:</strong> Días ganados - Días redimidos, redondeado hacia abajo (FLOOR) a días completos</li>
                                            <li><strong>Colores:</strong> Verde (≥5 días), Amarillo (<5 días), Rojo (negativo)</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal anterior si existe
                const modalAnterior = document.getElementById('modalLiquidacionVacaciones');
                if (modalAnterior) {
                    modalAnterior.remove();
                }
                
                // Agregar nuevo modal al body
                document.body.insertAdjacentHTML('beforeend', liquidacionHTML);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalLiquidacionVacaciones'));
                modal.show();
                
                // Limpiar modal cuando se cierre
                document.getElementById('modalLiquidacionVacaciones').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
            } catch (error) {
                console.error('Error generando liquidación de vacaciones:', error);
                alert('Error al generar la liquidación: ' + error.message);
            }
        };

        // Verificar empleados inválidos antes de eliminar
        window.verificarEmpleadosInvalidos = async function() {
            const modal = new bootstrap.Modal(document.getElementById('modalLimpiarEmpleadosInvalidos'));
            const lista = document.getElementById('listaEmpleadosInvalidos');
            const contador = document.getElementById('contadorEmpleadosInvalidos');
            const btnConfirmar = document.getElementById('btnConfirmarEliminacion');
            
            // Deshabilitar botón de confirmación inicialmente
            btnConfirmar.disabled = true;
            
            lista.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Verificando empleados...
                    </td>
                </tr>
            `;
            
            modal.show();
            
            try {
                // Cargar empleados si no están cargados
                if (!empleados || empleados.length === 0) {
                    const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                    empleados = empleadosSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                // Función para verificar si un valor es inválido
                function esInvalido(valor) {
                    if (!valor) return true;
                    const valorStr = String(valor).trim().toLowerCase();
                    return valorStr === '' || valorStr === 'undefined' || valorStr === 'null';
                }
                
                // Identificar empleados inválidos
                const empleadosInvalidos = empleados.filter(emp => {
                    const primerNombre = esInvalido(emp.primerNombre);
                    const primerApellido = esInvalido(emp.primerApellido);
                    const segundoNombre = esInvalido(emp.segundoNombre);
                    const segundoApellido = esInvalido(emp.segundoApellido);
                    
                    // Es inválido si TODOS los nombres y apellidos están vacíos o son "undefined"
                    return primerNombre && primerApellido && 
                           (segundoNombre || !emp.segundoNombre) && 
                           (segundoApellido || !emp.segundoApellido);
                });
                
                contador.textContent = empleadosInvalidos.length;
                
                if (empleadosInvalidos.length === 0) {
                    lista.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4 text-success">
                                <i class="fas fa-check-circle me-2"></i>
                                No se encontraron empleados inválidos. Todos los empleados tienen datos válidos.
                            </td>
                        </tr>
                    `;
                    btnConfirmar.disabled = true;
                    return;
                }
                
                // Mostrar lista de empleados inválidos
                let html = '';
                empleadosInvalidos.forEach((emp, index) => {
                    const username = emp.username || emp.id || 'N/A';
                    const estado = emp.estadoLaboral || 'N/A';
                    const primerNombre = emp.primerNombre || '<span class="text-danger">VACÍO</span>';
                    const primerApellido = emp.primerApellido || '<span class="text-danger">VACÍO</span>';
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><code>${username}</code></td>
                            <td>${primerNombre}</td>
                            <td>${primerApellido}</td>
                            <td><span class="badge bg-secondary">${estado}</span></td>
                        </tr>
                    `;
                });
                
                lista.innerHTML = html;
                
                // Habilitar botón de confirmación
                btnConfirmar.disabled = false;
                
                // Guardar lista de IDs para eliminación
                window.empleadosInvalidosParaEliminar = empleadosInvalidos.map(emp => emp.id);
                
            } catch (error) {
                console.error('Error verificando empleados inválidos:', error);
                lista.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al verificar empleados: ${error.message}
                        </td>
                    </tr>
                `;
                btnConfirmar.disabled = true;
            }
        };

        // Eliminar empleados inválidos
        window.eliminarEmpleadosInvalidos = async function() {
            if (!window.empleadosInvalidosParaEliminar || window.empleadosInvalidosParaEliminar.length === 0) {
                alert('No hay empleados para eliminar.');
                return;
            }
            
            const cantidad = window.empleadosInvalidosParaEliminar.length;
            const confirmacion = prompt(
                `¿Está seguro de eliminar ${cantidad} empleado(s) inválido(s)?\n\n` +
                `Esta acción NO se puede deshacer.\n\n` +
                `Escriba "ELIMINAR" para confirmar:`
            );
            
            if (confirmacion !== 'ELIMINAR') {
                alert('Eliminación cancelada. Debe escribir exactamente "ELIMINAR" para confirmar.');
                return;
            }
            
            const btnConfirmar = document.getElementById('btnConfirmarEliminacion');
            const textoOriginal = btnConfirmar.innerHTML;
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';
            
            let eliminados = 0;
            let errores = 0;
            
            try {
                for (const empleadoId of window.empleadosInvalidosParaEliminar) {
                    try {
                        await deleteDoc(doc(db, 'empleados', empleadoId));
                        eliminados++;
                    } catch (error) {
                        console.error(`Error eliminando empleado ${empleadoId}:`, error);
                        errores++;
                    }
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalLimpiarEmpleadosInvalidos'));
                if (modal) modal.hide();
                
                // Mostrar resultado
                if (errores === 0) {
                    alert(`✅ Se eliminaron exitosamente ${eliminados} empleado(s) inválido(s).`);
                } else {
                    alert(`⚠️ Se eliminaron ${eliminados} empleado(s), pero hubo ${errores} error(es).`);
                }
                
                // Recargar datos
                await cargarDatos();
                
                // Limpiar variable
                window.empleadosInvalidosParaEliminar = null;
                
            } catch (error) {
                console.error('Error en eliminación masiva:', error);
                alert('Error al eliminar empleados: ' + error.message);
            } finally {
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = textoOriginal;
            }
        };

        // Cargar saldo de vacaciones al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar después de un pequeño delay para asegurar que todo esté listo
            setTimeout(() => {
                if (window.cargarSaldoVacaciones) {
                    window.cargarSaldoVacaciones();
                }
            }, 1000);
        });
    </script>

    <script src="cache-buster.js"></script>
    <script src="utils.js"></script>
    <!-- Sistema de Autenticación Seguro ya cargado en el head -->
    <script type="module" src="load-headersecure.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script>
        // Función de diagnóstico para buscar empleado
        window.buscarEmpleadoDiagnostico = async function(nombre, apellido) {
            try {
                console.log('🔍 Buscando empleado:', nombre, apellido);
                
                // Usar db y collection que ya están disponibles en el scope
                if (typeof db === 'undefined') {
                    console.error('❌ db no está disponible. Asegúrate de estar en la página de empleados.');
                    alert('Error: db no está disponible. Asegúrate de estar en la página de empleados.');
                    return null;
                }
                
                // Buscar por nombre y apellido
                const empleadosRef = collection(db, 'empleados');
                const snapshot = await getDocs(empleadosRef);
                
                const empleadosEncontrados = [];
                snapshot.forEach(doc => {
                    const emp = { id: doc.id, ...doc.data() };
                    const nombreCompleto = `${emp.primerNombre || ''} ${emp.segundoNombre || ''} ${emp.primerApellido || ''} ${emp.segundoApellido || ''}`.trim().toLowerCase();
                    const nombreBuscar = `${nombre} ${apellido}`.trim().toLowerCase();
                    
                    if (nombreCompleto.includes(nombreBuscar) || 
                        (emp.primerNombre && emp.primerNombre.toLowerCase() === nombre.toLowerCase() && 
                         emp.primerApellido && emp.primerApellido.toLowerCase() === apellido.toLowerCase())) {
                        empleadosEncontrados.push(emp);
                    }
                });
                
                console.log('📋 Empleados encontrados:', empleadosEncontrados);
                
                if (empleadosEncontrados.length === 0) {
                    console.error('❌ No se encontró el empleado en Firestore');
                    alert('❌ No se encontró el empleado en Firestore.\n\nVerifica que el nombre y apellido sean correctos.');
                    return null;
                }
                
                // Mostrar información detallada
                let mensaje = '📋 Empleados encontrados:\n\n';
                empleadosEncontrados.forEach((emp, index) => {
                    const info = {
                        id: emp.id,
                        nombreCompleto: `${emp.primerNombre || ''} ${emp.primerApellido || ''}`,
                        username: emp.username,
                        emailEsperado: `rh+${emp.username}@ecoplagascr.com`,
                        firebaseAuthUID: emp.firebaseAuthUID || 'NO TIENE',
                        firebaseAuthEmail: emp.firebaseAuthEmail || 'NO TIENE',
                        tienePermisos: emp.permisos ? 'Sí' : 'No',
                        estado: emp.estado || 'No especificado'
                    };
                    
                    console.log(`📄 Empleado ${index + 1}:`, info);
                    mensaje += `Empleado ${index + 1}:\n`;
                    mensaje += `  ID: ${info.id}\n`;
                    mensaje += `  Nombre: ${info.nombreCompleto}\n`;
                    mensaje += `  Username: ${info.username}\n`;
                    mensaje += `  Email esperado: ${info.emailEsperado}\n`;
                    mensaje += `  Firebase Auth UID: ${info.firebaseAuthUID}\n`;
                    mensaje += `  Firebase Auth Email: ${info.firebaseAuthEmail}\n`;
                    mensaje += `  Estado: ${info.estado}\n\n`;
                });
                
                // Verificar en Firebase Auth
                if (window.fetchSignInMethodsForEmail && window.firebaseAuth) {
                    for (const emp of empleadosEncontrados) {
                        const email = `rh+${emp.username}@ecoplagascr.com`;
                        try {
                            const signInMethods = await window.fetchSignInMethodsForEmail(window.firebaseAuth, email);
                            if (signInMethods.length > 0) {
                                console.log(`✅ Usuario encontrado en Firebase Auth: ${email}`);
                                mensaje += `✅ ${email} existe en Firebase Auth\n`;
                            } else {
                                console.warn(`⚠️ Usuario NO encontrado en Firebase Auth: ${email}`);
                                mensaje += `⚠️ ${email} NO existe en Firebase Auth\n`;
                            }
                        } catch (error) {
                            console.error(`❌ Error verificando Firebase Auth para ${email}:`, error);
                            mensaje += `❌ Error verificando ${email}: ${error.message}\n`;
                        }
                    }
                } else {
                    mensaje += '\n⚠️ No se pudo verificar Firebase Auth (funciones no disponibles)';
                }
                
                alert(mensaje);
                return empleadosEncontrados;
            } catch (error) {
                console.error('❌ Error en diagnóstico:', error);
                alert('Error en diagnóstico: ' + error.message);
                return null;
            }
        };
        
        // Ejecutar diagnóstico automáticamente para Sebastian Trejos si se solicita
        setTimeout(() => {
            if (window.location.search.includes('diagnostico=sebastian') || window.location.hash.includes('diagnostico')) {
                window.buscarEmpleadoDiagnostico('Sebastian', 'Trejos');
            }
        }, 3000);
    </script>
</body>
</html>