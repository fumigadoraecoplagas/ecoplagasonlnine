<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edici√≥n de Horas Seguro - Eco Plagas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="eco-plagas-styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="check-permissions.js"></script>
    <script type="module" src="csrf-token.js"></script>
    <style>
        .suspicious-records-section {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 15px;
            margin-bottom: 25px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .suspicious-records-section .section-header h3 {
            color: #856404;
            font-weight: 600;
        }
        
        .suspicious-record-card {
            background: white;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .suspicious-record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .suspicious-reason {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .suspicious-reason.long-hours {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .suspicious-reason.short-hours {
            background: #f8d7da;
            color: #721c24;
        }
        
        .suspicious-reason.gps-distance {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .record-actions .btn-danger {
            margin-left: 5px;
        }
        
        /* Estilos para botones de editar y eliminar - iconos peque√±os con advertencia */
        .record-actions .btn-sm {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .record-actions .btn-sm i {
            font-size: 0.6rem;
            margin-right: 3px;
        }
        
        .record-actions .edit-btn {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            border: 1px solid #ff8c00;
            color: #000;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }
        
        .record-actions .edit-btn:hover {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
        }
        
        .record-actions .delete-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: 1px solid #c82333;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        
        .record-actions .delete-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }
        
        .record-actions .btn-sm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .no-suspicious-records {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        
        .disabled-record {
            opacity: 0.6;
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .disabled-record .record-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .badge.bg-warning {
            font-size: 0.7rem;
            padding: 2px 6px;
        }
        
        .reviewed-records-section {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            border-radius: 15px;
            margin-bottom: 25px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .reviewed-records-section .section-header h3 {
            color: #155724;
            font-weight: 600;
        }
        
        .reviewed-record-card {
            background: white;
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .reviewed-record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Estilos para registros activos (app no cerrada) */
        .working-record-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .working-record-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2196f3 0%, #9c27b0 100%);
            border-radius: 10px 10px 0 0;
        }
        
        .working-record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(33, 150, 243, 0.3);
        }
        
        .working-record-card .record-status {
            background: linear-gradient(135deg, #2196f3 0%, #9c27b0 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-header {
            transition: all 0.3s ease;
        }
        
        .section-header:hover {
            background-color: rgba(0,0,0,0.05);
            border-radius: 10px;
        }
        
        .section-header i.fa-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .section-header.expanded i.fa-chevron-down {
            transform: rotate(180deg);
        }
        
        .audit-info {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin-top: 10px;
            border-radius: 0 5px 5px 0;
        }
        
        .audit-info .audit-meta {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .audit-info .audit-comments {
            font-style: italic;
            color: #495057;
        }
        
        /* Estilos para el encabezado "Edici√≥n de Horas" */
        .app-header {
            background-color: #fbdc02 !important;
            background: #fbdc02 !important;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .app-header .app-title h1 {
            color: #000000 !important;
            margin: 0;
        }
        
        .app-header .app-title i {
            color: #000000 !important;
        }
        
        /* Estilos para la secci√≥n "Edici√≥n de Registros de Horas" */
        .records-section {
            background-color: #BBDEFB !important;
            background: #BBDEFB !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 2rem;
            border: none !important;
            box-shadow: none !important;
        }
        
        /* Recuadros de registros individuales - blanco con letras negras */
        .record-card,
        .working-record-card {
            background-color: #ffffff !important;
            background: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        /* Eliminar borde superior morado del working-record-card */
        .working-record-card::before {
            display: none !important;
        }
        
        /* Asegurar que el texto dentro de los recuadros sea negro */
        .record-card *,
        .working-record-card * {
            color: #000000 !important;
        }
        
        .record-card .record-header,
        .working-record-card .record-header {
            color: #000000 !important;
        }
        
        .record-card .record-details,
        .working-record-card .record-details {
            color: #000000 !important;
        }
        
        .record-card .detail-label,
        .working-record-card .detail-label,
        .record-card .detail-value,
        .working-record-card .detail-value {
            color: #000000 !important;
        }
        
        .record-card .employee-name,
        .working-record-card .employee-name,
        .record-card .employee-id,
        .working-record-card .employee-id {
            color: #000000 !important;
        }
        
        /* Background blanco para el resto de la p√°gina */
        body {
            background-color: #ffffff !important;
            background: #ffffff !important;
        }
        
        .main-container {
            background-color: #ffffff !important;
            background: #ffffff !important;
        }
        
        .app-container {
            background-color: #ffffff !important;
            background: #ffffff !important;
        }
        
        .app-dashboard {
            background-color: #ffffff !important;
            background: #ffffff !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header se carga din√°micamente -->

        <!-- Contenido Principal -->
        <div class="app-container">
            <!-- Dashboard Principal -->
            <div class="app-dashboard">
                <!-- Header de la App -->
                <div class="app-header">
                    <div class="app-title">
                        <i class="fas fa-edit"></i>
                        <h1>Edici√≥n de Horas</h1>
                    </div>
                </div>

                <!-- Filtros de B√∫squeda -->
                <div class="search-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="employeeFilter">Empleado:</label>
                            <select id="employeeFilter" class="form-select">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="dateFrom">Desde:</label>
                            <input type="date" id="dateFrom" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label for="dateTo">Hasta:</label>
                            <input type="date" id="dateTo" class="form-control">
                        </div>
                        <div class="filter-group">
                            <button id="btnSearch" class="btn btn-primary">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Registros que Requieren Revisi√≥n -->
                <div class="suspicious-records-section">
                    <div class="section-header" onclick="toggleSuspiciousSection()" style="cursor: pointer;">
                        <h3><i class="fas fa-exclamation-triangle text-warning"></i> Registros que Requieren Revisi√≥n</h3>
                        <div class="section-actions">
                            <div class="record-count" id="suspiciousCount">0 registros requieren revisi√≥n</div>
                            <i class="fas fa-chevron-down" id="suspiciousToggleIcon"></i>
                        </div>
                    </div>
                    
                    <div class="suspicious-records-list" id="suspiciousRecordsList" style="display: none;">
                        <!-- Los registros que requieren revisi√≥n se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>

                <!-- Registros Revisados -->
                <div class="reviewed-records-section">
                    <div class="section-header" onclick="toggleReviewedSection()" style="cursor: pointer;">
                        <h3><i class="fas fa-check-circle text-success"></i> Registros Revisados</h3>
                        <div class="section-actions">
                            <div class="record-count" id="reviewedCount">0 registros revisados</div>
                            <i class="fas fa-chevron-down" id="reviewedToggleIcon"></i>
                        </div>
                    </div>
                    
                    <div class="reviewed-records-list" id="reviewedRecordsList" style="display: none;">
                        <!-- Los registros revisados se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>

                <!-- Lista de Registros -->
                <div class="records-section">
                    <div class="section-header" onclick="toggleRecordsSection()" style="cursor: pointer;">
                        <h3><i class="fas fa-edit"></i> Edici√≥n de Registros de Horas</h3>
                        <div class="section-actions">
                            <div class="record-count" id="recordCount">0 registros encontrados</div>
                            <button id="btnViewLogs" class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); showLogsModal();">
                                <i class="fas fa-history"></i> Ver Historial de Cambios
                            </button>
                            <i class="fas fa-chevron-down" id="recordsToggleIcon"></i>
                        </div>
                    </div>
                    
                    <div class="records-list" id="recordsList" style="display: none;">
                        <!-- Los registros se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">
                        <i class="fas fa-edit"></i> Editar Registro de Horas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEmployeeId" class="form-label">ID del Empleado</label>
                                    <input type="text" class="form-control" id="editEmployeeId" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEmployeeName" class="form-label">Nombre del Empleado</label>
                                    <input type="text" class="form-control" id="editEmployeeName">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStartTime" class="form-label">Hora de Inicio</label>
                                    <input type="datetime-local" class="form-control" id="editStartTime">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEndTime" class="form-label">Hora de Finalizaci√≥n</label>
                                    <input type="datetime-local" class="form-control" id="editEndTime">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStatus" class="form-label">Estado</label>
                                    <select class="form-select" id="editStatus">
                                        <option value="completed">Completado</option>
                                        <option value="in_progress">En Progreso</option>
                                        <option value="cancelled">Cancelado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDuration" class="form-label">Duraci√≥n (horas)</label>
                                    <input type="number" class="form-control" id="editDuration" step="0.01" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCreatedAt" class="form-label">Fecha de Creaci√≥n</label>
                                    <input type="datetime-local" class="form-control" id="editCreatedAt" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editJornada" class="form-label">Tipo de Jornada</label>
                                    <select class="form-select" id="editJornada">
                                        <option value="Diurna">Diurna</option>
                                        <option value="Mixta">Mixta</option>
                                        <option value="Nocturna">Nocturna</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notas Adicionales</label>
                            <textarea class="form-control" id="editNotes" rows="3" placeholder="Agregar notas sobre este registro..."></textarea>
                        </div>

                        <!-- Secci√≥n de Auditor√≠a -->
                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-clipboard-check"></i> Informaci√≥n de Auditor√≠a</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editAuditComments" class="form-label">Comentarios de la Edici√≥n *</label>
                                        <textarea class="form-control" id="editAuditComments" rows="2" 
                                                placeholder="Explica el motivo de la edici√≥n..." required></textarea>
                                        <div class="form-text">Este campo es obligatorio para mantener trazabilidad.</div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editAuditCompleted">
                                        <label class="form-check-label" for="editAuditCompleted">
                                            <strong>Registro auditado y cumple con pol√≠ticas</strong>
                                        </label>
                                        <div class="form-text">Marcar solo si el registro ha sido revisado y aprobado.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSaveChanges">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> Confirmar Cambios
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas guardar los cambios en este registro?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        Esta acci√≥n no se puede deshacer.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnConfirmSave">
                        <i class="fas fa-save"></i> S√≠, Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial de Cambios -->
    <div class="modal fade" id="logsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history"></i> Historial de Cambios
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="logs-filters mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="logEmployeeFilter">Empleado:</label>
                                <select id="logEmployeeFilter" class="form-select">
                                    <option value="">Todos los empleados</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="logDateFrom">Desde:</label>
                                <input type="date" id="logDateFrom" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="logDateTo">Hasta:</label>
                                <input type="date" id="logDateTo" class="form-control">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <button id="btnFilterLogs" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                                <button id="btnClearLogs" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="logsList" class="logs-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Cargando historial...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="cache-buster.js"></script>
    <!-- Sistema de Autenticaci√≥n Seguro -->
    <script type="module">
        import { auth } from './auth-secure.js';
        
        // Guardar auth en window para uso global
        window.firebaseAuth = auth;
        
        // VERIFICACI√ìN INMEDIATA DE AUTENTICACI√ìN - Redirigir antes de cargar contenido
        (async function() {
            // Prevenir m√∫ltiples ejecuciones
            if (window.authCheckInProgress) {
                return;
            }
            window.authCheckInProgress = true;
            
            // Ocultar body inmediatamente
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Esperar a que auth-secure.js se cargue completamente
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verificar si ya estamos en iniciar_sesion.html (evitar loop)
            if (window.location.pathname.includes('iniciar_sesion.html')) {
                window.authCheckInProgress = false;
                return;
            }
            
            // Verificar autenticaci√≥n de manera simple
            let retries = 0;
            const maxRetries = 20; // 2 segundos
            
            while (retries < maxRetries) {
                // Verificar Firebase Auth directamente
                if (auth.currentUser) {
                    console.log('‚úÖ [EDICION_HORAS_SECURE] Usuario autenticado:', auth.currentUser.email);
                    
                    // Esperar a secureAuthManager
                    if (window.secureAuthManager) {
                        window.authManager = window.secureAuthManager;
                    } else {
                        // Esperar un poco m√°s
                        await new Promise(resolve => setTimeout(resolve, 300));
                        if (window.secureAuthManager) {
                            window.authManager = window.secureAuthManager;
                        }
                    }
                    
                    // Mostrar body
                    if (document.body) {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                    
                    window.authCheckInProgress = false;
                    return; // Usuario autenticado, continuar
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            // Si llegamos aqu√≠, no hay autenticaci√≥n
            console.log('‚ùå [EDICION_HORAS_SECURE] No autenticado despu√©s de esperar');
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Solo redirigir si no estamos ya en loginsecure
            if (!window.location.pathname.includes('iniciar_sesion.html')) {
                window.location.replace('iniciar_sesion.html');
            }
            
            window.authCheckInProgress = false;
        })();
    </script>
    <style>
        /* Ocultar contenido hasta verificar autenticaci√≥n */
        body {
            display: none !important;
        }
        body.authenticated {
            display: block !important;
        }
    </style>
    <script type="module" src="load-headersecure.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, updateDoc, doc, Timestamp, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Configuraci√≥n de Firebase (unificada)
        const firebaseConfig = {
            projectId: "cursorwebapp-f376d",
            appId: "1:719990096116:web:07c1ff697e7655b2cd9ea1",
            databaseURL: "https://cursorwebapp-f376d-default-rtdb.firebaseio.com",
            storageBucket: "cursorwebapp-f376d.firebasestorage.app",
            apiKey: "AIzaSyC-IQj0yHR8cELr-mw-v2xlnw6LlJYFUyk",
            authDomain: "cursorwebapp-f376d.firebaseapp.com",
            messagingSenderId: "719990096116",
            measurementId: "G-DJXLKFR7CD"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let allRecords = [];
        let filteredRecords = [];
        let suspiciousRecords = [];
        let reviewedRecords = [];
        let currentEditRecord = null;
        let allLogs = [];
        let filteredLogs = [];

        // Elementos del DOM
        const employeeFilter = document.getElementById('employeeFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const btnSearch = document.getElementById('btnSearch');
        const recordCount = document.getElementById('recordCount');
        const recordsList = document.getElementById('recordsList');
        const suspiciousCount = document.getElementById('suspiciousCount');
        const suspiciousRecordsList = document.getElementById('suspiciousRecordsList');
        const reviewedCount = document.getElementById('reviewedCount');
        const reviewedRecordsList = document.getElementById('reviewedRecordsList');
        const btnViewLogs = document.getElementById('btnViewLogs');
        const logsModal = new bootstrap.Modal(document.getElementById('logsModal'));
        const logEmployeeFilter = document.getElementById('logEmployeeFilter');
        const logDateFrom = document.getElementById('logDateFrom');
        const logDateTo = document.getElementById('logDateTo');
        const btnFilterLogs = document.getElementById('btnFilterLogs');
        const btnClearLogs = document.getElementById('btnClearLogs');
        const logsList = document.getElementById('logsList');
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        
        // Elementos del formulario de edici√≥n
        const editAuditComments = document.getElementById('editAuditComments');
        const editAuditCompleted = document.getElementById('editAuditCompleted');

        // Formulario de edici√≥n
        const editForm = document.getElementById('editForm');
        const editEmployeeId = document.getElementById('editEmployeeId');
        const editEmployeeName = document.getElementById('editEmployeeName');
        const editStartTime = document.getElementById('editStartTime');
        const editEndTime = document.getElementById('editEndTime');
        const editStatus = document.getElementById('editStatus');
        const editDuration = document.getElementById('editDuration');
        const editCreatedAt = document.getElementById('editCreatedAt');
        const editJornada = document.getElementById('editJornada');
        const editNotes = document.getElementById('editNotes');

        // Botones
        const btnSaveChanges = document.getElementById('btnSaveChanges');
        const btnConfirmSave = document.getElementById('btnConfirmSave');

        // Verificar autenticaci√≥n
        async function checkAuthentication() {
            // Verificar que el body est√© autenticado (ya verificado en el head)
            if (document.body && !document.body.classList.contains('authenticated')) {
                console.log('‚è≥ [EDICION_HORAS_SECURE] Esperando verificaci√≥n de autenticaci√≥n del head...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (!document.body.classList.contains('authenticated')) {
                    if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                        console.log('‚ùå [EDICION_HORAS_SECURE] No autenticado, redirigiendo...');
                        if (!window.location.pathname.includes('iniciar_sesion.html')) {
                            window.location.replace('iniciar_sesion.html');
                        }
                        return false;
                    } else {
                        document.body.style.display = 'block';
                        document.body.classList.add('authenticated');
                    }
                }
            }
            
            // Esperar a secureAuthManager
            if (!window.secureAuthManager) {
                let retries = 0;
                while (!window.secureAuthManager && retries < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
            }
            
            if (window.secureAuthManager) {
                window.authManager = window.secureAuthManager;
            }
            
            if (!window.authManager) {
                console.error('‚ùå [EDICION_HORAS_SECURE] authManager no disponible');
                return false;
            }
            
            if (!window.authManager.isAuthenticated()) {
                console.log('‚ùå [EDICION_HORAS_SECURE] Usuario no autenticado, redirigiendo...');
                if (!window.location.pathname.includes('iniciar_sesion.html')) {
                    window.location.replace('iniciar_sesion.html');
                }
                return false;
            }
            
            return true;
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando m√≥dulo de edici√≥n de horas...');
            
            // Verificar permisos de acceso
            if (!checkPagePermissions()) {
                return;
            }
            
            // Verificar autenticaci√≥n primero
            if (!(await checkAuthentication())) {
                return;
            }
            
            // Configurar fechas por defecto (√∫ltimo mes)
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            dateFrom.value = lastMonth.toISOString().split('T')[0];
            dateTo.value = today.toISOString().split('T')[0];
            
            // Cargar datos iniciales
            loadEmployees();
            loadRecords();
            
            // Event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            btnSearch.addEventListener('click', applyFilters);
            btnSaveChanges.addEventListener('click', showConfirmModal);
            btnConfirmSave.addEventListener('click', saveChanges);
            btnViewLogs.addEventListener('click', showLogsModal);
            btnFilterLogs.addEventListener('click', applyLogsFilters);
            btnClearLogs.addEventListener('click', clearLogsFilters);
            
            // Auto-calcular duraci√≥n cuando cambien las fechas
            editStartTime.addEventListener('change', calculateDuration);
            editEndTime.addEventListener('change', calculateDuration);
        }

        async function loadEmployees() {
            try {
                console.log('üìã Cargando lista de empleados...');
                
                // Cargar empleados desde la colecci√≥n empleados
                const empleadosRef = collection(db, 'empleados');
                const empleadosSnapshot = await getDocs(empleadosRef);
                
                // Limpiar opciones existentes
                employeeFilter.innerHTML = '<option value="">Todos los empleados</option>';
                
                // Agregar empleados
                empleadosSnapshot.forEach((doc) => {
                    const empleado = doc.data();
                    const option = document.createElement('option');
                    option.value = empleado.username;
                    option.textContent = `${empleado.primerNombre} ${empleado.primerApellido} (${empleado.username})`;
                    employeeFilter.appendChild(option);
                });
                
                console.log(`‚úÖ ${empleadosSnapshot.size} empleados cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando empleados:', error);
            }
        }

        async function loadRecords() {
            try {
                console.log('üìä Cargando registros de horas...');
                // Consultar sin orderBy ya que createdAt puede no existir en registros antiguos
                const q = query(collection(db, 'work_sessions'));
                const querySnapshot = await getDocs(q);
                
                // Cargar empleados para obtener nombres
                const empleadosRef = collection(db, 'empleados');
                const empleadosSnapshot = await getDocs(empleadosRef);
                const empleadosMap = {};
                empleadosSnapshot.forEach((doc) => {
                    const empleado = doc.data();
                    empleadosMap[empleado.username] = `${empleado.primerNombre} ${empleado.primerApellido}`;
                });
                
                allRecords = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('üìÑ Registro encontrado:', {
                        id: doc.id,
                        username: data.username,
                        startTime: data.startTime,
                        endTime: data.endTime,
                        status: data.status
                    });
                    allRecords.push({
                        id: doc.id,
                        ...data,
                        employeeName: empleadosMap[data.username] || data.username
                    });
                });
                
                // Ordenar por fecha de inicio (m√°s reciente primero)
                allRecords.sort((a, b) => {
                    const dateA = a.startTime?.toDate ? a.startTime.toDate() : new Date(a.startTime);
                    const dateB = b.startTime?.toDate ? b.startTime.toDate() : new Date(b.startTime);
                    return dateB - dateA;
                });
                
                console.log(`‚úÖ ${allRecords.length} registros cargados`);
                applyFilters();
                
                // Verificar si hay un par√°metro editId en la URL para abrir autom√°ticamente el modal de edici√≥n
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('editId');
                if (editId) {
                    // Validar formato de editId (solo letras, n√∫meros, guiones)
                    const idRegex = /^[a-zA-Z0-9_-]+$/;
                    if (idRegex.test(editId) && editId.length <= 100) {
                        if (window.safeLogger) {
                            window.safeLogger.info('üîç EditId encontrado en URL');
                        }
                        // Buscar el registro con el ID especificado
                        const recordToEdit = allRecords.find(record => record.id === editId);
                        if (recordToEdit) {
                            if (window.safeLogger) {
                                window.safeLogger.success('‚úÖ Registro encontrado para editar');
                            }
                            // Abrir el modal de edici√≥n con este registro
                            editRecord(editId);
                            // Limpiar el par√°metro de la URL para evitar que se abra nuevamente al recargar
                            const newUrl = window.location.pathname;
                            window.history.replaceState({}, document.title, newUrl);
                        } else {
                            if (window.safeLogger) {
                                window.safeLogger.warn('‚ö†Ô∏è No se encontr√≥ el registro con ID especificado');
                            }
                            showError('No se encontr√≥ el registro especificado para editar');
                        }
                    } else {
                        // ID inv√°lido - ignorar silenciosamente
                        if (window.safeLogger) {
                            window.safeLogger.warn('‚ö†Ô∏è Par√°metro editId inv√°lido en URL');
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error cargando registros:', error);
                showError('Error cargando registros de horas');
            }
        }

        function applyFilters() {
            const employeeId = employeeFilter.value;
            const fromDate = dateFrom.value;
            const toDate = dateTo.value;
            
            console.log('üîç Aplicando filtros:', { employeeId, fromDate, toDate });
            
            filteredRecords = allRecords.filter(record => {
                // Filtro por empleado
                if (employeeId && record.username !== employeeId) {
                    return false;
                }
                
                // Filtro por fecha
                if (fromDate || toDate) {
                    const recordDate = record.startTime.toDate ? record.startTime.toDate() : new Date(record.startTime);
                    const recordDateStr = recordDate.toISOString().split('T')[0];
                    
                    if (fromDate && recordDateStr < fromDate) {
                        return false;
                    }
                    if (toDate && recordDateStr > toDate) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log(`üìä ${filteredRecords.length} registros despu√©s del filtro`);
            
            // Detectar registros sospechosos
            detectSuspiciousRecords();
            
            displayRecords();
            displaySuspiciousRecords();
            displayReviewedRecords();
        }

        function canEditRecord(record) {
            const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
            if (!currentUser) return false;
            
            const isPaniagua = currentUser.nombre && currentUser.nombre.toLowerCase().includes('paniagua');
            return isPaniagua || currentUser.id !== record.username;
        }

        function displayRecords() {
            recordCount.textContent = `${filteredRecords.length} registros encontrados`;
            
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = `
                    <div class="no-records">
                        <i class="fas fa-search"></i>
                        <h4>No se encontraron registros</h4>
                        <p>Intenta ajustar los filtros de b√∫squeda</p>
                    </div>
                `;
                return;
            }
            
            recordsList.innerHTML = filteredRecords.map(record => {
                const startTime = record.startTime ? 
                    (record.startTime.toDate ? record.startTime.toDate() : new Date(record.startTime)) : 
                    new Date();
                const endTime = record.endTime ? 
                    (record.endTime.toDate ? record.endTime.toDate() : new Date(record.endTime)) : 
                    null;
                const createdAt = record.createdAt ? 
                    (record.createdAt.toDate ? record.createdAt.toDate() : new Date(record.createdAt)) : 
                    new Date();
                
                const duration = record.duration || calculateDurationHours(startTime, endTime);
                const jornada = getJornadaType(startTime);
                const canEdit = canEditRecord(record);
                const isOwnRecord = window.authManager && window.authManager.getCurrentUser() && 
                                  window.authManager.getCurrentUser().id === record.username;
                
                // Determinar el tipo de tarjeta seg√∫n el estado
                const isWorking = record.status === 'in_progress' || !record.endTime;
                const cardClass = isWorking ? 'working-record-card' : 'record-card';
                const statusText = isWorking ? 'Activo' : 'Completado';
                const statusClass = isWorking ? 'record-status' : 'badge bg-success';
                
                return `
                    <div class="${cardClass} ${!canEdit ? 'disabled-record' : ''}" data-record-id="${record.id}">
                        <div class="record-header">
                            <div class="record-employee">
                                <i class="fas fa-user"></i>
                                <span class="employee-name">${record.employeeName}</span>
                                <span class="employee-id">(${record.username})</span>
                                <span class="${statusClass} ms-2">${statusText}</span>
                                ${isOwnRecord && !canEdit ? '<span class="badge bg-warning text-dark ms-2">Solicita ayuda a otro(a) administrador</span>' : ''}
                            </div>
                            <div class="record-actions">
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-record-id="${record.id}" 
                                        ${!canEdit ? 'disabled title="No tienes permisos para editar este registro"' : ''}>
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-record-id="${record.id}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para eliminar este registro"' : ''}>
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                <div class="detail-item">
                                    <i class="fas fa-play"></i>
                                    <span class="detail-label">Inicio:</span>
                                    <span class="detail-value">${formatDateTime(startTime)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-stop"></i>
                                    <span class="detail-label">Fin:</span>
                                    <span class="detail-value">${formatDateTime(endTime)}</span>
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span class="detail-label">Duraci√≥n:</span>
                                    <span class="detail-value">${duration.toFixed(2)}h</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-sun"></i>
                                    <span class="detail-label">Jornada:</span>
                                    <span class="detail-value jornada-${jornada.toLowerCase()}">${jornada}</span>
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span class="detail-label">Creado:</span>
                                    <span class="detail-value">${formatDateTime(createdAt)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="detail-label">Estado:</span>
                                    <span class="detail-value status-${record.status}">${getStatusText(record.status)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners a los botones de editar y eliminar
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.recordId;
                    editRecord(recordId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.recordId;
                    deleteRecord(recordId);
                });
            });
        }

        // Coordenadas de las oficinas
        const OFFICE_COORDINATES = {
            latitude: 9.953848,
            longitude: -84.165469
        };
        
        // Distancia m√°xima permitida en metros
        const MAX_DISTANCE_METERS = 500;
        
        // Funci√≥n para calcular distancia entre dos puntos GPS (f√≥rmula de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distancia en metros
        }
        
        function detectSuspiciousRecords() {
            suspiciousRecords = [];
            reviewedRecords = [];
            
            filteredRecords.forEach(record => {
                if (record.status !== 'completed' || !record.endTime) return;
                
                const startTime = record.startTime?.toDate ? record.startTime.toDate() : new Date(record.startTime);
                const endTime = record.endTime?.toDate ? record.endTime.toDate() : new Date(record.endTime);
                const duration = (endTime - startTime) / (1000 * 60 * 60); // horas
                
                const reasons = [];
                
                // Verificar distancia GPS
                if (record.gpsStart && record.gpsEnd) {
                    const startDistance = calculateDistance(
                        OFFICE_COORDINATES.latitude, 
                        OFFICE_COORDINATES.longitude,
                        record.gpsStart.latitude, 
                        record.gpsStart.longitude
                    );
                    
                    const endDistance = calculateDistance(
                        OFFICE_COORDINATES.latitude, 
                        OFFICE_COORDINATES.longitude,
                        record.gpsEnd.latitude, 
                        record.gpsEnd.longitude
                    );
                    
                    if (startDistance > MAX_DISTANCE_METERS) {
                        reasons.push({
                            type: 'gps-distance',
                            text: `Inicio lejos de oficina: ${Math.round(startDistance)}m (m√°x: ${MAX_DISTANCE_METERS}m)`
                        });
                    }
                    
                    if (endDistance > MAX_DISTANCE_METERS) {
                        reasons.push({
                            type: 'gps-distance',
                            text: `Fin lejos de oficina: ${Math.round(endDistance)}m (m√°x: ${MAX_DISTANCE_METERS}m)`
                        });
                    }
                } else if (record.gpsStart) {
                    // Solo GPS de inicio disponible
                    const startDistance = calculateDistance(
                        OFFICE_COORDINATES.latitude, 
                        OFFICE_COORDINATES.longitude,
                        record.gpsStart.latitude, 
                        record.gpsStart.longitude
                    );
                    
                    if (startDistance > MAX_DISTANCE_METERS) {
                        reasons.push({
                            type: 'gps-distance',
                            text: `Inicio lejos de oficina: ${Math.round(startDistance)}m (m√°x: ${MAX_DISTANCE_METERS}m)`
                        });
                    }
                } else if (record.gpsEnd) {
                    // Solo GPS de fin disponible
                    const endDistance = calculateDistance(
                        OFFICE_COORDINATES.latitude, 
                        OFFICE_COORDINATES.longitude,
                        record.gpsEnd.latitude, 
                        record.gpsEnd.longitude
                    );
                    
                    if (endDistance > MAX_DISTANCE_METERS) {
                        reasons.push({
                            type: 'gps-distance',
                            text: `Fin lejos de oficina: ${Math.round(endDistance)}m (m√°x: ${MAX_DISTANCE_METERS}m)`
                        });
                    }
                }
                
                // M√°s de 10 horas
                if (duration > 10) {
                    reasons.push({
                        type: 'long-hours',
                        text: `M√°s de 10 horas: ${duration.toFixed(1)}h`
                    });
                }
                
                // Menos de 5 minutos (0.083 horas)
                if (duration < 0.083) {
                    reasons.push({
                        type: 'short-hours',
                        text: `Menos de 5 minutos: ${(duration * 60).toFixed(1)}min`
                    });
                }
                
                if (reasons.length > 0) {
                    const suspiciousRecord = {
                        ...record,
                        reasons: reasons,
                        duration: duration
                    };
                    
                    // Si ya fue auditado, va a registros revisados
                    if (record.auditCompleted === true) {
                        reviewedRecords.push(suspiciousRecord);
                    } else {
                        // Si no ha sido auditado, va a requiere revisi√≥n
                        suspiciousRecords.push(suspiciousRecord);
                    }
                }
            });
            
            console.log(`üö® ${suspiciousRecords.length} registros requieren revisi√≥n`);
            console.log(`‚úÖ ${reviewedRecords.length} registros ya revisados`);
        }

        function displaySuspiciousRecords() {
            suspiciousCount.textContent = `${suspiciousRecords.length} registros requieren revisi√≥n`;
            
            if (suspiciousRecords.length === 0) {
                suspiciousRecordsList.innerHTML = `
                    <div class="no-suspicious-records">
                        <i class="fas fa-check-circle text-success"></i>
                        <h5>¬°Excelente!</h5>
                        <p>No hay registros que requieran revisi√≥n</p>
                    </div>
                `;
                return;
            }
            
            suspiciousRecordsList.innerHTML = suspiciousRecords.map(record => {
                const startTime = record.startTime?.toDate ? record.startTime.toDate() : new Date(record.startTime);
                const endTime = record.endTime?.toDate ? record.endTime.toDate() : new Date(record.endTime);
                const canEdit = canEditRecord(record);
                const isOwnRecord = window.authManager && window.authManager.getCurrentUser() && 
                                  window.authManager.getCurrentUser().id === record.username;
                
                return `
                    <div class="suspicious-record-card ${!canEdit ? 'disabled-record' : ''}" data-record-id="${record.id}">
                        <div class="record-header">
                            <div class="record-employee">
                                <i class="fas fa-user"></i>
                                <span class="employee-name">${record.employeeName}</span>
                                <span class="employee-id">(${record.username})</span>
                                ${isOwnRecord && !canEdit ? '<span class="badge bg-warning text-dark ms-2">Solicita ayuda a otro(a) administrador</span>' : ''}
                            </div>
                            <div class="record-actions">
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-record-id="${record.id}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para editar este registro"' : ''}>
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-record-id="${record.id}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para eliminar este registro"' : ''}>
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                <div class="detail-item">
                                    <i class="fas fa-play"></i>
                                    <span class="detail-label">Inicio:</span>
                                    <span class="detail-value">${formatDateTime(startTime)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-stop"></i>
                                    <span class="detail-label">Fin:</span>
                                    <span class="detail-value">${formatDateTime(endTime)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span class="detail-label">Duraci√≥n:</span>
                                    <span class="detail-value">${record.duration.toFixed(1)}h</span>
                                </div>
                            </div>
                            <div class="suspicious-reasons">
                                ${record.reasons.map(reason => `
                                    <span class="suspicious-reason ${reason.type}">${reason.text}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners
            document.querySelectorAll('.suspicious-record-card .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.recordId;
                    editRecord(recordId);
                });
            });
            
            document.querySelectorAll('.suspicious-record-card .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.recordId;
                    deleteRecord(recordId);
                });
            });
        }

        function displayReviewedRecords() {
            reviewedCount.textContent = `${reviewedRecords.length} registros revisados`;
            
            if (reviewedRecords.length === 0) {
                reviewedRecordsList.innerHTML = `
                    <div class="no-suspicious-records">
                        <i class="fas fa-info-circle text-info"></i>
                        <h5>Sin registros revisados</h5>
                        <p>Los registros auditados aparecer√°n aqu√≠</p>
                    </div>
                `;
                return;
            }
            
            reviewedRecordsList.innerHTML = reviewedRecords.map(record => {
                const startTime = record.startTime?.toDate ? record.startTime.toDate() : new Date(record.startTime);
                const endTime = record.endTime?.toDate ? record.endTime.toDate() : new Date(record.endTime);
                const canEdit = canEditRecord(record);
                const isOwnRecord = window.authManager && window.authManager.getCurrentUser() && 
                                  window.authManager.getCurrentUser().id === record.username;
                
                return `
                    <div class="reviewed-record-card ${!canEdit ? 'disabled-record' : ''}" data-record-id="${record.id}">
                        <div class="record-header">
                            <div class="record-employee">
                                <i class="fas fa-user"></i>
                                <span class="employee-name">${record.employeeName}</span>
                                <span class="employee-id">(${record.username})</span>
                                <span class="badge bg-success ms-2">Revisado</span>
                            </div>
                            <div class="record-actions">
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-record-id="${record.id}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para editar este registro"' : ''}>
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-record-id="${record.id}"
                                        ${!canEdit ? 'disabled title="No tienes permisos para eliminar este registro"' : ''}>
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                <div class="detail-item">
                                    <i class="fas fa-play"></i>
                                    <span class="detail-label">Inicio:</span>
                                    <span class="detail-value">${formatDateTime(startTime)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-stop"></i>
                                    <span class="detail-label">Fin:</span>
                                    <span class="detail-value">${formatDateTime(endTime)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span class="detail-label">Duraci√≥n:</span>
                                    <span class="detail-value">${record.duration.toFixed(1)}h</span>
                                </div>
                            </div>
                            <div class="suspicious-reasons">
                                ${record.reasons.map(reason => `
                                    <span class="suspicious-reason ${reason.type}">${reason.text}</span>
                                `).join('')}
                            </div>
                            ${record.auditComments ? `
                                <div class="audit-info">
                                    <div class="audit-meta">
                                        <i class="fas fa-user-check"></i> Revisado por: ${record.auditBy || 'Usuario Desconocido'}
                                        <i class="fas fa-clock"></i> ${record.auditDate ? formatDateTime(record.auditDate.toDate ? record.auditDate.toDate() : new Date(record.auditDate)) : 'Fecha no disponible'}
                                    </div>
                                    <div class="audit-comments">
                                        <strong>Comentarios:</strong> ${record.auditComments}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners
            document.querySelectorAll('.reviewed-record-card .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.recordId;
                    editRecord(recordId);
                });
            });
            
            document.querySelectorAll('.reviewed-record-card .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.recordId;
                    deleteRecord(recordId);
                });
            });
        }

        function editRecord(recordId) {
            const record = filteredRecords.find(r => r.id === recordId);
            if (!record) {
                console.error('‚ùå Registro no encontrado:', recordId);
                return;
            }
            
            // Validar permisos de edici√≥n
            const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
            if (!currentUser) {
                showError('No se pudo obtener informaci√≥n del usuario actual');
                return;
            }
            
            // Verificar si el usuario actual es Paniagua
            const isPaniagua = currentUser.nombre && currentUser.nombre.toLowerCase().includes('paniagua');
            
            // Si no es Paniagua, no puede editar sus propias horas
            if (!isPaniagua && currentUser.id === record.username) {
                showError('No puedes editar tus propias horas. Contacta a un administrador o socio.');
                return;
            }
            
            currentEditRecord = record;
            console.log('‚úèÔ∏è Editando registro:', record);
            
            // Llenar formulario
            const startTime = record.startTime?.toDate ? record.startTime.toDate() : new Date(record.startTime);
            const endTime = record.endTime?.toDate ? record.endTime.toDate() : new Date(record.endTime);
            const createdAt = record.createdAt?.toDate ? record.createdAt.toDate() : (record.createdAt ? new Date(record.createdAt) : new Date());
            
            editEmployeeId.value = record.username;
            editEmployeeName.value = record.employeeName || record.username;
            editStartTime.value = formatDateTimeLocal(startTime);
            editEndTime.value = formatDateTimeLocal(endTime);
            editStatus.value = record.status;
            editCreatedAt.value = formatDateTimeLocal(createdAt);
            editJornada.value = getJornadaType(startTime);
            editNotes.value = record.notes || '';
            
            // Limpiar campos de auditor√≠a
            editAuditComments.value = '';
            editAuditCompleted.checked = false;
            
            // Calcular duraci√≥n inicial
            calculateDuration();
            
            // Mostrar modal
            editModal.show();
        }

        function calculateDuration() {
            const startTime = new Date(editStartTime.value);
            const endTime = new Date(editEndTime.value);
            
            if (startTime && endTime && endTime > startTime) {
                const duration = (endTime - startTime) / (1000 * 60 * 60);
                editDuration.value = duration.toFixed(2);
                
                // Actualizar jornada autom√°ticamente
                editJornada.value = getJornadaType(startTime);
            } else {
                editDuration.value = '';
            }
        }

        function showConfirmModal() {
            if (!validateForm()) {
                return;
            }
            confirmModal.show();
        }

        function validateForm() {
            const startTime = new Date(editStartTime.value);
            const endTime = new Date(editEndTime.value);
            
            if (!editEmployeeName.value.trim()) {
                showError('El nombre del empleado es requerido');
                return false;
            }
            
            if (!editStartTime.value || !editEndTime.value) {
                showError('Las fechas de inicio y fin son requeridas');
                return false;
            }
            
            if (endTime <= startTime) {
                showError('La hora de finalizaci√≥n debe ser posterior a la de inicio');
                return false;
            }
            
            return true;
        }

        async function createChangeLog(originalData, updatedData) {
            try {
                // Obtener informaci√≥n del usuario actual
                const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
                const userId = currentUser ? currentUser.id : 'unknown';
                const userName = currentUser ? (currentUser.nombre || currentUser.username || 'Usuario Desconocido') : 'Usuario Desconocido';
                
                console.log('üë§ Usuario actual para log:', { userId, userName, currentUser });
                
                // Crear objeto de cambios detectados
                const changes = [];
                
                // Comparar cada campo y detectar cambios
                const fieldsToCompare = [
                    'employeeName',
                    'startTime', 
                    'endTime',
                    'status',
                    'duration',
                    'createdAt',
                    'notes',
                    'auditComments',
                    'auditCompleted'
                ];
                
                fieldsToCompare.forEach(field => {
                    let originalValue = originalData[field];
                    let updatedValue = updatedData[field];
                    
                    // Convertir timestamps a fechas para comparaci√≥n
                    if (field === 'startTime' || field === 'endTime' || field === 'createdAt') {
                        originalValue = originalValue ? originalValue.toDate ? originalValue.toDate() : new Date(originalValue) : null;
                        updatedValue = updatedValue ? updatedValue.toDate ? updatedValue.toDate() : new Date(updatedValue) : null;
                    }
                    
                    // Comparar valores
                    if (JSON.stringify(originalValue) !== JSON.stringify(updatedValue)) {
                        changes.push({
                            field: field,
                            originalValue: originalValue,
                            newValue: updatedValue,
                            fieldName: getFieldDisplayName(field)
                        });
                    }
                });
                
                // Solo crear log si hay cambios
                if (changes.length > 0) {
                    // Validar que userName no sea undefined
                    const finalUserName = userName || 'Usuario Desconocido';
                    
                    const logData = {
                        recordId: originalData.id,
                        employeeId: originalData.username,
                        employeeName: originalData.employeeName || originalData.username,
                        modifiedBy: userId,
                        modifiedByName: finalUserName,
                        modifiedAt: Timestamp.now(),
                        changes: changes,
                        ipAddress: await getClientIP(),
                        userAgent: navigator.userAgent
                    };
                    
                    // Guardar log en Firebase
                    await addDoc(collection(db, 'work_sessions_logs'), logData);
                    
                    console.log('üìù Log de cambios creado:', {
                        recordId: originalData.id,
                        employee: originalData.employeeName,
                        modifiedBy: userName,
                        changesCount: changes.length
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Error creando log de cambios:', error);
                // No lanzar error para no interrumpir el guardado principal
            }
        }
        
        function getFieldDisplayName(field) {
            const fieldNames = {
                'employeeName': 'Nombre del Empleado',
                'startTime': 'Hora de Inicio',
                'endTime': 'Hora de Finalizaci√≥n',
                'status': 'Estado',
                'duration': 'Duraci√≥n',
                'createdAt': 'Fecha de Creaci√≥n',
                'notes': 'Notas',
                'auditComments': 'Comentarios de Auditor√≠a',
                'auditCompleted': 'Auditor√≠a Completada'
            };
            return fieldNames[field] || field;
        }
        
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        async function saveChanges() {
            try {
                console.log('üíæ Guardando cambios...');
                
                const startTime = new Date(editStartTime.value);
                const endTime = new Date(editEndTime.value);
                const createdAt = new Date(editCreatedAt.value);
                
                // Obtener datos originales para comparar cambios
                const originalData = currentEditRecord;
                
                const updatedData = {
                    employeeName: editEmployeeName.value.trim(),
                    startTime: Timestamp.fromDate(startTime),
                    endTime: Timestamp.fromDate(endTime),
                    status: editStatus.value,
                    duration: parseFloat(editDuration.value),
                    createdAt: Timestamp.fromDate(createdAt),
                    notes: editNotes.value.trim(),
                    lastModified: Timestamp.now(),
                    // Campos de auditor√≠a
                    auditComments: editAuditComments.value.trim(),
                    auditCompleted: editAuditCompleted.checked,
                    auditDate: Timestamp.now(),
                    auditBy: window.authManager ? window.authManager.getCurrentUser().nombre : 'Usuario Desconocido'
                };
                
                // Crear log de cambios antes de actualizar
                await createChangeLog(originalData, updatedData);
                
                await updateDoc(doc(db, 'work_sessions', currentEditRecord.id), updatedData);
                
                console.log('‚úÖ Cambios guardados exitosamente');
                showSuccess('Registro actualizado correctamente');
                
                // Cerrar modales
                confirmModal.hide();
                editModal.hide();
                
                // Recargar datos
                await loadRecords();
                
            } catch (error) {
                console.error('‚ùå Error guardando cambios:', error);
                showError('Error al guardar los cambios: ' + error.message);
            }
        }

        // Funciones auxiliares
        function formatDateTime(date) {
            if (!date) {
                return 'En progreso';
            }
            
            // Si es un Timestamp de Firebase, convertir a Date
            if (date.toDate && typeof date.toDate === 'function') {
                date = date.toDate();
            }
            
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/Costa_Rica'
            });
        }

        function formatDateTimeLocal(date) {
            if (!date) {
                return '';
            }
            
            // Si es un Timestamp de Firebase, convertir a Date
            if (date.toDate && typeof date.toDate === 'function') {
                date = date.toDate();
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function calculateDurationHours(startTime, endTime) {
            if (!endTime) {
                return 0; // Si no hay hora de fin, la duraci√≥n es 0
            }
            return (endTime - startTime) / (1000 * 60 * 60);
        }

        // Funci√≥n unificada para calcular tipo de jornada (consistente con registro_horas.html)
        function getJornadaType(startTime) {
            if (!startTime || isNaN(startTime.getTime())) {
                return 'Diurna'; // Valor por defecto si la fecha es inv√°lida
            }
            
            const hour = startTime.getHours();
            
            // L√≥gica corregida:
            // Diurna: 05:00 - 11:59
            // Mixta: 12:00 - 18:59
            // Nocturna: 19:00 - 04:59
            if (hour >= 5 && hour < 12) {
                return 'Diurna';
            } else if (hour >= 12 && hour < 19) {
                return 'Mixta';
            } else {
                return 'Nocturna';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'completed': 'Completado',
                'in_progress': 'En Progreso',
                'cancelled': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function showSuccess(message) {
            // Crear notificaci√≥n de √©xito
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        function showError(message) {
            // Crear notificaci√≥n de error
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            // Auto-remover despu√©s de 7 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 7000);
        }

        // Funciones para el historial de cambios
        async function showLogsModal() {
            try {
                logsModal.show();
                await loadLogs();
                await loadLogEmployees();
            } catch (error) {
                console.error('‚ùå Error mostrando modal de logs:', error);
                showError('Error al cargar el historial de cambios');
            }
        }

        async function loadLogs() {
            try {
                console.log('üìã Cargando historial de cambios...');
                const q = query(collection(db, 'work_sessions_logs'), orderBy('modifiedAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allLogs = [];
                querySnapshot.forEach((doc) => {
                    allLogs.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`‚úÖ ${allLogs.length} logs cargados`);
                applyLogsFilters();
                
            } catch (error) {
                console.error('‚ùå Error cargando logs:', error);
                showError('Error al cargar el historial de cambios');
            }
        }

        async function loadLogEmployees() {
            try {
                const employees = new Set();
                allLogs.forEach(log => {
                    employees.add(JSON.stringify({
                        id: log.employeeId,
                        name: log.employeeName
                    }));
                });
                
                logEmployeeFilter.innerHTML = '<option value="">Todos los empleados</option>';
                employees.forEach(emp => {
                    const employee = JSON.parse(emp);
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    logEmployeeFilter.appendChild(option);
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando empleados para logs:', error);
            }
        }

        function applyLogsFilters() {
            const employeeId = logEmployeeFilter.value;
            const fromDate = logDateFrom.value;
            const toDate = logDateTo.value;
            
            filteredLogs = allLogs.filter(log => {
                const logDate = log.modifiedAt.toDate();
                const logDateStr = logDate.toISOString().split('T')[0];
                
                let matchesEmployee = !employeeId || log.employeeId === employeeId;
                let matchesFromDate = !fromDate || logDateStr >= fromDate;
                let matchesToDate = !toDate || logDateStr <= toDate;
                
                return matchesEmployee && matchesFromDate && matchesToDate;
            });
            
            displayLogs();
        }

        function clearLogsFilters() {
            logEmployeeFilter.value = '';
            logDateFrom.value = '';
            logDateTo.value = '';
            applyLogsFilters();
        }

        function displayLogs() {
            if (filteredLogs.length === 0) {
                logsList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-info-circle"></i>
                        <h4>No se encontraron cambios</h4>
                        <p>No hay registros de modificaciones con los filtros aplicados</p>
                    </div>
                `;
                return;
            }
            
            logsList.innerHTML = filteredLogs.map(log => {
                const modifiedAt = log.modifiedAt.toDate();
                const modifiedAtStr = formatDateTime(modifiedAt);
                
                const changesHtml = log.changes.map(change => {
                    const originalValue = formatChangeValue(change.originalValue, change.field);
                    const newValue = formatChangeValue(change.newValue, change.field);
                    
                    return `
                        <div class="change-item">
                            <div class="change-field">
                                <strong>${change.fieldName}:</strong>
                            </div>
                            <div class="change-values">
                                <span class="original-value">${originalValue}</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="new-value">${newValue}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="log-card">
                        <div class="log-header">
                            <div class="log-info">
                                <h5>${log.employeeName}</h5>
                                <p class="log-meta">
                                    <i class="fas fa-user-edit"></i> ${log.modifiedByName}
                                    <i class="fas fa-clock"></i> ${modifiedAtStr}
                                </p>
                            </div>
                            <div class="log-badge">
                                <span class="badge bg-primary">${log.changes.length} cambio${log.changes.length !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="log-changes">
                            ${changesHtml}
                        </div>
                        <div class="log-footer">
                            <small class="text-muted">
                                <i class="fas fa-fingerprint"></i> IP: ${log.ipAddress || 'N/A'}
                                <i class="fas fa-id-badge"></i> ID: ${log.recordId}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatChangeValue(value, field) {
            if (value === null || value === undefined) {
                return '<em>No definido</em>';
            }
            
            if (field === 'startTime' || field === 'endTime' || field === 'createdAt') {
                if (value.toDate) {
                    return formatDateTime(value.toDate());
                } else if (value instanceof Date) {
                    return formatDateTime(value);
                } else {
                    return formatDateTime(new Date(value));
                }
            }
            
            if (field === 'duration') {
                return `${value} horas`;
            }
            
            if (field === 'status') {
                const statusMap = {
                    'completed': 'Completado',
                    'in_progress': 'En Progreso',
                    'cancelled': 'Cancelado'
                };
                return statusMap[value] || value;
            }
            
            return String(value);
        }

        async function deleteRecord(recordId) {
            // Buscar el registro para validar permisos
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                showError('Registro no encontrado');
                return;
            }
            
            // Validar permisos de eliminaci√≥n
            const currentUser = window.authManager ? window.authManager.getCurrentUser() : null;
            if (!currentUser) {
                showError('No se pudo obtener informaci√≥n del usuario actual');
                return;
            }
            
            // Verificar si el usuario actual es Paniagua
            const isPaniagua = currentUser.nombre && currentUser.nombre.toLowerCase().includes('paniagua');
            
            // Si no es Paniagua, no puede eliminar sus propias horas
            if (!isPaniagua && currentUser.id === record.username) {
                showError('No puedes eliminar tus propias horas. Contacta a un administrador o socio.');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este registro? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Eliminando registro:', recordId);
                
                // Eliminar de Firebase
                const recordRef = doc(db, 'work_sessions', recordId);
                await deleteDoc(recordRef);
                
                // Remover de las listas locales
                allRecords = allRecords.filter(r => r.id !== recordId);
                filteredRecords = filteredRecords.filter(r => r.id !== recordId);
                suspiciousRecords = suspiciousRecords.filter(r => r.id !== recordId);
                
                // Actualizar la vista
                displayRecords();
                displaySuspiciousRecords();
                displayReviewedRecords();
                
                showSuccess('Registro eliminado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error eliminando registro:', error);
                showError('Error al eliminar el registro');
            }
        }

        // Funciones para hacer colapsables las secciones
        function toggleSuspiciousSection() {
            const content = document.getElementById('suspiciousRecordsList');
            const icon = document.getElementById('suspiciousToggleIcon');
            const header = document.querySelector('.suspicious-records-section .section-header');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                header.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                header.classList.remove('expanded');
            }
        }

        function toggleReviewedSection() {
            const content = document.getElementById('reviewedRecordsList');
            const icon = document.getElementById('reviewedToggleIcon');
            const header = document.querySelector('.reviewed-records-section .section-header');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                header.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                header.classList.remove('expanded');
            }
        }

        function toggleRecordsSection() {
            const content = document.getElementById('recordsList');
            const icon = document.getElementById('recordsToggleIcon');
            const header = document.querySelector('.records-section .section-header');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                header.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                header.classList.remove('expanded');
            }
        }

        // Hacer las funciones globales
        window.toggleSuspiciousSection = toggleSuspiciousSection;
        window.toggleReviewedSection = toggleReviewedSection;
        window.toggleRecordsSection = toggleRecordsSection;
    </script>
</body>
</html>
